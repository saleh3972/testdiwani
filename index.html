<!DOCTYPE html>
<html dir="rtl" lang="ar">
<!--
    ========================================
    ğŸ¯ Ø§Ù„Ø¯ÙŠÙˆØ§Ù† - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ v23.0
    ========================================
    /Ø¢Ø®Ø± Ø¥ØµÙ„Ø§Ø­ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© ÙØ§Ø±ØºØ© Ù„ØªØ¬Ù†Ø¨ ØªØ­Ø°ÙŠØ± Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ù„Ø©
    ğŸ“‹ Ø£Ø­Ø¯Ø« Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª ÙˆØ§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©:
    
    ğŸ†• Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 23.0 (Firebase Integration):
    
    âœ… 15. ØªÙƒØ§Ù…Ù„ Firebase Ø§Ù„ÙƒØ§Ù…Ù„ ğŸ”¥
       - Ø±Ø¨Ø· Ø´Ø§Ù…Ù„ Ù…Ø¹ Firebase Realtime Database
       - Firebase Authentication Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø¢Ù…Ù†Ø©
       - Ù†Ø¸Ø§Ù… Ù‡Ø¬ÙŠÙ† (Hybrid): Firebase + LocalStorage
       - ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Firebase Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
       - Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Firebase + LocalStorage Ù…Ø¹Ø§Ù‹
       - LocalStorage ÙƒÙ†Ø¸Ø§Ù… Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Backup)
       - Ø¯Ø¹Ù… Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª Ù…Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    
    âœ… 16. Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Firebase
       - Ø£Ø¯Ø§Ø© Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ù„Ù‰ Firebase Authentication + Database
       - Ø£Ø¯Ø§Ø© Ù†Ù‚Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø¥Ù„Ù‰ Firebase
       - Ø£Ø¯Ø§Ø© Ù†Ù‚Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙƒØ§Ù…Ù„ (12 Ù†ÙˆØ¹ Ø¨ÙŠØ§Ù†Ø§Øª):
         â€¢ Ø§Ù„Ø£ØµÙ†Ø§Ù (items)
         â€¢ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (customers)
         â€¢ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (suppliers)
         â€¢ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (purchases)
         â€¢ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (sales)
         â€¢ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (expenses)
         â€¢ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (revenues)
         â€¢ Ø§Ù„Ø±ÙˆØ§ØªØ¨ (salaries)
         â€¢ Ø§Ù„Ø£ØµÙˆÙ„ (assets)
         â€¢ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (salesReturns)
         â€¢ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (purchaseReturns)
         â€¢ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù (advances)
       - Ù…Ø¹Ø§Ù„Ø¬Ø© Ø°ÙƒÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© (ØªØ­Ø¯ÙŠØ« Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±)
       - Ø£Ø²Ø±Ø§Ø± Ù…Ø®ØµØµØ© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ù†Ù‚Ù„
    
    âœ… 17. Ù…ÙŠØ²Ø© "ØªØ°ÙƒØ±Ù†ÙŠ" Ø§Ù„Ø¢Ù…Ù†Ø©
       - Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù…Ø¯Ø© 30 ÙŠÙˆÙ…
       - ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¯ÙˆÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
       - Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
       - Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ" Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙŠØ¯ÙˆÙŠ
       - ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ù…ØªØµÙØ­ (Ø£Ù…Ø§Ù†)
    
    ğŸ”¥ Firebase Features:
    âœ… 18. Ø¯ÙˆØ§Ù„ Firebase Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
       - firebaseCreateUser(): Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Authentication + Database
       - firebaseSignIn(): ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
       - firebaseGetUserData(): Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Database
       - firebaseSaveUserData(): Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Database
       - firebaseGetActivityData(): Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø´Ø§Ø· Ù…Ø­Ø¯Ø¯
       - firebaseSaveActivityData(): Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø´Ø§Ø· ÙÙŠ Firebase
       - firebaseSignOut(): ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¢Ù…Ù†
       - Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„
    
    âœ… 19. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
       - Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Firebase Authentication
       - Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: LocalStorage (Fallback)
       - Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„
       - Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ ÙˆØ§Ø¶Ø­Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
       - ØªØ³Ø¬ÙŠÙ„ ØªÙØµÙŠÙ„ÙŠ ÙÙŠ Console Ù„Ù„ØªØªØ¨Ø¹
    
    âœ… 20. Ù‡ÙŠÙƒÙ„ Firebase Database
       - users/
         â””â”€â”€ {uid}/
             â”œâ”€â”€ id
             â”œâ”€â”€ name
             â”œâ”€â”€ email
             â”œâ”€â”€ phone
             â”œâ”€â”€ role
             â”œâ”€â”€ activityId
             â””â”€â”€ createdAt
       - activities/
         â””â”€â”€ {activityId}/
             â”œâ”€â”€ id
             â”œâ”€â”€ name
             â”œâ”€â”€ createdAt
             â”œâ”€â”€ createdBy
             â”œâ”€â”€ items/
             â”œâ”€â”€ customers/
             â”œâ”€â”€ suppliers/
             â”œâ”€â”€ purchases/
             â”œâ”€â”€ sales/
             â””â”€â”€ ... (12 Ù†ÙˆØ¹ Ø¨ÙŠØ§Ù†Ø§Øª)
    
    ğŸ”§ ØªØ­Ø³ÙŠÙ†Ø§Øª ØªÙ‚Ù†ÙŠØ© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 23.0:
    âœ… 21. ØªØ­Ù…ÙŠÙ„ Ø°ÙƒÙŠ Ù…Ù† Firebase
       - ØªØ¹Ø¯ÙŠÙ„ initializeApp() Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase
       - ÙƒØ´Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø­Ø§Ù„Ø© Firebase (Ù…ÙØ¹Ù‘Ù„/Ù…Ø¹Ø·Ù‘Ù„)
       - ØªØ­Ù…ÙŠÙ„ Ù…ØªÙˆØ§Ø²ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø³Ø±Ø¹Ø© Ø£ÙƒØ¨Ø±
       - Ø±Ø³Ø§Ø¦Ù„ debug ÙˆØ§Ø¶Ø­Ø© Ù„ØªØªØ¨Ø¹ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    
    âœ… 22. Ø­ÙØ¸ Ù…Ø²Ø¯ÙˆØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠ
       - ØªØ¹Ø¯ÙŠÙ„ saveToLocalStorage() Ù„Ù„Ø­ÙØ¸ ÙÙŠ Firebase ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
       - ÙƒØ´Ù Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­
       - ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (GLOBAL_STORAGE_KEYS)
       - Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù†Ø´Ø§Ø· ÙÙ‚Ø· ÙÙŠ Firebase
       - Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ ÙÙŠ LocalStorage ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
    
    âœ… 23. Ø£Ù…Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
       - ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Firebase Authentication
       - Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firebase Database (Rules)
       - Ø¹Ø¯Ù… ØªØ®Ø²ÙŠÙ† ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Database (ÙÙ‚Ø· ÙÙŠ Authentication)
       - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚Ø¨Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
       - ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Console Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
    
    âœ… 24. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
       - Ù…Ø¹Ø§Ù„Ø¬Ø© "email-already-in-use" Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±
       - Ù…Ø¹Ø§Ù„Ø¬Ø© "auth/invalid-credential" Ø¹Ù†Ø¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©
       - Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
       - Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ ÙˆØ§Ø¶Ø­Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
       - ØªØ³Ø¬ÙŠÙ„ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Console
    
    ğŸ¨ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 23.0:
    âœ… 25. Ø£Ø²Ø±Ø§Ø± Firebase ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
       - ğŸ”¥ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ù„Ù‰ Firebase (Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ)
       - ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Firebase (Ø£Ø®Ø¶Ø±)
       - ğŸ”¥ Ù†Ù‚Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø¥Ù„Ù‰ Firebase (Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ)
       - ğŸ“¦ Ù†Ù‚Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¨Ù†ÙØ³Ø¬ÙŠ)
       - ØªØµÙ…ÙŠÙ… Gradient Ø¬Ø°Ø§Ø¨ Ù„ÙƒÙ„ Ø²Ø±
       - Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§Ø¶Ø­Ø© Ù„ÙƒÙ„ ÙˆØ¸ÙŠÙØ©
    
    âœ… 26. Checkbox "ØªØ°ÙƒØ±Ù†ÙŠ"
       - ØªØµÙ…ÙŠÙ… Ø£Ù†ÙŠÙ‚ ØªØ­Øª Ø­Ù‚ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
       - Ù…Ø³Ø§ÙØ§Øª Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆØªÙ†Ø³ÙŠÙ‚ Ø¬Ù…ÙŠÙ„
       - Ø­Ø§Ù„Ø© Ù…Ø­ÙÙˆØ¸Ø© (checked/unchecked)
       - Label Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ù‚Ø±
    
    âœ… 27. ØªØ­Ø³ÙŠÙ† Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„Ø£Ø®Ø·Ø§Ø¡
       - ØªÙ‚Ù„ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Console ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
       - ØªØ­Ø³ÙŠÙ† Ø±Ø³Ø§Ø¦Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø£Ù‚Ù„ Ø¥Ø²Ø¹Ø§Ø¬Ø§Ù‹)
       - Ø¥Ø¶Ø§ÙØ© toggleDebugMode() Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙØµÙŠÙ„
       - Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Database
       - Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
       - Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù†Ø¬Ø§Ø² ÙˆØ§Ø¶Ø­Ø© ÙˆØµØ¯ÙŠÙ‚Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    
    âœ… 28. Ø¢Ù„ÙŠØ© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
       - createUserDataFromFirebaseAuth(): Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
       - ØªÙƒØ§Ù…Ù„ Ù…Ø¹ firebaseSignIn() Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
       - Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Firebase Authentication
       - Ù…Ù†Ø¹ Ø£Ø®Ø·Ø§Ø¡ "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Database"
       - ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª
    
    ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø¯Ù‘Ø«Ø© Ù„Ù„Ù†Ø¸Ø§Ù…:
    - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø³Ø·Ø± Ø§Ù„ÙƒÙˆØ¯: ~15,600 Ø³Ø·Ø±
    - Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: 26 Ù…ÙŠØ²Ø© Ù…ØªÙ‚Ø¯Ù…Ø©
    - Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù…: 8 Ø£Ù‚Ø³Ø§Ù… Ø±Ø¦ÙŠØ³ÙŠØ©
    - Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±: 6 Ø£Ù†ÙˆØ§Ø¹ + 5 Ø£Ù†ÙˆØ§Ø¹ ÙƒØ´ÙˆÙ
    - Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ù…Ø§Ù†: Ù…ØªÙ‚Ø¯Ù… Ø¬Ø¯Ø§Ù‹ (SHA-256 + Firebase Auth)
    - Ø§Ù„ØªÙˆØ§ÙÙ‚: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
    - Ø¯Ø¹Ù… Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©: ÙƒÙ…Ø¨ÙŠÙˆØªØ± + Ø¬ÙˆØ§Ù„ (Responsive)
    - Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: Firebase Realtime Database
    - ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…Ù„: Online/Offline Hybrid
    
    ğŸ†• Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 22.0:
    
    âœ… 10. Ù†Ø¸Ø§Ù… ÙƒØ´ÙˆÙ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„
       - ØªØ­ÙˆÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¥Ù„Ù‰ "Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±"
       - Ø¥Ø¶Ø§ÙØ© ØªØ¨ÙˆÙŠØ¨Ø© ÙƒØ´ÙˆÙ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø¹ 5 Ø£Ù†ÙˆØ§Ø¹:
         â€¢ ğŸ“¦ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ)
         â€¢ ğŸ‘¥ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ)
         â€¢ ğŸ‘· ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ø¨Ø¯Ù„Ø§Øª ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª)
         â€¢ ğŸ¦ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ (Ø§Ù„Ù…Ø¯ÙŠÙ† ÙˆØ§Ù„Ø¯Ø§Ø¦Ù† ÙˆØ§Ù„Ø±ØµÙŠØ¯)
         â€¢ ğŸ’° ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© (Ø§Ù„Ù…Ø¯ÙŠÙ† ÙˆØ§Ù„Ø¯Ø§Ø¦Ù† ÙˆØ§Ù„Ø±ØµÙŠØ¯)
       - ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø© Ø¨Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†
       - Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø¨Ø·Ø§Ù‚Ø§Øª Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø¬Ù…ÙŠÙ„Ø© Ù…Ø«Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
       - Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„ÙƒÙ„ ÙƒØ´Ù
       - Ø±Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ø¨Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    
    âœ… 11. ØªØ­Ø³ÙŠÙ†Ø§Øª Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨
       - Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© (Ù…Ø·Ù„ÙˆØ¨)
       - Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ø¬Ù†Ø³ÙŠØ© (Ø³Ø¹ÙˆØ¯ÙŠ/ØºÙŠØ± Ø³Ø¹ÙˆØ¯ÙŠ) Ù…Ø¹ Ø§Ù„Ø±Ù…ÙˆØ²
       - ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
       - ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¥Ø¶Ø§ÙØ©ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø¹Ø±Ø¶)
       - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
       - Ø¯Ø¹Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
    
    âœ… 12. Ù†Ø¸Ø§Ù… Ø£Ù…Ø§Ù† Ù…Ø­Ø³Ù‘Ù†
       - Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
       - Ù…Ù†Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ØµØ±ÙŠØ­
       - Ù†Ø¸Ø§Ù… Ø¹Ù„Ø§Ù…Ø§Øª Ù…Ø­ÙƒÙ… ÙÙŠ localStorage Ù„ØªØ°ÙƒØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬
       - ØªØ±ØªÙŠØ¨ ØµØ­ÙŠØ­ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
       - ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø°ÙƒÙŠ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    
    ğŸ¨ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©:
    âœ… 13. Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù„Ø®Øµ Ø§Ù„ÙƒØ´ÙˆÙ
       - ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù†Ù…Ø·ÙŠØ© Ø¥Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ø¹ØµØ±ÙŠØ©
       - Ø£Ù„ÙˆØ§Ù† Ù…Ù…ÙŠØ²Ø© Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ø¨ÙŠØ§Ù†Ø§Øª (Ø£Ø®Ø¶Ø± Ù„Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØŒ Ø£Ø­Ù…Ø± Ù„Ù„Ø³Ù„Ø¨ÙŠØŒ Ø£Ø²Ø±Ù‚ Ù„Ù„Ù…Ø­Ø§ÙŠØ¯)
       - Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ØªØ¹Ø¨ÙŠØ±ÙŠØ© Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ø¨ÙŠØ§Ù†Ø§Øª
       - ØªØ£Ø«ÙŠØ±Ø§Øª hover ÙˆØ§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ø³Ù„Ø³Ø©
       - ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
       - Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø© Ø¨Ø´ÙƒÙ„ Ø¬Ù…ÙŠÙ„ ÙˆÙˆØ§Ø¶Ø­
    
    âœ… 14. ØªÙ†Ø³ÙŠÙ‚ Ù…ÙˆØ­Ù‘Ø¯ Ù„Ù„ÙƒØ´ÙˆÙ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
       - ØªÙˆØ­ÙŠØ¯ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨ÙŠÙ† ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆÙƒØ´ÙˆÙ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
       - Ø­Ù‚ÙˆÙ„ ØµØºÙŠØ±Ø© Ù…Ø±ØªØ¨Ø© Ø£ÙÙ‚ÙŠØ§Ù‹ Ø¨Ø´ÙƒÙ„ Ø£Ù†ÙŠÙ‚
       - Ù…Ø³Ø§ÙØ§Øª Ù…Ø­Ø³ÙˆØ¨Ø© ÙˆÙ…ØªØ³Ù‚Ø©
       - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ classes ÙˆØ£Ù†Ù…Ø§Ø· CSS
       - ØªØ¬Ø±Ø¨Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ­Ø¯Ø© ÙˆÙ…Ø£Ù„ÙˆÙØ©
    
    ğŸ†• Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 21.0:
    âœ… 8. Ù†Ø¸Ø§Ù… Ø§Ù„Ø®ØµÙ… ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
       - Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ø®ØµÙ… ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
       - Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
       - Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… (ÙˆÙ„ÙŠØ³ Ù‚Ø¨Ù„Ù‡)
       - Ø¹Ø±Ø¶ Ø§Ù„Ø®ØµÙ… ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
       - Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ØµÙ… ÙÙŠ Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹ Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ
       - ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù„ØªØ´Ù…Ù„ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø®ØµÙ…
       - ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„ØªÙˆØ§ÙÙ‚
       - Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø³Ø§Ù„Ø¨Ø© ÙˆØ§Ù„Ø£Ø®Ø·Ø§Ø¡
       - Ø¯Ø¹Ù… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ù…Ø¹ Ø§Ù„Ø®ØµÙ…
       - ÙˆØ§Ø¬Ù‡Ø© Ø³Ù‡Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    
    âœ… 9. Ù†Ø¸Ø§Ù… Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
       - Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ (ÙƒØ§Ø´ØŒ Ø¨Ù†ÙƒØŒ Ù…Ø®ØªÙ„Ø·)
       - Ø¹Ø±Ø¶ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
       - Ø¥Ø¶Ø§ÙØ© Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ ÙÙŠ Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
       - ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù„ØªØ´Ù…Ù„ Ø¹Ù…ÙˆØ¯ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
       - ÙÙ„ØªØ±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø­Ø³Ø¨ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
       - ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„ØªØ´Ù…Ù„ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (ÙƒØ§Ø´)
       - Ø¯Ø¹Ù… ØªØ¹Ø¯ÙŠÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ ÙÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
       - Ø±Ù…ÙˆØ² Ù…Ø±Ø¦ÙŠØ© Ù…Ù…ÙŠØ²Ø© Ù„ÙƒÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø¯ÙØ¹
    
    ğŸ”´ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø£Ø¯Ø§Ø¡:
    âœ… 1. Ù†Ø¸Ø§Ù… ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± (SHA-256)
       - ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
       - Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
       
    âœ… 2. Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Loading Indicators)
       - Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
       - Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ«/Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
       - Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
       
    âœ… 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Error Handling)
       - Ù†Ø¸Ø§Ù… logError Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
       - Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ localStorage
       - Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ ÙˆØ§Ø¶Ø­Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
       - Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
    
    âœ… 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Input Validation)
       - ValidationHelper: Ù…Ø¬Ù…ÙˆØ¹Ø© Ø´Ø§Ù…Ù„Ø© Ù…Ù† Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚
       - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© ÙˆØ§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰/Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·ÙˆÙ„
       - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙˆØ¬Ø¨Ø© ÙˆØ§Ù„Ù†Ø·Ø§Ù‚Ø§Øª
       - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ
       - Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø£ÙƒÙˆØ§Ø¯
       - ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø£Ø­Ù…Ø± Ù„Ù„Ø®Ø·Ø£ØŒ Ø£Ø®Ø¶Ø± Ù„Ù„ØµØ­ÙŠØ­)
       - Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ ÙˆØ§Ø¶Ø­Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù…Ø¹ ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ©
    
    ğŸ”µ ØªØ­Ø³ÙŠÙ†Ø§Øª ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
    âœ… 5. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ
       - Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
       - ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¯ÙŠÙˆÙ† ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©
       - Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªÙŠ Ù†ÙØ°Øª
       - 4 Ø£Ù†ÙˆØ§Ø¹ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ù†Ø¬Ø§Ø­ØŒ ØªØ­Ø°ÙŠØ±ØŒ Ø®Ø·Ø£ØŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª)
       
    âœ… 6. Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
       - Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ø¥Ù„Ù‰ Ø³Ù„Ø© Ù…Ø­Ø°ÙˆÙØ§Øª
       - Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…
       - Ø­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
       - Ø¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø£ØµÙ†Ø§ÙØŒ Ø¹Ù…Ù„Ø§Ø¡ØŒ Ù…ÙˆØ±Ø¯ÙŠÙ†ØŒ Ø¥Ù„Ø®)
    
    âœ… 7. Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Professional Confirm Dialog)
       - Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ confirm() Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© Ø¨Ø­ÙˆØ§Ø±Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠØ©
       - ØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠ Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ù„ÙˆÙ†Ø©
       - 4 Ø£Ù†ÙˆØ§Ø¹ Ù…Ù† Ø§Ù„Ø­ÙˆØ§Ø±Ø§Øª (ØªØ­Ø°ÙŠØ±ØŒ Ø®Ø·Ø±ØŒ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŒ Ù†Ø¬Ø§Ø­)
       - Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­ÙˆØ§Ø± Ø£Ùˆ Ø¨Ø²Ø± Escape
       - Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ø¶Ø­Ø© Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Ù…Ø®ØµØµØ© Ù„ÙƒÙ„ Ø­Ø§Ù„Ø©
       - ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© Ø³Ù„Ø³Ø© (Animations)
    
    ğŸ—ï¸ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ©:
    - HTML5 + CSS3 + JavaScript (Vanilla)
    - Firebase Realtime Database + Firebase Authentication
    - Ø§ØªØ¬Ø§Ù‡ RTL ÙƒØ§Ù…Ù„ Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
    - ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ (Mobile-First)
    - Ù†Ø¸Ø§Ù… Ù…ØªØºÙŠØ±Ø§Øª CSS Ù„Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø®Ø·ÙˆØ·
    - Local Storage Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
    - Session Storage Ù„Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    - Ù†Ø¸Ø§Ù… Ù‡Ø¬ÙŠÙ†: Firebase (Ø§Ù„Ø³Ø­Ø§Ø¨Ø©) + LocalStorage (Ù…Ø­Ù„ÙŠ)
    
    ğŸ” Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø®ØµÙˆØµÙŠØ©:
    - ØªØ´ÙÙŠØ± SHA-256 Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±
    - Firebase Authentication Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    - Firebase Security Rules Ù„Ù„Ø­Ù…Ø§ÙŠØ©
    - Ø¹Ø¯Ù… ØªØ®Ø²ÙŠÙ† ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Database
    - Ù…ÙŠØ²Ø© "ØªØ°ÙƒØ±Ù†ÙŠ" Ø¢Ù…Ù†Ø© (30 ÙŠÙˆÙ…)
    - Ø­Ù…Ø§ÙŠØ© Ù…Ù† CSRF Ùˆ XSS
    - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
    
    â˜ï¸ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©:
    - Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø² Ø¨Ù†ÙØ³ Ø§Ù„Ø­Ø³Ø§Ø¨
    - Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    - Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Firebase
    - LocalStorage ÙƒÙ†Ø¸Ø§Ù… Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    - Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª (Offline Mode)
    - Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
    
    ğŸ‘¨â€ğŸ’» Ø§Ù„Ù…Ø·ÙˆØ±: GitHub Copilot + Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    ğŸ“… Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: 8 Ù†ÙˆÙÙ…Ø¨Ø± 2025
    ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø±: v23.0 (Firebase Integration Edition)
    ========================================
-->
<head>
    <title>Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ - Ø¯ÙŠÙˆØ§Ù†ÙŠ</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Preconnect Ù„Ù„Ø®Ø·ÙˆØ· Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Ø§Ù„ÙØ§ÙÙŠÙƒÙˆÙ† -->
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dgjcr2bgq/image/upload/v1762349658/logo_vlldbc.png">
    <link rel="shortcut icon" type="image/png" href="https://res.cloudinary.com/dgjcr2bgq/image/upload/v1762349658/logo_vlldbc.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Reem+Kufi&display=swap" rel="stylesheet">
    
    <!-- CSS Ù…Ø®ØµØµ Ù„Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
    <style>
        /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¨Ø´ÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ */
        #data-monitor-modal {
            display: none !important;
            position: fixed !important;
            z-index: 10001 !important;
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0,0,0,0.6) !important;
            justify-content: center !important;
            align-items: center !important;
        }
        
        #data-monitor-modal.show {
            display: flex !important;
        }
        
        #data-monitor-modal .modal-content {
            background: white !important;
            margin: auto !important;
            padding: 20px !important;
            border-radius: 10px !important;
            max-width: 800px !important;
            width: 90% !important;
            max-height: 90% !important;
            overflow-y: auto !important;
            position: relative !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
        }
        
        #data-monitor-modal .close {
            cursor: pointer !important;
            font-size: 28px !important;
            color: #999 !important;
            font-weight: bold !important;
            line-height: 1 !important;
            padding: 0 !important;
            border: none !important;
            background: none !important;
        }
        
        #data-monitor-modal .close:hover {
            color: #333 !important;
        }
    </style>
    
    <!-- Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© - Firebase Ø¨Ø¯ÙˆÙ† defer Ù„Ø£Ù†Ù‡ Ù…Ø·Ù„ÙˆØ¨ ÙÙˆØ±Ø§Ù‹ -->

<script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, set, get, update, remove, onValue, push, child } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase Configuration - Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ± (Development)
        const firebaseConfig = {
            apiKey: "AIzaSyD0vzY_eb9sN2uh5sn4cJyYQSI6YoyJAeI",
            authDomain: "diwanitestapp.firebaseapp.com",
            databaseURL: "https://diwanitestapp-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "diwanitestapp",
            storageBucket: "diwanitestapp.firebasestorage.app",
            messagingSenderId: "296228843355",
            appId: "1:296228843355:web:e2a30eced24e7fef16747e",
            measurementId: "G-7P91XB244P"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;
        window.firebaseModules = {
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            ref,
            set,
            get,
            update,
            remove,
            onValue,
            push,
            child
        };

        // ØªØ¹Ø±ÙŠÙ DEBUG_MODE Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† Ø¹Ù„Ù‰ window (Ù…Ø¹ Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©)
        window.DEBUG_MODE = typeof window.DEBUG_MODE === 'boolean' ? window.DEBUG_MODE : false;

        // ÙÙ„ØªØ±Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„: Ø¥Ø¸Ù‡Ø§Ø± info/log ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ DEBUG_MODEØŒ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª/Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¯Ø§Ø¦Ù…Ø§Ù‹
        (function setupConsoleFilter(){
            try {
                const original = window.__ORIGINAL_CONSOLE__ || window.console;
                if (!window.__ORIGINAL_CONSOLE__) {
                    window.__ORIGINAL_CONSOLE__ = original;
                }
                const filtered = {
                    ...original,
                    log: (...args) => { if (window.DEBUG_MODE) original.log(...args); },
                    info: (...args) => { if (window.DEBUG_MODE) (original.info ? original.info(...args) : original.log(...args)); },
                    debug: (...args) => { if (window.DEBUG_MODE && original.debug) original.debug(...args); },
                    warn: (...args) => (original.warn ? original.warn(...args) : original.log(...args)),
                    error: (...args) => (original.error ? original.error(...args) : original.log(...args)),
                };
                window.console = filtered;
            } catch (e) {
                // ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙÙ„ØªØ±
            }
        })();

        if (window.DEBUG_MODE) {
            console.log('âœ… Firebase initialized successfully!');
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø© Ù„ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Google services
        window.addEventListener('error', function(event) {
            // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ iframe.js Ùˆall-frames.js (Google services)
            if (event.filename && (event.filename.includes('iframe.js') || event.filename.includes('all-frames.js'))) {
                console.log('ğŸ”‡ ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø®Ø·Ø£ Google service:', event.message);
                event.preventDefault();
                return false;
            }
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø·
            if (event.error && event.error.message && !event.error.message.includes('postMessage')) {
                console.warn('âš ï¸ Ø®Ø·Ø£ Ø¹Ø§Ù…:', event.error.message);
            }
        });

        // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ postMessage 
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && 
                (event.reason.message.includes('Could not establish connection') ||
                 event.reason.message.includes('postMessage') ||
                 event.reason.message.includes('target origin'))) {
                console.log('ğŸ”‡ ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø®Ø·Ø£ postMessage:', event.reason.message);
                event.preventDefault();
            }
        });
    </script>
    
    <script>
        'use strict';
        
        console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… "ØªØ°ÙƒØ±Ù†ÙŠ" Ø§Ù„Ø¬Ø¯ÙŠØ¯...');
        
        // ÙØ­Øµ ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª (Ù‚Ø¨Ù„ DOMContentLoaded)
        function checkAndAutoLogin() {
                console.log('ğŸ” ÙØ­Øµ Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ"...');
                
                const rememberedUser = localStorage.getItem('rememberedUser');
                if (!rememberedUser) {
                    console.log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ"');
                    return false;
                }
                
                try {
                    const userData = JSON.parse(rememberedUser);
                    const now = new Date().getTime();
                    const dayInMs = 30 * 24 * 60 * 60 * 1000; // 30 ÙŠÙˆÙ…
                    
                    if (userData.timestamp && (now - userData.timestamp) < dayInMs) {
                        console.log('âœ… Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ" ØµØ§Ù„Ø­Ø© - Ø³ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');
                        
                        // Ø¥Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø«Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                        let loginAttempted = false;
                        const waitForElements = setInterval(() => {
                            const loginEmail = document.getElementById('loginEmail');
                            const loginPassword = document.getElementById('loginPassword');
                            const rememberMe = document.getElementById('rememberMe');
                            const loginOverlay = document.getElementById('login-overlay');
                            
                            if (loginEmail && loginPassword && rememberMe && loginOverlay) {
                                clearInterval(waitForElements);
                                loginAttempted = true;
                                
                                // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙˆØ±Ø§Ù‹
                                loginOverlay.style.display = 'none';
                                
                                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                loginEmail.value = userData.email;
                                loginPassword.value = userData.password;
                                rememberMe.checked = true;
                                
                                console.log('ğŸ”‘ ØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ - Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...');
                                
                                // Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯ ÙˆÙ‚Øª Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡
                                setTimeout(() => {
                                    if (typeof handleLogin === 'function') {
                                        handleLogin();
                                        console.log('âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­!');
                                    } else {
                                        console.error('âŒ Ø¯Ø§Ù„Ø© handleLogin ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                                        loginOverlay.style.display = 'flex';
                                    }
                                }, 500);
                                
                                return true;
                            }
                        }, 50); // ÙØ­Øµ ÙƒÙ„ 50ms
                        
                        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙØ­Øµ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
                        setTimeout(() => {
                            clearInterval(waitForElements);
                            if (!loginAttempted) {
                                console.warn('âš ï¸ Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ - Ù„ÙƒÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ');
                                // Ù„Ø§ Ù†ÙØ¸Ù‡Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‡Ù†Ø§ Ù„Ø£Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù‚Ø¯ Ù†Ø¬Ø­ Ø¨Ø§Ù„ÙØ¹Ù„
                            }
                        }, 3000); // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø¥Ù„Ù‰ 3 Ø«ÙˆØ§Ù†
                        
                        return true;
                    } else {
                        console.log('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ" Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
                        localStorage.removeItem('rememberedUser');
                        return false;
                    }
                } catch (e) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ":', e);
                    localStorage.removeItem('rememberedUser');
                    return false;
                }
            }
            
            // ØªØ´ØºÙŠÙ„ ÙÙˆØ±ÙŠ
            const autoLoginSuccessful = checkAndAutoLogin();
            
            // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ù†Ø¹ ØªØ¯Ø®Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø®Ø±Ù‰
            if (autoLoginSuccessful) {
                window.AUTO_LOGIN_IN_PROGRESS = true;
                console.log('ğŸ”’ ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø¹Ù„Ø§Ù…Ø© AUTO_LOGIN_IN_PROGRESS');
            }
            
    </script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */
        .login-form.active {
            display: block !important;
        }
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border-top: 4px solid var(--primary-color);
            margin-bottom: 20px;
        }

        .stat-trend {
            font-size: 0.8em;
            margin-top: 5px;
            font-weight: bold;
        }

        .trend-up { 
            color: var(--success-color); 
        }

        .trend-down { 
            color: var(--accent-color); 
        }

        .analytics-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            .analytics-grid {
                grid-template-columns: 1fr;
            }
      
 
      
        }

        /* Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ */
        * {
            box-sizing: border-box;
        }
        
        html {
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
        }
        
        body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
            position: relative;
        }
        
        /* Ù…Ù†Ø¹ Ø£ÙŠ overflow Ø£ÙÙ‚ÙŠ */
        .section, .container, .form-grid, table, .invoice-items, .report-controls {
            max-width: 100%;
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table {
            table-layout: auto;
            width: 100%;
        }
        
        /* ØªØ­Ø³ÙŠÙ† touch scrolling */
        .invoice-items, .section table {
            -webkit-overflow-scrolling: touch;
        }

        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --bg-color: #ecf0f1;
            --text-color: #2c3e50;
            --font-size: 16px;
            --font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --sidebar-width: 280px;
            --sidebar-bg: #1a3a5c;
            --sidebar-text: #ffffff;
            --header-bg: linear-gradient(135deg, #1a3a5c 0%, #0d2742 100%);
        }
    

/* ===== ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ===== */
.chart-card {
    background: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border-top: 4px solid var(--primary-color);
    margin-bottom: 25px;
    height: 320px;
    position: relative;
    transition: all 0.3s ease;
}

@media (max-width: 480px) {
    .advanced-stats {
        gap: 15px !important;
    }

    .advanced-stats .stat-card {
        padding: 16px 12px;
    }

    .advanced-stats .stat-number {
        font-size: 1.7em;
    }
    th {
        padding: 10px 12px;
    }
}

.chart-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.chart-card canvas {
    width: 100% !important;
    height: 240px !important;
    margin-top: 10px;
}

.chart-card h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
    font-size: 1em;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 10px;
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.analytics-card {
    background: white;
    padding: 10px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-bottom: 20px;
    min-height: 120px;
    border-right: 4px solid var(--success-color);
    transition: all 0.3s ease;
}

.analytics-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.analytics-card h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
    font-size: 1.1em;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 8px;
    font-weight: 700;
}

.analytics-card p {
    margin: 8px 0;
    font-size: 14px;
    line-height: 1.5;
    color: var(--text-color);
}

.analytics-card strong {
    color: var(--secondary-color);
    font-weight: 700;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø¨ÙƒØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ© */
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 25px;
    margin: 30px 0;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ© */
.stat-card {
    background: white;
    padding: 10px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border-top: 5px solid var(--primary-color);
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color), var(--success-color));
}

.stat-number {
    font-size: 1.8em;
    font-weight: bold;
    color: var(--primary-color);
    margin: 8px 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-label {
    color: var(--secondary-color);
    font-size: 0.9em;
    font-weight: 600;
    margin-bottom: 8px;
}

.stat-trend {
    font-size: 0.9em;
    margin-top: 8px;
    font-weight: bold;
    padding: 4px 12px;
    border-radius: 20px;
    display: inline-block;
}

.trend-up {
    background: rgba(39, 174, 96, 0.1);
    color: var(--success-color);
}

.trend-down {
    background: rgba(231, 76, 60, 0.1);
    color: var(--accent-color);
}

/* ØªØ®ØµÙŠØµ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */
.advanced-stats {
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)) !important;
    gap: 20px !important;
    margin-bottom: 30px;
}

.advanced-stats .stat-card {
    padding: 20px 15px;
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.advanced-stats .stat-number {
    font-size: 2.4em;
    margin: 10px 0;
}

.advanced-stats .stat-label {
    font-size: 1.1em;
    margin-bottom: 8px;
}

.advanced-stats .stat-trend {
    font-size: 0.95em;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© */
@media (max-width: 1024px) {
    .analytics-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .charts-container {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .chart-card {
        height: 350px;
        padding: 20px;
    }
    
    .chart-card canvas {
        height: 250px !important;
    }
    
    .stat-number {
        font-size: 1.8em;
    }
    
    .analytics-card {
        padding: 15px;
        min-height: 140px;
    }

    .advanced-stats .stat-card {
        aspect-ratio: auto;
        padding: 18px 15px;
    }
    
    /* ğŸ†• Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© - Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    .charts-section > div[style*="grid"] {
        grid-template-columns: 1fr !important;
    }

    .advanced-stats .stat-number {
        font-size: 2em;
    }

    /* ğŸ“„ Ø§Ù„ØªØ°ÙŠÙŠÙ„ - ØªØ®Ø·ÙŠØ· Ø¹Ù…ÙˆØ¯ÙŠ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    #appFooter > div > div[style*="grid"] {
        grid-template-columns: 1fr !important;
        gap: 20px !important;
    }

    #appFooter {
        padding: 20px 15px !important;
        margin-top: 30px !important;
        margin-right: 0 !important; /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ø£ÙŠÙ…Ù† Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    }

    #appFooter h4 {
        font-size: 16px !important;
    }

    #appFooter p, #appFooter span, #appFooter a {
        font-size: 13px !important;
    }

    .section {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 15px 10px;
    }

    .section table {
        min-width: 540px;
    }

    table {
        font-size: calc(var(--font-size) * 0.85);
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }

    th,
    td {
        padding: 8px 6px;
        font-size: 13px;
    }
    
    /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª */
    .container {
        width: 100%;
        max-width: 100vw;
        padding: 10px 5px;
        overflow-x: hidden;
    }
    
    /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        justify-content: center;
    }
    
    .action-buttons button {
        font-size: 12px;
        padding: 6px 10px;
        min-width: auto;
    }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„ØªØ¯Ø±Ø¬Ø§Øª */
.charts-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin: 30px 0;
}

/* ØªØ£Ø«ÙŠØ±Ø§Øª ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
.chart-loading {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
.chart-card h3, 
.analytics-card h3,
.stat-label {
    font-family: 'Tajawal', sans-serif;
    font-weight: 700;
}

/* ØªØ®ØµÙŠØµ Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
:root {
    --chart-color-1: #2c5aa0;
    --chart-color-2: #27ae60;
    --chart-color-3: #e74c3c;
    --chart-color-4: #f39c12;
    --chart-color-5: #9b59b6;
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ===== */
#global-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    display: none;
}

.loader-overlay {
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

.loader-content {
    background: white;
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    text-align: center;
    animation: fadeIn 0.3s ease;
}

.spinner {
    width: 60px;
    height: 60px;
    margin: 0 auto 20px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loader-message {
    color: var(--text-color);
    font-size: 1.1em;
    font-weight: 600;
    margin: 0;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}
/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ===== */

/* ===== Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ===== */
#notifications-container {
    position: fixed;
    top: 80px;
    left: 20px;
    z-index: 99999;
    max-width: 400px;
    pointer-events: none;
}

.notification {
    background: white;
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 12px;
    box-shadow: 0 6px 25px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.4s ease;
    pointer-events: all;
    cursor: pointer;
    transition: all 0.3s ease;
    border-right: 4px solid var(--primary-color);
}

.notification:hover {
    transform: translateX(-5px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
}

.notification.success {
    border-right-color: var(--success-color);
}

.notification.warning {
    border-right-color: #f39c12;
}

.notification.error {
    border-right-color: var(--accent-color);
}

.notification.info {
    border-right-color: var(--primary-color);
}

.notification-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: 700;
    font-size: 0.95em;
    margin-bottom: 4px;
    color: var(--text-color);
}

.notification-message {
    font-size: 0.85em;
    color: #666;
    line-height: 1.4;
}

.notification-close {
    font-size: 20px;
    color: #999;
    cursor: pointer;
    padding: 4px;
    flex-shrink: 0;
}

.notification-close:hover {
    color: var(--accent-color);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideOut {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(100px);
    }
}

.notification.removing {
    animation: slideOut 0.3s ease forwards;
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± */
.notification-bell {
    position: relative;
    cursor: pointer;
    padding: 8px 12px;
    font-size: 1.3em;
    transition: all 0.3s ease;
}

.notification-bell:hover {
    color: var(--primary-color);
    transform: scale(1.1);
}

.notification-badge {
    position: absolute;
    top: 4px;
    right: 4px;
    background: var(--accent-color);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ===== */

/* ===== Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Confirm Dialog) ===== */
.confirm-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 10000;
    backdrop-filter: blur(3px);
    animation: fadeIn 0.3s ease;
}

.confirm-overlay.active {
    display: flex;
    justify-content: center;
    align-items: center;
}

.confirm-dialog {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    max-width: 480px;
    width: 90%;
    overflow: hidden;
    animation: scaleIn 0.3s ease;
    font-family: var(--font-family);
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.confirm-header {
    padding: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    border-bottom: 2px solid #f0f0f0;
}

.confirm-icon {
    font-size: 48px;
    line-height: 1;
}

.confirm-header.warning .confirm-icon {
    color: #f39c12;
}

.confirm-header.danger .confirm-icon {
    color: #e74c3c;
}

.confirm-header.info .confirm-icon {
    color: var(--primary-color);
}

.confirm-header.success .confirm-icon {
    color: var(--success-color);
}

.confirm-title {
    font-size: 1.4em;
    font-weight: 700;
    color: var(--text-color);
}

.confirm-body {
    padding: 24px;
    font-size: 1.05em;
    line-height: 1.6;
    color: #555;
}

.confirm-footer {
    padding: 20px 24px;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: #f8f9fa;
    border-top: 1px solid #e0e0e0;
}

.confirm-footer button {
    padding: 12px 28px;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: var(--font-family);
}

.confirm-btn-cancel {
    background: #e0e0e0;
    color: #666;
}

.confirm-btn-cancel:hover {
    background: #d0d0d0;
    transform: translateY(-2px);
}

.confirm-btn-confirm {
    background: var(--primary-color);
    color: white;
}

.confirm-btn-confirm:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

.confirm-btn-confirm.danger {
    background: #e74c3c;
}

.confirm-btn-confirm.danger:hover {
    background: #c0392b;
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
}

.confirm-btn-confirm.success {
    background: var(--success-color);
}

.confirm-btn-confirm.success:hover {
    background: #229954;
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}

/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ===== */

/* ===== Ø£Ù†Ù…Ø§Ø· Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ===== */
.edit-activity-modal input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    background: white;
    transform: translateY(-1px);
}

.edit-activity-modal button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2) !important;
}

.edit-activity-modal button:active {
    transform: translateY(0);
}

@media (max-width: 600px) {
    .edit-activity-modal {
        margin: 10px;
        max-width: calc(100% - 20px) !important;
    }
    
    .edit-activity-header {
        padding: 20px !important;
    }
    
    .edit-activity-body {
        padding: 20px !important;
    }
    
    .edit-activity-footer {
        padding: 15px 20px !important;
        flex-direction: column;
    }
    
    .edit-activity-footer button {
        width: 100%;
        margin-bottom: 10px;
    }
    
    .edit-activity-footer button:last-child {
        margin-bottom: 0;
    }
}

/* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù†ØªÙ‚Ø§Ù„ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø© */
.edit-activity-modal {
    transform-origin: center;
}

#edit-activity-overlay.show {
    display: flex !important;
    animation: fadeIn 0.3s ease;
}

#edit-activity-overlay.show .edit-activity-modal {
    animation: bounceIn 0.4s ease;
}

@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: scale(0.3) translateY(-50px);
    }
    50% {
        opacity: 1;
        transform: scale(1.05) translateY(0);
    }
    70% {
        transform: scale(0.95);
    }
    100% {
        transform: scale(1);
    }
}

#edit-activity-overlay.hide {
    animation: fadeOut 0.3s ease;
}

#edit-activity-overlay.hide .edit-activity-modal {
    animation: zoomOut 0.3s ease;
}

@keyframes zoomOut {
    0% {
        opacity: 1;
        transform: scale(1);
    }
    100% {
        opacity: 0;
        transform: scale(0.8);
    }
}
/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· ===== */

/* ===== Ø£Ù†Ù…Ø§Ø· Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ===== */
#trash-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

#trash-modal.active {
    display: flex;
}

.trash-content {
    background: white;
    border-radius: 15px;
    padding: 30px;
    max-width: 900px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    animation: fadeIn 0.3s ease;
}

.trash-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #eee;
}

.trash-header h2 {
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 10px;
}

.trash-tabs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 8px;
    margin-bottom: 20px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 8px;
}

.trash-tab {
    padding: 10px 8px;
    background: white;
    border: none;
    cursor: pointer;
    font-size: 0.8em;
    color: #666;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    text-align: center;
    white-space: normal;
    word-wrap: break-word;
}

.trash-tab:hover {
    color: var(--primary-color);
    background: #f0f8ff;
    transform: translateY(-2px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.trash-tab.active {
    color: white;
    background: var(--primary-color);
    font-weight: bold;
    box-shadow: 0 3px 8px rgba(44, 120, 208, 0.3);
}

.trash-items {
    margin-top: 20px;
}

.trash-item {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.trash-item:hover {
    background: #f0f0f0;
    border-color: var(--primary-color);
}

.trash-item-info {
    flex: 1;
}

.trash-item-name {
    font-weight: bold;
    color: var(--text-color);
    margin-bottom: 5px;
}

.trash-item-meta {
    font-size: 0.85em;
    color: #666;
}

.trash-item-actions {
    display: flex;
    gap: 8px;
}

.trash-empty-state {
    text-align: center;
    padding: 40px;
    color: #999;
}

.trash-empty-state i {
    font-size: 4em;
    margin-bottom: 15px;
    opacity: 0.3;
}

.trash-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    gap: 8px;
    margin-bottom: 15px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 8px;
}

.trash-stat {
    text-align: center;
    padding: 8px 6px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.trash-stat:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.trash-stat-value {
    font-size: 1.6em;
    font-weight: bold;
    color: var(--primary-color);
}

.trash-stat-label {
    font-size: 0.75em;
    color: #666;
    margin-top: 2px;
    white-space: normal;
    word-wrap: break-word;
    line-height: 1.2;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width: 768px) {
    .trash-stats {
        grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
        gap: 6px;
        padding: 8px;
    }
    
    .trash-tabs {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    }
    
    .trash-stat {
        padding: 6px 4px;
    }
    
    .trash-stat-value {
        font-size: 1.2em;
    }
    
    .trash-stat-label {
        font-size: 0.65em;
    }
    
    .trash-tab {
        font-size: 0.7em;
        padding: 8px 6px;
    }
}
/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ===== */


    * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); font-size: var(--font-size); background: var(--bg-color); color: var(--text-color); direction: rtl; line-height: 1.6; min-height: 100vh; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(5px); }
        #login-overlay.active ~ #appFooter { display: none !important; }
        #login-box { background: white; padding: 40px; border-radius: var(--border-radius); box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 420px; text-align: center; animation: fadeIn 0.5s ease; }
        
        /* Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        .login-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            display: block;
            object-fit: contain;
            animation: scaleIn 0.6s ease;
        }
        
        #login-box h2 { color: var(--primary-color); margin-bottom: 25px; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: var(--border-radius); font-size: calc(var(--font-size) * 0.95); }
        #login-error { color: var(--accent-color); margin-bottom: 15px; display: none; font-weight: bold; }
        .login-role-selector button { width: 100%; margin-bottom: 10px; padding: 15px; font-size: 1.1em; }
        .login-form { display: none; }
        .back-to-roles { color: var(--primary-color); cursor: pointer; display: block; margin-top: 20px; font-weight: bold; }
        
        /* First Setup Overlay Styles */
        #first-setup-overlay button:hover { background: rgba(255,255,255,0.3) !important; transform: translateY(-2px); }
        #first-setup-overlay .login-input::placeholder { color: rgba(0,0,0,0.6); }
        #first-setup-overlay .login-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(255,255,255,0.3); }

        #activity-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(8px); }
        #activity-box { background: white; padding: 40px; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.25); width: 100%; max-width: 500px; text-align: center; animation: fadeIn 0.5s ease; }
        #activity-box h2 { color: var(--primary-color); margin-bottom: 25px; }
        #activity-list { max-height: 200px; overflow-y: auto; margin-bottom: 20px; }
        .activity-btn { 
            width: 100%; 
            margin-bottom: 10px; 
            padding: 18px; 
            font-size: 1.1em; 
            white-space: normal; 
            word-wrap: break-word; 
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .app-container { display: flex; min-height: 100vh; }
        .container { flex: 1; margin-right: var(--sidebar-width); padding: 20px; transition: margin-right 0.3s ease; }
        .sidebar { width: var(--sidebar-width); background: var(--sidebar-bg); height: 100vh; position: fixed; right: 0; top: 0; box-shadow: var(--shadow); padding: 20px; overflow-y: auto; z-index: 100; }
        .sidebar-header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--primary-color); }
        .sidebar-header h1 { color: var(--sidebar-text); font-size: 1.5em; margin-bottom: 5px; }
        .sidebar-header .subtitle { color: #bdc3c7; font-size: 0.9em; }
        .sidebar-nav { display: flex; flex-direction: column; gap: 5px; }
        .sidebar-nav button { padding: 12px 15px; border: none; background: transparent; color: var(--sidebar-text); border-radius: var(--border-radius); cursor: pointer; font-size: calc(var(--font-size) * 0.9); font-weight: 500; transition: all 0.3s ease; text-align: right; border: 1px solid transparent; width: 100%; }
        .sidebar-nav button:hover { background: rgba(255, 255, 255, 0.1); transform: translateX(-3px); color: white; border-color: var(--primary-color); }
    .sidebar-nav button.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .user-section { margin-top: 25px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: var(--border-radius); border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; }
    /* Ø´Ø§Ø±Ø© Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
    .current-user { background: #2c3e50; color: #ecf0f1; padding: 12px; border-radius: var(--border-radius); font-weight: bold; font-size: 0.95em; line-height: 1.4; }
    .current-user .user-name { display: block; font-size: 1em; margin-bottom: 6px; }
    .current-user .user-description { display: block; font-size: 0.85em; opacity: 0.85; }
    /* Ø£Ù„ÙˆØ§Ù† Ù…Ø®ØµØµØ© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± */
    .current-user.role-admin { background: var(--success-color); color: #fff; }
    .current-user.role-manager { background: #2c78d0; color: #fff; }
    .current-user.role-user { background: #2980b9; color: #fff; }
        .header { display: flex; align-items: center; justify-content: center; margin-bottom: 30px; padding: 40px; background: var(--header-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); position: relative; color: white; }
        .header-logo { position: absolute; right: 30px; top: 50%; transform: translateY(-50%); width: 80px; height: 80px; object-fit: contain; border-radius: 8px; background: white; padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .header-content { text-align: center; flex: 1; }
        .header h1 { color: white; font-size: calc(var(--font-size) * 2); margin-bottom: 10px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .header .subtitle { color: rgba(255, 255, 255, 0.9); font-size: calc(var(--font-size) * 1.1); }
        .developer-credit { position: absolute; left: 20px; bottom: 20px; color: rgba(255, 255, 255, 0.8); font-size: calc(var(--font-size) * 0.8); font-style: italic; }
    .design-toggle { position: fixed; top: 20px; left: 20px; background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; font-size: 20px; box-shadow: var(--shadow); transition: all 0.3s ease; z-index: 101; }
    .design-toggle:hover { transform: scale(1.1); background: var(--secondary-color); }
        .control-panel { 
            position: fixed; 
            top: 20px; 
            right: calc(var(--sidebar-width) + 20px); 
            background: white; 
            padding: 20px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow); 
            z-index: 1000; 
            max-width: 300px; 
            max-height: 85vh; 
            overflow-y: auto; 
            display: none; 
        }
        .control-panel.show { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .control-panel h3 { color: var(--primary-color); margin-bottom: 15px; text-align: center; font-size: 1.1em; }
        .control-group { margin-bottom: 12px; }
        .control-group label { display: block; margin-bottom: 4px; font-weight: 600; color: var(--secondary-color); font-size: 0.9em; }
        .color-picker { width: 100%; height: 35px; border: none; border-radius: 5px; cursor: pointer; }
        .font-size-control { width: 100%; }
        
        /* ØªØ­Ø³ÙŠÙ† Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .control-panel::-webkit-scrollbar {
            width: 6px;
        }
        .control-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .control-panel::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }
        .control-panel::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
        .section { display: none; background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 20px; min-height: 500px; }
        .section.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .section h2 { 
            color: var(--primary-color); 
            margin-bottom: 25px; 
            font-size: calc(var(--font-size) * 1.5); 
            border-bottom: 3px solid var(--primary-color); 
            padding-bottom: 10px; 
            display: flex; /* Use flexbox */
            justify-content: space-between; /* Space between title and card */
            align-items: center; /* Align items vertically */
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .settings-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e3f2fd;
            flex-wrap: wrap;
        }
        
        .settings-tab {
            padding: 15px 30px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #546e7a;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .settings-tab:hover {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .settings-tab.active {
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
            color: white;
            border-bottom: 3px solid #0d47a1;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }
        
        .settings-tab-content {
            display: none;
        }
        
        .settings-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .settings-grid { display: flex; flex-direction: column; gap: 25px; }
    .settings-card { background: #ffffff; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 25px; display: flex; flex-direction: column; gap: 20px; width: 100%; position: relative; overflow: hidden; }
    .logo-settings { min-height: 500px; }
    .logo-settings .tips-container { margin-top: auto; }
    .settings-card::before { content: ''; position: absolute; top: 0; right: 0; left: 0; height: 4px; background: linear-gradient(90deg, #1976d2, #42a5f5); }
        .settings-card h3 { margin-top: 0; }
        .settings-card .data-actions { margin: 0; }
        .settings-card .data-actions-grid { gap: 15px; }

        .user-selector-controls select,
        .activity-selector-controls select { width: 100%; max-width: 320px; }

        .title-stat-card {
            background-color: #fff;
            color: #1a3556;
            border: none;
            padding: 8px 18px 10px;
            border-radius: var(--border-radius);
            font-size: 0.9em;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .title-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        }

        .title-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px #FFD70099, 0 2px 8px rgba(0,0,0,0.08);
        }

        .title-stat-card .stat-mini-label {
            font-weight: normal;
            margin-left: 8px;
            color: #1a3556;
        }

        .title-stat-card .stat-mini-number {
            font-weight: 700;
            font-size: 1.2em;
        }

        .search-container { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .search-input { flex: 1; min-width: 200px; padding: 12px 15px; border: 2px solid #ddd; border-radius: var(--border-radius); font-size: calc(var(--font-size) * 0.95); transition: all 0.3s ease; font-family: var(--font-family); }
        .search-input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        
        /* Advanced Filters */
        .filters-container { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: var(--border-radius); 
            margin-bottom: 20px; 
            border: 2px solid #e0e0e0;
            display: none;
        }
        .filters-container.show { display: block; animation: slideIn 0.3s ease; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: calc(var(--font-size) * 0.9); color: #555; font-weight: 600; }
        .filter-input { 
            padding: 10px 12px; 
            border: 2px solid #ddd; 
            border-radius: var(--border-radius); 
            font-size: calc(var(--font-size) * 0.9);
            transition: all 0.3s ease;
            font-family: var(--font-family);
        }
        .filter-input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        .filter-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; }
        .toggle-filters-btn { 
            padding: 12px 24px; 
            background: #2196F3; 
            color: white; 
            border: none; 
            border-radius: var(--border-radius); 
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: var(--font-family);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .toggle-filters-btn:hover { 
            background: #1976D2; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Sortable Table Headers */
        .sortable { 
            cursor: pointer; 
            user-select: none; 
            position: relative;
            transition: all 0.3s ease;
        }
        .sortable.asc::after { content: 'â†‘'; opacity: 1; color: #4CAF50; position: absolute; left: 8px; font-size: 0.8em; }
        .sortable.desc::after { content: 'â†“'; opacity: 1; color: #f44336; position: absolute; left: 8px; font-size: 0.8em; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 25px; }
        .stat-card { 
            background: white; 
            padding: 25px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow); 
            border-top: 5px solid var(--primary-color); 
            text-align: center; 
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
        }
        .stat-card h3 { color: var(--secondary-color); margin-bottom: 15px; font-size: calc(var(--font-size) * 1.1); }
        .stat-number { 
            font-size: calc(var(--font-size) * 2.5); 
            font-weight: bold; 
            color: var(--primary-color); 
            margin: 15px 0; 
        }
        .stat-label { 
            color: var(--secondary-color); 
            font-size: calc(var(--font-size) * 1);
            font-weight: 600;
        }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: calc(var(--font-size) * 0.95); }
        th { background: var(--primary-color); color: white; padding: 15px; text-align: right; font-weight: 600; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: right; }
        tr:hover { background: #f8f9fa; }
    .form-grid { display: grid; gap: 20px; margin-bottom: 30px; }
    .grid-5 { grid-template-columns: repeat(5, 1fr); }
    .grid-users { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .data-actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    @media (min-width: 768px) {
        .data-actions-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        input, select, textarea { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: var(--border-radius); font-size: calc(var(--font-size) * 0.95); transition: all 0.3s ease; font-family: var(--font-family); }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        button { padding: 10px 15px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: calc(var(--font-size) * 0.95); font-weight: 600; transition: all 0.3s ease; font-family: var(--font-family); }
    .btn-primary { background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; border: none; }
    .btn-primary:hover { background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(25, 118, 210, 0.4); }
    .btn-add { background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); color: white; border: none; }
    .btn-add:hover { background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4); }
    .btn-success { background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; border: none; }
    .btn-success:hover { background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(25, 118, 210, 0.4); }
    .btn-success.code-generator-btn { background: linear-gradient(135deg, #0277bd 0%, #01579b 100%); color: #ffffff; border: none; box-shadow: 0 2px 6px rgba(1, 87, 155, 0.3); }
    .btn-success.code-generator-btn:hover { background: linear-gradient(135deg, #01579b 0%, #01396a 100%); color: #ffffff; box-shadow: 0 4px 12px rgba(1, 87, 155, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #e53935 0%, #c62828 100%); color: white; border: none; }
        .btn-danger:hover { background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(229, 57, 53, 0.4); }
    .btn-secondary { background: linear-gradient(135deg, #5e92f3 0%, #4a7cda 100%); color: white; border: none; }
    .btn-secondary:hover { background: linear-gradient(135deg, #4a7cda 0%, #3667c5 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(74, 124, 218, 0.4); }
        .btn-info { background: #1abc9c; color: white; }
        .btn-info:hover { background: #16a085; transform: translateY(-2px); }
        #settings .data-actions-grid button { background: #005189; color: #ffffff; border: 1px solid #003f68; box-shadow: 0 2px 6px rgba(0, 81, 137, 0.2); }
        #settings .data-actions-grid button:hover { background: #004373; color: #ffffff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 81, 137, 0.3); }
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨ØªØ¯Ø±Ø¬ Ø£Ø²Ø±Ù‚ */
    .btn-warning { background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%); color: #ffffff; border: none; box-shadow: 0 2px 6px rgba(30, 136, 229, 0.3); }
    .btn-warning:hover { background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); color: #ffffff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4); }
    /* ØªØ®ØµÙŠØµ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨ØªØ¯Ø±Ø¬ Ø£Ø²Ø±Ù‚ */
    .btn-warning.edit-btn { background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%); color: #ffffff; border: none; box-shadow: 0 2px 6px rgba(30, 136, 229, 0.3); }
    .btn-warning.edit-btn:hover { background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); color: #ffffff; box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4); }
    /* ØªØ®ØµÙŠØµ Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨ØªØ¯Ø±Ø¬ Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ */
    .btn-warning.backup-btn { background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); color: #ffffff; border: none; box-shadow: 0 2px 6px rgba(66, 165, 245, 0.3); }
    .btn-warning.backup-btn:hover { background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%); color: #ffffff; box-shadow: 0 4px 12px rgba(66, 165, 245, 0.4); }
      .remaining-unpaid { 
    color: var(--accent-color); /* Ø£Ø­Ù…Ø± - Ø¹Ù„ÙŠÙ‡ Ù…Ø¨Ù„Øº */
    font-weight: bold; 
}
.remaining-paid { 
    color: var(--text-color); /* Ø£Ø³ÙˆØ¯/Ø¹Ø§Ø¯ÙŠ - Ø§Ù„Ø±ØµÙŠØ¯ ØµÙØ± */
    font-weight: normal; 
}
.remaining-credit { 
    color: var(--success-color); /* Ø£Ø®Ø¶Ø± - Ù„Ù‡ Ø±ØµÙŠØ¯ */
    font-weight: bold; 
}
        .report-controls { display: block; margin-bottom: 20px; }
        .report-controls .form-grid label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--secondary-color); }
        .report-controls select, .report-controls input[type="date"] { width: 100%; padding: 12px; font-size: 14px; border: 2px solid #ddd; border-radius: var(--border-radius); }
        .report-controls button { min-width: 150px; }
        .export-options { display: flex; gap: 10px; margin-top: 20px; }
        .report-summary { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: var(--border-radius); }
        .invoice-print { display: none; background: white; padding: 30px; direction: rtl; max-width: 800px; margin: 20px auto; }
        @media print { body * { visibility: hidden; } .invoice-print, .invoice-print * { visibility: visible; } .invoice-print { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; } .no-print { display: none !important; } }
        .invoice-header-print { display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #2c5aa0; }
        .invoice-details { margin: 20px 0; }
        .invoice-items-print table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 1.1em; }
        .invoice-items-print th { background: #e3f2fd; color: #2c5aa0; padding: 12px; text-align: right; font-size: 1.1em; }
        .invoice-items-print th:nth-child(1) { width: 50%; } /* Ø§Ù„ØµÙ†Ù */
        .invoice-items-print th:nth-child(2) { width:35%; text-align: center; } /* Ø§Ù„ÙƒÙ…ÙŠØ© */
        .invoice-items-print th:nth-child(3) { width: 35%; text-align: center; } /* Ø§Ù„Ø³Ø¹Ø± */
        .invoice-items-print th:nth-child(4) { width: 35%; text-align: left; } /* Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ */
        .invoice-items-print td { padding: 10px 12px; border-bottom: 1px solid #ddd; text-align: right; font-size: 1.05em; }
        .invoice-items-print td:nth-child(2) { text-align: center; } /* Ø§Ù„ÙƒÙ…ÙŠØ© */
        .invoice-items-print td:nth-child(3) { text-align: center; } /* Ø§Ù„Ø³Ø¹Ø± */
        .invoice-items-print td:nth-child(4) { text-align: left; direction: ltr; } /* Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ */
    .invoice-totals { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .invoice-totals > div { display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 8px; }
    .invoice-totals > div.total { font-weight: bold; font-size: 1.1em; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; }
    .invoice-totals > div span:last-child { min-width: 120px; text-align: left; direction: ltr; display: inline-block; }
    .invoice-totals input[type="number"] { width: 120px; flex: 0 0 120px; text-align: left; direction: ltr; }
    .invoice-totals select { width: 120px; flex: 0 0 120px; text-align: right; direction: rtl; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .invoice-totals-print { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .invoice-totals-print div { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .invoice-totals-print .total { font-weight: bold; font-size: 1.1em; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; }
        .code-generator-btn { padding: 10px 15px; font-size: calc(var(--font-size) * 0.9); width: auto; min-width: 120px; }
        .user-management { background: #f8f9fa; padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; }
        .user-card { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 15px; border-right: 4px solid var(--primary-color); }
    #settings .user-selector { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 20px; }
    #settings .user-selector-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px; }
    #settings .user-selector-controls select { flex: 1 1 220px; min-width: 200px; padding: 12px; border: 2px solid #ddd; border-radius: var(--border-radius); font-family: var(--font-family); }
    #settings .selected-user-info { display: none; gap: 12px; align-items: center; flex-wrap: nowrap; }
    #settings .selected-user-grid { display: flex; gap: 12px; flex-wrap: nowrap; overflow-x: auto; align-items: center; padding-bottom: 5px; }
    #settings .selected-user-field { flex: 0 0 170px; }
    #settings .selected-user-field.role-field { flex: 0 0 120px; }
    #settings .selected-user-field.phone-field { flex: 0 0 140px; }
    #settings .selected-user-field label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--secondary-color); }
    #settings .selected-user-field input { width: 100%; padding: 8px 10px; border: 2px solid #ddd; border-radius: var(--border-radius); background: #f5f7fb; font-family: var(--font-family); font-size: 0.9em; color: #2c3e50; }
    #settings .selected-user-actions { display: flex; gap: 10px; align-items: center; flex: 0 0 auto; margin-top: 22px; }
    #settings .selected-user-actions button { flex: 0 0 120px; max-width: 130px; padding: 8px 10px; }
    #settings .activity-selector { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 20px; }
    #settings .activity-selector-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px; }
    #settings .activity-selector-controls select { flex: 1 1 220px; min-width: 200px; padding: 12px; border: 2px solid #ddd; border-radius: var(--border-radius); font-family: var(--font-family); }
    #settings .selected-activity-info { display: none; gap: 12px; align-items: center; flex-wrap: nowrap; }
    #settings .selected-activity-field { flex: 0 0 220px; }
    #settings .selected-activity-field label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--secondary-color); }
    #settings .selected-activity-field input { width: 100%; padding: 8px 10px; border: 2px solid #ddd; border-radius: var(--border-radius); background: #f5f7fb; font-family: var(--font-family); font-size: 0.9em; color: #2c3e50; }
    #settings .selected-activity-actions { display: flex; gap: 10px; align-items: center; flex: 0 0 auto; margin-top: 30px; }
    #settings .selected-activity-actions button { flex: 0 0 120px; max-width: 130px; padding: 8px 10px; }
        .user-role { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; margin-right: 10px; }
    .role-admin { background: #e74c3c; color: white; }
    .role-manager { background: #2c78d0; color: white; }
        .role-user { background: #3498db; color: white; }
        .role-viewer { background: #95a5a6; color: white; }
        .user-status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 10px; }
        .status-active { background: #27ae60; }
        .status-inactive { background: #e74c3c; }
        @media (max-width: 1024px) { 
            .sidebar { width: 250px; } 
            .container { margin-right: 250px; } 
            .control-panel { 
                right: calc(250px + 20px); 
                max-height: 80vh; 
            } 
        }
        @media (max-width: 768px) { 
            * { max-width: 100vw; }
            body { flex-direction: column; overflow-x: hidden; width: 100%; } 
            .sidebar { position: fixed; width: 100%; height: 100vh; max-height: 100vh; overflow-y: auto; box-shadow: none; transform: translateX(100%); transition: transform 0.3s ease; padding: 15px; } 
            .sidebar.open { transform: translateX(0); } 
            .container { max-width: 100vw; width: 100%; margin-right: 0; padding: 10px 5px; overflow-x: hidden; box-sizing: border-box; } 
            .control-panel { right: 10px; } 
            .nav { flex-direction: column; } 
            .nav button { width: 100%; } 
            .form-grid { grid-template-columns: 1fr !important; gap: 10px; padding: 0; } 
            .form-grid input, .form-grid select, .form-grid textarea { width: 100%; max-width: 100%; box-sizing: border-box; }
            .control-panel { 
                position: fixed; 
                top: 0; 
                right: 0; 
                left: 0; 
                bottom: 0; 
                max-width: 100vw; 
                max-height: 100vh; 
                z-index: 2000; 
                overflow-y: auto; 
                padding: 15px; 
            } 
            .design-toggle { position: fixed; top: 20px; left: 20px; z-index: 2001; } 
            .invoice-header { flex-direction: column; gap: 10px; align-items: stretch; } 
            .report-controls { flex-direction: column; align-items: stretch; gap: 8px; } 
            .report-controls select, .report-controls input, .report-controls button { width: 100%; max-width: 100%; box-sizing: border-box; } 
            .invoice-header-print { flex-direction: column; gap: 10px; } 
            .search-container { flex-direction: column; gap: 10px; } 
            .search-container input { width: 100%; }
            .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr !important; } 
            .section { padding: 15px 10px; overflow-x: auto; max-width: 100vw; } 
            .section > * { max-width: 100%; }
            table { font-size: 12px; display: block; overflow-x: auto; width: 100%; } 
            th, td { padding: 6px 4px; white-space: nowrap; font-size: 11px; } 
            .invoice-items { overflow-x: auto; -webkit-overflow-scrolling: touch; max-width: 100%; } 
            .invoice-items table { min-width: 500px; display: table; }
            .invoice-totals { padding: 10px; font-size: 14px; }
            .action-buttons { flex-wrap: wrap; gap: 5px; justify-content: center; }
            .action-buttons button { min-width: 70px; padding: 6px 10px; font-size: 12px; }
            button, .btn { padding: 8px 12px; font-size: 13px; }
            
            /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */
            .advanced-stats { 
                display: flex !important; 
                flex-direction: column !important; 
                gap: 15px !important; 
            }
            .advanced-stats .stat-card { 
                width: 100% !important; 
                aspect-ratio: auto !important;
                padding: 20px !important; 
                min-height: 100px;
            }
            .advanced-stats .stat-number { font-size: 2em !important; }
            .advanced-stats .stat-label { font-size: 1em !important; }
            
            /* Ø¥ØµÙ„Ø§Ø­ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
            .charts-container {
                display: flex !important;
                flex-direction: column !important;
                gap: 20px !important;
            }
            .chart-card {
                width: 100% !important;
                height: auto !important;
                min-height: 300px;
                padding: 15px !important;
            }
            .chart-card canvas {
                height: 250px !important;
                max-height: 250px !important;
            }
        }
    .sidebar-toggle { display: none; position: fixed; top: 20px; right: 20px; background: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 10px 15px; cursor: pointer; z-index: 102; }
        @media (max-width: 768px) { .sidebar-toggle { display: block; } 


    }
@media (max-width: 640px) {
    .section {
        overflow-x: visible;
    }

    .section table {
        min-width: 100%;
        display: block;
        border: none;
        background: transparent;
    }

    .section thead {
        display: none;
    }

    .section tbody {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .section tbody tr {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        background: #ffffff;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 14px;
        border: 1px solid #e5e9f2;
    }

    .section tbody tr:hover {
        background: #f8f9fa;
    }

    .section tbody td {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
        border: none;
        text-align: right;
    }

    .section tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--secondary-color);
        flex-shrink: 0;
        min-width: 50px;
        font-size: 0.85em;
    }
    
    /* Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø§Ø³Ù… */
    .section tbody td:nth-child(1),
    .section tbody td:nth-child(2) {
        grid-column: span 1;
    }
    
    /* Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ */
    .section tbody td:nth-child(3),
    .section tbody td:nth-child(4) {
        grid-column: span 1;
    }
    
    /* Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
    .section tbody td:nth-child(5) {
        grid-column: 1;
    }
    
    .section tbody td:last-child {
        grid-column: 2;
        justify-content: flex-start;
        gap: 6px;
        flex-wrap: nowrap;
        flex-direction: row;
    }

    .section tbody td button,
    .section tbody td .btn {
        flex: 0 0 auto;
        min-width: 65px;
        padding: 6px 12px;
        font-size: 11px;
        white-space: nowrap;
    }
}






        /* === START: CSS for new Returns section === */
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

      .btn-whatsapp {
    background-color: #25D366; /* Ù„ÙˆÙ† ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø£Ø®Ø¶Ø± */
    color: white;
}
.btn-whatsapp:hover {
    background-color: #128C7E; /* Ù„ÙˆÙ† Ø£ØºÙ…Ù‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ£Ø´ÙŠØ± */
    transform: translateY(-2px);
}

        .email-btn {
            background-color: #221658;
            color: #ffffff;
            border: 1px solid #1a1246;
            box-shadow: 0 2px 6px rgba(34, 22, 88, 0.25);
        }

        .email-btn:hover {
            background-color: #1b124e;
            color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 22, 88, 0.35);
        }

      
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--secondary-color);
            position: relative;
            bottom: -2px;
        }
        .tab-button.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .return-invoice-details {
            background-color: #f8f9fa;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        .return-invoice-details p { margin-bottom: 5px; }
        .return-item-qty-input { width: 80px !important; padding: 8px !important; text-align: center;}
        /* === END: CSS for new Returns section === */

        .users-settings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-settings-table th,
        .users-settings-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            text-align: right;
        }

        .users-settings-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .users-settings-table tr:hover {
            background: #f8f9fa;
        }

        .activities-management table td:last-child {
            white-space: nowrap !important;
            min-width: 120px !important;
        }

        .activities-management .btn-danger, .activities-management .btn-warning {
            margin: 2px;
            padding: 8px 12px !important;
            font-size: 0.9em !important;
        }

        @media (max-width: 768px) {
            .activities-management table td:last-child {
                min-width: 100px !important;
            }
            
            .activities-management .btn-danger, .activities-management .btn-warning {
                padding: 6px 10px !important;
                font-size: 0.85em !important;
            }
        }



        @media (max-width: 768px) {
            .users-settings-table {
                font-size: 0.9em;
            }
            
            .users-settings-table th,
            .users-settings-table td {
                padding: 8px 10px;
            }
            
            .users-settings-table td:last-child {
                min-width: 100px;
            }
        }

        .report-total-row { background-color: var(--primary-color) !important; color: white !important; font-weight: bold !important; font-size: 1.1em !important; }
        .report-total-row td { padding: 15px !important; border-bottom: 2px solid var(--secondary-color) !important; }
   
        .users-settings-table td:last-child,
        .activities-management table td:last-child {
            white-space: nowrap !important;
            min-width: 120px !important;
            text-align: left !important;
        }

        .users-settings-table .btn-danger {
            margin: 2px;
            padding: 8px 12px !important;
        }

        /* === START: CSS for new Salaries section === */
        #salaries .form-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }

        .salary-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: var(--border-radius);
            border-left: 5px solid var(--primary-color);
        }

        .salary-card h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .salary-summary {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            font-size: 1.05em;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item span:first-child {
            font-weight: 600;
            color: var(--secondary-color);
        }

        .summary-item span:last-child {
            font-weight: bold;
        }

        .summary-total {
            font-size: 1.3em;
            color: var(--primary-color);
            border-top: 2px solid var(--primary-color);
            margin-top: 10px;
            padding-top: 15px;
        }
        
        .gosi-deduction {
            color: var(--accent-color);
        }

        .net-salary {
            color: var(--success-color);
        }

        .salary-actions {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        /* === END: CSS for new Salaries section === */

        @media (max-width: 768px) {
            .users-settings-table td:last-child,
            .activities-management table td:last-child {
                min-width: 100px !important;
            }
            
            .users-settings-table .btn-danger {
                padding: 6px 10px !important;
                font-size: 0.85em !important;
            }
        }
        #sales td.actions-cell {
            text-align: center !important;
            min-width: 240px !important;
        }

        #sales td.actions-cell .action-buttons {
            justify-content: center;
            flex-wrap: wrap;
        }

        #sales td.actions-cell .action-buttons button {
            flex: 1 1 110px;
            margin: 2px !important;
            padding: 8px 10px !important;
            font-size: 0.85em !important;
        }

/* === ØªÙ†Ø³ÙŠÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ === */
.action-buttons {
    display: flex; /* ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¯Ø§Ø®Ù„Ù‡ Ù…Ø±Ù†Ø© ÙˆÙ…ØªØ¬Ø§ÙˆØ±Ø© */
    gap: 10px;      /* ÙŠØ¶ÙŠÙ Ù…Ø³Ø§ÙØ© 5 Ø¨ÙƒØ³Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    min-width: 80px; /* ÙŠØ¶Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
}

.action-buttons button {
    flex: 1;       /* ÙŠØ¬Ø¹Ù„ ÙƒÙ„ Ø²Ø± ÙŠØ£Ø®Ø° Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ù… Ù„ÙŠÙ…Ù„Ø£ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© */
    padding: 6px 8px; /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„Ø²Ø± Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø­Ø¬Ù… */
    font-size: 0.9em; /* ØªØµØºÙŠØ± Ø·ÙÙŠÙ Ù„Ø­Ø¬Ù… Ø§Ù„Ø®Ø· */
}

/* Ø¥ØµÙ„Ø§Ø­ Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ´Ø§Ù…Ù„ Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width: 768px) {

    /* 1. Ø¥Ø¬Ø¨Ø§Ø± Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¸Ù‡ÙˆØ± */
    .sidebar-toggle {
        display: block !important;
    }

    /* 2. Ø¥ØµÙ„Ø§Ø­ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
    #items td .action-buttons,
    #customers td .action-buttons,
    #suppliers td .action-buttons,
    #purchases td .action-buttons,
    #sales td .action-buttons,
    #returns td .action-buttons,
    #expenses td .action-buttons,
    #revenues td .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    /* Ø£ÙƒÙˆØ§Ø¯ Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¬Ø§ÙˆØ¨ */
    body { flex-direction: column; }
    .sidebar { position: fixed; width: 100%; height: auto; box-shadow: none; transform: translateX(100%); transition: transform 0.3s ease; z-index: 2000; }
    .sidebar.open { transform: translateX(0); }
    .container { max-width: 100%; margin-right: 0; padding: 10px; }
    .form-grid, .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
    .search-container { flex-direction: column; }

    .form-grid button {
        font-size: 0.9em;
        padding: 10px;
    }
    
    .search-input {
        font-size: 0.9em;
        padding: 10px;
    }
    
    /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
    .charts-container {
        overflow-x: auto;
        padding-bottom: 10px;
    }
    
    .chart-card {
        min-width: 300px;
        flex-shrink: 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #items table {
        display: block;
        overflow-x: auto;
    }

    #items thead {
        display: none;
    }

    #items tbody {
        display: block;
    }

    #items tr {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-areas:
            "code name stock"
            "cost price price"
            "actions actions actions";
        row-gap: 8px;
        column-gap: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #items td {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 6px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
    }

    #items td::before {
        content: attr(data-label) " :";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
    }

    #items td[data-label="Ø§Ù„ÙƒÙˆØ¯"] { grid-area: code; }
    #items td[data-label="Ø§Ù„Ø§Ø³Ù…"] { grid-area: name; }
    #items td[data-label="Ø§Ù„Ø±ØµÙŠØ¯"] { grid-area: stock; }

    #items td[data-label="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡"] { grid-area: cost; }
    #items td[data-label="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹"] { grid-area: price; }

    #items td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        margin-top: 6px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #items td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #items td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        gap: 12px;
        width: 100%;
    }

    #items td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] button {
        flex: 1;
        font-size: 0.95em;
        padding: 11px 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #customers table {
        display: block;
        overflow-x: auto;
    }

    #customers thead {
        display: none;
    }

    #customers tbody {
        display: block;
    }

    #customers tr {
        display: grid;
        grid-template-columns: minmax(110px, auto) 1fr;
        grid-template-areas:
            "code name"
            "phone email"
            "address address"
            "actions actions";
        column-gap: 10px;
        row-gap: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #customers td {
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        gap: 6px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
    }

    #customers td::before {
        content: attr(data-label) " :";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
    }

    #customers td[data-label="Ø§Ù„ÙƒÙˆØ¯"] { grid-area: code; }
    #customers td[data-label="Ø§Ù„Ø§Ø³Ù…"] { grid-area: name; }
    #customers td[data-label="Ø§Ù„Ù‡Ø§ØªÙ"] { grid-area: phone; }
    #customers td[data-label="Ø§Ù„Ø¨Ø±ÙŠØ¯"] { grid-area: email; }
    #customers td[data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] {
        grid-area: address;
        word-break: break-word;
        margin-top: 6px;
    }

    #customers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        margin-top: 8px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #customers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #customers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    #customers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] button {
        width: 100%;
        font-size: 0.9em;
        padding: 9px 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #suppliers table {
        display: block;
        overflow-x: auto;
    }

    #suppliers thead {
        display: none;
    }

    #suppliers tbody {
        display: block;
    }

    #suppliers tr {
        display: grid;
        grid-template-columns: minmax(110px, auto) 1fr;
        grid-template-areas:
            "code name"
            "phone email"
            "address address"
            "actions actions";
        column-gap: 10px;
        row-gap: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #suppliers td {
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        gap: 6px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
    }

    #suppliers td::before {
        content: attr(data-label) " :";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
    }

    #suppliers td[data-label="Ø§Ù„ÙƒÙˆØ¯"] { grid-area: code; }
    #suppliers td[data-label="Ø§Ù„Ø§Ø³Ù…"] { grid-area: name; }
    #suppliers td[data-label="Ø§Ù„Ù‡Ø§ØªÙ"] { grid-area: phone; }
    #suppliers td[data-label="Ø§Ù„Ø¨Ø±ÙŠØ¯"] { grid-area: email; }
    #suppliers td[data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] {
        grid-area: address;
        word-break: break-word;
        margin-top: 6px;
    }

    #suppliers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        margin-top: 8px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #suppliers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #suppliers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    #suppliers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] button {
        width: 100%;
        font-size: 0.9em;
        padding: 9px 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #purchases table {
        display: block;
        overflow-x: auto;
    }

    #purchases thead {
        display: none;
    }

    #purchases tbody {
        display: block;
    }

    #purchases tr {
        display: grid;
        grid-template-columns: max-content max-content minmax(0, 1fr) minmax(0, 1fr);
        grid-template-areas:
            "number date supplier supplier"
            "quantity total paid paid"
            "remaining remaining remaining remaining"
            "actions actions actions actions";
        column-gap: 2px;
        row-gap: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #purchases td {
        display: flex;
        align-items: baseline;
        justify-content: flex-start;
        gap: 4px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
        min-width: 0;
        direction: rtl;
    }

    #purchases td::before {
        content: attr(data-label) ":";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
        background: transparent;
        flex-shrink: 0;
        display: inline-block;
    }
    #purchases td[data-label="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©"] {
        grid-area: number;
        white-space: nowrap;
    }
    #purchases td[data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®"] {
        grid-area: date;
        white-space: nowrap;
        margin-inline-start: 12px;
    }
    #purchases td[data-label="Ø§Ù„Ù…ÙˆØ±Ø¯"] {
        grid-area: supplier;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #purchases td[data-label="Ø§Ù„ÙƒÙ…ÙŠØ©"] {
        grid-area: quantity;
        white-space: nowrap;
    }
    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"] {
        grid-area: total;
        white-space: nowrap;
        margin-inline-end: 12px;
    }
    #purchases td[data-label="Ø§Ù„Ù…Ø¯ÙÙˆØ¹"] {
        grid-area: paid;
        white-space: nowrap;
        margin-inline-end: 12px;
    }
    #purchases td[data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ"] {
        grid-area: remaining;
        font-weight: 600;
        white-space: nowrap;
        justify-content: flex-start;
        padding-top: 6px;
        border-top: 1px solid #eee;
    }

    #purchases td[data-label="Ø§Ù„Ù…ÙˆØ±Ø¯"] {
        justify-content: flex-start;
        direction: rtl;
        text-align: right;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        margin-top: 6px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
    }

    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons button {
        width: 100%;
        font-size: 0.85em;
        padding: 8px 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #sales table {
        display: block;
        overflow-x: auto;
    }

    #sales thead {
        display: none;
    }

    #sales tbody {
        display: block;
    }

    #sales tr {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-areas:
            "number number date"
            "customer customer quantity"
            "total paid remaining"
            "actions actions actions";
        column-gap: 8px;
        row-gap: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #sales td {
        display: flex;
        align-items: baseline;
        justify-content: flex-start;
        gap: 4px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
        min-width: 0;
        direction: rtl;
    }

    #sales td::before {
        content: attr(data-label) ":";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
        background: transparent;
        flex-shrink: 0;
        display: inline-block;
    }

    #sales td[data-label="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©"] {
        grid-area: number;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®"] {
        grid-area: date;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„"] {
        grid-area: customer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #sales td[data-label="Ø§Ù„ÙƒÙ…ÙŠØ©"] {
        grid-area: quantity;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"] {
        grid-area: total;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„Ù…Ø¯ÙÙˆØ¹"] {
        grid-area: paid;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ"] {
        grid-area: remaining;
        font-weight: 600;
        white-space: nowrap;
        justify-content: flex-start;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons button {
        width: 100%;
        font-size: 0.85em;
        padding: 8px 0;
    }

}

@media (max-width: 480px) {
    /* Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ */
    * { font-size: 14px; }
    
    .analytics-card {
        min-width: 100%;
        margin: 0;
    }
    
    .chart-card {
        min-width: 100%;
        padding: 10px;
    }
    
    .container { padding: 5px 2px; }
    
    .section { padding: 10px 5px; }
    
    table { font-size: 10px; }
    
    th, td { padding: 4px 2px; font-size: 10px; }
    
    .form-grid input, .form-grid select, .form-grid textarea { 
        font-size: 14px;
        padding: 6px 8px;
    }
    
    .action-buttons button { 
        font-size: 11px;
        padding: 5px 8px;
        min-width: 60px;
    }
    
    .btn { 
        font-size: 12px;
        padding: 6px 10px;
    }
    
    h2 { font-size: 1.3em; }
    h3 { font-size: 1.1em; }
    
    .sidebar { font-size: 14px; }
    
    .nav button { font-size: 13px; padding: 8px; }
    
    .invoice-items table { min-width: 400px; }
    
    /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„ÙƒØ´ÙˆÙ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© */
    .account-statement-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        font-size: 14px;
        background: white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .account-statement-table th {
        background: linear-gradient(135deg, #4a90e2, #357abd);
        color: white;
        font-weight: 600;
        padding: 12px 10px;
        text-align: center;
        border-right: 1px solid rgba(255,255,255,0.2);
    }
    
    .account-statement-table td {
        padding: 10px;
        text-align: center;
        border-bottom: 1px solid #e5e5e5;
        border-right: 1px solid #e5e5e5;
    }
    
    .account-statement-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .account-statement-table tr:hover {
        background-color: #e7f3ff;
        transition: background-color 0.3s ease;
    }
    
    .remaining-unpaid {
        color: #dc3545;
        font-weight: 600;
    }
    
    .remaining-paid {
        color: #28a745;
        font-weight: 600;
    }
    
    .account-statement-summary {
        margin: 20px 0;
        background: transparent;
    }
    
    #statementSummary {
        background: transparent;
        border: none;
        border-radius: 0;
        padding: 0;
        margin: 20px 0;
        box-shadow: none;
    }
    
    #statementSummary h4 {
        color: #495057;
        margin-bottom: 10px;
        text-align: center;
        font-size: 16px;
    }
    
    #statementSummary p {
        margin: 5px 0;
        padding: 5px 10px;
        background: white;
        border-radius: 5px;
        border-left: 4px solid #4a90e2;
    }
    
    #statementResults {
        margin-top: 20px;
    }
    
    #statementResults h3 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 20px;
        font-size: 18px;
    }
    
    .statement-controls {
        display: flex !important;
        gap: 5px !important;
        margin-bottom: 20px !important;
        flex-wrap: nowrap !important;
        align-items: center !important;
        overflow-x: auto !important;
        white-space: nowrap !important;
        flex-direction: row !important;
    }
    
    .statement-controls select,
    .statement-controls input[type="date"] {
        width: auto !important;
        max-width: 120px !important;
        min-width: 80px !important;
        padding: 4px 6px !important;
        border: 1px solid #ddd !important;
        border-radius: 3px !important;
        font-size: 11px !important;
        flex-shrink: 0 !important;
        white-space: nowrap !important;
        display: inline-block !important;
    }
    
    .statement-controls button {
        min-width: 80px !important;
        padding: 4px 8px !important;
        font-size: 11px !important;
        flex-shrink: 0 !important;
        white-space: nowrap !important;
        display: inline-block !important;
    }
    
    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù„Ø®Øµ Ø§Ù„ÙƒØ´ÙˆÙ - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø«Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
    .statement-summary-cards {
        display: grid !important;
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 20px !important;
        margin: 20px 0 !important;
        width: 100% !important;
    }
    
    .summary-card {
        background: white !important;
        padding: 20px 15px !important;
        border-radius: 12px !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
        border-top: 5px solid #3498db !important;
        text-align: center !important;
        transition: all 0.3s ease !important;
        position: relative !important;
        overflow: hidden !important;
        min-height: 180px !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        align-items: center !important;
    }
    
    .summary-card:hover {
        transform: translateY(-5px) !important;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important;
    }
    
    .summary-card.sales {
        border-top-color: #667eea !important;
    }
    
    .summary-card.paid {
        border-top-color: #28a745 !important;
    }
    
    .summary-card.remaining {
        border-top-color: #17a2b8 !important;
    }
    
    .summary-card.profit {
        border-top-color: #ffc107 !important;
    }
    
    .summary-card.warning {
        border-top-color: #dc3545 !important;
    }
    
    .summary-card .card-value {
        font-size: 2.4em !important;
        font-weight: bold !important;
        color: #3498db !important;
        margin: 10px 0 !important;
    }
    
    .summary-card .card-title {
        font-size: 1.1em !important;
        margin-bottom: 8px !important;
        font-weight: 500 !important;
        color: #666 !important;
    }
    
    .summary-card .card-currency {
        font-size: 0.6em !important;
        color: #888 !important;
        font-weight: normal !important;
    }
    
    .summary-card .card-growth {
        position: absolute !important;
        bottom: 8px !important;
        right: 8px !important;
        font-size: 0.85em !important;
        display: flex !important;
        align-items: center !important;
        gap: 3px !important;
        color: #666 !important;
    }
    
    .summary-card .card-icon {
        position: absolute !important;
        bottom: 8px !important;
        left: 8px !important;
        font-size: 1.5em !important;
        opacity: 0.6 !important;
        color: #888 !important;
    }
    
    .summary-card .growth-icon {
        font-size: 1em !important;
    }
    
    @media (max-width: 768px) {
        .statement-summary-cards {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .summary-card {
            padding: 20px;
            min-height: 120px;
        }
        
        .summary-card .card-value {
            font-size: 2em;
        }
        
        .summary-card .card-icon {
            font-size: 2em;
            bottom: 10px;
            left: 10px;
        }
        
        .summary-card .card-title {
            font-size: 0.9em;
        }
        
        .summary-card .card-growth {
            bottom: 10px;
            right: 10px;
            font-size: 0.8em;
        }
    }
    
    @media (max-width: 480px) {
        .statement-summary-cards {
            grid-template-columns: 1fr;
        }
    }
    
    .statement-export-buttons {
        text-align: center;
        margin: 20px 0;
    }
    
    .statement-export-buttons button {
        margin: 0 10px;
        padding: 10px 20px;
        font-size: 14px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .statement-export-buttons .btn-excel {
        background: #28a745;
        color: white;
    }
    
    .statement-export-buttons .btn-excel:hover {
        background: #218838;
    }
    
    .statement-export-buttons .btn-print {
        background: #6c757d;
        color: white;
    }
    
    .statement-export-buttons .btn-print:hover {
        background: #5a6268;
    }
    
    /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© */
    @media (max-width: 400px) {
        .account-statement-table {
            font-size: 12px;
            overflow-x: auto;
            display: block;
            white-space: nowrap;
        }
        
        .account-statement-table th,
        .account-statement-table td {
            padding: 8px 6px;
            min-width: 80px;
        }
        
        #statementSummary {
            padding: 0;
            margin: 15px 0;
        }
        
        .account-statement-summary {
            margin: 15px 0;
        }
        
        .statement-controls {
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
        }
        
        .statement-controls select,
        .statement-controls input[type="date"],
        .statement-controls button {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            margin: 5px 0;
        }
        
        .statement-export-buttons button {
            display: block;
            width: 100%;
            margin: 5px 0;
        }
    }
    
    .user-section button {
        font-size: 0.95em;
        padding: 12px 15px;
        margin: 5px 0;
        min-height: 44px;
    }
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ===== */

/* Ø­Ù‚Ù„ Ø¨Ù‡ Ø®Ø·Ø£ */
input.input-error,
select.input-error,
textarea.input-error {
    border: 2px solid #e74c3c !important;
    background-color: #ffebee !important;
    animation: shake 0.5s ease;
}

/* Ø­Ù‚Ù„ ØµØ­ÙŠØ­ */
input.input-success,
select.input-success,
textarea.input-success {
    border: 2px solid #27ae60 !important;
    background-color: #f1f8f4 !important;
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ */
input.input-error::after,
input.input-success::after {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
}

input.input-error::after {
    content: 'âŒ';
}

input.input-success::after {
    content: 'âœ…';
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®Ø§Ø·Ø¦Ø© */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø£Ø³ÙÙ„ Ø§Ù„Ø­Ù‚Ù„ */
.field-error-message {
    color: #e74c3c;
    font-size: 0.85em;
    margin-top: 4px;
    display: block;
    animation: fadeIn 0.3s ease;
}

/* Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø£Ø³ÙÙ„ Ø§Ù„Ø­Ù‚Ù„ */
.field-success-message {
    color: #27ae60;
    font-size: 0.85em;
    margin-top: 4px;
    display: block;
    animation: fadeIn 0.3s ease;
}

/* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² */
input.input-error:focus,
select.input-error:focus,
textarea.input-error:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
}

input.input-success:focus,
select.input-success:focus,
textarea.input-success:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
}

/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ===== */

/* ===== Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ===== */
.dashboard-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.dashboard-card {
    background: #ffffff;
    color: #333;
    padding: 30px 25px;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    border-top: 4px solid transparent;
}

.dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.dashboard-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #1e3a8a 0%, #166534 100%);
}

.dashboard-card.customers {
    border-top-color: #1e3a8a;
}

.dashboard-card.customers::before {
    background: linear-gradient(135deg, #1e3a8a 0%, #166534 100%);
}

.dashboard-card.profit {
    border-top-color: #1e3a8a;
}

.dashboard-card.profit::before {
    background: linear-gradient(135deg, #1e3a8a 0%, #166534 100%);
}

.dashboard-card.revenue {
    border-top-color: #1e3a8a;
}

.dashboard-card.revenue::before {
    background: linear-gradient(135deg, #1e3a8a 0%, #166534 100%);
}

.dashboard-card.sales-today {
    border-top-color: #1e3a8a;
}

.dashboard-card.sales-today::before {
    background: linear-gradient(135deg, #1e3a8a 0%, #166534 100%);
}

.dashboard-card .card-value {
    font-size: 2.8rem;
    font-weight: 400;
    margin: 0 0 8px 0;
    line-height: 1;
    color: #1e40af;
}

.dashboard-card .card-title {
    font-size: 1rem;
    margin-bottom: 15px;
    opacity: 0.8;
    font-weight: 400;
    color: #1e40af;
}

.dashboard-card.revenue .card-value,
.dashboard-card.revenue .card-title {
    color: #dc2626;
}

.dashboard-card .card-growth {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
    font-weight: 400;
    color: #1e40af;
}

.dashboard-card .card-growth .growth-icon {
    margin-left: 8px;
    font-size: 1.2rem;
}

/* ===== Ù†Ù‡Ø§ÙŠØ© Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ===== */

/* ===== Ø£Ù†Ù…Ø§Ø· Ù‚Ø³Ù… Ø§Ù„Ø£ØµÙˆÙ„ ===== */
.asset-card {
    background: white;
    padding: 25px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-bottom: 20px;
    border-top: 4px solid var(--primary-color);
}

.asset-card h3 {
    color: var(--text-color);
    margin-bottom: 20px;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.asset-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.asset-actions button {
    flex: 1;
}

/* Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø± Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ - Ø¹Ø§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
input.editing-mode,
select.editing-mode,
textarea.editing-mode {
    border: 2px solid #28a745 !important;
    box-shadow: 0 0 8px rgba(40, 167, 69, 0.3) !important;
    animation: editPulse 1.5s ease-in-out infinite;
}

@keyframes editPulse {
    0%, 100% {
        box-shadow: 0 0 8px rgba(40, 167, 69, 0.3);
    }
    50% {
        box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
    }
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« */
.btn-primary.update-mode {
    background: linear-gradient(135deg, #28a745, #20c997) !important;
    animation: updateButton 2s ease-in-out infinite;
}

@keyframes updateButton {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.02);
    }
}

.assets-filters {
    display: flex;
    gap: 15px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.assets-filters select,
.assets-filters input {
    min-width: 200px;
    flex: 1;
}

.assets-summary {
    margin: 20px 0;
}

/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ù‚Ø³Ù… Ø§Ù„Ø£ØµÙˆÙ„ ===== */


 </style>


</head>
<body>
    <div id="login-overlay">
        <div id="login-box">
            <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ -->
            <img src="https://res.cloudinary.com/dgjcr2bgq/image/upload/v1762349658/logo_vlldbc.png" 
     alt="Ø´Ø¹Ø§Ø± Ù†Ø¸Ø§Ù… Ø¯ÙŠÙˆØ§Ù†ÙŠ" class="login-logo" id="loginLogo">
            
            <h2>Ø¯ÙŠÙˆØ§Ù†ÙŠ<br><span style="font-size: 0.8em; font-weight: normal; color: #1e3a5f;">Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù…ØªÙƒØ§Ù…Ù„</span></h2>
            <form id="loginForm" onsubmit="return false;" autocomplete="off">
           <input type="email" id="loginEmail" class="login-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" 
       onkeypress="if(event.key==='Enter')handleLogin()" autocomplete="new-email" name="email-new"> 

<input type="password" id="loginPassword" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" 
       onkeypress="if(event.key==='Enter')handleLogin()" autocomplete="new-password" name="password-new">
       
            <div style="display: flex; align-items: center; margin-top: 10px; gap: 8px;">
                <input type="checkbox" id="rememberMe" style="width: auto; cursor: pointer;">
                <label for="rememberMe" style="cursor: pointer; user-select: none;">ØªØ°ÙƒØ±Ù†ÙŠ</label>
            </div>
       
            <button class="btn-primary" onclick="handleLogin()" style="width: 100%; margin-top: 15px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </form>
            <a class="back-to-roles" onclick="openForgotPasswordModal()">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a>
            <p id="login-error">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„.</p>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„ -->
    <div id="first-setup-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); justify-content: center; align-items: center; z-index: 10001; backdrop-filter: blur(5px);">
        <div id="first-setup-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); width: 100%; max-width: 500px; text-align: center;">
            <div style="font-size: 4em; margin-bottom: 20px;">ğŸš€</div>
            <h2 style="color: white; margin-bottom: 10px; font-size: 2em;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¯ÙŠÙˆØ§Ù†ÙŠ!</h2>
            <p style="margin-bottom: 30px; opacity: 0.9; font-size: 1.1em;">Ù„Ø¨Ø¯Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„</p>
            
            <form id="firstSetupForm" onsubmit="return false;" autocomplete="off" style="text-align: right;">
                <input type="text" id="adminName" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„" 
                       style="background: rgba(255,255,255,0.9); border: none; margin-bottom: 15px;"
                       onkeypress="if(event.key==='Enter')createFirstAdmin()" autocomplete="off" required>
                
                <input type="email" id="adminEmail" class="login-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø¯ÙŠØ±" 
                       style="background: rgba(255,255,255,0.9); border: none; margin-bottom: 15px;"
                       onkeypress="if(event.key==='Enter')createFirstAdmin()" autocomplete="off" required>
                
                <input type="tel" id="adminPhone" class="login-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" 
                       style="background: rgba(255,255,255,0.9); border: none; margin-bottom: 15px;"
                       onkeypress="if(event.key==='Enter')createFirstAdmin()" autocomplete="off">
                
                <input type="password" id="adminPassword" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" 
                       style="background: rgba(255,255,255,0.9); border: none; margin-bottom: 15px;"
                       onkeypress="if(event.key==='Enter')createFirstAdmin()" autocomplete="off" required>
                
                <input type="password" id="adminPasswordConfirm" class="login-input" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" 
                       style="background: rgba(255,255,255,0.9); border: none; margin-bottom: 20px;"
                       onkeypress="if(event.key==='Enter')createFirstAdmin()" autocomplete="off" required>
                
                <button class="btn-success" onclick="createFirstAdmin()" style="width: 100%; padding: 15px; font-size: 1.1em; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); color: white; border-radius: 10px; transition: all 0.3s;">
                    ğŸ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
                </button>
            </form>
            
            <p id="setup-error" style="color: #ffcccb; margin-top: 15px; display: none; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;"></p>
        </div>
    </div>
    
    <div id="activity-overlay" style="display: none;">
        <div id="activity-box">
            <h2>Ø§Ø®ØªØ± Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ù†Ø´Ø§Ø·Ø§Ù‹ ØªØ¬Ø§Ø±ÙŠØ§Ù‹</h2>
            <div id="activity-list"></div>
            <hr style="margin: 20px 0;">
            <h3>Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ù†Ø´Ø§Ø·Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹</h3>
            <input type="text" id="newActivityName" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ø§Ù„: Ø¨ÙŠØ¹ Ù„Ø­Ø§ÙØ§Øª Ø§Ù„Ø£Ø·ÙØ§Ù„)">
            <button class="btn-success" onclick="addNewActivity()" style="width: 100%;">+ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù†Ø´Ø§Ø·</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div id="user-edit-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(5px);">
        <div id="user-edit-box" style="background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 480px; text-align: center;">
            <h2 style="color: var(--primary-color); margin-bottom: 20px;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
            <form id="editUserForm" onsubmit="return false;">
            <input type="text" id="editUserName" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="name">
            <input type="email" id="editUserEmail" class="login-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="email">
            <input type="tel" id="editUserPhone" class="login-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" autocomplete="tel">
            <input type="password" id="editUserPassword" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="new-password">
            <select id="editUserRole" class="login-input">
                <option value="admin">Ù…Ø¯ÙŠØ±</option>
                <option value="manager">Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·</option>
                <option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option>
            </select>
            <select id="editUserActivity" class="login-input" style="display: none;">
                <option value="">-- ØªØ¹ÙŠÙŠÙ† Ù„Ù†Ø´Ø§Ø· --</option>
            </select>
            </form>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn-success" onclick="saveEditedUser()" style="flex:1;">Ø­ÙØ¸</button>
                <button class="btn-secondary" onclick="closeEditUserModal()" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ -->
    <div id="email-settings-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 10002; backdrop-filter: blur(5px);" onclick="if(event.target === this) closeEmailSettingsModal();">
        <div style="background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation();">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="color: var(--primary-color); margin: 0;">ğŸ“§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h2>
                <button onclick="closeEmailSettingsModal()" style="background: #f0f0f0; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #666; font-size: 18px;" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
            </div>
            <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 0.95em;">
                Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¶Ø±ÙˆØ±ÙŠØ© Ù„ØªÙØ¹ÙŠÙ„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯. Ø§Ø­ØµÙ„ Ø¹Ù„ÙŠÙ‡Ø§ Ù…Ù† <a href="https://www.emailjs.com/" target="_blank" style="color: var(--primary-color);">EmailJS</a>
            </p>
            
            <form id="emailSettingsForm" onsubmit="return false;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <!-- Service ID -->
                    <div>
                        <label for="emailJsServiceId" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Service ID</label>
                        <code style="display: block; background-color: #f0f0f0; padding: 8px; border-radius: 4px; margin-bottom: 8px; cursor: pointer; user-select: all; font-size: 0.85em;" onclick="navigator.clipboard.writeText(this.innerText); showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Service ID', 'success', 2000);">service_hu6ucxi</code>
                        <input type="text" id="emailJsServiceId" class="login-input" placeholder="Ø£Ø¯Ø®Ù„ Service ID">
                    </div>
                    
                    <!-- Public Key -->
                    <div>
                        <label for="emailJsPublicKey" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Public Key</label>
                        <code style="display: block; background-color: #f0f0f0; padding: 8px; border-radius: 4px; margin-bottom: 8px; cursor: pointer; user-select: all; font-size: 0.85em;" onclick="navigator.clipboard.writeText(this.innerText); showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Public Key', 'success', 2000);">-FKicwCTdzG90IoY6</code>
                        <input type="text" id="emailJsPublicKey" class="login-input" placeholder="Ø£Ø¯Ø®Ù„ Public Key">
                    </div>
                    
                    <!-- Template ID -->
                    <div>
                        <label for="emailJsTemplateId" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Template ID (Ø§Ù„ÙÙˆØ§ØªÙŠØ±)</label>
                        <code style="display: block; background-color: #f0f0f0; padding: 8px; border-radius: 4px; margin-bottom: 8px; cursor: pointer; user-select: all; font-size: 0.85em;" onclick="navigator.clipboard.writeText(this.innerText); showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Template ID', 'success', 2000);">template_cwep9ok</code>
                        <input type="text" id="emailJsTemplateId" class="login-input" placeholder="Ø£Ø¯Ø®Ù„ Template ID Ù„Ù„ÙÙˆØ§ØªÙŠØ±">
                    </div>
                    
                    <!-- Reset Template ID -->
                    <div>
                        <label for="emailJsResetTemplateId" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Reset Template ID</label>
                        <code style="display: block; background-color: #f0f0f0; padding: 8px; border-radius: 4px; margin-bottom: 8px; cursor: pointer; user-select: all; font-size: 0.85em;" onclick="navigator.clipboard.writeText(this.innerText); showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Reset Template ID', 'success', 2000);">template_password_reset</code>
                        <input type="text" id="emailJsResetTemplateId" class="login-input" placeholder="Ø£Ø¯Ø®Ù„ Template ID Ù„Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9em; color: #555;">
                    <strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong>
                    <ul style="margin: 10px 0 0 20px; padding: 0;">
                        <li>Ù‚Ø§Ù„Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: <code style="background: #e9ecef; padding: 2px 5px; border-radius: 3px;">{{to_name}}, {{to_email}}, {{invoice_number}}, {{invoice_details}}</code></li>
                        <li>Ù‚Ø§Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: <code style="background: #e9ecef; padding: 2px 5px; border-radius: 3px;">{{to_email}}, {{reset_link}}, {{app_name}}</code></li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn-success" onclick="saveEmailJsSettings()" style="flex: 1;">ğŸ’¾ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
                    <button class="btn-secondary" onclick="closeEmailSettingsModal()" style="flex: 1;">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„) -->
    <div id="change-password-overlay" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10002; backdrop-filter: blur(5px);">
        <div style="background:white; padding: 24px; border-radius: var(--border-radius); width: 100%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <h2 style="margin-top:0; color: var(--primary-color);">ğŸ”’ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
            <form id="changePasswordForm" onsubmit="return false;">
            <input type="password" id="cp-old" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" autocomplete="current-password">
            <input type="password" id="cp-new" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" autocomplete="new-password">
            <input type="password" id="cp-confirm" class="login-input" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" autocomplete="new-password">
            </form>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-success" onclick="submitPasswordChange()" style="flex:1;">Ø­ÙØ¸</button>
                <button class="btn-secondary" onclick="closeChangePasswordModal()" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø·) -->
    <div id="forgot-password-overlay" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10002; backdrop-filter: blur(5px);">
        <div style="background:white; padding: 24px; border-radius: var(--border-radius); width: 100%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align:center;">
            <h2 style="margin-top:0; color: var(--primary-color);">ğŸ“§ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
            <p style="margin: 0 0 10px;">Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ³Ù†Ø±Ø³Ù„ Ù„Ùƒ Ø±Ø§Ø¨Ø·Ø§Ù‹ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</p>
            <form id="forgotPasswordForm" onsubmit="return false;">
            <input type="email" id="fp-email" class="login-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="email">
            </form>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-success" onclick="requestPasswordReset()" style="flex:1;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                <button class="btn-secondary" onclick="closeForgotPasswordModal()" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· -->
    <div id="reset-password-overlay" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10003; backdrop-filter: blur(5px);">
        <div style="background:white; padding: 24px; border-radius: var(--border-radius); width: 100%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align:center;">
            <h2 style="margin-top:0; color: var(--primary-color);">ğŸ” ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <form id="resetPasswordForm" onsubmit="return false;">
            <input type="password" id="rp-new" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" autocomplete="new-password">
            <input type="password" id="rp-confirm" class="login-input" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" autocomplete="new-password">
            </form>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-success" onclick="submitTokenPasswordReset()" style="flex:1;">Ø­ÙØ¸</button>
                <button class="btn-secondary" onclick="closeResetPasswordModal()" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© -->
    <div id="edit-activity-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 10005; backdrop-filter: blur(5px);">
        <div class="edit-activity-modal" style="background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 520px; overflow: hidden; animation: scaleIn 0.3s ease;">
            <!-- Ø±Ø£Ø³ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
            <div class="edit-activity-header" style="background: linear-gradient(135deg, var(--primary-color) 0%, #2980b9 100%); padding: 25px 30px; text-align: center; color: white; position: relative;">
                <div style="font-size: 48px; margin-bottom: 10px;">âœï¸</div>
                <h2 style="margin: 0; font-size: 1.6em; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·</h2>
                <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 0.95em;">ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</p>
            </div>
            
            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
            <div class="edit-activity-body" style="padding: 30px;">
                <form id="editActivityForm" onsubmit="return false;">
                    <!-- Ø­Ù‚Ù„ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· -->
                    <div style="margin-bottom: 25px;">
                        <label for="editActivityName" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color); font-size: 1.1em;">
                            ğŸ“ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·
                        </label>
                        <input type="text" id="editActivityName" class="login-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯" 
                               style="width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1.1em; transition: all 0.3s ease; background: #f8f9fa;"
                               autocomplete="off" required>
                    </div>
                    
                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
                    <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <h3 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                            ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.95em;">
                            <div>
                                <span style="color: #666; font-weight: 600;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</span>
                                <div id="activityCreatedAt" style="color: var(--text-color); margin-top: 4px;"></div>
                            </div>
                            <div>
                                <span style="color: #666; font-weight: 600;">Ø§Ù„Ù…Ù†Ø´Ø¦:</span>
                                <div id="activityCreatedBy" style="color: var(--text-color); margin-top: 4px;"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© -->
            <div class="edit-activity-footer" style="padding: 20px 30px; background: #f8f9fa; border-top: 1px solid #e1e5e9; display: flex; gap: 15px;">
                <button class="btn-success" onclick="saveEditedActivity()" 
                        style="flex: 1; padding: 15px; font-size: 1.1em; font-weight: 600; border-radius: 12px; transition: all 0.3s ease; background: linear-gradient(135deg, var(--success-color) 0%, #229954 100%); box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);">
                    ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                </button>
                <button class="btn-secondary" onclick="closeEditActivityModal()" 
                        style="flex: 1; padding: 15px; font-size: 1.1em; font-weight: 600; border-radius: 12px; transition: all 0.3s ease; background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); color: white; box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);">
                    âŒ Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ -->
    <div id="confirm-overlay" class="confirm-overlay" role="dialog" aria-modal="true" aria-labelledby="confirm-title" aria-describedby="confirm-body">
        <div class="confirm-dialog">
            <div id="confirm-header" class="confirm-header">
                <span id="confirm-icon" class="confirm-icon" aria-hidden="true">âš ï¸</span>
                <h3 id="confirm-title" class="confirm-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
            </div>
            <div id="confirm-body" class="confirm-body">
                Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ
            </div>
            <div class="confirm-footer">
                <button id="confirm-btn-cancel" class="confirm-btn-cancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="confirm-btn-confirm" class="confirm-btn-confirm" type="button">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>

    <div class="app-container" style="display: none;">
        <button class="sidebar-toggle" onclick="toggleSidebar()">â˜° Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
                <img src="https://res.cloudinary.com/dgjcr2bgq/image/upload/v1762349658/logo_vlldbc.png" 
     alt="Ø´Ø¹Ø§Ø± Ø¯ÙŠÙˆØ§Ù†ÙŠ" class="header-logo" id="sidebarLogo" 
     style="width: 100px; height: 100px; margin: 0 auto 15px; position: static; transform: none; border-radius: 8px; background: white; padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
            </div>
            
            <div class="sidebar-nav" id="sidebarNav">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>

            <div class="user-section">
                <div class="current-user" id="currentUserDisplay"></div>
                <button class="btn-danger" onclick="logout()" style="width: 100%; margin-top: 10px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <button class="design-toggle" onclick="toggleControlPanel()">ğŸ¨</button>

        <div class="control-panel" id="controlPanel">
            <h3>ğŸ¨ ØªØ®ØµÙŠØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</h3>
            
            <div class="control-group">
                <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø·:</label>
                <select id="fontFamilySelect" onchange="updateFontFamily(this.value)">
                    <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                    <option value="'Tajawal', sans-serif">Tajawal</option>
                    <option value="'Amiri', serif">Amiri</option>
                    <option value="'El Messiri', sans-serif">El Messiri</option>
                    <option value="'Reem Kufi', sans-serif">Reem Kufi</option>
                    <option value="'Arial', sans-serif">Arial</option>
                    <option value="'Helvetica', sans-serif">Helvetica</option>
                </select>
            </div>

            <div class="control-group">
                <label>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·:</label>
                <input type="range" class="font-size-control" min="12" max="20" value="16" onchange="updateFontSize(this.value)">
                <span id="font-size-value">16px</span>
            </div>

            <div class="control-group">
                <label>ğŸ¨ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:</label>
                <input type="color" class="color-picker" value="#2c5aa0" onchange="updateColor('--primary-color', this.value)">
            </div>

            <div class="control-group">
                <label>ğŸ–¼ï¸ Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©:</label>
                <input type="color" class="color-picker" value="#ecf0f1" onchange="updateColor('--bg-color', this.value)">
            </div>

            <div class="control-group">
                <label>ğŸ“ Ù„ÙˆÙ† Ø§Ù„Ù†Øµ:</label>
                <input type="color" class="color-picker" value="#2c3e50" onchange="updateColor('--text-color', this.value)">
            </div>

            <div class="control-group">
                <label>ğŸ›ï¸ Ù„ÙˆÙ† Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©:</label>
                <input type="color" class="color-picker" value="#2c5aa0" onchange="updateHeaderColor(this.value)" id="headerColorPicker">
            </div>

            <div class="control-group">
                <label>ğŸ“‹ Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©:</label>
                <input type="color" class="color-picker" value="#2c3e50" onchange="updateColor('--sidebar-bg', this.value)" id="sidebarColorPicker">
            </div>

            <hr style="margin: 15px 0; border: none; border-top: 1px solid #e0e0e0;">
            
            <h4 style="margin: 10px 0; font-size: 0.95em; color: #1a3a5c;">ğŸ“„ ØªØ®ØµÙŠØµ Ø§Ù„ØªØ°ÙŠÙŠÙ„</h4>
            
            <div class="control-group">
                <label>ğŸ¨ Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØ°ÙŠÙŠÙ„ (Ø£ÙˆÙ„):</label>
                <input type="color" class="color-picker" value="#1e3a5f" onchange="updateFooterGradient(this.value, 'start')" id="footerColor1Picker">
            </div>

            <div class="control-group">
                <label>ğŸ¨ Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØ°ÙŠÙŠÙ„ (Ø«Ø§Ù†ÙŠ):</label>
                <input type="color" class="color-picker" value="#2c4a6f" onchange="updateFooterGradient(this.value, 'end')" id="footerColor2Picker">
            </div>

            <div class="control-group">
                <label>âœï¸ Ø®Ø· Ø§Ù„ØªØ°ÙŠÙŠÙ„:</label>
                <select id="footerFontSelect" onchange="updateFooterFont(this.value)">
                    <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                    <option value="'Tajawal', sans-serif">Tajawal</option>
                    <option value="'Amiri', serif">Amiri</option>
                    <option value="'El Messiri', sans-serif">El Messiri</option>
                    <option value="'Reem Kufi', sans-serif">Reem Kufi</option>
                    <option value="'Arial', sans-serif">Arial</option>
                </select>
            </div>

            <button onclick="resetDesign()" class="btn-primary" style="width: 100%; margin-top: 8px; padding: 8px 12px; font-size: 0.9em;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button onclick="toggleControlPanel()" class="btn-danger" style="width: 100%; margin-top: 8px; padding: 8px 12px; font-size: 0.9em;">âŒ Ø¥ØºÙ„Ø§Ù‚</button>
        </div>

<div class="container">
    <div class="header">
        <div class="header-content">
            <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· ÙÙŠ Ø§Ù„ÙˆØ³Ø· -->
            <img src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·" class="activity-header-logo" id="activityHeaderLogo" style="display: none; width: 80px; height: 80px; margin: 0 auto 10px; object-fit: contain; border-radius: 8px;">
            
            <h1 id="activityHeaderTitle">Ø¯ÙŠÙˆØ§Ù†ÙŠ</h1>
            <div class="subtitle" id="activityHeaderSubtitle">Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù…ØªÙƒØ§Ù…Ù„</div>
        </div>
        
        <div class="developer-credit">Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ±: ØµØ§Ù„Ø­ Ø§Ù„ØµÙ…Ù„Ø©</div>
    </div>

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
    <div id="notifications-container"></div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª -->
    <div id="trash-modal">
        <div class="trash-content">
            <div class="trash-header">
                <h2>ğŸ—‘ï¸ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</h2>
                <button class="btn-secondary" onclick="closeTrashModal()">âœ– Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            
            <p style="text-align: center; color: #666; font-size: 0.95em; margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 8px;">
                ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ù„Ù…Ø¯Ø© 30 ÙŠÙˆÙ…Ø§Ù‹
            </p>
            
            <div class="trash-stats">
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-items">0</div>
                    <div class="trash-stat-label">Ø£ØµÙ†Ø§Ù</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-customers">0</div>
                    <div class="trash-stat-label">Ø¹Ù…Ù„Ø§Ø¡</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-suppliers">0</div>
                    <div class="trash-stat-label">Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-purchases">0</div>
                    <div class="trash-stat-label">Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-sales">0</div>
                    <div class="trash-stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-expenses">0</div>
                    <div class="trash-stat-label">Ù…ØµØ±ÙˆÙØ§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-revenues">0</div>
                    <div class="trash-stat-label">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-salesReturns">0</div>
                    <div class="trash-stat-label">Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-purchaseReturns">0</div>
                    <div class="trash-stat-label">Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-total">0</div>
                    <div class="trash-stat-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                </div>
            </div>

            <div class="trash-tabs">
                <button class="trash-tab active" onclick="renderTrashItems('items')">ğŸ“¦ Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
                <button class="trash-tab" onclick="renderTrashItems('customers')">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
                <button class="trash-tab" onclick="renderTrashItems('suppliers')">ğŸ­ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</button>
                <button class="trash-tab" onclick="renderTrashItems('purchases')">ğŸ“¥ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('sales')">ğŸ“¤ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('expenses')">ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('revenues')">ğŸ’° Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('salesReturns')">â†©ï¸ Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('purchaseReturns')">â†ªï¸ Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª</button>
            </div>

            <div id="trash-items-container" class="trash-items"></div>
        </div>
    </div>

    <div id="home" class="section active">
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</h2>
        <p>Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù…Ù„ÙŠØ§ØªÙƒ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©</p>
       <div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
        <div class="stat-number" id="totalStockQuantity">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
        <div class="stat-number" id="stockValue">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
        <div class="stat-number" id="totalItems">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="stat-number" id="totalCustomers">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
        <div class="stat-number" id="totalSuppliers">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
        <div class="stat-number" id="totalSales">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
        <div class="stat-number" id="totalPurchases">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
        <div class="stat-number" id="totalExpensesHome">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
        <div class="stat-number" id="totalRevenuesHome">0</div>
    </div>
    <div class="stat-card">
    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù</div>
    <div class="stat-number" id="totalAdvancesHome">0</div>
</div>
<div class="stat-card">
    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„</div>
    <div class="stat-number" id="totalAssetsHome">0.00</div>
</div>
<div class="stat-card">
    <div class="stat-label">ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ù…ØªØ§Ø­</div>
    <div class="stat-number" id="availableCash">0.00</div>
</div>
</div>
</div> 
<div id="advanced-dashboard" class="section">
    <h2>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
    
    <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© -->
    <div class="stats-grid advanced-stats">
        <div class="stat-card">
            <div class="stat-number" id="todaySales">0</div>
            <div class="stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="stat-trend" id="salesTrend">â†—ï¸ +12%</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayPurchases">0</div>
            <div class="stat-label">Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="stat-trend" id="purchasesTrend">â†—ï¸ +8%</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayExpenses">0</div>
            <div class="stat-label">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="stat-trend" id="expensesTrend">â†—ï¸ +15%</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayRevenues">0</div>
            <div class="stat-label">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="stat-trend" id="revenuesTrend">â†—ï¸ +5%</div>
        </div>
    </div>

    <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© -->
    <div class="stats-grid advanced-stats" style="margin-top: 30px;">
        <div class="stat-card">
            <div class="stat-number" id="monthlySales">0</div>
            <div class="stat-label">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
            <div class="stat-trend" id="monthlySalesTrend">ğŸ“Š</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="monthlyPurchases">0</div>
            <div class="stat-label">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
            <div class="stat-trend" id="monthlyPurchasesTrend">ğŸ“Š</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="monthlyExpensesCard">0</div>
            <div class="stat-label">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
            <div class="stat-trend" id="monthlyExpensesTrend">ğŸ“Š</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="monthlyRevenues">0</div>
            <div class="stat-label">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
            <div class="stat-trend" id="monthlyRevenuesTrend">ğŸ“Š</div>
        </div>
    </div>

    <!-- ğŸ†• Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (KPIs) -->
    <div class="kpi-section" style="margin-top: 40px;">
        <h3 style="margin-bottom: 20px; color: var(--primary-color); font-size: 20px;">ğŸ’ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
        <div class="stats-grid advanced-stats">
            <div class="stat-card kpi-card" style="background: white; border: 3px solid #667eea; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);">
                <div class="stat-number" id="kpiNetProfit" style="color: #667eea;">0</div>
                <div class="stat-label" style="color: #555;">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø§Ù„Ø´Ù‡Ø±)</div>
                <div class="stat-trend" id="kpiNetProfitTrend" style="color: #667eea;">ğŸ“ˆ +0%</div>
            </div>
            <div class="stat-card kpi-card" style="background: white; border: 3px solid #f5576c; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.2);">
                <div class="stat-number" id="kpiCustomersDebt" style="color: #f5576c;">0</div>
                <div class="stat-label" style="color: #555;">Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                <div class="stat-trend" id="kpiCustomersCount" style="color: #f5576c;">ğŸ‘¥ 0 Ø¹Ù…ÙŠÙ„</div>
            </div>
            <div class="stat-card kpi-card" style="background: white; border: 3px solid #4facfe; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.2);">
                <div class="stat-number" id="kpiSuppliersDebt" style="color: #4facfe;">0</div>
                <div class="stat-label" style="color: #555;">Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
                <div class="stat-trend" id="kpiSuppliersCount" style="color: #4facfe;">ğŸ¢ 0 Ù…ÙˆØ±Ø¯</div>
            </div>
            <div class="stat-card kpi-card" style="background: white; border: 3px solid #43e97b; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.2);">
                <div class="stat-number" id="kpiCashFlow" style="color: #43e97b;">0</div>
                <div class="stat-label" style="color: #555;">Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ù…ØªØ§Ø­</div>
                <div class="stat-trend" id="kpiCashFlowTrend" style="color: #43e97b;">ğŸ’° Ø§Ù„ÙŠÙˆÙ…</div>
            </div>
        </div>
    </div>

    <!-- ğŸ†• Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="charts-section" style="margin-top: 40px;">
        <h3 style="margin-bottom: 20px; color: var(--primary-color); font-size: 20px;">ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</h3>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
            <!-- Ø±Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª vs Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
            <div class="chart-card">
                <h3>ğŸ“ˆ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª vs Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±)</h3>
                <canvas id="salesVsPurchasesChart"></canvas>
            </div>
            
            <!-- Ø±Ø³Ù… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª -->
            <div class="chart-card">
                <h3>ğŸ¯ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h3>
                <canvas id="expensesDistributionChart"></canvas>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <!-- Ø±Ø³Ù… Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ø¨ÙŠØ¹Ø§Ù‹ -->
            <div class="chart-card">
                <h3>ğŸ† Ø£Ø¹Ù„Ù‰ 5 Ø£ØµÙ†Ø§Ù Ù…Ø¨ÙŠØ¹Ø§Ù‹</h3>
                <canvas id="topItemsChart"></canvas>
            </div>
            
            <!-- Ø±Ø³Ù… Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ -->
            <div class="chart-card">
                <h3>ğŸ’° Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h3>
                <canvas id="cashFlowChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="items" class="section">
    <h2>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatItems" class="stat-mini-number">0</span></span></h2>
    
    <div class="form-grid grid-3">
        <input type="text" id="itemCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù">
        <input type="text" id="itemName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù *" required>
        <input type="number" id="itemCost" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
    </div>
    
    <div class="form-grid grid-2">
        <input type="number" id="itemPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
        <input type="number" id="itemStock" placeholder="Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ">
    </div>
    
    <div class="form-grid grid-1">
        <button class="btn-primary btn-add" onclick="addItem()">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchItems" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('itemsFilters')">
            <span> </span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="itemsFilters" class="filters-container">
        <div class="filters-grid">
            <div class="filter-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ù…Ù†)</label>
                <input type="number" id="itemCostFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="itemCostTo" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ù…Ù†)</label>
                <input type="number" id="itemPriceFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="itemPriceTo" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ø±ØµÙŠØ¯ (Ù…Ù†)</label>
                <input type="number" id="itemStockFrom" class="filter-input" placeholder="0">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ø±ØµÙŠØ¯ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="itemStockTo" class="filter-input" placeholder="0">
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetItemsFilters()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button class="btn-primary" onclick="applyItemsFilters()">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        </div>
    </div>

    <table id="itemsTable">
   <thead>
    <tr>
        <th class="sortable" data-column="code">Ø§Ù„ÙƒÙˆØ¯</th>
        <th class="sortable" data-column="name">Ø§Ù„Ø§Ø³Ù…</th>
        <th class="sortable" data-column="cost">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
        <th class="sortable" data-column="price">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
        <th class="sortable" data-column="stock">Ø§Ù„Ø±ØµÙŠØ¯</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    </tr>
</thead>
        <tbody id="itemsList"></tbody>
    </table>
</div>

<div id="customers" class="section">
    <h2>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatCustomers" class="stat-mini-number">0</span></span></h2>
    
    <div class="form-grid grid-3">
        <input type="text" id="customerCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„">
        <input type="text" id="customerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *" required>
        <input type="text" id="customerPhone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
        <input type="email" id="customerEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="text" id="customerAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
    <button class="btn-primary btn-add" onclick="addCustomer()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchCustomers" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('customersFilters')">
            <span> </span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="customersFilters" class="filters-container">
        <p style="color: #666; margin-bottom: 10px;">ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø£Ø¹Ù„Ø§Ù‡ Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø§Ù„ÙƒÙˆØ¯ØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)</p>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetCustomersFilters()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ø­Ø«</button>
        </div>
    </div>

    <table id="customersTable">
        <thead>
    <tr>
        <th class="sortable" data-column="code">Ø§Ù„ÙƒÙˆØ¯</th>
        <th class="sortable" data-column="name">Ø§Ù„Ø§Ø³Ù…</th>
        <th class="sortable" data-column="phone">Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th class="sortable" data-column="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
        <th class="sortable" data-column="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    </tr>
</thead>
        <tbody id="customersList"></tbody>
    </table>
</div>

<div id="suppliers" class="section">
    <h2>ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatSuppliers" class="stat-mini-number">0</span></span></h2>
    
    <div class="form-grid grid-3">
        <input type="text" id="supplierCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯">
        <input type="text" id="supplierName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ *" required>
        <input type="text" id="supplierPhone" placeholder=" Ø§Ù„Ù‡Ø§ØªÙ">
        <input type="email" id="supplierEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="text" id="supplierAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
    <button class="btn-primary btn-add" onclick="addSupplier()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchSuppliers" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('suppliersFilters')">
            <span> </span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="suppliersFilters" class="filters-container">
        <p style="color: #666; margin-bottom: 10px;">ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø£Ø¹Ù„Ø§Ù‡ Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø§Ù„ÙƒÙˆØ¯ØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)</p>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetSuppliersFilters()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ø­Ø«</button>
        </div>
    </div>

    <table id="suppliersTable">
        <thead>
            <tr>
                <th class="sortable" data-column="code">Ø§Ù„ÙƒÙˆØ¯</th>
                <th class="sortable" data-column="name">Ø§Ù„Ø§Ø³Ù…</th>
                <th class="sortable" data-column="phone">Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th class="sortable" data-column="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                <th class="sortable" data-column="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="suppliersList"></tbody>
    </table>
</div>

<div id="purchases" class="section">
    <h2>ğŸ›’ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatPurchases" class="stat-mini-number">0</span></span></h2>
    <p>ğŸ“ Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</p>
    
    <div class="form-grid grid-4">
        <input type="text" id="purchaseCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©" readonly>
        <input type="date" id="purchaseDate">
        <select id="purchaseSupplier" onchange="updateSupplierFields()">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯</option>
        </select>
        <select id="purchaseBranch">
            <option value="general_admin">ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>
            <option value="">ğŸª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
        </select>
    </div>
    
    <div class="form-grid grid-4">
        <input type="text" id="purchaseSupplierName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯" readonly>
        <input type="text" id="purchaseSupplierCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯" readonly>
        <input type="text" id="purchaseSupplierPhone" placeholder="Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ±Ø¯" readonly>
        <input type="text" id="purchaseSupplierAddress" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ±Ø¯">
    </div>
    
    <div class="form-grid grid-4">
        <input type="text" id="purchaseNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
    </div>
    
    <div class="form-grid grid-4">
        <select id="purchaseItem">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>
        </select>
        <input type="number" id="purchaseQuantity" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" min="1" value="1">
        <select id="purchaseUnit">
            <option value="Ù‚Ø·Ø¹Ø©">Ù‚Ø·Ø¹Ø©</option>
            <option value="Ø¯Ø±Ø²Ù†">Ø¯Ø±Ø²Ù†</option>
        </select>
        <input type="number" id="purchasePrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
    <button class="btn-primary btn-add" onclick="addPurchaseItem()">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    </div>
    
    <div class="invoice-items">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="purchaseItemsList"></tbody>
        </table>
    </div>
    
    <div class="invoice-totals">
        <div>
            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
            <span id="purchaseSubtotal">0.00</span>
        </div>
        <div>
            <span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
            <span id="purchaseTax">0.00</span>
        </div>
         <div>
            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
            <input type="number" id="purchasePaidAmount" placeholder="0.00" oninput="updatePurchaseTotals()">
        </div>
        <div>
            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
            <span id="purchaseRemainingAmount" class="remaining-unpaid">0.00</span>
        </div>
        <div class="total">
            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
            <span id="purchaseTotal">0.00</span>
        </div>
    </div>
    
   <div style="display: flex; gap: 10px; margin-top: 20px; align-items: center; flex-wrap: wrap;">
    <button class="btn-primary" id="savePurchaseBtn" onclick="savePurchase()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
    <button class="btn-secondary" onclick="newPurchase()">ğŸ†• ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>

    <input type="file" id="purchaseAttachment" accept="image/*,application/pdf" style="flex: 1; min-width: 250px; padding: 10px; border: 2px dashed var(--primary-color); background: #f8f9fa;">
</div>
    
    <h3 style="margin-top: 30px;">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
    
    <div class="search-container">
        <input type="text" id="searchPurchases" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('purchasesFilters')">
            <span> </span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="purchasesFilters" class="filters-container">
        <div class="filters-grid">
            <div class="filter-group">
                <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="purchasesDateFrom" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="purchasesDateTo" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ù…Ù†)</label>
                <input type="number" id="purchasesAmountFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="purchasesAmountTo" class="filter-input" placeholder="0.00">
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetPurchasesFilters()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button class="btn-primary" onclick="applyPurchasesFilters()">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        </div>
    </div>
    
  <table id="purchasesTable">
        <thead>
            <tr>
                <th class="sortable" data-column="code">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th class="sortable" data-column="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th class="sortable" data-column="supplierId">Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                <th class="sortable" data-column="itemsCount">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th class="sortable" data-column="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th class="sortable" data-column="paidAmount">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                <th class="sortable" data-column="remainingAmount">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                <th>Ø§Ù„Ù…Ø±ÙÙ‚</th> <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="purchasesList"></tbody>
    </table>
</div>

<div id="sales" class="section">
    <h2>ğŸ’° ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatSales" class="stat-mini-number">0</span></span></h2>
    <p>ğŸ“ˆ Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
    
    <div class="form-grid grid-4">
        <input type="text" id="saleCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©" readonly>
        <input type="date" id="saleDate">
        <select id="saleCustomer" onchange="updateCustomerFields()">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
        </select>
        <select id="saleBranch">
            <option value="">ğŸª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
        </select>
    </div>
    
    <div class="form-grid grid-4">
        <input type="text" id="saleCustomerCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„" readonly>
        <input type="text" id="saleCustomerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" readonly>
        <input type="text" id="saleCustomerPhone" placeholder="Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„" readonly>
        <input type="text" id="saleCustomerAddress" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„">
    </div>
    
    <div class="form-grid grid-4">
        <input type="text" id="saleNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
    </div>
    
    <div class="form-grid grid-4">
        <select id="saleItem">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>
        </select>
        <input type="number" id="saleQuantity" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" min="1" value="1">
        <select id="saleUnit">
            <option value="Ù‚Ø·Ø¹Ø©">Ù‚Ø·Ø¹Ø©</option>
            <option value="Ø¯Ø±Ø²Ù†">Ø¯Ø±Ø²Ù†</option>
        </select>
        <input type="number" id="salePrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
    <button class="btn-primary btn-add" onclick="addSaleItem()">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    </div>
    
    <div class="invoice-items">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="saleItemsList"></tbody>
        </table>
    </div>
    
    <div class="invoice-totals">
        <div>
            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
            <span id="saleSubtotal">0.00</span>
        </div>
        <div>
            <span>Ø§Ù„Ø®ØµÙ…:</span>
            <input type="number" id="saleDiscount" placeholder="0.00" oninput="updateSaleTotals()" min="0" step="0.01">
        </div>
        <div>
            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…:</span>
            <span id="saleAfterDiscount">0.00</span>
        </div>
       <div>
            <span>
                <input type="checkbox" id="applySaleTax" onchange="updateSaleTotals()" checked style="margin-right: 5px; vertical-align: middle;">
                <label for="applySaleTax" style="cursor: pointer;">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%)</label>
            </span>
            <span id="saleTax">0.00</span>
        </div>
         <div>
            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
            <input type="number" id="salePaidAmount" placeholder="0.00" oninput="updateSaleTotals()">
        </div>
        <div>
            <span>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</span>
            <select id="salePaymentMethod">
                <option value="cash">ğŸ’° ÙƒØ§Ø´</option>
                <option value="bank">ğŸ¦ Ø¨Ù†Ùƒ</option>
                <option value="mixed">ğŸ”„ Ù…Ø®ØªÙ„Ø·</option>
            </select>
        </div>
        <div>
            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
            <span id="saleRemainingAmount" class="remaining-unpaid">0.00</span>
        </div>
        <div class="total">
            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
            <span id="saleTotal">0.00</span>
        </div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn-primary" id="saveSaleBtn" onclick="saveSale()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
        <button class="btn-secondary" onclick="newSale()">ğŸ†• ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
    
    <h3 style="margin-top: 30px;">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
    
    <div class="search-container">
        <input type="text" id="searchSales" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('salesFilters')">
            <span> </span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="salesFilters" class="filters-container">
        <div class="filters-grid">
            <div class="filter-group">
                <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="salesDateFrom" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="salesDateTo" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ù…Ù†)</label>
                <input type="number" id="salesAmountFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="salesAmountTo" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                <select id="salesPaymentMethodFilter" class="filter-input">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</option>
                    <option value="cash">ğŸ’° ÙƒØ§Ø´</option>
                    <option value="bank">ğŸ¦ Ø¨Ù†Ùƒ</option>
                    <option value="mixed">ğŸ”„ Ù…Ø®ØªÙ„Ø·</option>
                </select>
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetSalesFilters()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button class="btn-primary" onclick="applySalesFilters()">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        </div>
    </div>
    
    <table id="salesTable">
        <thead>
            <tr>
                <th class="sortable" data-column="code">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th class="sortable" data-column="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th class="sortable" data-column="customerId">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th class="sortable" data-column="itemsCount">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th class="sortable" data-column="discount">Ø§Ù„Ø®ØµÙ…</th>
                <th class="sortable" data-column="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th class="sortable" data-column="paidAmount">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                <th class="sortable" data-column="paymentMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                <th class="sortable" data-column="remainingAmount">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                <th style="text-align: center;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="salesList"></tbody>
    </table>
</div>

<div id="returns" class="section">
    <h2>â†©ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</h2>
    <div class="tabs">
        <button id="salesReturnTabBtn" class="tab-button active" onclick="showReturnTab('sales')">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
        <button id="purchasesReturnTabBtn" class="tab-button" onclick="showReturnTab('purchases')">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
    </div>

    <div id="salesReturnContent" class="tab-content active">
        <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø§Ø¦Ù†)</h3>
        <div class="search-container">
            <input type="number" id="salesReturnInvoiceSearch" class="search-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©...">
            <button class="btn-primary" onclick="findSaleForReturn()">ğŸ” Ø¨Ø­Ø«</button>
        </div>
        
        <div id="salesReturnInvoiceDetails" class="return-invoice-details" style="display: none;"></div>

        <div id="salesReturnItemsContainer" style="display: none;">
            <h4>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹:</h4>
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„ØµÙ†Ù</th>
                        <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©</th>
                    </tr>
                </thead>
                <tbody id="salesReturnItemsList"></tbody>
            </table>
            <div class="invoice-totals">
                <div class="total">
                    <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</span>
                    <span id="salesReturnTotal">0.00</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-success" onclick="saveSaleReturn()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</button>
                <button class="btn-secondary" onclick="newSaleReturn()">ğŸ†• Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>
        
        <h3 style="margin-top: 30px;">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
        <table>
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
            </thead>
            <tbody id="salesReturnsList"></tbody>
        </table>
    </div>

    <div id="purchaseReturnContent" class="tab-content">
        <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª (Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¯ÙŠÙ†)</h3>
        <div class="search-container">
            <input type="number" id="purchaseReturnInvoiceSearch" class="search-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©...">
            <button class="btn-primary" onclick="findPurchaseForReturn()">ğŸ” Ø¨Ø­Ø«</button>
        </div>

        <div id="purchaseReturnInvoiceDetails" class="return-invoice-details" style="display: none;"></div>

        <div id="purchaseReturnItemsContainer" style="display: none;">
            <h4>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹:</h4>
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„ØµÙ†Ù</th>
                        <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©</th>
                    </tr>
                </thead>
                <tbody id="purchaseReturnItemsList"></tbody>
            </table>
            <div class="invoice-totals">
                <div class="total">
                    <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</span>
                    <span id="purchaseReturnTotal">0.00</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-success" onclick="savePurchaseReturn()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</button>
                <button class="btn-secondary" onclick="newPurchaseReturn()">ğŸ†• Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>

        <h3 style="margin-top: 30px;">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
        <table>
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                    <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
            </thead>
            <tbody id="purchaseReturnsList"></tbody>
        </table>
    </div>
</div>

<div id="expenses" class="section">
    <h2>ğŸ’¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatExpenses" class="stat-mini-number">0</span></span></h2>
    <p>ğŸ’° Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØµÙ†ÙŠÙ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p>
    
    <div class="form-grid grid-4">
        <input type="date" id="expenseDate" value="">
        <input type="text" id="expenseCategory" placeholder="ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ØµØ±ÙˆÙ *" required>
        <input type="number" id="expenseAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº *" required min="0">
        <select id="expenseBranchId">
            <option value="general_admin">ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>
            <option value="">ğŸª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
        </select>
    </div>
    
    <div class="form-grid grid-3">
        <input type="text" id="expenseDescription" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ">
        <select id="expensePaymentMethod">
            <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
            <option value="bank">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
            <option value="check">Ø´ÙŠÙƒ</option>
            <option value="card">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
        </select>
        <input type="text" id="expenseReference" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    </div>
    
    <div class="form-grid grid-2">
        <input type="file" id="expenseAttachment" accept="image/*,application/pdf" style="padding: 10px; border: 2px dashed var(--primary-color); background: #f8f9fa;">
        <button class="btn-primary btn-add" onclick="addExpense()">â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
    </div>
    <div class="search-container">
        <input type="text" id="searchExpenses" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª...">
    </div>

   <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                <th>Ø§Ù„ÙˆØµÙ</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                <th>Ø§Ù„Ù…Ø±ÙÙ‚</th> <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="expensesList"></tbody>
    </table>
    <div class="stats-grid" style="margin-top: 30px;">
        <div class="stat-card">
            <div class="stat-number" id="totalExpenses">0</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayExpenses">0</div>
            <div class="stat-label">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="monthExpenses">0</div>
            <div class="stat-label">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±</div>
        </div>
    </div>
</div>

<div id="revenues" class="section">
    <h2>ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatRevenues" class="stat-mini-number">0</span></span></h2>
    <p>ğŸ’µ Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØµÙ†ÙŠÙ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©</p>
    
    <div class="form-grid grid-4">
        <input type="date" id="revenueDate" value="">
        <input type="text" id="revenueCategory" placeholder="ØªØµÙ†ÙŠÙ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ *" required>
        <input type="number" id="revenueAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº *" required min="0">
        <select id="revenueBranchId">
            <option value="">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
        </select>
    </div>
    
    <div class="form-grid grid-3">
        <input type="text" id="revenueDescription" placeholder="ÙˆØµÙ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯">
        <select id="revenueSource">
            <option value="sales">Ù…Ø¨ÙŠØ¹Ø§Øª</option>
            <option value="services">Ø®Ø¯Ù…Ø§Øª</option>
            <option value="investment">Ø§Ø³ØªØ«Ù…Ø§Ø±</option>
            <option value="other">Ø£Ø®Ø±Ù‰</option>
        </select>
        <input type="text" id="revenueReference" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    </div>
    
    <div class="form-grid grid-1">
        <button class="btn-primary btn-add" onclick="addRevenue()">â• Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ±Ø§Ø¯</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchRevenues" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª...">
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„ÙˆØµÙ</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="revenuesList"></tbody>
    </table>
    
    <div class="stats-grid" style="margin-top: 30px;">
        <div class="stat-card">
            <div class="stat-number" id="totalRevenues">0</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayRevenues">0</div>
            <div class="stat-label">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="monthRevenues">0</div>
            <div class="stat-label">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div>
        </div>
    </div>
</div>


<!-- Ø¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ Ù‚Ø³Ù… Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆÙ‚Ø¨Ù„ Ù‚Ø³Ù… Ø§Ù„ØµØ¯Ù‚Ø© -->
<div id="advances" class="section">
    <h2>ğŸ’³ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatAdvances" class="stat-mini-number">0.00</span></span></h2>
    <p>ğŸ’° Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø³Ù„Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠØ©</p>
    
    <div class="form-grid grid-4">
        <input type="date" id="advanceDate" value="">
        <select id="advanceType">
            <option value="Ø³Ù„ÙØ©">Ø³Ù„ÙØ© Ù…ÙˆØ¸Ù</option>
            <option value="Ø¹Ù‡Ø¯Ø©">Ø¹Ù‡Ø¯Ø© Ù…Ø§Ù„ÙŠØ©</option>
            <option value="Ø³Ø¯Ø§Ø¯">Ø³Ø¯Ø§Ø¯</option>
        </select>
        <input type="text" id="advanceEmployee" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù / Ø§Ù„Ù…Ø³ØªÙ„Ù… *" required>
        <input type="number" id="advanceAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº *" required min="0">
    </div>
    
    <div class="form-grid grid-3">
        <input type="text" id="advanceDescription" placeholder="Ø§Ù„ÙˆØµÙ / Ø§Ù„ØºØ±Ø¶">
        <select id="advanceStatus">
            <option value="Ù…Ø³ØªØ­Ù‚">Ù…Ø³ØªØ­Ù‚</option>
            <option value="Ù…Ø³Ø¯Ø¯">Ù…Ø³Ø¯Ø¯</option>
            <option value="Ø¬Ø²Ø¦ÙŠ">Ù…Ø³Ø¯Ø¯ Ø¬Ø²Ø¦ÙŠØ§Ù‹</option>
        </select>
        <button class="btn-primary btn-add" onclick="addAdvance()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø©/Ø³Ù„ÙØ©</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchAdvances" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù...">
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù / Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„ÙˆØµÙ</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="advancesList"></tbody>
    </table>
    
    <div class="stats-grid" style="margin-top: 30px;">
        <div class="stat-card">
            <div class="stat-number" id="totalAdvances">0.00</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ù ÙˆØ§Ù„Ø¹Ù‡Ø¯</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="dueAdvances">0.00</div>
            <div class="stat-label">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="paidAdvances">0.00</div>
            <div class="stat-label">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³Ø¯Ø¯Ø©</div>
        </div>
    </div>
</div>

<div id="salaries" class="section">
    <h2>ğŸ’¼ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨ <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatSalaries" class="stat-mini-number">0.00</span></span></h2>
    <p>ğŸ§¾ Ù‚Ù… Ø¨Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø£Ù†Ø¸Ù…Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>

    <div class="salary-card">
        <h3>Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨</h3>
        <div class="form-grid">
            <input type="month" id="salaryMonth" value="">
            <input type="text" id="salaryEmployeeName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù *" required>
            <input type="text" id="salaryNationalId" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© *" required>
            <select id="salaryBranchId">
                <option value="general_admin">ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>
                <option value="">ğŸª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
            </select>
            <select id="salaryNationality" required>
                <option value="">ğŸ³ï¸ Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</option>
                <option value="saudi">ğŸ‡¸ğŸ‡¦ Ø³Ø¹ÙˆØ¯ÙŠ</option>
                <option value="non-saudi">ğŸŒ ØºÙŠØ± Ø³Ø¹ÙˆØ¯ÙŠ</option>
            </select>
            <input type="text" id="salaryEmployeeId" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" required>
            <input type="text" id="salaryJobTitle" placeholder="Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
            <input type="number" id="salaryBasic" placeholder="Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ *" min="0" step="0.01" required>
            <input type="number" id="salaryHousing" placeholder="Ø¨Ø¯Ù„ Ø§Ù„Ø³ÙƒÙ†" min="0" step="0.01">
            <input type="number" id="salaryTransport" placeholder="Ø¨Ø¯Ù„ Ø§Ù„Ù†Ù‚Ù„" min="0" step="0.01">
            <input type="number" id="salaryOtherAllowances" placeholder="Ø¨Ø¯Ù„Ø§Øª Ø£Ø®Ø±Ù‰" min="0" step="0.01">
            <input type="number" id="salaryOvertime" placeholder="Ù…ÙƒØ§ÙØ¢Øª Ø¥Ø¶Ø§ÙÙŠØ©" min="0" step="0.01">
            <input type="number" id="salaryOtherDeductions" placeholder="Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰" min="0" step="0.01">
            <textarea id="salaryNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ù…Ø³ÙŠØ±" rows="2"></textarea>
        </div>
        <div class="salary-actions">
            <button class="btn-primary" onclick="addSalary()">â• Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙŠØ±</button>
            <button class="btn-secondary" onclick="clearSalaryForm()">â†º ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        </div>
    </div>

    <div class="salary-summary">
        <h3>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯</h3>
        <div class="dashboard-cards">
            <div class="dashboard-card" style="background: white; border: 2px solid #3498db; color: #3498db;">
                <div class="card-value" id="salarySummaryCount" style="color: #3498db;">0</div>
                <div class="card-title" style="color: #3498db;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
                <div class="card-growth">
                    <span style="color: #3498db;">+0%</span>
                    <span class="growth-icon">ğŸ‘¥</span>
                </div>
            </div>
            <div class="dashboard-card" style="background: white; border: 2px solid #27ae60; color: #27ae60;">
                <div class="card-value" id="salarySummaryBasic" style="color: #27ae60;">0.00</div>
                <div class="card-title" style="color: #27ae60;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
                <div class="card-growth">
                    <span style="color: #27ae60;">+0%</span>
                    <span class="growth-icon">ğŸ’°</span>
                </div>
            </div>
            <div class="dashboard-card" style="background: white; border: 2px solid #f39c12; color: #f39c12;">
                <div class="card-value" id="salarySummaryAllowances" style="color: #f39c12;">0.00</div>
                <div class="card-title" style="color: #f39c12;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</div>
                <div class="card-growth">
                    <span style="color: #f39c12;">+0%</span>
                    <span class="growth-icon">ğŸ</span>
                </div>
            </div>
            <div class="dashboard-card" style="background: white; border: 2px solid #9b59b6; color: #9b59b6;">
                <div class="card-value" id="salarySummaryGross" style="color: #9b59b6;">0.00</div>
                <div class="card-title" style="color: #9b59b6;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨</div>
                <div class="card-growth">
                    <span style="color: #9b59b6;">+0%</span>
                    <span class="growth-icon">ğŸ’µ</span>
                </div>
            </div>
        </div>
        
        <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª -->
        <div class="dashboard-cards" style="margin-top: 15px;">
            <div class="dashboard-card" style="background: white; border: 2px solid #e74c3c; color: #e74c3c;">
                <div class="card-value" id="salarySummaryGosi" style="color: #e74c3c;">0.00</div>
                <div class="card-title" style="color: #e74c3c;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª GOSI</div>
                <div class="card-growth">
                    <span style="color: #e74c3c;">-9%</span>
                    <span class="growth-icon">ğŸ›ï¸</span>
                </div>
            </div>
            <div class="dashboard-card" style="background: white; border: 2px solid #e67e22; color: #e67e22;">
                <div class="card-value" id="salarySummaryGosiEmployer" style="color: #e67e22;">0.00</div>
                <div class="card-title" style="color: #e67e22;">Ù…Ø³Ø§Ù‡Ù…Ø© Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„ (GOSI)</div>
                <div class="card-growth">
                    <span style="color: #e67e22;">+9%</span>
                    <span class="growth-icon">ğŸ¢</span>
                </div>
            </div>
            <div class="dashboard-card" style="background: white; border: 2px solid #8e44ad; color: #8e44ad;">
                <div class="card-value" id="salarySummaryOtherDeductions" style="color: #8e44ad;">0.00</div>
                <div class="card-title" style="color: #8e44ad;">Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰</div>
                <div class="card-growth">
                    <span style="color: #8e44ad;">+0%</span>
                    <span class="growth-icon">ğŸ“‹</span>
                </div>
            </div>
            <div class="dashboard-card" style="background: white; border: 3px solid #2ecc71; color: #2ecc71; box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);">
                <div class="card-value" id="salarySummaryNet" style="font-size: 1.8em; font-weight: bold; color: #2ecc71;">0.00</div>
                <div class="card-title" style="font-weight: bold; color: #2ecc71;">ØµØ§ÙÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨</div>
                <div class="card-growth">
                    <span style="font-weight: bold; color: #2ecc71;">ğŸ’¼</span>
                    <span class="growth-icon">âœ…</span>
                </div>
            </div>
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="searchSalaries" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨...">
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„ØªØµØ¯ÙŠØ± -->
    <div class="export-options" style="margin: 20px 0;">
        <div class="form-grid grid-2">
            <button class="btn-success" onclick="exportSalariesToExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
            <button class="btn-secondary" onclick="printSalariesReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</th>
                <th>Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</th>
                <th>Ø§Ù„Ø´Ù‡Ø±</th>
                <th>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                <th>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</th>
                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th>Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ GOSI</th>
                <th>Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰</th>
                <th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="salariesList"></tbody>
    </table>
</div>

<div id="assets" class="section">
    <h2>ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© <span class="title-stat-card"><span class="stat-mini-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©:</span><span id="miniStatAssets" class="stat-mini-number">0.00</span></span></h2>
    <p>ğŸ­ Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØªØ¨Ø¹ Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</p>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ„ Ø¬Ø¯ÙŠØ¯ -->
    <div class="asset-card" id="assetForm">
        <h3>Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ„ Ø«Ø§Ø¨Øª Ø¬Ø¯ÙŠØ¯</h3>
        <div class="form-grid grid-3">
            <input type="text" id="assetName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„ *" required>
            <select id="assetType" required>
                <option value="">Ù†ÙˆØ¹ Ø§Ù„Ø£ØµÙ„</option>
                <option value="computers">ğŸ’» Ø£Ø¬Ù‡Ø²Ø© ÙƒÙ…Ø¨ÙŠÙˆØªØ±</option>
                <option value="furniture">ğŸª‘ Ø£Ø«Ø§Ø« Ù…ÙƒØªØ¨ÙŠ</option>
                <option value="vehicles">ğŸš— Ø³ÙŠØ§Ø±Ø§Øª ÙˆÙ…Ø±ÙƒØ¨Ø§Øª</option>
                <option value="equipment">âš™ï¸ Ù…Ø¹Ø¯Ø§Øª ÙˆØ¢Ù„Ø§Øª</option>
                <option value="electronics">ğŸ“± Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
                <option value="buildings">ğŸ¢ Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ¹Ù‚Ø§Ø±Ø§Øª</option>
                <option value="other">ğŸ“¦ Ø£Ø®Ø±Ù‰</option>
            </select>
            <input type="date" id="assetPurchaseDate" required>
        </div>
        
        <div class="form-grid grid-3">
            <input type="text" id="assetSupplier" placeholder="Ø§Ù„Ù…ÙˆØ±Ø¯ Ø£Ùˆ Ø§Ù„Ù…ØªØ¬Ø±">
            <input type="text" id="assetInvoiceNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
            <input type="number" id="assetCost" placeholder="ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡ *" min="0" step="0.01" required>
        </div>
        
        <div class="form-grid grid-3">
            <input type="number" id="assetLifespan" placeholder="Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ (Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª) *" min="1" max="50" required>
            <input type="number" id="assetSalvageValue" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø±Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" min="0" step="0.01">
            <select id="assetStatus">
                <option value="active">ğŸŸ¢ Ù†Ø´Ø·</option>
                <option value="maintenance">ğŸŸ¡ ØªØ­Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</option>
                <option value="inactive">ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·</option>
            </select>
        </div>
        
        <div class="form-grid grid-1">
            <textarea id="assetNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©" rows="2"></textarea>
        </div>
        
        <div class="asset-actions">
            <button class="btn-primary" onclick="addAsset()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ„</button>
        </div>
    </div>

    <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ù„Ù„Ø£ØµÙˆÙ„ -->
    <div class="assets-summary" id="assetsSummary">
        <div class="dashboard-cards">
            <div class="dashboard-card customers">
                <div class="card-value" id="totalAssetsValue">0.00</div>
                <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙˆÙ„</div>
                <div class="card-growth">
                    <span>+0%</span>
                    <span class="growth-icon">ğŸ¢</span>
                </div>
            </div>
            <div class="dashboard-card revenue">
                <div class="card-value" id="totalDepreciation">0.00</div>
                <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ</div>
                <div class="card-growth">
                    <span>+0%</span>
                    <span class="growth-icon">ğŸ“‰</span>
                </div>
            </div>
            <div class="dashboard-card profit">
                <div class="card-value" id="netAssetsValue">0.00</div>
                <div class="card-title">ØµØ§ÙÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙˆÙ„</div>
                <div class="card-growth">
                    <span>+0%</span>
                    <span class="growth-icon">ğŸ’</span>
                </div>
            </div>
            <div class="dashboard-card sales-today">
                <div class="card-value" id="totalAssetsCount">0</div>
                <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆÙ„</div>
                <div class="card-growth">
                    <span>+0%</span>
                    <span class="growth-icon">ğŸ“‹</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø« -->
    <div class="assets-filters">
        <select id="filterAssetType">
            <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
            <option value="computers">ğŸ’» Ø£Ø¬Ù‡Ø²Ø© ÙƒÙ…Ø¨ÙŠÙˆØªØ±</option>
            <option value="furniture">ğŸª‘ Ø£Ø«Ø§Ø« Ù…ÙƒØªØ¨ÙŠ</option>
            <option value="vehicles">ğŸš— Ø³ÙŠØ§Ø±Ø§Øª ÙˆÙ…Ø±ÙƒØ¨Ø§Øª</option>
            <option value="equipment">âš™ï¸ Ù…Ø¹Ø¯Ø§Øª ÙˆØ¢Ù„Ø§Øª</option>
            <option value="electronics">ğŸ“± Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
            <option value="buildings">ğŸ¢ Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ¹Ù‚Ø§Ø±Ø§Øª</option>
            <option value="other">ğŸ“¦ Ø£Ø®Ø±Ù‰</option>
        </select>
        <select id="filterAssetStatus">
            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="active">ğŸŸ¢ Ù†Ø´Ø·</option>
            <option value="maintenance">ğŸŸ¡ ØªØ­Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</option>
            <option value="inactive">ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·</option>
        </select>
        <input type="text" id="searchAssets" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£ØµÙˆÙ„...">
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„ØªØµØ¯ÙŠØ± -->
    <div class="export-options" style="margin: 20px 0;">
        <div class="form-grid grid-2">
            <button class="btn-success" onclick="exportAssetsToExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
            <button class="btn-secondary" onclick="printAssetsReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙˆÙ„ -->
    <table>
        <thead>
            <tr>
                <th>ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„</th>
                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                <th>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
                <th>Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ</th>
                <th>Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ Ø§Ù„Ø³Ù†ÙˆÙŠ</th>
                <th>Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ</th>
                <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØªØ±ÙŠØ©</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="assetsList"></tbody>
    </table>
</div>

<div id="reports" class="section">
    <h2>ï¿½ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
    <p>ï¿½ Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</p>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div class="tabs">
        <button id="reportsTabBtn" class="tab-button active" onclick="switchAccountingTab('reports')">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
        <button id="accountStatementsTabBtn" class="tab-button" onclick="switchAccountingTab('accountStatements')">ğŸ“‹ ÙƒØ´ÙˆÙ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
    </div>

    <!-- ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
    <div id="reportsTab" class="tab-content active">
        <div class="report-controls">
            <div class="form-grid grid-3" style="margin-bottom: 20px;">
                <div>
                    <select id="reportType" onchange="changeReportType()" style="width: 100%; padding: 12px; font-size: 14px;" placeholder="Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±">
                        <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</option>
                        <option value="sales">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                        <option value="purchases">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
                        <option value="sales_returns">â†©ï¸ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                        <option value="purchase_returns">â†©ï¸ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
                        <option value="expenses">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</option>
                        <option value="revenues">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</option>
                        <option value="salaries">ğŸ’¼ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨</option>
                        <option value="profit_loss">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø©</option>
                    </select>
                </div>
                <div>
                    <input type="date" id="reportFrom" placeholder="Ù…Ù† ØªØ§Ø±ÙŠØ®" style="width: 100%; padding: 12px; font-size: 14px;">
                </div>
                <div>
                    <input type="date" id="reportTo" placeholder="Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®" style="width: 100%; padding: 12px; font-size: 14px;">
                </div>
            </div>
            
            <div class="form-grid grid-3" style="margin-bottom: 20px;">
                <div>
                    <select id="paymentStatusFilter" style="width: 100%; padding: 12px; font-size: 14px;">
                        <option value="all">ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</option>
                        <option value="paid">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</option>
                        <option value="unpaid">ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</option>
                    </select>
                </div>
                <div>
                    <select id="reportItemFilter" onchange="updateReportItemFilter()" style="width: 100%; padding: 12px; font-size: 14px;">
                        <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù</option>
                        <option value="specific">ØµÙ†Ù Ù…Ø­Ø¯Ø¯</option>
                    </select>
                </div>
                <div>
                    <select id="reportSpecificItem" style="display: none; width: 100%; padding: 12px; font-size: 14px;">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>
                    </select>
                </div>
            </div>
            
            <!-- Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø®ÙÙŠØ© -->
            <select id="reportSupplierFilter" style="display: none;">
                <option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>
            </select>
            <select id="reportCustomerFilter" style="display: none;">
                <option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
            </select>
            
            <!-- ğŸª ÙÙ„ØªØ± Ø§Ù„ÙØ±ÙˆØ¹ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
            <div class="form-grid grid-1" style="margin-bottom: 20px;">
                <select id="reportBranchFilter" style="width: 100%; padding: 12px; font-size: 14px;">
                    <option value="all">ğŸª ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
                </select>
            </div>
        </div>
        
        <div class="export-options">
            <div class="form-grid grid-3">
                <button class="btn-primary" onclick="generateReport()">ğŸ” Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                <button class="btn-success" onclick="exportToExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
                <button class="btn-secondary" onclick="exportToWeb()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            </div>
        </div>
        
        <div class="report-summary" id="reportSummary">
               
        </div>
        
        <div id="reportResults">
        </div>
    </div>

    <!-- ØªØ¨ÙˆÙŠØ¨Ø© ÙƒØ´ÙˆÙ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª -->
    <div id="accountStatementsTab" class="tab-content">
        <div class="report-controls">
            <div class="form-grid grid-3" style="margin-bottom: 20px;">
                <div>
                    <label>Ù†ÙˆØ¹ Ø§Ù„ÙƒØ´Ù</label>
                    <select id="statementType" onchange="changeStatementType()" style="width: 100%; padding: 12px; font-size: 14px;">
                        <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙƒØ´Ù</option>
                        <option value="suppliers">ğŸ“¦ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>
                        <option value="customers">ğŸ‘¥ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
                        <option value="employees">ğŸ‘· ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
                        <option value="bank">ğŸ¦ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ</option>
                        <option value="cash">ğŸ’° ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</option>
                        <option value="tax">ğŸ“Š ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</option>
                    </select>
                </div>
                <div>
                    <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="statementFrom" placeholder="Ù…Ù† ØªØ§Ø±ÙŠØ®" style="width: 100%; padding: 12px; font-size: 14px;">
                </div>
                <div>
                    <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="statementTo" placeholder="Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®" style="width: 100%; padding: 12px; font-size: 14px;">
                </div>
            </div>
            
            <!-- Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø®ÙÙŠØ© -->
            <select id="specificSupplierFilter" style="display: none;" onchange="autoRefreshStatement()">
                <option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>
            </select>
            <select id="specificCustomerFilter" style="display: none;" onchange="autoRefreshStatement()">
                <option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
            </select>
            <select id="specificEmployeeFilter" style="display: none;" onchange="autoRefreshStatement()">
                <option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
            </select>
            <select id="taxFilterType" style="display: none; width: 100%; padding: 12px; font-size: 14px; margin-bottom: 15px;" onchange="autoRefreshStatement()">
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
                <option value="withTax">ÙÙ‚Ø· Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙŠ ÙÙŠÙ‡Ø§ Ø¶Ø±ÙŠØ¨Ø©</option>
                <option value="withoutTax">ÙÙ‚Ø· Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©</option>
            </select>
            <!-- ğŸª ÙÙ„ØªØ± Ø§Ù„ÙØ±ÙˆØ¹ - Ø¬Ø¯ÙŠØ¯ -->
            <select id="statementBranchFilter" style="width: 100%; padding: 12px; font-size: 14px; margin-bottom: 15px;" onchange="autoRefreshStatement()">
                <option value="all">ğŸª ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
            </select>
        </div>
        
        <div class="export-options">
            <div class="form-grid grid-3">
                <button class="btn-primary" onclick="generateAccountStatement()" style="padding: 12px 20px; font-size: 14px;">ğŸ” Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´Ù</button>
                <button class="btn-success" onclick="exportStatementToExcel()" style="padding: 12px 20px; font-size: 14px;">ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
                <button class="btn-secondary" onclick="printAccountStatement()" style="padding: 12px 20px; font-size: 14px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù</button>
            </div>
        </div>
        
        <div class="account-statement-summary" id="statementSummary">
            <div class="dashboard-cards">
                <div class="dashboard-card customers">
                    <div class="card-value" id="summaryTotalTransactions">0.00</div>
                    <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</div>
                    <div class="card-growth">
                        <span id="transactionsGrowth">+0%</span>
                        <span class="growth-icon">ğŸ“Š</span>
                    </div>
                </div>
                <div class="dashboard-card profit">
                    <div class="card-value" id="summaryTotalPaid">0.00</div>
                    <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
                    <div class="card-growth">
                        <span id="paidGrowth">+0%</span>
                        <span class="growth-icon">âœ…</span>
                    </div>
                </div>
                <div class="dashboard-card revenue">
                    <div class="card-value" id="summaryTotalRemaining">0.00</div>
                    <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                    <div class="card-growth">
                        <span id="remainingGrowth">+0%</span>
                        <span class="growth-icon">â³</span>
                    </div>
                </div>
                <div class="dashboard-card sales-today">
                    <div class="card-value" id="summaryRecordsCount">0</div>
                    <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
                    <div class="card-growth">
                        <span id="recordsGrowth">+0%</span>
                        <span class="growth-icon">ğŸ“‹</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="statementResults">
        </div>
    </div>
</div>

<div id="settings" class="section">
    <h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù†Ø¸Ø§Ù…</h2>

    <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div class="settings-tabs">
        <button class="settings-tab active" onclick="switchSettingsTab('users')">
            ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        </button>
        <button class="settings-tab" onclick="switchSettingsTab('activities')">
            ğŸ¢ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙˆØ§Ù„ÙØ±ÙˆØ¹
        </button>
        <button class="settings-tab" onclick="switchSettingsTab('general')">
            âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        </button>
        <button class="settings-tab" onclick="switchSettingsTab('backup')">
            ğŸ’¾ Ø§Ù„Ù†Ø³Ø® ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        </button>
    </div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
    <div id="usersTabContent" class="settings-tab-content active">
        <div id="userManagementSection" class="user-management settings-card">
            <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            
            <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ -->
            <div class="current-user-info" style="background: #f0f7ff; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-right: 4px solid var(--primary-color);">
                <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 1.1em;">ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</h4>
                <div class="form-grid grid-2" style="margin-bottom: 15px;">
                    <div>
                        <strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="currentUserNameDisplay">-</span>
                    </div>
                    <div>
                        <strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> <span id="currentUserEmailDisplay">-</span>
                    </div>
                    <div>
                        <strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> <span id="currentUserPhoneDisplay">-</span>
                    </div>
                    <div>
                        <strong>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:</strong> <span id="currentUserRoleDisplay">-</span>
                    </div>
                </div>
                <div id="currentActivityDisplay" style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <strong>ğŸ¢ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> <span id="currentActivityNameDisplay">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø·</span>
                </div>
                <div class="form-grid grid-3">
                    <button class="btn-primary" onclick="openSelfEditUserModal()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</button>
                    <button class="btn-warning" id="changeActivityBtn" onclick="showActivityModal()" style="display: none;">ğŸ”„ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·</button>
                    <button class="btn-warning" onclick="openChangePasswordModal()">ğŸ”’ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
                </div>
            </div>
            
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
            <div class="user-selector" style="margin-bottom: 25px;">
                <h4 style="color: var(--secondary-color); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0;">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
                <label for="usersDropdown" class="user-selector-label">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:</label>
                <div class="user-selector-controls">
                    <select id="usersDropdown" onchange="handleUserSelection()">
                        <option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§</option>
                    </select>
                </div>
                <div id="selectedUserInfo" class="selected-user-info" style="display: none;">
                    <div class="selected-user-grid">
                        <div class="selected-user-field">
                            <label for="selectedUserName">Ø§Ù„Ø§Ø³Ù…</label>
                            <input type="text" id="selectedUserName" readonly>
                        </div>
                        <div class="selected-user-field role-field">
                            <label for="selectedUserRole">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                            <input type="text" id="selectedUserRole" readonly>
                        </div>
                        <div class="selected-user-field">
                            <label for="selectedUserEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="text" id="selectedUserEmail" readonly>
                        </div>
                        <div class="selected-user-field phone-field">
                            <label for="selectedUserPhone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                            <input type="text" id="selectedUserPhone" readonly>
                        </div>
                        <div class="selected-user-field">
                            <label for="selectedUserActivity">Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø®ØµØµ</label>
                            <input type="text" id="selectedUserActivity" readonly>
                        </div>
                    </div>
                    <div class="selected-user-actions">
                        <button class="btn-warning edit-btn" id="editSelectedUserBtn" onclick="handleEditSelectedUser()" disabled>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger" id="deleteSelectedUserBtn" onclick="handleDeleteSelectedUser()" disabled>ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                </div>
            </div>
            
            <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ -->
            <div style="margin-bottom: 25px;">
                <h4 style="color: var(--secondary-color); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0;"> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h4>
                <form id="newUserForm" onsubmit="return false;">
                <div class="form-grid grid-3">
                    <input type="text" id="newUserName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… *" autocomplete="name">
                    <select id="newUserRole">
                        <option value="admin">Ù…Ø¯ÙŠØ±</option>
                        <option value="manager">Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·</option>
                        <option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option>
                    </select>
                    <input type="email" id="newUserEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *" autocomplete="email">
                </div>
                <div class="form-grid grid-3">
                    <input type="tel" id="newUserPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ *" autocomplete="tel">
                    <input type="password" id="newUserPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *" autocomplete="new-password">
                    <select id="newUserActivity">
                        <option value="">-- ØªØ¹ÙŠÙŠÙ† Ù„Ù†Ø´Ø§Ø· --</option>
                    </select>
                </div>
                    <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
                    <div class="form-grid grid-3" style="margin-top: 15px;">
                        <button class="btn-primary btn-add" onclick="addUser()" style="padding: 15px; font-size: 1.1em; font-weight: 600;"> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                        <div></div>
                        <div></div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙˆØ§Ù„ÙØ±ÙˆØ¹ -->
    <div id="activitiesTabContent" class="settings-tab-content">
        <div id="activityManagementSection" class="activities-management settings-card">
            <h3>ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</h3>
            <div class="form-grid grid-3">
                <input type="text" id="settingNewActivityName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                <button class="btn-primary btn-add" onclick="addNewActivity(true)"> Ø¥Ø¶Ø§ÙØ© Ù†Ø´Ø§Ø·</button>
                <button class="btn-secondary" onclick="migrateActivitiesToFirebase()" style="background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%); opacity: 0.7;">
                    ï¿½ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù€ Firebase
                </button>
                <p style="font-size: 0.8em; color: #666; margin: 5px 0; font-style: italic;">
                    ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Firebase
                </p>
                <button class="btn-secondary" onclick="migrateActivityDataToFirebase()" style="background: linear-gradient(135deg, #9C27B0 0%, #E91E63 100%); opacity: 0.7;">
                    ï¿½ Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                </button>
                <p style="font-size: 0.8em; color: #666; margin: 5px 0; font-style: italic;">
                    ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Firebase
                </p>
            </div>
            <div class="activity-selector" style="margin-top: 20px;">
                <label for="activitiesDropdown" class="activity-selector-label">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø©:</label>
                <div class="activity-selector-controls">
                    <select id="activitiesDropdown" onchange="handleActivitySelection()">
                        <option value="">Ø§Ø®ØªØ± Ù†Ø´Ø§Ø·Ù‹Ø§</option>
                    </select>
                </div>
                <div id="selectedActivityInfo" class="selected-activity-info" style="display: none;">
                    <div class="selected-activity-field">
                        <label for="selectedActivityName">Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·</label>
                        <input type="text" id="selectedActivityName" readonly>
                    </div>
                    <div class="selected-activity-actions">
                        <button class="btn-warning edit-btn" id="editSelectedActivityBtn" onclick="handleEditSelectedActivity()" disabled>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger" id="deleteSelectedActivityBtn" onclick="handleDeleteSelectedActivity()" disabled>ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ğŸ¢ Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹ - Ø¬Ø¯ÙŠØ¯ -->
        <div id="branchManagementSection" class="branches-management settings-card" style="display: none;">
            <h3>ğŸª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹</h3>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙØ±ÙˆØ¹ Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙˆØ§Ø­Ø¯ ÙˆØªØªØ¨Ø¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„ÙƒÙ„ ÙØ±Ø¹ Ø¹Ù„Ù‰ Ø­Ø¯Ø©
            </p>
            
            <div class="form-grid grid-2" style="margin-bottom: 20px;">
                <input type="text" id="newBranchName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ø§Ù„: Ø§Ù„Ø±ÙŠØ§Ø¶ - Ø­ÙŠ Ø§Ù„Ù†Ø®ÙŠÙ„)">
                <button class="btn-primary btn-add" onclick="addBranch()">â• Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹</button>
            </div>
            
            <div id="branchesTableContainer">
                <table id="branchesTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                            <th style="text-align: left;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="branchesTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999; padding: 30px;">
                                Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹ - Ø£Ø¶Ù ÙØ±Ø¹Ùƒ Ø§Ù„Ø£ÙˆÙ„
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
    <div id="generalTabContent" class="settings-tab-content">
        <!-- ğŸ“„ Ù‚Ø³Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ - Ø¬Ø¯ÙŠØ¯ -->
        <div id="footerSettingsSection" class="footer-settings settings-card">
            <h3>ğŸ“„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„</h3>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                Ù‚Ù… Ø¨ØªØ®ØµÙŠØµ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØªÙŠ ØªØ¸Ù‡Ø± ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
            </p>
            
            <button class="btn-primary" onclick="openFooterSettingsModal()" style="padding: 15px 30px; font-size: 1.1em;">
                âš™ï¸ ØªØ®ØµÙŠØµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„
            </button>
            
            <div class="tips-container" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 0.85em;">
                <p><strong>ğŸ’¡ Ù†ØµØ§Ø¦Ø­:</strong></p>
                <ul style="margin: 5px 0; padding-right: 20px;">
                    <li>ÙŠÙ…ÙƒÙ†Ùƒ ØªØ±Ùƒ Ø£ÙŠ Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„ÙŠÙ‡</li>
                    <li>Ø³ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙØ§Ø±ØºØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„ØªØ°ÙŠÙŠÙ„</li>
                    <li>ÙŠÙØ­ÙØ¸ Ø§Ù„ØªØ°ÙŠÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø­Ù„ÙŠ</li>
                    <li>Ø§Ø³ØªØ®Ø¯Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ù†Ø§Ø³Ø¨Ø© Ù„ÙˆØµÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</li>
                </ul>
            </div>
        </div>

        <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆØ´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div id="programLogoSection" class="logo-settings settings-card">
                <h3>ï¿½ Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</h3>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Ø§Ø®ØªØ± Ø´Ø¹Ø§Ø±Ø§Ù‹ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</p>
                
                <div class="logo-preview-container" style="text-align: center; margin-bottom: 20px;">
                    <img id="logoPreview" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¹Ø§Ø±" style="max-width: 150px; max-height: 150px; display: none; border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
                    <p id="noLogoText" style="color: #999; font-style: italic;">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯</p>
                </div>
                
                <div class="logo-actions" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <input type="file" id="logoFileInput" accept="image/*" style="display: none;" onchange="handleLogoUpload(this)">
                    <button class="btn-primary" onclick="document.getElementById('logoFileInput').click()">ğŸ“¤ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø¹Ø§Ø±</button>
                    <button class="btn-danger" id="removeLogoBtn" onclick="removeLogo()" style="display: none;">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø±</button>
                </div>
                
                <div class="tips-container" style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: auto; font-size: 0.85em;">
                    <p><strong>ğŸ’¡ Ù†ØµØ§Ø¦Ø­:</strong></p>
                    <ul style="margin: 5px 0; padding-right: 20px;">
                        <li>ÙŠÙÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø¨Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© (PNG)</li>
                        <li>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡: 500Ã—500 Ø¨ÙƒØ³Ù„</li>
                        <li>Ø£Ù‚ØµÙ‰ Ø­Ø¬Ù… Ù„Ù„Ù…Ù„Ù: 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª</li>
                    </ul>
                </div>
            </div>

            <div id="activityLogoSection" class="activity-logo-settings settings-card" style="display: none;">
                <h3>ï¿½ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</h3>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Ø§Ø®ØªØ± Ø´Ø¹Ø§Ø±Ø§Ù‹ Ù„Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±)</p>
                
                <div class="logo-preview-container" style="text-align: center; margin-bottom: 20px;">
                    <img id="activityLogoPreview" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·" style="max-width: 150px; max-height: 150px; display: none; border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
                    <p id="noActivityLogoText" style="color: #999; font-style: italic;">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ù„Ù„Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯</p>
                </div>
                
                <div class="logo-actions" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 30px;">
                    <input type="file" id="activityLogoFileInput" accept="image/*" style="display: none;" onchange="handleActivityLogoUpload(this)">
                    <button class="btn-primary" onclick="document.getElementById('activityLogoFileInput').click()">ğŸ“¤ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·</button>
                    <button class="btn-danger" id="removeActivityLogoBtn" onclick="removeActivityLogo()" style="display: none;">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø±</button>
                </div>
                
                <div class="tips-container" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: auto; font-size: 0.85em;">
                    <p><strong>ğŸ’¡ Ù†ØµØ§Ø¦Ø­:</strong></p>
                    <ul style="margin: 5px 0; padding-right: 20px;">
                        <li>Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ ÙˆØ³Ø· Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· ØªØ­ØªÙ‡</li>
                        <li>ÙŠÙÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø¨Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© (PNG)</li>
                        <li>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡: 400Ã—400 Ø¨ÙƒØ³Ù„</li>
                        <li>Ø£Ù‚ØµÙ‰ Ø­Ø¬Ù… Ù„Ù„Ù…Ù„Ù: 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©: Ø§Ù„Ù†Ø³Ø® ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© -->
    <div id="backupTabContent" class="settings-tab-content">
        <div class="backup-settings settings-card" style="background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%); color: white; border: none;">
            <h3 style="color: white;">ï¿½ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</h3>
            <p style="opacity: 0.95; margin-bottom: 20px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙˆØ­ÙØ¸Ù‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</p>
            
            <div class="data-actions-grid" style="gap: 15px;">
                <button class="btn-success" onclick="createBackup()" style="background: #10b981;">
                    ğŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ø¢Ù†
                </button>
                <button class="btn-warning" onclick="showBackupInfoWithRestore()" style="background: #f59e0b;">
                    ğŸ“‹ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¢Ø®Ø± Ù†Ø³Ø®Ø©
                </button>
                <button class="btn-secondary" onclick="downloadAutoBackup()" style="background: #6366f1;">
                    ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© ÙƒÙ…Ù„Ù
                </button>
                <button class="btn-success" onclick="exportActivityData()" style="background: #059669;">
                    ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·
                </button>
                <button class="btn-info" onclick="exportActivityDataExcel()" style="background: #0284c7;">
                    ğŸ“Š ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Excel
                </button>
                <button class="btn-primary" onclick="importData()" style="background: #7c3aed;">
                    ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ø´Ø§Ø·
                </button>
                <button class="btn-secondary" onclick="importSampleData()" style="background: #64748b;">
                    ğŸ§ª Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù†Ø´Ø§Ø·
                </button>
                <button class="btn-danger" onclick="showTrashModal()">
                    ğŸ—‘ï¸ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                    <span id="trash-count-badge" style="background: #fff; color: #d32f2f; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-right: 5px; font-weight: bold;"></span>
                </button>
                <button class="btn-danger" onclick="clearActivityData()" style="background: #dc2626;">
                    ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·
                </button>
                <button id="toggleEmailSettingsBtn" class="btn-success" onclick="toggleEmailSettings()" style="background: #16a34a;">
                    ğŸ“§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                </button>
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 8px; margin-top: 20px; backdrop-filter: blur(10px);">
                <h4 style="color: white; margin-bottom: 10px;">ğŸ’¡ Ù†ØµØ§Ø¦Ø­ Ù…Ù‡Ù…Ø©:</h4>
                <ul style="margin: 0; padding-right: 20px; opacity: 0.95;">
                    <li>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø£Ø¹Ù„Ø§Ù‡ Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·</li>
                    <li>Ø§Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„ÙƒÙ„ Ù†Ø´Ø§Ø· Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ</li>
                    <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØµØ­ÙŠØ­ Ù‚Ø¨Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ùˆ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
                    <li>Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªØ´Ù…Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· (Ø§Ù„Ø£ØµÙ†Ø§ÙØŒ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŒ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†ØŒ Ø§Ù„ÙÙˆØ§ØªÙŠØ±ØŒ Ø¥Ù„Ø®.)</li>
                </ul>
            </div>
            
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(this.files)">
        </div>

        <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Firebase -->
        <div class="settings-card" style="margin-top: 20px;">
            <h3>ğŸ”¥ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Firebase</h3>
            
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… -->
            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #1976d2; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                <h4 style="margin: 0 0 15px 0; color: #0d47a1; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                    ğŸ”¥ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¬ÙŠÙ†
                </h4>
                <div style="font-size: 0.95em; color: #1565c0; line-height: 1.6;">
                    âœ… <strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯:</strong> ÙŠØ­ÙØ¸ÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Firebase + LocalStorage<br>
                    âœ… <strong>Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</strong> ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Firebase + LocalStorage<br>
                    âœ… <strong>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·:</strong> ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Firebase + LocalStorage<br>
                    ğŸ’¡ <strong>Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡:</strong> ÙÙ‚Ø· Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
                </div>
            </div>
            
            <div class="form-grid grid-3">
                <button class="btn-secondary" onclick="fixUsersPhoneField()">
                    ğŸ“± Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚Ù„ Ø§Ù„Ù‡Ø§ØªÙ
                </button>
                <button class="btn-secondary" onclick="migrateUsersToFirebase()">
                    ğŸ‘¥ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰
                </button>
                <button class="btn-secondary" onclick="fixFirebaseUserData()">
                    ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Firebase
                </button>
                <button class="btn-secondary" onclick="migrateActivitiesToFirebase()">
                    ğŸ¢ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                </button>
                <button class="btn-secondary" onclick="migrateActivityDataToFirebase()">
                    ğŸ“Š Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                </button>
            </div>
            <p style="font-size: 0.9em; color: #666; margin: 15px 0; font-style: italic; text-align: center;">
                ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Firebase + LocalStorage
            </p>
        </div>
    </div>
</div>

<div id="purchaseInvoicePrint" class="invoice-print">
    <!-- Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ -->
    <div style="border: 4px double #2c5aa0; padding: 15px; position: relative;">
        
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø±: Ø§Ù„Ø´Ø¹Ø§Ø± (Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø±) + Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· -->
        <div style="border: 2px solid #2c5aa0; border-radius: 15px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center;">
            <div style="width: 60px; display: flex; justify-content: flex-start;">
                <img id="printPurchaseActivityLogo" src="" alt="Ø´Ø¹Ø§Ø±" style="width: 50px; height: 50px; display: none; margin: 0; border-radius: 50%; border: 2px solid #2c5aa0;">
            </div>
            <div style="text-align: center; flex: 1;">
                <h2 id="printPurchaseActivityName" style="margin: 0; color: #2c5aa0; font-size: 1.5em; font-weight: bold;">Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·</h2>
                <div style="font-size: 0.85em; margin-top: 2px;">ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</div>
            </div>
            <div style="width: 60px;"></div>
        </div>
        
        <!-- ØµÙ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 0.95em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px;">
                <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="printPurchaseDate"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px;">
                <strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> <span id="printPurchaseNumber"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px;">
                <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> <span id="printPurchaseTime">--:--</span>
            </div>
        </div>
        
        <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ -->
        <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 10px; font-size: 0.95em;">
            <strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> <span id="printSupplierName">-----</span>
        </div>
        
        <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 10px; font-size: 0.9em;">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> <span id="printPurchaseNotes">-----</span>
        </div>
        
        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù -->
        <table class="invoice-items-table" style="width: 100%; border-collapse: collapse; margin-bottom: 10px; table-layout: fixed; display: table; margin: 0;">
            <colgroup>
                <col style="width: 5%;">    <!-- Ù… -->
                <col style="width: 25%;">   <!-- Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù -->
                <col style="width: 12.5%;"> <!-- Ø§Ù„ÙƒÙ…ÙŠØ© -->
                <col style="width: 12.5%;"> <!-- Ø§Ù„ÙˆØ­Ø¯Ø© -->
                <col style="width: 12.5%;"> <!-- Ø§Ù„Ø³Ø¹Ø± -->
                <col style="width: 12.5%;"> <!-- Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ -->
            </colgroup>
            <thead>
                <tr style="background: #e3f2fd; color: #2c5aa0;">
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">Ù…</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: right;">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">Ø§Ù„Ø³Ø¹Ø±</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                </tr>
            </thead>
            <tbody id="printPurchaseItems" style="font-size: 0.95em;">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </tbody>
        </table>
        
        <!-- Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± Ø§Ù„ØµÙØ­Ø© -->
        <div style="margin-top: 15px; width: 280px; float: left;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #f8f9fa; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</strong>
                <span id="printPurchaseSubtotal">0.00</span>
            </div>
            <div id="printPurchaseTaxRow" style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%):</strong>
                <span id="printPurchaseTax">0.00</span>
            </div>
            <div style="border: 2px solid #2c5aa0; padding: 10px; background: #e3f2fd; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-weight: bold; font-size: 1em; color: #2c5aa0;">
                <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong>
                <span id="printPurchaseTotal">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong>
                <span id="printPurchasePaid">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #fff3cd; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong>
                <span id="printPurchaseRemaining">0.00</span>
            </div>
        </div>
        
        <div style="clear: both;"></div>
    </div>
</div>

<div id="saleInvoicePrint" class="invoice-print">
    <!-- Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ -->
    <div style="border: 4px double #2c5aa0; padding: 15px; position: relative;">
        
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø±: Ø§Ù„Ø´Ø¹Ø§Ø± (Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø±) + Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· -->
        <div style="border: 2px solid #2c5aa0; border-radius: 15px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center;">
            <div style="width: 60px; display: flex; justify-content: flex-start;">
                <img id="printSaleActivityLogo" src="" alt="Ø´Ø¹Ø§Ø±" style="width: 50px; height: 50px; display: none; margin: 0; border-radius: 50%; border: 2px solid #2c5aa0;">
            </div>
            <div style="text-align: center; flex: 1;">
                <h2 id="printSaleActivityName" style="margin: 0; color: #2c5aa0; font-size: 1.5em; font-weight: bold;">Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·</h2>
                <div style="font-size: 0.85em; margin-top: 2px;">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</div>
            </div>
            <div style="width: 60px;"></div>
        </div>
        
        <!-- ØµÙ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div style="display: grid; grid-template-columns: 1fr 1.5fr 0.8fr; gap: 10px; margin-bottom: 10px; font-size: 0.95em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; font-size: 0.85em; border-radius: 8px;">
                <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="printSaleDate"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; background: #e3f2fd; font-size: 0.85em; border-radius: 8px;">
                <strong>ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø© Ù€ Ø±Ù‚Ù…:</strong> <span id="printSaleNumber"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; font-size: 0.85em; border-radius: 8px;">
                <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> <span id="printSaleTime">--:--</span>
            </div>
        </div>
        
        <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
        <div style="display: grid; grid-template-columns: 1.5fr 0.8fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 0.95em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="printCustomerName">-----</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="printCustomerCode">-----</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> <span id="printCustomerPhone">-----</span>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 0.9em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="printCustomerAddress">-----</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> <span id="printSaleNotes">-----</span>
            </div>
        </div>
        
        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù -->
    <table class="invoice-items-table" style="width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 10px;">
            <thead>
                <tr style="background: #e3f2fd; color: #2c5aa0;">
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 5%; border-radius: 6px;">Ù…</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15%; border-radius: 6px;">Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 33%; border-radius: 6px;">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15.5%; border-radius: 6px;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15.5%; border-radius: 6px;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15.5%; border-radius: 6px;">Ø§Ù„Ø³Ø¹Ø±</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 12.5%; border-radius: 6px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                </tr>
            </thead>
            <tbody id="printSaleItems" style="font-size: 0.9em;">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </tbody>
        </table>
        
        <!-- Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± Ø§Ù„ØµÙØ­Ø© -->
            <div style="margin-top: 15px; width: 280px; float: left;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #f8f9fa; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</strong>
                <span id="printSaleSubtotal">0.00</span>
            </div>
            <div id="printSaleDiscountRow" style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #fff8e1; font-size: 0.9em;">
                <strong>Ø§Ù„Ø®ØµÙ…:</strong>
                <span id="printSaleDiscount">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #e8f5e8; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…:</strong>
                <span id="printSaleAfterDiscount">0.00</span>
            </div>
            <div id="printSaleTaxRow" style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%):</strong>
                <span id="printSaleTax">0.00</span>
            </div>
            <div style="border: 2px solid #2c5aa0; padding: 10px; background: #e3f2fd; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-weight: bold; font-size: 1em; color: #2c5aa0;">
                <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong>
                <span id="printSaleTotal">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong>
                <span id="printSalePaid">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #e8f4fd; font-size: 0.9em;">
                <strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong>
                <span id="printSalePaymentMethod">ğŸ’° ÙƒØ§Ø´</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #fff3cd; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong>
                <span id="printSaleRemaining">0.00</span>
            </div>
        </div>
        
        <div style="clear: both;"></div>
    </div>
</div>
        </div>
    </div>
    <script>
// === Ø¯ÙˆØ§Ù„ Firebase Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ===
// ... (Ø£Ø³ÙÙ„ Ø¯ÙˆØ§Ù„ firebaseGet, firebaseSet, etc.)

console.log('ğŸ”¥ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ...');

console.log('ğŸ” Checking if we reach this point...');

/**
 * Ø¯Ø§Ù„Ø© Ù„Ø±ÙØ¹ Ù…Ù„Ù Ø¥Ù„Ù‰ Firebase Storage
 * @param {File} file - Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±ÙØ¹Ù‡
 * @param {string} path - Ø§Ù„Ù…Ø³Ø§Ø± Ø¯Ø§Ø®Ù„ Storage (Ù…Ø«Ù„ 'purchases' Ø£Ùˆ 'expenses')
 * @returns {Promise<string|null>} - Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø£Ùˆ null Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„
 */
/**
 * Ø¯Ø§Ù„Ø© Ù„Ø±ÙØ¹ Ù…Ù„Ù Ø¥Ù„Ù‰ Cloudinary
 * @param {File} file - Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±ÙØ¹Ù‡
 * @param {string} path - (Ù„Ù… Ù†Ø¹Ø¯ Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ù‡Ù†Ø§ ÙˆÙ„ÙƒÙ† Ø³Ù†Ø¨Ù‚ÙŠÙ‡ Ù„Ù„ØªÙˆØ§ÙÙ‚)
 * @returns {Promise<string|null>} - Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø£Ùˆ null Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„
 */
async function uploadFile(file, path) {
    if (!file) return null;

    // --- â¬‡ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Cloudinary Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ â¬‡ï¸ ---
    const CLOUD_NAME = "dgjcr2bgq";
    const UPLOAD_PRESET = "diwani_uploads";
    // --- â¬†ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â¬†ï¸ ---

    const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… FormData Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', UPLOAD_PRESET);

    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù„Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø·
    if (currentActivityId) {
        formData.append('folder', `diwani_attachments/${currentActivityId}/${path}`);
    }

    try {
        showLoading(`Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚... ${file.name}`);

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Cloudinary
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok && data.secure_url) {
            // Ù†Ø¬Ø­ Ø§Ù„Ø±ÙØ¹!
            hideLoading();
            showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            return data.secure_url; // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¢Ù…Ù† Ù„Ù„Ù…Ù„Ù
        } else {
            // ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹
            throw new Error(data.error.message || 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹');
        }

    } catch (error) {
        hideLoading();
        logError('Cloudinary Upload', error);
        showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ' + error.message, 'error');
        return null;
    }
}

// ========================================
// ğŸ”¥ Firebase Integration - ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„
// ========================================
const USE_FIREBASE = true; // true = Firebase, false = LocalStorage ÙÙ‚Ø·

// Ø§Ø¬Ø¹Ù„ Ù‚ÙŠÙ…Ø© DEBUG_MODE Ù…ØªØ²Ø§Ù…Ù†Ø© Ù…Ø¹ window.DEBUG_MODE Ø§Ù„Ø°ÙŠ ØªÙ… ØªØ¹Ø±ÙŠÙÙ‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹
let DEBUG_MODE = typeof window.DEBUG_MODE === 'boolean' ? window.DEBUG_MODE : false;

function debugLog(...args) {
    if (window.DEBUG_MODE) {
        console.log(...args);
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ¨Ø¯ÙŠÙ„ DEBUG_MODE Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
function toggleDebugMode(enable = null) {
    const original = window.__ORIGINAL_CONSOLE__ || console;
    if (enable === null) {
        window.DEBUG_MODE = !window.DEBUG_MODE;
    } else {
        window.DEBUG_MODE = !!enable;
    }
    DEBUG_MODE = window.DEBUG_MODE; // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙŠ Ù…ØªØ²Ø§Ù…Ù†Ø§Ù‹
    // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø­ØªÙ‰ Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
    original.log(`ğŸ› DEBUG_MODE: ${window.DEBUG_MODE ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…Ø¹Ø·Ù‘Ù„'}`);
    return window.DEBUG_MODE;
}

// ÙƒØ´Ù Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
if (typeof window !== 'undefined') {
    // Ù„Ø§ ØªØ¹ÙŠØ¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù„Ù‰ window.DEBUG_MODE Ù‡Ù†Ø§ Ø­ØªÙ‰ Ù„Ø§ ØªÙØ³Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¨ÙƒØ±Ø©
    window.toggleDebugMode = toggleDebugMode;
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
function systemStatus() {
    console.log('ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©:');
    console.log(`ğŸ”¥ Firebase: ${USE_FIREBASE ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…Ø¹Ø·Ù‘Ù„'}`);
    console.log(`ğŸ› Debug Mode: ${DEBUG_MODE ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…Ø¹Ø·Ù‘Ù„'}`);
    console.log(`ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: ${window.currentUser ? window.currentUser.name : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}`);
    console.log(`ğŸ¢ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentActivityId ? currentActivityId : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`);
    console.log('ğŸ”§ Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Debug Mode: toggleDebugMode()');
    return {
        firebase: USE_FIREBASE,
        debugMode: DEBUG_MODE,
        currentUser: window.currentUser,
        currentActivityId: currentActivityId
    };
}

// ÙƒØ´Ù Ø¯Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
if (typeof window !== 'undefined') {
    window.systemStatus = systemStatus;
}

// ========================================
// ğŸ”¥ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
// ========================================
let activities = [];
let currentActivityId = null;
let items = [], customers = [], suppliers = [], purchases = [], sales = [], expenses = [], revenues = [], salaries = [], assets = [];
let branches = []; // ğŸ¢ Ø§Ù„ÙØ±ÙˆØ¹ - Ø¬Ø¯ÙŠØ¯
let advances = [];
let salesReturns = [], purchaseReturns = [];
let currentPurchaseItems = [], currentSaleItems = [];
let editingPurchaseId = null, editingSaleId = null, editingSalaryId = null;
let currentPurchaseNumber = 1, currentSaleNumber = 1;
let currentSaleReturnNumber = 1, currentPurchaseReturnNumber = 1;
let activeSaleReturn = null, activePurchaseReturn = null;
let users = [];
const GOSI_RATE = 0.09;
const GOSI_SALARY_CAP = 45000;

// ========================================
// ğŸ”¥ ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© initializeApp Ù…Ø¨ÙƒØ±Ø§Ù‹
// ========================================
async function initializeApp() {
    console.log('ğŸ¯ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
    console.log('ğŸš€ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¯ÙŠÙˆØ§Ù† - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ v23.0');
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ù† Firebase/LocalStorage
    console.log('ğŸ“‹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©...');
    await loadUsers();
    await loadActivities();
    
    if (!currentActivityId) { 
        console.log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ù…Ø­Ø¯Ø¯ - Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø©');
        showActivityModal(); 
        return; 
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ø£Ùˆ LocalStorage
    if (USE_FIREBASE) {
        debugLog('ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...');
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
        console.log(`ğŸ” Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ø´Ø§Ø·: ${currentActivityId}`);
        
        const firebaseItems = await firebaseGetActivityData(currentActivityId, 'items') || [];
        console.log(`ğŸ“¦ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseItems.length} ØµÙ†Ù Ù…Ù† Firebase`);
        
        const firebaseCustomers = await firebaseGetActivityData(currentActivityId, 'customers') || [];
        console.log(`ğŸ‘¥ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseCustomers.length} Ø¹Ù…ÙŠÙ„ Ù…Ù† Firebase`);
        
        const firebaseSuppliers = await firebaseGetActivityData(currentActivityId, 'suppliers') || [];
        console.log(`ğŸª ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseSuppliers.length} Ù…ÙˆØ±Ø¯ Ù…Ù† Firebase`);
        
        const firebasePurchases = await firebaseGetActivityData(currentActivityId, 'purchases') || [];
        console.log(`ğŸ›’ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebasePurchases.length} Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ù† Firebase`);
        
        const firebaseSales = await firebaseGetActivityData(currentActivityId, 'sales') || [];
        console.log(`ğŸ’° ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseSales.length} Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† Firebase`);
        
        const firebaseExpenses = await firebaseGetActivityData(currentActivityId, 'expenses') || [];
        console.log(`ğŸ’¸ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseExpenses.length} Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù† Firebase`);
        
        const firebaseRevenues = await firebaseGetActivityData(currentActivityId, 'revenues') || [];
        console.log(`ğŸ’µ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseRevenues.length} Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…Ù† Firebase`);
        
        const firebaseSalaries = await firebaseGetActivityData(currentActivityId, 'salaries') || [];
        console.log(`ğŸ’¼ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseSalaries.length} Ø±Ø§ØªØ¨ Ù…Ù† Firebase`);
        
        const firebaseAssets = await firebaseGetActivityData(currentActivityId, 'assets') || [];
        console.log(`ğŸ¦ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseAssets.length} Ø£ØµÙ„ Ù…Ù† Firebase`);
        
        const firebaseSalesReturns = await firebaseGetActivityData(currentActivityId, 'salesReturns') || [];
        console.log(`â†©ï¸ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseSalesReturns.length} Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† Firebase`);
        
        const firebaseAdvances = await firebaseGetActivityData(currentActivityId, 'advances') || [];
        console.log(`ğŸ’³ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseAdvances.length} Ø¹Ù‡Ø¯Ø©/Ø³Ù„ÙØ© Ù…Ù† Firebase`);
        
        const firebasePurchaseReturns = await firebaseGetActivityData(currentActivityId, 'purchaseReturns') || [];
        console.log(`ğŸ”™ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebasePurchaseReturns.length} Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ù† Firebase`);
        
        const firebaseBranches = await firebaseGetActivityData(currentActivityId, 'branches') || [];
        console.log(`ğŸª ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseBranches.length} ÙØ±Ø¹ Ù…Ù† Firebase`);
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
        items = firebaseItems;
        customers = firebaseCustomers;
        suppliers = firebaseSuppliers;
        purchases = firebasePurchases;
        sales = firebaseSales;
        expenses = firebaseExpenses;
        revenues = firebaseRevenues;
        salaries = firebaseSalaries;
        assets = firebaseAssets;
        salesReturns = firebaseSalesReturns;
        advances = firebaseAdvances;
        branches = firebaseBranches;
        purchaseReturns = firebasePurchaseReturns;
        
        debugLog('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase');
    } else {
        debugLog('ğŸ“¦ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage...');
        
        items = (loadFromLocalStorage('items')) || [];
        customers = (loadFromLocalStorage('customers')) || [];
        suppliers = (loadFromLocalStorage('suppliers')) || [];
        purchases = (loadFromLocalStorage('purchases')) || [];
        sales = (loadFromLocalStorage('sales')) || [];
        expenses = (loadFromLocalStorage('expenses')) || [];
        revenues = (loadFromLocalStorage('revenues')) || [];
        salaries = (loadFromLocalStorage('salaries')) || [];
        assets = (loadFromLocalStorage('assets')) || [];
        salesReturns = (loadFromLocalStorage('salesReturns')) || [];
        advances = (loadFromLocalStorage('advances')) || [];
        purchaseReturns = (loadFromLocalStorage('purchaseReturns')) || [];
        branches = (loadFromLocalStorage('branches')) || []; // ğŸª ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹
    }

    currentPurchaseNumber = purchases.length > 0 ? Math.max(0, ...purchases.map(p => p.number)) + 1 : 1;
    currentSaleNumber = sales.length > 0 ? Math.max(0, ...sales.map(s => s.number)) + 1 : 1;
    currentSaleReturnNumber = salesReturns.length > 0 ? Math.max(0, ...salesReturns.map(r => r.number)) + 1 : 1;
    
    // ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
    if (typeof upgradeSalesData === 'function') {
        await upgradeSalesData();
    }
    currentPurchaseReturnNumber = purchaseReturns.length > 0 ? Math.max(0, ...purchaseReturns.map(r => r.number)) + 1 : 1;
    
    const today = new Date().toISOString().split('T')[0];
    ['purchaseDate', 'saleDate', 'expenseDate', 'revenueDate', 'reportFrom', 'reportTo'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = today;
    });
    
    const monthInput = document.getElementById('salaryMonth');
    if (monthInput) {
        if (!monthInput.value) {
            monthInput.value = new Date().toISOString().slice(0, 7);
        }
        monthInput.onchange = () => { if (typeof updateSalarySummary === 'function') updateSalarySummary(); };
    }
    
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¨Ø£Ù…Ø§Ù†
    const safeFunctions = [
        'generatePurchaseCode', 'generateSaleCode', 'updateDashboard', 'updateExpenseStats', 
        'updateRevenueStats', 'updateDataStats', 'renderItems', 'renderCustomers', 'renderSuppliers', 
        'renderExpenses', 'renderRevenues', 'renderSalaries', 'updateSalarySummary', 'displayAssets', 
        'updateAssetsStats', 'clearSalaryForm', 'renderSalesList', 'renderPurchasesList', 
        'renderSalesReturns', 'renderPurchaseReturns', 'updatePurchaseDropdowns', 'updateSaleDropdowns', 
        'updateReportItemFilter', 'loadTrashFromLocalStorage', 'updateTrashBadge'
    ];
    
    safeFunctions.forEach(funcName => {
        if (typeof window[funcName] === 'function') {
            try { window[funcName](); } catch (e) { console.warn(`ØªØ­Ø°ÙŠØ± ÙÙŠ ${funcName}:`, e.message); }
        }
    });
    
    // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¥Ø¶Ø§ÙÙŠ ÙÙˆØ±ÙŠ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
    if (typeof updateDashboard === 'function') {
        try {
            updateDashboard();
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù†Ø¬Ø§Ø­');
        } catch (e) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:', e);
        }
    }

    const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser') || 'null');
    if (typeof updateLoggedInUserDisplay === 'function' && loggedInUser) {
        updateLoggedInUserDisplay(loggedInUser);
    }
    
    // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø¯ÙŠÙˆÙ† ÙÙ‚Ø· Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ
    setTimeout(() => {
        if (typeof checkLowStock === 'function') checkLowStock();
        if (typeof checkUnpaidDebts === 'function') checkUnpaidDebts();
    }, 10000);
    
    // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„Ø£ØµÙˆÙ„
    const searchAssetsInput = document.getElementById('searchAssets');
    const filterAssetTypeSelect = document.getElementById('filterAssetType');
    const filterAssetStatusSelect = document.getElementById('filterAssetStatus');
    
    if (searchAssetsInput && typeof displayAssets === 'function') {
        searchAssetsInput.addEventListener('input', displayAssets);
    }
    if (filterAssetTypeSelect && typeof displayAssets === 'function') {
        filterAssetTypeSelect.addEventListener('change', displayAssets);
    }
    if (filterAssetStatusSelect && typeof displayAssets === 'function') {
        filterAssetStatusSelect.addEventListener('change', displayAssets);
    }
    
    // ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    setTimeout(() => {
        if (typeof initBackupReminderSystem === 'function') {
            initBackupReminderSystem();
        }
    }, 3000);
    
    const activity = activities.find(a => a.id == currentActivityId);
    console.log(`âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ù†Ø´Ø§Ø·: ${activity ? activity.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`);
    
    // ØªØ­Ù…ÙŠÙ„ ØªØ®ØµÙŠØµØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    if (typeof loadDesignPreferences === 'function') {
        loadDesignPreferences();
        console.log('ğŸ¨ ØªÙ… ØªØ­Ù…ÙŠÙ„ ØªØ®ØµÙŠØµØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ…');
    }
    
    console.log('ğŸ“Š ØªÙ… ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…');
    
    // ğŸ” ÙØ­Øµ Ø´Ø§Ù…Ù„ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase
    setTimeout(async () => {
        if (USE_FIREBASE && currentActivityId) {
            console.log('ğŸ” ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ù„Ù„Ù†Ø´Ø§Ø·:', currentActivityId);
            try {
                const { ref, get } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                // ÙØ­Øµ Ø¨Ù†ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase
                const activityRef = ref(db, `activities/${currentActivityId}`);
                const snapshot = await get(activityRef);
                
                if (snapshot.exists()) {
                    const activityData = snapshot.val();
                    console.log('ğŸ“Š Ø¨Ù†ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase:', Object.keys(activityData));
                    console.log('ğŸ” Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù…Ù† Firebase:', activityData);
                    
                    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ÙØµÙ„Ø©
                    Object.keys(activityData).forEach(dataType => {
                        const data = activityData[dataType];
                        console.log(`ğŸ” ÙØ­Øµ ${dataType}:`, data);
                        if (data && typeof data === 'object') {
                            const count = Array.isArray(data) ? data.length : Object.keys(data).length;
                            console.log(`ğŸ“Š Firebase ${dataType}: ${count} Ø¹Ù†ØµØ±`);
                        }
                    });
                } else {
                    console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ø´Ø§Ø· ÙÙŠ Firebase:', currentActivityId);
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Firebase:', error);
            }
        }
    }, 1000);
    
    // ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    setTimeout(() => {
        const dataStatus = {
            items: items?.length || 0,
            customers: customers?.length || 0,
            suppliers: suppliers?.length || 0,
            purchases: purchases?.length || 0,
            sales: sales?.length || 0,
            expenses: expenses?.length || 0,
            revenues: revenues?.length || 0,
            salaries: salaries?.length || 0,
            users: users?.length || 0,
            activities: activities?.length || 0,
            currentUser: !!window.currentUser,
            currentActivityId: currentActivityId || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
        };
        
        console.log('ğŸ“Š ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', dataStatus);
        
        const totalData = Object.values(dataStatus).reduce((sum, val) => 
            typeof val === 'number' ? sum + val : sum, 0);
        
        if (totalData === 0 && window.currentUser) {
            console.error('ğŸš¨ Ù…Ø´ÙƒÙ„Ø© Ø®Ø·ÙŠØ±Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª!');
            showNotification('ğŸš¨ ØªØ­Ø°ÙŠØ±', 'ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'warning');
        } else if (totalData > 0) {
            console.log(`âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù…Ù„Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (${totalData} Ø¹Ù†ØµØ±)`);
        }
        
        // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        if (typeof updateDashboard === 'function') {
            updateDashboard();
        }
    }, 2000);
    
    // ØªØ­Ù‚Ù‚ Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
    if (window.currentUser) {
        console.log('âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„:', window.currentUser.name);
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        const loginSection = document.getElementById('loginSection');
        const appContent = document.getElementById('appContent');
        if (loginSection && appContent) {
            loginSection.style.display = 'none';
            appContent.style.display = 'block';
        }
    } else {
        console.log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„');
    }
}

// ÙƒØ´Ù Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ø¹Ø§Ù„Ù…ÙŠØ© ÙÙˆØ±Ø§Ù‹
if (typeof window !== 'undefined') {
    window.initializeApp = initializeApp;
    debugLog('ğŸ¯ ØªÙ… ØªØ¹Ø±ÙŠÙ window.initializeApp Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù…ÙƒØ§Ù† Ù…Ø¨ÙƒØ±!');
}

console.log('ğŸ”¥ Firebase initialization completed, continuing...');

// ========================================
// ğŸ“§ Ø¯ÙˆØ§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (EmailJS)
// ========================================
function toggleEmailSettings() {
    console.log('ğŸ“§ ÙØªØ­ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ...');
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† emailJsConfig Ùˆ LocalStorage
    const savedConfig = localStorage.getItem('diwan_email_config');
    if (savedConfig) {
        try {
            const config = JSON.parse(savedConfig);
            Object.assign(emailJsConfig, config);
        } catch (error) {
            console.warn('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯:', error);
        }
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø£Ùˆ LocalStorage)
    const serviceId = emailJsConfig.serviceID || localStorage.getItem('emailjs_service_id') || '';
    const templateId = emailJsConfig.templateID || localStorage.getItem('emailjs_template_id') || '';
    const resetTemplateId = emailJsConfig.resetTemplateID || localStorage.getItem('emailjs_reset_template_id') || '';
    const publicKey = emailJsConfig.publicKey || localStorage.getItem('emailjs_public_key') || '';
    
    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById('emailJsServiceId').value = serviceId;
    document.getElementById('emailJsTemplateId').value = templateId;
    document.getElementById('emailJsResetTemplateId').value = resetTemplateId;
    document.getElementById('emailJsPublicKey').value = publicKey;
    
    // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
    const overlay = document.getElementById('email-settings-overlay');
    if (overlay) {
        overlay.style.display = 'flex';
        console.log('âœ… ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯');
    } else {
        console.error('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯');
        showNotification('âŒ Ø®Ø·Ø£', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯', 'error');
    }
}

function closeEmailSettingsModal() {
    const overlay = document.getElementById('email-settings-overlay');
    if (overlay) {
        overlay.style.display = 'none';
        console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯');
    }
}

async function saveEmailJsSettings() {
    console.log('ğŸ’¾ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ...');
    
    const serviceId = document.getElementById('emailJsServiceId').value.trim();
    const templateId = document.getElementById('emailJsTemplateId').value.trim();
    const resetTemplateId = document.getElementById('emailJsResetTemplateId').value.trim();
    const publicKey = document.getElementById('emailJsPublicKey').value.trim();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
    emailJsConfig = {
        serviceID: serviceId,
        templateID: templateId,
        resetTemplateID: resetTemplateId,
        publicKey: publicKey
    };
    
    // Ø­ÙØ¸ ÙÙŠ LocalStorage
    try {
        localStorage.setItem('diwan_email_config', JSON.stringify(emailJsConfig));
        
        // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù†ÙØµÙ„Ø© Ø£ÙŠØ¶Ø§Ù‹ Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
        localStorage.setItem('emailjs_service_id', serviceId);
        localStorage.setItem('emailjs_template_id', templateId);
        localStorage.setItem('emailjs_reset_template_id', resetTemplateId);
        localStorage.setItem('emailjs_public_key', publicKey);
        
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­');
        showNotification('âœ… Ù†Ø¬Ø­', 'ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        closeEmailSettingsModal();
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯:', error);
        showNotification('âŒ Ø®Ø·Ø£', 'ÙØ´Ù„ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'error');
    }
}

// ØªØ­Ù…ÙŠÙ„ Ù‚ÙŠÙ… EmailJS Ø¥Ù„Ù‰ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (ÙŠÙØ³ØªØ¯Ø¹Ù‰ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©)
function loadEmailJsSettings() {
    try {
        const serviceId = emailJsConfig.serviceID || localStorage.getItem('emailjs_service_id') || '';
        const templateId = emailJsConfig.templateID || localStorage.getItem('emailjs_template_id') || '';
        const resetTemplateId = emailJsConfig.resetTemplateID || localStorage.getItem('emailjs_reset_template_id') || '';
        const publicKey = emailJsConfig.publicKey || localStorage.getItem('emailjs_public_key') || '';

        const serviceEl = document.getElementById('emailJsServiceId');
        const templateEl = document.getElementById('emailJsTemplateId');
        const resetTplEl = document.getElementById('emailJsResetTemplateId');
        const publicKeyEl = document.getElementById('emailJsPublicKey');

        if (serviceEl) serviceEl.value = serviceId;
        if (templateEl) templateEl.value = templateId;
        if (resetTplEl) resetTplEl.value = resetTemplateId;
        if (publicKeyEl) publicKeyEl.value = publicKey;
    } catch (e) {
        console.warn('âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª EmailJS Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„:', e?.message || e);
    }
}

// Ø¥ØªØ§Ø­Ø© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
window.toggleEmailSettings = toggleEmailSettings;
window.closeEmailSettingsModal = closeEmailSettingsModal;
window.saveEmailJsSettings = saveEmailJsSettings;

// ========================================
// ğŸ”¥ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ (LocalStorage ÙÙ‚Ø· - Ù…Ø¹Ø·Ù„ ÙÙŠ Firebase)
// ========================================
async function createDefaultUser() {
    const existingUsers = loadFromLocalStorage('diwan_users') || [];
    
    // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ LocalStorage
    if (existingUsers.length === 0) {
        const defaultUser = {
            id: 'admin-001',
            name: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…',
            email: 'admin@diwani.com',
            password: '123456',
            phone: '+966500000000',
            role: 'admin',
            activityId: null,
            createdAt: new Date().toISOString()
        };
        
        existingUsers.push(defaultUser);
        saveToLocalStorage('diwan_users', existingUsers);
        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ LocalStorage: admin@diwani.com / 123456');
        
        // âš ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Ù…Ø¹Ø·Ù„ - Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø¯Ø§Ø© Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ
        console.log('â„¹ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Firebase Ù…Ø¹Ø·Ù„ - Ù‚Ù… Ø¨Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        
        /* // ÙƒÙˆØ¯ Ø¥Ù†Ø´Ø§Ø¡ Firebase Ù…Ø¹Ø·Ù„
        if (USE_FIREBASE) {
            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const { signInWithEmailAndPassword } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                try {
                    await signInWithEmailAndPassword(auth, defaultUser.email, defaultUser.password);
                    console.log('â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Firebase');
                } catch (signInError) {
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡
                    if (signInError.code === 'auth/user-not-found' || signInError.code === 'auth/invalid-credential') {
                        const firebaseUser = await firebaseCreateUser(
                            defaultUser.email,
                            defaultUser.password,
                            {
                                id: defaultUser.id,
                                name: defaultUser.name,
                                email: defaultUser.email,
                                phone: defaultUser.phone,
                                role: defaultUser.role,
                                activityId: defaultUser.activityId
                            }
                        );
                        
                        if (firebaseUser) {
                            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Firebase');
                        }
                    }
                }
            } catch (error) {
                console.log('â„¹ï¸ ØªØ®Ø·ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase:', error.message);
            }
        }
        */ // Ù†Ù‡Ø§ÙŠØ© ÙƒÙˆØ¯ Firebase Ø§Ù„Ù…Ø¹Ø·Ù„
    }
}

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª =====
let notifications = [];
let trashBin = {
    items: [],
    customers: [],
    suppliers: [],
    purchases: [],
    sales: [],
    expenses: [],
    revenues: [],
    salaries: [],
    advances: []
};
const LOW_STOCK_THRESHOLD = 5; // Ø­Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†

// ===== ØªÙƒÙˆÙŠÙ† EmailJS Ø§Ù„Ø«Ø§Ø¨Øª (Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø£Ø¯Ù†Ø§Ù‡ Ø«Ù… ÙØ¹Ù‘Ù„ Ø§Ù„Ø¹Ù„Ù… EMAILJS_FIXED) =====
const EMAILJS_FIXED = false; // true = Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø© Ø£Ø¯Ù†Ø§Ù‡ ÙˆØ¹Ø¯Ù… Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯

const EMAILJS_DEFAULTS = {
    serviceID: 'service_hu6ucxi',
    templateID: 'VH3waGBnucCE-S4eeM0I4', // Ù‚Ø§Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
    resetTemplateID: 'template_aqp69jt', // Ù‚Ø§Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    publicKey: '-FKicwCTdzG90IoY6'
};
let emailJsConfig = { ...EMAILJS_DEFAULTS };

// ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
function loadSavedEmailSettings() {
    try {
        const savedConfig = localStorage.getItem('diwan_email_config');
        if (savedConfig) {
            const config = JSON.parse(savedConfig);
            Object.assign(emailJsConfig, config);
            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©');
        }
    } catch (error) {
        console.warn('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯:', error);
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙˆØ±Ø§Ù‹
loadSavedEmailSettings();
    // ===== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ´ÙÙŠØ± Ù„Ù„Ø£Ù…Ø§Ù† =====
    async function hashPassword(password) {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… SHA-256 Ù„ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        const msgBuffer = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    }

    async function verifyPassword(inputPassword, hashedPassword) {
        const inputHash = await hashPassword(inputPassword);
        return inputHash === hashedPassword;
    }

    // ===== Ù†Ø¸Ø§Ù… Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ =====
    function showLoading(message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
        let loader = document.getElementById('global-loader');
        if (!loader) {
            loader = document.createElement('div');
            loader.id = 'global-loader';
            loader.innerHTML = `
                <div class="loader-overlay">
                    <div class="loader-content">
                        <div class="spinner"></div>
                        <p class="loader-message">${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loader);
        } else {
            loader.querySelector('.loader-message').textContent = message;
            loader.style.display = 'block';
        }
    }

    function hideLoading() {
        const loader = document.getElementById('global-loader');
        if (loader) {
            loader.style.display = 'none';
        }
    }

    function updateLoadingMessage(message) {
        const loader = document.getElementById('global-loader');
        if (loader) {
            loader.querySelector('.loader-message').textContent = message;
        }
    }

    // ===== Ù†Ø¸Ø§Ù… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… =====
    function logError(context, error, showToUser = true) {
        const timestamp = new Date().toISOString();
        const errorLog = {
            timestamp,
            context,
            error: error.message || error,
            stack: error.stack || 'No stack trace'
        };
        
        console.error('ğŸ”´ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…:', errorLog);
        
        // Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ localStorage Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
        try {
            let errorLogs = JSON.parse(localStorage.getItem('systemErrors') || '[]');
            errorLogs.push(errorLog);
            // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 50 Ø®Ø·Ø£ ÙÙ‚Ø·
            if (errorLogs.length > 50) errorLogs = errorLogs.slice(-50);
            localStorage.setItem('systemErrors', JSON.stringify(errorLogs));
        } catch (e) {
            console.error('ÙØ´Ù„ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:', e);
        }
        
        if (showToUser) {
            showNotification(
                'âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…',
                `${error.message || error}\n\nÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.`,
                'error',
                8000
            );
        }
    }

    async function safeAsyncOperation(operation, context, loadingMessage = null) {
        try {
            if (loadingMessage) showLoading(loadingMessage);
            const result = await operation();
            return { success: true, data: result };
        } catch (error) {
            logError(context, error);
            return { success: false, error: error.message || error };
        } finally {
            if (loadingMessage) hideLoading();
        }
    }

    // ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =====
    function showNotification(title, message, type = 'info', duration = 5000) {
        const container = document.getElementById('notifications-container') || createNotificationContainer();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø·Ø§Ø¨Ù‚ Ù…Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹
        const existingNotifications = container.querySelectorAll('.notification');
        for (let existingNotif of existingNotifications) {
            const existingTitle = existingNotif.querySelector('.notification-title')?.textContent;
            const existingMessage = existingNotif.querySelector('.notification-message')?.textContent;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø·Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ø§Ù‹ØŒ Ù„Ø§ Ù†Ø¶ÙŠÙ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯
            if (existingTitle === title && existingMessage === message && existingNotif.classList.contains(type)) {
                // Ù†Ø¹ÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                return existingNotif;
            }
        }
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const icons = {
            success: 'âœ…',
            warning: 'âš ï¸',
            error: 'âŒ',
            info: 'â„¹ï¸'
        };
        
        notification.innerHTML = `
            <div class="notification-icon">${icons[type]}</div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <div class="notification-close" onclick="closeNotification(this)">âœ–</div>
        `;
        
        container.appendChild(notification);
        
        // Ø¥Ø²Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        setTimeout(() => {
            if (notification.parentElement) {
                closeNotification(notification.querySelector('.notification-close'));
            }
        }, duration);
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        notifications.push({
            id: Date.now(),
            title,
            message,
            type,
            timestamp: new Date().toISOString()
        });
        
        return notification;
    }

    function createNotificationContainer() {
        const container = document.createElement('div');
        container.id = 'notifications-container';
        document.body.appendChild(container);
        return container;
    }

    function closeNotification(closeButton) {
        const notification = closeButton.closest('.notification');
        notification.classList.add('removing');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }

    // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„Ø¨ØµØ±ÙŠØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ =====
    
    /**
     * ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø± Ø¹Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
     * @param {string} formSelector - Ù…Ø­Ø¯Ø¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ù…Ø«Ù„: '#itemForm')
     * @param {string} firstFieldId - Ù…Ø¹Ø±Ù Ø£ÙˆÙ„ Ø­Ù‚Ù„ Ù„Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„ÙŠÙ‡
     * @param {string} titleSelector - Ù…Ø­Ø¯Ø¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
     * @param {string} titleText - Ù†Øµ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
     */
    function applyEditMode(formSelector, firstFieldId, titleSelector = null, titleText = null) {
        const form = document.querySelector(formSelector);
        if (!form) return;
        
        // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ù„Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø± Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
        const formInputs = form.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            input.classList.add('editing-mode');
            // Ø¥Ø²Ø§Ù„Ø© readonly Ùˆ disabled Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
            input.removeAttribute('readonly');
            input.removeAttribute('disabled');
            input.disabled = false;
            input.readOnly = false;
        });
        
        // ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¥Ù† ÙˆØ¬Ø¯
        if (titleSelector && titleText) {
            const titleElement = document.querySelector(titleSelector);
            if (titleElement) {
                titleElement.innerHTML = titleText;
                titleElement.style.color = '#28a745';
            }
        }
        
        // ØªØºÙŠÙŠØ± Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
        const submitBtn = form.querySelector('.btn-primary');
        if (submitBtn && !submitBtn.innerHTML.includes('ØªØ­Ø¯ÙŠØ«')) {
            submitBtn.setAttribute('data-original-text', submitBtn.innerHTML);
            submitBtn.innerHTML = 'ğŸ”„ ØªØ­Ø¯ÙŠØ«';
            submitBtn.classList.add('update-mode');
        }
        
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
        form.scrollIntoView({ behavior: 'smooth' });
        
        // Ù†Ù‚Ù„ Ø§Ù„Ù…Ø¤Ø´Ø± Ù„Ù„Ø­Ù‚Ù„ Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
        setTimeout(() => {
            const firstField = document.getElementById(firstFieldId);
            if (firstField) {
                firstField.focus();
                if (firstField.type === 'text' || firstField.tagName === 'TEXTAREA') {
                    firstField.select();
                }
            }
        }, 500);
    }
    
    /**
     * Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
     * @param {string} formSelector - Ù…Ø­Ø¯Ø¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
     * @param {string} titleSelector - Ù…Ø­Ø¯Ø¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
     * @param {string} originalTitleText - Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
     */
    function removeEditMode(formSelector, titleSelector = null, originalTitleText = null) {
        const form = document.querySelector(formSelector);
        if (!form) return;
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
        const formInputs = form.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            input.classList.remove('editing-mode');
        });
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£ØµÙ„ÙŠ
        if (titleSelector && originalTitleText) {
            const titleElement = document.querySelector(titleSelector);
            if (titleElement) {
                titleElement.innerHTML = originalTitleText;
                titleElement.style.color = '';
            }
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„ÙŠ
        const submitBtn = form.querySelector('.btn-primary');
        if (submitBtn) {
            const originalText = submitBtn.getAttribute('data-original-text');
            if (originalText) {
                submitBtn.innerHTML = originalText;
                submitBtn.removeAttribute('data-original-text');
            }
            submitBtn.classList.remove('update-mode');
        }
    }
    
    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙ‚Ø·
     * @returns {Promise<boolean>} - true Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„ØŒ false Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡
     */
    async function confirmCancelItemEdit() {
        const form = document.querySelector('#items');
        if (!form) return true;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ù‚ÙˆÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙ‚Ø·
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            const confirmed = await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ†Ø§ÙØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            return confirmed;
        }
        return true;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙ‚Ø·
     * @returns {Promise<boolean>} - true Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„ØŒ false Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡
     */
    async function confirmCancelCustomerEdit() {
        const form = document.querySelector('#customers');
        if (!form) return true;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ù‚ÙˆÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙ‚Ø·
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            const confirmed = await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            return confirmed;
        }
        return true;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙÙ‚Ø·
     */
    async function confirmCancelSupplierEdit() {
        const form = document.querySelector('#suppliers');
        if (!form) return true;
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            return await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†ØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
        }
        return true;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙÙ‚Ø·
     */
    async function confirmCancelExpenseEdit() {
        const form = document.querySelector('#expenses');
        if (!form) return true;
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            return await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§ØªØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
        }
        return true;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙÙ‚Ø·
     */
    async function confirmCancelRevenueEdit() {
        const form = document.querySelector('#revenues');
        if (!form) return true;
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            return await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§ØªØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
        }
        return true;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙÙ‚Ø·
     */
    async function confirmCancelSalaryEdit() {
        const form = document.querySelector('#salaries');
        if (!form) return true;
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            return await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨ØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
        }
        return true;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø£ØµÙˆÙ„ ÙÙ‚Ø·
     */
    async function confirmCancelAssetEdit() {
        const form = document.querySelector('#assets');
        if (!form) return true;
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            return await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø£ØµÙˆÙ„ØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
        }
        return true;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù ÙÙ‚Ø·
     */
    async function confirmCancelAdvanceEdit() {
        const form = document.querySelector('#advances');
        if (!form) return true;
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            return await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„ÙØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
        }
        return true;
    }

    function checkLowStock() {
        const lowStockItems = items.filter(item => item.stock <= LOW_STOCK_THRESHOLD && item.stock > 0);
        const outOfStockItems = items.filter(item => item.stock <= 0);
        
        if (outOfStockItems.length > 0) {
            showNotification(
                'ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡: Ø£ØµÙ†Ø§Ù Ù†ÙØ°Øª',
                `${outOfStockItems.length} ØµÙ†Ù Ù†ÙØ° Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ²ÙˆÙŠØ¯ ÙÙˆØ±Ø§Ù‹.`,
                'error',
                8000
            );
        }
        
        if (lowStockItems.length > 0) {
            showNotification(
                'âš ï¸ ØªØ­Ø°ÙŠØ±: Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶',
                `${lowStockItems.length} ØµÙ†Ù Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ù†ÙØ§Ø¯ (Ø£Ù‚Ù„ Ù…Ù† ${LOW_STOCK_THRESHOLD} ÙˆØ­Ø¯Ø§Øª).`,
                'warning',
                7000
            );
        }
    }

    function checkUnpaidDebts() {
        const unpaidSales = sales.filter(s => s.remainingAmount > 0);
        const totalDebt = unpaidSales.reduce((sum, s) => sum + s.remainingAmount, 0);
        
        if (unpaidSales.length > 0) {
            showNotification(
                'ğŸ’° ØªØ°ÙƒÙŠØ±: Ø¯ÙŠÙˆÙ† ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©',
                `Ù„Ø¯ÙŠÙƒ ${unpaidSales.length} ÙØ§ØªÙˆØ±Ø© Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${totalDebt.toFixed(2)} Ø±.Ø³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©.`,
                'warning',
                6000
            );
        }
    }

    // ===== Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª =====
    function moveToTrash(type, item) {
        if (!trashBin[type]) trashBin[type] = [];
        
        const trashItem = {
            ...item,
            deletedAt: new Date().toISOString(),
            deletedBy: JSON.parse(sessionStorage.getItem('loggedInUser'))?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
            type: type
        };
        
        trashBin[type].push(trashItem);
        saveTrashToLocalStorage();
        
        showNotification(
            'ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
            `ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…Ø§Ù‹.`,
            'info',
            4000
        );
        
        // ØªØ­Ø¯ÙŠØ« Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
        refreshTrashModalIfOpen(type);
        
        return true;
    }

    function restoreFromTrash(type, itemId) {
        const itemIndex = trashBin[type].findIndex(item => item.id === itemId);
        if (itemIndex === -1) return false;
        
        const item = trashBin[type][itemIndex];
        trashBin[type].splice(itemIndex, 1);
        
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        const { deletedAt, deletedBy, type: itemType, ...originalItem } = item;
        
        switch(type) {
            case 'items': items.push(originalItem); break;
            case 'customers': customers.push(originalItem); break;
            case 'suppliers': suppliers.push(originalItem); break;
            case 'purchases': purchases.push(originalItem); break;
            case 'sales': sales.push(originalItem); break;
            case 'expenses': expenses.push(originalItem); break;
            case 'revenues': revenues.push(originalItem); break;
            case 'salaries': salaries.push(originalItem); break;
        }
        
        saveTrashToLocalStorage();
        showNotification(
            'âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
            'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­.',
            'success'
        );
        
        // ØªØ­Ø¯ÙŠØ« Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
        refreshTrashModalIfOpen(type);
        
        return true;
    }

    async function permanentlyDelete(type, itemId) {
        const confirmed = await showConfirmDialog({
            title: 'âš ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ',
            message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ\nâŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!',
            type: 'danger',
            confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
            cancelText: 'Ø¥Ù„ØºØ§Ø¡',
            icon: 'ğŸš«'
        });
        
        if (!confirmed) {
            return false;
        }
        
        const itemIndex = trashBin[type].findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            trashBin[type].splice(itemIndex, 1);
            saveTrashToLocalStorage();
            showNotification(
                'ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
                'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ.',
                'info'
            );
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
            refreshTrashModalIfOpen(type);
            
            return true;
        }
        return false;
    }

    function saveTrashToLocalStorage() {
        const key = currentActivityId ? `trash_${currentActivityId}` : 'trash_global';
        localStorage.setItem(key, JSON.stringify(trashBin));
    }

    function loadTrashFromLocalStorage() {
        const key = currentActivityId ? `trash_${currentActivityId}` : 'trash_global';
        const saved = localStorage.getItem(key);
        if (saved) {
            trashBin = JSON.parse(saved);
            cleanOldTrashItems();
        }
    }

    function cleanOldTrashItems() {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        Object.keys(trashBin).forEach(type => {
            trashBin[type] = trashBin[type].filter(item => {
                const deletedDate = new Date(item.deletedAt);
                return deletedDate > thirtyDaysAgo;
            });
        });
        
        saveTrashToLocalStorage();
    }

    function getTrashCount() {
        let count = 0;
        Object.keys(trashBin).forEach(type => {
            count += (trashBin[type] || []).length;
        });
        return count;
    }

    function refreshTrashModalIfOpen(type) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ù…ÙØªÙˆØ­Ø©
        const trashModal = document.getElementById('trash-modal');
        if (trashModal && trashModal.classList.contains('active')) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
            updateTrashBadge();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù„Ù„Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
            // Ù†Ø¬Ø¯ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø·
            const activeTab = document.querySelector('.trash-tab.active');
            if (activeTab) {
                // Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† onclick attribute
                const onclickAttr = activeTab.getAttribute('onclick');
                const match = onclickAttr.match(/renderTrashItems\('([^']+)'\)/);
                if (match) {
                    const currentType = match[1];
                    renderTrashItems(currentType);
                }
            }
        }
    }

    function showTrashModal() {
        loadTrashFromLocalStorage();
        document.getElementById('trash-modal').classList.add('active');
        renderTrashItems('items');
    }

    function closeTrashModal() {
        document.getElementById('trash-modal').classList.remove('active');
    }

    function renderTrashItems(type) {
        const container = document.getElementById('trash-items-container');
        const items = trashBin[type] || [];
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø´Ø·Ø©
        document.querySelectorAll('.trash-tab').forEach(tab => tab.classList.remove('active'));
        event?.target?.classList.add('active');
        
        if (items.length === 0) {
            container.innerHTML = `
                <div class="trash-empty-state">
                    <i>ğŸ—‘ï¸</i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = items.map(item => {
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹Ù‡
            let displayName = item.name || item.code || 'Ø¹Ù†ØµØ±';
            if (type === 'purchases' || type === 'sales' || type === 'salesReturns' || type === 'purchaseReturns') {
                displayName = `ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… ${item.id} - ${item.date || ''}`;
            }
            
            return `
                <div class="trash-item">
                    <div class="trash-item-info">
                        <div class="trash-item-name">${displayName}</div>
                        <div class="trash-item-meta">
                            Ø­Ø°Ù Ø¨ÙˆØ§Ø³Ø·Ø©: ${item.deletedBy} | 
                            ${formatDate(item.deletedAt)}
                        </div>
                    </div>
                    <div class="trash-item-actions">
                        <button class="btn-success btn-sm" onclick="restoreItem('${type}', ${item.id})">
                            â†º Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                        </button>
                        <button class="btn-danger btn-sm" onclick="deleteItemPermanently('${type}', ${item.id})">
                            ğŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function restoreItem(type, itemId) {
        if (restoreFromTrash(type, itemId)) {
            // Ø®Ø±ÙŠØ·Ø© Ø¢Ù…Ù†Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† eval()
            const dataMap = {
                'items': items,
                'customers': customers,
                'suppliers': suppliers,
                'purchases': purchases,
                'sales': sales,
                'expenses': expenses,
                'revenues': revenues,
                'salesReturns': salesReturns,
                'purchaseReturns': purchaseReturns
            };
            
            saveToLocalStorage(type, dataMap[type]);
            renderTrashItems(type);
            updateDashboard();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            switch(type) {
                case 'items': renderItems(); break;
                case 'customers': renderCustomers(); break;
                case 'suppliers': renderSuppliers(); break;
                case 'purchases': renderPurchasesList(); break;
                case 'sales': renderSalesList(); break;
                case 'expenses': renderExpenses(); break;
                case 'revenues': renderRevenues(); break;
                case 'salesReturns': renderSalesReturns(); break;
                case 'purchaseReturns': renderPurchaseReturns(); break;
            }
            
            showNotification('âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', `ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© ${getTypeNameAr(type)} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        }
    }

    function deleteItemPermanently(type, itemId) {
        if (permanentlyDelete(type, itemId)) {
            renderTrashItems(type);
        }
    }

    function emptyTrash(type) {
        if (!confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙØ±Ø§Øº Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ù„Ù€ ${getTypeNameAr(type)}ØŸ`)) {
            return;
        }
        
        trashBin[type] = [];
        saveTrashToLocalStorage();
        renderTrashItems(type);
        showNotification(
            'ğŸ—‘ï¸ ØªÙ… Ø¥ÙØ±Ø§Øº Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
            `ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± ${getTypeNameAr(type)} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`,
            'success'
        );
    }

    function getTypeNameAr(type) {
        const names = {
            items: 'Ø§Ù„Ø£ØµÙ†Ø§Ù',
            customers: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',
            suppliers: 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†',
            purchases: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
            sales: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
            expenses: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
            revenues: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',
            salesReturns: 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
            purchaseReturns: 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
            salaries: 'Ø§Ù„Ø±ÙˆØ§ØªØ¨'
        };
        return names[type] || type;
    }

    function updateTrashBadge() {
        const totalCount = getTrashCount();
        const badge = document.getElementById('trash-count-badge');
        
        if (badge) {
            if (totalCount > 0) {
                badge.textContent = totalCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
        ['items', 'customers', 'suppliers', 'purchases', 'sales', 'expenses', 'revenues', 'salesReturns', 'purchaseReturns'].forEach(type => {
            const el = document.getElementById(`trash-count-${type}`);
            if (el) el.textContent = (trashBin[type] || []).length;
        });
        
        const totalEl = document.getElementById('trash-count-total');
        if (totalEl) totalEl.textContent = totalCount;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return 'Ø§Ù„ÙŠÙˆÙ…';
        if (diffDays === 1) return 'Ø£Ù…Ø³';
        if (diffDays < 7) return `Ù…Ù†Ø° ${diffDays} Ø£ÙŠØ§Ù…`;
        if (diffDays < 30) return `Ù…Ù†Ø° ${Math.floor(diffDays / 7)} Ø£Ø³Ø§Ø¨ÙŠØ¹`;
        return date.toLocaleDateString('ar-SA');
    }

    // ===== Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… =====
    
    /**
     * Ù†Ø¸Ø§Ù… Ø´Ø§Ù…Ù„ Ù„ÙÙ„ØªØ±Ø© ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
     */
    const FilterSortHelper = {
        // Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ÙƒÙ„ Ù‚Ø³Ù…
        currentFilters: {},
        
        // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ÙƒÙ„ Ù‚Ø³Ù…
        currentSort: {},
        
        /**
         * ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
         * @param {Array} data - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ÙÙ„ØªØ±ØªÙ‡Ø§
         * @param {Object} filters - Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ±Ø©
         * @returns {Array} - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
         */
        applyFilters(data, filters) {
            if (!data || !Array.isArray(data)) return [];
            
            return data.filter(item => {
                // ÙÙ„ØªØ±Ø© Ø§Ù„Ù†Øµ (Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…)
                if (filters.searchText) {
                    const searchLower = filters.searchText.toLowerCase();
                    const matchFound = Object.values(item).some(value => 
                        value && value.toString().toLowerCase().includes(searchLower)
                    );
                    if (!matchFound) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…Ù†)
                if (filters.dateFrom && item.date) {
                    if (new Date(item.date) < new Date(filters.dateFrom)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø¥Ù„Ù‰)
                if (filters.dateTo && item.date) {
                    if (new Date(item.date) > new Date(filters.dateTo)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø± (Ù…Ù†)
                if (filters.priceFrom !== undefined && filters.priceFrom !== '' && item.price !== undefined) {
                    if (parseFloat(item.price) < parseFloat(filters.priceFrom)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø± (Ø¥Ù„Ù‰)
                if (filters.priceTo !== undefined && filters.priceTo !== '' && item.price !== undefined) {
                    if (parseFloat(item.price) > parseFloat(filters.priceTo)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº (Ù…Ù†)
                if (filters.amountFrom !== undefined && filters.amountFrom !== '' && item.total !== undefined) {
                    if (parseFloat(item.total) < parseFloat(filters.amountFrom)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº (Ø¥Ù„Ù‰)
                if (filters.amountTo !== undefined && filters.amountTo !== '' && item.total !== undefined) {
                    if (parseFloat(item.total) > parseFloat(filters.amountTo)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© (Ù…Ù†)
                if (filters.quantityFrom !== undefined && filters.quantityFrom !== '' && item.quantity !== undefined) {
                    if (parseFloat(item.quantity) < parseFloat(filters.quantityFrom)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© (Ø¥Ù„Ù‰)
                if (filters.quantityTo !== undefined && filters.quantityTo !== '' && item.quantity !== undefined) {
                    if (parseFloat(item.quantity) > parseFloat(filters.quantityTo)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©/Ø§Ù„Ù†ÙˆØ¹
                if (filters.status && item.status) {
                    if (item.status !== filters.status) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
                if (filters.category && item.category) {
                    if (item.category !== filters.category) return false;
                }
                
                return true;
            });
        },
        
        /**
         * ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø¹Ù…ÙˆØ¯ Ù…Ø¹ÙŠÙ†
         * @param {Array} data - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ±ØªÙŠØ¨Ù‡Ø§
         * @param {String} column - Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯
         * @param {String} direction - Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªØ±ØªÙŠØ¨ (asc/desc)
         * @returns {Array} - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø©
         */
        sortData(data, column, direction = 'asc') {
            if (!data || !Array.isArray(data)) return [];
            
            const sortedData = [...data].sort((a, b) => {
                let valueA = a[column];
                let valueB = b[column];
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ§Ø±ØºØ©
                if (valueA === null || valueA === undefined) valueA = '';
                if (valueB === null || valueB === undefined) valueB = '';
                
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
                if (!isNaN(valueA) && !isNaN(valueB)) {
                    valueA = parseFloat(valueA);
                    valueB = parseFloat(valueB);
                }
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
                else if (this.isDate(valueA) && this.isDate(valueB)) {
                    valueA = new Date(valueA);
                    valueB = new Date(valueB);
                }
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†ØµÙˆØµ
                else {
                    valueA = valueA.toString().toLowerCase();
                    valueB = valueB.toString().toLowerCase();
                }
                
                if (valueA < valueB) return direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            return sortedData;
        },
        
        /**
         * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© ØªØ§Ø±ÙŠØ®
         */
        isDate(value) {
            return value && !isNaN(Date.parse(value)) && /\d{4}-\d{2}-\d{2}/.test(value);
        },
        
        /**
         * Ø¥Ø¶Ø§ÙØ© Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ±ØªÙŠØ¨ Ù„Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
         * @param {String} tableId - Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„
         * @param {String} section - Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…
         * @param {Function} renderCallback - Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
         */
        makeSortable(tableId, section, renderCallback) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const headers = table.querySelectorAll('thead th.sortable');
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-column');
                    if (!column) return;
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªØ±ØªÙŠØ¨
                    let direction = 'asc';
                    if (this.currentSort[section]?.column === column) {
                        direction = this.currentSort[section].direction === 'asc' ? 'desc' : 'asc';
                    }
                    
                    // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±ØªÙŠØ¨
                    this.currentSort[section] = { column, direction };
                    
                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                    headers.forEach(h => {
                        h.classList.remove('asc', 'desc');
                    });
                    header.classList.add(direction);
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
                    if (renderCallback) renderCallback();
                });
            });
        },
        
        /**
         * Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø©
         */
        toggleFilters(filterId) {
            const filtersContainer = document.getElementById(filterId);
            if (filtersContainer) {
                filtersContainer.classList.toggle('show');
            }
        },
        
        /**
         * Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±
         */
        resetFilters(section, filterId) {
            this.currentFilters[section] = {};
            const filtersContainer = document.getElementById(filterId);
            if (filtersContainer) {
                const inputs = filtersContainer.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            }
        }
    };
    
    // ===== Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Input Validation) =====
    
    /**
     * Ù…Ø¬Ù…ÙˆØ¹Ø© Ø´Ø§Ù…Ù„Ø© Ù…Ù† Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
     */
    const ValidationHelper = {
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø­Ù‚Ù„ Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹
        required(value, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            if (!value || value.toString().trim() === '') {
                return `âŒ ${fieldName} Ù…Ø·Ù„ÙˆØ¨ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø·ÙˆÙ„
        minLength(value, min, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            if (value && value.toString().trim().length < min) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${min} Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·ÙˆÙ„
        maxLength(value, max, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            if (value && value.toString().length > max) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² ${max} Ø­Ø±ÙØ§Ù‹`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø±Ù‚Ù… ØµØ­ÙŠØ­
        isNumber(value, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            if (value !== '' && isNaN(parseFloat(value))) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨
        isPositive(value, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            const num = parseFloat(value);
            if (!isNaN(num) && num < 0) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹ Ù…ÙˆØ¬Ø¨Ø§Ù‹`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù‚Ù… Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±
        isGreaterThanZero(value, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            const num = parseFloat(value);
            if (!isNaN(num) && num <= 0) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù‚Ù… Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ Ù…Ø¹ÙŠÙ†
        inRange(value, min, max, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            const num = parseFloat(value);
            if (!isNaN(num) && (num < min || num > max)) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† ${min} Ùˆ ${max}`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        isEmail(value, fieldName = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') {
            if (value && value.trim() !== '') {
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailPattern.test(value)) {
                    return `âŒ ${fieldName} ØºÙŠØ± ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„: user@example.com)`;
                }
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ
        isSaudiPhone(value, fieldName = 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') {
            if (value && value.trim() !== '') {
                const phonePattern = /^(05|5)[0-9]{8}$/;
                if (!phonePattern.test(value.replace(/\s/g, ''))) {
                    return `âŒ ${fieldName} ØºÙŠØ± ØµØ­ÙŠØ­ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù…)`;
                }
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø©
        isUnique(value, list, field, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„', excludeId = null) {
            if (value && value.trim() !== '') {
                const exists = list.some(item => {
                    const isDifferentItem = excludeId ? item.id !== excludeId : true;
                    return isDifferentItem && item[field] && 
                           item[field].toString().toLowerCase() === value.toString().toLowerCase();
                });
                
                if (exists) {
                    return `âŒ ${fieldName} Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ…Ø© Ù…Ø®ØªÙ„ÙØ©`;
                }
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
        isValidDate(value, fieldName = 'Ø§Ù„ØªØ§Ø±ÙŠØ®') {
            if (value && value.trim() !== '') {
                const date = new Date(value);
                if (isNaN(date.getTime())) {
                    return `âŒ ${fieldName} ØºÙŠØ± ØµØ­ÙŠØ­`;
                }
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ÙŠØ³ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
        notFutureDate(value, fieldName = 'Ø§Ù„ØªØ§Ø±ÙŠØ®') {
            if (value && value.trim() !== '') {
                const date = new Date(value);
                const today = new Date();
                today.setHours(23, 59, 59, 999);
                
                if (date > today) {
                    return `âŒ ${fieldName} Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„`;
                }
            }
            return null;
        }
    };
    
    /**
     * Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ù†Ù…ÙˆØ°Ø¬
     * @param {Object} validations - ÙƒØ§Ø¦Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚
     * @returns {Object} - { isValid: boolean, errors: Array }
     */
    function validateForm(validations) {
        const errors = [];
        
        for (const [fieldId, rules] of Object.entries(validations)) {
            const element = document.getElementById(fieldId);
            if (!element) continue;
            
            const value = element.value;
            let hasError = false;
            
            // ØªØ·Ø¨ÙŠÙ‚ ÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© ØªØ­Ù‚Ù‚
            for (const rule of rules) {
                const error = rule.validator(value);
                if (error) {
                    errors.push({
                        fieldId,
                        element,
                        message: error
                    });
                    hasError = true;
                    break; // Ø¥ÙŠÙ‚Ø§Ù Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø®Ø·Ø£ Ù„ÙƒÙ„ Ø­Ù‚Ù„
                }
            }
            
            // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
            if (hasError) {
                element.classList.add('input-error');
                element.classList.remove('input-success');
            } else if (value && value.trim() !== '') {
                element.classList.add('input-success');
                element.classList.remove('input-error');
            } else {
                element.classList.remove('input-error', 'input-success');
            }
        }
        
        return {
            isValid: errors.length === 0,
            errors
        };
    }
    
    /**
     * Ø¹Ø±Ø¶ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
     */
    function displayValidationErrors(errors) {
        if (errors.length === 0) return;
        
        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø­Ù‚Ù„ Ø®Ø§Ø·Ø¦
        if (errors[0].element) {
            errors[0].element.focus();
            errors[0].element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø¥Ø´Ø¹Ø§Ø±
        const errorMessages = errors.map(e => e.message).join('\n');
        showNotification(
            'âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ§Ù„ÙŠØ©',
            errorMessages,
            'error',
            6000
        );
    }
    
    /**
     * Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
     */
    function clearValidationStyles() {
        document.querySelectorAll('.input-error, .input-success').forEach(el => {
            el.classList.remove('input-error', 'input-success');
        });
    }

    // ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Professional Confirm Dialog) =====
    
    /**
     * Ø¹Ø±Ø¶ Ø­ÙˆØ§Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ø­ØªØ±Ø§ÙÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† confirm() Ø§Ù„Ø¹Ø§Ø¯ÙŠ
     * @param {Object} options - Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­ÙˆØ§Ø±
     * @param {string} options.title - Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­ÙˆØ§Ø±
     * @param {string} options.message - Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
     * @param {string} options.type - Ù†ÙˆØ¹ Ø§Ù„Ø­ÙˆØ§Ø± (warning, danger, info, success)
     * @param {string} options.confirmText - Ù†Øµ Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
     * @param {string} options.cancelText - Ù†Øµ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
     * @param {string} options.icon - Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­ÙˆØ§Ø±
     * @returns {Promise<boolean>} - true Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ØŒ false Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡
     */
    function showConfirmDialog(options = {}) {
        return new Promise((resolve) => {
            const {
                title = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',
                message = 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ',
                type = 'warning', // warning, danger, info, success
                confirmText = 'ØªØ£ÙƒÙŠØ¯',
                cancelText = 'Ø¥Ù„ØºØ§Ø¡',
                icon = null,
                confirmButtonClass = '' // Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
            } = options;
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø­ÙˆØ§Ø±
            const overlay = document.getElementById('confirm-overlay');
            const header = document.getElementById('confirm-header');
            const iconEl = document.getElementById('confirm-icon');
            const titleEl = document.getElementById('confirm-title');
            const bodyEl = document.getElementById('confirm-body');
            const confirmBtn = document.getElementById('confirm-btn-confirm');
            const cancelBtn = document.getElementById('confirm-btn-cancel');
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            const icons = {
                warning: 'âš ï¸',
                danger: 'âŒ',
                info: 'â„¹ï¸',
                success: 'âœ…'
            };
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            iconEl.textContent = icon || icons[type] || 'âš ï¸';
            titleEl.textContent = title;
            bodyEl.textContent = message;
            confirmBtn.textContent = confirmText;
            cancelBtn.textContent = cancelText;
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙØ¦Ø§Øª - Ø§Ø³ØªØ®Ø¯Ø§Ù… confirmButtonClass Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            header.className = `confirm-header ${type}`;
            const buttonClass = confirmButtonClass || (type === 'danger' ? 'danger' : type === 'success' ? 'success' : '');
            confirmBtn.className = `confirm-btn-confirm ${buttonClass}`;
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø­ÙˆØ§Ø±
            overlay.classList.add('active');
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            const handleConfirm = () => {
                overlay.classList.remove('active');
                cleanup();
                resolve(true);
            };
            
            const handleCancel = () => {
                overlay.classList.remove('active');
                cleanup();
                resolve(false);
            };
            
            const handleOverlayClick = (e) => {
                if (e.target === overlay) {
                    handleCancel();
                }
            };
            
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    handleCancel();
                }
            };
            
            const cleanup = () => {
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
                overlay.removeEventListener('click', handleOverlayClick);
                document.removeEventListener('keydown', handleEscape);
            };
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
            overlay.addEventListener('click', handleOverlayClick);
            document.addEventListener('keydown', handleEscape);
        });
    }
    
    // ===== Ù†Ù‡Ø§ÙŠØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ =====

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    async function confirmCancelEdit(formSelector) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        const form = document.querySelector(formSelector);
        if (!form) return true;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø±Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        const editingId = form.getAttribute('data-editing-id');
        if (!editingId) return true; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
        
        // Ø¹Ø±Ø¶ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
        return await showConfirmDialog({
            title: 'âš ï¸ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„',
            message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØŸ\n\nØ³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.',
            type: 'warning',
            icon: 'âš ï¸',
            confirmText: 'Ù†Ø¹Ù…ØŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„',
            cancelText: 'Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„',
            confirmButtonClass: 'warning'
        });
    }

        // === Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ===
        const GLOBAL_STORAGE_KEYS = new Set(['diwan_users', 'diwan_activities']);

        function resolveStorageKey(key) {
            if (GLOBAL_STORAGE_KEYS.has(key)) {
                return key;
            }
            return currentActivityId ? `activity_${currentActivityId}_${key}` : key;
        }

        async function saveToLocalStorage(key, data) {
            try {
                const fullKey = resolveStorageKey(key);
                console.log(`ğŸ’¾ saveToLocalStorage: key="${key}" -> fullKey="${fullKey}", items=${Array.isArray(data) ? data.length : 'N/A'}`);
                
                // ØªØ´Ø®ÙŠØµ Ø®Ø§Øµ Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                if (key === 'diwan_users' && Array.isArray(data)) {
                    console.log('ğŸ“± ØªØ´Ø®ÙŠØµ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:');
                    data.forEach(user => {
                        if (user.phone) {
                            console.log(`  ğŸ“± ${user.email}: phone="${user.phone}" (${typeof user.phone}) - Ø·ÙˆÙ„: ${user.phone.length}`);
                        } else {
                            console.log(`  ğŸ“± ${user.email}: phone ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (${typeof user.phone})`);
                        }
                    });
                }
                
                // Ø­ÙØ¸ ÙÙŠ LocalStorage
                localStorage.setItem(fullKey, JSON.stringify(data));
                console.log(`âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ LocalStorage: ${fullKey}`);
                
                // ØªØ­Ù‚Ù‚ ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø­ÙØ¸ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)
                if (key === 'diwan_users') {
                    const immediateCheck = JSON.parse(localStorage.getItem(fullKey) || '[]');
                    console.log('ğŸ” ØªØ­Ù‚Ù‚ ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø­ÙØ¸ ÙÙŠ localStorage:');
                    immediateCheck.forEach(user => {
                        if (user.phone) {
                            console.log(`  âœ… ${user.email}: phone="${user.phone}" Ù…Ø­ÙÙˆØ¸ Ø¨Ù†Ø¬Ø§Ø­`);
                        } else {
                            console.log(`  âš ï¸ ${user.email}: phone ÙØ§Ø±Øº ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©`);
                        }
                    });
                }
                
                // Ø­ÙØ¸ ÙÙŠ Firebase Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù‘Ù„Ø§Ù‹
                if (USE_FIREBASE && currentActivityId && !GLOBAL_STORAGE_KEYS.has(key)) {
                    // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­
                    const dataType = key;
                    await firebaseSaveActivityData(currentActivityId, dataType, data);
                    debugLog(`ğŸ”¥ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase: ${dataType}`);
                }
                
                return true;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                return false;
            }
        }

        function loadFromLocalStorage(key) {
            try {
                const fullKey = resolveStorageKey(key);
                const data = localStorage.getItem(fullKey);
                const parsed = data ? JSON.parse(data) : null;
                
                // ØªØ³Ø¬ÙŠÙ„ Ù…ÙØµÙ„ ÙÙ‚Ø· Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ø£Ùˆ ÙÙŠ Ø­Ø§Ù„Ø© Debug
                if (window.DEBUG_MODE || DEBUG_MODE || key === 'users' || key === 'activities') {
                    console.log(`ğŸ“‚ loadFromLocalStorage: key="${key}" -> fullKey="${fullKey}"`);
                    console.log(`ğŸ“Š ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${Array.isArray(parsed) ? parsed.length : 'null'} Ø¹Ù†ØµØ±`);
                }
                
                return parsed;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
                return null;
            }
        }

        function removeFromLocalStorage(key) {
            try {
                const fullKey = resolveStorageKey(key);
                localStorage.removeItem(fullKey);
                return true;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
                return false;
            }
        }



        // === Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© ===
        async function saveActivities() {
            const success = saveToLocalStorage('diwan_activities', activities);
            if (success) {
                loadActivities();
            }
        }

        // === Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase (ØªØ¬Ø§Ù‡Ù„ GLOBAL_STORAGE_KEYS) ===
        async function firebaseSaveUsersDirectly(usersArray) {
            if (!USE_FIREBASE) return false;
            
            try {
                const { ref, set } = window.firebaseModules;
                const database = window.firebaseDatabase;
                
                if (!database) {
                    console.warn('âš ï¸ Firebase Database ØºÙŠØ± Ù…ØªØ§Ø­');
                    return false;
                }
                
                // Ø­ÙØ¸ ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Authentication + Database
                for (const user of usersArray) {
                    if (!user.firebaseUid) {
                        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Authentication Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
                        try {
                            const firebaseUser = await firebaseCreateUser(user.email, user.password, {
                                name: user.name,
                                phone: user.phone,
                                role: user.role,
                                activityId: user.activityId,
                                createdAt: user.createdAt
                            });
                            
                            if (firebaseUser) {
                                user.firebaseUid = firebaseUser.uid;
                                console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase: ${user.email}`);
                            }
                        } catch (authError) {
                            if (authError.code === 'auth/email-already-in-use') {
                                console.log(`â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Firebase: ${user.email}`);
                            } else {
                                console.warn(`âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Authentication: ${authError.message}`);
                            }
                        }
                    }
                }
                
                // Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Database
                const usersRef = ref(database, 'users'); // ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† 'system/users' Ø¥Ù„Ù‰ 'users'
                
                // ØªØ­ÙˆÙŠÙ„ Array Ø¥Ù„Ù‰ Object Ù…ÙÙ‡Ø±Ø³ Ø¨Ø§Ù„Ù€ email Ù„Ø¶Ù…Ø§Ù† Ø¨Ù†ÙŠØ© Ø«Ø§Ø¨ØªØ©
                const usersObject = {};
                usersArray.forEach(user => {
                    if (user.email) {
                        usersObject[user.email.replace(/[.#$[\]]/g, '_')] = user; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù…Ù† Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©
                    }
                });
                
                await set(usersRef, usersObject);
                
                console.log('ğŸ”¥âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase Database');
                return true;
                
            } catch (error) {
                console.error('ğŸ”¥âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase:', error);
                return false;
            }
        }

        async function saveUsers() {
            console.log('ğŸ’¾ Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...', users.length, 'Ù…Ø³ØªØ®Ø¯Ù…');
            
            // ØªØ´Ø®ÙŠØµ ØªÙØµÙŠÙ„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
            const userWithPhone = users.find(u => u.phone);
            if (userWithPhone) {
                console.log('ğŸ“± Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸:', {
                    id: userWithPhone.id,
                    name: userWithPhone.name,
                    phone: userWithPhone.phone,
                    phoneType: typeof userWithPhone.phone
                });
            }
            
            // 1. Ø­ÙØ¸ ÙÙŠ LocalStorage Ø£ÙˆÙ„Ø§Ù‹ (ÙƒØ§Ù„Ù…Ø¹ØªØ§Ø¯)
            const success = saveToLocalStorage('diwan_users', users);
            
            // 2. Ø­ÙØ¸ ÙÙŠ Firebase Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (ØªØ¬Ø§Ù‡Ù„ GLOBAL_STORAGE_KEYS)
            if (success && USE_FIREBASE) {
                console.log('ğŸ”¥ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase...');
                const firebaseSuccess = await firebaseSaveUsersDirectly(users);
                if (firebaseSuccess) {
                    console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­');
                    // Ø¥Ø´Ø¹Ø§Ø± Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    // showNotification('ğŸ”¥ Firebase', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase', 'success');
                }
            }
            if (success) {
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ localStorage');
                // ØªØ­Ù‚Ù‚ Ù…Ø¨Ø§Ø´Ø±
                const verification = loadFromLocalStorage('diwan_users');
                console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸:', verification ? verification.length : 0, 'Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ÙÙˆØ¸');
                
                // ØªØ´Ø®ÙŠØµ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                if (verification && verification.length > 0) {
                    const savedUserWithPhone = verification.find(u => u.phone);
                    if (savedUserWithPhone) {
                        console.log('ğŸ“± Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸:', {
                            id: savedUserWithPhone.id,
                            name: savedUserWithPhone.name,
                            phone: savedUserWithPhone.phone,
                            phoneType: typeof savedUserWithPhone.phone
                        });
                    } else {
                        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸!');
                    }
                }
            } else {
                console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†!');
            }
            return success;
        }

        // ========================================
        // ğŸ”¥ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ù„Ù‰ Firebase Database
        // ========================================
        async function migrateUsersToFirebase() {
            if (!USE_FIREBASE) {
                showNotification('âš ï¸ Firebase Ù…Ø¹Ø·Ù„', 'ØªÙØ¹ÙŠÙ„ Firebase Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù†Ù‚Ù„', 'warning');
                return;
            }

            const confirmed = await showConfirmDialog(
                'ğŸ”¥ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ù„Ù‰ Firebase',
                `Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (${users.length}) Ù…Ù† LocalStorage Ø¥Ù„Ù‰ Firebase DatabaseØŸ\n\nâš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªÙ†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ø§Øª Firebase Authentication Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù….`,
                'primary',
                'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„ Ø§Ù„Ø¢Ù†',
                'Ø¥Ù„ØºØ§Ø¡'
            );

            if (!confirmed) return;

            showLoading('ğŸ”¥ Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ù„Ù‰ Firebase...');
            
            let successCount = 0;
            let failCount = 0;
            const errors = [];

            for (const user of users) {
                try {
                    console.log(`ğŸ”„ Ù…Ø¹Ø§Ù„Ø¬Ø©: ${user.email}...`);
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Firebase Authentication
                    let firebaseUser = null;
                    try {
                        firebaseUser = await firebaseCreateUser(user.email, user.password, {
                            id: user.id,
                            name: user.name,
                            email: user.email,
                            phone: user.phone,
                            role: user.role,
                            activityId: user.activityId,
                            createdAt: user.createdAt || new Date().toISOString()
                        });
                    } catch (authError) {
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ AuthenticationØŒ Ù†Ø¬Ù„Ø¨ Ø§Ù„Ù€ UID
                        if (authError.code === 'auth/email-already-in-use') {
                            console.log(`â„¹ï¸ ${user.email} Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Firebase Auth - Ø³Ù†Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·`);
                            
                            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ UID
                            const { signInWithEmailAndPassword, signOut } = window.firebaseModules;
                            const auth = window.firebaseAuth;
                            try {
                                // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                                const currentUser = auth.currentUser;
                                
                                // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø¤Ù‚Øª
                                const userCred = await signInWithEmailAndPassword(auth, user.email, user.password);
                                firebaseUser = { uid: userCred.user.uid };
                                console.log(`âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ UID: ${firebaseUser.uid}`);
                                
                                // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ÙÙˆØ±ÙŠ
                                await signOut(auth);
                                
                                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£ØµÙ„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                                if (currentUser) {
                                    const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                                    if (loggedInUser) {
                                        await signInWithEmailAndPassword(auth, loggedInUser.email, loggedInUser.password);
                                    }
                                }
                            } catch (signInError) {
                                console.warn(`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ UID Ù„Ù€ ${user.email}:`, signInError.message);
                            }
                        }
                    }

                    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Database
                    if (firebaseUser && firebaseUser.uid) {
                        await firebaseSaveUserData(firebaseUser.uid, {
                            id: user.id,
                            name: user.name,
                            email: user.email,
                            phone: user.phone,
                            role: user.role,
                            activityId: user.activityId,
                            createdAt: user.createdAt || new Date().toISOString()
                        });
                        
                        console.log(`âœ… ØªÙ… Ù†Ù‚Ù„: ${user.email}`);
                        successCount++;
                    } else {
                        throw new Error('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ UID');
                    }
                    
                } catch (error) {
                    console.error(`âŒ ÙØ´Ù„ Ù†Ù‚Ù„ ${user.email}:`, error);
                    failCount++;
                    errors.push({ email: user.email, error: error.message });
                }
            }

            hideLoading();

            // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            if (successCount === users.length) {
                showNotification(
                    'âœ… Ù†Ø¬Ø­ Ø§Ù„Ù†Ù‚Ù„',
                    `ØªÙ… Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (${successCount}) Ø¥Ù„Ù‰ Firebase Ø¨Ù†Ø¬Ø§Ø­!`,
                    'success',
                    8000
                );
            } else if (successCount > 0) {
                showNotification(
                    'âš ï¸ Ù†Ù‚Ù„ Ø¬Ø²Ø¦ÙŠ',
                    `ØªÙ… Ù†Ù‚Ù„ ${successCount} Ù…Ø³ØªØ®Ø¯Ù…ØŒ ÙØ´Ù„ ${failCount} Ù…Ø³ØªØ®Ø¯Ù….\nØªØ­Ù‚Ù‚ Ù…Ù† Console Ù„Ù„ØªÙØ§ØµÙŠÙ„.`,
                    'warning',
                    10000
                );
                console.log('âŒ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:', errors);
            } else {
                showNotification(
                    'âŒ ÙØ´Ù„ Ø§Ù„Ù†Ù‚Ù„',
                    'ÙØ´Ù„ Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†. ØªØ­Ù‚Ù‚ Ù…Ù† Console.',
                    'error',
                    8000
                );
            }
        }

        /**
         * Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰
         */
        async function fixUsersPhoneField() {
            const confirmed = await showConfirmDialog({
                title: 'ğŸ“± Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡Ø§ØªÙ',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡Ù… Ø±Ù‚Ù… Ù‡Ø§ØªÙØŸ\n\nØ³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ phone ÙØ§Ø±Øº ÙŠÙ…ÙƒÙ† ØªØ¹Ø¨Ø¦ØªÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹.',
                type: 'info',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø¥ØµÙ„Ø­ Ø§Ù„Ø¢Ù†',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });

            if (!confirmed) return;

            showLoading('ğŸ“± Ø¬Ø§Ø±ÙŠ Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡Ø§ØªÙ...');

            try {
                let fixedCount = 0;
                
                users.forEach(user => {
                    if (!user.hasOwnProperty('phone') || user.phone === undefined) {
                        user.phone = '';
                        fixedCount++;
                        console.log(`âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚Ù„ phone Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user.email}`);
                    }
                });

                if (fixedCount > 0) {
                    // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                    saveUsers();
                    
                    hideLoading();
                    showNotification(
                        'âœ… ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­',
                        `ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚Ù„ Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù€ ${fixedCount} Ù…Ø³ØªØ®Ø¯Ù…`,
                        'success'
                    );
                    
                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                    renderUsersInSettings();
                } else {
                    hideLoading();
                    showNotification(
                        'â„¹ï¸ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„Ø¥ØµÙ„Ø§Ø­',
                        'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø­Ù‚Ù„ Ø§Ù„Ù‡Ø§ØªÙ',
                        'info'
                    );
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡Ø§ØªÙ:', error);
                hideLoading();
                showNotification(
                    'âŒ ÙØ´Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­',
                    'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡Ø§ØªÙ: ' + error.message,
                    'error'
                );
            }
        }

        /**
         * Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ© ÙÙŠ Firebase Database
         */
        async function fixFirebaseUserData() {
            if (!USE_FIREBASE) {
                showNotification('âš ï¸ Firebase Ù…Ø¹Ø·Ù„', 'ØªÙØ¹ÙŠÙ„ Firebase Ù…Ø·Ù„ÙˆØ¨', 'warning');
                return;
            }

            const confirmed = await showConfirmDialog(
                'ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',
                'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ© ÙÙŠ Firebase DatabaseØŸ\n\nØ³ÙŠØªÙ… Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage Ù…Ø¹ Firebase.',
                'primary',
                'Ù†Ø¹Ù…ØŒ Ø£ØµÙ„Ø­ Ø§Ù„Ø¢Ù†',
                'Ø¥Ù„ØºØ§Ø¡'
            );

            if (!confirmed) return;

            showLoading('ğŸ”§ Ø¬Ø§Ø±ÙŠ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

            try {
                const { ref, get } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Firebase
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                
                if (!snapshot.exists()) {
                    hideLoading();
                    showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase', 'warning');
                    return;
                }

                const firebaseUsers = snapshot.val();
                let fixedCount = 0;

                // Ù…Ø·Ø§Ø¨Ù‚Ø© ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Firebase Ù…Ø¹ LocalStorage
                for (const uid in firebaseUsers) {
                    const fbUser = firebaseUsers[uid];
                    
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ LocalStorage Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
                    const localUser = users.find(u => u.email === fbUser.email);
                    
                    if (localUser) {
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ©
                        await firebaseSaveUserData(uid, {
                            id: localUser.id,
                            name: localUser.name,
                            email: localUser.email,
                            phone: localUser.phone,
                            role: localUser.role,
                            activityId: localUser.activityId,
                            createdAt: localUser.createdAt || new Date().toISOString()
                        });
                        
                        console.log(`âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø¨ÙŠØ§Ù†Ø§Øª: ${localUser.email}`);
                        fixedCount++;
                    }
                }

                hideLoading();
                showNotification(
                    'âœ… ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­',
                    `ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø¨ÙŠØ§Ù†Ø§Øª ${fixedCount} Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase!`,
                    'success'
                );

            } catch (error) {
                hideLoading();
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­:', error);
                showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­', error.message, 'error');
            }
        }

        /**
         * Ù†Ù‚Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø¥Ù„Ù‰ Firebase Database
         */
        async function migrateActivitiesToFirebase() {
            if (!USE_FIREBASE) {
                showNotification('âš ï¸ Firebase Ù…Ø¹Ø·Ù„', 'ØªÙØ¹ÙŠÙ„ Firebase Ù…Ø·Ù„ÙˆØ¨', 'warning');
                return;
            }

            const confirmed = await showConfirmDialog(
                'ğŸ”¥ Ù†Ù‚Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø¥Ù„Ù‰ Firebase',
                `Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø© (${activities.length}) Ø¥Ù„Ù‰ Firebase DatabaseØŸ\n\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§.`,
                'primary',
                'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„ Ø§Ù„Ø¢Ù†',
                'Ø¥Ù„ØºØ§Ø¡'
            );

            if (!confirmed) return;

            showLoading('ğŸ”¥ Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©...');

            try {
                const { ref, set } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                let successCount = 0;
                let errorCount = 0;

                // Ù†Ù‚Ù„ ÙƒÙ„ Ù†Ø´Ø§Ø· Ø¥Ù„Ù‰ Firebase
                for (const activity of activities) {
                    try {
                        const activityRef = ref(db, `activities/${activity.id}`);
                        await set(activityRef, {
                            id: activity.id,
                            name: activity.name,
                            createdAt: activity.createdAt || new Date().toISOString(),
                            createdBy: activity.createdBy || 'admin'
                        });
                        
                        console.log(`âœ… ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù†Ø´Ø§Ø·: ${activity.name}`);
                        successCount++;
                    } catch (error) {
                        console.error(`âŒ ÙØ´Ù„ Ù†Ù‚Ù„ Ø§Ù„Ù†Ø´Ø§Ø· ${activity.name}:`, error);
                        errorCount++;
                    }
                }

                hideLoading();
                
                if (errorCount === 0) {
                    showNotification(
                        'âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­',
                        `ØªÙ… Ù†Ù‚Ù„ ${successCount} Ù†Ø´Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Firebase!`,
                        'success'
                    );
                } else {
                    showNotification(
                        'âš ï¸ Ù†Ù‚Ù„ Ø¬Ø²Ø¦ÙŠ',
                        `Ù†Ø¬Ø­: ${successCount} | ÙØ´Ù„: ${errorCount}`,
                        'warning'
                    );
                }

            } catch (error) {
                hideLoading();
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù†Ù‚Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©:', error);
                showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ù‚Ù„', error.message, 'error');
            }
        }

        /**
         * Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Firebase
         */
        async function migrateActivityDataToFirebase() {
            if (!USE_FIREBASE) {
                showNotification('âš ï¸ Firebase Ù…Ø¹Ø·Ù„', 'ØªÙØ¹ÙŠÙ„ Firebase Ù…Ø·Ù„ÙˆØ¨', 'warning');
                return;
            }

            if (!currentActivityId) {
                showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·', 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø´Ø§Ø· Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }

            const activity = activities.find(a => a.id == currentActivityId);
            const activityName = activity ? activity.name : currentActivityId;

            const dataTypes = [
                { name: 'Ø§Ù„Ø£ØµÙ†Ø§Ù', key: 'items', data: items },
                { name: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', key: 'customers', data: customers },
                { name: 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†', key: 'suppliers', data: suppliers },
                { name: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', key: 'purchases', data: purchases },
                { name: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', key: 'sales', data: sales },
                { name: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', key: 'expenses', data: expenses },
                { name: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', key: 'revenues', data: revenues },
                { name: 'Ø§Ù„Ø±ÙˆØ§ØªØ¨', key: 'salaries', data: salaries },
                { name: 'Ø§Ù„Ø£ØµÙˆÙ„', key: 'assets', data: assets },
                { name: 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', key: 'salesReturns', data: salesReturns },
                { name: 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', key: 'purchaseReturns', data: purchaseReturns },
                { name: 'Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù', key: 'advances', data: advances }
            ];

            const totalItems = dataTypes.reduce((sum, type) => sum + (type.data ? type.data.length : 0), 0);

            const confirmed = await showConfirmDialog(
                'ğŸ”¥ Ù†Ù‚Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·',
                `Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· "${activityName}" Ø¥Ù„Ù‰ FirebaseØŸ\n\n` +
                `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${totalItems}\n\n` +
                dataTypes.map(t => `${t.name}: ${t.data ? t.data.length : 0}`).join('\n'),
                'primary',
                'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„ Ø§Ù„Ø¢Ù†',
                'Ø¥Ù„ØºØ§Ø¡'
            );

            if (!confirmed) return;

            showLoading('ğŸ”¥ Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·...');

            try {
                const { ref, set } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                let totalSuccess = 0;
                let totalError = 0;

                // Ù†Ù‚Ù„ ÙƒÙ„ Ù†ÙˆØ¹ Ø¨ÙŠØ§Ù†Ø§Øª
                for (const dataType of dataTypes) {
                    if (!dataType.data || dataType.data.length === 0) {
                        console.log(`â­ï¸ ØªØ®Ø·ÙŠ ${dataType.name} (Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª)`);
                        continue;
                    }

                    try {
                        const dataRef = ref(db, `activities/${currentActivityId}/${dataType.key}`);
                        
                        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† Ø¨Ù…ÙØ§ØªÙŠØ­ ÙØ±ÙŠØ¯Ø©
                        const dataObject = {};
                        dataType.data.forEach(item => {
                            const itemId = item.id || item.number || Date.now() + Math.random();
                            dataObject[itemId] = item;
                        });
                        
                        await set(dataRef, dataObject);
                        
                        console.log(`âœ… ØªÙ… Ù†Ù‚Ù„ ${dataType.name}: ${dataType.data.length} Ø³Ø¬Ù„`);
                        totalSuccess += dataType.data.length;
                    } catch (error) {
                        console.error(`âŒ ÙØ´Ù„ Ù†Ù‚Ù„ ${dataType.name}:`, error);
                        totalError += dataType.data.length;
                    }
                }

                hideLoading();
                
                if (totalError === 0) {
                    showNotification(
                        'âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­',
                        `ØªÙ… Ù†Ù‚Ù„ ${totalSuccess} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Firebase!`,
                        'success'
                    );
                } else {
                    showNotification(
                        'âš ï¸ Ù†Ù‚Ù„ Ø¬Ø²Ø¦ÙŠ',
                        `Ù†Ø¬Ø­: ${totalSuccess} | ÙØ´Ù„: ${totalError}`,
                        'warning'
                    );
                }

            } catch (error) {
                hideLoading();
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ù‚Ù„', error.message, 'error');
            }
        }

        // === ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Firebase ===
        async function firebaseLoadUsersDirectly() {
            if (!USE_FIREBASE) return null;
            
            try {
                const { ref, get } = window.firebaseModules;
                const database = window.firebaseDatabase;
                
                if (!database) {
                    console.warn('âš ï¸ Firebase Database ØºÙŠØ± Ù…ØªØ§Ø­');
                    return null;
                }
                
                const usersRef = ref(database, 'users'); // ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† 'system/users' Ø¥Ù„Ù‰ 'users'
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const firebaseUsers = snapshot.val();
                    
                    // ØªØ­ÙˆÙŠÙ„ Object Ø¥Ù„Ù‰ Array Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Object
                    let usersArray = [];
                    if (Array.isArray(firebaseUsers)) {
                        usersArray = firebaseUsers;
                    } else if (firebaseUsers && typeof firebaseUsers === 'object') {
                        // ØªØ­ÙˆÙŠÙ„ Object Ø¥Ù„Ù‰ Array Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Object.values
                        usersArray = Object.values(firebaseUsers).filter(u => u && u.id && u.email);
                    }
                    
                    console.log('ğŸ”¥âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Firebase:', usersArray?.length || 0);
                    return usersArray;
                } else {
                    console.log('ğŸ”¥â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase - Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©');
                    return [];
                }
                
            } catch (error) {
                console.error('ğŸ”¥âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Firebase:', error);
                return null;
            }
        }

        // === ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ù† Firebase ===
        async function firebaseLoadActivitiesDirectly() {
            if (!USE_FIREBASE) return null;
            
            try {
                const { ref, get, set, remove } = window.firebaseModules;
                const database = window.firebaseDatabase;
                
                if (!database) {
                    console.warn('âš ï¸ Firebase Database ØºÙŠØ± Ù…ØªØ§Ø­');
                    return null;
                }
                
                // ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·
                const activitiesRef = ref(database, 'activities');
                let snapshot = await get(activitiesRef);
                
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (!snapshot.exists()) {
                    console.log('ğŸ” Ù„Ù… ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© ÙÙŠ activitiesØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ activitiesList Ø§Ù„Ù‚Ø¯ÙŠÙ…...');
                    const oldActivitiesRef = ref(database, 'activitiesList');
                    const oldSnapshot = await get(oldActivitiesRef);
                    
                    if (oldSnapshot.exists()) {
                        const firebaseActivities = oldSnapshot.val();
                        const activitiesArray = [];
                        
                        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„Ø·Ø©
                        Object.keys(firebaseActivities).forEach(key => {
                            const value = firebaseActivities[key];
                            if (value && typeof value === 'object' && value.id && value.name) {
                                activitiesArray.push(value);
                            }
                        });
                        
                        if (activitiesArray.length > 0) {
                            console.log(`ğŸ”„ Ù†Ù‚Ù„ ${activitiesArray.length} Ù†Ø´Ø§Ø· Ù…Ù† activitiesList Ø¥Ù„Ù‰ activities`);
                            const activitiesObject = {};
                            activitiesArray.forEach(activity => {
                                if (activity.id) {
                                    activitiesObject[activity.id] = {
                                        id: activity.id,
                                        name: activity.name,
                                        createdAt: activity.createdAt || new Date().toISOString(),
                                        createdBy: activity.createdBy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
                                    };
                                }
                            });
                            await set(activitiesRef, activitiesObject);
                            
                            // Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…
                            await remove(oldActivitiesRef);
                            console.log('ï¿½ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… activities');
                            
                            return activitiesArray;
                        }
                    }
                }
                
                if (snapshot.exists()) {
                    const firebaseActivities = snapshot.val();
                    
                    // ØªØ­ÙˆÙŠÙ„ Object Ø¥Ù„Ù‰ Array Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Object
                    let activitiesArray = [];
                    if (Array.isArray(firebaseActivities)) {
                        activitiesArray = firebaseActivities;
                    } else if (firebaseActivities && typeof firebaseActivities === 'object') {
                        // ØªØ­ÙˆÙŠÙ„ Object Ø¥Ù„Ù‰ Array Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Object.values
                        activitiesArray = Object.values(firebaseActivities).filter(a => a && a.id && a.name);
                    }
                    
                    console.log('ğŸ”¥âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ù† Firebase:', activitiesArray?.length || 0);
                    return activitiesArray;
                } else {
                    console.log('ğŸ”¥â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase - Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©');
                    return [];
                }
                
            } catch (error) {
                console.error('ğŸ”¥âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ù† Firebase:', error);
                return null;
            }
        }

       async function loadUsers() {
    try {
        console.log("ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...");
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase Ø£ÙˆÙ„Ø§Ù‹
        if (USE_FIREBASE) {
            const firebaseUsers = await firebaseLoadUsersDirectly();
            if (firebaseUsers && firebaseUsers.length > 0) {
                users = firebaseUsers;
                console.log(`ğŸ”¥âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${users.length} Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firebase`);
                return;
            }
        }
        
        // Ø¥Ø°Ø§ ÙØ´Ù„ FirebaseØŒ Ø­Ù…Ù‘Ù„ Ù…Ù† LocalStorage
        console.log("ğŸ”„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ...");
        let storedUsers = loadFromLocalStorage('diwan_users');

        if (!Array.isArray(storedUsers)) {
            storedUsers = [];
        }

        if (storedUsers.length === 0 && typeof localStorage !== 'undefined') {
            const legacyUsers = [];
            const legacyKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.endsWith('_diwan_users')) {
                    try {
                        const raw = JSON.parse(localStorage.getItem(key) || '[]');
                        if (Array.isArray(raw) && raw.length) {
                            raw.forEach(candidate => {
                                if (!candidate || !candidate.email) return;
                                const exists = legacyUsers.some(user => user.email === candidate.email);
                                if (!exists) {
                                    legacyUsers.push(candidate);
                                }
                            });
                        }
                        legacyKeys.push(key);
                    } catch (legacyError) {
                        console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù‚Ø¯ÙŠÙ…Ø©:', legacyError);
                    }
                }
            }

            if (legacyUsers.length) {
                console.log(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${legacyUsers.length} Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù…ÙØ§ØªÙŠØ­ Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ø³ÙŠØªÙ… Ù†Ù‚Ù„Ù‡Ù… Ù„Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯`);
                storedUsers = legacyUsers;
                saveToLocalStorage('diwan_users', storedUsers);
                legacyKeys.forEach(key => localStorage.removeItem(key));
            }
        }

        users = storedUsers;
        
        // Ø¥ØµÙ„Ø§Ø­: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ù‚Ù„ phone ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        users.forEach(user => {
            if (!user.hasOwnProperty('phone')) {
                user.phone = '';
                console.log(`âš ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ phone ÙØ§Ø±Øº Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user.email}`);
            }
        });
        
        console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${users.length} Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ`);
        if (users.length > 0) {
            console.log('ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ù…Ù„Ø©:');
            users.forEach(u => {
                console.log(`  - ${u.email}: role=${u.role}, phone=${u.phone || 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}, activityId=${u.activityId} (${typeof u.activityId})`);
            });
            
            // ØªØ´Ø®ÙŠØµ Ø®Ø§Øµ Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ù„Ø§Øª
            console.log('ğŸ“± ØªØ´Ø®ÙŠØµ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ù„Ø§Øª:');
            users.forEach(u => {
                if (u.phone) {
                    console.log(`  ğŸ“± ${u.email}: phone="${u.phone}" (${typeof u.phone}) - Ø·ÙˆÙ„: ${u.phone.length}`);
                } else {
                    console.log(`  ğŸ“± ${u.email}: phone ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (${typeof u.phone})`);
                }
            });
        }
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:", error);
        users = [];
    }
}

        // === Ø¯ÙˆØ§Ù„ ØªØ®ØµÙŠØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===
        function toggleControlPanel() {
            const panel = document.getElementById('controlPanel');
            panel.classList.toggle('show');
        }

        function updateFontSize(size) {
            document.documentElement.style.setProperty('--font-size', size + 'px');
            document.getElementById('font-size-value').textContent = size + 'px';
            saveDesignPreferences(); // Ø­ÙØ¸ Ø§Ù„ØªØ®ØµÙŠØµØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        }

        function updateColor(variable, color) {
            document.documentElement.style.setProperty(variable, color);
            saveDesignPreferences(); // Ø­ÙØ¸ Ø§Ù„ØªØ®ØµÙŠØµØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        }

        function updateHeaderColor(color) {
            // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¯Ø±Ø¬
            const gradient = `linear-gradient(135deg, ${color} 0%, #34495e 100%)`;
            document.documentElement.style.setProperty('--header-bg', gradient);
            saveDesignPreferences(); // Ø­ÙØ¸ Ø§Ù„ØªØ®ØµÙŠØµØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        }

        // ØªØ­Ø¯ÙŠØ« ØªØ¯Ø±Ø¬ Ø§Ù„ØªØ°ÙŠÙŠÙ„
        function updateFooterGradient(color, position) {
            const footer = document.getElementById('appFooter');
            if (!footer) return;
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const currentStyle = footer.style.background;
            let color1 = '#667eea';
            let color2 = '#764ba2';
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù…Ù† Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const match = currentStyle.match(/linear-gradient\(135deg,\s*([^)]+)\s+0%,\s*([^)]+)\s+100%\)/);
            if (match) {
                color1 = match[1].trim();
                color2 = match[2].trim();
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            if (position === 'start') {
                color1 = color;
            } else {
                color2 = color;
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const newGradient = `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
            footer.style.background = newGradient;
            
            saveDesignPreferences();
        }

        // ØªØ­Ø¯ÙŠØ« Ø®Ø· Ø§Ù„ØªØ°ÙŠÙŠÙ„
        function updateFooterFont(font) {
            const footer = document.getElementById('appFooter');
            if (footer) {
                footer.style.fontFamily = font;
                saveDesignPreferences();
            }
        }

        function saveDesignPreferences() {
            const footer = document.getElementById('appFooter');
            const preferences = {
                primaryColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
                bgColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim(),
                textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
                headerBg: getComputedStyle(document.documentElement).getPropertyValue('--header-bg').trim(),
                sidebarBg: getComputedStyle(document.documentElement).getPropertyValue('--sidebar-bg').trim(),
                fontSize: getComputedStyle(document.documentElement).getPropertyValue('--font-size').trim(),
                fontFamily: getComputedStyle(document.documentElement).getPropertyValue('--font-family').trim(),
                footerBg: footer ? footer.style.background : '',
                footerFont: footer ? footer.style.fontFamily : ''
            };
            localStorage.setItem('designPreferences', JSON.stringify(preferences));
        }

        function loadDesignPreferences() {
            const saved = localStorage.getItem('designPreferences');
            if (saved) {
                try {
                    const preferences = JSON.parse(saved);
                    
                    if (preferences.primaryColor) {
                        document.documentElement.style.setProperty('--primary-color', preferences.primaryColor);
                        const primaryPicker = document.querySelector('input[onchange*="--primary-color"]');
                        if (primaryPicker) primaryPicker.value = preferences.primaryColor;
                    }
                    
                    if (preferences.bgColor) {
                        document.documentElement.style.setProperty('--bg-color', preferences.bgColor);
                        const bgPicker = document.querySelector('input[onchange*="--bg-color"]');
                        if (bgPicker) bgPicker.value = preferences.bgColor;
                    }
                    
                    if (preferences.textColor) {
                        document.documentElement.style.setProperty('--text-color', preferences.textColor);
                        const textPicker = document.querySelector('input[onchange*="--text-color"]');
                        if (textPicker) textPicker.value = preferences.textColor;
                    }
                    
                    if (preferences.headerBg) {
                        document.documentElement.style.setProperty('--header-bg', preferences.headerBg);
                        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ù† Ø§Ù„ØªØ¯Ø±Ø¬
                        const colorMatch = preferences.headerBg.match(/linear-gradient\(135deg,\s*([^,]+)/);
                        if (colorMatch && colorMatch[1]) {
                            const headerPicker = document.getElementById('headerColorPicker');
                            if (headerPicker) headerPicker.value = colorMatch[1].trim();
                        }
                    }
                    
                    if (preferences.sidebarBg) {
                        document.documentElement.style.setProperty('--sidebar-bg', preferences.sidebarBg);
                        const sidebarPicker = document.getElementById('sidebarColorPicker');
                        if (sidebarPicker) sidebarPicker.value = preferences.sidebarBg;
                    }
                    
                    if (preferences.fontSize) {
                        document.documentElement.style.setProperty('--font-size', preferences.fontSize);
                        const sizeValue = parseInt(preferences.fontSize);
                        const rangeInput = document.querySelector('input[type="range"]');
                        const sizeDisplay = document.getElementById('font-size-value');
                        if (rangeInput) rangeInput.value = sizeValue;
                        if (sizeDisplay) sizeDisplay.textContent = preferences.fontSize;
                    }
                    
                    if (preferences.fontFamily) {
                        document.documentElement.style.setProperty('--font-family', preferences.fontFamily);
                        const fontSelect = document.getElementById('fontFamilySelect');
                        if (fontSelect) fontSelect.value = preferences.fontFamily;
                    }
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„
                    const footer = document.getElementById('appFooter');
                    if (footer) {
                        if (preferences.footerBg) {
                            footer.style.background = preferences.footerBg;
                            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù…Ù† Ø§Ù„ØªØ¯Ø±Ø¬
                            const match = preferences.footerBg.match(/linear-gradient\(135deg,\s*([^)]+)\s+0%,\s*([^)]+)\s+100%\)/);
                            if (match) {
                                const footerColor1 = document.getElementById('footerColor1Picker');
                                const footerColor2 = document.getElementById('footerColor2Picker');
                                if (footerColor1) footerColor1.value = match[1].trim();
                                if (footerColor2) footerColor2.value = match[2].trim();
                            }
                        }
                        if (preferences.footerFont) {
                            footer.style.fontFamily = preferences.footerFont;
                            const footerFontSelect = document.getElementById('footerFontSelect');
                            if (footerFontSelect) footerFontSelect.value = preferences.footerFont;
                        }
                    }
                    
                } catch (e) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªØ®ØµÙŠØµØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ…:', e);
                }
            }
        }

        function updateFontFamily(font) {
            document.documentElement.style.setProperty('--font-family', font);
            saveDesignPreferences(); // Ø­ÙØ¸ Ø§Ù„ØªØ®ØµÙŠØµØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        }

        function resetDesign() {
            document.documentElement.style.setProperty('--primary-color', '#2c5aa0');
            document.documentElement.style.setProperty('--bg-color', '#ecf0f1');
            document.documentElement.style.setProperty('--text-color', '#2c3e50');
            document.documentElement.style.setProperty('--header-bg', 'linear-gradient(135deg, #2c5aa0 0%, #34495e 100%)');
            document.documentElement.style.setProperty('--sidebar-bg', '#1a3a5c');
            document.documentElement.style.setProperty('--font-size', '16px');
            document.documentElement.style.setProperty('--font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif");
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ°ÙŠÙŠÙ„
            const footer = document.getElementById('appFooter');
            if (footer) {
                footer.style.background = 'linear-gradient(135deg, #1e3a5f 0%, #2c4a6f 100%)';
                footer.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            }
            
            document.querySelector('input[type="range"]').value = 16;
            document.getElementById('font-size-value').textContent = '16px';
            document.querySelector('input[value="#2c5aa0"]').value = '#2c5aa0';
            document.querySelector('input[value="#ecf0f1"]').value = '#ecf0f1';
            document.querySelector('input[value="#2c3e50"]').value = '#1a3a5c';
            document.getElementById('headerColorPicker').value = '#2c5aa0';
            document.getElementById('sidebarColorPicker').value = '#2c3e50';
            document.getElementById('fontFamilySelect').value = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            
            // Ø­Ø°Ù Ø§Ù„ØªØ®ØµÙŠØµØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            localStorage.removeItem('designPreferences');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
            showNotification('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­! ğŸ¨', 'success');
        }

        // === Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Ù…Ø¤Ù‚ØªØ©) ===
        function showAutoBackupInfo() {
            try {
                // Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ LocalStorage
                let totalSize = 0;
                let itemsCount = 0;
                
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length;
                        itemsCount++;
                    }
                }
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ø¥Ù„Ù‰ ÙˆØ­Ø¯Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
                let sizeText = '';
                if (totalSize < 1024) {
                    sizeText = `${totalSize} Ø¨Ø§ÙŠØª`;
                } else if (totalSize < 1024 * 1024) {
                    sizeText = `${(totalSize / 1024).toFixed(1)} ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª`;
                } else {
                    sizeText = `${(totalSize / (1024 * 1024)).toFixed(1)} Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª`;
                }
                
                // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Firebase
                const firebaseStatus = USE_FIREBASE ? 'Ù…ÙÙØ¹Ù‘Ù„ âœ…' : 'Ù…Ø¹Ø·Ù‘Ù„ âŒ';
                
                // Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
                const lastActivity = sessionStorage.getItem('lastActivityTime') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                
                const message = `
ğŸ”„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¬ÙŠÙ† Ø§Ù„Ù†Ø´Ø·:
â€¢ Firebase: ${firebaseStatus}
â€¢ LocalStorage: Ù†Ø´Ø· âœ…
â€¢ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©: ${sizeText}
â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙØ§ØªÙŠØ­: ${itemsCount}
â€¢ Ø¢Ø®Ø± Ù†Ø´Ø§Ø·: ${lastActivity}

ğŸ’¡ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ù…ÙƒØ§Ù†ÙŠÙ† Ù„Ø¶Ù…Ø§Ù† Ø£Ù‚ØµÙ‰ Ø­Ù…Ø§ÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª.`;
                
                showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', message, 'info');
                
            } catch (error) {
                showNotification('â„¹ï¸ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¬ÙŠÙ† ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Firebase + LocalStorage ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'info');
            }
        }
        
        /**
         * Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ø¯Ø© ØªØ¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
         */
        async function showBackupInfoWithRestore() {
            try {
                // Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ LocalStorage
                let totalSize = 0;
                let itemsCount = 0;
                
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length;
                        itemsCount++;
                    }
                }
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ø¥Ù„Ù‰ ÙˆØ­Ø¯Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
                let sizeText = '';
                if (totalSize < 1024) {
                    sizeText = `${totalSize} Ø¨Ø§ÙŠØª`;
                } else if (totalSize < 1024 * 1024) {
                    sizeText = `${(totalSize / 1024).toFixed(1)} ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª`;
                } else {
                    sizeText = `${(totalSize / (1024 * 1024)).toFixed(1)} Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª`;
                }
                
                // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Firebase
                const firebaseStatus = USE_FIREBASE ? 'Ù…ÙÙØ¹Ù‘Ù„ âœ…' : 'Ù…Ø¹Ø·Ù‘Ù„ âŒ';
                
                // Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
                const lastActivity = sessionStorage.getItem('lastActivityTime') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                
                const message = `
ğŸ”„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:
â€¢ Firebase: ${firebaseStatus}
â€¢ LocalStorage: Ù†Ø´Ø· âœ…
â€¢ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©: ${sizeText}
â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙØ§ØªÙŠØ­: ${itemsCount}
â€¢ Ø¢Ø®Ø± Ù†Ø´Ø§Ø·: ${lastActivity}

ğŸ’¡ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ù…ÙƒØ§Ù†ÙŠÙ† Ù„Ø¶Ù…Ø§Ù† Ø£Ù‚ØµÙ‰ Ø­Ù…Ø§ÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª.

Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©ØŸ`;
                
                const confirmed = await showConfirmDialog(
                    'ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©',
                    message,
                    'info',
                    'Ù†Ø¹Ù…ØŒ Ø§Ø³ØªØ¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                    'Ø¥Ù„ØºØ§Ø¡'
                );

                if (confirmed) {
                    // ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø£Ø®Ø±Ù‰
                    await restoreAutoBackup(true);
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ:', error);
                showNotification('â„¹ï¸ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¬ÙŠÙ† ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Firebase + LocalStorage ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'info');
            }
        }
        
        async function restoreAutoBackup(skipConfirmation = false) {
            if (!skipConfirmation) {
                const confirmed = await showConfirmDialog(
                    'ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©',
                    'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (LocalStorage)ØŸ\n\nâš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø³ÙŠØ³ØªØ¨Ø¯Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©.',
                    'warning',
                    'Ù†Ø¹Ù…ØŒ Ø§Ø³ØªØ¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                    'Ø¥Ù„ØºØ§Ø¡'
                );

                if (!confirmed) return;
            }

            try {
                showLoading('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                
                console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† LocalStorage...');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                await loadUsers();
                await loadActivities();
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
                if (window.currentActivityId) {
                    console.log('ğŸ“Š Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·:', window.currentActivityId);
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage
                    items = JSON.parse(localStorage.getItem(`diwan_items_${window.currentActivityId}`) || '[]');
                    customers = JSON.parse(localStorage.getItem(`diwan_customers_${window.currentActivityId}`) || '[]');
                    suppliers = JSON.parse(localStorage.getItem(`diwan_suppliers_${window.currentActivityId}`) || '[]');
                    purchases = JSON.parse(localStorage.getItem(`diwan_purchases_${window.currentActivityId}`) || '[]');
                    sales = JSON.parse(localStorage.getItem(`diwan_sales_${window.currentActivityId}`) || '[]');
                    expenses = JSON.parse(localStorage.getItem(`diwan_expenses_${window.currentActivityId}`) || '[]');
                    revenues = JSON.parse(localStorage.getItem(`diwan_revenues_${window.currentActivityId}`) || '[]');
                    salaries = JSON.parse(localStorage.getItem(`diwan_salaries_${window.currentActivityId}`) || '[]');
                    assets = JSON.parse(localStorage.getItem(`diwan_assets_${window.currentActivityId}`) || '[]');
                    salesReturns = JSON.parse(localStorage.getItem(`diwan_salesReturns_${window.currentActivityId}`) || '[]');
                    purchaseReturns = JSON.parse(localStorage.getItem(`diwan_purchaseReturns_${window.currentActivityId}`) || '[]');
                    advances = JSON.parse(localStorage.getItem(`diwan_advances_${window.currentActivityId}`) || '[]');
                    
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage:');
                    console.log(`  - Ø§Ù„Ø£ØµÙ†Ø§Ù: ${items.length}`);
                    console.log(`  - Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${customers.length}`);
                    console.log(`  - Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†: ${suppliers.length}`);
                    console.log(`  - Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${sales.length}`);
                    console.log(`  - Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${purchases.length}`);
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
                const currentSection = document.querySelector('.section:not([style*="display: none"])');
                if (currentSection && currentSection.id) {
                    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:', currentSection.id);
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                    const sectionName = currentSection.id.replace('Section', '');
                    if (typeof showSection === 'function') {
                        showSection(sectionName);
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                sessionStorage.setItem('lastRestoreTime', new Date().toLocaleString('ar-SA'));
                
                hideLoading();
                showNotification('âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'success');
                
            } catch (error) {
                hideLoading();
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©:', error);
                showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message, 'error');
            }
        }
        
        function downloadAutoBackup() {
            try {
                // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage
                const backupData = {
                    timestamp: new Date().toISOString(),
                    type: 'local_storage_backup',
                    users: JSON.parse(localStorage.getItem('users') || '[]'),
                    activities: JSON.parse(localStorage.getItem('activities') || '[]'),
                    activityData: {}
                };
                
                // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ù†Ø´Ø§Ø·
                backupData.activities.forEach(activity => {
                    const activityId = activity.id;
                    backupData.activityData[activityId] = {
                        items: JSON.parse(localStorage.getItem(`items_${activityId}`) || '[]'),
                        customers: JSON.parse(localStorage.getItem(`customers_${activityId}`) || '[]'),
                        suppliers: JSON.parse(localStorage.getItem(`suppliers_${activityId}`) || '[]'),
                        purchases: JSON.parse(localStorage.getItem(`purchases_${activityId}`) || '[]'),
                        sales: JSON.parse(localStorage.getItem(`sales_${activityId}`) || '[]'),
                        expenses: JSON.parse(localStorage.getItem(`expenses_${activityId}`) || '[]'),
                        revenues: JSON.parse(localStorage.getItem(`revenues_${activityId}`) || '[]'),
                        salaries: JSON.parse(localStorage.getItem(`salaries_${activityId}`) || '[]'),
                        assets: JSON.parse(localStorage.getItem(`assets_${activityId}`) || '[]'),
                        salesReturns: JSON.parse(localStorage.getItem(`salesReturns_${activityId}`) || '[]'),
                        purchaseReturns: JSON.parse(localStorage.getItem(`purchaseReturns_${activityId}`) || '[]'),
                        advances: JSON.parse(localStorage.getItem(`advances_${activityId}`) || '[]')
                    };
                });
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù„Ù„ØªÙ†Ø²ÙŠÙ„
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ†Ø²ÙŠÙ„
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `backup_localStorage_${new Date().toISOString().split('T')[0]}.json`;
                
                // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('âœ… ØªÙ… Ø§Ù„ØªÙ†Ø²ÙŠÙ„', 'ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† LocalStorage Ø¨Ù†Ø¬Ø§Ø­', 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
            }
        }

        // === ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ù‡ÙˆØ§ØªÙ ===
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        function updateAccountInfoSection(user) {
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            const currentUserNameEl = document.getElementById('currentUserNameDisplay');
            const currentUserEmailEl = document.getElementById('currentUserEmailDisplay');
            const currentUserPhoneEl = document.getElementById('currentUserPhoneDisplay');
            const currentUserRoleEl = document.getElementById('currentUserRoleDisplay');
            const currentActivityNameEl = document.getElementById('currentActivityNameDisplay');
            const changeActivityBtn = document.getElementById('changeActivityBtn');

            const fallbackText = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            const fallbackActivity = 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø·';
            
            if (currentUserNameEl) {
                const hasName = user && user.name && user.name.trim();
                currentUserNameEl.textContent = hasName ? user.name : (user && user.email ? user.email : fallbackText);
            }
            if (currentUserEmailEl) {
                currentUserEmailEl.textContent = user && user.email ? user.email : fallbackText;
            }
            if (currentUserPhoneEl) {
                const hasPhone = user && user.phone && user.phone.trim();
                currentUserPhoneEl.textContent = hasPhone ? user.phone : fallbackText;
            }
            if (currentUserRoleEl) {
                if (user && user.role) {
                    const roleNames = { admin: 'ğŸ”‘ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', manager: 'ğŸ§­ Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·', user: 'ğŸ‘¨â€ğŸ’¼ Ù…Ø³ØªØ®Ø¯Ù…' };
                    currentUserRoleEl.textContent = roleNames[user.role] || 'Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                } else {
                    currentUserRoleEl.textContent = fallbackText;
                }
            }
            if (currentActivityNameEl) {
                let activityName = fallbackActivity;
                if (currentActivityId) {
                    const activity = activities.find(a => a.id == currentActivityId);
                    activityName = activity ? activity.name : 'Ù†Ø´Ø§Ø· ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                }
                currentActivityNameEl.textContent = activityName;
            }
            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ±
            if (changeActivityBtn) {
                const showChange = (user && user.role === 'admin');
                changeActivityBtn.style.display = showChange ? 'inline-block' : 'none';
            }
        }

        function updateSidebar(role) {
            const sidebarNav = document.getElementById('sidebarNav');
            if (!sidebarNav) return;

            // Refreshes the navigation menu according to the signed-in role.
            const baseSections = [
                { id: 'home', label: 'ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' },
                { id: 'advanced-dashboard', label: 'ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©' },
                { id: 'items', label: 'ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù' },
                { id: 'customers', label: 'ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' },
                { id: 'suppliers', label: 'ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†' },
                { id: 'purchases', label: 'ğŸ›’ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª' },
                { id: 'sales', label: 'ğŸ’° ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª' },
                { id: 'returns', label: 'â†©ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª' },
                { id: 'expenses', label: 'ğŸ’¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª' },
                { id: 'revenues', label: 'ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª' },
                { id: 'advances', label: 'ğŸ’³ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù' },
                { id: 'sadaqa', label: 'ğŸ¤² Ø­Ø³Ø§Ø¨ Ø§Ù„ØµØ¯Ù‚Ø©' },
                { id: 'salaries', label: 'ğŸ’¼ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨' },
                { id: 'assets', label: 'ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙˆÙ„' },
                { id: 'reports', label: 'ï¿½ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±' },
                { id: 'settings', label: 'âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù†Ø¸Ø§Ù…' }
            ];

            let sectionsToRender;
            if (role === 'admin') {
                sectionsToRender = baseSections;
            } else if (role === 'manager') {
                // Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ÙŠØ±Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø§Ø¹Ø¯Ø§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                sectionsToRender = baseSections;
            } else if (role === 'user') {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙŠØ±Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø§Ø¹Ø¯Ø§ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨
                sectionsToRender = baseSections.filter(section => !['settings', 'salaries'].includes(section.id));
            } else {
                sectionsToRender = baseSections.filter(section => !['salaries'].includes(section.id));
            }

            sidebarNav.innerHTML = '';
            sectionsToRender.forEach(section => {
                const button = document.createElement('button');
                button.textContent = section.label;
                button.setAttribute('onclick', `showSection('${section.id}')`);
                sidebarNav.appendChild(button);
            });
            // Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø§Ù„ØµØ¯Ù‚Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (!document.getElementById('sadaqa')) {
                const container = document.querySelector('.container');
                if (container) {
                    const sadaqaSection = document.createElement('div');
                    sadaqaSection.id = 'sadaqa';
                    sadaqaSection.className = 'section';
                    sadaqaSection.innerHTML = `
                        <h2>ğŸ¤² Ø­Ø³Ø§Ø¨ Ø§Ù„ØµØ¯Ù‚Ø©</h2>
                        <div class="form-grid grid-3">
                            <input type="number" id="sadaqaAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„) *" min="1" required>
                            <input type="date" id="sadaqaDate" required>
                            <input type="text" id="sadaqaDesc" placeholder="ÙˆØµÙ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯">
                            <button class="btn-primary btn-add" onclick="addSadaqa()">â• Ø¥Ø¶Ø§ÙØ© ØµØ¯Ù‚Ø©</button>
                        </div>
                        <div id="sadaqaList" style="margin-top:2em;"></div>
                        <div id="sadaqaTotal" style="margin-top:1em; font-weight:bold;"></div>
                    `;
                    container.appendChild(sadaqaSection);
                    // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø³Ù…
                    setTimeout(() => { window.renderSadaqaList(); }, 0);
                }
            }
            // Ø¯ÙˆØ§Ù„ Ø§Ù„ØµØ¯Ù‚Ø©
            window.addSadaqa = function() {
                const amount = parseFloat(document.getElementById('sadaqaAmount').value);
                const date = document.getElementById('sadaqaDate').value;
                const desc = document.getElementById('sadaqaDesc').value;
                if (!amount || !date) {
                    showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®', 'error');
                    return;
                }
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                sadaqat.push({ amount, date, desc });
                localStorage.setItem('sadaqat', JSON.stringify(sadaqat));
                document.getElementById('sadaqaAmount').value = '';
                document.getElementById('sadaqaDate').value = '';
                document.getElementById('sadaqaDesc').value = '';
                renderSadaqaList();
            };
            window.renderSadaqaList = function() {
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                let html = '<table border="1" style="width:100%;text-align:center"><tr><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th style="text-align:left">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>';
                let total = 0;
                sadaqat.forEach((s, i) => {
                    html += `<tr>
                        <td>${s.amount}</td>
                        <td>${s.date}</td>
                        <td>${s.desc || ''}</td>
                        <td style='text-align:left'>
                            <div class='action-buttons' style='justify-content: flex-start;'>
                                <button class='btn-warning edit-btn' onclick="editSadaqa(${i})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class='btn-danger' onclick="deleteSadaqa(${i})">Ø­Ø°Ù</button>
                            </div>
                        </td>
                    </tr>`;
                    total += s.amount;
                });
                html += '</table>';
                document.getElementById('sadaqaList').innerHTML = html;
                document.getElementById('sadaqaTotal').innerText = 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ¯Ù‚Ø§Øª: ' + total + ' Ø±ÙŠØ§Ù„';
            };
            // Ø­Ø°Ù Ø³Ø¬Ù„ ØµØ¯Ù‚Ø©
            window.deleteSadaqa = function(idx) {
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) {
                    sadaqat.splice(idx, 1);
                    localStorage.setItem('sadaqat', JSON.stringify(sadaqat));
                    renderSadaqaList();
                }
            };
            // ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„ ØµØ¯Ù‚Ø©
            window.editSadaqa = function(idx) {
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                const s = sadaqat[idx];
                document.getElementById('sadaqaAmount').value = s.amount;
                document.getElementById('sadaqaDate').value = s.date;
                document.getElementById('sadaqaDesc').value = s.desc;
                // Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ØŒ Ù†Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…
                window._sadaqaEditIdx = idx;
                const btn = document.querySelector('#sadaqa .btn-add');
                if (btn) {
                    btn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
                    btn.onclick = function() {
                        const amount = parseFloat(document.getElementById('sadaqaAmount').value);
                        const date = document.getElementById('sadaqaDate').value;
                        const desc = document.getElementById('sadaqaDesc').value;
                        if (!amount || !date) {
                            showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®', 'error');
                            return;
                        }
                        sadaqat[idx] = { amount, date, desc };
                        localStorage.setItem('sadaqat', JSON.stringify(sadaqat));
                        renderSadaqaList();
                        document.getElementById('sadaqaAmount').value = '';
                        document.getElementById('sadaqaDate').value = '';
                        document.getElementById('sadaqaDesc').value = '';
                        btn.textContent = 'â• Ø¥Ø¶Ø§ÙØ© ØµØ¯Ù‚Ø©';
                        btn.onclick = addSadaqa;
                        window._sadaqaEditIdx = null;
                    };
                }
            };
            // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø³Ù…
            if (!window._sadaqaListLoaded) {
                document.addEventListener('DOMContentLoaded', window.renderSadaqaList);
                window._sadaqaListLoaded = true;
            }

            const activeSection = document.querySelector('.section.active');
            if (activeSection) {
                const activeButton = sidebarNav.querySelector(`button[onclick="showSection('${activeSection.id}')"]`);
                if (activeButton) {
                    activeButton.classList.add('active');
                }
            }
        }

        function updateLoggedInUserDisplay(user) {
            const userEl = document.getElementById('currentUserDisplay');
            if (userEl) {
                if (user) {
                    const displayName = (user.name && user.name.trim()) ? user.name : user.email || 'Ù…Ø³ØªØ®Ø¯Ù…';
                    const roleInfo = {
                        admin: { label: 'ğŸ”‘ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', cls: 'role-admin' },
                        manager: { label: 'ğŸ§­ Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·', cls: 'role-manager' },
                        user: { label: 'ğŸ‘¨â€ğŸ’¼ Ù…Ø³ØªØ®Ø¯Ù…', cls: 'role-user' }
                    };
                    const currentRole = roleInfo[user.role] || { label: 'Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', cls: '' };
                    userEl.innerHTML = `<span class="user-name">ğŸ‘¤ ${displayName}</span><span class="user-description">${currentRole.label}</span>`;
                    userEl.classList.remove('role-admin', 'role-manager', 'role-user');
                    if (currentRole.cls) {
                        userEl.classList.add(currentRole.cls);
                    }
                } else {
                    userEl.innerHTML = '<span class="user-name">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span><span class="user-description">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„</span>';
                    userEl.classList.remove('role-admin', 'role-manager', 'role-user');
                }
            }

            updateAccountInfoSection(user);
        }

function updatePerformanceIndicators() {
    const monthlySummary = document.getElementById('monthlySummary');
    const financialPerformance = document.getElementById('financialPerformance');
    
    if (!monthlySummary || !financialPerformance) return;
    
    const currentMonth = new Date().toISOString().substring(0, 7);
    
    const monthSales = sales.filter(s => s.date.substring(0, 7) === currentMonth)
                          .reduce((sum, sale) => sum + sale.total, 0);
    const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === currentMonth)
                                .reduce((sum, expense) => sum + expense.amount, 0);
    const monthRevenue = revenues.filter(r => r.date.substring(0, 7) === currentMonth)
                               .reduce((sum, revenue) => sum + revenue.amount, 0);
    const monthPurchases = purchases.filter(p => p.date.substring(0, 7) === currentMonth)
                                  .reduce((sum, purchase) => sum + purchase.total, 0);

    const profitMargin = monthSales > 0 ? ((monthSales - monthPurchases - monthExpenses) / monthSales * 100).toFixed(1) : 0;
    const avgInvoice = monthSales / Math.max(sales.filter(s => s.date.substring(0, 7) === currentMonth).length, 1);

    monthlySummary.innerHTML = `
        <div style="margin-bottom: 15px;">
            <p style="margin: 8px 0; font-size: 14px;">ğŸ’° <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</strong> ${monthSales.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ’¸ <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</strong> ${monthExpenses.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ“ˆ <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:</strong> ${monthRevenue.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ¯ <strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</strong> ${sales.filter(s => s.date.substring(0, 7) === currentMonth).length}</p>
        </div>
    `;

    financialPerformance.innerHTML = `
        <div style="margin-bottom: 15px;">
            <p style="margin: 8px 0; font-size: 14px;">ğŸ“Š <strong>Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­:</strong> <span style="color: ${profitMargin > 0 ? '#27ae60' : '#e74c3c'}">${profitMargin}%</span></p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ“ˆ <strong>Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${avgInvoice.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ”„ <strong>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ:</strong> <span style="color: #27ae60">+15%</span></p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ¯ <strong>ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù:</strong> <span style="color: #27ae60">85%</span></p>
        </div>
    `;
}

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
function getLast7Days() {
    const days = [];
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toISOString().split('T')[0]);
    }
    return days;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-SA', { 
        month: 'short', 
        day: 'numeric' 
    });
}

        // === Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ===
       async function showSection(sectionId) {
    if (editingSaleId || editingPurchaseId) {
        const confirmed = await showConfirmDialog(
            'ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
            'Ù„Ø¯ÙŠÙƒ ÙØ§ØªÙˆØ±Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ØŸ',
            'warning',
            'Ø­Ø³Ù†Ø§Ù‹ØŒ Ø¥Ù„ØºØ§Ø¡',
            'Ø¥Ù„ØºØ§Ø¡'
        );
        if (!confirmed) {
            return;
        }
        resetInvoiceForms();
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙ‚Ø· Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù†Ù‡Ø§
    const currentSection = document.querySelector('.section.active');
    if (currentSection && currentSection.id === 'items' && sectionId !== 'items') {
        const confirmed = await confirmCancelItemEdit();
        if (!confirmed) {
            return; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ÙˆØ§Ù„Ø¨Ù‚Ø§Ø¡ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù
        }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù†Ù‡Ø§
    if (currentSection && currentSection.id === 'customers' && sectionId !== 'customers') {
        const confirmed = await confirmCancelCustomerEdit();
        if (!confirmed) {
            return; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ÙˆØ§Ù„Ø¨Ù‚Ø§Ø¡ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
    if (currentSection && currentSection.id === 'suppliers' && sectionId !== 'suppliers') {
        const confirmed = await confirmCancelSupplierEdit();
        if (!confirmed) return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    if (currentSection && currentSection.id === 'expenses' && sectionId !== 'expenses') {
        const confirmed = await confirmCancelExpenseEdit();
        if (!confirmed) return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
    if (currentSection && currentSection.id === 'revenues' && sectionId !== 'revenues') {
        const confirmed = await confirmCancelRevenueEdit();
        if (!confirmed) return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨
    if (currentSection && currentSection.id === 'salaries' && sectionId !== 'salaries') {
        const confirmed = await confirmCancelSalaryEdit();
        if (!confirmed) return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø£ØµÙˆÙ„
    if (currentSection && currentSection.id === 'assets' && sectionId !== 'assets') {
        const confirmed = await confirmCancelAssetEdit();
        if (!confirmed) return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù
    if (currentSection && currentSection.id === 'advances' && sectionId !== 'advances') {
        const confirmed = await confirmCancelAdvanceEdit();
        if (!confirmed) return;
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„Ø¨ØµØ±ÙŠØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
    document.querySelectorAll('input.editing-mode, select.editing-mode, textarea.editing-mode').forEach(input => {
        input.classList.remove('editing-mode');
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
    document.querySelectorAll('.btn-primary.update-mode').forEach(btn => {
        const originalText = btn.getAttribute('data-original-text');
        if (originalText) {
            btn.innerHTML = originalText;
            btn.removeAttribute('data-original-text');
        }
        btn.classList.remove('update-mode');
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    document.querySelectorAll('.section h2').forEach(h2 => {
        h2.style.color = '';
    });
    
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ±ÙŠØº Ù„Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡Ø§
    if (typeof clearItemForm === 'function') clearItemForm();
    if (typeof clearCustomerForm === 'function') clearCustomerForm();
    if (typeof clearSupplierForm === 'function') clearSupplierForm();
    if (typeof clearExpenseForm === 'function') clearExpenseForm();
    if (typeof clearRevenueForm === 'function') clearRevenueForm();
    if (typeof clearSalaryForm === 'function') clearSalaryForm();
    if (typeof clearAssetForm === 'function') clearAssetForm();
    if (typeof clearAdvanceForm === 'function') clearAdvanceForm();

    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    document.querySelectorAll('.sidebar-nav button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙ‚Ø·
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø· ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    const activeButton = Array.from(document.querySelectorAll('.sidebar-nav button')).find(
        btn => btn.getAttribute('onclick') === `showSection('${sectionId}')`
    );
    if(activeButton) activeButton.classList.add('active');

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
    if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('open');
    }
    
    // ğŸ  ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    if (sectionId === 'home') {
        console.log('ğŸ  ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª...');
        if (typeof updateDashboard === 'function') {
            updateDashboard();
        }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØµØºØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
    if (sectionId === 'items') {
        const miniStatItemsEl = document.getElementById('miniStatItems');
        if (miniStatItemsEl) miniStatItemsEl.textContent = items.length;
        renderItems();
        generateItemCode();
    }
    else if (sectionId === 'customers') {
        const miniStatCustomersEl = document.getElementById('miniStatCustomers');
        if (miniStatCustomersEl) miniStatCustomersEl.textContent = customers.length;
        renderCustomers();
        generateCustomerCode();
    }
    else if (sectionId === 'suppliers') {
        const miniStatSuppliersEl = document.getElementById('miniStatSuppliers');
        if (miniStatSuppliersEl) miniStatSuppliersEl.textContent = suppliers.length;
        renderSuppliers();
        generateSupplierCode();
    }
    else if (sectionId === 'purchases') {
        const miniStatPurchasesEl = document.getElementById('miniStatPurchases');
        if (miniStatPurchasesEl) miniStatPurchasesEl.textContent = purchases.length;
        updatePurchaseDropdowns();
        generatePurchaseCode();
        const purchaseDateEl = document.getElementById('purchaseDate');
        if (purchaseDateEl) purchaseDateEl.value = new Date().toISOString().split('T')[0];
    }
    else if (sectionId === 'sales') {
        const miniStatSalesEl = document.getElementById('miniStatSales');
        if (miniStatSalesEl) miniStatSalesEl.textContent = sales.length;
        updateSaleDropdowns();
        generateSaleCode();
        const saleDateEl = document.getElementById('saleDate');
        if (saleDateEl) saleDateEl.value = new Date().toISOString().split('T')[0];
    }
    else if (sectionId === 'expenses') {
        const miniStatExpensesEl = document.getElementById('miniStatExpenses');
        if (miniStatExpensesEl) miniStatExpensesEl.textContent = expenses.length;
        updateExpenseStats();
        renderExpenses();
        const expenseDateEl = document.getElementById('expenseDate');
        if (expenseDateEl) expenseDateEl.value = new Date().toISOString().split('T')[0];
    } else if (sectionId === 'revenues') {
        const miniStatRevenuesEl = document.getElementById('miniStatRevenues');
        if (miniStatRevenuesEl) miniStatRevenuesEl.textContent = revenues.length;
        updateRevenueStats();
        renderRevenues();
        const revenueDateEl = document.getElementById('revenueDate');
        if (revenueDateEl) revenueDateEl.value = new Date().toISOString().split('T')[0];
    } else if (sectionId === 'salaries') {
        renderSalaries();
        updateSalarySummary();
    } else if (sectionId === 'advances') {
        const miniStatAdvancesEl = document.getElementById('miniStatAdvances');
        if (miniStatAdvancesEl) miniStatAdvancesEl.textContent = advances.length;
        renderAdvances();
        updateAdvanceStats();
        setupAdvanceSearch();
        const advanceDateEl = document.getElementById('advanceDate');
        if (advanceDateEl) advanceDateEl.value = new Date().toISOString().split('T')[0];
 
    } else if (sectionId === 'advanced-dashboard') {
        try {
            console.log('ğŸ“Š ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© - Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ØªÙˆÙØ±Ù‡Ø§
            if (!sales || sales.length === 0) {
                const stored = loadFromLocalStorage('sales');
                if (stored) sales = stored;
            }
            if (!purchases || purchases.length === 0) {
                const stored = loadFromLocalStorage('purchases');
                if (stored) purchases = stored;
            }
            if (!expenses || expenses.length === 0) {
                const stored = loadFromLocalStorage('expenses');
                if (stored) expenses = stored;
            }
            if (!revenues || revenues.length === 0) {
                const stored = loadFromLocalStorage('revenues');
                if (stored) revenues = stored;
            }
            
            console.log('ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„:', {
                sales: sales ? sales.length : 0,
                purchases: purchases ? purchases.length : 0,
                expenses: expenses ? expenses.length : 0,
                revenues: revenues ? revenues.length : 0
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
            if (typeof updateAdvancedDashboardCards === 'function') {
                updateAdvancedDashboardCards();
            }
            
            // ğŸ†• ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
            setTimeout(() => {
                if (typeof updateAllCharts === 'function') {
                    updateAllCharts();
                }
            }, 300); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            
            if (typeof initAdvancedDashboard === 'function') {
                initAdvancedDashboard();
            } else {
                console.warn('âš ï¸ Ø¯Ø§Ù„Ø© initAdvancedDashboard ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©:', error);
        }
    } else if (sectionId === 'returns') {
        showReturnTab('sales');
    } else if (sectionId === 'settings') {
        const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        const userManagementSection = document.getElementById('userManagementSection');
        const activityManagementSection = document.getElementById('activityManagementSection');
        const branchManagementSection = document.getElementById('branchManagementSection');
        const footerSettingsSection = document.getElementById('footerSettingsSection');

        if (userManagementSection) {
            if (loggedInUser && (loggedInUser.role === 'admin' || loggedInUser.role === 'manager')) {
                userManagementSection.style.display = 'block';
            } else {
                userManagementSection.style.display = 'none';
            }
        }

        if (activityManagementSection) {
            // ÙÙ‚Ø· Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ³ØªØ·ÙŠØ¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© (Ø¥Ù†Ø´Ø§Ø¡ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø­Ø°Ù)
            if (loggedInUser && loggedInUser.role === 'admin') {
                activityManagementSection.style.display = 'block';
            } else {
                // Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø©
                activityManagementSection.style.display = 'none';
            }
        }

        // ğŸª Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆÙ…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·
        if (branchManagementSection) {
            if (loggedInUser && (loggedInUser.role === 'admin' || loggedInUser.role === 'manager')) {
                branchManagementSection.style.display = 'block';
                renderBranches(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else {
                branchManagementSection.style.display = 'none';
            }
        }

        // ğŸ“„ Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        if (footerSettingsSection) {
            footerSettingsSection.style.display = 'block';
            loadFooterSettings(); // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· Ø¹Ù„Ù‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        if (loggedInUser && loggedInUser.role === 'manager') {
            restrictManagerUserManagement(loggedInUser);
        }

        if (loggedInUser && (loggedInUser.role === 'admin' || loggedInUser.role === 'manager')) {
            document.getElementById('activityLogoSection').style.display = 'block';
        } else {
            document.getElementById('activityLogoSection').style.display = 'none';
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        console.log('ğŸ“‹ ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        renderActivitiesInSettings();
        renderUsersInSettings();
        
        // ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)
        switchSettingsTab('users');
    }
}

        /**
         * Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
         */
        function switchSettingsTab(tabName) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
            document.querySelectorAll('.settings-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            const tabContents = {
                'users': 'usersTabContent',
                'activities': 'activitiesTabContent',
                'general': 'generalTabContent',
                'backup': 'backupTabContent'
            };
            
            const contentId = tabContents[tabName];
            const contentElement = document.getElementById(contentId);
            if (contentElement) {
                contentElement.classList.add('active');
            }
            
            // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø©
            event.currentTarget.classList.add('active');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø©
            if (tabName === 'activities') {
                renderActivitiesInSettings();
                renderBranches();
            } else if (tabName === 'users') {
                renderUsersInSettings();
            } else if (tabName === 'general') {
                loadFooterSettings();
            }
        }

        /**
         * ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
         */
        function restrictManagerUserManagement(loggedInUser) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù… Ø£Ùˆ Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø· Ø¢Ø®Ø±
            const roleSelect = document.getElementById('newUserRole');
            if (roleSelect) {
                // Ø¥Ø®ÙØ§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± - ÙÙ‚Ø· ÙŠØ³ØªØ·ÙŠØ¹ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ø§Ø¯ÙŠÙŠÙ†
                Array.from(roleSelect.options).forEach(option => {
                    if (option.value === 'admin' || option.value === 'manager') {
                        option.style.display = 'none';
                    } else if (option.value === 'user') {
                        option.style.display = 'block';
                        option.selected = true; // ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ ÙƒØ®ÙŠØ§Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ
                    }
                });
            }

            // Ù‚ÙŠØ¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø´Ø§Ø· - ÙÙ‚Ø· Ù†Ø´Ø§Ø· Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
            const activitySelect = document.getElementById('newUserActivity');
            if (activitySelect && loggedInUser.activityId) {
                // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø¹Ø¯Ø§ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø¯ÙŠØ±
                Array.from(activitySelect.options).forEach(option => {
                    if (option.value === '' || option.value === loggedInUser.activityId) {
                        option.style.display = 'block';
                        if (option.value === loggedInUser.activityId) {
                            option.selected = true; // ØªØ­Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
                        }
                    } else {
                        option.style.display = 'none';
                    }
                });

                // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
                const managerNote = document.createElement('p');
                managerNote.id = 'manager-restriction-note';
                managerNote.style.cssText = 'color: #2196F3; font-size: 0.9em; margin: 10px 0; padding: 15px; background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); border-radius: 8px; border-right: 4px solid #2196F3; box-shadow: 0 2px 4px rgba(33,150,243,0.1);';
                managerNote.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5em;">ğŸ§­</span>
                        <div>
                            <strong>ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·:</strong>
                            <ul style="margin: 5px 0; padding-right: 15px;">
                                <li>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ø§Ø¯ÙŠÙŠÙ† Ù„Ù†Ø´Ø§Ø·Ùƒ ÙÙ‚Ø·</li>
                                <li>ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ù†Ø´Ø§Ø·Ùƒ ÙÙ‚Ø·</li>
                                <li>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠØ±ÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø£Ùˆ Ù…Ø¯ÙŠØ±ÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø£Ø®Ø±Ù‰</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
                const existingNote = document.getElementById('manager-restriction-note');
                if (existingNote) {
                    existingNote.remove();
                }
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ form Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const newUserForm = document.getElementById('newUserForm');
                if (newUserForm && newUserForm.parentNode) {
                    newUserForm.parentNode.insertBefore(managerNote, newUserForm.nextSibling);
                }
            }

            // ØªÙ‚ÙŠÙŠØ¯ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ù†Ø´Ø§Ø·Ù‡ ÙÙ‚Ø·
            restrictManagerUsersList(loggedInUser);
        }

        /**
         * ØªÙ‚ÙŠÙŠØ¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· - Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ù†Ø´Ø§Ø·Ù‡ ÙÙ‚Ø·
         */
        function restrictManagerUsersList(loggedInUser) {
            const usersDropdown = document.getElementById('usersDropdown');
            if (usersDropdown && loggedInUser.activityId) {
                // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù†Ø´Ø§Ø·
                Array.from(usersDropdown.options).forEach(option => {
                    if (option.value === '') {
                        option.style.display = 'block'; // Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ "Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§"
                        return;
                    }

                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                    const user = users.find(u => u.email === option.value);
                    if (user) {
                        if (user.activityId === loggedInUser.activityId || user.email === loggedInUser.email) {
                            option.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ù†ÙØ³ Ø§Ù„Ù†Ø´Ø§Ø· + Ø§Ù„Ù…Ø¯ÙŠØ± Ù†ÙØ³Ù‡
                        } else {
                            option.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
                        }
                    } else {
                        option.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
                    }
                });
            }
        }

        // ===== Activity and Header Functions =====
        function updateHeaderForActivity(activity) {
            if (activity) {
                document.getElementById('activityHeaderTitle').textContent = activity.name;
                document.getElementById('activityHeaderSubtitle').style.display = 'none';
                
                // Load activity logo
                loadActivityLogo();
            } else {
                document.getElementById('activityHeaderTitle').textContent = 'Ø¯ÙŠÙˆØ§Ù†ÙŠ';
                document.getElementById('activityHeaderSubtitle').style.display = 'block';
                
                // Hide activity logo
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) headerLogo.style.display = 'none';
            }

console.log('ğŸ” Reached line ~10000 in main script...');

            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            updateAccountInfoSection(loggedInUser);
        }
        
        function getActivityDataKey(baseKey) {
            if (!currentActivityId) return null;
            return `activity_${currentActivityId}_${baseKey}`;
        }
        
        async function loadActivities() {
            try {
                console.log("ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©...");
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase Ø£ÙˆÙ„Ø§Ù‹
                if (USE_FIREBASE) {
                    const firebaseActivities = await firebaseLoadActivitiesDirectly();
                    if (firebaseActivities && firebaseActivities.length > 0) {
                        activities = firebaseActivities;
                        console.log(`ğŸ”¥âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${activities.length} Ù†Ø´Ø§Ø· Ù…Ù† Firebase`);
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
                        const activitySelect = document.getElementById('userActivitySelect');
                        if (activitySelect) {
                            activitySelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø£ÙˆÙ„Ø§Ù‹ --</option>';
                            activities.forEach(act => {
                                activitySelect.innerHTML += `<option value="${act.id}">${act.name}</option>`;
                            });
                        }
                        return;
                    }
                }
                
                // Ø¥Ø°Ø§ ÙØ´Ù„ FirebaseØŒ Ø­Ù…Ù‘Ù„ Ù…Ù† LocalStorage
                console.log("ğŸ”„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ...");
                let rawData = loadFromLocalStorage('diwan_activities');
                console.log("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù… Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ:", rawData);

                if (!Array.isArray(rawData) && rawData) {
                    rawData = [];
                }

                if ((!rawData || rawData.length === 0) && typeof localStorage !== 'undefined') {
                    const legacyActivities = [];
                    const legacyKeys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.endsWith('_diwan_activities')) {
                            try {
                                const raw = JSON.parse(localStorage.getItem(key) || '[]');
                                if (Array.isArray(raw) && raw.length) {
                                    raw.forEach(candidate => {
                                        if (!candidate || !candidate.id) return;
                                        const exists = legacyActivities.some(act => String(act.id) === String(candidate.id));
                                        if (!exists) {
                                            legacyActivities.push(candidate);
                                        }
                                    });
                                }
                                legacyKeys.push(key);
                            } catch (legacyError) {
                                console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ù†Ø´Ø·Ø© Ù‚Ø¯ÙŠÙ…Ø©:', legacyError);
                            }
                        }
                    }

                    if (legacyActivities.length) {
                        console.log(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${legacyActivities.length} Ù†Ø´Ø§Ø· ÙÙŠ Ù…ÙØ§ØªÙŠØ­ Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ø³ÙŠØªÙ… Ù†Ù‚Ù„Ù‡Ù… Ù„Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯`);
                        rawData = legacyActivities;
                        saveToLocalStorage('diwan_activities', rawData);
                        legacyKeys.forEach(key => localStorage.removeItem(key));
                    }
                }

                activities = rawData || [];
                console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${activities.length} Ù†Ø´Ø§Ø·:`, activities);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ù†ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (activities.length > 0) {
                    console.log("Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø£Ù†Ø´Ø·Ø©:");
                    activities.forEach((act, index) => {
                        console.log(`Ø§Ù„Ù†Ø´Ø§Ø· ${index + 1}:`, { id: act.id, name: act.name });
                    });
                }
                
                const activitySelect = document.getElementById('userActivitySelect');
                if (activitySelect) {
                    activitySelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø£ÙˆÙ„Ø§Ù‹ --</option>';
                    activities.forEach(act => {
                        activitySelect.innerHTML += `<option value="${act.id}">${act.name}</option>`;
                    });
                }
            } catch (error) {
                console.error("Ø®Ø·Ø£ ØªÙØµÙŠÙ„ÙŠ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©:", error);
                activities = [];
            }
        }

        // === Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase (ØªØ¬Ø§Ù‡Ù„ GLOBAL_STORAGE_KEYS) ===
        async function firebaseSaveActivitiesDirectly(activitiesArray) {
            if (!USE_FIREBASE) return false;
            
            try {
                const { ref, set } = window.firebaseModules;
                const database = window.firebaseDatabase;
                
                if (!database) {
                    console.warn('âš ï¸ Firebase Database ØºÙŠØ± Ù…ØªØ§Ø­');
                    return false;
                }

                console.log('ğŸ”¥ Ø­ÙØ¸ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase...');
                
                // Ø­ÙØ¸ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase Database Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù†Ø´Ø·Ø©
                // Ù†Ø³ØªØ®Ø¯Ù… activities Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† activitiesList Ù„ØªØ¬Ù†Ø¨ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·
                const activitiesListRef = ref(database, 'activities');
                
                // ØªØ­ÙˆÙŠÙ„ Array Ø¥Ù„Ù‰ Object Ù…ÙÙ‡Ø±Ø³ Ø¨Ø§Ù„Ù€ id Ù…Ø¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const activitiesObject = {};
                activitiesArray.forEach(activity => {
                    if (activity.id) {
                        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                        activitiesObject[activity.id] = {
                            id: activity.id,
                            name: activity.name || 'Ù†Ø´Ø§Ø· Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
                            createdAt: activity.createdAt || new Date().toISOString(),
                            createdBy: activity.createdBy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
                        };
                    }
                });
                
                // Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Ù…ÙƒØ§Ù† Ù…Ù†ÙØµÙ„ Ù„ØªØ¬Ù†Ø¨ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù†Ø´Ø·Ø©
                await set(activitiesListRef, activitiesObject);
                
                console.log('ğŸ”¥âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase Database (activities)');
                console.log('ğŸ›¡ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ© Ù…Ø­Ù…ÙŠØ© ÙˆÙ„Ù† ØªÙÙ…Ø³Ø­');
                return true;
                
            } catch (error) {
                console.error('ğŸ”¥âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase:', error);
                return false;
            }
        }

        async function saveActivities() {
            // 1. Ø­ÙØ¸ ÙÙŠ LocalStorage Ø£ÙˆÙ„Ø§Ù‹ (ÙƒØ§Ù„Ù…Ø¹ØªØ§Ø¯)
            const success = saveToLocalStorage('diwan_activities', activities);
            
            // 2. Ø­ÙØ¸ ÙÙŠ Firebase Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø£Ù†Ø´Ø·Ø© (ØªØ¬Ø§Ù‡Ù„ GLOBAL_STORAGE_KEYS)
            if (success && USE_FIREBASE) {
                console.log('ğŸ”¥ Ø­ÙØ¸ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase...');
                const firebaseSuccess = await firebaseSaveActivitiesDirectly(activities);
                if (firebaseSuccess) {
                    console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­');
                    // Ø¥Ø´Ø¹Ø§Ø± Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    // showNotification('ğŸ”¥ Firebase', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase', 'success');
                }
            }
            
            if (success) {
                loadActivities();
            }
        }
        
        function showActivityModal() {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©
            loadActivities();
            
            document.getElementById('activity-overlay').style.display = 'flex';
            document.querySelector('.app-container').style.display = 'none';
            renderActivitiesInModal();
        }
        
        function renderActivitiesInModal() {
            console.log(`Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© - Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù†Ø´Ø·Ø©: ${activities.length}`);
            const listDiv = document.getElementById('activity-list');
            listDiv.innerHTML = '';
            if (activities.length === 0) {
                console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§");
                listDiv.innerHTML = '<p>Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯. Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯ Ù„Ù„Ø¨Ø¯Ø¡.</p>';
            } else {
                console.log("Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù†Ø´Ø·Ø©:", activities.map(a => a.name));
                activities.forEach(activity => {
                    const button = document.createElement('button');
                    button.className = 'btn-primary activity-btn';
                    button.textContent = activity.name;
                    button.onclick = () => selectActivity(activity.id);
                    listDiv.appendChild(button);
                });
            }
        }
        
    async function addNewActivity(fromSettings = false) {
            const inputId = fromSettings ? 'settingNewActivityName' : 'newActivityName';
            const activityName = document.getElementById(inputId).value.trim();
            if (!activityName) {
                showNotification('âš ï¸ Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„Ù†Ø´Ø§Ø·', 'warning');
                return;
            }

            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const newActivity = {
                id: Date.now(),
                name: activityName,
                createdBy: loggedInUser ? loggedInUser.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                createdAt: new Date().toISOString()
            };
            activities.push(newActivity);
            await saveActivities();
            document.getElementById(inputId).value = '';

            if (fromSettings) {
                renderActivitiesInSettings();
            } else {
                selectActivity(newActivity.id);
            }
        }

        async function selectActivity(id) {
            console.log(`Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø´Ø§Ø·: ${id}`);
            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·...');
            
            try {
                currentActivityId = id;
                sessionStorage.setItem('currentActivityId', id);
                console.log(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø´Ø§Ø· ÙÙŠ sessionStorage: ${id}`);
                
                const activity = activities.find(a => a.id == id);
                
                console.log('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·:', activity);
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ sessionStorage Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø±
                if (activity) {
                    sessionStorage.setItem('currentActivity', JSON.stringify(activity));
                }
                
                updateHeaderForActivity(activity);
                document.getElementById('activity-overlay').style.display = 'none';
                document.querySelector('.app-container').style.display = 'flex';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø´Ø§Ø·
                const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
                if (user) {
                    updateSidebar(user.role);
                }

                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆÙØ± Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡
                console.log('ğŸ” ÙØ­Øµ Ø­Ø§Ù„Ø© initializeApp:', {
                    'window.initializeApp type': typeof window.initializeApp,
                    'window.initializeApp value': window.initializeApp,
                    'initializeApp type': typeof initializeApp,
                    'initializeApp value': initializeApp
                });
                
                if (typeof window.initializeApp === 'function') {
                    console.log('âœ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ initializeApp Ù…Ù† window');
                    await window.initializeApp();
                } else if (typeof initializeApp === 'function') {
                    console.log('âœ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ initializeApp Ù…Ø¨Ø§Ø´Ø±Ø©');
                    await initializeApp();
                } else {
                    console.warn('âš ï¸ initializeApp ØºÙŠØ± Ù…ØªØ§Ø­Ø© - Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ¹Ø±ÙŠÙ Ù…Ø¤Ø¬Ù„...');
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
                    let attempts = 0;
                    const maxAttempts = 10;
                    const checkInterval = 100;
                    
                    const tryInitialize = async () => {
                        console.log(`ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ${attempts + 1}/${maxAttempts} - Ù†ÙˆØ¹ window.initializeApp:`, typeof window.initializeApp);
                        
                        if (typeof window.initializeApp === 'function') {
                            console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ initializeApp - Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¢Ù†...');
                            try { 
                                await window.initializeApp(); 
                                console.log('âœ… ØªÙ…Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­');
                            } catch (e) { 
                                console.error('âŒ Ø¥Ø®ÙØ§Ù‚ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¤Ø¬Ù„Ø©:', e); 
                            }
                            return;
                        }
                        
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(tryInitialize, checkInterval);
                        } else {
                            console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ initializeApp Ø¨Ø¹Ø¯', maxAttempts, 'Ù…Ø­Ø§ÙˆÙ„Ø§Øª');
                            console.log('ğŸš¨ Ø­Ø§Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©:', {
                                'window.initializeApp': window.initializeApp,
                                'typeof window.initializeApp': typeof window.initializeApp
                            });
                        }
                    };
                    
                    tryInitialize();
                }
                
                // ğŸ  Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
                console.log('ğŸ  Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...');
                setTimeout(() => {
                    const homeSection = document.getElementById('home');
                    if (homeSection && !homeSection.classList.contains('active')) {
                        console.log('ğŸ”„ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...');
                        showSection('home');
                    } else {
                        console.log('âœ… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù†Ø´Ø·Ø© Ø¨Ø§Ù„ÙØ¹Ù„');
                        // ğŸ”„ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ù†Ø´Ø·Ø©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
                        console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...');
                        if (typeof updateDashboard === 'function') {
                            updateDashboard();
                        }
                    }
                }, 500);
                
                hideLoading();
            } catch (error) {
                hideLoading();
                logError('Select Activity', error);
            }
        }
        
        function renderActivitiesInSettings() {
            const dropdown = document.getElementById('activitiesDropdown');
            if (!dropdown) return;

            const previousSelection = dropdown.value;
            dropdown.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù†Ø´Ø§Ø·Ù‹Ø§</option>';

            activities.forEach(activity => {
                const option = document.createElement('option');
                option.value = activity.id;
                option.textContent = activity.name;
                dropdown.appendChild(option);
            });

            if (previousSelection && activities.some(a => String(a.id) === previousSelection)) {
                dropdown.value = previousSelection;
            } else {
                dropdown.value = '';
            }

            handleActivitySelection();
        }

        function handleActivitySelection() {
            const dropdown = document.getElementById('activitiesDropdown');
            const infoBox = document.getElementById('selectedActivityInfo');
            const nameInput = document.getElementById('selectedActivityName');
            const editBtn = document.getElementById('editSelectedActivityBtn');
            const deleteBtn = document.getElementById('deleteSelectedActivityBtn');

            if (!dropdown) return;

            const selectedId = dropdown.value;
            const activity = activities.find(a => String(a.id) === selectedId);

            if (!activity) {
                if (infoBox) infoBox.style.display = 'none';
                if (nameInput) nameInput.value = '';
                if (editBtn) editBtn.disabled = true;
                if (deleteBtn) deleteBtn.disabled = true;
                return;
            }

            if (infoBox) infoBox.style.display = 'flex';
            if (nameInput) nameInput.value = activity.name;
            if (editBtn) editBtn.disabled = false;
            if (deleteBtn) deleteBtn.disabled = false;
        }

        function handleEditSelectedActivity() {
            const dropdown = document.getElementById('activitiesDropdown');
            if (!dropdown || !dropdown.value) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø´Ø§Ø· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'warning');
                return;
            }
            const activityId = Number(dropdown.value);
            if (!Number.isNaN(activityId)) {
                editActivity(activityId);
            }
        }

        function handleDeleteSelectedActivity() {
            const dropdown = document.getElementById('activitiesDropdown');
            if (!dropdown || !dropdown.value) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø´Ø§Ø· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'warning');
                return;
            }
            const activityId = Number(dropdown.value);
            if (!Number.isNaN(activityId)) {
                deleteActivity(activityId);
            }
        }

        async function editActivity(id) {
            const activityIndex = activities.findIndex(a => a.id === id);
            if (activityIndex === -1) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }

            // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            openEditActivityModal(id);
        }
        
        async function deleteActivity(id) {
            if (id == currentActivityId) {
                showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…ÙØªÙˆØ­ Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            const activity = activities.find(a => a.id === id);
            const confirmed = await showConfirmDialog(
                'Ø­Ø°Ù Ø§Ù„Ù†Ø´Ø§Ø· Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
                `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù†Ø´Ø§Ø· "${activity.name}"ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`,
                'danger',
                'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                const dataKeys = ['items', 'customers', 'suppliers', 'purchases', 'sales', 'salesReturns', 'purchaseReturns', 'expenses', 'revenues', 'lastBackup'];
                for (const key of dataKeys) {
                    removeFromLocalStorage(key);
                }
                activities = activities.filter(a => a.id !== id);
                await saveActivities();
                renderActivitiesInSettings();
            }
        }

        // ===== ğŸª Branch Management Functions - Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹ =====
        
        // Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯
        async function addBranch() {
            const branchName = document.getElementById('newBranchName').value.trim();
            
            if (!branchName) {
                showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹', 'warning');
                return;
            }
            
            if (!currentActivityId) {
                showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø´Ø§Ø· Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ø³Ù…
            const exists = branches.find(b => b.name === branchName && b.activityId === currentActivityId);
            if (exists) {
                showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠÙˆØ¬Ø¯ ÙØ±Ø¹ Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
                return;
            }
            
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            
            const newBranch = {
                id: Date.now(),
                activityId: currentActivityId,
                name: branchName,
                createdAt: new Date().toISOString(),
                createdBy: loggedInUser ? loggedInUser.email : 'unknown'
            };
            
            branches.push(newBranch);
            await saveBranches();
            
            document.getElementById('newBranchName').value = '';
            renderBranches();
            
            showNotification('âœ… Ù†Ø¬Ø§Ø­', `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹ "${branchName}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„ÙØ±ÙˆØ¹ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        function renderBranches() {
            const tbody = document.getElementById('branchesTableBody');
            
            if (!currentActivityId) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Ø§Ø®ØªØ± Ù†Ø´Ø§Ø·Ø§Ù‹ Ù„Ø¹Ø±Ø¶ ÙØ±ÙˆØ¹Ù‡</td></tr>';
                return;
            }
            
            const activityBranches = branches.filter(b => b.activityId === currentActivityId);
            
            if (activityBranches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹ - Ø£Ø¶Ù ÙØ±Ø¹Ùƒ Ø§Ù„Ø£ÙˆÙ„</td></tr>';
                return;
            }
            
            tbody.innerHTML = activityBranches.map((branch, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${branch.name}</td>
                    <td>${new Date(branch.createdAt).toLocaleDateString('ar-SA')}</td>
                    <td style="text-align: left;">
                        <button class="btn-warning btn-sm" onclick="editBranch(${branch.id})" title="ØªØ¹Ø¯ÙŠÙ„" style="margin-left: 5px;">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger btn-sm" onclick="deleteBranch(${branch.id})" title="Ø­Ø°Ù">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // ØªØ¹Ø¯ÙŠÙ„ ÙØ±Ø¹
        async function editBranch(branchId) {
            const branch = branches.find(b => b.id === branchId);
            if (!branch) return;
            
            const newName = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹:', branch.name);
            if (!newName || newName.trim() === '') return;
            
            const trimmedName = newName.trim();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ø³Ù…
            const exists = branches.find(b => b.name === trimmedName && b.activityId === currentActivityId && b.id !== branchId);
            if (exists) {
                showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠÙˆØ¬Ø¯ ÙØ±Ø¹ Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
                return;
            }
            
            branch.name = trimmedName;
            branch.updatedAt = new Date().toISOString();
            
            await saveBranches();
            renderBranches();
            
            showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
        
        // Ø­Ø°Ù ÙØ±Ø¹
        async function deleteBranch(branchId) {
            const branch = branches.find(b => b.id === branchId);
            if (!branch) return;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙØ±Ø¹
            const hasTransactions = 
                sales.some(s => s.branchId === branchId) ||
                purchases.some(p => p.branchId === branchId) ||
                expenses.some(e => e.branchId === branchId) ||
                revenues.some(r => r.branchId === branchId);
            
            let message = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹ "${branch.name}"ØŸ`;
            if (hasTransactions) {
                message += '\n\nâš ï¸ ØªØ­Ø°ÙŠØ±: ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹. Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ.';
            }
            
            const confirmed = confirm(message);
            if (!confirmed) return;
            
            // Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹
            branches = branches.filter(b => b.id !== branchId);
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (null = Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)
            if (hasTransactions) {
                sales.forEach(s => { if (s.branchId === branchId) s.branchId = null; });
                purchases.forEach(p => { if (p.branchId === branchId) p.branchId = null; });
                expenses.forEach(e => { if (e.branchId === branchId) e.branchId = null; });
                revenues.forEach(r => { if (r.branchId === branchId) r.branchId = null; });
                
                // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                await saveData('sales', sales);
                await saveData('purchases', purchases);
                await saveData('expenses', expenses);
                await saveData('revenues', revenues);
            }
            
            await saveBranches();
            renderBranches();
            
            showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
        
        // Ø­ÙØ¸ Ø§Ù„ÙØ±ÙˆØ¹ ÙÙŠ Firebase Ùˆ localStorage
        async function saveBranches() {
            if (!currentActivityId) return;
            
            // Ø­ÙØ¸ ÙÙŠ localStorage
            saveToLocalStorage('branches', branches);
            
            // Ø­ÙØ¸ ÙÙŠ Firebase
            if (typeof firebaseSaveActivityData === 'function') {
                await firebaseSaveActivityData(currentActivityId, 'branches', branches);
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹ Ø¹Ù†Ø¯ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        async function loadBranches() {
            if (!currentActivityId) return;
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase Ø£ÙˆÙ„Ø§Ù‹
            if (typeof firebaseGetActivityData === 'function') {
                const firebaseBranches = await firebaseGetActivityData(currentActivityId, 'branches');
                if (firebaseBranches && firebaseBranches.length > 0) {
                    branches = firebaseBranches;
                    saveToLocalStorage('branches', branches);
                    return;
                }
            }
            
            // Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage ÙƒØ¨Ø¯ÙŠÙ„
            const localBranches = loadFromLocalStorage('branches');
            if (localBranches && Array.isArray(localBranches)) {
                branches = localBranches.filter(b => b.activityId === currentActivityId);
            } else {
                branches = [];
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹
        function getBranchName(branchId) {
            if (!branchId) return 'Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ';
            const branch = branches.find(b => b.id === branchId);
            return branch ? branch.name : 'ÙØ±Ø¹ Ù…Ø­Ø°ÙˆÙ';
        }

        // ===== Search Functions =====
        function searchItems() {
            const searchTerm = document.getElementById('searchItems').value.toLowerCase();
            const filteredItems = items.filter(item => 
                item.name.toLowerCase().includes(searchTerm) || 
                item.code.toLowerCase().includes(searchTerm)
            );
            renderFilteredItems(filteredItems);
        }

        function renderFilteredItems(filteredItems) {
            const tbody = document.getElementById('itemsList');
            tbody.innerHTML = '';
            if (filteredItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</td></tr>';
                return;
            }
            filteredItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Ø§Ù„ÙƒÙˆØ¯">${item.code}</td>
                    <td data-label="Ø§Ù„Ø§Ø³Ù…">${item.name}</td>
                    <td data-label="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">${item.cost}</td>
                    <td data-label="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">${item.price}</td>
                    <td data-label="Ø§Ù„Ø±ØµÙŠØ¯">${item.stock}</td>
                    <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                     <div class="action-buttons">
                        <button class="btn-warning edit-btn" onclick="editItem(${item.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger" onclick="deleteItem(${item.id})">Ø­Ø°Ù</button>
                    </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
function newPurchaseReturn() {
    activePurchaseReturn = null;
    document.getElementById('purchaseReturnInvoiceSearch').value = '';
    document.getElementById('purchaseReturnInvoiceDetails').style.display = 'none';
    document.getElementById('purchaseReturnItemsContainer').style.display = 'none';
    document.getElementById('purchaseReturnItemsList').innerHTML = '';
    document.getElementById('purchaseReturnTotal').textContent = '0.00';
}

function findPurchaseForReturn() {
    const invoiceNumber = parseInt(document.getElementById('purchaseReturnInvoiceSearch').value);
    if (isNaN(invoiceNumber)) {
        showNotification('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ØµØ­ÙŠØ­', 'warning');
        return;
    }
    
    const purchase = purchases.find(p => p.number === invoiceNumber);
    if (!purchase) {
        showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…', 'error');
        newPurchaseReturn();
        return;
    }

    activePurchaseReturn = purchase;
    const supplier = suppliers.find(s => s.id === purchase.supplierId);
    
    const detailsDiv = document.getElementById('purchaseReturnInvoiceDetails');
    detailsDiv.innerHTML = `
        <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> PUR${purchase.number.toString().padStart(3, '0')}</p>
        <p><strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${purchase.date}</p>
    `;
    detailsDiv.style.display = 'block';

    const itemsTbody = document.getElementById('purchaseReturnItemsList');
    itemsTbody.innerHTML = '';
    purchase.items.forEach(item => {
        const tr = document.createElement('tr');
        tr.dataset.itemId = item.id;
        tr.dataset.price = item.price;
        tr.innerHTML = `
            <td>${item.name}</td>
            <td>${item.price.toFixed(2)}</td>
            <td>${item.quantity}</td>
            <td><input type="number" class="return-item-qty-input" min="0" max="${item.quantity}" value="0" oninput="updatePurchaseReturnTotal()"></td>
        `;
        itemsTbody.appendChild(tr);
    });
    
    document.getElementById('purchaseReturnItemsContainer').style.display = 'block';
    updatePurchaseReturnTotal();
}

function updatePurchaseReturnTotal() {
    let total = 0;
    document.querySelectorAll('#purchaseReturnItemsList tr').forEach(tr => {
        const price = parseFloat(tr.dataset.price);
        const qty = parseInt(tr.querySelector('input').value) || 0;
        total += price * qty;
    });
    document.getElementById('purchaseReturnTotal').textContent = total.toFixed(2);
}

async function savePurchaseReturn() {
    if (!activePurchaseReturn) {
        showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø«', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        return;
    }
    
    const returnedItems = [];
    let totalReturnValue = 0;
    document.querySelectorAll('#purchaseReturnItemsList tr').forEach(tr => {
        const qty = parseInt(tr.querySelector('input').value) || 0;
        if (qty > 0) {
            const originalItem = activePurchaseReturn.items.find(i => i.id == tr.dataset.itemId);
            returnedItems.push({
                id: originalItem.id,
                name: originalItem.name,
                price: originalItem.price,
                quantity: qty
            });
            totalReturnValue += originalItem.price * qty;
        }
    });

    if (returnedItems.length === 0) {
        showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙ…ÙŠØ§Øª', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ ÙƒÙ…ÙŠØ§Øª Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹', 'warning');
        return;
    }

    returnedItems.forEach(returnedItem => {
        const itemInStock = items.find(i => i.id === returnedItem.id);
        if (itemInStock) {
            itemInStock.stock -= returnedItem.quantity;
        }
    });

    const newReturn = {
        id: Date.now(),
        number: currentPurchaseReturnNumber,
        date: new Date().toISOString().split('T')[0],
        originalInvoiceId: activePurchaseReturn.id,
        originalInvoiceNumber: activePurchaseReturn.number,
        supplierId: activePurchaseReturn.supplierId,
        items: returnedItems,
        total: totalReturnValue
    };

    const originalPurchaseIndex = purchases.findIndex(p => p.id === activePurchaseReturn.id);

    if (originalPurchaseIndex > -1) {
        const originalPurchase = purchases[originalPurchaseIndex];
        originalPurchase.total = roundCurrency((originalPurchase.total || 0) - totalReturnValue);
        originalPurchase.remainingAmount = roundCurrency((originalPurchase.remainingAmount || 0) - totalReturnValue);
        originalPurchase.notes = (originalPurchase.notes || '') + ` [Ù…Ø±ØªØ¬Ø¹ Ø¨Ù‚ÙŠÙ…Ø©: ${totalReturnValue.toFixed(2)}]`;
        debugLog('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©:', purchases[originalPurchaseIndex]);
    }

    purchaseReturns.push(newReturn);
    currentPurchaseReturnNumber++;
    
    const success1 = saveToLocalStorage('purchaseReturns', purchaseReturns);
    const success2 = saveToLocalStorage('items', items);
    const success3 = saveToLocalStorage('purchases', purchases); 
    
    if (success1 && success2 && success3) { 
        showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø±Ù‚Ù… S-PR${newReturn.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        newPurchaseReturn();
        renderPurchaseReturns();
        updateDashboard();
        renderItems();
        renderPurchasesList(); 
    } else {
        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}

function renderPurchaseReturns() {
    const tbody = document.getElementById('purchaseReturnsList');
    tbody.parentElement.querySelector('thead tr').innerHTML = `
        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
        <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    `;

    tbody.innerHTML = '';
    if (purchaseReturns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø´ØªØ±ÙŠØ§Øª</td></tr>';
        return;
    }
    purchaseReturns.forEach(pr => {
        const supplier = suppliers.find(s => s.id === pr.supplierId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>PR${pr.number.toString().padStart(3, '0')}</td>
            <td>${pr.date}</td>
            <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>PUR${pr.originalInvoiceNumber.toString().padStart(3, '0')}</td>
            <td>${pr.total.toFixed(2)}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-danger" onclick="deletePurchaseReturn(${pr.id})">Ø­Ø°Ù</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function searchCustomers() {
    const searchTerm = document.getElementById('searchCustomers').value.toLowerCase();
    const filteredCustomers = customers.filter(customer => 
        customer.name.toLowerCase().includes(searchTerm) || 
        customer.code.toLowerCase().includes(searchTerm) ||
                (customer.phone && customer.phone.toLowerCase().includes(searchTerm))
            );
            renderFilteredCustomers(filteredCustomers);
        }

        function renderFilteredCustomers(filteredCustomers) {
            const tbody = document.getElementById('customersList');
            tbody.innerHTML = '';
            if (filteredCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</td></tr>';
                return;
            }
            filteredCustomers.forEach(customer => {
                const tr = document.createElement('tr');
                tr.innerHTML = `

                    <td data-label="Ø§Ù„ÙƒÙˆØ¯">${customer.code}</td>
                    <td data-label="Ø§Ù„Ø§Ø³Ù…">${customer.name}</td>
                    <td data-label="Ø§Ù„Ù‡Ø§ØªÙ">${customer.phone || ''}</td>
                    <td data-label="Ø§Ù„Ø¨Ø±ÙŠØ¯">${customer.email || ''}</td>
                    <td data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">${customer.address || ''}</td>
                    <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                        <div class="action-buttons">
                            <button class="btn-warning edit-btn" onclick="editCustomer(${customer.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn-danger" onclick="deleteCustomer(${customer.id})">Ø­Ø°Ù</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function searchSuppliers() {
            const searchTerm = document.getElementById('searchSuppliers').value.toLowerCase();
            const filteredSuppliers = suppliers.filter(supplier => 
                supplier.name.toLowerCase().includes(searchTerm) || 
                supplier.code.toLowerCase().includes(searchTerm) ||
                (supplier.phone && supplier.phone.toLowerCase().includes(searchTerm))
            );
            renderFilteredSuppliers(filteredSuppliers);
        }

        function renderFilteredSuppliers(filteredSuppliers) {
            const tbody = document.getElementById('suppliersList');
            tbody.innerHTML = '';
            if (filteredSuppliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ±Ø¯ÙˆÙ† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</td></tr>';
                return;
            }
            filteredSuppliers.forEach(supplier => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td data-label="Ø§Ù„ÙƒÙˆØ¯">${supplier.code}</td>
                        <td data-label="Ø§Ù„Ø§Ø³Ù…">${supplier.name}</td>
                        <td data-label="Ø§Ù„Ù‡Ø§ØªÙ">${supplier.phone || ''}</td>
                        <td data-label="Ø§Ù„Ø¨Ø±ÙŠØ¯">${supplier.email || ''}</td>
                        <td data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">${supplier.address || ''}</td>
                        <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                            <div class="action-buttons">
                                <button class="btn-warning edit-btn" onclick="editSupplier(${supplier.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="btn-danger" onclick="deleteSupplier(${supplier.id})">Ø­Ø°Ù</button>
                            </div>
                        </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function searchSalaries() {
            const input = document.getElementById('searchSalaries');
            if (!input) return;
            const term = input.value.trim().toLowerCase();
            if (!term) {
                renderSalaries();
                return;
            }
            const filtered = salaries.filter(salary => {
                const nameMatch = (salary.employeeName || '').toLowerCase().includes(term);
                const idMatch = (salary.employeeId || '').toLowerCase().includes(term);
                const jobMatch = (salary.jobTitle || '').toLowerCase().includes(term);
                const monthMatch = (salary.month || '').toLowerCase().includes(term);
                return nameMatch || idMatch || jobMatch || monthMatch;
            });
            renderSalaries(filtered, true);
        }

        // ===== Items Functions =====
        function generateItemCode() {
            document.getElementById('itemCode').value = 'IT' + (items.length + 1).toString().padStart(3, '0');
        }

        async function addItem() {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            const validation = validateForm({
                itemName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') },
                    { validator: (v) => ValidationHelper.isUnique(v, items, 'name', 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') }
                ],
                itemCost: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡') }
                ],
                itemPrice: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹') },
                    { validator: (v) => ValidationHelper.isGreaterThanZero(v, 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹') }
                ],
                itemStock: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø§Ù„ÙƒÙ…ÙŠØ©') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'Ø§Ù„ÙƒÙ…ÙŠØ©') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const code = document.getElementById('itemCode').value;
            const name = document.getElementById('itemName').value.trim();
            const cost = document.getElementById('itemCost').value;
            const price = document.getElementById('itemPrice').value;
            const stock = document.getElementById('itemStock').value;

            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù...');

            try {
                const item = {
                    id: Date.now(),
                    code: code || 'IT' + (items.length + 1).toString().padStart(3, '0'),
                    name: name,
                    cost: parseFloat(cost) || 0,
                    price: parseFloat(price) || 0,
                    stock: parseInt(stock) || 0
                };

                items.push(item);
                const success = saveToLocalStorage('items', items);
                
                hideLoading();
                
                if (success) {
                    updateDashboard();
                    clearItemForm();
                    renderItems();
                    showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                } else {
                    items.pop(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙ†Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            } catch (error) {
                hideLoading();
                logError('Add Item', error);
            }
        }

function loadCustomersToSelect() {
    const select = document.getElementById('accountClientSelect');
    if (!select) return;
    
    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>';
    
    customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.name + ' - ' + (customer.code || '');
        select.appendChild(option);
    });
}

        function renderItems() {
            const tbody = document.getElementById('itemsList');
            tbody.innerHTML = '';
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
            let filteredItems = [...items];
            const searchText = document.getElementById('searchItems')?.value || '';
            
            // Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
            const filters = {
                searchText: searchText,
                priceFrom: document.getElementById('itemCostFrom')?.value,
                priceTo: document.getElementById('itemCostTo')?.value,
            };
            
            // Ø¥Ø¶Ø§ÙØ© ÙÙ„Ø§ØªØ± Ø¥Ø¶Ø§ÙÙŠØ©
            if (document.getElementById('itemPriceFrom')?.value) {
                filters.price = { 
                    from: parseFloat(document.getElementById('itemPriceFrom').value),
                    to: parseFloat(document.getElementById('itemPriceTo')?.value || Infinity)
                };
            }
            
            if (document.getElementById('itemStockFrom')?.value) {
                filters.quantity = {
                    from: parseFloat(document.getElementById('itemStockFrom').value),
                    to: parseFloat(document.getElementById('itemStockTo')?.value || Infinity)
                };
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… FilterSortHelper
            if (searchText) {
                filteredItems = filteredItems.filter(item => 
                    item.name.toLowerCase().includes(searchText.toLowerCase()) ||
                    item.code.toLowerCase().includes(searchText.toLowerCase())
                );
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡
            if (filters.priceFrom) {
                filteredItems = filteredItems.filter(item => parseFloat(item.cost) >= parseFloat(filters.priceFrom));
            }
            if (filters.priceTo) {
                filteredItems = filteredItems.filter(item => parseFloat(item.cost) <= parseFloat(filters.priceTo));
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹
            if (filters.price) {
                filteredItems = filteredItems.filter(item => {
                    const price = parseFloat(item.price);
                    return price >= filters.price.from && price <= filters.price.to;
                });
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø±ØµÙŠØ¯
            if (filters.quantity) {
                filteredItems = filteredItems.filter(item => {
                    const stock = parseFloat(item.stock);
                    return stock >= filters.quantity.from && stock <= filters.quantity.to;
                });
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
            const sortState = FilterSortHelper.currentSort['items'];
            if (sortState) {
                filteredItems = FilterSortHelper.sortData(filteredItems, sortState.column, sortState.direction);
            }
            
            if (filteredItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
                return;
            }
            
            filteredItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.code}</td>
                    <td>${item.name}</td>
                    <td>${item.cost}</td>
                    <td>${item.price}</td>
                    <td>${item.stock}</td>
                    <td>
                    <div class="action-buttons">
                        <button class="btn-warning edit-btn" onclick="editItem(${item.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger" onclick="deleteItem(${item.id})">Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ø£ØµÙ†Ø§Ù
        function applyItemsFilters() {
            renderItems();
        }
        
        function resetItemsFilters() {
            document.getElementById('itemCostFrom').value = '';
            document.getElementById('itemCostTo').value = '';
            document.getElementById('itemPriceFrom').value = '';
            document.getElementById('itemPriceTo').value = '';
            document.getElementById('itemStockFrom').value = '';
            document.getElementById('itemStockTo').value = '';
            renderItems();
        }

        function editItem(id) {
            const item = items.find(item => item.id === id);
            if (!item) return;
            
            document.getElementById('itemCode').value = item.code;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCost').value = item.cost;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemStock').value = item.stock;
            const addButton = document.querySelector('#items .btn-primary');
            addButton.textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù';
            addButton.onclick = function() { updateItem(id); };
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            applyEditMode('#items', 'itemName', '#items h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ù: ${item.name}`);
        }

        async function updateItem(id) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ø¹ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±
            const validation = validateForm({
                itemName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') },
                    { validator: (v) => ValidationHelper.isUnique(v, items, 'name', 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù', id) }
                ],
                itemCost: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡') }
                ],
                itemPrice: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹') },
                    { validator: (v) => ValidationHelper.isGreaterThanZero(v, 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹') }
                ],
                itemStock: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø§Ù„ÙƒÙ…ÙŠØ©') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'Ø§Ù„ÙƒÙ…ÙŠØ©') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('itemName').value.trim();

            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù...');

            try {
                const itemIndex = items.findIndex(item => item.id === id);
                if (itemIndex !== -1) {
                    const oldName = items[itemIndex].name; // Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
                    debugLog('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù:', { oldName, newName: name, itemId: id });
                    
                    items[itemIndex] = {
                        id: id,
                        code: document.getElementById('itemCode').value,
                        name: name,
                        cost: parseFloat(document.getElementById('itemCost').value) || 0,
                        price: parseFloat(document.getElementById('itemPrice').value) || 0,
                        stock: parseInt(document.getElementById('itemStock').value) || 0
                    };
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ÙÙŠ Ø¬Ù…ÙŠØ¹ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                    let salesUpdated = false;
                    let salesCount = 0;
                    sales.forEach(sale => {
                        sale.items.forEach(item => {
                            if (item.id === id || item.name === oldName) {
                                item.name = name;
                                salesUpdated = true;
                                salesCount++;
                            }
                        });
                    });
                    debugLog(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${salesCount} ØµÙ†Ù ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª`);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ÙÙŠ Ø¬Ù…ÙŠØ¹ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
                    let purchasesCount = 0;
                    purchases.forEach(purchase => {
                        purchase.items.forEach(item => {
                            if (item.id === id || item.name === oldName) {
                                item.name = name;
                                purchasesCount++;
                            }
                        });
                    });
                    debugLog(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${purchasesCount} ØµÙ†Ù ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª`);
                    
                    const success = saveToLocalStorage('items', items);
                    const salesSuccess = salesUpdated ? saveToLocalStorage('sales', sales) : true;
                    const purchasesSuccess = saveToLocalStorage('purchases', purchases);
                    
                    debugLog('ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', { success, salesSuccess, purchasesSuccess });
                    
                    hideLoading();
                    
                    if (success && salesSuccess && purchasesSuccess) {
                        updateDashboard();
                        clearItemForm();
                        renderItems();
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù…ÙØªÙˆØ­Ø©
                        if (document.getElementById('advanced-dashboard') && 
                            document.getElementById('advanced-dashboard').classList.contains('active')) {
                            debugLog('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...');
                            updateLiveStats();
                        }
                        
                        const addButton = document.querySelector('#items .btn-primary');
                        addButton.textContent = 'â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù';
                        addButton.onclick = addItem;
                        showNotification('âœ… Ù†Ø¬Ø§Ø­', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­!\n- ØªÙ… ØªØ­Ø¯ÙŠØ« ${salesCount} ØµÙ†Ù ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª\n- ØªÙ… ØªØ­Ø¯ÙŠØ« ${purchasesCount} ØµÙ†Ù ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª`, 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            } catch (error) {
                hideLoading();
                logError('Update Item', error);
            }
        }

        async function deleteItem(id) {
            const confirmed = await showConfirmDialog({
                title: 'ğŸ—‘ï¸ Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…Ø§Ù‹.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„Ù‡',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            
            if (confirmed) {
                showLoading('Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„ØµÙ†Ù...');
                
                try {
                    const item = items.find(i => i.id === id);
                    if (!item) {
                        hideLoading();
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                        return;
                    }
                    
                    // Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                    moveToTrash('items', item);
                    
                    // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©
                    const itemsCopy = [...items];
                    items = items.filter(item => item.id !== id);
                    const success = saveToLocalStorage('items', items);
                    
                    hideLoading();
                    
                    if (success) {
                        renderItems();
                        updateDashboard();
                        updateTrashBadge();
                    } else {
                        items = itemsCopy; // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
                        showNotification(
                            'âŒ Ø®Ø·Ø£',
                            'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                            'error'
                        );
                    }
                } catch (error) {
                    hideLoading();
                    logError('Delete Item', error);
                }
            }
        }

        function clearItemForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemCost').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemStock').value = '';
            const addButton = document.querySelector('#items .btn-primary');
            addButton.textContent = 'â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù';
            addButton.onclick = addItem;
            generateItemCode(); // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ±ÙŠØº
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            removeEditMode('#items', '#items h2', 'ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatItems" class="stat-mini-number">0</span></span>');
        }
        
        // ===== Customers Functions =====
        function generateCustomerCode() {
            document.getElementById('customerCode').value = 'CU' + (customers.length + 1).toString().padStart(3, '0');
        }

        async function addCustomer() {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            const validation = validateForm({
                customerName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') },
                    { validator: (v) => ValidationHelper.isUnique(v, customers, 'name', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') }
                ],
                customerPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') }
                ],
                customerEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('customerName').value.trim();

            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„...');

            try {
                const customer = {
                    id: Date.now(),
                    code: document.getElementById('customerCode').value || 'CU' + (customers.length + 1).toString().padStart(3, '0'),
                    name: name,
                    phone: document.getElementById('customerPhone').value,
                    email: document.getElementById('customerEmail').value,
                    address: document.getElementById('customerAddress').value
                };
                customers.push(customer);
                const success = saveToLocalStorage('customers', customers);
                
                hideLoading();
                
                if (success) {
                    updateDashboard();
                    clearCustomerForm();
                    renderCustomers();
                    showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    loadCustomersToSelect();

                } else {
                    customers.pop();
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            } catch (error) {
                hideLoading();
                logError('Add Customer', error);
            }
        }

        function renderCustomers() {
            const tbody = document.getElementById('customersList');
            tbody.innerHTML = '';
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
            let filteredCustomers = [...customers];
            const searchText = document.getElementById('searchCustomers')?.value || '';
            
            if (searchText) {
                filteredCustomers = filteredCustomers.filter(customer => 
                    customer.name.toLowerCase().includes(searchText.toLowerCase()) ||
                    customer.code.toLowerCase().includes(searchText.toLowerCase()) ||
                    (customer.phone && customer.phone.includes(searchText)) ||
                    (customer.email && customer.email.toLowerCase().includes(searchText.toLowerCase())) ||
                    (customer.address && customer.address.toLowerCase().includes(searchText.toLowerCase()))
                );
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
            const sortState = FilterSortHelper.currentSort['customers'];
            if (sortState) {
                filteredCustomers = FilterSortHelper.sortData(filteredCustomers, sortState.column, sortState.direction);
            }

            if (filteredCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
                return;
            }

            filteredCustomers.forEach(customer => {
                const tr = document.createElement('tr');
                tr.innerHTML = `

                    <td>${customer.code}</td>
                    <td>${customer.name}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.email}</td>
                    <td>${customer.address}</td>
                    <td>

                               <div class="action-buttons">
                        <button class="btn-warning edit-btn" onclick="editCustomer(${customer.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger" onclick="deleteCustomer(${customer.id})">Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡
        function resetCustomersFilters() {
            document.getElementById('searchCustomers').value = '';
            renderCustomers();
        }

        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer) return;
            
            document.getElementById('customerCode').value = customer.code;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('customerEmail').value = customer.email;
            document.getElementById('customerAddress').value = customer.address;
            const addButton = document.querySelector('#customers .btn-primary');
            addButton.textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„';
            addButton.onclick = () => updateCustomer(id);
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            applyEditMode('#customers', 'customerName', '#customers h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customer.name}`);
        }

        async function updateCustomer(id) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ø¹ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±
            const validation = validateForm({
                customerName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') },
                    { validator: (v) => ValidationHelper.isUnique(v, customers, 'name', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', id) }
                ],
                customerPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') }
                ],
                customerEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('customerName').value.trim();

            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„...');

            try {
                const customerIndex = customers.findIndex(c => c.id === id);
                if (customerIndex !== -1) {
                    customers[customerIndex] = {
                        id: id,
                        code: document.getElementById('customerCode').value,
                        name: name,
                        phone: document.getElementById('customerPhone').value,
                        email: document.getElementById('customerEmail').value,
                        address: document.getElementById('customerAddress').value
                    };
                    const success = saveToLocalStorage('customers', customers);
                    
                    hideLoading();
                    
                    if (success) {
                        updateDashboard();
                        clearCustomerForm();
                        renderCustomers();
                        
                        const addButton = document.querySelector('#customers .btn-primary');
                        addButton.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„';
                        addButton.onclick = addCustomer;
                        
                        showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            } catch (error) {
                hideLoading();
                logError('Update Customer', error);
            }
        }

        async function deleteCustomer(id) {
            const confirmed = await showConfirmDialog({
                title: 'ğŸ—‘ï¸ Ù†Ù‚Ù„ Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…Ø§Ù‹.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„Ù‡',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            
            if (confirmed) {
                const customer = customers.find(c => c.id === id);
                if (customer) {
                    moveToTrash('customers', customer);
                    customers = customers.filter(c => c.id !== id);
                    const success = saveToLocalStorage('customers', customers);
                    if (success) {
                        renderCustomers();
                        updateDashboard();
                        showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            }
        }

        async function clearCustomerForm() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            const confirmed = await confirmCancelEdit('#customers');
            if (!confirmed) return;
            
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerAddress').value = '';
            const addButton = document.querySelector('#customers .btn-primary');
            addButton.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„';
            addButton.onclick = addCustomer;
            generateCustomerCode(); // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ±ÙŠØº
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            removeEditMode('#customers', '#customers h2', 'ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatCustomers" class="stat-mini-number">0</span></span>');
        }

        // ===== Suppliers Functions =====
        function generateSupplierCode() {
            document.getElementById('supplierCode').value = 'SU' + (suppliers.length + 1).toString().padStart(3, '0');
        }

        async function addSupplier() {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            const validation = validateForm({
                supplierName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') },
                    { validator: (v) => ValidationHelper.isUnique(v, suppliers, 'name', 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') }
                ],
                supplierPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') }
                ],
                supplierEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('supplierName').value.trim();

            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ±Ø¯...');

            try {
                const supplier = {
                    id: Date.now(),
                    code: document.getElementById('supplierCode').value || 'SU' + (suppliers.length + 1).toString().padStart(3, '0'),
                    name: name,
                    phone: document.getElementById('supplierPhone').value,
                    email: document.getElementById('supplierEmail').value,
                    address: document.getElementById('supplierAddress').value
                };
                suppliers.push(supplier);
                const success = saveToLocalStorage('suppliers', suppliers);
                
                hideLoading();
                
                if (success) {
                    updateDashboard();
                    clearSupplierForm();
                    renderSuppliers();
                    showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                } else {
                    suppliers.pop();
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            } catch (error) {
                hideLoading();
                logError('Add Supplier', error);
            }
        }

        function renderSuppliers() {
            const tbody = document.getElementById('suppliersList');
            tbody.innerHTML = '';
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
            let filteredSuppliers = [...suppliers];
            const searchText = document.getElementById('searchSuppliers')?.value || '';
            
            if (searchText) {
                filteredSuppliers = filteredSuppliers.filter(supplier => 
                    supplier.name.toLowerCase().includes(searchText.toLowerCase()) ||
                    supplier.code.toLowerCase().includes(searchText.toLowerCase()) ||
                    (supplier.phone && supplier.phone.includes(searchText)) ||
                    (supplier.email && supplier.email.toLowerCase().includes(searchText.toLowerCase())) ||
                    (supplier.address && supplier.address.toLowerCase().includes(searchText.toLowerCase()))
                );
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
            const sortState = FilterSortHelper.currentSort['suppliers'];
            if (sortState) {
                filteredSuppliers = FilterSortHelper.sortData(filteredSuppliers, sortState.column, sortState.direction);
            }

            if (filteredSuppliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
                return;
            }

            filteredSuppliers.forEach(supplier => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${supplier.code}</td>
                    <td>${supplier.name}</td>
                    <td>${supplier.phone}</td>
                    <td>${supplier.email}</td>
                    <td>${supplier.address}</td>
                    <td>
                    <div class="action-buttons">
                        <button class="btn-warning edit-btn" onclick="editSupplier(${supplier.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger" onclick="deleteSupplier(${supplier.id})">Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        function resetSuppliersFilters() {
            document.getElementById('searchSuppliers').value = '';
            renderSuppliers();
        }

        function editSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (!supplier) return;
            
            document.getElementById('supplierCode').value = supplier.code;
            document.getElementById('supplierName').value = supplier.name;
            document.getElementById('supplierPhone').value = supplier.phone;
            document.getElementById('supplierEmail').value = supplier.email;
            document.getElementById('supplierAddress').value = supplier.address;
            const addButton = document.querySelector('#suppliers .btn-primary');
            addButton.textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ±Ø¯';
            addButton.onclick = () => updateSupplier(id);
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            applyEditMode('#suppliers', 'supplierName', '#suppliers h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯: ${supplier.name}`);
        }

        async function updateSupplier(id) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ø¹ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±
            const validation = validateForm({
                supplierName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') },
                    { validator: (v) => ValidationHelper.isUnique(v, suppliers, 'name', 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯', id) }
                ],
                supplierPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') }
                ],
                supplierEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('supplierName').value.trim();

            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ±Ø¯...');

            try {
                const supplierIndex = suppliers.findIndex(s => s.id === id);
                if (supplierIndex !== -1) {
                    suppliers[supplierIndex] = {
                        id: id,
                        code: document.getElementById('supplierCode').value,
                        name: name,
                        phone: document.getElementById('supplierPhone').value,
                        email: document.getElementById('supplierEmail').value,
                        address: document.getElementById('supplierAddress').value
                    };
                    const success = saveToLocalStorage('suppliers', suppliers);
                    
                    hideLoading();
                    
                    if (success) {
                        updateDashboard();
                        clearSupplierForm();
                        renderSuppliers();
                        
                        const addButton = document.querySelector('#suppliers .btn-primary');
                        addButton.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯';
                        addButton.onclick = addSupplier;
                        
                        showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            } catch (error) {
                hideLoading();
                logError('Update Supplier', error);
            }
        }

        async function deleteSupplier(id) {
            const confirmed = await showConfirmDialog({
                title: 'ğŸ—‘ï¸ Ù†Ù‚Ù„ Ù…ÙˆØ±Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…Ø§Ù‹.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„Ù‡',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            
            if (confirmed) {
                const supplier = suppliers.find(s => s.id === id);
                if (supplier) {
                    moveToTrash('suppliers', supplier);
                    suppliers = suppliers.filter(s => s.id !== id);
                    const success = saveToLocalStorage('suppliers', suppliers);
                    if (success) {
                        renderSuppliers();
                        updateDashboard();
                        showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            }
        }

        async function clearSupplierForm() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            const confirmed = await confirmCancelEdit('#suppliers');
            if (!confirmed) return;
            
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierAddress').value = '';
            const addButton = document.querySelector('#suppliers .btn-primary');
            addButton.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯';
            addButton.onclick = addSupplier;
            generateSupplierCode(); // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ±ÙŠØº
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            removeEditMode('#suppliers', '#suppliers h2', 'ğŸª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatSuppliers" class="stat-mini-number">0</span></span>');
        }
        
        // ===== General Invoice Functions =====
        function resetInvoiceForms() {
            editingSaleId = null;
            editingPurchaseId = null;
            newSale();
            newPurchase();
        }

        // ===== Purchases Functions =====
        function generatePurchaseCode() {
            document.getElementById('purchaseCode').value = 'PUR' + currentPurchaseNumber.toString().padStart(3, '0');
        }
        
        function updatePurchaseDropdowns() {
            const supplierSelect = document.getElementById('purchaseSupplier');
            const itemSelect = document.getElementById('purchaseItem');
            
            supplierSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯</option>';
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name;
                supplierSelect.appendChild(option);
            });

            itemSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (${item.stock} Ù…ØªÙˆÙØ±)`;
                option.dataset.price = item.cost;
                itemSelect.appendChild(option);
            });
            
            // ğŸª ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙØ±ÙˆØ¹
            updateBranchDropdowns();
            
            renderPurchasesList();
        }
        
        function addPurchaseItem() {
            const itemId = parseInt(document.getElementById('purchaseItem').value);
            const quantity = parseInt(document.getElementById('purchaseQuantity').value);
            const unit = document.getElementById('purchaseUnit').value;
            const price = parseFloat(document.getElementById('purchasePrice').value);
            
            if (!itemId || !quantity || !unit || isNaN(price)) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'warning');
                return;
            }
            
            const item = items.find(i => i.id === itemId);
            if (!item) {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }
            
            const existingItem = currentPurchaseItems.find(i => i.id === itemId && i.unit === unit);
            if (existingItem) {
                existingItem.quantity += quantity;
                existingItem.total = existingItem.quantity * existingItem.price;
            } else {
                currentPurchaseItems.push({
                    id: itemId,
                    name: item.name,
                    quantity: quantity,
                    unit: unit,
                    price: price,
                    total: quantity * price
                });
            }
            
            renderPurchaseItems();
            updatePurchaseTotals();
            
            document.getElementById('purchaseItem').value = '';
            document.getElementById('purchaseQuantity').value = '1';
            document.getElementById('purchasePrice').value = '';
        }
        
        function renderPurchaseItems() {
            const tbody = document.getElementById('purchaseItemsList');
            tbody.innerHTML = '';
            
            if (currentPurchaseItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù</td></tr>';
                return;
            }
            
            currentPurchaseItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit || 'Ù‚Ø·Ø¹Ø©'}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.total.toFixed(2)}</td>
                    <td>
                        <button class="btn-danger" onclick="removePurchaseItem(${index})">Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function removePurchaseItem(index) {
            currentPurchaseItems.splice(index, 1);
            renderPurchaseItems();
            updatePurchaseTotals();
        }
        
        function updatePurchaseTotals() {
            const subtotal = currentPurchaseItems.reduce((sum, item) => sum + item.total, 0);
            const tax = subtotal * 0.15;
            const total = subtotal + tax;
            const paidAmount = parseFloat(document.getElementById('purchasePaidAmount').value) || 0;
            const remainingAmount = total - paidAmount;

            document.getElementById('purchaseSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('purchaseTax').textContent = tax.toFixed(2);
            document.getElementById('purchaseTotal').textContent = total.toFixed(2);
            
            const remainingEl = document.getElementById('purchaseRemainingAmount');
            remainingEl.textContent = remainingAmount.toFixed(2);
            remainingEl.className = remainingAmount <= 0 ? 'remaining-paid' : 'remaining-unpaid';
        }
        
       async function savePurchase() {
    const date = document.getElementById('purchaseDate').value;
    const supplierId = parseInt(document.getElementById('purchaseSupplier').value);
    const branchId = document.getElementById('purchaseBranch').value ? parseInt(document.getElementById('purchaseBranch').value) : null;
    const notes = document.getElementById('purchaseNotes').value;
    const paidAmount = parseFloat(document.getElementById('purchasePaidAmount').value) || 0;

    if (!date || !supplierId || currentPurchaseItems.length === 0) {
        showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù Ù„Ù„ÙØ§ØªÙˆØ±Ø©', 'warning');
        return;
    }
    
    const attachmentFile = document.getElementById('purchaseAttachment').files[0];
    let attachmentUrl = null;

    if (attachmentFile) {
        attachmentUrl = await uploadFile(attachmentFile, 'purchases');
        if (!attachmentUrl) {
            showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹', 'ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚ØŒ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
            return;
        }
    }
    
    const subtotal = currentPurchaseItems.reduce((sum, item) => sum + item.total, 0);
    const tax = subtotal * 0.15;
    const total = subtotal + tax;
    const remainingAmount = total - paidAmount;

    if (editingPurchaseId) {
        const purchaseIndex = purchases.findIndex(p => p.id === editingPurchaseId);
        if (purchaseIndex > -1) {
            const originalPurchase = purchases[purchaseIndex];
            
            originalPurchase.items.forEach(pi => {
                const item = items.find(i => i.id === pi.id);
                if (item) item.stock -= pi.quantity;
            });

            const updatedPurchase = {
                ...originalPurchase,
                date,
                supplierId,
                branchId,
                notes,
                paidAmount,
                items: [...currentPurchaseItems],
                subtotal,
                tax,
                total,
                remainingAmount,
                attachmentUrl: attachmentUrl || originalPurchase.attachmentUrl
            };

            purchases[purchaseIndex] = updatedPurchase;
            
            showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… PUR${originalPurchase.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
        }
    } else {
         const newPurchaseData = { 
             id: Date.now(), 
             number: currentPurchaseNumber, 
             date, 
             supplierId, 
             branchId,
             notes, 
             paidAmount, 
             items: [...currentPurchaseItems], 
             subtotal, 
             tax, 
             total, 
             remainingAmount,
             attachmentUrl: attachmentUrl 
         };
        purchases.push(newPurchaseData);
        currentPurchaseNumber++;
        showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… PUR${newPurchaseData.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
    }
    
    const success1 = saveToLocalStorage('purchases', purchases);
    
    currentPurchaseItems.forEach(pi => {
        const item = items.find(i => i.id === pi.id);
        if (item) item.stock += pi.quantity;
    });
    const success2 = saveToLocalStorage('items', items);
    
    if (success1 && success2) {
        newPurchase();
        updateDashboard();
        renderItems();
    } else {
        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}        
        async function newPurchase() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            const confirmed = await confirmCancelEdit('#purchases');
            if (!confirmed) return;
            
            currentPurchaseItems = [];
            editingPurchaseId = null;
            document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('purchaseSupplier').value = '';
            document.getElementById('purchaseSupplierName').value = '';
            document.getElementById('purchaseSupplierCode').value = '';
            document.getElementById('purchaseSupplierPhone').value = '';
            document.getElementById('purchaseSupplierAddress').value = '';
            document.getElementById('purchaseNotes').value = '';
            document.getElementById('purchasePaidAmount').value = '';
            generatePurchaseCode();
            document.getElementById('savePurchaseBtn').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            renderPurchaseItems();
            updatePurchaseTotals();
            renderPurchasesList();
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            removeEditMode('#purchases', '#purchases h2', 'ğŸ›’ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatPurchases" class="stat-mini-number">0</span></span>');
      
  }
  function renderPurchasesList() {
    const tbody = document.getElementById('purchasesList');
    tbody.innerHTML = '';
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
    let filteredPurchases = [...purchases];
    const searchText = document.getElementById('searchPurchases')?.value || '';
    
    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
    if (searchText) {
        filteredPurchases = filteredPurchases.filter(purchase => {
            const supplier = suppliers.find(s => s.id === purchase.supplierId);
            return (`pur${purchase.number}`.toLowerCase().includes(searchText.toLowerCase()) || 
                    (supplier && supplier.name.toLowerCase().includes(searchText.toLowerCase())) || 
                    purchase.date.includes(searchText));
        });
    }
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const dateFrom = document.getElementById('purchasesDateFrom')?.value;
    const dateTo = document.getElementById('purchasesDateTo')?.value;
    if (dateFrom) {
        filteredPurchases = filteredPurchases.filter(purchase => new Date(purchase.date) >= new Date(dateFrom));
    }
    if (dateTo) {
        filteredPurchases = filteredPurchases.filter(purchase => new Date(purchase.date) <= new Date(dateTo));
    }
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº
    const amountFrom = document.getElementById('purchasesAmountFrom')?.value;
    const amountTo = document.getElementById('purchasesAmountTo')?.value;
    if (amountFrom) {
        filteredPurchases = filteredPurchases.filter(purchase => purchase.total >= parseFloat(amountFrom));
    }
    if (amountTo) {
        filteredPurchases = filteredPurchases.filter(purchase => purchase.total <= parseFloat(amountTo));
    }
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
    const sortState = FilterSortHelper.currentSort['purchases'];
    if (sortState) {
        filteredPurchases = FilterSortHelper.sortData(filteredPurchases, sortState.column, sortState.direction);
    }
    
    if (filteredPurchases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>'; // ğŸ’¡ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø¥Ù„Ù‰ 9
        return;
    }
    
    // --- Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØµØ­ÙŠØ­ (Ø­Ù„Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) ---
    filteredPurchases.forEach(purchase => {
        const supplier = suppliers.find(s => s.id === purchase.supplierId);
        const totalQty = purchase.items.reduce((sum, item) => sum + item.quantity, 0);

        const remaining = purchase.remainingAmount ?? (purchase.total - (purchase.paidAmount || 0));
        const remainingClass = remaining > 0.01 ? 'remaining-unpaid' : (remaining < -0.01 ? 'remaining-credit' : 'remaining-paid');
        const remainingText = remaining.toFixed(2);
        
        const attachmentLink = purchase.attachmentUrl 
            ? `<a href="${purchase.attachmentUrl}" target="_blank" class="btn-info" style="padding: 4px 8px; text-decoration: none;">Ø¹Ø±Ø¶</a>`
            : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>PUR${purchase.number.toString().padStart(3, '0')}</td>
            <td>${purchase.date}</td>
            <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>${totalQty}</td>
            <td>${purchase.total.toFixed(2)}</td>
            <td>${(purchase.paidAmount || 0).toFixed(2)}</td>
            <td class="${remainingClass}">${remainingText}</td>
            <td>${attachmentLink}</td>
            <td>
            <div class="action-buttons">
                <button class="btn-secondary" onclick="printPurchaseInvoice(${purchase.id})">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                <button class="btn-warning edit-btn" onclick="editPurchase(${purchase.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn-danger" onclick="deletePurchase(${purchase.id})">Ø­Ø°Ù</button>
            </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
        function applyPurchasesFilters() {
            renderPurchasesList();
        }
        
        function resetPurchasesFilters() {
            document.getElementById('purchasesDateFrom').value = '';
            document.getElementById('purchasesDateTo').value = '';
            document.getElementById('purchasesAmountFrom').value = '';
            document.getElementById('purchasesAmountTo').value = '';
            document.getElementById('searchPurchases').value = '';
            renderPurchasesList();
        }

        function searchPurchases() {
            renderPurchasesList();
        }

        function renderFilteredPurchases(filtered) {
            // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù… ØªØ¹Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø© - ØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ ÙÙŠ renderPurchasesList
            renderPurchasesList();
        }

        function printPurchaseInvoice(purchaseId) {
            const purchase = purchases.find(p => p.id === purchaseId);
            if (!purchase) return;
            
            const supplier = suppliers.find(s => s.id === purchase.supplierId);
            
            // ØªØ­Ù…ÙŠÙ„ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· ÙˆØ§Ø³Ù…Ù‡
            const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
            if (currentActivity) {
                document.getElementById('printPurchaseActivityName').textContent = currentActivity.name;
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† localStorage
                const storageKey = `activity_${currentActivity.id}_data`;
                const activityData = JSON.parse(localStorage.getItem(storageKey));
                const logoImg = document.getElementById('printPurchaseActivityLogo');
                
                if (activityData && activityData.logo) {
                    logoImg.src = activityData.logo;
                    logoImg.style.display = 'block';
                } else {
                    logoImg.style.display = 'none';
                }
            }
            
            // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
            document.getElementById('printPurchaseDate').textContent = purchase.date;
            const now = new Date();
            document.getElementById('printPurchaseTime').textContent = now.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('printPurchaseNumber').textContent = purchase.number.toString().padStart(3, '0');
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯
            document.getElementById('printSupplierName').textContent = supplier ? supplier.name : '-----';
            
            // Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            const notesElement = document.getElementById('printPurchaseNotes');
            if (notesElement) {
                notesElement.textContent = purchase.notes || '-----';
            }
            
            // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù
            const itemsBody = document.getElementById('printPurchaseItems');
            itemsBody.innerHTML = '';
            purchase.items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${index + 1}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: right;">${item.name}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${item.quantity}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${item.unit || 'Ù‚Ø·Ø¹Ø©'}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${item.price.toFixed(2)}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; direction: ltr; font-weight: bold;">${item.total.toFixed(2)}</td>
                `;
                itemsBody.appendChild(tr);
            });
            
            // Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
            document.getElementById('printPurchaseSubtotal').textContent = (purchase.subtotal || 0).toFixed(2);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹
            const taxAmount = purchase.tax || 0;
            document.getElementById('printPurchaseTax').textContent = taxAmount.toFixed(2);
            const taxRow = document.getElementById('printPurchaseTaxRow');
            if (taxRow) taxRow.style.display = 'grid'; // Ø¥Ø¸Ù‡Ø§Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹
            
            document.getElementById('printPurchaseTotal').textContent = (purchase.total || 0).toFixed(2);
            document.getElementById('printPurchasePaid').textContent = (purchase.paidAmount || 0).toFixed(2);
            const remaining = (purchase.remainingAmount !== undefined) ? purchase.remainingAmount : ((purchase.total || 0) - (purchase.paidAmount || 0));
            document.getElementById('printPurchaseRemaining').textContent = remaining.toFixed(2);
            
            const printSection = document.getElementById('purchaseInvoicePrint');
            printSection.style.display = 'block';
            setTimeout(() => {
                window.print();
                printSection.style.display = 'none';
            }, 100);
        }
        
        async function deletePurchase(id) {
            const confirmed = await showConfirmDialog({
                title: 'ğŸ—‘ï¸ Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nâš ï¸ Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡Ø§',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡',
                icon: 'ğŸ“¦'
            });
            
            if (confirmed) {
                const pIndex = purchases.findIndex(p => p.id === id);
                if (pIndex > -1) {
                    const purchase = purchases[pIndex];
                    
                    // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª
                    purchase.items.forEach(pi => {
                        const item = items.find(i => i.id === pi.id);
                        if (item) item.stock -= pi.quantity;
                    });
                    saveToLocalStorage('items', items);
                    
                    // Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                    moveToTrash('purchases', purchase);
                    purchases.splice(pIndex, 1);
                    saveToLocalStorage('purchases', purchases);
                    
                    renderPurchasesList();
                    updateDashboard();
                    renderItems();
                    showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                }
            }
        }
        
        function editPurchase(id) {
            const purchase = purchases.find(p => p.id === id);
            if (!purchase) return;
            
            editingPurchaseId = id;
            currentPurchaseItems = JSON.parse(JSON.stringify(purchase.items));
            
            document.getElementById('purchaseDate').value = purchase.date;
            document.getElementById('purchaseSupplier').value = purchase.supplierId;
            document.getElementById('purchaseNotes').value = purchase.notes;
            document.getElementById('purchasePaidAmount').value = purchase.paidAmount || 0;
            document.getElementById('purchaseCode').value = `ØªØ¹Ø¯ÙŠÙ„ PUR${purchase.number.toString().padStart(3, '0')}`;
            document.getElementById('savePurchaseBtn').textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            
            renderPurchaseItems();
            updatePurchaseTotals();
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            const supplierName = suppliers.find(s => s.id === purchase.supplierId)?.name || 'Ø§Ù„Ù…ÙˆØ±Ø¯';
            applyEditMode('#purchases', 'purchaseSupplier', '#purchases h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${supplierName}`);
        }

        // ===== Sales Functions =====
        function generateSaleCode() {
            document.getElementById('saleCode').value = 'SAL' + currentSaleNumber.toString().padStart(3, '0');
        }
        
        function updateSaleDropdowns() {
            const customerSelect = document.getElementById('saleCustomer');
            const itemSelect = document.getElementById('saleItem');
            
            customerSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                customerSelect.appendChild(option);
            });

            itemSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (${item.stock} Ù…ØªÙˆÙØ±)`;
                option.dataset.price = item.price;
                itemSelect.appendChild(option);
            });
            
            // ğŸª ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙØ±ÙˆØ¹
            updateBranchDropdowns();
            
            renderSalesList();
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        function updateCustomerFields() {
            const customerSelect = document.getElementById('saleCustomer');
            const customerId = parseInt(customerSelect.value);
            const customer = customers.find(c => c.id === customerId);
            
            if (customer) {
                document.getElementById('saleCustomerName').value = customer.name || '';
                document.getElementById('saleCustomerCode').value = customer.code || '';
                document.getElementById('saleCustomerPhone').value = customer.phone || '';
                document.getElementById('saleCustomerAddress').value = customer.address || '';
            } else {
                document.getElementById('saleCustomerName').value = '';
                document.getElementById('saleCustomerCode').value = '';
                document.getElementById('saleCustomerPhone').value = '';
                document.getElementById('saleCustomerAddress').value = '';
            }
        }
        
        // ğŸª ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙØ±ÙˆØ¹ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
        function updateBranchDropdowns() {
            const activityBranches = branches.filter(b => b.activityId === currentActivityId);
            
            // Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©)
            const adminSelects = ['expenseBranchId', 'salaryBranchId', 'purchaseBranch'];
            
            // Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© Ø§Ù„Ø£Ø®Ø±Ù‰ (Ø¨Ø¯ÙˆÙ† Ø®ÙŠØ§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©)
            const regularSelects = ['saleBranch', 'revenueBranchId'];
            
            // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨ (Ù…Ø¹ Ø®ÙŠØ§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©)
            adminSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="general_admin">ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>';
                select.innerHTML += '<option value="">ğŸª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>';
                
                activityBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id;
                    option.textContent = branch.name;
                    select.appendChild(option);
                });
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                if (currentValue === 'general_admin' || currentValue === '' || activityBranches.find(b => b.id == currentValue)) {
                    select.value = currentValue;
                }
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø®ÙŠØ§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©)
            regularSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">ğŸª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>';
                
                activityBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id;
                    option.textContent = branch.name;
                    select.appendChild(option);
                });
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                if (currentValue && activityBranches.find(b => b.id == currentValue)) {
                    select.value = currentValue;
                }
            });
        }

        // === ğŸ“„ Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ ===
        
        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ù…Ù† localStorage
        function loadFooterSettings() {
            console.log('ğŸ¯ loadFooterSettings() CALLED!');
            try {
                const savedSettings = localStorage.getItem('footerSettings');
                const settings = savedSettings ? JSON.parse(savedSettings) : getDefaultFooterSettings();
                
                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©)
                const companyNameInput = document.getElementById('footerCompanyNameInput');
                if (companyNameInput) {
                    companyNameInput.value = settings.companyName || '';
                    document.getElementById('footerCompanyDescInput').value = settings.companyDesc || '';
                    document.getElementById('footerPhoneInput').value = settings.phone || '';
                    document.getElementById('footerEmailInput').value = settings.email || '';
                    document.getElementById('footerAddressInput').value = settings.address || '';
                    document.getElementById('footerTwitterInput').value = settings.twitterUrl || '';
                    document.getElementById('footerFacebookInput').value = settings.facebookUrl || '';
                    document.getElementById('footerInstagramInput').value = settings.instagramUrl || '';
                    document.getElementById('footerLinkedinInput').value = settings.linkedinUrl || '';
                    document.getElementById('footerCopyrightInput').value = settings.copyright || '';
                    document.getElementById('footerVersionInput').value = settings.version || '';
                }
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ
                updateFooterDisplay(settings);
                
                console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„:', error);
                // Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø£Ø¸Ù‡Ø± Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                updateFooterDisplay(getDefaultFooterSettings());
            }
        }
        
        // Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„
        function saveFooterSettings() {
            try {
                const settings = {
                    companyName: document.getElementById('footerCompanyNameInput').value.trim(),
                    companyDesc: document.getElementById('footerCompanyDescInput').value.trim(),
                    phone: document.getElementById('footerPhoneInput').value.trim(),
                    email: document.getElementById('footerEmailInput').value.trim(),
                    address: document.getElementById('footerAddressInput').value.trim(),
                    twitterUrl: document.getElementById('footerTwitterInput').value.trim(),
                    facebookUrl: document.getElementById('footerFacebookInput').value.trim(),
                    instagramUrl: document.getElementById('footerInstagramInput').value.trim(),
                    linkedinUrl: document.getElementById('footerLinkedinInput').value.trim(),
                    copyright: document.getElementById('footerCopyrightInput').value.trim(),
                    version: document.getElementById('footerVersionInput').value.trim()
                };
                
                localStorage.setItem('footerSettings', JSON.stringify(settings));
                updateFooterDisplay(settings);
                
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'error');
            }
        }
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ØªØ°ÙŠÙŠÙ„
        function updateFooterDisplay(settings) {
            try {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ
                const footerCompanyName = document.getElementById('footerCompanyName');
                const footerCompanyDesc = document.getElementById('footerCompanyDesc');
                const footerPhone = document.getElementById('footerPhone');
                const footerEmail = document.getElementById('footerEmail');
                const footerAddress = document.getElementById('footerAddress');
                const footerCopyright = document.getElementById('footerCopyright');
                const footerVersion = document.getElementById('footerVersion');
                
                if (footerCompanyName) footerCompanyName.textContent = settings.companyName || 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©';
                if (footerCompanyDesc) footerCompanyDesc.textContent = settings.companyDesc || 'ÙˆØµÙ Ù…Ø®ØªØµØ± Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ';
                if (footerPhone) footerPhone.textContent = settings.phone ? `ğŸ“ ${settings.phone}` : 'ğŸ“ +966 xx xxx xxxx';
                if (footerEmail) footerEmail.textContent = settings.email ? `âœ‰ï¸ ${settings.email}` : 'âœ‰ï¸ info@company.com';
                if (footerAddress) footerAddress.textContent = settings.address ? `ğŸ“ ${settings.address}` : 'ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†';
                if (footerCopyright) footerCopyright.textContent = settings.copyright || 'Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©';
                if (footerVersion) footerVersion.textContent = settings.version || 'Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.0';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„ÙØ§Ø±ØºØ© Ù…Ù†Ù‡Ø§
                const links = [
                    { id: 'footerTwitterLink', url: settings.twitterUrl },
                    { id: 'footerFacebookLink', url: settings.facebookUrl },
                    { id: 'footerInstagramLink', url: settings.instagramUrl },
                    { id: 'footerLinkedinLink', url: settings.linkedinUrl }
                ];
                
                links.forEach(link => {
                    const element = document.getElementById(link.id);
                    if (element) {
                        if (link.url) {
                            element.href = link.url;
                            element.style.display = 'inline-block';
                        } else {
                            element.href = '#';
                            element.style.display = 'none';
                        }
                    }
                });
                
                console.log('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¹Ù„Ù‰ DOM');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„:', error);
            } finally {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£)
                setTimeout(() => {
                    console.log('â° setTimeout fired - about to show footer...');
                    const footer = document.getElementById('appFooter');
                    if (footer) {
                        footer.style.opacity = '1';
                        console.log('âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ°ÙŠÙŠÙ„');
                    } else {
                        console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± Ø§Ù„ØªØ°ÙŠÙŠÙ„ #appFooter');
                    }
                }, 50);
            }
        }
        
        // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        function getDefaultFooterSettings() {
            return {
                companyName: 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©',
                companyDesc: 'ÙˆØµÙ Ù…Ø®ØªØµØ± Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ',
                phone: '+966 xx xxx xxxx',
                email: 'info@company.com',
                address: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†',
                twitterUrl: '',
                facebookUrl: '',
                instagramUrl: '',
                linkedinUrl: '',
                copyright: 'Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©',
                version: 'Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.0'
            };
        }
        
        // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function openFooterSettingsModal() {
            const modal = document.getElementById('footerSettingsModal');
            if (modal) {
                modal.style.display = 'flex';
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„
                loadFooterSettings();
            }
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function closeFooterSettingsModal() {
            const modal = document.getElementById('footerSettingsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function saveFooterSettingsFromModal() {
            saveFooterSettings();
            closeFooterSettingsModal();
        }
        
        // === Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ ===
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        function updateSupplierFields() {
            const supplierSelect = document.getElementById('purchaseSupplier');
            const supplierId = parseInt(supplierSelect.value);
            const supplier = suppliers.find(s => s.id === supplierId);
            
            if (supplier) {
                document.getElementById('purchaseSupplierName').value = supplier.name || '';
                document.getElementById('purchaseSupplierCode').value = supplier.code || '';
                document.getElementById('purchaseSupplierPhone').value = supplier.phone || '';
                document.getElementById('purchaseSupplierAddress').value = supplier.address || '';
            } else {
                document.getElementById('purchaseSupplierName').value = '';
                document.getElementById('purchaseSupplierCode').value = '';
                document.getElementById('purchaseSupplierPhone').value = '';
                document.getElementById('purchaseSupplierAddress').value = '';
            }
        }
        
        function addSaleItem() {
            const itemId = parseInt(document.getElementById('saleItem').value);
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const unit = document.getElementById('saleUnit').value;
            const price = parseFloat(document.getElementById('salePrice').value);
            
            if (!itemId || !quantity || !unit || isNaN(price)) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'warning');
                return;
            }
            
            const item = items.find(i => i.id === itemId);
            if (!item) {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }
            
            const existingInCart = currentSaleItems.find(i => i.id === itemId && i.unit === unit);
            const qtyInCart = existingInCart ? existingInCart.quantity : 0;

            if (item.stock < (quantity + qtyInCart)) {
                showNotification('âš ï¸ Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙ', `Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${quantity + qtyInCart}) ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©. Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${item.stock}`, 'warning', 6000);
                return;
            }
            
            if (existingInCart) {
                existingInCart.quantity += quantity;
                existingInCart.total = existingInCart.quantity * existingInCart.price;
            } else {
                currentSaleItems.push({ id: itemId, name: item.name, quantity, unit: unit, price, total: quantity * price });
            }
            
            renderSaleItems();
            updateSaleTotals();
            
            document.getElementById('saleItem').value = '';
            document.getElementById('saleQuantity').value = '1';
            document.getElementById('salePrice').value = '';
        }
        
        function renderSaleItems() {
            const tbody = document.getElementById('saleItemsList');
            tbody.innerHTML = '';
            if (currentSaleItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù</td></tr>';
                return;
            }
            currentSaleItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit || 'Ù‚Ø·Ø¹Ø©'}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.total.toFixed(2)}</td>
                    <td><button class="btn-danger" onclick="removeSaleItem(${index})">Ø­Ø°Ù</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function removeSaleItem(index) {
            currentSaleItems.splice(index, 1);
            renderSaleItems();
            updateSaleTotals();
        }
        
        function updateSaleTotals() {
            const subtotal = currentSaleItems.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
            const afterDiscount = Math.max(0, subtotal - discount); // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù‚ÙŠÙ… Ø³Ø§Ù„Ø¨Ø©
            const applyTax = document.getElementById('applySaleTax').checked;
            const tax = applyTax ? afterDiscount * 0.15 : 0;
            const total = afterDiscount + tax;
            const paidAmount = parseFloat(document.getElementById('salePaidAmount').value) || 0;
            const remainingAmount = total - paidAmount;

            document.getElementById('saleSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('saleAfterDiscount').textContent = afterDiscount.toFixed(2);
            document.getElementById('saleTax').textContent = tax.toFixed(2);
            document.getElementById('saleTotal').textContent = total.toFixed(2);
            
            const remainingEl = document.getElementById('saleRemainingAmount');
            remainingEl.textContent = remainingAmount.toFixed(2);
            remainingEl.className = remainingAmount <= 0 ? 'remaining-paid' : 'remaining-unpaid';
        }
        
        async function newSale() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            const confirmed = await confirmCancelEdit('#sales');
            if (!confirmed) return;
            
            currentSaleItems = [];
            editingSaleId = null;
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('saleCustomer').value = '';
            document.getElementById('saleCustomerName').value = '';
            document.getElementById('saleCustomerCode').value = '';
            document.getElementById('saleCustomerPhone').value = '';
            document.getElementById('saleCustomerAddress').value = '';
            document.getElementById('saleNotes').value = '';
            document.getElementById('saleDiscount').value = '';
            document.getElementById('salePaidAmount').value = '';
            document.getElementById('salePaymentMethod').value = 'cash';
            generateSaleCode();
            document.getElementById('saveSaleBtn').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            renderSaleItems();
            updateSaleTotals();
            renderSalesList();
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            removeEditMode('#sales', '#sales h2', 'ğŸ§¾ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatSales" class="stat-mini-number">0</span></span>');
        }

        async function saveSale() {
            const date = document.getElementById('saleDate').value;
            const customerId = parseInt(document.getElementById('saleCustomer').value);
            const branchId = document.getElementById('saleBranch').value ? parseInt(document.getElementById('saleBranch').value) : null;
            const notes = document.getElementById('saleNotes').value;
            const customerAddress = document.getElementById('saleCustomerAddress').value;
            const paidAmount = parseFloat(document.getElementById('salePaidAmount').value) || 0;
            const paymentMethod = document.getElementById('salePaymentMethod').value;
            const taxApplied = document.getElementById('applySaleTax').checked;

            if (!date || !customerId || currentSaleItems.length === 0) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù Ù„Ù„ÙØ§ØªÙˆØ±Ø©', 'warning');
                return;
            }
            
            const subtotal = currentSaleItems.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
            const afterDiscount = Math.max(0, subtotal - discount);
            const tax = taxApplied ? afterDiscount * 0.15 : 0;
            const total = afterDiscount + tax;
            const remainingAmount = total - paidAmount;

            if (editingSaleId) {
                const saleIndex = sales.findIndex(s => s.id === editingSaleId);
                if (saleIndex > -1) {
                    const originalSale = sales[saleIndex];
                    
                    originalSale.items.forEach(si => {
                        const item = items.find(i => i.id === si.id);
                        if (item) item.stock += si.quantity;
                    });

                    const updatedSale = {
                        ...originalSale,
                        date,
                        customerId,
                        branchId,
                        notes,
                        customerAddress,
                        paidAmount,
                        paymentMethod,
                        items: [...currentSaleItems],
                        subtotal,
                        discount,
                        afterDiscount,
                        tax,
                        total,
                        remainingAmount,
                        taxApplied
                    };
                    
                    sales[saleIndex] = updatedSale;
                    
                    showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… SAL${originalSale.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                }
            } else {
                const newSaleData = { id: Date.now(), number: currentSaleNumber, date, customerId, branchId, notes, customerAddress, paidAmount, paymentMethod, items: [...currentSaleItems], subtotal, discount, afterDiscount, tax, total, remainingAmount, taxApplied };
                sales.push(newSaleData);
                currentSaleNumber++;
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… SAL${newSaleData.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
            }
            
            const success1 = saveToLocalStorage('sales', sales);
            
            currentSaleItems.forEach(si => {
                const item = items.find(i => i.id === si.id);
                if (item) item.stock -= si.quantity;
            });
            const success2 = saveToLocalStorage('items', items);
            
            if (success1 && success2) {
                newSale();
                updateDashboard();
                renderItems();
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }
        
        function renderSalesList() {
            const tbody = document.getElementById('salesList');
            tbody.innerHTML = '';
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
    let filteredSales = [...sales];
    const searchText = document.getElementById('searchSales')?.value || '';
    
    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
    if (searchText) {
        filteredSales = filteredSales.filter(sale => {
            const customer = customers.find(c => c.id === sale.customerId);
            return (`sal${sale.number}`.toLowerCase().includes(searchText.toLowerCase()) || 
                    (customer && customer.name.toLowerCase().includes(searchText.toLowerCase())) || 
                    sale.date.includes(searchText));
        });
    }
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const dateFrom = document.getElementById('salesDateFrom')?.value;
    const dateTo = document.getElementById('salesDateTo')?.value;
    if (dateFrom) {
        filteredSales = filteredSales.filter(sale => new Date(sale.date) >= new Date(dateFrom));
    }
    if (dateTo) {
        filteredSales = filteredSales.filter(sale => new Date(sale.date) <= new Date(dateTo));
    }
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº
    const amountFrom = document.getElementById('salesAmountFrom')?.value;
    const amountTo = document.getElementById('salesAmountTo')?.value;
    if (amountFrom) {
        filteredSales = filteredSales.filter(sale => sale.total >= parseFloat(amountFrom));
    }
    if (amountTo) {
        filteredSales = filteredSales.filter(sale => sale.total <= parseFloat(amountTo));
    }
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
    const paymentMethodFilter = document.getElementById('salesPaymentMethodFilter')?.value;
    if (paymentMethodFilter) {
        filteredSales = filteredSales.filter(sale => (sale.paymentMethod || 'cash') === paymentMethodFilter);
    }
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
    const sortState = FilterSortHelper.currentSort['sales'];
    if (sortState) {
        filteredSales = FilterSortHelper.sortData(filteredSales, sortState.column, sortState.direction);
    }
    
    if (filteredSales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
        return;
    }
    
    filteredSales.forEach(sale => {
        const customer = customers.find(c => c.id === sale.customerId);
        const totalQty = sale.items.reduce((sum, item) => sum + item.quantity, 0);
        
        // --- ğŸ’¡ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
        const remaining = sale.remainingAmount ?? (sale.total - (sale.paidAmount || 0));
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
        // remaining-unpaid: Ø£Ø­Ù…Ø± (Ø¹Ù„ÙŠÙ‡ ÙÙ„ÙˆØ³)
        // remaining-credit: Ø£Ø®Ø¶Ø± (Ù„Ù‡ ÙÙ„ÙˆØ³)
        // remaining-paid: Ø£Ø³ÙˆØ¯ (Ø§Ù„Ø±ØµÙŠØ¯ ØµÙØ±)
        const remainingClass = remaining > 0.01 ? 'remaining-unpaid' : (remaining < -0.01 ? 'remaining-credit' : 'remaining-paid');
        const remainingText = remaining.toFixed(2);
        // --- ğŸ’¡ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ---

        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
        const getPaymentMethodDisplay = (method) => {
            switch(method) {
                case 'cash': return 'ğŸ’° ÙƒØ§Ø´';
                case 'bank': return 'ğŸ¦ Ø¨Ù†Ùƒ';
                case 'mixed': return 'ğŸ”„ Ù…Ø®ØªÙ„Ø·';
                default: return 'ğŸ’° ÙƒØ§Ø´';
            }
        };

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td data-label="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©">SAL${sale.number.toString().padStart(3, '0')}</td>
            <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${sale.date}</td>
            <td data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„">${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td data-label="Ø§Ù„ÙƒÙ…ÙŠØ©">${totalQty}</td>
            <td data-label="Ø§Ù„Ø®ØµÙ…">${(sale.discount || 0).toFixed(2)}</td>
            <td data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ">${sale.total.toFixed(2)}</td>
            <td data-label="Ø§Ù„Ù…Ø¯ÙÙˆØ¹">${(sale.paidAmount || 0).toFixed(2)}</td>
            <td data-label="Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹">${getPaymentMethodDisplay(sale.paymentMethod)}</td>
            <td data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ" class="${remainingClass}">${remainingText}</td>
            <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                <div class="action-buttons">
                    <button class="btn-secondary" onclick="printSaleInvoice(${sale.id})">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button class="email-btn" onclick="emailSaleInvoice(${sale.id})">ğŸ“§ Ø¨Ø±ÙŠØ¯</button>
                    <button class="btn-whatsapp" onclick="sendWhatsAppInvoice(${sale.id})">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</button>
                    <button class="btn-warning edit-btn" onclick="editSale(${sale.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn-danger" onclick="deleteSale(${sale.id})">Ø­Ø°Ù</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
        function applySalesFilters() {
            renderSalesList();
        }
        
        function resetSalesFilters() {
            document.getElementById('salesDateFrom').value = '';
            document.getElementById('salesDateTo').value = '';
            document.getElementById('salesAmountFrom').value = '';
            document.getElementById('salesAmountTo').value = '';
            document.getElementById('salesPaymentMethodFilter').value = '';
            document.getElementById('searchSales').value = '';
            renderSalesList();
        }

        function searchSales() {
            renderSalesList();
        }

     function renderFilteredSales(filtered) {
    // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù… ØªØ¹Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø© - ØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ ÙÙŠ renderSalesList
    renderSalesList();
}

        function printSaleInvoice(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;
            
            const customer = customers.find(c => c.id === sale.customerId);
            
            // ØªØ­Ù…ÙŠÙ„ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· ÙˆØ§Ø³Ù…Ù‡
            const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
            if (currentActivity) {
                document.getElementById('printSaleActivityName').textContent = currentActivity.name;
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† localStorage
                const storageKey = `activity_${currentActivity.id}_data`;
                const activityData = JSON.parse(localStorage.getItem(storageKey));
                const logoImg = document.getElementById('printSaleActivityLogo');
                
                if (activityData && activityData.logo) {
                    logoImg.src = activityData.logo;
                    logoImg.style.display = 'block';
                } else {
                    logoImg.style.display = 'none';
                }
            }
            
            // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
            document.getElementById('printSaleDate').textContent = sale.date;
            const now = new Date();
            document.getElementById('printSaleTime').textContent = now.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('printSaleNumber').textContent = 'SAL' + sale.number.toString().padStart(3, '0');
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
            document.getElementById('printCustomerName').textContent = customer ? customer.name : '-----';
            document.getElementById('printCustomerCode').textContent = customer ? customer.code : '-----';
            document.getElementById('printCustomerPhone').textContent = customer ? customer.phone : '-----';
            document.getElementById('printCustomerAddress').textContent = sale.customerAddress || '-----';
            
            // Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            const notesElement = document.getElementById('printSaleNotes');
            if (notesElement) {
                notesElement.textContent = sale.notes || '-----';
            }
            
            // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù - Ø¯Ù…Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯
            const itemsBody = document.getElementById('printSaleItems');
            itemsBody.innerHTML = '';
            
            // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ ÙˆØ§Ø­Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù
            const tr = document.createElement('tr');
            
            // Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ³Ù„Ø³Ù„
            let numbersHtml = '';
            let codesHtml = '';
            let namesHtml = '';
            let quantitiesHtml = '';
            let unitsHtml = '';
            let pricesHtml = '';
            let totalsHtml = '';
            
            sale.items.forEach((item, index) => {
                const itemData = items.find(i => i.id === item.id);
                const itemCode = itemData ? itemData.code : '---';
                
                const separator = index < sale.items.length - 1 ? '<hr style="margin: 4px 0; border: none; border-top: 1px solid #ccc;">' : '';
                
                numbersHtml += `${index + 1}${separator}`;
                codesHtml += `${itemCode}${separator}`;
                namesHtml += `${item.name}${separator}`;
                quantitiesHtml += `${item.quantity}${separator}`;
                unitsHtml += `${item.unit || 'Ù‚Ø·Ø¹Ø©'}${separator}`;
                pricesHtml += `${item.price.toFixed(2)}${separator}`;
                totalsHtml += `${item.total.toFixed(2)}${separator}`;
            });
            
            tr.innerHTML = `
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${numbersHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${codesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: right; vertical-align: top; border-radius: 6px;">${namesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${quantitiesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${unitsHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${pricesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; vertical-align: top; direction: ltr; font-weight: bold; border-radius: 6px;">${totalsHtml}</td>
            `;
            itemsBody.appendChild(tr);
            
            // Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
            document.getElementById('printSaleSubtotal').textContent = (sale.subtotal || 0).toFixed(2);
            
            // Ø§Ù„Ø®ØµÙ… ÙˆÙ…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
            const discount = sale.discount || 0;
            const afterDiscount = sale.afterDiscount || ((sale.subtotal || 0) - discount);
            document.getElementById('printSaleDiscount').textContent = discount.toFixed(2);
            document.getElementById('printSaleAfterDiscount').textContent = afterDiscount.toFixed(2);
            
            // Ø¥Ø®ÙØ§Ø¡ Ø£Ùˆ Ø¥Ø¸Ù‡Ø§Ø± ØµÙ Ø§Ù„Ø®ØµÙ…
            const discountRow = document.getElementById('printSaleDiscountRow');
            if (discount > 0) {
                if (discountRow) discountRow.style.display = 'grid';
            } else {
                if (discountRow) discountRow.style.display = 'none';
            }
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ù‚ÙŠÙ…Ø© ÙØ¹Ù„ÙŠØ© Ø£Ùˆ 0.00)
            const taxAmount = sale.includeTax ? (sale.tax || 0) : 0;
            document.getElementById('printSaleTax').textContent = taxAmount.toFixed(2);
            const taxRow = document.getElementById('printSaleTaxRow');
            if (taxRow) taxRow.style.display = 'grid'; // Ø¥Ø¸Ù‡Ø§Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹
            
            document.getElementById('printSaleTotal').textContent = (sale.total || 0).toFixed(2);
            document.getElementById('printSalePaid').textContent = (sale.paidAmount || 0).toFixed(2);
            
            // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
            const getPaymentMethodText = (method) => {
                switch(method) {
                    case 'cash': return 'ğŸ’° ÙƒØ§Ø´';
                    case 'bank': return 'ğŸ¦ Ø¨Ù†Ùƒ';
                    case 'mixed': return 'ğŸ”„ Ù…Ø®ØªÙ„Ø·';
                    default: return 'ğŸ’° ÙƒØ§Ø´';
                }
            };
            document.getElementById('printSalePaymentMethod').textContent = getPaymentMethodText(sale.paymentMethod);
            
            const remaining = (sale.remainingAmount !== undefined) ? sale.remainingAmount : ((sale.total || 0) - (sale.paidAmount || 0));
            document.getElementById('printSaleRemaining').textContent = remaining.toFixed(2);
            
            const printSection = document.getElementById('saleInvoicePrint');
            printSection.style.display = 'block';
            setTimeout(() => {
                window.print();
                printSection.style.display = 'none';
            }, 100);
        }
        
        async function deleteSale(id) {
            const confirmed = await showConfirmDialog({
                title: 'ğŸ—‘ï¸ Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nâš ï¸ Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡Ø§',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡',
                icon: 'ğŸ“'
            });
            
            if (confirmed) {
                 const saleIndex = sales.findIndex(s => s.id === id);
                if (saleIndex > -1) {
                    const sale = sales[saleIndex];
                    
                    // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª
                    sale.items.forEach(si => {
                        const item = items.find(i => i.id === si.id);
                        if (item) item.stock += si.quantity;
                    });
                    saveToLocalStorage('items', items);
                    
                    // Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                    moveToTrash('sales', sale);
                    sales.splice(saleIndex, 1);
                    saveToLocalStorage('sales', sales);
                    
                    renderSalesList();
                    updateDashboard();
                    renderItems();
                    showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                }
            }
        }
        
        function editSale(id) {
            const sale = sales.find(s => s.id === id);
            if (!sale) return;
            
            editingSaleId = id;
            currentSaleItems = JSON.parse(JSON.stringify(sale.items));
            
            document.getElementById('saleDate').value = sale.date;
            document.getElementById('saleCustomer').value = sale.customerId;
            
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
            updateCustomerFields();
            
            document.getElementById('saleCustomerAddress').value = sale.customerAddress || '';
            document.getElementById('saleNotes').value = sale.notes;
            document.getElementById('saleDiscount').value = sale.discount || 0;
            document.getElementById('salePaidAmount').value = sale.paidAmount || 0;
            document.getElementById('salePaymentMethod').value = sale.paymentMethod || 'cash';
            document.getElementById('saleCode').value = `ØªØ¹Ø¯ÙŠÙ„ SAL${sale.number.toString().padStart(3, '0')}`;
            document.getElementById('saveSaleBtn').textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            
            document.getElementById('applySaleTax').checked = sale.taxApplied ?? true;
            
            renderSaleItems();
            updateSaleTotals();
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            const customerName = customers.find(c => c.id === sale.customerId)?.name || 'Ø§Ù„Ø¹Ù…ÙŠÙ„';
            applyEditMode('#sales', 'saleCustomer', '#sales h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${customerName}`);
        }

        // ===== Returns Functions =====
        function showReturnTab(type) {
            document.getElementById('salesReturnContent').classList.remove('active');
            document.getElementById('purchaseReturnContent').classList.remove('active');
            document.getElementById('salesReturnTabBtn').classList.remove('active');
            document.getElementById('purchasesReturnTabBtn').classList.remove('active');

            if (type === 'sales') {
                document.getElementById('salesReturnContent').classList.add('active');
                document.getElementById('salesReturnTabBtn').classList.add('active');
                newSaleReturn();
            } else {
                document.getElementById('purchaseReturnContent').classList.add('active');
                document.getElementById('purchasesReturnTabBtn').classList.add('active');
                newPurchaseReturn();
            }
        }
        
        function newSaleReturn() {
            activeSaleReturn = null;
            document.getElementById('salesReturnInvoiceSearch').value = '';
            document.getElementById('salesReturnInvoiceDetails').style.display = 'none';
            document.getElementById('salesReturnItemsContainer').style.display = 'none';
            document.getElementById('salesReturnItemsList').innerHTML = '';
            document.getElementById('salesReturnTotal').textContent = '0.00';
        }

        function findSaleForReturn() {
            const invoiceNumber = parseInt(document.getElementById('salesReturnInvoiceSearch').value);
            if (isNaN(invoiceNumber)) {
                showNotification('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ØµØ­ÙŠØ­', 'warning');
                return;
            }
            
            const sale = sales.find(s => s.number === invoiceNumber);
            if (!sale) {
                showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…', 'error');
                newSaleReturn();
                return;
            }

            activeSaleReturn = sale;
            const customer = customers.find(c => c.id === sale.customerId);
            
            const detailsDiv = document.getElementById('salesReturnInvoiceDetails');
            detailsDiv.innerHTML = `
                <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> SAL${sale.number.toString().padStart(3, '0')}</p>
                <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${sale.date}</p>
            `;
            detailsDiv.style.display = 'block';

            const itemsTbody = document.getElementById('salesReturnItemsList');
            itemsTbody.innerHTML = '';
            sale.items.forEach(item => {
                const tr = document.createElement('tr');
                tr.dataset.itemId = item.id;
                tr.dataset.price = item.price;
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td><input type="number" class="return-item-qty-input" min="0" max="${item.quantity}" value="0" oninput="updateSaleReturnTotal()"></td>
                `;
                itemsTbody.appendChild(tr);
            });
            
            document.getElementById('salesReturnItemsContainer').style.display = 'block';
            updateSaleReturnTotal();
        }

        function updateSaleReturnTotal() {
            let total = 0;
            document.querySelectorAll('#salesReturnItemsList tr').forEach(tr => {
                const price = parseFloat(tr.dataset.price);
                const qty = parseInt(tr.querySelector('input').value) || 0;
                total += price * qty;
            });
            document.getElementById('salesReturnTotal').textContent = total.toFixed(2);
        }

        async function saveSaleReturn() {
            if (!activeSaleReturn) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø«', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const returnedItems = [];
            let totalReturnValue = 0;
            document.querySelectorAll('#salesReturnItemsList tr').forEach(tr => {
                const qty = parseInt(tr.querySelector('input').value) || 0;
                if (qty > 0) {
                    const originalItem = activeSaleReturn.items.find(i => i.id == tr.dataset.itemId);
                    returnedItems.push({
                        id: originalItem.id,
                        name: originalItem.name,
                        price: originalItem.price,
                        quantity: qty
                    });
                    totalReturnValue += originalItem.price * qty;
                }
            });

            if (returnedItems.length === 0) {
                showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ ÙƒÙ…ÙŠØ§Øª Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹', 'warning');
                return;
            }

            returnedItems.forEach(returnedItem => {
                const itemInStock = items.find(i => i.id === returnedItem.id);
                if (itemInStock) {
                    itemInStock.stock += returnedItem.quantity;
                }
            });

            const newReturn = {
                id: Date.now(),
                number: currentSaleReturnNumber,
                date: new Date().toISOString().split('T')[0],
                originalInvoiceId: activeSaleReturn.id,
                originalInvoiceNumber: activeSaleReturn.number,
                customerId: activeSaleReturn.customerId,
                branchId: activeSaleReturn.branchId || null,
                items: returnedItems,
                total: totalReturnValue
            };


// --- ğŸ’¡ Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ---
            // 1. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            const originalSaleIndex = sales.findIndex(s => s.id === activeSaleReturn.id);
            
            if (originalSaleIndex > -1) {
                // 2. Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                const originalSale = sales[originalSaleIndex];
                
                // Ø®ØµÙ… Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ
                originalSale.total = roundCurrency((originalSale.total || 0) - totalReturnValue);
                originalSale.remainingAmount = roundCurrency((originalSale.remainingAmount || 0) - totalReturnValue);
                
                // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                originalSale.notes = (originalSale.notes || '') + ` [Ù…Ø±ØªØ¬Ø¹ Ø¨Ù‚ÙŠÙ…Ø©: ${totalReturnValue.toFixed(2)}]`;
                
                debugLog('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©:', sales[originalSaleIndex]);
            }
            // --- ğŸ’¡ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ---

            // Ø§Ù„Ø³Ø·Ø± 7930 ÙŠØ¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§
         salesReturns.push(newReturn);
            currentSaleReturnNumber++;
            
            const success1 = saveToLocalStorage('salesReturns', salesReturns);
            const success2 = saveToLocalStorage('items', items);
            const success3 = saveToLocalStorage('sales', sales); // <-- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: Ù„Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            
            if (success1 && success2 && success3) { // <-- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±Ø·: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ ÙƒÙ„ Ø´ÙŠØ¡
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø±Ù‚Ù… SR${newReturn.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                newSaleReturn();
                renderSalesReturns();
                updateDashboard();
                renderItems();
                renderSalesList(); // <-- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: Ù„ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

       function renderSalesReturns() {
    const tbody = document.getElementById('salesReturnsList');
    // ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
    tbody.parentElement.querySelector('thead tr').innerHTML = `
        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
        <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th> 
    `;

    tbody.innerHTML = '';
    if (salesReturns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Øª</td></tr>';
        return;
    }
    salesReturns.forEach(sr => {
        const customer = customers.find(c => c.id === sr.customerId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>SR${sr.number.toString().padStart(3, '0')}</td>
            <td>${sr.date}</td>
            <td>${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>SAL${sr.originalInvoiceNumber.toString().padStart(3, '0')}</td>
            <td>${sr.total.toFixed(2)}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-danger" onclick="deleteSaleReturn(${sr.id})">Ø­Ø°Ù</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

     function newPurchase() {
    currentPurchaseItems = [];
    editingPurchaseId = null;
    document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('purchaseSupplier').value = '';
    document.getElementById('purchaseNotes').value = '';
    document.getElementById('purchasePaidAmount').value = '';
    
    document.getElementById('purchaseAttachment').value = null;
    
    generatePurchaseCode();
    document.getElementById('savePurchaseBtn').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
    renderPurchaseItems();
    updatePurchaseTotals();
    renderPurchasesList();
}
        function findPurchaseForReturn() {
            const invoiceNumber = parseInt(document.getElementById('purchaseReturnInvoiceSearch').value);
            if (isNaN(invoiceNumber)) {
                showNotification('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ØµØ­ÙŠØ­', 'warning');
                return;
            }
            
            const purchase = purchases.find(p => p.number === invoiceNumber);
            if (!purchase) {
                showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…', 'error');
                newPurchaseReturn();
                return;
            }

            activePurchaseReturn = purchase;
            const supplier = suppliers.find(s => s.id === purchase.supplierId);
            
            const detailsDiv = document.getElementById('purchaseReturnInvoiceDetails');
            detailsDiv.innerHTML = `
                <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> PUR${purchase.number.toString().padStart(3, '0')}</p>
                <p><strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${purchase.date}</p>
            `;
            detailsDiv.style.display = 'block';

            const itemsTbody = document.getElementById('purchaseReturnItemsList');
            itemsTbody.innerHTML = '';
            purchase.items.forEach(item => {
                const tr = document.createElement('tr');
                tr.dataset.itemId = item.id;
                tr.dataset.price = item.price;
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td><input type="number" class="return-item-qty-input" min="0" max="${item.quantity}" value="0" oninput="updatePurchaseReturnTotal()"></td>
                `;
                itemsTbody.appendChild(tr);
            });
            
            document.getElementById('purchaseReturnItemsContainer').style.display = 'block';
            updatePurchaseReturnTotal();
        }

        function updatePurchaseReturnTotal() {
            let total = 0;
            document.querySelectorAll('#purchaseReturnItemsList tr').forEach(tr => {
                const price = parseFloat(tr.dataset.price);
                const qty = parseInt(tr.querySelector('input').value) || 0;
                total += price * qty;
            });
            document.getElementById('purchaseReturnTotal').textContent = total.toFixed(2);
        }

     async function savePurchaseReturn() {
            if (!activePurchaseReturn) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø«', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const returnedItems = [];
            let totalReturnValue = 0;
            document.querySelectorAll('#purchaseReturnItemsList tr').forEach(tr => {
                const qty = parseInt(tr.querySelector('input').value) || 0;
                if (qty > 0) {
                    const originalItem = activePurchaseReturn.items.find(i => i.id == tr.dataset.itemId);
                    returnedItems.push({
                        id: originalItem.id,
                        name: originalItem.name,
                        price: originalItem.price,
                        quantity: qty
                    });
                    totalReturnValue += originalItem.price * qty;
                }
            });

            if (returnedItems.length === 0) {
                showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙ…ÙŠØ§Øª', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ ÙƒÙ…ÙŠØ§Øª Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹', 'warning');
                return;
            }

            returnedItems.forEach(returnedItem => {
                const itemInStock = items.find(i => i.id === returnedItem.id);
                if (itemInStock) {
                    itemInStock.stock -= returnedItem.quantity;
                }
            });

            const newReturn = {
                id: Date.now(),
                number: currentPurchaseReturnNumber,
                date: new Date().toISOString().split('T')[0],
                originalInvoiceId: activePurchaseReturn.id,
                originalInvoiceNumber: activePurchaseReturn.number,
                supplierId: activePurchaseReturn.supplierId,
                branchId: activePurchaseReturn.branchId || null,
                items: returnedItems,
                total: totalReturnValue
            };

            // --- ğŸ’¡ Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ­Ø¯ÙŠØ« ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ© ---
            // 1. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            const originalPurchaseIndex = purchases.findIndex(p => p.id === activePurchaseReturn.id);

            if (originalPurchaseIndex > -1) {
                // 2. Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                const originalPurchase = purchases[originalPurchaseIndex];
                
                // Ø®ØµÙ… Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ
                originalPurchase.total = roundCurrency((originalPurchase.total || 0) - totalReturnValue);
                originalPurchase.remainingAmount = roundCurrency((originalPurchase.remainingAmount || 0) - totalReturnValue);
                
                // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                originalPurchase.notes = (originalPurchase.notes || '') + ` [Ù…Ø±ØªØ¬Ø¹ Ø¨Ù‚ÙŠÙ…Ø©: ${totalReturnValue.toFixed(2)}]`;
                
                debugLog('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©:', purchases[originalPurchaseIndex]);
            }
            // --- ğŸ’¡ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ---

            purchaseReturns.push(newReturn);
            currentPurchaseReturnNumber++;
            
            const success1 = saveToLocalStorage('purchaseReturns', purchaseReturns);
            const success2 = saveToLocalStorage('items', items);
            const success3 = saveToLocalStorage('purchases', purchases); // <-- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            
            if (success1 && success2 && success3) { // <-- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±Ø·
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…GitÂ¹S-PR${newReturn.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                newPurchaseReturn();
                renderPurchaseReturns();
                updateDashboard();
                renderItems();
                renderPurchasesList(); // <-- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }
function renderPurchaseReturns() {
    const tbody = document.getElementById('purchaseReturnsList');
    // ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
    tbody.parentElement.querySelector('thead tr').innerHTML = `
        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
        <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    `;

    tbody.innerHTML = '';
    if (purchaseReturns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø´ØªØ±ÙŠØ§Øª</td></tr>';
        return;
    }
    purchaseReturns.forEach(pr => {
        const supplier = suppliers.find(s => s.id === pr.supplierId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>PR${pr.number.toString().padStart(3, '0')}</td>
            <td>${pr.date}</td>
            <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>PUR${pr.originalInvoiceNumber.toString().padStart(3, '0')}</td>
            <td>${pr.total.toFixed(2)}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-danger" onclick="deletePurchaseReturn(${pr.id})">Ø­Ø°Ù</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

        function calculateTotalStock() {
            return items.reduce((total, item) => total + (parseInt(item.stock) || 0), 0);
        }

        // ===== Expenses and Revenues Functions =====
    async function addExpense() {
    const date = document.getElementById('expenseDate').value;
    const category = document.getElementById('expenseCategory').value;
    const amount = parseFloat(document.getElementById('expenseAmount').value);
    if (!date || !category || isNaN(amount)) { 
        showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning'); 
        return; 
    }

    const attachmentFile = document.getElementById('expenseAttachment').files[0];
    let attachmentUrl = null;

    if (attachmentFile) {
        attachmentUrl = await uploadFile(attachmentFile, 'expenses');
        if (!attachmentUrl) {
            showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹', 'ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚ØŒ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ', 'error');
            return;
        }
    }

    const expense = { 
        id: Date.now(), 
        date, 
        category, 
        amount, 
        description: document.getElementById('expenseDescription').value, 
        paymentMethod: document.getElementById('expensePaymentMethod').value, 
        reference: document.getElementById('expenseReference').value,
        branchId: document.getElementById('expenseBranchId').value || null,
        attachmentUrl: attachmentUrl 
    };
    
    expenses.push(expense);
    const success = saveToLocalStorage('expenses', expenses);
    if (success) {
        clearExpenseForm(); 
        renderExpenses();
        updateExpenseStats();
        updateDashboard();
    } else {
        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}
       function renderExpenses() {
    const tbody = document.getElementById('expensesList');
    tbody.innerHTML = '';
    if (expenses.length === 0) { 
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª</td></tr>'; // ğŸ’¡ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø¥Ù„Ù‰ 8
        return; 
    }
    
    [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(exp => {
        const tr = document.createElement('tr');
        
        const attachmentLink = exp.attachmentUrl 
            ? `<a href="${exp.attachmentUrl}" target="_blank" class="btn-info" style="padding: 4px 8px; text-decoration: none;">Ø¹Ø±Ø¶</a>`
            : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        
        tr.innerHTML = `
            <td>${exp.date}</td>
            <td>${exp.category}</td>
            <td>${exp.amount.toFixed(2)}</td>
            <td>${getPaymentMethodName(exp.paymentMethod)}</td>
            <td>${exp.description || '-'}</td>
            <td>${exp.reference || '-'}</td>
            <td>${attachmentLink}</td>
            <td>
                <button class="btn-warning edit-btn" onclick="editExpense(${exp.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn-danger edit-btn" onclick="deleteExpense(${exp.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}
        function getPaymentMethodName(method) { return { 'cash': 'Ù†Ù‚Ø¯ÙŠ', 'bank': 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ', 'check': 'Ø´ÙŠÙƒ', 'card': 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†' }[method] || method; }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseCategory').value = expense.category;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseDescription').value = expense.description || '';
            document.getElementById('expensePaymentMethod').value = expense.paymentMethod;
            document.getElementById('expenseReference').value = expense.reference || '';
            const btn = document.querySelector('#expenses .btn-primary');
            btn.textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ';
            btn.onclick = () => updateExpense(id);
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            applyEditMode('#expenses', 'expenseDate', '#expenses h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ`);
        }

        async function updateExpense(id) {
            const date = document.getElementById('expenseDate').value, category = document.getElementById('expenseCategory').value, amount = parseFloat(document.getElementById('expenseAmount').value);
            if (!date || !category || isNaN(amount)) { showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning'); return; }
            const index = expenses.findIndex(e => e.id === id);
            if (index > -1) {
                expenses[index] = { ...expenses[index], date, category, amount, description: document.getElementById('expenseDescription').value, paymentMethod: document.getElementById('expensePaymentMethod').value, reference: document.getElementById('expenseReference').value };
                const success = saveToLocalStorage('expenses', expenses);
                if (success) {
                    clearExpenseForm();
                    renderExpenses();
                    updateExpenseStats();
                    showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            }
        }
        
        async function deleteExpense(id) {
            const confirmed = await showConfirmDialog(
                'Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ',
                'warning',
                'Ù†Ù‚Ù„',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                const expense = expenses.find(e => e.id === id);
                if (expense) {
                    moveToTrash('expenses', expense);
                    expenses = expenses.filter(e => e.id !== id);
                    const success = saveToLocalStorage('expenses', expenses);
                    if (success) {
                        renderExpenses();
                        updateExpenseStats();
                        updateDashboard();
                        showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            }
        }
        
      async function clearExpenseForm() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
    const confirmed = await confirmCancelEdit('#expenses');
    if (!confirmed) return;
    
    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    ['expenseCategory', 'expenseAmount', 'expenseDescription', 'expenseReference'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('expensePaymentMethod').value = 'cash';
    
    document.getElementById('expenseAttachment').value = null; 
    
    const btn = document.querySelector('#expenses .btn-primary');
    btn.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ';
    btn.onclick = addExpense;
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
    removeEditMode('#expenses', '#expenses h2', 'ğŸ’¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatExpenses" class="stat-mini-number">0</span></span>');
}
        function updateExpenseStats() {
            const today = new Date().toISOString().split('T')[0];
            const month = today.substring(0, 7);
            const total = expenses.reduce((s, e) => s + e.amount, 0);
            const todayTotal = expenses.filter(e => e.date === today).reduce((s, e) => s + e.amount, 0);
            const monthTotal = expenses.filter(e => e.date.substring(0, 7) === month).reduce((s, e) => s + e.amount, 0);
            document.getElementById('totalExpenses').textContent = total.toFixed(2);
            document.getElementById('todayExpenses').textContent = todayTotal.toFixed(2);
            document.getElementById('monthExpenses').textContent = monthTotal.toFixed(2);
        }
        
        async function addRevenue() {
            const date = document.getElementById('revenueDate').value, category = document.getElementById('revenueCategory').value, amount = parseFloat(document.getElementById('revenueAmount').value);
            if (!date || !category || isNaN(amount)) { showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning'); return; }
            const revenue = { 
                id: Date.now(), 
                date, 
                category, 
                amount, 
                source: document.getElementById('revenueSource').value, 
                description: document.getElementById('revenueDescription').value, 
                reference: document.getElementById('revenueReference').value,
                branchId: document.getElementById('revenueBranchId').value || null
            };
            revenues.push(revenue);
            const success = saveToLocalStorage('revenues', revenues);
            if (success) {
                clearRevenueForm();
                renderRevenues();
                updateRevenueStats();
                updateDashboard();
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }
        function renderRevenues() {
            const tbody = document.getElementById('revenuesList');
            tbody.innerHTML = '';
            if (revenues.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</td></tr>'; return; }
             [...revenues].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(rev => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${rev.date}</td><td>${rev.category}</td><td>${getRevenueSourceName(rev.source)}</td><td>${rev.amount.toFixed(2)}</td><td>${rev.description || '-'}</td><td>${rev.reference || '-'}</td><td><button class="btn-warning edit-btn" onclick="editRevenue(${rev.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn-danger edit-btn" onclick="deleteRevenue(${rev.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>`;
                tbody.appendChild(tr);
            });
        }
        function getRevenueSourceName(source) { return { 'sales': 'Ù…Ø¨ÙŠØ¹Ø§Øª', 'services': 'Ø®Ø¯Ù…Ø§Øª', 'investment': 'Ø§Ø³ØªØ«Ù…Ø§Ø±', 'other': 'Ø£Ø®Ø±Ù‰' }[source] || source; }
        function editRevenue(id) {
            const rev = revenues.find(r => r.id === id);
            if (!rev) return;
            document.getElementById('revenueDate').value = rev.date;
            document.getElementById('revenueCategory').value = rev.category;
            document.getElementById('revenueAmount').value = rev.amount;
            document.getElementById('revenueDescription').value = rev.description || '';
            document.getElementById('revenueSource').value = rev.source;
            document.getElementById('revenueReference').value = rev.reference || '';
            const btn = document.querySelector('#revenues .btn-primary');
            btn.textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯';
            btn.onclick = () => updateRevenue(id);
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            applyEditMode('#revenues', 'revenueDate', '#revenues h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯`);
        }
        async function updateRevenue(id) {
            const date = document.getElementById('revenueDate').value, category = document.getElementById('revenueCategory').value, amount = parseFloat(document.getElementById('revenueAmount').value);
            if (!date || !category || isNaN(amount)) { showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning'); return; }
            const index = revenues.findIndex(r => r.id === id);
            if (index > -1) {
                revenues[index] = { ...revenues[index], date, category, amount, source: document.getElementById('revenueSource').value, description: document.getElementById('revenueDescription').value, reference: document.getElementById('revenueReference').value };
                const success = saveToLocalStorage('revenues', revenues);
                if (success) {
                    clearRevenueForm();
                    renderRevenues();
                    updateRevenueStats();
                    showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            }
        }
        async function deleteRevenue(id) {
            const confirmed = await showConfirmDialog(
                'Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ',
                'warning',
                'Ù†Ù‚Ù„',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                const revenue = revenues.find(r => r.id === id);
                if (revenue) {
                    moveToTrash('revenues', revenue);
                    revenues = revenues.filter(r => r.id !== id);
                    const success = saveToLocalStorage('revenues', revenues);
                    if (success) {
                        renderRevenues();
                        updateRevenueStats();
                        updateDashboard();
                        showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            }
        }
        async function clearRevenueForm() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            const confirmed = await confirmCancelEdit('#revenues');
            if (!confirmed) return;
            
            document.getElementById('revenueDate').value = new Date().toISOString().split('T')[0];
            ['revenueCategory', 'revenueAmount', 'revenueDescription', 'revenueReference'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('revenueSource').value = 'sales';
            const btn = document.querySelector('#revenues .btn-primary');
            btn.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ±Ø§Ø¯';
            btn.onclick = addRevenue;
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            removeEditMode('#revenues', '#revenues h2', 'ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatRevenues" class="stat-mini-number">0</span></span>');
        }
        function updateRevenueStats() {
            const today = new Date().toISOString().split('T')[0];
            const month = today.substring(0, 7);
            const total = revenues.reduce((s, r) => s + r.amount, 0);
            const todayTotal = revenues.filter(r => r.date === today).reduce((s, r) => s + r.amount, 0);
            const monthTotal = revenues.filter(r => r.date.substring(0, 7) === month).reduce((s, r) => s + r.amount, 0);
            document.getElementById('totalRevenues').textContent = total.toFixed(2);
            document.getElementById('todayRevenues').textContent = todayTotal.toFixed(2);
            document.getElementById('monthRevenues').textContent = monthTotal.toFixed(2);
        }

        // ===== Salaries Functions =====
        function normalizeAmount(value) {
            const amount = parseFloat(value);
            return Number.isFinite(amount) ? amount : 0;
        }

        function roundCurrency(value) {
            return Math.round((Number(value) || 0) * 100) / 100;
        }

        function formatCurrency(value) {
            const amount = Number(value);
            return Number.isFinite(amount) ? amount.toFixed(2) : '0.00';
        }

        function getSalaryFormValues() {
            const monthInput = document.getElementById('salaryMonth');
            if (!monthInput) return null;
            const getValue = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };
            return {
                month: monthInput.value || '',
                employeeName: getValue('salaryEmployeeName').trim(),
                nationalId: getValue('salaryNationalId').trim(),
                nationality: getValue('salaryNationality'),
                employeeId: getValue('salaryEmployeeId').trim(),
                jobTitle: getValue('salaryJobTitle').trim(),
                branchId: getValue('salaryBranchId') || null,
                basic: getValue('salaryBasic') || '0',
                housing: getValue('salaryHousing') || '0',
                transport: getValue('salaryTransport') || '0',
                otherAllowances: getValue('salaryOtherAllowances') || '0',
                overtime: getValue('salaryOvertime') || '0',
                otherDeductions: getValue('salaryOtherDeductions') || '0',
                notes: getValue('salaryNotes').trim()
            };
        }

        function computeSalaryBreakdown(formData) {
            const basic = roundCurrency(normalizeAmount(formData.basic));
            const housing = roundCurrency(normalizeAmount(formData.housing));
            const transport = roundCurrency(normalizeAmount(formData.transport));
            const otherAllowances = roundCurrency(normalizeAmount(formData.otherAllowances));
            const overtime = roundCurrency(normalizeAmount(formData.overtime));
            const allowancesTotal = roundCurrency(housing + transport + otherAllowances + overtime);
            const gross = roundCurrency(basic + allowancesTotal);
            const gosiBase = Math.min(basic + housing, GOSI_SALARY_CAP);
            const gosiEmployee = roundCurrency(gosiBase * GOSI_RATE);
            const gosiEmployer = roundCurrency(gosiBase * GOSI_RATE);
            const otherDeductions = roundCurrency(normalizeAmount(formData.otherDeductions));
            const net = roundCurrency(gross - gosiEmployee - otherDeductions);

            return {
                basic,
                housing,
                transport,
                otherAllowances,
                overtime,
                allowancesTotal,
                gross,
                gosiEmployee,
                gosiEmployer,
                otherDeductions,
                net
            };
        }

        async function addSalary() {
            const formData = getSalaryFormValues();
            if (!formData) return;
            if (!formData.month || !formData.employeeName || !formData.nationalId || !formData.nationality) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© ÙˆØ§Ù„Ø¬Ù†Ø³ÙŠØ©', 'warning');
                return;
            }
            if (normalizeAmount(formData.basic) <= 0) {
                showNotification('âš ï¸ Ø±Ø§ØªØ¨ ØºÙŠØ± ØµØ­ÙŠØ­', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'warning');
                return;
            }
            const breakdown = computeSalaryBreakdown(formData);
            const salaryRecord = {
                id: Date.now(),
                month: formData.month,
                employeeName: formData.employeeName,
                nationalId: formData.nationalId,
                nationality: formData.nationality,
                employeeId: formData.employeeId,
                jobTitle: formData.jobTitle,
                branchId: formData.branchId,
                notes: formData.notes,
                basic: breakdown.basic,
                housing: breakdown.housing,
                transport: breakdown.transport,
                otherAllowances: breakdown.otherAllowances,
                overtime: breakdown.overtime,
                allowancesTotal: breakdown.allowancesTotal,
                gross: breakdown.gross,
                gosiEmployee: breakdown.gosiEmployee,
                gosiEmployer: breakdown.gosiEmployer,
                otherDeductions: breakdown.otherDeductions,
                net: breakdown.net,
                createdAt: new Date().toISOString()
            };

            salaries.push(salaryRecord);
            const success = saveToLocalStorage('salaries', salaries);
            if (success) {
                clearSalaryForm(true, true); // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
                renderSalaries();
                updateSalarySummary();
                updateDataStats();
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨', 'error');
            }
        }

        async function updateSalary(id) {
            const formData = getSalaryFormValues();
            if (!formData) return;
            if (!formData.month || !formData.employeeName || !formData.nationalId || !formData.nationality) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© ÙˆØ§Ù„Ø¬Ù†Ø³ÙŠØ©', 'warning');
                return;
            }
            const index = salaries.findIndex(s => s.id === id);
            if (index === -1) return;
            const breakdown = computeSalaryBreakdown(formData);
            const existing = salaries[index];
            salaries[index] = {
                ...existing,
                month: formData.month,
                employeeName: formData.employeeName,
                nationalId: formData.nationalId,
                nationality: formData.nationality,
                employeeId: formData.employeeId,
                jobTitle: formData.jobTitle,
                branchId: formData.branchId,
                notes: formData.notes,
                basic: breakdown.basic,
                housing: breakdown.housing,
                transport: breakdown.transport,
                otherAllowances: breakdown.otherAllowances,
                overtime: breakdown.overtime,
                allowancesTotal: breakdown.allowancesTotal,
                gross: breakdown.gross,
                gosiEmployee: breakdown.gosiEmployee,
                gosiEmployer: breakdown.gosiEmployer,
                otherDeductions: breakdown.otherDeductions,
                net: breakdown.net,
                updatedAt: new Date().toISOString()
            };

            const success = saveToLocalStorage('salaries', salaries);
            if (success) {
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                clearSalaryForm(true, true); // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                renderSalaries();
                updateSalarySummary();
                updateDataStats();
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨', 'error');
            }
        }

        function editSalary(id) {
            const salary = salaries.find(s => s.id === id);
            if (!salary) return;
            editingSalaryId = id;
            if (document.getElementById('salaryMonth')) document.getElementById('salaryMonth').value = salary.month || '';
            if (document.getElementById('salaryEmployeeName')) document.getElementById('salaryEmployeeName').value = salary.employeeName || '';
            if (document.getElementById('salaryNationalId')) document.getElementById('salaryNationalId').value = salary.nationalId || '';
            if (document.getElementById('salaryNationality')) document.getElementById('salaryNationality').value = salary.nationality || '';
            if (document.getElementById('salaryEmployeeId')) document.getElementById('salaryEmployeeId').value = salary.employeeId || '';
            if (document.getElementById('salaryJobTitle')) document.getElementById('salaryJobTitle').value = salary.jobTitle || '';
            if (document.getElementById('salaryBasic')) document.getElementById('salaryBasic').value = formatCurrency(salary.basic);
            if (document.getElementById('salaryHousing')) document.getElementById('salaryHousing').value = formatCurrency(salary.housing);
            if (document.getElementById('salaryTransport')) document.getElementById('salaryTransport').value = formatCurrency(salary.transport);
            if (document.getElementById('salaryOtherAllowances')) document.getElementById('salaryOtherAllowances').value = formatCurrency(salary.otherAllowances);
            if (document.getElementById('salaryOvertime')) document.getElementById('salaryOvertime').value = formatCurrency(salary.overtime);
            if (document.getElementById('salaryOtherDeductions')) document.getElementById('salaryOtherDeductions').value = formatCurrency(salary.otherDeductions);
            if (document.getElementById('salaryNotes')) document.getElementById('salaryNotes').value = salary.notes || '';

            const addBtn = document.querySelector('#salaries .btn-primary');
            if (addBtn) {
                addBtn.textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ÙŠØ±';
                addBtn.onclick = () => updateSalary(id);
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            applyEditMode('#salaries', 'salaryEmployeeName', '#salaries h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ÙŠØ±: ${salary.employeeName}`);
        }

        async function deleteSalary(id) {
            const confirmed = await showConfirmDialog(
                'Ø­Ø°Ù Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨',
                'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ÙŠØ±ØŸ',
                'danger',
                'Ø­Ø°Ù',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (!confirmed) return;
            salaries = salaries.filter(s => s.id !== id);
            const success = saveToLocalStorage('salaries', salaries);
            if (success) {
                if (editingSalaryId === id) {
                    clearSalaryForm();
                }
                renderSalaries();
                updateSalarySummary();
                updateDataStats();
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨', 'error');
            }
        }

        async function clearSalaryForm(skipSummaryUpdate = true, skipConfirmation = false) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° (Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† skipConfirmation = true)
            if (!skipConfirmation) {
                const confirmed = await confirmCancelSalaryEdit();
                if (!confirmed) return;
            }
            
            editingSalaryId = null;
            const monthEl = document.getElementById('salaryMonth');
            let monthWasEmpty = false;
            if (monthEl && !monthEl.value) {
                monthEl.value = new Date().toISOString().slice(0, 7);
                monthWasEmpty = true;
            }
            const inputs = ['salaryEmployeeName', 'salaryNationalId', 'salaryNationality', 'salaryEmployeeId', 'salaryJobTitle', 'salaryBasic', 'salaryHousing', 'salaryTransport', 'salaryOtherAllowances', 'salaryOvertime', 'salaryOtherDeductions'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const notesEl = document.getElementById('salaryNotes');
            if (notesEl) notesEl.value = '';

            const addBtn = document.querySelector('#salaries .btn-primary');
            if (addBtn) {
                addBtn.textContent = 'â• Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙŠØ±';
                addBtn.onclick = addSalary;
            }
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            removeEditMode('#salaries', '#salaries h2', 'ğŸ‘¨â€ğŸ’¼ Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨ <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatSalaries" class="stat-mini-number">0</span></span>');

            if (monthWasEmpty || !skipSummaryUpdate) {
                updateSalarySummary();
            }
        }

        function renderSalaries(data = null, isFiltered = false) {
            const tbody = document.getElementById('salariesList');
            if (!tbody) return;
            const source = Array.isArray(data) ? data : salaries;
            tbody.innerHTML = '';
            if (source.length === 0) {
                const message = isFiltered ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙŠØ±Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙŠØ±Ø§Øª Ø±ÙˆØ§ØªØ¨ Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯';
                tbody.innerHTML = `<tr><td colspan="12" style="text-align: center;">${message}</td></tr>`;
                return;
            }

            const sorted = [...source].sort((a, b) => {
                if ((b.month || '') > (a.month || '')) return 1;
                if ((b.month || '') < (a.month || '')) return -1;
                return (a.employeeName || '').localeCompare(b.employeeName || '');
            });

            sorted.forEach(salary => {
                const allowances = typeof salary.allowancesTotal === 'number'
                    ? salary.allowancesTotal
                    : normalizeAmount(salary.housing) + normalizeAmount(salary.transport) + normalizeAmount(salary.otherAllowances) + normalizeAmount(salary.overtime);
                const gross = typeof salary.gross === 'number' ? salary.gross : normalizeAmount(salary.basic) + allowances;
                const gosiEmployee = normalizeAmount(salary.gosiEmployee);
                const otherDeductions = normalizeAmount(salary.otherDeductions);
                const net = typeof salary.net === 'number' ? salary.net : gross - gosiEmployee - otherDeductions;
                const tr = document.createElement('tr');
                if (salary.notes) {
                    tr.title = salary.notes;
                }
                tr.innerHTML = `
                    <td>${salary.employeeName || '-'}</td>
                    <td>${salary.nationalId || '-'}</td>
                    <td>${salary.nationality === 'saudi' ? 'ğŸ‡¸ğŸ‡¦ Ø³Ø¹ÙˆØ¯ÙŠ' : salary.nationality === 'non-saudi' ? 'ğŸŒ ØºÙŠØ± Ø³Ø¹ÙˆØ¯ÙŠ' : '-'}</td>
                    <td>${salary.month || '-'}</td>
                    <td>${salary.jobTitle || '-'}</td>
                    <td>${formatCurrency(salary.basic)}</td>
                    <td>${formatCurrency(allowances)}</td>
                    <td>${formatCurrency(gross)}</td>
                    <td>${formatCurrency(gosiEmployee)}</td>
                    <td>${formatCurrency(otherDeductions)}</td>
                    <td>${formatCurrency(net)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-warning edit-btn" onclick="editSalary(${salary.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn-danger edit-btn" onclick="deleteSalary(${salary.id})">Ø­Ø°Ù</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateSalarySummary() {
            const monthInput = document.getElementById('salaryMonth');
            const targetMonth = monthInput ? monthInput.value : '';
            const dataset = targetMonth ? salaries.filter(s => s.month === targetMonth) : [...salaries];
            const totals = dataset.reduce((acc, salary) => {
                acc.count += 1;
                const basic = normalizeAmount(salary.basic);
                const housing = normalizeAmount(salary.housing);
                const transport = normalizeAmount(salary.transport);
                const otherAllowances = normalizeAmount(salary.otherAllowances);
                const overtime = normalizeAmount(salary.overtime);
                const allowances = typeof salary.allowancesTotal === 'number' ? salary.allowancesTotal : housing + transport + otherAllowances + overtime;
                const gross = typeof salary.gross === 'number' ? salary.gross : basic + allowances;
                const gosiEmployee = normalizeAmount(salary.gosiEmployee);
                const gosiEmployer = normalizeAmount(salary.gosiEmployer);
                const otherDeductions = normalizeAmount(salary.otherDeductions);
                const net = typeof salary.net === 'number' ? salary.net : gross - gosiEmployee - otherDeductions;

                acc.basic += basic;
                acc.allowances += allowances;
                acc.gross += gross;
                acc.gosi += gosiEmployee;
                acc.gosiEmployer += gosiEmployer;
                acc.otherDeductions += otherDeductions;
                acc.net += net;
                return acc;
            }, { count: 0, basic: 0, allowances: 0, gross: 0, gosi: 0, gosiEmployer: 0, otherDeductions: 0, net: 0 });

            const summaryCount = document.getElementById('salarySummaryCount');
            if (summaryCount) summaryCount.textContent = totals.count;
            const summaryBasic = document.getElementById('salarySummaryBasic');
            if (summaryBasic) summaryBasic.textContent = formatCurrency(totals.basic);
            const summaryAllowances = document.getElementById('salarySummaryAllowances');
            if (summaryAllowances) summaryAllowances.textContent = formatCurrency(totals.allowances);
            const summaryGross = document.getElementById('salarySummaryGross');
            if (summaryGross) summaryGross.textContent = formatCurrency(totals.gross);
            const summaryGosi = document.getElementById('salarySummaryGosi');
            if (summaryGosi) summaryGosi.textContent = formatCurrency(totals.gosi);
            const summaryGosiEmployer = document.getElementById('salarySummaryGosiEmployer');
            if (summaryGosiEmployer) summaryGosiEmployer.textContent = formatCurrency(totals.gosiEmployer);
            const summaryOther = document.getElementById('salarySummaryOtherDeductions');
            if (summaryOther) summaryOther.textContent = formatCurrency(totals.otherDeductions);
            const summaryNet = document.getElementById('salarySummaryNet');
            if (summaryNet) summaryNet.textContent = formatCurrency(totals.net);

            const miniStat = document.getElementById('miniStatSalaries');
            if (miniStat) miniStat.textContent = formatCurrency(totals.net);
        }

        // ===== Accounting & Reports Functions =====
        
        // Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        function switchAccountingTab(tabName) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
            document.getElementById('reportsTab').classList.remove('active');
            document.getElementById('accountStatementsTab').classList.remove('active');
            document.getElementById('reportsTabBtn').classList.remove('active');
            document.getElementById('accountStatementsTabBtn').classList.remove('active');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.getElementById(tabName + 'TabBtn').classList.add('active');
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const today = new Date().toISOString().split('T')[0];
            if (tabName === 'accountStatements') {
                document.getElementById('statementFrom').value = today;
                document.getElementById('statementTo').value = today;
            }
        }
        
        // Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨
        function changeStatementType() {
            const statementType = document.getElementById('statementType').value;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            document.getElementById('specificSupplierFilter').style.display = 'none';
            document.getElementById('specificCustomerFilter').style.display = 'none';
            document.getElementById('specificEmployeeFilter').style.display = 'none';
            document.getElementById('taxFilterType').style.display = 'none';
            
            // ğŸª ØªØ­Ø¯ÙŠØ« ÙÙ„ØªØ± Ø§Ù„ÙØ±ÙˆØ¹
            populateBranchFilter();
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
            switch(statementType) {
                case 'suppliers':
                    document.getElementById('specificSupplierFilter').style.display = 'inline-block';
                    populateSpecificSupplierFilter();
                    break;
                case 'customers':
                    document.getElementById('specificCustomerFilter').style.display = 'inline-block';
                    populateSpecificCustomerFilter();
                    break;
                case 'employees':
                    document.getElementById('specificEmployeeFilter').style.display = 'inline-block';
                    populateSpecificEmployeeFilter();
                    break;
                case 'tax':
                    document.getElementById('taxFilterType').style.display = 'inline-block';
                    break;
            }
        }
        
        // Ø¯ÙˆØ§Ù„ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        function populateSpecificSupplierFilter() {
            const select = document.getElementById('specificSupplierFilter');
            select.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>';
            suppliers.forEach(supplier => {
                select.innerHTML += `<option value="${supplier.id}">${supplier.name}</option>`;
            });
        }
        
        function populateSpecificCustomerFilter() {
            const select = document.getElementById('specificCustomerFilter');
            select.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>';
            customers.forEach(customer => {
                select.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
            });
        }
        
        function populateSpecificEmployeeFilter() {
            const select = document.getElementById('specificEmployeeFilter');
            select.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>';
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨
            const employees = [...new Set(salaries.map(s => s.employeeName))];
            employees.forEach(employee => {
                select.innerHTML += `<option value="${employee}">${employee}</option>`;
            });
        }
        
        // ğŸª Ø¯Ø§Ù„Ø© ØªØ¹Ø¨Ø¦Ø© ÙÙ„ØªØ± Ø§Ù„ÙØ±ÙˆØ¹
        function populateBranchFilter() {
            const select = document.getElementById('statementBranchFilter');
            if (!select) return;
            
            const activityBranches = branches.filter(b => b.activityId === currentActivityId);
            
            select.innerHTML = '<option value="all">ğŸª ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>';
            select.innerHTML += '<option value="general_admin">ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>';
            select.innerHTML += '<option value="">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·</option>';
            
            activityBranches.forEach(branch => {
                select.innerHTML += `<option value="${branch.id}">${branch.name}</option>`;
            });
        }
        
        // ğŸª Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
        function filterByBranch(transactions) {
            const branchFilter = document.getElementById('statementBranchFilter').value;
            
            if (branchFilter === 'all') {
                return transactions; // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else if (branchFilter === 'general_admin') {
                return transactions.filter(t => t.branchId === 'general_admin'); // Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø·
            } else if (branchFilter === '') {
                return transactions.filter(t => !t.branchId || t.branchId === ''); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                return transactions.filter(t => t.branchId == branchFilter); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ´Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ±
        function autoRefreshStatement() {
            const statementResults = document.getElementById('statementResults').innerHTML;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙƒØ´Ù Ù…Ø¹Ø±ÙˆØ¶ØŒ Ù†Ø¹ÙŠØ¯ ØªÙˆÙ„ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            if (statementResults && statementResults.trim() !== '') {
                generateAccountStatement();
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨
        function generateAccountStatement() {
            const statementType = document.getElementById('statementType').value;
            const fromDate = document.getElementById('statementFrom').value;
            const toDate = document.getElementById('statementTo').value;
            
            if (!fromDate || !toDate) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØªØ±Ø© Ø²Ù…Ù†ÙŠØ© ØµØ­ÙŠØ­Ø©', 'warning');
                return;
            }
            
            switch(statementType) {
                case 'suppliers':
                    generateSuppliersStatement(fromDate, toDate);
                    break;
                case 'customers':
                    generateCustomersStatement(fromDate, toDate);
                    break;
                case 'employees':
                    generateEmployeesStatement(fromDate, toDate);
                    break;
                case 'bank':
                    generateBankStatement(fromDate, toDate);
                    break;
                case 'cash':
                    generateCashStatement(fromDate, toDate);
                    break;
                case 'tax':
                    generateTaxStatement(fromDate, toDate);
                    break;
            }
        }
        
        // Ø¯Ø§Ù„Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        function generateSuppliersStatement(fromDate, toDate) {
            const specificSupplierId = document.getElementById('specificSupplierFilter').value;
            
            let filteredPurchases = purchases.filter(p => 
                p.date >= fromDate && p.date <= toDate
            );
            
            if (specificSupplierId !== 'all') {
                filteredPurchases = filteredPurchases.filter(p => p.supplierId == specificSupplierId);
            }
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            filteredPurchases = filterByBranch(filteredPurchases);
            
            let totalPurchases = 0;
            let totalPaid = 0;
            let totalRemaining = 0;
            
            let tableHTML = `
                <h3>ğŸ“¦ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h3>
                <table class="account-statement-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                            <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredPurchases.forEach(purchase => {
                const supplier = suppliers.find(s => s.id === purchase.supplierId);
                const remaining = purchase.total - (purchase.paidAmount || 0);
                
                totalPurchases += purchase.total;
                totalPaid += purchase.paidAmount || 0;
                totalRemaining += remaining;
                
                tableHTML += `
                    <tr>
                        <td>${purchase.date}</td>
                        <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td>PUR${purchase.number.toString().padStart(3, '0')}</td>
                        <td>${purchase.total.toFixed(2)}</td>
                        <td>${(purchase.paidAmount || 0).toFixed(2)}</td>
                        <td class="${remaining > 0.01 ? 'remaining-unpaid' : 'remaining-paid'}">${remaining.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            const summaryHTML = `
                <div class="dashboard-cards">
                    <div class="dashboard-card customers">
                        <div class="card-value">${totalPurchases.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                        <div class="card-growth">
                            <span>+8%</span>
                            <span class="growth-icon">ğŸ“¦</span>
                        </div>
                    </div>
                    <div class="dashboard-card profit">
                        <div class="card-value">${totalPaid.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
                        <div class="card-growth">
                            <span>+12%</span>
                            <span class="growth-icon">âœ…</span>
                        </div>
                    </div>
                    <div class="dashboard-card revenue">
                        <div class="card-value">${totalRemaining.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                        <div class="card-growth">
                            <span>${totalRemaining > 0 ? '-5%' : '+15%'}</span>
                            <span class="growth-icon">${totalRemaining > 0 ? 'â³' : 'ğŸ‰'}</span>
                        </div>
                    </div>
                    <div class="dashboard-card sales-today">
                        <div class="card-value">${filteredPurchases.length}</div>
                        <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                        <div class="card-growth">
                            <span>+5%</span>
                            <span class="growth-icon">ğŸ“‹</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statementSummary').innerHTML = summaryHTML;
            document.getElementById('statementResults').innerHTML = tableHTML;
        }
        
        // Ø¯Ø§Ù„Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        function generateCustomersStatement(fromDate, toDate) {
            const specificCustomerId = document.getElementById('specificCustomerFilter').value;
            
            let filteredSales = sales.filter(s => 
                s.date >= fromDate && s.date <= toDate
            );
            
            if (specificCustomerId !== 'all') {
                filteredSales = filteredSales.filter(s => s.customerId == specificCustomerId);
            }
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            filteredSales = filterByBranch(filteredSales);
            
            let totalSales = 0;
            let totalPaid = 0;
            let totalRemaining = 0;
            
            let tableHTML = `
                <h3>ğŸ‘¥ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                <table class="account-statement-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                            <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredSales.forEach(sale => {
                const customer = customers.find(c => c.id === sale.customerId);
                const remaining = sale.total - (sale.paidAmount || 0);
                
                totalSales += sale.total;
                totalPaid += sale.paidAmount || 0;
                totalRemaining += remaining;
                
                tableHTML += `
                    <tr>
                        <td>${sale.date}</td>
                        <td>${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td>SAL${sale.number.toString().padStart(3, '0')}</td>
                        <td>${sale.total.toFixed(2)}</td>
                        <td>${(sale.paidAmount || 0).toFixed(2)}</td>
                        <td class="${remaining > 0.01 ? 'remaining-unpaid' : 'remaining-paid'}">${remaining.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            const summaryHTML = `
                <div class="dashboard-cards">
                    <div class="dashboard-card customers">
                        <div class="card-value">${totalSales.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                        <div class="card-growth">
                            <span>+12%</span>
                            <span class="growth-icon">ğŸ’°</span>
                        </div>
                    </div>
                    <div class="dashboard-card profit">
                        <div class="card-value">${totalPaid.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
                        <div class="card-growth">
                            <span>+8%</span>
                            <span class="growth-icon">âœ…</span>
                        </div>
                    </div>
                    <div class="dashboard-card revenue">
                        <div class="card-value">${totalRemaining.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                        <div class="card-growth">
                            <span>${totalRemaining > 0 ? '-15%' : '+5%'}</span>
                            <span class="growth-icon">${totalRemaining > 0 ? 'â³' : 'ğŸ‰'}</span>
                        </div>
                    </div>
                    <div class="dashboard-card sales-today">
                        <div class="card-value">${filteredSales.length}</div>
                        <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                        <div class="card-growth">
                            <span>+10%</span>
                            <span class="growth-icon">ğŸ“‹</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statementSummary').innerHTML = summaryHTML;
            document.getElementById('statementResults').innerHTML = tableHTML;
        }
        
        // Ø¯Ø§Ù„Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        function generateEmployeesStatement(fromDate, toDate) {
            const specificEmployee = document.getElementById('specificEmployeeFilter').value;
            
            let filteredSalaries = salaries.filter(s => 
                s.month >= fromDate && s.month <= toDate
            );
            
            if (specificEmployee !== 'all') {
                filteredSalaries = filteredSalaries.filter(s => s.employeeName === specificEmployee);
            }
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            filteredSalaries = filterByBranch(filteredSalaries);
            
            let totalBasic = 0;
            let totalAllowances = 0;
            let totalDeductions = 0;
            let totalNet = 0;
            
            let tableHTML = `
                <h3>ğŸ‘· ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
                <table class="account-statement-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø´Ù‡Ø±</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                            <th>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
                            <th>Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</th>
                            <th>Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª</th>
                            <th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredSalaries.forEach(salary => {
                const totalGross = salary.basicSalary + salary.allowances;
                const totalDeduction = salary.gosiEmployee + salary.otherDeductions;
                const netSalary = totalGross - totalDeduction;
                
                totalBasic += salary.basicSalary;
                totalAllowances += salary.allowances;
                totalDeductions += totalDeduction;
                totalNet += netSalary;
                
                tableHTML += `
                    <tr>
                        <td>${salary.month}</td>
                        <td>${salary.employeeName}</td>
                        <td>${salary.basicSalary.toFixed(2)}</td>
                        <td>${salary.allowances.toFixed(2)}</td>
                        <td>${totalDeduction.toFixed(2)}</td>
                        <td>${netSalary.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            const summaryHTML = `
                <div class="dashboard-cards">
                    <div class="dashboard-card customers">
                        <div class="card-value">${totalBasic.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
                        <div class="card-growth">
                            <span>+5%</span>
                            <span class="growth-icon">ğŸ’¼</span>
                        </div>
                    </div>
                    <div class="dashboard-card profit">
                        <div class="card-value">${totalAllowances.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</div>
                        <div class="card-growth">
                            <span>+10%</span>
                            <span class="growth-icon">ğŸ</span>
                        </div>
                    </div>
                    <div class="dashboard-card revenue">
                        <div class="card-value">${totalDeductions.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª</div>
                        <div class="card-growth">
                            <span>-3%</span>
                            <span class="growth-icon">ğŸ“‰</span>
                        </div>
                    </div>
                    <div class="dashboard-card sales-today">
                        <div class="card-value">${totalNet.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµØ§ÙÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨</div>
                        <div class="card-growth">
                            <span>+8%</span>
                            <span class="growth-icon">ğŸ’°</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statementSummary').innerHTML = summaryHTML;
            document.getElementById('statementResults').innerHTML = tableHTML;
        }
        
        // Ø¯Ø§Ù„Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ
        function generateBankStatement(fromDate, toDate) {
            let bankTransactions = [];
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©
            sales.filter(s => s.date >= fromDate && s.date <= toDate && s.paymentMethod === 'bank')
                .forEach(sale => {
                    const customer = customers.find(c => c.id === sale.customerId);
                    bankTransactions.push({
                        date: sale.date,
                        description: `Ù…Ø¨ÙŠØ¹Ø§Øª - ${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
                        reference: `SAL${sale.number.toString().padStart(3, '0')}`,
                        debit: 0,
                        credit: sale.paidAmount || 0,
                        type: 'sale'
                    });
                });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©
            purchases.filter(p => p.date >= fromDate && p.date <= toDate && p.paymentMethod === 'bank')
                .forEach(purchase => {
                    const supplier = suppliers.find(s => s.id === purchase.supplierId);
                    bankTransactions.push({
                        date: purchase.date,
                        description: `Ù…Ø´ØªØ±ÙŠØ§Øª - ${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
                        reference: `PUR${purchase.number.toString().padStart(3, '0')}`,
                        debit: purchase.paidAmount || 0,
                        credit: 0,
                        type: 'purchase'
                    });
                });
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            bankTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let balance = 0;
            let totalDebits = 0;
            let totalCredits = 0;
            
            let tableHTML = `
                <h3>ğŸ¦ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ</h3>
                <table class="account-statement-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                            <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                            <th>Ù…Ø¯ÙŠÙ†</th>
                            <th>Ø¯Ø§Ø¦Ù†</th>
                            <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            bankTransactions.forEach(transaction => {
                balance += transaction.credit - transaction.debit;
                totalDebits += transaction.debit;
                totalCredits += transaction.credit;
                
                tableHTML += `
                    <tr>
                        <td>${transaction.date}</td>
                        <td>${transaction.description}</td>
                        <td>${transaction.reference}</td>
                        <td>${transaction.debit > 0 ? transaction.debit.toFixed(2) : '-'}</td>
                        <td>${transaction.credit > 0 ? transaction.credit.toFixed(2) : '-'}</td>
                        <td class="${balance >= 0 ? 'remaining-paid' : 'remaining-unpaid'}">${balance.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            const summaryHTML = `
                <div class="dashboard-cards">
                    <div class="dashboard-card revenue">
                        <div class="card-value">${totalDebits.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†</div>
                        <div class="card-growth">
                            <span>+7%</span>
                            <span class="growth-icon">ğŸ“¤</span>
                        </div>
                    </div>
                    <div class="dashboard-card customers">
                        <div class="card-value">${totalCredits.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù†</div>
                        <div class="card-growth">
                            <span>+15%</span>
                            <span class="growth-icon">ğŸ“¥</span>
                        </div>
                    </div>
                    <div class="dashboard-card ${balance >= 0 ? 'profit' : 'sales-today'}">
                        <div class="card-value">${balance.toFixed(2)}</div>
                        <div class="card-title">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div>
                        <div class="card-growth">
                            <span>${balance >= 0 ? '+12%' : '-8%'}</span>
                            <span class="growth-icon">${balance >= 0 ? 'ğŸ’°' : 'âš ï¸'}</span>
                        </div>
                    </div>
                    <div class="dashboard-card sales-today">
                        <div class="card-value">${bankTransactions.length}</div>
                        <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</div>
                        <div class="card-growth">
                            <span>+5%</span>
                            <span class="growth-icon">ï¿½</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statementSummary').innerHTML = summaryHTML;
            document.getElementById('statementResults').innerHTML = tableHTML;
        }
        
        // Ø¯Ø§Ù„Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
        function generateCashStatement(fromDate, toDate) {
            let cashTransactions = [];
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
            sales.filter(s => s.date >= fromDate && s.date <= toDate && (s.paymentMethod === 'cash' || !s.paymentMethod))
                .forEach(sale => {
                    const customer = customers.find(c => c.id === sale.customerId);
                    cashTransactions.push({
                        date: sale.date,
                        description: `Ù…Ø¨ÙŠØ¹Ø§Øª Ù†Ù‚Ø¯ÙŠØ© - ${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
                        reference: `SAL${sale.number.toString().padStart(3, '0')}`,
                        debit: 0,
                        credit: sale.paidAmount || 0,
                        type: 'sale'
                    });
                });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
            purchases.filter(p => p.date >= fromDate && p.date <= toDate && (p.paymentMethod === 'cash' || !p.paymentMethod))
                .forEach(purchase => {
                    const supplier = suppliers.find(s => s.id === purchase.supplierId);
                    cashTransactions.push({
                        date: purchase.date,
                        description: `Ù…Ø´ØªØ±ÙŠØ§Øª Ù†Ù‚Ø¯ÙŠØ© - ${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
                        reference: `PUR${purchase.number.toString().padStart(3, '0')}`,
                        debit: purchase.paidAmount || 0,
                        credit: 0,
                        type: 'purchase'
                    });
                });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
            expenses.filter(e => e.date >= fromDate && e.date <= toDate)
                .forEach(expense => {
                    cashTransactions.push({
                        date: expense.date,
                        description: `Ù…ØµØ±ÙˆÙØ§Øª - ${expense.description}`,
                        reference: `EXP${expense.id}`,
                        debit: expense.amount,
                        credit: 0,
                        type: 'expense'
                    });
                });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
            revenues.filter(r => r.date >= fromDate && r.date <= toDate)
                .forEach(revenue => {
                    cashTransactions.push({
                        date: revenue.date,
                        description: `Ø¥ÙŠØ±Ø§Ø¯Ø§Øª - ${revenue.description}`,
                        reference: `REV${revenue.id}`,
                        debit: 0,
                        credit: revenue.amount,
                        type: 'revenue'
                    });
                });
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            cashTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let balance = 0;
            let totalDebits = 0;
            let totalCredits = 0;
            
            let tableHTML = `
                <h3>ğŸ’° ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</h3>
                <table class="account-statement-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                            <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                            <th>Ù…Ø¯ÙŠÙ†</th>
                            <th>Ø¯Ø§Ø¦Ù†</th>
                            <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            cashTransactions.forEach(transaction => {
                balance += transaction.credit - transaction.debit;
                totalDebits += transaction.debit;
                totalCredits += transaction.credit;
                
                tableHTML += `
                    <tr>
                        <td>${transaction.date}</td>
                        <td>${transaction.description}</td>
                        <td>${transaction.reference}</td>
                        <td>${transaction.debit > 0 ? transaction.debit.toFixed(2) : '-'}</td>
                        <td>${transaction.credit > 0 ? transaction.credit.toFixed(2) : '-'}</td>
                        <td class="${balance >= 0 ? 'remaining-paid' : 'remaining-unpaid'}">${balance.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            const summaryHTML = `
                <div class="dashboard-cards">
                    <div class="dashboard-card revenue">
                        <div class="card-value">${totalDebits.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†</div>
                        <div class="card-growth">
                            <span>+9%</span>
                            <span class="growth-icon">ğŸ’¸</span>
                        </div>
                    </div>
                    <div class="dashboard-card customers">
                        <div class="card-value">${totalCredits.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù†</div>
                        <div class="card-growth">
                            <span>+18%</span>
                            <span class="growth-icon">ğŸ’µ</span>
                        </div>
                    </div>
                    <div class="dashboard-card ${balance >= 0 ? 'profit' : 'sales-today'}">
                        <div class="card-value">${balance.toFixed(2)}</div>
                        <div class="card-title">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div>
                        <div class="card-growth">
                            <span>${balance >= 0 ? '+22%' : '-11%'}</span>
                            <span class="growth-icon">${balance >= 0 ? 'ğŸ’°' : 'âš ï¸'}</span>
                        </div>
                    </div>
                    <div class="dashboard-card sales-today">
                        <div class="card-value">${cashTransactions.length}</div>
                        <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</div>
                        <div class="card-growth">
                            <span>+3%</span>
                            <span class="growth-icon">ï¿½</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statementSummary').innerHTML = summaryHTML;
            document.getElementById('statementResults').innerHTML = tableHTML;
        }
        
        // Ø¯Ø§Ù„Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
        function generateTaxStatement(fromDate, toDate) {
            const taxFilter = document.getElementById('taxFilterType').value;
            const TAX_RATE = 0.15; // Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© 15%
            
            let taxTransactions = [];
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            sales.filter(s => s.date >= fromDate && s.date <= toDate).forEach(sale => {
                const customer = customers.find(c => c.id === sale.customerId);
                const hasTax = sale.includeTax || false;
                const baseAmount = hasTax ? sale.total / 1.15 : sale.total;
                const taxAmount = hasTax ? baseAmount * TAX_RATE : 0;
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
                if (taxFilter === 'withTax' && !hasTax) return;
                if (taxFilter === 'withoutTax' && hasTax) return;
                
                taxTransactions.push({
                    date: sale.date,
                    type: 'Ù…Ø¨ÙŠØ¹Ø§Øª',
                    customer: customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                    reference: `SAL${sale.number.toString().padStart(3, '0')}`,
                    baseAmount: baseAmount,
                    taxAmount: taxAmount,
                    total: sale.total,
                    hasTax: hasTax,
                    category: 'sale'
                });
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            purchases.filter(p => p.date >= fromDate && p.date <= toDate).forEach(purchase => {
                const supplier = suppliers.find(s => s.id === purchase.supplierId);
                const hasTax = purchase.includeTax || false;
                const baseAmount = hasTax ? purchase.total / 1.15 : purchase.total;
                const taxAmount = hasTax ? baseAmount * TAX_RATE : 0;
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
                if (taxFilter === 'withTax' && !hasTax) return;
                if (taxFilter === 'withoutTax' && hasTax) return;
                
                taxTransactions.push({
                    date: purchase.date,
                    type: 'Ù…Ø´ØªØ±ÙŠØ§Øª',
                    customer: supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                    reference: `PUR${purchase.number.toString().padStart(3, '0')}`,
                    baseAmount: baseAmount,
                    taxAmount: taxAmount,
                    total: purchase.total,
                    hasTax: hasTax,
                    category: 'purchase'
                });
            });
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            taxTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
            let totalSalesTax = 0;
            let totalPurchasesTax = 0;
            let cumulativeTaxBalance = 0;
            
            let tableHTML = `
                <h3>ğŸ“Š ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%)</h3>
                <table class="account-statement-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
                            <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            taxTransactions.forEach(transaction => {
                // Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù…Ù† Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…ÙˆØ¬Ø¨Ø©
                // Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© ÙÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø³Ø§Ù„Ø¨Ø©
                const taxImpact = transaction.category === 'sale' ? transaction.taxAmount : -transaction.taxAmount;
                cumulativeTaxBalance += taxImpact;
                
                if (transaction.category === 'sale') {
                    totalSalesTax += transaction.taxAmount;
                } else {
                    totalPurchasesTax += transaction.taxAmount;
                }
                
                tableHTML += `
                    <tr>
                        <td>${transaction.date}</td>
                        <td>${transaction.type}</td>
                        <td>${transaction.customer}</td>
                        <td>${transaction.reference}</td>
                        <td>${transaction.baseAmount.toFixed(2)}</td>
                        <td class="${transaction.taxAmount > 0 ? 'remaining-unpaid' : ''}">${transaction.taxAmount.toFixed(2)}</td>
                        <td>${transaction.total.toFixed(2)}</td>
                        <td class="${cumulativeTaxBalance >= 0 ? 'remaining-unpaid' : 'remaining-paid'}">${cumulativeTaxBalance.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            const netTaxDue = totalSalesTax - totalPurchasesTax;
            
            tableHTML += `
                    </tbody>
                    <tfoot>
                        <tr style="font-weight: bold; background: #f5f7fa;">
                            <td colspan="5" style="text-align: left;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª:</td>
                            <td>Ø¶Ø±ÙŠØ¨Ø© Ù…Ø¨ÙŠØ¹Ø§Øª: ${totalSalesTax.toFixed(2)}</td>
                            <td>Ø¶Ø±ÙŠØ¨Ø© Ù…Ø´ØªØ±ÙŠØ§Øª: ${totalPurchasesTax.toFixed(2)}</td>
                            <td class="${netTaxDue >= 0 ? 'remaining-unpaid' : 'remaining-paid'}">ØµØ§ÙÙŠ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${netTaxDue.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            const summaryHTML = `
                <div class="dashboard-cards">
                    <div class="dashboard-card sales-today">
                        <div class="card-value">${totalSalesTax.toFixed(2)}</div>
                        <div class="card-title">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ù…Ø³ØªØ­Ù‚Ø©)</div>
                        <div class="card-growth">
                            <span>ğŸ“¤ Ù„Ù„Ø­ÙƒÙˆÙ…Ø©</span>
                            <span class="growth-icon">â¬†ï¸</span>
                        </div>
                    </div>
                    <div class="dashboard-card profit">
                        <div class="card-value">${totalPurchasesTax.toFixed(2)}</div>
                        <div class="card-title">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ù…Ø¯ÙÙˆØ¹Ø©)</div>
                        <div class="card-growth">
                            <span>ğŸ“¥ Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</span>
                            <span class="growth-icon">â¬‡ï¸</span>
                        </div>
                    </div>
                    <div class="dashboard-card ${netTaxDue >= 0 ? 'revenue' : 'customers'}">
                        <div class="card-value">${netTaxDue.toFixed(2)}</div>
                        <div class="card-title">ØµØ§ÙÙŠ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ${netTaxDue >= 0 ? '(Ù…Ø³ØªØ­Ù‚Ø© Ù„Ù„Ø­ÙƒÙˆÙ…Ø©)' : '(Ù…Ø³ØªØ±Ø¬Ø¹Ø©)'}</div>
                        <div class="card-growth">
                            <span>${netTaxDue >= 0 ? 'ğŸ’¸ ÙŠØ¬Ø¨ Ø§Ù„Ø³Ø¯Ø§Ø¯' : 'ğŸ’° Ø±ØµÙŠØ¯ Ù„ØµØ§Ù„Ø­Ùƒ'}</span>
                            <span class="growth-icon">${netTaxDue >= 0 ? 'âš ï¸' : 'âœ…'}</span>
                        </div>
                    </div>
                    <div class="dashboard-card customers">
                        <div class="card-value">${taxTransactions.length}</div>
                        <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                        <div class="card-growth">
                            <span>ğŸ“‹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                            <span class="growth-icon">ğŸ“Š</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statementSummary').innerHTML = summaryHTML;
            document.getElementById('statementResults').innerHTML = tableHTML;
        }
        
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„ÙƒØ´ÙˆÙ
        function exportStatementToExcel() {
            const statementType = document.getElementById('statementType').value;
            const fromDate = document.getElementById('statementFrom').value;
            const toDate = document.getElementById('statementTo').value;
            
            // Ù…Ù†Ø·Ù‚ ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒØ´Ù Ø¥Ù„Ù‰ Excel
            const table = document.querySelector('#statementResults table');
            if (!table) {
                showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ´Ù Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ CSV
            let csv = '\uFEFF'; // BOM for UTF-8 Excel compatibility
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = [];
                
                cols.forEach(col => {
                    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙˆØ§ØµÙ„
                    let text = col.textContent.trim();
                    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù‚ØªØ¨Ø§Ø³ Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙÙˆØ§ØµÙ„
                    if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                        text = '"' + text.replace(/"/g, '""') + '"';
                    }
                    rowData.push(text);
                });
                
                csv += rowData.join(',') + '\n';
            });
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
            const statementNames = {
                'suppliers': 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†',
                'customers': 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',
                'employees': 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†',
                'bank': 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_Ø§Ù„Ø¨Ù†Ùƒ',
                'cash': 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©',
                'tax': 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©'
            };
            
            const fileName = `${statementNames[statementType] || 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨'}_${fromDate}_${toDate}.csv`;
            
            // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', `ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒØ´Ù Ø¨Ù†Ø¬Ø§Ø­: ${fileName}`, 'success');
            } else {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ', 'error');
            }
        }
        
        function printAccountStatement() {
            const statementResults = document.getElementById('statementResults').innerHTML;
            const statementSummary = document.getElementById('statementSummary').innerHTML;
            
            if (!statementResults) {
                showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ´Ù Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const printContent = `
                <html>
                    <head>
                        <title>ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨</title>
                        <style>
                            body { font-family: 'Tajawal', Arial, sans-serif; direction: rtl; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                            th { background-color: #f8f9fa; }
                            .remaining-unpaid { color: #dc3545; }
                            .remaining-paid { color: #28a745; }
                        </style>
                    </head>
                    <body>
                        ${statementSummary}
                        ${statementResults}
                    </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

console.log('ğŸ” Reached line ~15100 in main script...');

        // ===== Reports Functions =====
        function updateReportItemFilter() {
            const filterType = document.getElementById('reportItemFilter').value;
            const specificItemSelect = document.getElementById('reportSpecificItem');
            if (filterType === 'specific') {
                specificItemSelect.style.display = 'block';
                specificItemSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>';
                items.forEach(item => {
                    specificItemSelect.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                });
            } else {
                specificItemSelect.style.display = 'none';
                specificItemSelect.value = '';
            }
        }
        
        function changeReportType() {
            const reportType = document.getElementById('reportType').value;
            const isInvoiceReport = (reportType === 'sales' || reportType === 'purchases' || reportType === 'sales_returns' || reportType === 'purchase_returns');
            
            // ğŸ”¥ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            document.getElementById('reportResults').innerHTML = '';
            document.getElementById('reportSummary').innerHTML = '';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø£ÙˆÙ„Ø§Ù‹
            const itemFilterDiv = document.getElementById('reportItemFilter').parentElement;
            const specificItemDiv = document.getElementById('reportSpecificItem').parentElement;
            const paymentFilterDiv = document.getElementById('paymentStatusFilter').parentElement;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
            itemFilterDiv.style.display = 'none';
            specificItemDiv.style.display = 'none'; 
            paymentFilterDiv.style.display = 'none';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ± Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            if (isInvoiceReport) {
                itemFilterDiv.style.display = 'block';
                specificItemDiv.style.display = 'block';
            }
            
            if (reportType === 'sales' || reportType === 'purchases') {
                paymentFilterDiv.style.display = 'block';
            }
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù†ÙØ³Ù‡ - Ø³ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "ØµÙ†Ù Ù…Ø­Ø¯Ø¯"
            document.getElementById('reportSpecificItem').style.display = 'none';
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© ÙÙ„ØªØ± Ø§Ù„Ø£ØµÙ†Ø§Ù
            document.getElementById('reportItemFilter').value = 'all';

            const supplierFilter = document.getElementById('reportSupplierFilter');
            const customerFilter = document.getElementById('reportCustomerFilter');

            supplierFilter.style.display = 'none';
            customerFilter.style.display = 'none';

            if (reportType === 'purchases' || reportType === 'purchase_returns') {
                supplierFilter.style.display = 'inline-block';
                supplierFilter.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>';
                suppliers.forEach(supplier => {
                    supplierFilter.innerHTML += `<option value="${supplier.id}">${supplier.name}</option>`;
                });
            } else if (reportType === 'sales' || reportType === 'sales_returns') {
                customerFilter.style.display = 'inline-block';
                customerFilter.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>';
                customers.forEach(customer => {
                    customerFilter.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
                });
            }
            
            // ğŸª ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙˆØ¹
            updateReportBranchFilter();
        }
        
        // ğŸª Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙˆØ¹ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        function updateReportBranchFilter() {
            const branchFilter = document.getElementById('reportBranchFilter');
            if (!branchFilter) return;
            
            const activityBranches = branches.filter(b => b.activityId === currentActivityId);
            
            branchFilter.innerHTML = '<option value="all">ğŸª ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>';
            branchFilter.innerHTML += '<option value="general_admin">ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>';
            branchFilter.innerHTML += '<option value="">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·</option>';
            
            activityBranches.forEach(branch => {
                branchFilter.innerHTML += `<option value="${branch.id}">${branch.name}</option>`;
            });
        }

        // ğŸ”§ Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© (COGS)
        function calculateCOGS(filteredSales) {
            let totalCost = 0;
            
            if (!Array.isArray(filteredSales)) {
                return 0;
            }
            
            filteredSales.forEach(sale => {
                if (sale && Array.isArray(sale.items)) {
                    sale.items.forEach(soldItem => {
                        if (soldItem && soldItem.id) {
                            const masterItem = items.find(item => item.id === soldItem.id);
                            if (masterItem && soldItem.quantity) {
                                const cost = Number(masterItem.cost) || 0;
                                const quantity = Number(soldItem.quantity) || 0;
                                totalCost += quantity * cost;
                            }
                        }
                    });
                }
            });
            
            return totalCost;
        }


function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const fromDate = document.getElementById('reportFrom').value;
    const toDate = document.getElementById('reportTo').value;
    const paymentStatus = document.getElementById('paymentStatusFilter').value;
    const itemFilterType = document.getElementById('reportItemFilter').value;
    const specificItemId = parseInt(document.getElementById('reportSpecificItem').value);
    
    const selectedSupplierId = document.getElementById('reportSupplierFilter').value;
    const selectedCustomerId = document.getElementById('reportCustomerFilter').value;
    const selectedBranchId = document.getElementById('reportBranchFilter').value; // ğŸª ÙÙ„ØªØ± Ø§Ù„ÙØ±Ø¹

    let data = [];
    let reportTitle = '';
    let tableHeaders = '';
    let tableBody = '';
    let summary = {
        count: 0,
        totalAmount: 0,
        totalPaid: 0,
        totalRemaining: 0,
        totalBasic: 0,
        totalAllowances: 0,
        totalGross: 0,
        totalGosiEmployee: 0,
        totalGosiEmployer: 0,
        totalOtherDeductions: 0,
        totalNet: 0
    };

    switch (reportType) {
        case 'sales': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª';
            tableHeaders = `<th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ø®ØµÙ…</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>`;
            let src = Array.isArray(sales) ? sales : [];
            data = src.filter(s => (!fromDate || s.date >= fromDate) && (!toDate || s.date <= toDate));
            
            if (selectedCustomerId !== 'all') {
                data = data.filter(s => s.customerId == selectedCustomerId);
            }
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            if (selectedBranchId === 'all') {
                // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹ - Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¡
            } else if (selectedBranchId === '') {
                data = data.filter(s => !s.branchId); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                data = data.filter(s => s.branchId == selectedBranchId); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
            break;
        }
        case 'purchases': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª';
            tableHeaders = `<th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>`;
            let src = Array.isArray(purchases) ? purchases : [];
            data = src.filter(p => (!fromDate || p.date >= fromDate) && (!toDate || p.date <= toDate));

            if (selectedSupplierId !== 'all') {
                data = data.filter(p => p.supplierId == selectedSupplierId);
            }
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            if (selectedBranchId === 'all') {
                // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else if (selectedBranchId === 'general_admin') {
                data = data.filter(p => p.branchId === 'general_admin'); // Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø·
            } else if (selectedBranchId === '') {
                data = data.filter(p => !p.branchId || p.branchId === ''); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                data = data.filter(p => p.branchId == selectedBranchId); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
            break;
        }
        case 'sales_returns': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª';
            tableHeaders = `<th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>`;
            let src = Array.isArray(salesReturns) ? salesReturns : [];
            data = src.filter(r => (!fromDate || r.date >= fromDate) && (!toDate || r.date <= toDate));
            
            if (selectedCustomerId !== 'all') {
                data = data.filter(r => r.customerId == selectedCustomerId);
            }
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            if (selectedBranchId === 'all') {
                // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else if (selectedBranchId === '') {
                data = data.filter(r => !r.branchId); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                data = data.filter(r => r.branchId == selectedBranchId); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
            break;
        }
        case 'purchase_returns': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª';
            tableHeaders = `<th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>`;
            let src = Array.isArray(purchaseReturns) ? purchaseReturns : [];
            data = src.filter(r => (!fromDate || r.date >= fromDate) && (!toDate || r.date <= toDate));

            if (selectedSupplierId !== 'all') {
                data = data.filter(r => r.supplierId == selectedSupplierId);
            }
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            if (selectedBranchId === 'all') {
                // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else if (selectedBranchId === '') {
                data = data.filter(r => !r.branchId); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                data = data.filter(r => r.branchId == selectedBranchId); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
            break;
        }
        case 'expenses': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª';
            tableHeaders = `<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th>`;
            const src = Array.isArray(expenses) ? expenses : [];
            data = src.filter(e => (!fromDate || e.date >= fromDate) && (!toDate || e.date <= toDate));
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            if (selectedBranchId === 'all') {
                // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else if (selectedBranchId === 'general_admin') {
                data = data.filter(e => e.branchId === 'general_admin'); // Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø·
            } else if (selectedBranchId === '') {
                data = data.filter(e => !e.branchId || e.branchId === ''); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                data = data.filter(e => e.branchId == selectedBranchId); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
            break;
        }
        case 'revenues': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª';
            tableHeaders = `<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„Ù…ØµØ¯Ø±</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th>`;
            const src = Array.isArray(revenues) ? revenues : [];
            data = src.filter(r => (!fromDate || r.date >= fromDate) && (!toDate || r.date <= toDate));
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            if (selectedBranchId === 'all') {
                // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else if (selectedBranchId === '') {
                data = data.filter(r => !r.branchId); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                data = data.filter(r => r.branchId == selectedBranchId); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
            break;
        }
        case 'salaries': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨';
            tableHeaders = `<th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th><th>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th><th>Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ GOSI</th><th>Ù…Ø³Ø§Ù‡Ù…Ø© Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„</th><th>Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰</th><th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</th>`;
            const src = Array.isArray(salaries) ? salaries : [];
            data = src.filter(salary => {
                if (!salary) return false;
                const monthValue = salary.month ? `${salary.month}-01` : '';
                const afterFrom = !fromDate || (monthValue && monthValue >= fromDate);
                const beforeTo = !toDate || (monthValue && monthValue <= toDate);
                return afterFrom && beforeTo;
            });
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            if (selectedBranchId === 'all') {
                // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else if (selectedBranchId === 'general_admin') {
                data = data.filter(s => s.branchId === 'general_admin'); // Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø·
            } else if (selectedBranchId === '') {
                data = data.filter(s => !s.branchId || s.branchId === ''); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                data = data.filter(s => s.branchId == selectedBranchId); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
            break;
        }
        case 'profit_loss': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø©';

            const filteredSales = (Array.isArray(sales) ? sales : [])
                .filter(s => (!fromDate || s.date >= fromDate) && (!toDate || s.date <= toDate));
            const filteredExpenses = (Array.isArray(expenses) ? expenses : [])
                .filter(e => (!fromDate || e.date >= fromDate) && (!toDate || e.date <= toDate));
            const filteredRevenues = (Array.isArray(revenues) ? revenues : [])
                .filter(r => (!fromDate || r.date >= fromDate) && (!toDate || r.date <= toDate));

            const totalSalesRevenue = filteredSales.reduce((sum, sale) => sum + (Number(sale.total) || 0), 0);
            const totalOtherRevenues = filteredRevenues.reduce((sum, revenue) => sum + (Number(revenue.amount) || 0), 0);
            const totalCOGS = calculateCOGS(filteredSales);
            const grossProfit = totalSalesRevenue - totalCOGS;
            const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + (Number(expense.amount) || 0), 0);
            
            // ğŸ”¥ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ: ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„)
            const netProfitFromOperations = grossProfit + totalOtherRevenues - totalExpenses;

            let summaryHtml = `<h3>Ù…Ù„Ø®Øµ ${reportTitle}</h3>
                <p><strong>Ø§Ù„ÙØªØ±Ø© Ù…Ù†:</strong> ${fromDate || 'Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'} <strong>Ø¥Ù„Ù‰:</strong> ${toDate || 'Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'}</p>
                <p><strong>Ø¹Ø¯Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</strong> ${filteredSales.length}</p>
                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</strong> ${filteredExpenses.length}</p>
                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰:</strong> ${filteredRevenues.length}</p>`;
            document.getElementById('reportSummary').innerHTML = summaryHtml;

            let resultsHtml = `
                <h3 style="margin-top:20px;">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø© (Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©)</h3>
                <table style="text-align: right; margin-bottom: 30px;">
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;"><strong>ï¿½ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</strong></td>
                        <td style="padding: 10px; color: var(--success-color); font-weight: bold;">${totalSalesRevenue.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">(-) ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</td>
                        <td style="padding: 10px; color: var(--accent-color);">${totalCOGS.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 2px solid #333; font-size: 1.05em;">
                        <td style="padding: 10px;"><strong>(=) Ù…Ø¬Ù…Ù„ Ø±Ø¨Ø­ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</strong></td>
                        <td style="padding: 10px; font-weight: bold;">${grossProfit.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">ğŸ’¡ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰</td>
                        <td style="padding: 10px; color: var(--success-color);">${totalOtherRevenues.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">(-) Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</td>
                        <td style="padding: 10px; color: var(--accent-color);">${totalExpenses.toFixed(2)}</td>
                    </tr>
                    <tr style="background: ${netProfitFromOperations >= 0 ? 'var(--success-color)' : 'var(--accent-color)'}; color: white; font-size: 1.2em; border-radius: 8px;">
                        <td style="padding: 15px;"><strong>(=) ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</strong></td>
                        <td style="padding: 15px; font-weight: bold;">${netProfitFromOperations.toFixed(2)}</td>
                    </tr>
                </table>`;
            document.getElementById('reportResults').innerHTML = resultsHtml;
            
            // ğŸ”¥ Ø§Ù„Ø¢Ù† Ù†ÙƒÙ…Ù„ Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙƒØ´Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
            let detailedData = [];
            
            // Ø¥Ø¶Ø§ÙØ© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            filteredSales.forEach(sale => {
                detailedData.push({
                    type: 'Ù…Ø¨ÙŠØ¹Ø©',
                    number: `SAL${sale.number.toString().padStart(3, '0')}`,
                    date: sale.date,
                    description: (Array.isArray(customers) ? customers : []).find(c => c.id === sale.customerId)?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                    debit: 0,
                    credit: Number(sale.total) || 0
                });
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
            filteredExpenses.forEach(expense => {
                detailedData.push({
                    type: 'Ù…ØµØ±ÙˆÙ',
                    number: `EXP${expense.number?.toString().padStart(3, '0') || '---'}`,
                    date: expense.date,
                    description: expense.description || 'Ù…ØµØ±ÙˆÙ',
                    debit: Number(expense.amount) || 0,
                    credit: 0
                });
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
            filteredRevenues.forEach(revenue => {
                detailedData.push({
                    type: 'Ø¥ÙŠØ±Ø§Ø¯',
                    number: `REV${revenue.number?.toString().padStart(3, '0') || '---'}`,
                    date: revenue.date,
                    description: revenue.description || 'Ø¥ÙŠØ±Ø§Ø¯ Ø¢Ø®Ø±',
                    debit: 0,
                    credit: Number(revenue.amount) || 0
                });
            });
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            detailedData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒØ´Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
            if (detailedData.length > 0) {
                let detailedTableBody = '';
                detailedData.forEach(item => {
                    detailedTableBody += `<tr>
                        <td>${item.number}</td>
                        <td>${item.date}</td>
                        <td>${item.type}</td>
                        <td>${item.description}</td>
                        <td style="color: var(--accent-color); font-weight: bold;">${item.debit.toFixed(2)}</td>
                        <td style="color: var(--success-color); font-weight: bold;">${item.credit.toFixed(2)}</td>
                    </tr>`;
                });

                document.getElementById('reportTable').innerHTML = `
                    <div style="margin-top: 30px;">
                        <h3>ğŸ“‹ Ø§Ù„ÙƒØ´Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th>Ø§Ù„ÙˆØµÙ</th>
                                    <th style="color: var(--accent-color);">Ù…Ø¯ÙŠÙ†</th>
                                    <th style="color: var(--success-color);">Ø¯Ø§Ø¦Ù†</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${detailedTableBody}
                            </tbody>
                        </table>
                    </div>`;
            } else {
                document.getElementById('reportTable').innerHTML = '<p style="text-align: center; margin-top: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>';
            }
            return;
        }
    }

    if (reportType === 'sales' || reportType === 'purchases') {
        if (paymentStatus === 'paid' || paymentStatus === 'unpaid') {
            data = data.filter(inv => {
                const total = Number(inv.total) || 0;
                const paid = Number(inv.paidAmount) || 0;
                const remaining = total - paid;
                
                if (paymentStatus === 'paid') {
                    return remaining <= 0.01;
                } else {
                    return remaining > 0.01;
                }
            });
        }
    }

    if ((reportType === 'sales' || reportType === 'purchases' || reportType === 'sales_returns' || reportType === 'purchase_returns')
        && itemFilterType === 'specific' && specificItemId) {
        data = data.filter(invoice =>
            Array.isArray(invoice.items) && invoice.items.some(it => it.id === specificItemId)
        );
    }

if (data.length > 0) {
    data.forEach(item => {
        if (reportType === 'sales') {
            const customer = (Array.isArray(customers) ? customers : []).find(c => c.id === item.customerId);
            const subtotal = Number(item.subtotal) || 0;
            const discount = Number(item.discount) || 0;
            const total = Number(item.total) || 0;
            const paid  = Number(item.paidAmount) || 0;
            const remaining = total - paid;
            
            // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            const getPaymentMethodForReport = (method) => {
                switch(method) {
                    case 'cash': return 'ÙƒØ§Ø´';
                    case 'bank': return 'Ø¨Ù†Ùƒ';
                    case 'mixed': return 'Ù…Ø®ØªÙ„Ø·';
                    default: return 'ÙƒØ§Ø´';
                }
            };

            tableBody += `<tr>
                <td>SAL${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                <td>${subtotal > 0 ? subtotal.toFixed(2) : total.toFixed(2)}</td>
                <td>${discount.toFixed(2)}</td>
                <td>${total.toFixed(2)}</td>
                <td>${paid.toFixed(2)}</td>
                <td>${getPaymentMethodForReport(item.paymentMethod)}</td>
                <td class="${Math.abs(remaining) <= 0.01 ? 'remaining-paid' : 'remaining-unpaid'}">${remaining.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;
            summary.totalPaid   += paid;
            summary.totalRemaining += remaining;

        } else if (reportType === 'purchases') {
            const supplier = (Array.isArray(suppliers) ? suppliers : []).find(s => s.id === item.supplierId);
            const total = Number(item.total) || 0;
            const paid  = Number(item.paidAmount) || 0;
            const remaining = total - paid;

            tableBody += `<tr>
                <td>PUR${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                <td>${total.toFixed(2)}</td>
                <td>${paid.toFixed(2)}</td>
                <td class="${Math.abs(remaining) <= 0.01 ? 'remaining-paid' : 'remaining-unpaid'}">${remaining.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;
            summary.totalPaid   += paid;
            summary.totalRemaining += remaining;

        } else if (reportType === 'sales_returns') {
            const customer = (Array.isArray(customers) ? customers : []).find(c => c.id === item.customerId);
            const total = Number(item.total) || 0;
            const originalSale = (Array.isArray(sales) ? sales : []).find(s => s.id === item.saleId);
            const originalInvoiceNumber = originalSale ? `SAL${originalSale.number.toString().padStart(3, '0')}` : '-';

            tableBody += `<tr>
                <td>SR${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                <td>${originalInvoiceNumber}</td>
                <td>${total.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;

        } else if (reportType === 'purchase_returns') {
            const supplier = (Array.isArray(suppliers) ? suppliers : []).find(s => s.id === item.supplierId);
            const total = Number(item.total) || 0;
            const originalPurchase = (Array.isArray(purchases) ? purchases : []).find(p => p.id === item.purchaseId);
            const originalInvoiceNumber = originalPurchase ? `PUR${originalPurchase.number.toString().padStart(3, '0')}` : '-';

            tableBody += `<tr>
                <td>PR${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                <td>${originalInvoiceNumber}</td>
                <td>${total.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;

        } else if (reportType === 'expenses') {
                const amount = Number(item.amount) || 0;
                tableBody += `<tr>
                    <td>${item.date}</td>
                    <td>${item.category}</td>
                    <td>${item.description || '-'}</td>
                    <td>${amount.toFixed(2)}</td>
                </tr>`;
                summary.totalAmount += amount;

            } else if (reportType === 'revenues') {
                const amount = Number(item.amount) || 0;
                tableBody += `<tr>
                    <td>${item.date}</td>
                    <td>${item.category}</td>
                    <td>${getRevenueSourceName(item.source)}</td>
                    <td>${amount.toFixed(2)}</td>
                </tr>`;
                summary.totalAmount += amount;
                } else if (reportType === 'salaries') {
                    const basic = normalizeAmount(item.basic);
                    const housing = normalizeAmount(item.housing);
                    const transport = normalizeAmount(item.transport);
                    const otherAllowances = normalizeAmount(item.otherAllowances);
                    const overtime = normalizeAmount(item.overtime);
                    const allowances = typeof item.allowancesTotal === 'number' ? item.allowancesTotal : housing + transport + otherAllowances + overtime;
                    const gross = typeof item.gross === 'number' ? item.gross : basic + allowances;
                    const gosiEmployee = normalizeAmount(item.gosiEmployee);
                    const gosiEmployer = normalizeAmount(item.gosiEmployer);
                    const otherDeductions = normalizeAmount(item.otherDeductions);
                    const net = typeof item.net === 'number' ? item.net : gross - gosiEmployee - otherDeductions;

                    tableBody += `<tr>
                        <td>${item.employeeName || '-'}</td>
                        <td>${item.month || '-'}</td>
                        <td>${item.jobTitle || '-'}</td>
                        <td>${formatCurrency(basic)}</td>
                        <td>${formatCurrency(allowances)}</td>
                        <td>${formatCurrency(gross)}</td>
                        <td>${formatCurrency(gosiEmployee)}</td>
                        <td>${formatCurrency(gosiEmployer)}</td>
                        <td>${formatCurrency(otherDeductions)}</td>
                        <td>${formatCurrency(net)}</td>
                    </tr>`;

                    summary.totalBasic += basic;
                    summary.totalAllowances += allowances;
                    summary.totalGross += gross;
                    summary.totalGosiEmployee += gosiEmployee;
                    summary.totalGosiEmployer += gosiEmployer;
                    summary.totalOtherDeductions += otherDeductions;
                    summary.totalNet += net;
                    summary.totalAmount += net;
            }
        });
        summary.count = data.length;
    }

    const summaryDiv = document.getElementById('reportSummary');
    let summaryHtml = `<h3>Ù…Ù„Ø®Øµ ${reportTitle}</h3>`;
    if (reportType === 'sales' || reportType === 'purchases') {
        summaryHtml += `
            <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</strong> ${summary.count}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº:</strong> ${summary.totalAmount.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${summary.totalPaid.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${summary.totalRemaining.toFixed(2)}</p>`;
    } else if (reportType === 'sales_returns' || reportType === 'purchase_returns') {
        summaryHtml += `
            <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª:</strong> ${summary.count}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª:</strong> ${summary.totalAmount.toFixed(2)}</p>`;
    } else if (reportType === 'salaries') {
        summaryHtml += `
            <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ÙŠØ±Ø§Øª:</strong> ${summary.count}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</strong> ${summary.totalBasic.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª:</strong> ${summary.totalAllowances.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨:</strong> ${summary.totalGross.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª GOSI Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†:</strong> ${summary.totalGosiEmployee.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³Ø§Ù‡Ù…Ø§Øª Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ GOSI:</strong> ${summary.totalGosiEmployer.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰:</strong> ${summary.totalOtherDeductions.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµØ§ÙÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨:</strong> ${summary.totalNet.toFixed(2)}</p>`;
    } else {
        summaryHtml += `
            <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:</strong> ${summary.count}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº:</strong> ${summary.totalAmount.toFixed(2)}</p>`;
    }
    summaryDiv.innerHTML = summaryHtml;

    const resultsDiv = document.getElementById('reportResults');
    if (tableBody) {
        if (reportType === 'sales' || reportType === 'purchases') {
            if (reportType === 'sales') {
                tableBody += `<tr class="report-total-row">
                    <td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                    <td>-</td>
                    <td>-</td>
                    <td>${summary.totalAmount.toFixed(2)}</td>
                    <td>${summary.totalPaid.toFixed(2)}</td>
                    <td>-</td>
                    <td>${summary.totalRemaining.toFixed(2)}</td>
                </tr>`;
            } else {
                tableBody += `<tr class="report-total-row">
                    <td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                    <td>${summary.totalAmount.toFixed(2)}</td>
                    <td>${summary.totalPaid.toFixed(2)}</td>
                    <td>${summary.totalRemaining.toFixed(2)}</td>
                </tr>`;
            }
        } else if (reportType === 'sales_returns' || reportType === 'purchase_returns') {
            tableBody += `<tr class="report-total-row">
                <td colspan="4">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                <td>${summary.totalAmount.toFixed(2)}</td>
            </tr>`;
        } else if (reportType === 'salaries') {
            tableBody += `<tr class="report-total-row">
                <td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                <td>${summary.totalBasic.toFixed(2)}</td>
                <td>${summary.totalAllowances.toFixed(2)}</td>
                <td>${summary.totalGross.toFixed(2)}</td>
                <td>${summary.totalGosiEmployee.toFixed(2)}</td>
                <td>${summary.totalGosiEmployer.toFixed(2)}</td>
                <td>${summary.totalOtherDeductions.toFixed(2)}</td>
                <td>${summary.totalNet.toFixed(2)}</td>
            </tr>`;
        } else {
            tableBody += `<tr class="report-total-row">
                <td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                <td>${summary.totalAmount.toFixed(2)}</td>
            </tr>`;
        }

        resultsDiv.innerHTML = `
            <h3 style="margin-top:20px;">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
            <table>
                <thead><tr>${tableHeaders}</tr></thead>
                <tbody>${tableBody}</tbody>
            </table>`;
    } else {
        resultsDiv.innerHTML = `<p style="text-align: center; margin-top: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</p>`;
    }
}


        function exportToExcel() {
            const reportTable = document.querySelector("#reportResults table");
            if (!reportTable) {
                showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ±', 'ÙŠØ±Ø¬Ù‰ Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±', 'warning');
                return;
            }

            let csv = [];
            const headers = [];
            reportTable.querySelectorAll("thead th").forEach(header => headers.push(`"${header.innerText}"`));
            csv.push(headers.join(','));

            reportTable.querySelectorAll("tbody tr").forEach(row => {
                const rowData = [];
                row.querySelectorAll("td").forEach(cell => rowData.push(`"${cell.innerText}"`));
                csv.push(rowData.join(','));
            });

            const csvContent = "data:text/csv;charset=utf-8," + '\uFEFF' + csv.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const reportType = document.getElementById('reportType').value;
            link.setAttribute("download", `report_${reportType}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToWeb() {
            const reportResultsHTML = document.getElementById('reportResults').innerHTML;
            const reportSummaryHTML = document.getElementById('reportSummary').innerHTML;

            if (!reportResultsHTML.trim() || reportResultsHTML.includes("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª")) {
                showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ±', 'ÙŠØ±Ø¬Ù‰ Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±', 'warning');
                return;
            }
            
            const reportType = document.getElementById('reportType').value;
            const reportTitle = `ØªÙ‚Ø±ÙŠØ± ${document.querySelector(`#reportType option[value='${reportType}']`).textContent}`;

            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                    <head>
                        <title>${reportTitle}</title>
                        <meta charset="UTF-8">
                        <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">



                        <style>
                            body { font-family: 'Tajawal', sans-serif; direction: rtl; padding: 20px; color: #2c3e50; }
                            h1, h3 { color: #2c5aa0; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 14px; }
                            th, td { border: 1px solid #ddd; padding: 10px; text-align: right; }
                            th { background-color: #2c5aa0; color: white; }
                            tr:nth-child(even) { background-color: #f8f9fa; }
                            .report-summary { border: 1px solid #ddd; border-right: 5px solid #2c5aa0; padding: 15px; margin-bottom: 20px; background: #f8f9fa; border-radius: 8px; }
                            .report-total-row { font-weight: bold; background-color: #34495e; color: white; }
                            .remaining-paid { color: #27ae60; font-weight: bold; }
                            .remaining-unpaid { color: #e74c3c; font-weight: bold; }
                            @media print {
                                body { padding: 10px; }
                                button { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>${reportTitle}</h1>
                        <div class="report-summary">${reportSummaryHTML}</div>
                        ${reportResultsHTML}
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="window.print()" style="padding: 10px 20px; background: #2c5aa0; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-right: 10px;">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </body>
                </html>
            `);
            newWindow.document.close();
        }

        // ===== Data Management Functions =====
        function ensureActivitySelected() {
            if (!currentActivityId) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø´Ø§Ø· Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'warning');
                return false;
            }
            return true;
        }

        async function refreshActivityData() {
            if (!currentActivityId) return;
            initializeApp();
        }

        function updateDataStats() {
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            setText('dataItemsCount', items.length);
            setText('dataCustomersCount', customers.length);
            setText('dataSuppliersCount', suppliers.length);
            setText('dataPurchasesCount', purchases.length);
            setText('dataSalesCount', sales.length);
            setText('dataExpensesCount', expenses.length);
            setText('dataRevenuesCount', revenues.length);
            setText('dataSalariesCount', salaries.length);
            setText('dataStockQuantity', calculateTotalStock());
            const hasActivity = Boolean(currentActivityId);
            let lastBackupText = 'ØºÙŠØ± Ù…ØªØ§Ø­';
            if (hasActivity) {
                const backupKey = getActivityDataKey('lastBackup');
                const lastBackup = backupKey ? localStorage.getItem(backupKey) : null;
                lastBackupText = lastBackup ? new Date(lastBackup).toLocaleDateString('ar-SA') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            }
            setText('dataLastBackup', lastBackupText);
        }

        function exportActivityData() {
            if (!ensureActivitySelected()) return;
            const activity = activities.find(a => a.id == currentActivityId);
            const activityData = { items, customers, suppliers, purchases, sales, expenses, revenues, salaries, salesReturns, purchaseReturns, exportDate: new Date().toISOString(), system: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ', activityName: activity ? activity.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' };
            const dataStr = JSON.stringify(activityData, null, 2);
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([dataStr], {type: 'application/json'}));
            link.download = `Ø§Ù„Ø¯ÙŠÙˆØ§Ù†_${activity ? activity.name.replace(/\s/g, '_') : 'Ø¨ÙŠØ§Ù†Ø§Øª'}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showNotification('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        function exportActivityDataExcel() {
            if (!ensureActivitySelected()) return;
            if (!window.XLSX || !XLSX.utils || typeof XLSX.utils.book_new !== 'function') {
                showNotification('âŒ Ø®Ø·Ø£', 'Ù…ÙƒØªØ¨Ø© Excel ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
                return;
            }

            const activity = activities.find(a => a.id == currentActivityId);
            const workbook = XLSX.utils.book_new();
            const todayISO = new Date().toISOString();
            const todayDate = todayISO.split('T')[0];

            const safeSheetName = (name) => {
                if (!name) return 'Sheet';
                const invalidChars = /[:\\\/?*\[\]]/g;
                const cleaned = name.replace(invalidChars, ' ');
                return cleaned.length > 30 ? cleaned.substring(0, 27) + '...' : cleaned;
            };

            const formatDocNumber = (prefix, number) => {
                if (typeof number === 'number') {
                    return `${prefix}${number.toString().padStart(3, '0')}`;
                }
                return `${prefix}${number || ''}`;
            };

            const formatItemsList = (list) => {
                if (!Array.isArray(list) || list.length === 0) return '';
                return list.map(item => {
                    const name = item && item.name ? item.name : '';
                    const qty = item && typeof item.quantity === 'number' ? item.quantity : 0;
                    const price = item && typeof item.price === 'number' ? item.price : 0;
                    return `${name} x${qty} @${price}`;
                }).join('\n');
            };

            const appendSheet = (rows, title) => {
                const preparedRows = (Array.isArray(rows) && rows.length) ? rows : [{ 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª': '' }];
                const worksheet = XLSX.utils.json_to_sheet(preparedRows);
                XLSX.utils.book_append_sheet(workbook, worksheet, safeSheetName(title));
            };

            const summaryRows = [
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': activity ? activity.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': new Date().toLocaleString('ar-SA') },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': items.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': customers.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': suppliers.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': purchases.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': sales.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': expenses.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': revenues.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': salaries.length }
            ];
            appendSheet(summaryRows, 'Ù…Ù„Ø®Øµ');

            appendSheet(items.map(item => ({
                'Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù': item.code || '',
                'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù': item.name || '',
                'ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡': typeof item.cost === 'number' ? item.cost : Number(item.cost) || 0,
                'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹': typeof item.price === 'number' ? item.price : Number(item.price) || 0,
                'Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ': typeof item.stock === 'number' ? item.stock : Number(item.stock) || 0
            })), 'Ø§Ù„Ø£ØµÙ†Ø§Ù');

            appendSheet(customers.map(customer => ({
                'Ø±Ù…Ø² Ø§Ù„Ø¹Ù…ÙŠÙ„': customer.code || '',
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„': customer.name || '',
                'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„': customer.phone || '',
                'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ': customer.email || '',
                'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†': customer.address || ''
            })), 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡');

            appendSheet(suppliers.map(supplier => ({
                'Ø±Ù…Ø² Ø§Ù„Ù…ÙˆØ±Ø¯': supplier.code || '',
                'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯': supplier.name || '',
                'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„': supplier.phone || '',
                'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ': supplier.email || '',
                'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†': supplier.address || ''
            })), 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†');

            appendSheet(purchases.map(purchase => {
                const supplier = suppliers.find(s => s.id === purchase.supplierId);
                const remaining = (purchase && typeof purchase.remainingAmount === 'number')
                    ? purchase.remainingAmount
                    : (purchase.total || 0) - (purchase.paidAmount || 0);
                return {
                    'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©': formatDocNumber('PUR', purchase.number),
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': purchase.date || '',
                    'Ø§Ù„Ù…ÙˆØ±Ø¯': supplier ? supplier.name : '',
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù': Array.isArray(purchase.items) ? purchase.items.length : 0,
                    'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª': typeof purchase.total === 'number' ? purchase.total : Number(purchase.total) || 0,
                    'Ø§Ù„Ù…Ø¯ÙÙˆØ¹': typeof purchase.paidAmount === 'number' ? purchase.paidAmount : Number(purchase.paidAmount) || 0,
                    'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': remaining,
                    'Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©': formatItemsList(purchase.items),
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': purchase.notes || ''
                };
            }), 'ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');

            appendSheet(sales.map(sale => {
                const customer = customers.find(c => c.id === sale.customerId);
                const remaining = (sale && typeof sale.remainingAmount === 'number')
                    ? sale.remainingAmount
                    : (sale.total || 0) - (sale.paidAmount || 0);
                return {
                    'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©': formatDocNumber('SAL', sale.number),
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': sale.date || '',
                    'Ø§Ù„Ø¹Ù…ÙŠÙ„': customer ? customer.name : '',
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù': Array.isArray(sale.items) ? sale.items.length : 0,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©': typeof sale.total === 'number' ? sale.total : Number(sale.total) || 0,
                    'Ø§Ù„Ù…Ø¯ÙÙˆØ¹': typeof sale.paidAmount === 'number' ? sale.paidAmount : Number(sale.paidAmount) || 0,
                    'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': remaining,
                    'ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©': sale.taxApplied === false ? 'Ù„Ø§' : 'Ù†Ø¹Ù…',
                    'Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©': formatItemsList(sale.items),
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': sale.notes || ''
                };
            }), 'ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');

            appendSheet(expenses.map(expense => ({
                'Ø§Ù„ØªØ§Ø±ÙŠØ®': expense.date || '',
                'Ø§Ù„ØªØµÙ†ÙŠÙ': expense.category || '',
                'Ø§Ù„Ù…Ø¨Ù„Øº': typeof expense.amount === 'number' ? expense.amount : Number(expense.amount) || 0,
                'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹': getPaymentMethodName ? getPaymentMethodName(expense.paymentMethod) : (expense.paymentMethod || ''),
                'Ø§Ù„Ù…Ø±Ø¬Ø¹': expense.reference || '',
                'Ø§Ù„ÙˆØµÙ': expense.description || ''
            })), 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª');

            appendSheet(revenues.map(revenue => ({
                'Ø§Ù„ØªØ§Ø±ÙŠØ®': revenue.date || '',
                'Ø§Ù„ØªØµÙ†ÙŠÙ': revenue.category || '',
                'Ø§Ù„Ù…ØµØ¯Ø±': getRevenueSourceName ? getRevenueSourceName(revenue.source) : (revenue.source || ''),
                'Ø§Ù„Ù…Ø¨Ù„Øº': typeof revenue.amount === 'number' ? revenue.amount : Number(revenue.amount) || 0,
                'Ø§Ù„Ù…Ø±Ø¬Ø¹': revenue.reference || '',
                'Ø§Ù„ÙˆØµÙ': revenue.description || ''
            })), 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª');

            appendSheet(salaries.map(salary => ({
                'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù': salary.employeeName || '',
                'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©': salary.employeeId || '',
                'Ø´Ù‡Ø± Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚': salary.month || '',
                'Ø³Ø¹ÙˆØ¯ÙŠØŸ': salary.isSaudi ? 'Ù†Ø¹Ù…' : 'Ù„Ø§',
                'Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ': typeof salary.basic === 'number' ? salary.basic : Number(salary.basic) || 0,
                'Ø¨Ø¯Ù„ Ø§Ù„Ø³ÙƒÙ†': typeof salary.housing === 'number' ? salary.housing : Number(salary.housing) || 0,
                'Ø¨Ø¯Ù„ Ø§Ù„Ù†Ù‚Ù„': typeof salary.transport === 'number' ? salary.transport : Number(salary.transport) || 0,
                'Ø¨Ø¯Ù„Ø§Øª Ø£Ø®Ø±Ù‰': typeof salary.otherAllowances === 'number' ? salary.otherAllowances : Number(salary.otherAllowances) || 0,
                'Ø³Ø§Ø¹Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©': typeof salary.overtime === 'number' ? salary.overtime : Number(salary.overtime) || 0,
                'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø§ØªØ¨': typeof salary.gross === 'number' ? salary.gross : Number(salary.gross) || 0,
                'Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª (GOSI)': typeof salary.gosiEmployee === 'number' ? salary.gosiEmployee : Number(salary.gosiEmployee) || 0,
                'Ù…Ø³Ø§Ù‡Ù…Ø© Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„ (GOSI)': typeof salary.gosiEmployer === 'number' ? salary.gosiEmployer : Number(salary.gosiEmployer) || 0,
                'Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰': typeof salary.otherDeductions === 'number' ? salary.otherDeductions : Number(salary.otherDeductions) || 0,
                'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨': typeof salary.net === 'number' ? salary.net : Number(salary.net) || 0,
                'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': salary.notes || ''
            })), 'Ø§Ù„Ø±ÙˆØ§ØªØ¨');

            appendSheet(purchaseReturns.map(returnDoc => {
                const supplier = suppliers.find(s => s.id === returnDoc.supplierId);
                return {
                    'Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹': formatDocNumber('PR', returnDoc.number),
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': returnDoc.date || '',
                    'Ø§Ù„Ù…ÙˆØ±Ø¯': supplier ? supplier.name : '',
                    'ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©': formatDocNumber('PUR', returnDoc.originalInvoiceNumber),
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©': typeof returnDoc.total === 'number' ? returnDoc.total : Number(returnDoc.total) || 0,
                    'Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©': formatItemsList(returnDoc.items)
                };
            }), 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');

            appendSheet(salesReturns.map(returnDoc => {
                const customer = customers.find(c => c.id === returnDoc.customerId);
                return {
                    'Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹': formatDocNumber('SR', returnDoc.number),
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': returnDoc.date || '',
                    'Ø§Ù„Ø¹Ù…ÙŠÙ„': customer ? customer.name : '',
                    'ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©': formatDocNumber('SAL', returnDoc.originalInvoiceNumber),
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©': typeof returnDoc.total === 'number' ? returnDoc.total : Number(returnDoc.total) || 0,
                    'Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©': formatItemsList(returnDoc.items)
                };
            }), 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');

            const fileName = `Ø§Ù„Ø¯ÙŠÙˆØ§Ù†_${activity ? activity.name.replace(/\s/g, '_') : 'Ø¨ÙŠØ§Ù†Ø§Øª'}_${todayDate}_Excel.xlsx`;
            XLSX.writeFile(workbook, fileName);
            showNotification('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
        }

        async function importData() {
            if (!ensureActivitySelected()) return;
            const confirmed = await showConfirmDialog(
                'Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                'ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ',
                'warning',
                'Ù…ØªØ§Ø¨Ø¹Ø©',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                document.getElementById('importFile').click();
            }
        }

         async function handleFileImport(files) { // Ø£Ø¶ÙÙ†Ø§ ÙƒÙ„Ù…Ø© async
     if (!files.length) return;
     if (!ensureActivitySelected()) return;
    const reader = new FileReader();
    reader.onload = async function(e) { // Ø£Ø¶ÙÙ†Ø§ ÙƒÙ„Ù…Ø© async Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹
        try {
            const importedData = JSON.parse(e.target.result);
            if (!importedData.system || !importedData.system.includes('Ø§Ù„Ø¯ÙŠÙˆØ§Ù†')) {
                showNotification('âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­', 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù', 'error');
                return;
            }
            const confirmed = await showConfirmDialog(
                'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯',
                'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØŸ',
                'info',
                'Ù†Ø¹Ù…',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {

                // Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙØ¸
                const savePromises = [];
                const keysToImport = ['items', 'customers', 'suppliers', 'purchases', 'sales', 'expenses', 'revenues', 'salaries', 'salesReturns', 'purchaseReturns'];

                keysToImport.forEach(key => {
                    if (importedData[key] && Array.isArray(importedData[key])) {
                        // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase
                        savePromises.push(saveToLocalStorage(key, importedData[key]));
                    }
                });

                // Ù†Ù†ØªØ¸Ø± Ø­ØªÙ‰ ØªÙƒØªÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙØ¸
                const saveResults = await Promise.all(savePromises);
                if (savePromises.length && saveResults.some(result => !result)) {
                    showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
                    return;
                }

                await refreshActivityData();
                const importInput = document.getElementById('importFile');
                if (importInput) {
                    importInput.value = '';
                }
                showNotification('âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Firebase Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©', 'success');
            }
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:", error);
            const importInput = document.getElementById('importFile');
            if (importInput) {
                importInput.value = '';
            }
            showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        }
    };
    reader.readAsText(files[0]);
}

        function createBackup() {
            if (!ensureActivitySelected()) return;
            exportActivityData();
            const timestamp = new Date().toISOString();
            const lastBackupKey = getActivityDataKey('lastBackup');
            const reminderKey = getActivityDataKey('lastBackupTimestamp');
            if (lastBackupKey) {
                localStorage.setItem(lastBackupKey, timestamp);
            }
            if (reminderKey) {
                localStorage.setItem(reminderKey, Date.now());
            }
            updateDataStats();
        }

        async function importSampleData() {
            if (!ensureActivitySelected()) return;
            const confirmed = await showConfirmDialog(
                'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©',
                'Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ',
                'info',
                'Ù…ØªØ§Ø¨Ø¹Ø©',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                const sampleItems = [{ id: Date.now() + 1, code: 'IT001', name: 'Ø¬Ù‡Ø§Ø² ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ù…Ø­Ù…ÙˆÙ„', cost: 2000, price: 2500, stock: 10 }];
                const sampleCustomers = [{ id: Date.now() + 2, code: 'CU001', name: 'Ø´Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ©', phone: '0123456789', email: 'info@tech.com', address: 'Ø§Ù„Ø±ÙŠØ§Ø¶' }];
                const sampleSuppliers = [{ id: Date.now() + 3, code: 'SU001', name: 'Ø´Ø±ÙƒØ© Ø§Ù„Ø¥Ù…Ø¯Ø§Ø¯Ø§Øª', phone: '0123456791', email: 'supply@tech.com', address: 'Ø§Ù„Ø¯Ù…Ø§Ù…' }];

                const updatedItems = [...items, ...sampleItems];
                const updatedCustomers = [...customers, ...sampleCustomers];
                const updatedSuppliers = [...suppliers, ...sampleSuppliers];

                const saveResults = await Promise.all([
                    saveToLocalStorage('items', updatedItems),
                    saveToLocalStorage('customers', updatedCustomers),
                    saveToLocalStorage('suppliers', updatedSuppliers)
                ]);

                if (saveResults.some(result => !result)) {
                    showNotification('âŒ Ø®Ø·Ø£', 'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹', 'error');
                    return;
                }

                await refreshActivityData();
                showNotification('âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ', 'success');
            }
        }

        async function clearActivityData() {
            if (!ensureActivitySelected()) return;
            const confirmed1 = await showConfirmDialog(
                'Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                'ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù†Ø´Ø§Ø· Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                'danger',
                'Ù†Ø¹Ù…',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed1) {
                const confirmed2 = await showConfirmDialog(
                    'ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ',
                    'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø¬Ø¯Ø§Ù‹ØŸ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§!',
                    'danger',
                    'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
                    'Ø¥Ù„ØºØ§Ø¡'
                );
                if (confirmed2) {
                    const dataKeys = ['items', 'customers', 'suppliers', 'purchases', 'sales', 'salesReturns', 'purchaseReturns', 'expenses', 'revenues', 'salaries', 'lastBackup'];
                    const removalResults = await Promise.all(dataKeys.map(key => removeFromLocalStorage(key)));
                    if (removalResults.some(result => !result)) {
                        showNotification('âŒ Ø®Ø·Ø£', 'ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©', 'error');
                        return;
                    }
                    dataKeys.forEach(key => {
                        const storageKey = getActivityDataKey(key);
                        if (storageKey) {
                            localStorage.removeItem(storageKey);
                        }
                    });
                    const reminderKey = getActivityDataKey('lastBackupTimestamp');
                    if (reminderKey) {
                        localStorage.removeItem(reminderKey);
                    }
                    items = [];
                    customers = [];
                    suppliers = [];
                    purchases = [];
                    sales = [];
                    expenses = [];
                    revenues = [];
                    salaries = [];
                    salesReturns = [];
                    purchaseReturns = [];
                    await refreshActivityData();
                    showNotification('âœ… ØªÙ… Ø§Ù„Ù…Ø³Ø­', 'ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ', 'success');
                }
            }
        }

        // ===== Dashboard Update =====
 function updateDashboard() {
    console.log('ğŸ“Š ğŸ”„ updateDashboard - Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…...');
    console.log('ğŸ“Š currentActivityId:', currentActivityId);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù:', items?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:', customers?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†:', suppliers?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:', sales?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:', purchases?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:', expenses?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:', revenues?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‡Ø¯:', advances?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆÙ„:', assets?.length || 0);
    
    // ğŸ” ÙØ­Øµ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù†Ø´Ø· Ø­Ø§Ù„ÙŠØ§Ù‹
    const activeSection = document.querySelector('.section.active');
    console.log('ğŸ“ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù†Ø´Ø· Ø­Ø§Ù„ÙŠØ§Ù‹:', activeSection ? activeSection.id : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯');
    
    const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
    const allowEmpty = !currentActivityId && loggedInUser && loggedInUser.role === 'admin';
    
    console.log('ğŸ“Š allowEmpty:', allowEmpty, '| loggedInUser:', loggedInUser?.email);
    
    if (!currentActivityId && !allowEmpty) {
        console.log('âš ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù updateDashboard - Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ù…Ø­Ø¯Ø¯ ÙˆÙ„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙØ§Ø±Øº');
        return;
    }

    const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) {
            const oldValue = el.textContent;
            el.textContent = value;
            console.log(`âœ… ØªØ­Ø¯ÙŠØ« #${id}: "${oldValue}" â†’ "${value}"`);
            
            // ğŸ” ÙØ­Øµ Ø¨Ø¹Ø¯ 100ms Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªØºÙŠÙŠØ± Ø§Ù„Ù‚ÙŠÙ…Ø©
            setTimeout(() => {
                const currentValue = document.getElementById(id)?.textContent;
                if (currentValue !== value.toString()) {
                    console.error(`ğŸš¨ Ø§Ù„Ù‚ÙŠÙ…Ø© ØªØºÙŠØ±Øª! #${id}: "${value}" â†’ "${currentValue}"`);
                }
            }, 100);
        } else {
            console.warn(`âš ï¸ Ø§Ù„Ø¹Ù†ØµØ± #${id} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!`);
        }
    };
   document.getElementById('totalAdvancesHome').textContent = advances.length;
    setText('totalItems', items.length);
    setText('totalCustomers', customers.length);
    setText('totalSuppliers', suppliers.length);
    setText('stockValue', items.reduce((s, i) => s + ((Number(i.stock) || 0) * (Number(i.cost) || 0)), 0).toFixed(2));
    setText('totalSales', sales.reduce((s, i) => s + (Number(i.total) || 0), 0).toFixed(2));
    setText('totalPurchases', purchases.reduce((s, i) => s + (Number(i.total) || 0), 0).toFixed(2));
    setText('totalExpensesHome', expenses.reduce((s, e) => s + (Number(e.amount) || 0), 0).toFixed(2));
    setText('totalRevenuesHome', revenues.reduce((s, r) => s + (Number(r.amount) || 0), 0).toFixed(2));
    
    setText('totalStockQuantity', calculateTotalStock());
    
    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„ (ØµØ§ÙÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ)
    let totalAssetsValue = 0;
    if (typeof calculateDepreciation === 'function') {
        totalAssetsValue = assets.reduce((sum, asset) => {
            const depreciation = calculateDepreciation(asset);
            return sum + depreciation.bookValue;
        }, 0);
    } else {
        // Ø­Ø³Ø§Ø¨ Ù…Ø¨Ø³Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø¯Ø§Ù„Ø© calculateDepreciation Ù…ØªØ§Ø­Ø©
        totalAssetsValue = assets.reduce((sum, asset) => sum + (Number(asset.cost) || 0), 0);
    }
    setText('totalAssetsHome', totalAssetsValue.toFixed(2));
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ù…ØªØ§Ø­
    // Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ø¯Ø§Ø®Ù„ = Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© + ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ + Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
    const cashSales = sales.reduce((sum, sale) => sum + (Number(sale.paidAmount) || 0), 0);
    const cashRevenues = revenues.reduce((sum, rev) => sum + (Number(rev.amount) || 0), 0);
    const totalCashIn = cashSales + cashRevenues;
    
    // Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ø®Ø§Ø±Ø¬ = Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© + Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª + Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
    const cashPurchases = purchases.reduce((sum, purchase) => sum + (Number(purchase.paidAmount) || 0), 0);
    const cashExpenses = expenses.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
    const totalCashOut = cashPurchases + cashExpenses;
    
    // Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ = Ø§Ù„Ø¯Ø§Ø®Ù„ - Ø§Ù„Ø®Ø§Ø±Ø¬
    const availableCash = totalCashIn - totalCashOut;
    
    setText('availableCash', availableCash.toFixed(2));
    
    console.log('âœ… updateDashboard - Ø§ÙƒØªÙ…Ù„ ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª!');
    console.log('ğŸ“Š Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:');
    console.log('  - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù:', items.length);
    console.log('  - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:', customers.length);
    console.log('  - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†:', suppliers.length);
    console.log('  - Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:', items.reduce((s, i) => s + ((Number(i.stock) || 0) * (Number(i.cost) || 0)), 0).toFixed(2));
    console.log('  - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:', sales.reduce((s, i) => s + (Number(i.total) || 0), 0).toFixed(2));
    console.log('  - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:', purchases.reduce((s, i) => s + (Number(i.total) || 0), 0).toFixed(2));
    
    // ğŸ” ÙØ­Øµ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙŠ DOM ÙØ¹Ù„ÙŠØ§Ù‹
    setTimeout(() => {
        console.log('ğŸ” ÙØ­Øµ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙŠ DOM:');
        console.log('  ğŸ“Š #totalItems.textContent =', document.getElementById('totalItems')?.textContent);
        console.log('  ğŸ“Š #totalCustomers.textContent =', document.getElementById('totalCustomers')?.textContent);
        console.log('  ğŸ“Š #totalSuppliers.textContent =', document.getElementById('totalSuppliers')?.textContent);
        console.log('  ğŸ“Š #totalSales.textContent =', document.getElementById('totalSales')?.textContent);
        console.log('  ğŸ“Š #totalPurchases.textContent =', document.getElementById('totalPurchases')?.textContent);
        
        // ÙØ­Øµ Ø§Ù„Ù€ CSS Ø§Ù„Ù…Ø·Ø¨Ù‚
        const totalItemsEl = document.getElementById('totalItems');
        if (totalItemsEl) {
            const styles = window.getComputedStyle(totalItemsEl);
            console.log('  ğŸ¨ CSS Ù„Ù€ #totalItems:');
            console.log('    - display:', styles.display);
            console.log('    - visibility:', styles.visibility);
            console.log('    - opacity:', styles.opacity);
            console.log('    - color:', styles.color);
            console.log('    - font-size:', styles.fontSize);
        }
    }, 100);
    
    // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
    if (document.getElementById('advanced-dashboard')?.classList.contains('active')) {
        console.log('ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©...');
        if (typeof updateLiveStats === 'function') {
            updateLiveStats();
        } else {
            // ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
            updateAdvancedDashboardCards();
        }
    }
}

// ===== Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© =====
function updateAdvancedDashboardCards() {
    console.log('ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹...');
    
    const today = new Date().toISOString().split('T')[0];
    const currentMonth = new Date().toISOString().slice(0, 7);
    
    console.log('ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…:', today);
    console.log('ğŸ“… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:', currentMonth);
    
    // Ø·Ø¨Ø§Ø¹Ø© ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„ØªØ´Ø®ÙŠØµ
    console.log('ğŸ“Š ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:');
    sales.forEach((s, i) => {
        console.log(`  Ø§Ù„Ø¨ÙŠØ¹ ${i + 1}: ØªØ§Ø±ÙŠØ®="${s.date}", Ø¥Ø¬Ù…Ø§Ù„ÙŠ=${s.total}`);
    });
    
    // Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…
    const todaySales = sales.filter(s => {
        const saleDate = s.date ? s.date.split('T')[0] : ''; // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© ISO
        const isToday = saleDate === today;
        console.log(`  ğŸ” ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ¹: ØªØ§Ø±ÙŠØ®="${s.date}" -> ØªØ§Ø±ÙŠØ® Ù…Ù†Ø³Ù‚="${saleDate}", Ù‡Ù„ Ø§Ù„ÙŠÙˆÙ…ØŸ ${isToday}`);
        return isToday;
    });
    const todaySalesTotal = todaySales.reduce((sum, s) => sum + (Number(s.total) || 0), 0);
    document.getElementById('todaySales').textContent = todaySalesTotal.toFixed(2);
    
    console.log(`âœ… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…: ${todaySales.length} ÙØ§ØªÙˆØ±Ø©ØŒ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${todaySalesTotal.toFixed(2)}`);
    
    // Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…
    const todayPurchases = purchases.filter(p => {
        const purchaseDate = p.date ? p.date.split('T')[0] : '';
        return purchaseDate === today;
    });
    const todayPurchasesTotal = todayPurchases.reduce((sum, p) => sum + (Number(p.total) || 0), 0);
    document.getElementById('todayPurchases').textContent = todayPurchasesTotal.toFixed(2);
    
    // Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…
    const todayExpenses = expenses.filter(e => {
        const expenseDate = e.date ? e.date.split('T')[0] : '';
        return expenseDate === today;
    });
    const todayExpensesTotal = todayExpenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
    document.getElementById('todayExpenses').textContent = todayExpensesTotal.toFixed(2);
    
    // Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…
    const todayRevenues = revenues.filter(r => {
        const revenueDate = r.date ? r.date.split('T')[0] : '';
        return revenueDate === today;
    });
    const todayRevenuesTotal = todayRevenues.reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
    document.getElementById('todayRevenues').textContent = todayRevenuesTotal.toFixed(2);
    
    // Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
    const monthlySales = sales.filter(s => {
        const saleDate = s.date ? s.date.split('T')[0] : '';
        return saleDate.startsWith(currentMonth);
    });
    const monthlySalesTotal = monthlySales.reduce((sum, s) => sum + (Number(s.total) || 0), 0);
    document.getElementById('monthlySales').textContent = monthlySalesTotal.toFixed(2);
    
    // Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
    const monthlyPurchases = purchases.filter(p => {
        const purchaseDate = p.date ? p.date.split('T')[0] : '';
        return purchaseDate.startsWith(currentMonth);
    });
    const monthlyPurchasesTotal = monthlyPurchases.reduce((sum, p) => sum + (Number(p.total) || 0), 0);
    document.getElementById('monthlyPurchases').textContent = monthlyPurchasesTotal.toFixed(2);
    
    // Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
    const monthlyExpenses = expenses.filter(e => {
        const expenseDate = e.date ? e.date.split('T')[0] : '';
        return expenseDate.startsWith(currentMonth);
    });
    const monthlyExpensesTotal = monthlyExpenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
    const monthlyExpensesCard = document.getElementById('monthlyExpensesCard');
    if (monthlyExpensesCard) monthlyExpensesCard.textContent = monthlyExpensesTotal.toFixed(2);
    
    // Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
    const monthlyRevenues = revenues.filter(r => {
        const revenueDate = r.date ? r.date.split('T')[0] : '';
        return revenueDate.startsWith(currentMonth);
    });
    const monthlyRevenuesTotal = monthlyRevenues.reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
    document.getElementById('monthlyRevenues').textContent = monthlyRevenuesTotal.toFixed(2);
    
    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©:');
    console.log('  - Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…:', todaySalesTotal.toFixed(2), `(${todaySales.length} ÙØ§ØªÙˆØ±Ø©)`);
    console.log('  - Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…:', todayPurchasesTotal.toFixed(2), `(${todayPurchases.length} ÙØ§ØªÙˆØ±Ø©)`);
    console.log('  - Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©:', monthlySalesTotal.toFixed(2), `(${monthlySales.length} ÙØ§ØªÙˆØ±Ø©)`);
    console.log('  - Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©:', monthlyPurchasesTotal.toFixed(2), `(${monthlyPurchases.length} ÙØ§ØªÙˆØ±Ø©)`);
}

// ===== Ø¯Ø§Ù„Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Placeholder) =====
function initAdvancedDashboard() {
    // Ø¯Ø§Ù„Ø© ÙØ§Ø±ØºØ© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ - Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ØªÙØ­Ø¯Ø« Ø¨ÙˆØ§Ø³Ø·Ø© updateAdvancedDashboardCards()
    console.log('ğŸ“Š initAdvancedDashboard: ØªÙ… Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ (Ø¯Ø§Ù„Ø© ÙØ§Ø±ØºØ©)');
}

// ğŸ†• ===== Ø¯ÙˆØ§Ù„ ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© =====

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
let salesVsPurchasesChart = null;
let expensesDistributionChart = null;
let topItemsChart = null;
let cashFlowChart = null;

// ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ (KPIs)
function updateKPIs() {
    const currentMonth = new Date().toISOString().slice(0, 7);
    
    // Ø­Ø³Ø§Ø¨ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠ
    const monthlySalesData = sales.filter(s => s.date && s.date.startsWith(currentMonth));
    const monthlyPurchasesData = purchases.filter(p => p.date && p.date.startsWith(currentMonth));
    const monthlyExpensesData = expenses.filter(e => e.date && e.date.startsWith(currentMonth));
    const monthlyRevenuesData = revenues.filter(r => r.date && r.date.startsWith(currentMonth));
    
    const totalSales = monthlySalesData.reduce((sum, s) => sum + (Number(s.total) || 0), 0);
    const totalPurchases = monthlyPurchasesData.reduce((sum, p) => sum + (Number(p.total) || 0), 0);
    const totalExpenses = monthlyExpensesData.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
    const totalRevenues = monthlyRevenuesData.reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
    
    const netProfit = (totalSales + totalRevenues) - (totalPurchases + totalExpenses);
    document.getElementById('kpiNetProfit').textContent = netProfit.toFixed(2);
    
    // Ø­Ø³Ø§Ø¨ Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    const customersDebt = sales.reduce((sum, s) => sum + (Number(s.remainingAmount) || 0), 0);
    const customersWithDebt = sales.filter(s => (Number(s.remainingAmount) || 0) > 0).length;
    document.getElementById('kpiCustomersDebt').textContent = customersDebt.toFixed(2);
    document.getElementById('kpiCustomersCount').textContent = `ğŸ‘¥ ${customersWithDebt} Ø¹Ù…ÙŠÙ„`;
    
    // Ø­Ø³Ø§Ø¨ Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
    const suppliersDebt = purchases.reduce((sum, p) => sum + (Number(p.remainingAmount) || 0), 0);
    const suppliersWithDebt = purchases.filter(p => (Number(p.remainingAmount) || 0) > 0).length;
    document.getElementById('kpiSuppliersDebt').textContent = suppliersDebt.toFixed(2);
    document.getElementById('kpiSuppliersCount').textContent = `ğŸ¢ ${suppliersWithDebt} Ù…ÙˆØ±Ø¯`;
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ù…ØªØ§Ø­ (ØªÙ‚Ø¯ÙŠØ± Ø¨Ø³ÙŠØ·)
    const cashFlow = customersDebt - suppliersDebt;
    document.getElementById('kpiCashFlow').textContent = cashFlow.toFixed(2);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª
    const profitTrend = netProfit >= 0 ? 'ğŸ“ˆ Ø±Ø¨Ø­' : 'ğŸ“‰ Ø®Ø³Ø§Ø±Ø©';
    document.getElementById('kpiNetProfitTrend').textContent = profitTrend;
}

// ØªØ­Ø¯ÙŠØ« Ø±Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª vs Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
function updateSalesVsPurchasesChart() {
    const ctx = document.getElementById('salesVsPurchasesChart');
    if (!ctx) return;
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±
    const months = [];
    const salesData = [];
    const purchasesData = [];
    
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const monthStr = date.toISOString().slice(0, 7);
        
        // Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
        const monthNames = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 
                           'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
        months.push(monthNames[date.getMonth()]);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
        const monthSales = sales
            .filter(s => s.date && s.date.startsWith(monthStr))
            .reduce((sum, s) => sum + (Number(s.total) || 0), 0);
        salesData.push(monthSales);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
        const monthPurchases = purchases
            .filter(p => p.date && p.date.startsWith(monthStr))
            .reduce((sum, p) => sum + (Number(p.total) || 0), 0);
        purchasesData.push(monthPurchases);
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù…
    if (salesVsPurchasesChart) {
        salesVsPurchasesChart.destroy();
    }
    
    salesVsPurchasesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                data: salesData,
                borderColor: '#27ae60',
                backgroundColor: 'rgba(39, 174, 96, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
                data: purchasesData,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// ØªØ­Ø¯ÙŠØ« Ø±Ø³Ù… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
function updateExpensesDistributionChart() {
    const ctx = document.getElementById('expensesDistributionChart');
    if (!ctx) return;
    
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
    const categories = {};
    expenses.forEach(e => {
        const category = e.category || 'Ø£Ø®Ø±Ù‰';
        categories[category] = (categories[category] || 0) + (Number(e.amount) || 0);
    });
    
    const labels = Object.keys(categories);
    const data = Object.values(categories);
    
    // Ø£Ù„ÙˆØ§Ù† Ù…ØªÙ†ÙˆØ¹Ø©
    const colors = [
        '#667eea', '#764ba2', '#f093fb', '#f5576c', 
        '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
        '#fa709a', '#fee140'
    ];
    
    // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù…
    if (expensesDistributionChart) {
        expensesDistributionChart.destroy();
    }
    
    expensesDistributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'right'
                }
            }
        }
    });
}

// ØªØ­Ø¯ÙŠØ« Ø±Ø³Ù… Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ø¨ÙŠØ¹Ø§Ù‹
function updateTopItemsChart() {
    const ctx = document.getElementById('topItemsChart');
    if (!ctx) return;
    
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØµÙ†Ù
    const itemSales = {};
    sales.forEach(sale => {
        if (sale.items && Array.isArray(sale.items)) {
            sale.items.forEach(item => {
                const itemName = item.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const itemTotal = (Number(item.price) || 0) * (Number(item.quantity) || 0);
                itemSales[itemName] = (itemSales[itemName] || 0) + itemTotal;
            });
        }
    });
    
    // ØªØ±ØªÙŠØ¨ ÙˆØ£Ø®Ø° Ø£Ø¹Ù„Ù‰ 5
    const sorted = Object.entries(itemSales)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    
    const labels = sorted.map(([name]) => name);
    const data = sorted.map(([, value]) => value);
    
    // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù…
    if (topItemsChart) {
        topItemsChart.destroy();
    }
    
    topItemsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                data: data,
                backgroundColor: [
                    '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'
                ],
                borderRadius: 5
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true
                }
            }
        }
    });
}

// ØªØ­Ø¯ÙŠØ« Ø±Ø³Ù… Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ
function updateCashFlowChart() {
    const ctx = document.getElementById('cashFlowChart');
    if (!ctx) return;
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
    const days = [];
    const cashInData = [];
    const cashOutData = [];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        // Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ…
        const dayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
        days.push(dayNames[date.getDay()]);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„Ø© (Ù…Ø¨ÙŠØ¹Ø§Øª + Ø¥ÙŠØ±Ø§Ø¯Ø§Øª)
        const daySales = sales
            .filter(s => s.date && s.date.split('T')[0] === dateStr)
            .reduce((sum, s) => sum + (Number(s.paidAmount) || 0), 0);
        const dayRevenues = revenues
            .filter(r => r.date && r.date.split('T')[0] === dateStr)
            .reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
        cashInData.push(daySales + dayRevenues);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬Ø© (Ù…Ø´ØªØ±ÙŠØ§Øª + Ù…ØµØ±ÙˆÙØ§Øª)
        const dayPurchases = purchases
            .filter(p => p.date && p.date.split('T')[0] === dateStr)
            .reduce((sum, p) => sum + (Number(p.paidAmount) || 0), 0);
        const dayExpenses = expenses
            .filter(e => e.date && e.date.split('T')[0] === dateStr)
            .reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
        cashOutData.push(dayPurchases + dayExpenses);
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù…
    if (cashFlowChart) {
        cashFlowChart.destroy();
    }
    
    cashFlowChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: days,
            datasets: [{
                label: 'ØªØ¯ÙÙ‚Ø§Øª Ø¯Ø§Ø®Ù„Ø©',
                data: cashInData,
                backgroundColor: '#43e97b',
                borderRadius: 5
            }, {
                label: 'ØªØ¯ÙÙ‚Ø§Øª Ø®Ø§Ø±Ø¬Ø©',
                data: cashOutData,
                backgroundColor: '#f5576c',
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Ø¯Ø§Ù„Ø© Ø´Ø§Ù…Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
function updateAllCharts() {
    console.log('ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©...');
    updateKPIs();
    updateSalesVsPurchasesChart();
    updateExpensesDistributionChart();
    updateTopItemsChart();
    updateCashFlowChart();
    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©');
}
        
        // ========================================
        // ğŸ”¥ Firebase Authentication Functions
        // ========================================
        
        /**
         * ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙÙŠ Firebase Authentication
         */
        async function firebaseCreateUser(email, password, userData) {
            if (!USE_FIREBASE) {
                debugLog('âš ï¸ Firebase Ù…Ø¹Ø·Ù„ - Ø§Ø³ØªØ®Ø¯Ø§Ù… LocalStorage ÙÙ‚Ø·');
                return null;
            }

            try {
                const { createUserWithEmailAndPassword } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                debugLog('ğŸ”¥ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙÙŠ Firebase:', email);
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const firebaseUser = userCredential.user;
                
                debugLog('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase:', firebaseUser.uid);
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ Realtime Database
                await firebaseSaveUserData(firebaseUser.uid, userData);
                
                return firebaseUser;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Firebase:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showNotification('âš ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù…', 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
                } else if (error.code === 'auth/weak-password') {
                    showNotification('âš ï¸ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warning');
                }
                return null;
            }
        }

        /**
         * Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Realtime Database
         */
        async function firebaseSaveUserData(uid, userData) {
            if (!USE_FIREBASE) return;

            try {
                const { ref, set } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                const userRef = ref(db, `users/${uid}`);
                await set(userRef, {
                    ...userData,
                    uid: uid,
                    createdAt: userData.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                
                debugLog('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Database');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
            }
        }

        /**
         * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase
         */
        async function firebaseSignIn(email, password) {
            if (!USE_FIREBASE) {
                debugLog('âš ï¸ Firebase Ù…Ø¹Ø·Ù„ - Ø§Ø³ØªØ®Ø¯Ø§Ù… LocalStorage ÙÙ‚Ø·');
                return null;
            }

            try {
                const { signInWithEmailAndPassword } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                debugLog('ğŸ”¥ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Firebase:', email);
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const firebaseUser = userCredential.user;
                
                debugLog('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­:', firebaseUser.uid);
                
                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Database
                let userData = await firebaseGetUserData(firebaseUser.uid);
                
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                if (!userData) {
                    console.log('ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...');
                    userData = await createUserDataFromFirebaseAuth(firebaseUser, 'user', null);
                }
                
                return { firebaseUser, userData };
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Firebase:', error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    return { error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©' };
                } else if (error.code === 'auth/too-many-requests') {
                    return { error: 'ØªÙ… Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹' };
                }
                return { error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' };
            }
        }

        /**
         * Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firebase Database
         */
        async function firebaseGetUserData(uid) {
            if (!USE_FIREBASE) return null;

            try {
                const { ref, get } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                // Ø£ÙˆÙ„Ø§Ù‹: Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… UID
                let userRef = ref(db, `users/${uid}`);
                let snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù€ UID ÙÙŠ Database');
                    return snapshot.val();
                }
                
                // Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ØŒ Ø§Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù† Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù€ UID
                const usersRef = ref(db, 'users');
                const usersSnapshot = await get(usersRef);
                
                if (usersSnapshot.exists()) {
                    const allUsers = usersSnapshot.val();
                    
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ù€ UID
                    for (const [key, userData] of Object.entries(allUsers)) {
                        if (userData && (userData.firebaseUid === uid || userData.id === uid)) {
                            console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù€ key: ${key}`);
                            return userData;
                        }
                    }
                }
                
                console.log('ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Database - Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹');
                return null;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                return null;
            }
        }

        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Database ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Auth
         */
        async function createUserDataFromFirebaseAuth(firebaseUser, role = 'user', activityId = null) {
            if (!USE_FIREBASE || !window.firebaseDatabase) return null;

            try {
                const { ref, set } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                console.log('ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...');
                
                const userData = {
                    id: firebaseUser.uid,
                    name: firebaseUser.displayName || firebaseUser.email.split('@')[0], // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯
                    email: firebaseUser.email,
                    phone: firebaseUser.phoneNumber || '',
                    role: role,
                    activityId: activityId,
                    firebaseUid: firebaseUser.uid,
                    createdAt: new Date().toISOString(),
                    createdBy: 'system-auto'
                };
                
                const userRef = ref(db, `users/${firebaseUser.uid}`);
                await set(userRef, userData);
                
                console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:', userData);
                return userData;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©:', error);
                return null;
            }
        }

        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Firebase Authentication + Database
         */
        async function createFirstSystemAdmin(email, password, name, phone = '') {
            if (!USE_FIREBASE) return null;

            try {
                const { createUserWithEmailAndPassword } = window.firebaseModules;
                const { ref, set } = window.firebaseModules;
                const auth = window.firebaseAuth;
                const db = window.firebaseDatabase;
                
                console.log('ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„...');
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const firebaseUser = userCredential.user;
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙŠ Database
                const adminData = {
                    id: firebaseUser.uid,
                    name: name,
                    email: email,
                    password: password, // Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                    phone: phone,
                    role: 'admin',
                    activityId: null, // Ø§Ù„Ù…Ø¯ÙŠØ± Ù„ÙŠØ³ Ù…Ø±ØªØ¨Ø· Ø¨Ù†Ø´Ø§Ø· Ù…Ø­Ø¯Ø¯
                    firebaseUid: firebaseUser.uid,
                    createdAt: new Date().toISOString(),
                    createdBy: 'system'
                };
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase Database
                const userRef = ref(db, `users/${firebaseUser.uid}`);
                await set(userRef, adminData);
                
                console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                
                return { firebaseUser, userData: adminData };
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…:', error);
                if (error.code === 'auth/email-already-in-use') {
                    return { error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„' };
                } else if (error.code === 'auth/weak-password') {
                    return { error: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹' };
                } else if (error.code === 'auth/invalid-email') {
                    return { error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­' };
                }
                return { error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨' };
            }
        }

        /**
         * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆÙ„
         */
        async function checkForFirstSetup() {
            console.log('ğŸ” checkForFirstSetup: Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ');
            
            if (!USE_FIREBASE) {
                console.log('âš ï¸ Firebase Ù…Ø¹Ø·Ù„');
                return false;
            }

            try {
                const { ref, get } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                console.log('ğŸ“Š ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...');
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                
                if (!snapshot.exists()) {
                    console.log('ğŸš€ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† - Ø¥Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„');
                    return true; // ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„ÙŠ
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¯ÙŠØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
                const usersData = snapshot.val();
                console.log('ğŸ‘¥ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', Object.keys(usersData).length, 'Ù…Ø³ØªØ®Ø¯Ù…');
                
                const admins = Object.values(usersData).filter(user => user && user.role === 'admin');
                console.log('ğŸ‘‘ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†:', admins.length);
                
                if (admins.length === 0) {
                    console.log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù… - Ø¥Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ±');
                    return true;
                }
                
                console.log('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„ - ÙŠÙˆØ¬Ø¯', admins.length, 'Ù…Ø¯ÙŠØ±');
                return false; // Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ:', error);
                return false;
            }
        }

        /**
         * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase
         */
        async function firebaseSignOut() {
            if (!USE_FIREBASE) return;

            try {
                const { signOut } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                await signOut(auth);
                debugLog('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:', error);
            }
        }

        /**
         * Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Firebase
         */
        async function firebaseGetActivityData(activityId, dataType) {
            if (!USE_FIREBASE) return null;

            try {
                console.log(`ğŸ” Firebase: Ø¬Ù„Ø¨ ${dataType} Ù„Ù„Ù†Ø´Ø§Ø· ${activityId}`);
                
                const { ref, get } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                const dataRef = ref(db, `activities/${activityId}/${dataType}`);
                console.log(`ğŸ“ Firebase Path: activities/${activityId}/${dataType}`);
                
                const snapshot = await get(dataRef);
                
                console.log(`ğŸ” snapshot.exists() = ${snapshot.exists()}`);
                if (snapshot.exists()) {
                    const dataObject = snapshot.val();
                    console.log(`ğŸ” Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù… Ù…Ù† Firebase Ù„Ù€ ${dataType}:`, dataObject);
                    console.log(`ğŸ” Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${typeof dataObject}`);
                    console.log(`ğŸ” Ù‡Ù„ Ù‡Ùˆ Ù…ØµÙÙˆÙØ©ØŸ ${Array.isArray(dataObject)}`);
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
                    let dataArray;
                    if (Array.isArray(dataObject)) {
                        dataArray = dataObject;
                    } else if (typeof dataObject === 'object' && dataObject !== null) {
                        dataArray = Object.values(dataObject);
                    } else {
                        dataArray = [];
                    }
                    
                    console.log(`ğŸ” Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù€ ${dataType}:`, dataArray);
                    console.log(`âœ… Firebase: ÙˆÙØ¬Ø¯ ${dataArray.length} Ø¹Ù†ØµØ± Ù…Ù† ${dataType}`);
                    return dataArray;
                } else {
                    console.warn(`âš ï¸ Firebase: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ${dataType} Ù„Ù„Ù†Ø´Ø§Ø· ${activityId}`);
                    debugLog(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ${dataType} ÙÙŠ Firebase`);
                    return [];
                }
            } catch (error) {
                console.error(`âŒ Firebase Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ${dataType} Ù„Ù„Ù†Ø´Ø§Ø· ${activityId}:`, error);
                return null;
            }
        }

        /**
         * Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase
         */
        async function firebaseSaveActivityData(activityId, dataType, data) {
            if (!USE_FIREBASE) return false;

            try {
                const { ref, set } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù†
                const dataObject = {};
                data.forEach(item => {
                    const itemId = item.id || item.number || Date.now() + Math.random();
                    dataObject[itemId] = item;
                });
                
                const dataRef = ref(db, `activities/${activityId}/${dataType}`);
                await set(dataRef, dataObject);
                
                debugLog(`âœ… ØªÙ… Ø­ÙØ¸ ${dataType} ÙÙŠ Firebase`);
                return true;
            } catch (error) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ${dataType}:`, error);
                return false;
            }
        }

        // ===== Login System Functions =====
     let loginInProgress = false;
     async function handleLogin() {
    if (loginInProgress) {
        return;
    }
    loginInProgress = true;
    const errorMsg = document.getElementById('login-error');
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPassword').value;

    if (!email || !pass) {
        showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'warning');
        loginInProgress = false;
        return;
    }

    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
    errorMsg.style.display = 'none';

    try {
        let user = null;
        
        // ========================================
        // ğŸ”¥ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 1: Firebase Authentication
        // ========================================
        if (USE_FIREBASE) {
            debugLog('ğŸ”¥ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Firebase...');
            const firebaseResult = await firebaseSignIn(email, pass);
            
            if (firebaseResult && !firebaseResult.error && firebaseResult.userData) {
                debugLog('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ø¨Ø± Firebase');
                user = firebaseResult.userData;
            user.firebaseUid = firebaseResult.firebaseUser.uid;
            window.currentUser = user; // <--- ğŸ”¥ Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ù†Ø§

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Firebase ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Firebase ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                try {
                    const { ref, get } = window.firebaseModules;
                    const db = window.firebaseDatabase;
                    
                    const usersRef = ref(db, 'users');
                    const usersSnapshot = await get(usersRef);
                    
                    if (usersSnapshot.exists()) {
                        const usersData = usersSnapshot.val();
                        const rawUsers = Object.values(usersData)
                            .filter(u => u && u.id && u.email);
                        
                        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                        const uniqueUsersMap = new Map();
                        rawUsers.forEach(u => {
                            const existing = uniqueUsersMap.get(u.email);
                            if (!existing || (u.createdAt && u.createdAt > existing.createdAt)) {
                                uniqueUsersMap.set(u.email, {
                                    id: u.id,
                                    name: u.name,
                                    email: u.email,
                                    phone: u.phone || '', // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ø¬ÙˆØ§Ù„
                                    password: u.password,
                                    role: u.role,
                                    activityId: u.activityId,
                                    firebaseUid: u.firebaseUid,
                                    createdAt: u.createdAt
                                });
                            }
                        });
                        
                        // Ø¯Ù…Ø¬ Ø°ÙƒÙŠ: Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…ÙØ­Ø¯Ø«Ø©
                        const localUsers = loadFromLocalStorage('diwan_users') || [];
                        console.log('ğŸ”„ Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...');
                        console.log('ğŸ“Š Firebase users:', Array.from(uniqueUsersMap.values()).length);
                        console.log('ğŸ“Š Local users:', localUsers.length);
                        
                        // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Firebase ÙƒØ£Ø³Ø§Ø³ + Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…ÙØ­Ø¯Ø«Ø©
                        const mergedUsersMap = new Map();
                        
                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ø£ÙˆÙ„Ø§Ù‹
                        Array.from(uniqueUsersMap.values()).forEach(user => {
                            mergedUsersMap.set(user.email, user);
                        });
                        
                        // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªÙƒÙˆÙ† Ø£Ø­Ø¯Ø«)
                        localUsers.forEach(localUser => {
                            const firebaseUser = mergedUsersMap.get(localUser.email);
                            if (firebaseUser) {
                                // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø£Ø­Ø¯Ø«
                                const mergedUser = {
                                    ...firebaseUser,
                                    // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©
                                    name: localUser.name || firebaseUser.name,
                                    phone: localUser.phone || firebaseUser.phone,
                                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ù„ÙŠ Ø£Ø­Ø¯Ø«ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                                    ...(localUser.updatedAt && localUser.updatedAt > firebaseUser.updatedAt ? {
                                        name: localUser.name,
                                        phone: localUser.phone,
                                        updatedAt: localUser.updatedAt
                                    } : {})
                                };
                                mergedUsersMap.set(localUser.email, mergedUser);
                                
                                if (localUser.phone && !firebaseUser.phone) {
                                    console.log(`ğŸ”„ Ø¯Ù…Ø¬: Ø§Ø­ØªÙØ¸ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù€ ${localUser.email}: ${localUser.phone}`);
                                }
                            } else {
                                // Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·
                                mergedUsersMap.set(localUser.email, localUser);
                            }
                        });
                        
                        users = Array.from(mergedUsersMap.values());
                        localStorage.setItem('diwan_users', JSON.stringify(users));
                        debugLog(`âœ… ØªÙ… Ø¯Ù…Ø¬ ${users.length} Ù…Ø³ØªØ®Ø¯Ù… (Firebase + Local)`);
                        
                        // ØªØ´Ø®ÙŠØµ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…ÙˆØ¬Ø©
                        const usersWithPhone = users.filter(u => u.phone);
                        console.log(`ğŸ“± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø£Ø±Ù‚Ø§Ù… Ø¬ÙˆØ§Ù„: ${usersWithPhone.length}`);
                        usersWithPhone.forEach(u => {
                            console.log(`  ğŸ“± ${u.email}: ${u.phone}`);
                        });
                    }
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', error);
                }
            } else if (firebaseResult && firebaseResult.error) {
                hideLoading();
                errorMsg.textContent = firebaseResult.error;
                errorMsg.style.display = 'block';
                return;
            }
        }
        
        // ========================================
        // ğŸ“¦ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 2: LocalStorage (Fallback)
        // ========================================
        if (!user) {
            debugLog('ğŸ“¦ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± LocalStorage...');
            const savedUsers = loadFromLocalStorage('diwan_users') || [];
            users = savedUsers;
          user = users.find(u => u.email === email && u.password === pass);
        window.currentUser = user; // <--- ğŸ”¥ ÙˆØ£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ù†Ø§

        if (!user) {
                hideLoading();
                errorMsg.textContent = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                errorMsg.style.display = 'block';
                return;
            }
            
            debugLog('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ø¨Ø± LocalStorage');
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ù† Firebase Ø£Ùˆ LocalStorage
        if (USE_FIREBASE) {
            try {
                const firebaseActivities = await firebaseLoadActivitiesDirectly();
                if (firebaseActivities && firebaseActivities.length > 0) {
                    activities = firebaseActivities;
                    // Ø­ÙØ¸ ÙÙŠ LocalStorage
                    localStorage.setItem('diwan_activities', JSON.stringify(activities));
                    debugLog(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${activities.length} Ù†Ø´Ø§Ø· Ù…Ù† Firebase`);
                } else {
                    activities = loadFromLocalStorage('diwan_activities') || [];
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©:', error);
                activities = loadFromLocalStorage('diwan_activities') || [];
            }
        } else {
            activities = loadFromLocalStorage('diwan_activities') || [];
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        if (user.role === 'user' && (!user.activityId || !activities.find(a => a.id == user.activityId))) {
            hideLoading();
            showNotification('âš ï¸ Ù†Ø´Ø§Ø· ØºÙŠØ± ØµØ§Ù„Ø­', 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±.', 'warning');
            errorMsg.textContent = 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± ØµØ§Ù„Ø­.';
            errorMsg.style.display = 'block';
            
            // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹
            if (USE_FIREBASE && user.firebaseUid) {
                await firebaseSignOut();
            }
            return;
        }

        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Session
        sessionStorage.setItem('loggedInUser', JSON.stringify(user));
        sessionStorage.setItem('isLoggedIn', 'true');
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage Ø¥Ø°Ø§ ØªÙ… ØªÙØ¹ÙŠÙ„ "ØªØ°ÙƒØ±Ù†ÙŠ" (Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ØªØµÙØ­)
        const rememberMe = document.getElementById('rememberMe').checked;
        if (rememberMe) {
            localStorage.setItem('rememberedUser', JSON.stringify({
                email: email,
                password: pass, // Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø· ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ØªØµÙØ­
                timestamp: new Date().getTime()
            }));
        } else {
            localStorage.removeItem('rememberedUser');
        }
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©
        localStorage.removeItem('loggedInUser');
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('justLoggedOut');

        updateLoggedInUserDisplay(user);
        document.getElementById('login-overlay').style.display = 'none';
        document.querySelector('.app-container').style.display = 'flex';
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        const footer = document.getElementById('appFooter');
        if (footer) {
            footer.style.display = 'block';
            setTimeout(() => { footer.style.opacity = '1'; }, 100);
        }

        if (user.role === 'admin') {
            currentActivityId = sessionStorage.getItem('currentActivityId');
            if (currentActivityId && activities.find(a => a.id == currentActivityId)) {
                selectActivity(currentActivityId);
            } else {
                enterAdminWithoutActivity();
            }
        } else {
            selectActivity(user.activityId);
        }

        hideLoading();
        
        // Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        showNotification('âœ… Ù…Ø±Ø­Ø¨Ø§Ù‹', `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ${user.name || user.email}`, 'success');

    } catch (error) {
        hideLoading();
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
        errorMsg.textContent = 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        errorMsg.style.display = 'block';
    } finally {
        loginInProgress = false;
    }
}

        // ===== First Setup System Functions =====
        
        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„
         */
        async function createFirstAdmin() {
            const errorMsg = document.getElementById('setup-error');
            const name = document.getElementById('adminName').value.trim();
            const email = document.getElementById('adminEmail').value.trim();
            const phone = document.getElementById('adminPhone').value.trim();
            const password = document.getElementById('adminPassword').value;
            const confirmPassword = document.getElementById('adminPasswordConfirm').value;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (!name || !email || !password) {
                errorMsg.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©';
                errorMsg.style.display = 'block';
                return;
            }

            if (password.length < 6) {
                errorMsg.textContent = 'âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
                errorMsg.style.display = 'block';
                return;
            }

            if (password !== confirmPassword) {
                errorMsg.textContent = 'âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†';
                errorMsg.style.display = 'block';
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorMsg.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­';
                errorMsg.style.display = 'block';
                return;
            }

            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…...');
            errorMsg.style.display = 'none';

            try {
                const result = await createFirstSystemAdmin(email, password, name, phone);
                
                if (result && !result.error) {
                    hideLoading();
                    document.getElementById('first-setup-overlay').style.display = 'none';
                    
                    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Session Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                    sessionStorage.setItem('loggedInUser', JSON.stringify(result.userData));
                    sessionStorage.setItem('isLoggedIn', 'true');
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                    document.getElementById('login-overlay').style.display = 'none';
                    document.querySelector('.app-container').style.display = 'flex';
                    
                    updateLoggedInUserDisplay(result.userData);
                    enterAdminWithoutActivity();
                    
                    showNotification('ğŸ‰ ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!', `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name}, ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ ÙƒÙ…Ø¯ÙŠØ± Ù„Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                    
                } else {
                    hideLoading();
                    errorMsg.textContent = result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨';
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                hideLoading();
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…:', error);
                errorMsg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                errorMsg.style.display = 'block';
            }
        }

        /**
         * ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
         */
      async function checkFirstSetup() {
            console.log('ğŸ” checkFirstSetup: Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ');
            
            if (!USE_FIREBASE) {
                console.log('âš ï¸ Firebase Ù…Ø¹Ø·Ù„ - ØªÙ… ØªØ¬Ø§Ù‡Ù„ ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ');
                return;
            }

            console.log('ğŸ”¥ Firebase Ù…ÙØ¹Ù„ - ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

            try {
                const needsSetup = await checkForFirstSetup();
                console.log('ğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ - ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„ÙŠ:', needsSetup);
                
                if (needsSetup) {
                    console.log('ğŸš€ Ø¥Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„');
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('first-setup-overlay').style.display = 'flex';
                } else {
                    console.log('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„');
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© "ØªØ°ÙƒØ±Ù†ÙŠ" Ù‚Ø¨Ù„ Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    const rememberedUser = localStorage.getItem('rememberedUser');
                    const manualLogout = sessionStorage.getItem('manualLogout');
                    
                    if (!manualLogout && rememberedUser) {
                        try {
                            const userData = JSON.parse(rememberedUser);
                            const now = new Date().getTime();
                            const dayInMs = 30 * 24 * 60 * 60 * 1000; // 30 ÙŠÙˆÙ…
                            
                            if (userData.timestamp && (now - userData.timestamp) < dayInMs) {
                                console.log('ğŸ”„ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ" ØµØ§Ù„Ø­Ø© - Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
                                return; // Ù„Ø§ ØªØ¸Ù‡Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                            }
                        } catch (e) {
                            console.warn('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ°ÙƒØ±Ù†ÙŠ:', e);
                        }
                    }
                    
                    console.log('ğŸ“ Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©');
                    document.getElementById('login-overlay').style.display = 'flex';
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ:', error);
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø£Ø¸Ù‡Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
                document.getElementById('login-overlay').style.display = 'flex';
            }
        }

        function enterAdminWithoutActivity() {
            currentActivityId = null;
            sessionStorage.removeItem('currentActivityId');

            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) loginOverlay.style.display = 'none';
            const activityOverlay = document.getElementById('activity-overlay');
            if (activityOverlay) activityOverlay.style.display = 'none';
            const appContainer = document.querySelector('.app-container');
            if (appContainer) appContainer.style.display = 'flex';

            items = [];
            customers = [];
            suppliers = [];
            purchases = [];
            sales = [];
            expenses = [];
            revenues = [];
            salaries = [];
            salesReturns = [];
            purchaseReturns = [];
            currentPurchaseItems = [];
            currentSaleItems = [];
            currentPurchaseNumber = 1;
            currentSaleNumber = 1;
            currentSaleReturnNumber = 1;
            currentPurchaseReturnNumber = 1;
            editingPurchaseId = null;
            editingSaleId = null;

            const todayISO = new Date().toISOString().split('T')[0];
            const setValueIfExists = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.value = value;
            };
            ['purchaseDate', 'saleDate', 'expenseDate', 'revenueDate', 'reportFrom', 'reportTo'].forEach(id => setValueIfExists(id, todayISO));

            setValueIfExists('purchaseCode', `PUR${currentPurchaseNumber.toString().padStart(3, '0')}`);
            setValueIfExists('saleCode', `SAL${currentSaleNumber.toString().padStart(3, '0')}`);

            updateHeaderForActivity(null);
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            updateLoggedInUserDisplay(loggedInUser);
            updateSidebar(loggedInUser ? loggedInUser.role : null);

            newPurchase();
            newSale();
            newSaleReturn();
            newPurchaseReturn();

            renderItems();
            renderCustomers();
            renderSuppliers();
            renderPurchasesList();
            renderSalesList();
            renderSalesReturns();
            renderPurchaseReturns();
            renderExpenses();
            renderRevenues();
            updatePurchaseDropdowns();
            updateSaleDropdowns();
            updateExpenseStats();
            updateRevenueStats();
            updateDataStats();
            updateDashboard();
            updateReportItemFilter();
            // Ù„Ø§ Ù†Ø³ØªØ¯Ø¹ÙŠ changeReportType() Ù„ØªØ±Ùƒ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙØ§Ø±Øº
            const reportResults = document.getElementById('reportResults');
            if (reportResults) reportResults.innerHTML = '';
            const reportSummary = document.getElementById('reportSummary');
            if (reportSummary) reportSummary.innerHTML = '';
            renderActivitiesInSettings();
            renderUsersInSettings();
        }
        
      async function logout() {
            const confirmed = await showConfirmDialog({
                title: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ',
                icon: 'ğŸšª',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡',
                confirmButtonClass: 'danger'
            });
            
            if (confirmed) {
                // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
                sessionStorage.clear();
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('isLoggedIn');
                
                // Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ" Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙŠØ¯ÙˆÙŠ
                localStorage.removeItem('rememberedUser');
                console.log('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ" Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
                
                // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø¬Ù„ Ø®Ø±ÙˆØ¬ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                sessionStorage.setItem('manualLogout', 'true');
                
                location.reload();
            }
        }

        function renderUsersInSettings() {
            // ØªÙ… Ø¥Ø²Ø§Ù„Ø© loadUsers() Ù„Ø£Ù†Ù‡ ÙŠØ³Ø¨Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø­Ù…Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù…ØªØºÙŠØ± users Ø§Ù„Ø¹Ø§Ù…
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const isAdmin = loggedInUser && loggedInUser.role === 'admin';
            const isManager = loggedInUser && loggedInUser.role === 'manager';
            const activitySelect = document.getElementById('newUserActivity');
            const userSelect = document.getElementById('usersDropdown');
            const roleSelect = document.getElementById('newUserRole');

            // ØªØ´Ø®ÙŠØµ Ù„Ù„Ù…Ø¯ÙŠØ±
            if (isManager) {
                console.log('ğŸ” ØªØµÙÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·:');
                console.log('Ù…Ø¹Ø±Ù Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø¯ÙŠØ±:', loggedInUser.activityId, 'Ù†ÙˆØ¹Ù‡:', typeof loggedInUser.activityId);
                console.log('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', users.length);
                users.forEach(u => {
                    console.log(`  - ${u.email}: Ù†Ø´Ø§Ø·=${u.activityId} (${typeof u.activityId}), Ø¯ÙˆØ±=${u.role}`);
                });
            }

            if (roleSelect) {
                if (isManager) {
                    roleSelect.value = 'user';
                    roleSelect.disabled = true;
                } else {
                    roleSelect.disabled = false;
                }
            }

            if (activitySelect) {
                activitySelect.innerHTML = '<option value="">-- ØªØ¹ÙŠÙŠÙ† Ù„Ù†Ø´Ø§Ø· --</option>';
                const availableActivities = isManager
                    ? activities.filter(act => String(act.id) === String(loggedInUser.activityId))
                    : activities;
                availableActivities.forEach(act => {
                    activitySelect.innerHTML += `<option value="${act.id}">${act.name}</option>`;
                });
                if (isManager) {
                    activitySelect.value = loggedInUser.activityId || '';
                    activitySelect.disabled = true;
                } else {
                    activitySelect.disabled = false;
                }
            }

            if (userSelect) {
                const previousSelection = userSelect.value;
                userSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§</option>';
                
                // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                const filteredUsers = users.filter(user => {
                    if (isAdmin) return true;
                    if (isManager) {
                        // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡
                        if (user.role === 'admin') return false;
                        // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± Ø¨Ø±Ø¤ÙŠØ© Ù†ÙØ³Ù‡
                        if (user.role === 'manager' && String(user.id) !== String(loggedInUser.id)) return false;
                        
                        // Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù†Øµ
                        const userActivityId = String(user.activityId || '');
                        const managerActivityId = String(loggedInUser.activityId || '');
                        const matches = userActivityId === managerActivityId;
                        
                        console.log(`  ØªØ­Ù‚Ù‚ Ù…Ù† ${user.email}: activityId="${userActivityId}" Ù…Ù‚Ø§Ø¨Ù„ "${managerActivityId}" => ${matches}`);
                        return matches;
                    }
                    return false;
                });

                console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙÙŠØ©:', filteredUsers.length);

                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·ØŒ Ø«Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                const sortedUsers = filteredUsers.sort((a, b) => {
                    const roleOrder = { admin: 1, manager: 2, user: 3 };
                    const orderA = roleOrder[a.role] || 4;
                    const orderB = roleOrder[b.role] || 4;
                    
                    if (orderA !== orderB) {
                        return orderA - orderB;
                    }
                    
                    // Ù†ÙØ³ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…
                    const nameA = (a.name && a.name.trim()) ? a.name : a.email;
                    const nameB = (b.name && b.name.trim()) ? b.name : b.email;
                    return nameA.localeCompare(nameB, 'ar');
                });

                sortedUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    const roleLabelMap = { admin: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', manager: 'Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·', user: 'Ù…Ø³ØªØ®Ø¯Ù…' };
                    const baseName = (user.name && user.name.trim()) ? user.name : user.email;
                    option.textContent = `${baseName} - ${roleLabelMap[user.role] || 'Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`;
                    userSelect.appendChild(option);
                });

                if (previousSelection && users.some(u => String(u.id) === previousSelection)) {
                    userSelect.value = previousSelection;
                } else {
                    userSelect.value = '';
                }
            }

            handleUserSelection();
        }

        function handleUserSelection() {
            const userSelect = document.getElementById('usersDropdown');
            const infoBox = document.getElementById('selectedUserInfo');
            const nameInput = document.getElementById('selectedUserName');
            const emailInput = document.getElementById('selectedUserEmail');
            const phoneInput = document.getElementById('selectedUserPhone');
            const roleInput = document.getElementById('selectedUserRole');
            const activityInput = document.getElementById('selectedUserActivity');
            const editBtn = document.getElementById('editSelectedUserBtn');
            const deleteBtn = document.getElementById('deleteSelectedUserBtn');

            if (!userSelect) return;

            const userId = userSelect.value;
            const user = users.find(u => String(u.id) === userId);

            if (!user) {
                if (infoBox) infoBox.style.display = 'none';
                if (nameInput) nameInput.value = '';
                if (emailInput) emailInput.value = '';
                if (phoneInput) phoneInput.value = '';
                if (roleInput) roleInput.value = '';
                if (activityInput) activityInput.value = '';
                if (editBtn) editBtn.disabled = true;
                if (deleteBtn) deleteBtn.disabled = true;
                return;
            }

            if (infoBox) infoBox.style.display = 'flex';
            if (nameInput) nameInput.value = (user.name && user.name.trim()) ? user.name : user.email;
            if (emailInput) emailInput.value = user.email || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            if (phoneInput) phoneInput.value = (user.phone && user.phone.trim()) ? user.phone : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            if (roleInput) {
                const roleNames = { admin: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', manager: 'Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·', user: 'Ù…Ø³ØªØ®Ø¯Ù…' };
                roleInput.value = roleNames[user.role] || 'Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            }

            let assignedActivity = 'ØºÙŠØ± Ù…Ø®ØµØµ';
            if (user.role === 'admin') {
                assignedActivity = 'Ù…ØªØ¹Ø¯Ø¯ (Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…)';
            } else if (user.role === 'manager' || user.role === 'user') {
                const activity = activities.find(a => a.id == user.activityId);
                assignedActivity = activity ? activity.name : 'Ù†Ø´Ø§Ø· ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            }
            if (activityInput) activityInput.value = assignedActivity;

            if (editBtn) editBtn.disabled = false;
            if (deleteBtn) deleteBtn.disabled = false;
        }

        function handleEditSelectedUser() {
            const userSelect = document.getElementById('usersDropdown');
            if (!userSelect || !userSelect.value) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'warning');
                return;
            }
            const userId = userSelect.value;
            openEditUserModal(userId);
        }

        function handleDeleteSelectedUser() {
            const userSelect = document.getElementById('usersDropdown');
            if (!userSelect || !userSelect.value) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'warning');
                return;
            }
            const userId = userSelect.value;
            deleteUser(userId);
        }

        let editingUserId = null;
        let editingUserSelf = false;
        function openEditUserModal(userId, options = {}) {
            editingUserSelf = Boolean(options && options.selfEdit);
            const user = users.find(u => String(u.id) === String(userId));
            if (!user) return;

            editingUserId = user.id;

            // ØªØ´Ø®ÙŠØµ: Ø·Ø¨Ø§Ø¹Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
            console.log('ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ¹Ø¯ÙŠÙ„:', user);
            console.log('ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:', user.phone);

            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const isManager = loggedInUser && loggedInUser.role === 'manager';
            const isSelf = loggedInUser && String(user.id) === String(loggedInUser.id);

            if (isManager) {
                // Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ÙŠØ³ØªØ·ÙŠØ¹ ØªØ¹Ø¯ÙŠÙ„:
                // 1. Ù†ÙØ³Ù‡ (Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙ‡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·)
                // 2. Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ† ÙÙŠ Ù†Ø´Ø§Ø·Ù‡ ÙÙ‚Ø·
                // Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ ØªØ¹Ø¯ÙŠÙ„:
                // - Ù…Ø¯ÙŠØ±ÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… (admin)
                // - Ù…Ø¯ÙŠØ±ÙŠ Ø£Ù†Ø´Ø·Ø© Ø£Ø®Ø±Ù‰ (manager Ù…Ù† Ø£Ù†Ø´Ø·Ø© Ù…Ø®ØªÙ„ÙØ©)
                // - Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ø£Ù†Ø´Ø·Ø© Ø£Ø®Ø±Ù‰

                const sameActivity = String(user.activityId) === String(loggedInUser.activityId);
                
                if (user.role === 'admin') {
                    showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', 'warning');
                    return;
                }
                
                if (user.role === 'manager' && !isSelf) {
                    showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø· Ø¢Ø®Ø±', 'warning');
                    return;
                }
                
                if (user.role === 'user' && !sameActivity) {
                    showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ù†Ø´Ø§Ø·Ùƒ ÙÙ‚Ø·', 'warning');
                    return;
                }
            }

            const nameInput = document.getElementById('editUserName');
            const emailInput = document.getElementById('editUserEmail');
            const phoneInput = document.getElementById('editUserPhone');
            const passwordInput = document.getElementById('editUserPassword');
            const roleSelect = document.getElementById('editUserRole');
            const actSel = document.getElementById('editUserActivity');

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            nameInput.value = user.name || '';
            emailInput.value = user.email || '';
            
            // ØªØ´Ø®ÙŠØµ Ø®Ø§Øµ Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¬ÙˆØ§Ù„
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ“‹ ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ID:', userId);
            console.log('ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', Object.keys(user));
            console.log('ğŸ“± Ù‚ÙŠÙ…Ø© user.phone:', user.phone);
            console.log('ğŸ“± Ù†ÙˆØ¹ user.phone:', typeof user.phone);
            console.log('ğŸ“± Ù‡Ù„ user.phone ÙØ§Ø±ØºØŸ', user.phone === '' || user.phone === null || user.phone === undefined);
            console.log('ğŸ“± Ø·ÙˆÙ„ user.phone:', user.phone ? user.phone.length : 0);
            console.log('ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…Ù„Ø©:', JSON.stringify(user, null, 2));
            
            // ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚Ù„ Ø§Ù„Ø¬ÙˆØ§Ù„
            phoneInput.value = user.phone || '';
            
            console.log('âœ… Ù‚ÙŠÙ…Ø© Ø­Ù‚Ù„ Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©:', phoneInput.value);
            console.log('âœ… Ø·ÙˆÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø©:', phoneInput.value.length);
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            
            passwordInput.value = user.password || '';
            roleSelect.value = user.role;

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø©
            actSel.innerHTML = '<option value="">-- ØªØ¹ÙŠÙŠÙ† Ù„Ù†Ø´Ø§Ø· --</option>';
            const availableActivities = isManager
                ? activities.filter(a => String(a.id) === String(loggedInUser.activityId))
                : activities;
            availableActivities.forEach(a => actSel.innerHTML += `<option value="${a.id}">${a.name}</option>`);

            const shouldShowActivity = (user.role === 'user' || user.role === 'manager');
            actSel.style.display = shouldShowActivity ? 'block' : 'none';
            actSel.value = shouldShowActivity ? (user.activityId || '') : '';

            // ØªÙ…ÙƒÙŠÙ† Ø£Ùˆ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø¨ Ø³ÙŠØ§Ù‚ Ø§Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ
            const disableRoleSelect = editingUserSelf || isManager || isSelf;
            roleSelect.disabled = disableRoleSelect;
            actSel.disabled = editingUserSelf || isSelf;

            if (!disableRoleSelect) {
                roleSelect.onchange = function() {
                    if (this.value === 'user' || this.value === 'manager') {
                        actSel.style.display = 'block';
                        actSel.disabled = false;
                    } else {
                        actSel.style.display = 'none';
                        actSel.value = '';
                        actSel.disabled = false;
                    }
                };
            } else {
                roleSelect.onchange = null;
            }

            document.getElementById('user-edit-overlay').style.display = 'flex';
        }

        function closeEditUserModal() {
            document.getElementById('user-edit-overlay').style.display = 'none';
            editingUserId = null;
            editingUserSelf = false;
        }

        // ===== Ø¯ÙˆØ§Ù„ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© =====
        let editingActivityId = null;

        function openEditActivityModal(activityId) {
            const activity = activities.find(a => a.id === activityId);
            if (!activity) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }

            editingActivityId = activityId;
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©
            document.getElementById('editActivityName').value = activity.name;
            document.getElementById('activityCreatedAt').textContent = activity.createdAt || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            document.getElementById('activityCreatedBy').textContent = activity.createdBy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            
            // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø¹ ØªØ£Ø«ÙŠØ±
            const overlay = document.getElementById('edit-activity-overlay');
            overlay.style.display = 'flex';
            overlay.classList.add('show');
            
            // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù…
            setTimeout(() => {
                document.getElementById('editActivityName').focus();
                document.getElementById('editActivityName').select();
            }, 300);
        }

        function closeEditActivityModal() {
            const overlay = document.getElementById('edit-activity-overlay');
            overlay.classList.remove('show');
            overlay.classList.add('hide');
            
            setTimeout(() => {
                overlay.style.display = 'none';
                overlay.classList.remove('hide');
                editingActivityId = null;
                document.getElementById('editActivityForm').reset();
            }, 300);
        }

        async function saveEditedActivity() {
            const nameInput = document.getElementById('editActivityName');
            const newName = nameInput.value.trim();
            
            if (!newName) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·', 'warning');
                nameInput.focus();
                return;
            }
            
            if (!editingActivityId) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„ØªØ¹Ø¯ÙŠÙ„', 'error');
                return;
            }
            
            const activityIndex = activities.findIndex(a => a.id === editingActivityId);
            if (activityIndex === -1) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }
            
            const currentName = activities[activityIndex].name;
            
            if (newName === currentName) {
                showNotification('â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±', 'Ù„Ù… ØªÙ‚Ù… Ø¨ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·', 'info');
                closeEditActivityModal();
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†Ø´Ø§Ø· Ø¢Ø®Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…
            const existingActivity = activities.find(a => a.name === newName && a.id !== editingActivityId);
            if (existingActivity) {
                showNotification('âš ï¸ Ø§Ø³Ù… Ù…ÙƒØ±Ø±', 'ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø¢Ø®Ø± Ø¨Ù†ÙØ³ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…', 'warning');
                nameInput.focus();
                nameInput.select();
                return;
            }
            
            try {
                // Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                activities[activityIndex].name = newName;
                activities[activityIndex].updatedAt = new Date().toLocaleString('ar-SA');
                
                // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆFirebase
                await saveActivities();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                renderActivitiesInSettings();
                
                // ØªØ­Ø¯ÙŠØ« Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
                if (currentActivityId === editingActivityId) {
                    updateHeaderForActivity(activities[activityIndex]);
                }
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ ÙÙŠ Firebase Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
                try {
                    if (typeof firebaseSaveActivityData === 'function' && currentActivityId === editingActivityId) {
                        await firebaseSaveActivityData();
                    }
                } catch (firebaseError) {
                    console.log('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase:', firebaseError.message);
                }
                
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø¥Ù„Ù‰ "${newName}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                closeEditActivityModal();
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†Ø´Ø§Ø·:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª', 'error');
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Enter ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ù†Øµ
        document.addEventListener('DOMContentLoaded', function() {
            const editActivityName = document.getElementById('editActivityName');
            if (editActivityName) {
                editActivityName.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveEditedActivity();
                    }
                });
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
            const editActivityOverlay = document.getElementById('edit-activity-overlay');
            if (editActivityOverlay) {
                editActivityOverlay.addEventListener('click', function(e) {
                    if (e.target === editActivityOverlay) {
                        closeEditActivityModal();
                    }
                });
            }
        });


        // ===== Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· =====

        function openSelfEditUserModal() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser) {
                showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ø¬Ù„', 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }

            console.log('ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† sessionStorage:', loggedInUser);
            console.log('ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ù† sessionStorage:', loggedInUser.phone);

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ù…ØµÙÙˆÙØ© users Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© (Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„)
            const currentUser = users.find(u => String(u.id) === String(loggedInUser.id));
            
            if (!currentUser) {
                showNotification('âŒ Ø®Ø·Ø£', 'ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ¹Ø¯ÙŠÙ„', 'error');
                return;
            }

            console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù…ØµÙÙˆÙØ© users:', currentUser);
            console.log('ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ù† users:', currentUser.phone);
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ sessionStorage ÙˆÙ„ÙŠØ³ ÙÙŠ usersØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« users
            if (loggedInUser.phone && !currentUser.phone) {
                console.log('âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ sessionStorage Ù„ÙƒÙ† Ù…ÙÙ‚ÙˆØ¯ ÙÙŠ users!');
                console.log('ğŸ”§ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« users Ù…Ù† sessionStorage...');
                currentUser.phone = loggedInUser.phone;
                saveUsers();
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« users Ø¨Ù†Ø¬Ø§Ø­');
            }

            openEditUserModal(currentUser.id, { selfEdit: true });
        }

        async function saveEditedUser() {
            console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø¯Ø§Ù„Ø© saveEditedUser...');
            
            const name = document.getElementById('editUserName').value.trim();
            const email = document.getElementById('editUserEmail').value.trim();
            const phone = document.getElementById('editUserPhone').value.trim();
            const password = document.getElementById('editUserPassword').value.trim();
            let role = document.getElementById('editUserRole').value;
            let activityId = document.getElementById('editUserActivity').value;
            const phonePattern = /^[+\d]{6,20}$/;
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const isManager = loggedInUser && loggedInUser.role === 'manager';

            // ØªØ´Ø®ÙŠØµ Ù…ÙØµÙ„ Ù„Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
            console.log('ğŸ“‹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¯Ø®Ù„Ø©:');
            console.log('  ğŸ“§ Email:', email);
            console.log('  ğŸ‘¤ Name:', name);
            console.log('  ğŸ“± Phone (raw):', `"${document.getElementById('editUserPhone').value}"`);
            console.log('  ğŸ“± Phone (trimmed):', `"${phone}"`);
            console.log('  ğŸ“± Phone length:', phone.length);
            console.log('  ğŸ“± Phone type:', typeof phone);
            console.log('  ğŸ” Password:', password ? '***' : 'ÙØ§Ø±Øº');
            console.log('  ğŸ­ Role:', role);
            console.log('  ğŸ¢ ActivityId:', activityId);
            console.log('  ğŸ”¢ editingUserId:', editingUserId);

            if (!name) { showNotification('âš ï¸ Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·Ù„ÙˆØ¨', 'warning'); return; }
            if (!email) { showNotification('âš ï¸ Ø¨Ø±ÙŠØ¯ Ù…Ø·Ù„ÙˆØ¨', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø·Ù„ÙˆØ¨', 'warning'); return; }
            if (!phone) { 
                console.error('âŒ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙØ§Ø±Øº!'); 
                showNotification('âš ï¸ Ø¬ÙˆØ§Ù„ Ù…Ø·Ù„ÙˆØ¨', 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ø·Ù„ÙˆØ¨', 'warning'); 
                return; 
            }
            if (!phonePattern.test(phone)) { 
                console.error('âŒ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:', phone); 
                showNotification('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· ÙˆÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ù„Ø§Ù…Ø© +', 'warning'); 
                return; 
            }
            if (!role) { showNotification('âš ï¸ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø©', 'Ø§Ø®ØªØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©', 'warning'); return; }

            const idx = users.findIndex(u => String(u.id) === String(editingUserId));
            console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:');
            console.log('  ğŸ”¢ editingUserId:', editingUserId, '(type:', typeof editingUserId, ')');
            console.log('  ğŸ“Š users.length:', users.length);
            console.log('  ğŸ“ users IDs:', users.map(u => `${u.id} (${typeof u.id})`));
            console.log('  ğŸ¯ found index:', idx);
            
            if (idx === -1) { 
                console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…ØµÙÙˆÙØ© users!');
                showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error'); 
                return; 
            }

            const targetUser = users[idx];
            console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', {
                id: targetUser.id,
                email: targetUser.email,
                name: targetUser.name,
                phone: targetUser.phone,
                phoneType: typeof targetUser.phone
            });
            
            const isSelf = loggedInUser && String(targetUser.id) === String(loggedInUser.id);

            // ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·
            if (isManager && !isSelf) {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ†ØªÙ…ÙŠ Ù„Ù†ÙØ³ Ø§Ù„Ù†Ø´Ø§Ø·
                if (String(targetUser.activityId) !== String(loggedInUser.activityId)) {
                    showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ù†Ø´Ø§Ø·Ùƒ ÙÙ‚Ø·', 'warning');
                    return;
                }
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØ³ØªÙ‡Ø¯Ù Ù„ÙŠØ³ Ù…Ø¯ÙŠØ± Ø£Ùˆ Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…
                if (targetUser.role === 'admin' || targetUser.role === 'manager') {
                    showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', 'warning');
                    return;
                }
                
                // ÙØ±Ø¶ Ø¯ÙˆØ± Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ ÙˆÙ†ÙØ³ Ø§Ù„Ù†Ø´Ø§Ø·
                role = 'user';
                activityId = loggedInUser.activityId;
            } else if (isSelf) {
                // Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ù†ÙØ³Ù‡ØŒ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
                role = targetUser.role;
                activityId = targetUser.activityId || '';
            } else if (editingUserSelf) {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø°Ø§ØªÙŠ
                role = targetUser.role;
                activityId = targetUser.activityId || '';
            }

            if ((role === 'user' || role === 'manager') && !activityId) { showNotification('âš ï¸ Ù†Ø´Ø§Ø· Ù…Ø·Ù„ÙˆØ¨', 'ÙŠØ¬Ø¨ ØªØ¹ÙŠÙŠÙ† Ù†Ø´Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'warning'); return; }


            // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±
            if (users.some(u => u.email === email && String(u.id) !== String(editingUserId))) {
                showNotification('âŒ Ø¨Ø±ÙŠØ¯ Ù…ÙƒØ±Ø±', 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
                return;
            }

            console.log('ğŸ’¾ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ø¯ÙŠØ«...');
            console.log('  ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', `"${phone}"`);
            console.log('  ğŸ“± Ø·ÙˆÙ„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:', phone.length);
            console.log('  ğŸ“± Ù†ÙˆØ¹ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:', typeof phone);
            console.log('  ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù„Ù„ØªØ­Ø¯ÙŠØ«:', {
                id: targetUser.id,
                name: targetUser.name,
                email: targetUser.email,
                phoneBeforeUpdate: targetUser.phone,
                phoneBeforeType: typeof targetUser.phone
            });

            // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
            const oldPhone = targetUser.phone;
            
            targetUser.name = name;
            targetUser.email = email;
            targetUser.phone = phone;
            if (password) targetUser.password = password; // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø©
            targetUser.role = role;
            targetUser.activityId = (role === 'user' || role === 'manager') ? activityId : null;

            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« targetUser:');
            console.log('  ğŸ“± oldPhone:', `"${oldPhone}"`);
            console.log('  ğŸ“± newPhone:', `"${targetUser.phone}"`);
            console.log('  ğŸ“± phoneChanged:', oldPhone !== targetUser.phone);
            console.log('  ğŸ‘¤ targetUser Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', {
                id: targetUser.id,
                name: targetUser.name,
                email: targetUser.email,
                phone: targetUser.phone,
                phoneType: typeof targetUser.phone
            });
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ… ÙÙŠ Ù…ØµÙÙˆÙØ© users
            const checkUser = users[idx];
            console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† users[idx] Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', {
                id: checkUser.id,
                phone: checkUser.phone,
                phoneType: typeof checkUser.phone
            });
            console.log('ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', {
                id: targetUser.id,
                name: targetUser.name,
                email: targetUser.email,
                phone: targetUser.phone,
                role: targetUser.role
            });

            const updatedUser = targetUser;
            
            // Ø­ÙØ¸ ØªÙØµÙŠÙ„ÙŠ Ù…Ø¹ ØªØ´Ø®ÙŠØµ
            console.log('ğŸ’¾ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...');
            const saveResult = await saveUsers();
            console.log('ğŸ’¾ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­ÙØ¸:', saveResult);
            
            // Ø­ÙØ¸ ÙÙŠ Firebase Ø£ÙŠØ¶Ø§Ù‹
            try {
                if (USE_FIREBASE && typeof firebase !== 'undefined' && firebase.auth().currentUser) {
                    console.log('ğŸ”¥ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØ­Ø¯Ø« ÙÙŠ Firebase...');
                    console.log('ğŸ”¥ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', updatedUser.id);
                    console.log('ğŸ”¥ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸:', {
                        name: updatedUser.name,
                        email: updatedUser.email,
                        phone: updatedUser.phone,
                        role: updatedUser.role,
                        activityId: updatedUser.activityId
                    });
                    
                    const userRef = firebase.database().ref(`users/${updatedUser.id}`);
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Ø£ÙˆÙ„Ø§Ù‹
                    const existingUser = await userRef.once('value');
                    if (existingUser.exists()) {
                        console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ FirebaseØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...');
                        await userRef.update({
                            name: updatedUser.name,
                            email: updatedUser.email,
                            phone: updatedUser.phone,
                            role: updatedUser.role,
                            activityId: updatedUser.activityId,
                            updatedAt: new Date().toISOString()
                        });
                        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­');
                    } else {
                        console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ FirebaseØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¤Ù‡...');
                        await userRef.set({
                            id: updatedUser.id,
                            name: updatedUser.name,
                            email: updatedUser.email,
                            phone: updatedUser.phone,
                            role: updatedUser.role,
                            activityId: updatedUser.activityId,
                            createdAt: updatedUser.createdAt || new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­');
                    }
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase
                    const verification = await userRef.once('value');
                    const savedData = verification.val();
                    console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Firebase:', savedData.phone);
                    
                } else {
                    console.log('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„');
                }
            } catch (firebaseError) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase:', firebaseError);
            }
            
            console.log('ğŸ’¾ Ø¨Ø¹Ø¯ saveUsers() - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:');
            const savedUser = users.find(u => String(u.id) === String(editingUserId));
            console.log('ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø­ÙÙˆØ¸:', savedUser ? savedUser.phone : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            
            // ØªØ­Ù‚Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ù…Ù† localStorage Ù…Ø¨Ø§Ø´Ø±Ø©
            const directCheck = loadFromLocalStorage('diwan_users');
            if (directCheck) {
                const directUser = directCheck.find(u => String(u.id) === String(editingUserId));
                console.log('ğŸ“± ØªØ­Ù‚Ù‚ Ù…Ø¨Ø§Ø´Ø± Ù…Ù† localStorage - Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:', directUser ? directUser.phone : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            }
            
            if (loggedInUser && String(loggedInUser.id) === String(updatedUser.id)) {
                sessionStorage.setItem('loggedInUser', JSON.stringify(updatedUser));
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« sessionStorage Ø£ÙŠØ¶Ø§Ù‹');
                updateLoggedInUserDisplay(updatedUser);
            }
            renderUsersInSettings();
            closeEditUserModal();
            showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'success');
        }

        async function deleteUser(id) {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const targetId = String(id);
            if (loggedInUser && String(loggedInUser.id) === targetId) {
                showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ù†ÙØ³Ùƒ', 'warning');
                return;
            }

            if (loggedInUser && loggedInUser.role === 'manager') {
                const target = users.find(u => String(u.id) === targetId);
                if (!target || target.role !== 'user' || String(target.activityId) !== String(loggedInUser.activityId)) {
                    showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'warning');
                    return;
                }
            }

            const admins = users.filter(u => u.role === 'admin');
            const userToDelete = users.find(u => String(u.id) === targetId);
            if (!userToDelete) {
                showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯', 'error');
                return;
            }

            if (userToDelete.role === 'admin' && admins.length <= 1) {
                showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙŠØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…', 'warning');
                return;
            }

            const confirmed = await showConfirmDialog(
                'Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
                `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${userToDelete.email}ØŸ`,
                'danger',
                'Ø­Ø°Ù',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                users = users.filter(u => String(u.id) !== targetId);
                await saveUsers();
                renderUsersInSettings();
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
        function addUser() {
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const phone = document.getElementById('newUserPhone').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            const role = document.getElementById('newUserRole').value;
            const activityId = document.getElementById('newUserActivity').value;
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const isAdmin = loggedInUser && loggedInUser.role === 'admin';
            const isManager = loggedInUser && loggedInUser.role === 'manager';

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            if (!name || !email || !phone || !password) {
                showNotification('âš ï¸ Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning');
                return;
            }

            if (!loggedInUser || (!isAdmin && !isManager)) {
                showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', 'warning');
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showNotification('âš ï¸ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­', 'warning');
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
            if (users.some(u => u.email === email)) {
                showNotification('âš ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
                return;
            }

            let normalizedRole = role;
            let normalizedActivityId = activityId;

            if (isManager) {
                if (!loggedInUser.activityId) {
                    showNotification('âš ï¸ Ù†Ø´Ø§Ø· ØºÙŠØ± Ù…Ø­Ø¯Ø¯', 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Ù†Ø´Ø§Ø· Ù…Ø­Ø¯Ø¯ Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', 'warning');
                    return;
                }

                // Ù‚ÙŠÙˆØ¯ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·
                if (role !== 'user') {
                    showNotification('âš ï¸ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø­Ø¯ÙˆØ¯Ø©', 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ø§Ø¯ÙŠÙŠÙ† ÙÙ‚Ø·', 'warning');
                    return;
                }

                if (activityId && String(activityId) !== String(loggedInUser.activityId)) {
                    showNotification('âš ï¸ Ù†Ø´Ø§Ø· ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ù„Ù‰ Ù†Ø´Ø§Ø·Ùƒ ÙÙ‚Ø·', 'warning');
                    return;
                }

                // ØªØ­ÙˆÙŠÙ„ Ù…Ø¹Ø±Ù Ø§Ù„Ù†Ø´Ø§Ø· Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚
                const managerActivityId = loggedInUser.activityId;
                normalizedRole = 'user'; // ÙÙ‚Ø· Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ø§Ø¯ÙŠÙŠÙ†
                normalizedActivityId = managerActivityId; // ÙÙ‚Ø· Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø¯ÙŠØ±

                console.log('ğŸ§­ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ÙŠØ¶ÙŠÙ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ:', {
                    managerEmail: loggedInUser.email,
                    managerActivityId: managerActivityId,
                    newUserRole: normalizedRole,
                    newUserActivityId: normalizedActivityId
                });
            }

            if ((normalizedRole === 'user' || normalizedRole === 'manager') && !normalizedActivityId) {
                showNotification('âš ï¸ Ù†Ø´Ø§Ø· Ù…Ø·Ù„ÙˆØ¨', 'ÙŠØ¬Ø¨ ØªØ¹ÙŠÙŠÙ† Ù†Ø´Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'warning');
                return;
            }

            if (normalizedRole === 'admin') {
                normalizedActivityId = null;
            }

            try {
                showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...');

                // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const newUser = {
                    id: 'user_' + Date.now(),
                    name: name,
                    email: email,
                    password: password,
                    phone: phone,
                    role: normalizedRole,
                    activityId: (normalizedRole === 'user' || normalizedRole === 'manager') ? normalizedActivityId : null,
                    createdAt: new Date().toISOString()
                };

                console.log(' Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯:', {
                    email: newUser.email,
                    role: newUser.role,
                    activityId: newUser.activityId,
                    activityIdType: typeof newUser.activityId,
                    addedBy: loggedInUser.email,
                    addedByRole: loggedInUser.role,
                    addedByActivityId: loggedInUser.activityId
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ©
                users.push(newUser);

                // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                saveUsers();
                
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¢Ù†:', users.length);

                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserEmail').value = '';
                document.getElementById('newUserPhone').value = '';
                document.getElementById('newUserPassword').value = '';
                document.getElementById('newUserRole').value = 'user';
                document.getElementById('newUserActivity').value = '';

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
                renderUsersInSettings();

                hideLoading();
                showNotification('âœ… ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');

            } catch (error) {
                hideLoading();
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
            }
        }

        // ===== Logo Management Functions =====
        function handleLogoUpload(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];
            if (!validTypes.includes(file.type)) {
                showNotification('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø¨ØµÙŠØºØ© PNG Ø£Ùˆ JPG Ø£Ùˆ SVG ÙÙ‚Ø·.', 'error');
                fileInput.value = '';
                return;
            }

            // Validate file size (max 2MB)
            const maxSize = 2 * 1024 * 1024; // 2MB in bytes
            if (file.size > maxSize) {
                showNotification('âŒ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª.', 'error');
                fileInput.value = '';
                return;
            }

            // Read and convert to Base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64String = e.target.result;
                
                // Save to localStorage
                localStorage.setItem('systemLogo', base64String);
                
                // Update preview in Settings
                const previewImg = document.getElementById('logoPreview');
                if (previewImg) {
                    previewImg.src = base64String;
                    previewImg.style.display = 'block';
                }
                
                // Hide "no logo" text
                const noLogoText = document.getElementById('noLogoText');
                if (noLogoText) noLogoText.style.display = 'none';
                
                // Update login screen logo
                const loginLogo = document.getElementById('loginLogo');
                if (loginLogo) {
                    loginLogo.src = base64String;
                    loginLogo.style.display = 'block';
                }
                
                // Update sidebar logo
                const sidebarLogo = document.getElementById('sidebarLogo');
                if (sidebarLogo) {
                    sidebarLogo.src = base64String;
                    sidebarLogo.style.display = 'block';
                }
                
                // Show remove button
                const removeBtn = document.getElementById('removeLogoBtn');
                if (removeBtn) removeBtn.style.display = 'inline-block';
                
                showNotification('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            };
            
            reader.onerror = function() {
                showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.', 'error');
                fileInput.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            showConfirmDialog(
                'Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø±',
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ',
                'warning',
                'Ø­Ø°Ù',
                'Ø¥Ù„ØºØ§Ø¡'
            ).then(confirmed => {
                if (confirmed) {
                    // Remove from localStorage
                    localStorage.removeItem('systemLogo');
                    
                    // Clear preview in Settings
                    const previewImg = document.getElementById('logoPreview');
                    if (previewImg) {
                        previewImg.src = '';
                        previewImg.style.display = 'none';
                    }
                    
                    // Show "no logo" text
                    const noLogoText = document.getElementById('noLogoText');
                    if (noLogoText) noLogoText.style.display = 'block';
                    
                    // Clear login screen logo
                    const loginLogo = document.getElementById('loginLogo');
                    if (loginLogo) {
                        loginLogo.src = '';
                        loginLogo.style.display = 'none';
                    }
                    
                    // Clear sidebar logo
                    const sidebarLogo = document.getElementById('sidebarLogo');
                    if (sidebarLogo) {
                        sidebarLogo.src = '';
                        sidebarLogo.style.display = 'none';
                    }
                    
                    // Hide remove button
                    const removeBtn = document.getElementById('removeLogoBtn');
                    if (removeBtn) removeBtn.style.display = 'none';
                    
                    // Clear file input
                    const fileInput = document.getElementById('logoFileInput');
                    if (fileInput) fileInput.value = '';
                    
                    showNotification('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                }
            });
        }

        function loadSavedLogo() {
            const savedLogo = localStorage.getItem('systemLogo');
            const noLogoText = document.getElementById('noLogoText');
            
            if (savedLogo) {
                // Update preview in Settings
                const previewImg = document.getElementById('logoPreview');
                if (previewImg) {
                    previewImg.src = savedLogo;
                    previewImg.style.display = 'block';
                }
                
                // Hide "no logo" text
                if (noLogoText) noLogoText.style.display = 'none';
                
                // Update login screen logo
                const loginLogo = document.getElementById('loginLogo');
                if (loginLogo) {
                    loginLogo.src = savedLogo;
                    loginLogo.style.display = 'block';
                }
                
                // Update sidebar logo
                const sidebarLogo = document.getElementById('sidebarLogo');
                if (sidebarLogo) {
                    sidebarLogo.src = savedLogo;
                    sidebarLogo.style.display = 'block';
                }
                
                // Show remove button
                const removeBtn = document.getElementById('removeLogoBtn');
                if (removeBtn) removeBtn.style.display = 'inline-block';
            } else {
                // Show "no logo" text if no logo exists
                if (noLogoText) noLogoText.style.display = 'block';
            }
        }

        // ===== Activity Logo Functions =====
        function handleActivityLogoUpload(fileInput) {
            debugLog('ğŸ” Ø¨Ø¯Ø¡ Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·...');
            
            const file = fileInput.files[0];
            if (!file) {
                debugLog('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù');
                return;
            }
            
            debugLog('ğŸ“„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±:', file.name, 'Ø§Ù„Ø­Ø¬Ù…:', file.size);
            
            // Check file size (max 500KB for localStorage compatibility)
            if (file.size > 500 * 1024) {
                showNotification('âŒ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹', 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 500 ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª. ÙŠØ±Ø¬Ù‰ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.', 'error');
                fileInput.value = '';
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                debugLog('âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­');
                const base64String = e.target.result;
                
                // Get current activity
                let currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
                debugLog('Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ:', currentActivity);
                
                if (!currentActivity) {
                    showNotification('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ù…Ø­Ø¯Ø¯', 'error');
                    return;
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·
                currentActivity.logo = base64String;
                
                // Ø­ÙØ¸ ÙÙŠ sessionStorage
                sessionStorage.setItem('currentActivity', JSON.stringify(currentActivity));
                
                // Ø­ÙØ¸ ÙÙŠ localStorage activities
                try {
                    const storageKey = `activity_${currentActivity.id}_data`;
                    const activityData = JSON.parse(localStorage.getItem(storageKey)) || {};
                    activityData.logo = base64String;
                    localStorage.setItem(storageKey, JSON.stringify(activityData));
                    debugLog('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ localStorage');
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        showNotification('âŒ Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦Ø©', 'Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø£ØµØºØ± (Ø£Ù‚Ù„ Ù…Ù† 200 ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª).', 'error');
                        fileInput.value = '';
                        return;
                    }
                    throw error;
                }
                
                // Update preview
                const previewImg = document.getElementById('activityLogoPreview');
                const noLogoText = document.getElementById('noActivityLogoText');
                if (previewImg) {
                    previewImg.src = base64String;
                    previewImg.style.display = 'block';
                    debugLog('ğŸ–¼ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¹Ø§Ø±');
                }
                if (noLogoText) noLogoText.style.display = 'none';
                
                // Update header logo
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) {
                    headerLogo.src = base64String;
                    headerLogo.style.display = 'block';
                    debugLog('ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©');
                }
                
                // Show remove button
                const removeBtn = document.getElementById('removeActivityLogoBtn');
                if (removeBtn) removeBtn.style.display = 'inline-block';
                
                showNotification('âœ… ØªÙ… Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            };
            
            reader.onerror = function() {
                debugLog('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù');
                showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.', 'error');
                fileInput.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        function removeActivityLogo() {
            showConfirm(
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·ØŸ',
                'Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±',
                'warning',
                () => {
                    const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
                    if (!currentActivity) return;
                    
                    // Remove logo from localStorage
                    const storageKey = `activity_${currentActivity.id}_data`;
                    const activityData = JSON.parse(localStorage.getItem(storageKey)) || {};
                    delete activityData.logo;
                    localStorage.setItem(storageKey, JSON.stringify(activityData));
                    
                    // Update preview
                    const previewImg = document.getElementById('activityLogoPreview');
                    const noLogoText = document.getElementById('noActivityLogoText');
                    if (previewImg) previewImg.style.display = 'none';
                    if (noLogoText) noLogoText.style.display = 'block';
                    
                    // Clear header logo
                    const headerLogo = document.getElementById('activityHeaderLogo');
                    if (headerLogo) headerLogo.style.display = 'none';
                    
                    // Hide remove button
                    const removeBtn = document.getElementById('removeActivityLogoBtn');
                    if (removeBtn) removeBtn.style.display = 'none';
                    
                    // Clear file input
                    const fileInput = document.getElementById('activityLogoFileInput');
                    if (fileInput) fileInput.value = '';
                    
                    showNotification('âœ… ØªÙ… Ø­Ø°Ù Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                }
            );
        }

        function loadActivityLogo() {
            const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
            if (!currentActivity) {
                // Hide logo if no activity
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) headerLogo.style.display = 'none';
                return;
            }
            
            // Load logo from localStorage
            const storageKey = `activity_${currentActivity.id}_data`;
            const activityData = JSON.parse(localStorage.getItem(storageKey));
            const savedLogo = activityData?.logo;
            
            if (!savedLogo) {
                // Hide logo if no logo saved
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) headerLogo.style.display = 'none';
                return;
            }
            
            // Update preview in settings
            const previewImg = document.getElementById('activityLogoPreview');
            const noLogoText = document.getElementById('noActivityLogoText');
            if (previewImg) {
                previewImg.src = savedLogo;
                previewImg.style.display = 'block';
            }
            if (noLogoText) noLogoText.style.display = 'none';
            
            // Update header logo
            const headerLogo = document.getElementById('activityHeaderLogo');
            if (headerLogo) {
                headerLogo.src = savedLogo;
                headerLogo.style.display = 'block';
            }
            
            // Show remove button
            const removeBtn = document.getElementById('removeActivityLogoBtn');
            if (removeBtn) removeBtn.style.display = 'inline-block';
        }

        // ===== Email Functions (Ù…ÙÙˆØ­Ù‘ÙØ¯Ø© Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„ÙØ› ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø©) =====
function emailSaleInvoice(saleId) {
    if (!emailJsConfig.serviceID || !emailJsConfig.templateID || !emailJsConfig.publicKey) {
        showNotification('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªÙƒÙˆÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.', 'warning');
        return;
    }

    const sale = sales.find(s => s.id === saleId);
    if (!sale) return;

    const customer = customers.find(c => c.id === sale.customerId);
    if (!customer || !customer.email) {
        showNotification('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.', 'error');
        return;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
    const currentActivity = activities.find(a => a.id == currentActivityId);
    const activityName = currentActivity ? currentActivity.name : 'Ø¨Ø³Ù…Ø© Ø¨ÙˆØªÙŠÙƒ';

    // Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
    let emailContent = `
        <div style="font-family: Arial, sans-serif; direction: rtl; text-align: right;">
            <h2 style="color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 10px;">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
            
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
            <div style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> SAL${sale.number.toString().padStart(3, '0')}</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${sale.date}</p>
                <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${customer.name}</p>
                <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${sale.notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}</p>
            </div>

            <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù -->
            <h3 style="color: #34495e;">Ø£ØµÙ†Ø§Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</h3>
            <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                <tr style="background-color: #2c5aa0; color: white;">
                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„ØµÙ†Ù</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                </tr>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù
    sale.items.forEach(item => {
        emailContent += `
            <tr>
                <td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.quantity}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: left;">${item.price.toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: left;">${item.total.toFixed(2)}</td>
            </tr>
        `;
    });

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
    emailContent += `
            </table>
            
            <div style="margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: left; max-width: 350px; margin-left: 0; margin-right: auto;">
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span> <strong>${sale.subtotal.toFixed(2)}</strong></p>
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span> <strong>${sale.tax.toFixed(2)}</strong></p>
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span> <strong>${(sale.paidAmount || 0).toFixed(2)}</strong></p>
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span> <strong>${(sale.remainingAmount ?? sale.total).toFixed(2)}</strong></p>
                <h3 style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #2c5aa0; color: #2c5aa0; display: flex; justify-content: space-between;"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span> <strong>${sale.total.toFixed(2)}</strong></h3>
            </div>

            <!-- Ø§Ù„ØªØ­ÙŠØ© -->
            <div style="margin-top: 30px; text-align: center; font-style: italic; border-top: 1px solid #ddd; padding-top: 15px;">
                <p>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹ ${activityName}</p>
            </div>
        </div>
    `;

    const templateParams = {
        to_name: customer.name,
        to_email: customer.email,
        from_name: activityName,
        invoice_number: `SAL${sale.number.toString().padStart(3, '0')}`,
        invoice_details: emailContent,
        email_subject: `ÙØ§ØªÙˆØ±Ø© ${activityName} - SAL${sale.number.toString().padStart(3, '0')}`
    };

    emailjs.send(emailJsConfig.serviceID, emailJsConfig.templateID, templateParams, emailJsConfig.publicKey)
        .then(function(response) {
           showNotification('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }, function(error) {
           showNotification('âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + error.text, 'error');
        });
}

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        function loadUsersDropdown() {
            // Ø¯Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ©
            console.log('ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...');
        }

        function loadActivitiesDropdown() {
            // Ø¯Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ©  
            console.log('ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø©...');
        }

        // ===== Ù†Ø¸Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ =====
        
        /**
         * Ù†Ø¸Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø°ÙƒÙŠ Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©
         * ÙŠÙÙ†Ø¨Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
         */
        function initBackupReminderSystem() {
            if (!currentActivityId) return;
            
            const reminderKey = `diwan_lastBackupReminder_${currentActivityId}`;
            const lastReminderTime = Number(localStorage.getItem(reminderKey) || 0);
            const now = Date.now();
            const twentyFourHours = 24 * 60 * 60 * 1000;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ù…Ø± 24 Ø³Ø§Ø¹Ø© Ù…Ù†Ø° Ø¢Ø®Ø± ØªÙ†Ø¨ÙŠÙ‡
            if ((now - lastReminderTime) >= twentyFourHours) {
                showBackupReminder();
            }
            
            // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©
            setInterval(() => {
                const currentTime = Date.now();
                const lastCheck = Number(localStorage.getItem(reminderKey) || 0);
                if ((currentTime - lastCheck) >= twentyFourHours) {
                    showBackupReminder();
                }
            }, twentyFourHours);
        }
        
        /**
         * Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
         */
        async function showBackupReminder() {
        /**
         * Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
         */
        async function showBackupReminder() {
            if (!currentActivityId) return;
            
            try {
                const activity = activities.find(a => a.id == currentActivityId);
                if (!activity) return;
                
                // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªÙ†Ø¨ÙŠÙ‡
                const reminderKey = `diwan_lastBackupReminder_${currentActivityId}`;
                localStorage.setItem(reminderKey, String(Date.now()));
                
                // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const totalRecords = (items?.length || 0) + (customers?.length || 0) + (suppliers?.length || 0) + 
                                   (purchases?.length || 0) + (sales?.length || 0) + (expenses?.length || 0) + 
                                   (revenues?.length || 0) + (salaries?.length || 0);
                
                // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø³ÙŠØ·
                const userChoice = confirm(`ğŸ›¡ï¸ ÙˆÙ‚Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ!\n\nÙ†Ø´Ø§Ø·: ${activity.name}\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${totalRecords}\n\nÙ„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù†Ø° Ø£ÙƒØ«Ø± Ù…Ù† 24 Ø³Ø§Ø¹Ø©.\nÙ†Ù†ØµØ­ Ø¨Ø¥Ø¬Ø±Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø£Ù…Ø§Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ø¢Ù†ØŸ`);
                
                if (userChoice) {
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªØ§Ø± Ø¥Ø¬Ø±Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙˆØ±Ø§Ù‹
                    const success = await performManualBackup();
                    if (success) {
                        showNotification('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    } else {
                        showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
                    }
                } else {
                    showNotification('â„¹ï¸ ØªÙ… ØªØ£Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'Ø³ÙŠØªÙ… ØªØ°ÙƒÙŠØ±Ùƒ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 24 Ø³Ø§Ø¹Ø©', 'info');
                }
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ:', error);
            }
        }
        
        /**
         * Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
         */
        async function showBackupReminderDialog(activityName, totalRecords, dataStats) {
            return new Promise((resolve) => {
                // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø¨Ø³Ø·Ø©
                const confirmed = confirm(`ÙˆÙ‚Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ! ğŸ›¡ï¸\n\nÙ†Ø´Ø§Ø·: ${activityName}\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${totalRecords}\n\nÙ„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù†Ø° Ø£ÙƒØ«Ø± Ù…Ù† 24 Ø³Ø§Ø¹Ø©.\nÙ†Ù†ØµØ­ Ø¨Ø¥Ø¬Ø±Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø£Ù…Ø§Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ø¢Ù†ØŸ`);
                
                if (confirmed) {
                    resolve('backup_now');
                } else {
                    resolve('dismiss');
                }
            });
        }
        
        /**
         * ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ø¹Ù†Ø¯ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
         */
        async function performManualBackup() {
            if (!currentActivityId) return;
            
            try {
                const activity = activities.find(a => a.id == currentActivityId);
                if (!activity) return;
                
                // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const backupData = {
                    activity: activity,
                    items: items || [],
                    customers: customers || [],
                    suppliers: suppliers || [],
                    purchases: purchases || [],
                    sales: sales || [],
                    expenses: expenses || [],
                    revenues: revenues || [],
                    salaries: salaries || [],
                    backupDate: new Date().toISOString(),
                    backupTimestamp: Date.now(),
                    version: '23.0',
                    backupType: 'manual' // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
                };
                
                // Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ localStorage
                const backupKey = `diwan_manualBackup_${currentActivityId}`;
                const oldBackupsKey = `diwan_manualBackup_old_${currentActivityId}`;
                
                // Ù†Ù‚Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                const oldBackup = localStorage.getItem(backupKey);
                if (oldBackup) {
                    localStorage.setItem(oldBackupsKey, oldBackup);
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                localStorage.setItem(`diwan_lastBackupReminder_${currentActivityId}`, String(Date.now()));
                
                debugLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ© Ù„Ù„Ù†Ø´Ø§Ø·: ${activity.name}`);
                
                return true;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ÙŠØ¯ÙˆÙŠ:', error);
                return false;
            }
        }
        
        /**
         * Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ©
         */
        async function restoreManualBackup() {
            if (!currentActivityId) {
                showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø· Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const backupKey = `diwan_manualBackup_${currentActivityId}`;
            const backupData = localStorage.getItem(backupKey);
            
            if (!backupData) {
                showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø´Ø§Ø·', 'warning');
                return;
            }
            
            const confirmed = await showConfirmDialog(
                'Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©',
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                'warning',
                'Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            
            if (!confirmed) return;
            
            try {
                const backup = JSON.parse(backupData);
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                items = backup.items || [];
                customers = backup.customers || [];
                suppliers = backup.suppliers || [];
                purchases = backup.purchases || [];
                sales = backup.sales || [];
                expenses = backup.expenses || [];
                revenues = backup.revenues || [];
                salaries = backup.salaries || [];
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø© ÙÙŠ Firebase
                saveToLocalStorage('items', items);
                saveToLocalStorage('customers', customers);
                saveToLocalStorage('suppliers', suppliers);
                saveToLocalStorage('purchases', purchases);
                saveToLocalStorage('sales', sales);
                saveToLocalStorage('expenses', expenses);
                saveToLocalStorage('revenues', revenues);
                saveToLocalStorage('salaries', salaries);
                saveToLocalStorage('assets', assets);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                renderItems();
                renderCustomers();
                renderSuppliers();
                renderPurchasesList();
                renderSalesList();
                renderExpenses();
                renderRevenues();
                renderSalaries();
                updateDataStats();
                
                const backupDate = new Date(backup.backupDate);
                showNotification(
                    'âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­',
                    `ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨ØªØ§Ø±ÙŠØ® ${backupDate.toLocaleString('ar-SA')}`,
                    'success'
                );
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
                showNotification('âŒ ÙØ´Ù„Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
            }
        }
        
        /**
         * Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ©
         */
        function showManualBackupInfo() {
            if (!currentActivityId) return;
            
            const backupKey = `diwan_manualBackup_${currentActivityId}`;
            const lastReminderKey = `diwan_lastBackupReminder_${currentActivityId}`;
            
            const backupData = localStorage.getItem(backupKey);
            const lastReminderTime = Number(localStorage.getItem(lastReminderKey) || 0);
            
            if (!backupData) {
                showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯', 'info');
                return;
            }
            
            try {
                const backup = JSON.parse(backupData);
                const backupDate = new Date(backup.backupDate);
                const timeDiff = Date.now() - lastBackupTime;
                const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
                
                let message = `ğŸ“… ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${backupDate.toLocaleString('ar-SA')}\n`;
                message += `â±ï¸ Ù…Ù†Ø°: ${hoursDiff} Ø³Ø§Ø¹Ø©\n`;
                message += `ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù: ${backup.items?.length || 0}\n`;
                message += `ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${backup.customers?.length || 0}\n`;
                message += `ğŸ¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†: ${backup.suppliers?.length || 0}\n`;
                message += `ğŸ’° Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${backup.sales?.length || 0}\n`;
                message += `ğŸ›’ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${backup.purchases?.length || 0}`;
                
                showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', message, 'info');
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
            }
        }
        
        /**
         * ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© ÙƒÙ…Ù„Ù JSON
         */
        function downloadManualBackup() {
            if (!currentActivityId) {
                showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø· Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const backupKey = `diwan_manualBackup_${currentActivityId}`;
            const backupData = localStorage.getItem(backupKey);
            
            if (!backupData) {
                showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø´Ø§Ø·', 'warning');
                return;
            }
            
            try {
                const backup = JSON.parse(backupData);
                const activity = activities.find(a => a.id == currentActivityId);
                const activityName = activity ? activity.name : 'Ø§Ù„Ù†Ø´Ø§Ø·';
                
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ù…Ù„Ù
                const date = new Date();
                const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
                const timeStr = date.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
                const fileName = `Ù†Ø³Ø®Ø©_Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©_ÙŠØ¯ÙˆÙŠØ©_${activityName}_${dateStr}_${timeStr}.json`;
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ JSON Ù…Ù†Ø³Ù‚
                const jsonString = JSON.stringify(backup, null, 2);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Blob ÙˆØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification(
                    'âœ… ØªÙ… Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­',
                    `ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${fileName}`,
                    'success'
                );
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
                showNotification('âŒ ÙØ´Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ±Ù‚ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®ØµÙ… ÙˆØ·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
        async function upgradeSalesData() {
            let dataUpdated = false;
            
            sales.forEach(sale => {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ‡Ø§ Ø­Ù‚Ù„ Ø§Ù„Ø®ØµÙ…ØŒ Ø£Ø¶ÙÙ‡ ÙƒØµÙØ±
                if (sale.discount === undefined) {
                    sale.discount = 0;
                    dataUpdated = true;
                }
                
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ‡Ø§ Ø­Ù‚Ù„ "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…"ØŒ Ø§Ø­Ø³Ø¨Ù‡
                if (sale.afterDiscount === undefined) {
                    sale.afterDiscount = (sale.subtotal || 0) - (sale.discount || 0);
                    dataUpdated = true;
                }
                
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ‡Ø§ Ø­Ù‚Ù„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ØŒ Ø£Ø¶ÙÙ‡ ÙƒÙ€ "ÙƒØ§Ø´"
                if (sale.paymentMethod === undefined) {
                    sale.paymentMethod = 'cash';
                    dataUpdated = true;
                }
            });
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±
            if (dataUpdated) {
                saveToLocalStorage('sales', sales);
                console.log('âœ… ØªÙ… ØªØ±Ù‚ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„ØªØ´Ù…Ù„ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®ØµÙ… ÙˆØ·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹');
            }
        }

        // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… Ù†Ù‚Ù„ ØªØ¹Ø±ÙŠÙ initializeApp Ø¥Ù„Ù‰ Ù…ÙƒØ§Ù† Ù…Ø¨ÙƒØ± ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØª

        // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… Ù†Ù‚Ù„ ØªØ¹Ø±ÙŠÙ initializeApp Ø¥Ù„Ù‰ Ù…ÙƒØ§Ù† Ù…Ø¨ÙƒØ± ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØª

        // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
        function validateSession() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† sessionStorage Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… localStorage
            let loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser') || 'null');
            let isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            let storageType = 'session';
            
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ÙÙŠ sessionStorageØŒ ØªØ­Ù‚Ù‚ Ù…Ù† localStorage
            if (!loggedInUser || !isLoggedIn) {
                loggedInUser = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
                isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                storageType = 'local';
                
                // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª ÙÙŠ localStorageØŒ Ø§Ù†Ø³Ø®Ù‡Ø§ Ø¥Ù„Ù‰ sessionStorage Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø±ÙŠØ¹
                if (loggedInUser && isLoggedIn) {
                    sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                    sessionStorage.setItem('isLoggedIn', 'true');
                }
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø© isLoggedInØŒ Ù‚Ù… Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡Ø§
            if (loggedInUser && !isLoggedIn) {
                if (storageType === 'session') {
                    sessionStorage.setItem('isLoggedIn', 'true');
                } else {
                    localStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('isLoggedIn', 'true');
                }
                return true;
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø¥Ø´Ø§Ø±Ø© isLoggedIn ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù‚Ù… Ø¨Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
            if (isLoggedIn && !loggedInUser) {
                sessionStorage.removeItem('isLoggedIn');
                localStorage.removeItem('isLoggedIn');
                return false;
            }
            
            return isLoggedIn && loggedInUser;
        }
document.addEventListener('DOMContentLoaded', function() {
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            if (window.AUTO_LOGIN_IN_PROGRESS) {
                console.log('ğŸ”’ ØªÙ… ØªØ¬Ø§Ù‡Ù„ DOMContentLoaded Ù„Ø£Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ÙŠØ¯ÙˆÙŠ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©
            const manualLogout = sessionStorage.getItem('manualLogout');
            if (manualLogout) {
                console.log('ğŸš« ØªÙ… Ù…Ù†Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø³Ø¨Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ÙŠØ¯ÙˆÙŠ Ø³Ø§Ø¨Ù‚');
                sessionStorage.removeItem('manualLogout');
                // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                document.getElementById('login-overlay').style.display = 'flex';
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ" Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            const rememberedUser = localStorage.getItem('rememberedUser');
            let autoLoginAttempted = false;
            
            if (rememberedUser) {
                try {
                    const userData = JSON.parse(rememberedUser);
                    const now = new Date().getTime();
                    const dayInMs = 30 * 24 * 60 * 60 * 1000; // 30 ÙŠÙˆÙ…
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (30 ÙŠÙˆÙ…)
                    if (userData.timestamp && (now - userData.timestamp) < dayInMs) {
                        autoLoginAttempted = true;
                        
                        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙˆØ±Ø§Ù‹
                        document.getElementById('login-overlay').style.display = 'none';
                        
                        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ø¹Ø±Ø¶Ù‡Ø§
                        document.getElementById('loginEmail').value = userData.email;
                        document.getElementById('loginPassword').value = userData.password;
                        document.getElementById('rememberMe').checked = true;
                        
                        console.log('ğŸ”„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ"...');
                        
                        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                        setTimeout(() => {
                            handleLogin();
                        }, 100);
                        
                    } else {
                        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
                        console.log('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ" Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©ØŒ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§');
                        localStorage.removeItem('rememberedUser');
                    }
                } catch (e) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ":', e);
                    localStorage.removeItem('rememberedUser');
                }
            }
            
            // ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
            if (!autoLoginAttempted) {
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('justLoggedOut');
                console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©');
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø­ÙÙˆØ¸
            loadSavedLogo();
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø´Ø¹Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø¥Ø®ÙØ§Ø¡Ù‡ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©
            const loginLogo = document.getElementById('loginLogo');
            if (loginLogo) {
                loginLogo.onerror = function() {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø´Ø¹Ø§Ø± ÙÙŠ localStorage Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø®ÙØ§Ø¡
                    const savedLogo = localStorage.getItem('systemLogo');
                    if (!savedLogo) {
                        this.style.display = 'none';
                    }
                };
            }
            
            const hydrateResponsiveTables = () => {
                const tables = document.querySelectorAll('.section table');
                tables.forEach(table => {
                    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
                    if (!headers.length) return;
                    table.querySelectorAll('tbody tr').forEach(row => {
                        Array.from(row.children).forEach((cell, index) => {
                            if (headers[index]) {
                                cell.setAttribute('data-label', headers[index]);
                            } else {
                                cell.removeAttribute('data-label');
                            }
                        });
                    });
                });
            };

            let responsiveTablesTimer;
            const scheduleResponsiveTablesHydration = () => {
                clearTimeout(responsiveTablesTimer);
                responsiveTablesTimer = setTimeout(hydrateResponsiveTables, 100);
            };

            // Ù…Ø¹ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† Ù…ØµØ§Ø¯Ù‚Ø©
            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ØªÙØ­Ù…Ù„ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            console.log("ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");
            
            // Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
            setTimeout(() => {
                const emailField = document.getElementById('loginEmail');
                const passwordField = document.getElementById('loginPassword');
                if (emailField) emailField.value = '';
                if (passwordField) passwordField.value = '';
            }, 100);
            
            if (EMAILJS_FIXED) {
                emailJsConfig = { ...EMAILJS_DEFAULTS };
            } else {
                const storedEmailJsConfig = JSON.parse(localStorage.getItem('diwan_email_config') || 'null') || {};
                emailJsConfig = {
                    serviceID: storedEmailJsConfig.serviceID || EMAILJS_DEFAULTS.serviceID || '',
                    templateID: storedEmailJsConfig.templateID || EMAILJS_DEFAULTS.templateID || '',
                    resetTemplateID: storedEmailJsConfig.resetTemplateID || EMAILJS_DEFAULTS.resetTemplateID || '',
                    publicKey: storedEmailJsConfig.publicKey || EMAILJS_DEFAULTS.publicKey || ''
                };
            }
            if (!('resetTemplateID' in emailJsConfig) || emailJsConfig.resetTemplateID === undefined) {
                emailJsConfig.resetTemplateID = '';
            }
            if (!EMAILJS_FIXED) {
                loadEmailJsSettings();
            }

            loadActivities();
            // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø«Ø§Ø¨ØªØ©
            if (EMAILJS_FIXED) {
                const toggleBtn = document.getElementById('toggleEmailSettingsBtn');
                if (toggleBtn) toggleBtn.style.display = 'none';
            }
            handleResetFlowFromURL();
            
            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            restoreLoginState();
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„
            FilterSortHelper.makeSortable('itemsTable', 'items', renderItems);
            FilterSortHelper.makeSortable('customersTable', 'customers', renderCustomers);
            FilterSortHelper.makeSortable('suppliersTable', 'suppliers', renderSuppliers);
            FilterSortHelper.makeSortable('salesTable', 'sales', renderSalesList);
            FilterSortHelper.makeSortable('purchasesTable', 'purchases', renderPurchasesList);
            
            // Ø±Ø¨Ø· Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±Ø©
            document.getElementById('searchItems')?.addEventListener('input', renderItems);
            document.getElementById('searchCustomers')?.addEventListener('input', renderCustomers);
            document.getElementById('searchSuppliers')?.addEventListener('input', renderSuppliers);
            document.getElementById('searchSales')?.addEventListener('input', searchSales);
            document.getElementById('searchPurchases')?.addEventListener('input', searchPurchases);
            
            document.addEventListener('click', function(event) {
                const cp = document.getElementById('controlPanel'), dt = document.querySelector('.design-toggle');
                if (cp && cp.classList.contains('show') && !cp.contains(event.target) && !dt.contains(event.target)) {
                    cp.classList.remove('show');
                }
            });

            const tableObserverRoot = document.querySelector('.app-container') || document.body;
            const responsiveTableObserver = new MutationObserver(scheduleResponsiveTablesHydration);
            responsiveTableObserver.observe(tableObserverRoot, { childList: true, subtree: true });
            scheduleResponsiveTablesHydration();

            const loginEmailField = document.getElementById('loginEmail');
            const loginPasswordField = document.getElementById('loginPassword');
            const submitOnEnter = (event) => {
                if (event.key === 'Enter') {
                    handleLogin();
                }
            };
            if (loginEmailField) {
                loginEmailField.addEventListener('keyup', submitOnEnter);
            }
            if (loginPasswordField) {
                loginPasswordField.addEventListener('keyup', submitOnEnter);
            }

            const searchInputs = { 'searchItems': searchItems, 'searchCustomers': searchCustomers, 'searchSuppliers': searchSuppliers, 'searchPurchases': searchPurchases, 'searchSales': searchSales, 'searchExpenses': () => {}, 'searchRevenues': () => {}, 'searchSalaries': searchSalaries };
            let searchTimeout;
            Object.keys(searchInputs).forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.onkeyup = () => {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(searchInputs[id], 300);
                    };
                }
            });
            
            // ØªÙ‡ÙŠØ¦Ø© ÙƒØ´ÙˆÙ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
            initializeAccountStatements();
        });
        
        // Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        function restoreLoginState() {

            
    if (window.AUTO_LOGIN_IN_PROGRESS) {
        console.log('ğŸ”„ ØªÙ… ØªØ®Ø·ÙŠ restoreLoginState Ù„Ø£Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„');
        return;
    }
    console.log('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
            console.log('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            createDefaultUser();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø© ÙÙŠ sessionStorage
            const sessionUser = sessionStorage.getItem('loggedInUser');
            const sessionLogin = sessionStorage.getItem('isLoggedIn');
            
            console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©:');
            console.log('sessionLogin:', sessionLogin);
            console.log('sessionUser exists:', !!sessionUser);
            
            let user = null;
            let isLoggedIn = false;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ sessionStorage
            if (sessionLogin === 'true' && sessionUser) {
                try {
                    user = JSON.parse(sessionUser);
                    isLoggedIn = true;
                    console.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ sessionStorage:', user);
                } catch (e) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† sessionStorage:', e);
                }
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡
            if (isLoggedIn && user) {
                console.log('ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©...');
                loadUsers();
                loadActivities();
                
                console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', users.length);
                console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù†Ø´Ø·Ø©:', activities.length);
            }
            
            if (isLoggedIn && user) {
                console.log('ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØµØ­ÙŠØ­ØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©...');
                // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                document.getElementById('login-overlay').style.display = 'none';
                document.querySelector('.app-container').style.display = 'flex';
                
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                updateLoggedInUserDisplay(user);
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„Ù…Ø¯ÙŠØ±
                if (user.role === 'admin') {
                    const savedActivityId = sessionStorage.getItem('currentActivityId');
                    console.log('Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø­ÙÙˆØ¸:', savedActivityId);
                    console.log('Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©:', activities.map(a => `${a.id}: ${a.name}`));
                    
                    if (savedActivityId && activities.find(a => a.id == savedActivityId)) {
                        console.log('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø§Ø·:', savedActivityId);
                        selectActivity(savedActivityId);
                    } else {
                        console.log('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ù…Ø­ÙÙˆØ¸ ØµØ­ÙŠØ­ØŒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ù†Ø´Ø§Ø·');
                        enterAdminWithoutActivity();
                    }
                } else if (user.activityId) {
                    console.log('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', user.activityId);
                    selectActivity(user.activityId);
                }
            } else {
                console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© ØµØ­ÙŠØ­Ø© - Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©:');
                console.log('sessionLogin:', sessionLogin);
                console.log('sessionUser exists:', !!sessionUser);
                console.log('isLoggedIn:', isLoggedIn);
                console.log('user exists:', !!user);
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                document.getElementById('login-overlay').style.display = 'flex';
                document.querySelector('.app-container').style.display = 'none';
            }
        }
        
        // ===== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© =====
        
        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ„ Ø¬Ø¯ÙŠØ¯
        async function addAsset() {
            const name = document.getElementById('assetName').value.trim();
            const type = document.getElementById('assetType').value;
            const purchaseDate = document.getElementById('assetPurchaseDate').value;
            const supplier = document.getElementById('assetSupplier').value.trim();
            const invoiceNumber = document.getElementById('assetInvoiceNumber').value.trim();
            const cost = parseFloat(document.getElementById('assetCost').value);
            const lifespan = parseInt(document.getElementById('assetLifespan').value);
            const salvageValue = parseFloat(document.getElementById('assetSalvageValue').value) || 0;
            const status = document.getElementById('assetStatus').value;
            const notes = document.getElementById('assetNotes').value.trim();

            if (!name || !type || !purchaseDate || !cost || !lifespan) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning');
                return;
            }

            if (cost <= 0 || lifespan <= 0) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±', 'warning');
                return;
            }

            if (salvageValue >= cost) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø±Ø¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡', 'warning');
                return;
            }

            // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            const editingId = document.getElementById('assetForm').getAttribute('data-editing-id');
            
            if (editingId) {
                // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                const assetIndex = assets.findIndex(a => a.id == editingId);
                if (assetIndex !== -1) {
                    const oldCode = assets[assetIndex].code;
                    assets[assetIndex] = {
                        ...assets[assetIndex],
                        name,
                        type,
                        purchaseDate,
                        supplier,
                        invoiceNumber,
                        cost,
                        lifespan,
                        salvageValue,
                        status,
                        notes
                    };
                    
                    try {
                        saveToLocalStorage('assets', assets);
                        showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØµÙ„ "${name}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                        resetAssetForm();
                        displayAssets();
                        updateAssetsStats();
                    } catch (error) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØµÙ„:', error);
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØµÙ„', 'error');
                    }
                }
            } else {
                // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                const asset = {
                    id: Date.now(),
                    code: `ASSET${(assets.length + 1).toString().padStart(3, '0')}`,
                    name,
                    type,
                    purchaseDate,
                    supplier,
                    invoiceNumber,
                    cost,
                    lifespan,
                    salvageValue,
                    status,
                    notes,
                    createdAt: new Date().toISOString()
                };

                assets.push(asset);
                
                try {
                    saveToLocalStorage('assets', assets);
                    showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ„ "${name}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                    resetAssetForm();
                    displayAssets();
                    updateAssetsStats();
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„:', error);
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„', 'error');
                    assets.pop(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸
                }
            }
        }

        // Ø¯Ø§Ù„Ø© ØªÙØ±ÙŠØº Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£ØµÙˆÙ„
        async function clearAssetForm() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            const confirmed = await confirmCancelEdit('#assetForm');
            if (!confirmed) return;
            
            resetAssetForm();
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£ØµÙˆÙ„ (Ø¨Ø¯ÙˆÙ† ØªØ£ÙƒÙŠØ¯)
        function resetAssetForm() {
            document.getElementById('assetName').value = '';
            document.getElementById('assetType').value = '';
            document.getElementById('assetPurchaseDate').value = '';
            document.getElementById('assetSupplier').value = '';
            document.getElementById('assetInvoiceNumber').value = '';
            document.getElementById('assetCost').value = '';
            document.getElementById('assetLifespan').value = '';
            document.getElementById('assetSalvageValue').value = '';
            document.getElementById('assetStatus').value = 'active';
            document.getElementById('assetNotes').value = '';
            
            // Ø­Ø°Ù Ù…Ø¹Ø±Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¥Ù† ÙˆØ¬Ø¯
            document.getElementById('assetForm').removeAttribute('data-editing-id');
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            const formTitle = document.querySelector('#assetForm h3');
            if (formTitle) {
                formTitle.innerHTML = 'Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ„ Ø«Ø§Ø¨Øª Ø¬Ø¯ÙŠØ¯';
                formTitle.style.color = '';
            }
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            const formInputs = document.querySelectorAll('#assetForm input, #assetForm select, #assetForm textarea');
            formInputs.forEach(input => {
                input.classList.remove('editing-mode');
            });
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            const submitBtn = document.querySelector('#assetForm .btn-primary');
            if (submitBtn) {
                submitBtn.innerHTML = 'â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ„';
                submitBtn.classList.remove('update-mode');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ
        function calculateDepreciation(asset) {
            const depreciableValue = asset.cost - asset.salvageValue;
            const annualDepreciation = depreciableValue / asset.lifespan;
            
            const purchaseDate = new Date(asset.purchaseDate);
            const currentDate = new Date();
            const monthsElapsed = (currentDate.getFullYear() - purchaseDate.getFullYear()) * 12 + 
                                (currentDate.getMonth() - purchaseDate.getMonth()) + 
                                (currentDate.getDate() >= purchaseDate.getDate() ? 0 : -1);
            
            const yearsElapsed = Math.max(0, monthsElapsed / 12);
            const accumulatedDepreciation = Math.min(annualDepreciation * yearsElapsed, depreciableValue);
            const bookValue = asset.cost - accumulatedDepreciation;
            
            return {
                annualDepreciation: annualDepreciation,
                accumulatedDepreciation: accumulatedDepreciation,
                bookValue: Math.max(bookValue, asset.salvageValue),
                yearsElapsed: yearsElapsed
            };
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙˆÙ„
        function displayAssets() {
            const assetsList = document.getElementById('assetsList');
            const searchTerm = document.getElementById('searchAssets').value.toLowerCase();
            const typeFilter = document.getElementById('filterAssetType').value;
            const statusFilter = document.getElementById('filterAssetStatus').value;

            let filteredAssets = assets.filter(asset => {
                const matchesSearch = asset.name.toLowerCase().includes(searchTerm) ||
                                    asset.code.toLowerCase().includes(searchTerm) ||
                                    asset.supplier.toLowerCase().includes(searchTerm);
                const matchesType = !typeFilter || asset.type === typeFilter;
                const matchesStatus = !statusFilter || asset.status === statusFilter;
                
                return matchesSearch && matchesType && matchesStatus;
            });

            assetsList.innerHTML = filteredAssets.map(asset => {
                const depreciation = calculateDepreciation(asset);
                const typeIcons = {
                    'computers': 'ğŸ’»',
                    'furniture': 'ğŸª‘',
                    'vehicles': 'ğŸš—',
                    'equipment': 'âš™ï¸',
                    'electronics': 'ğŸ“±',
                    'buildings': 'ğŸ¢',
                    'other': 'ğŸ“¦'
                };
                
                const statusIcons = {
                    'active': 'ğŸŸ¢',
                    'maintenance': 'ğŸŸ¡',
                    'inactive': 'ğŸ”´'
                };

                return `
                    <tr>
                        <td>${asset.code}</td>
                        <td>${asset.name}</td>
                        <td>${typeIcons[asset.type]} ${getAssetTypeLabel(asset.type)}</td>
                        <td>${asset.purchaseDate}</td>
                        <td>${asset.cost.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                        <td>${asset.lifespan} Ø³Ù†ÙˆØ§Øª</td>
                        <td>${depreciation.annualDepreciation.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                        <td>${depreciation.accumulatedDepreciation.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                        <td>${depreciation.bookValue.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                        <td>${statusIcons[asset.status]} ${getAssetStatusLabel(asset.status)}</td>
                        <td style="white-space: nowrap;">
                            <button class="btn-warning" onclick="editAsset(${asset.id})" title="ØªØ¹Ø¯ÙŠÙ„" style="background: #2c5aa0; border-color: #2c5aa0;">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn-danger" onclick="deleteAsset(${asset.id})" title="Ø­Ø°Ù">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ³Ù…ÙŠØ© Ù†ÙˆØ¹ Ø§Ù„Ø£ØµÙ„
        function getAssetTypeLabel(type) {
            const labels = {
                'computers': 'Ø£Ø¬Ù‡Ø²Ø© ÙƒÙ…Ø¨ÙŠÙˆØªØ±',
                'furniture': 'Ø£Ø«Ø§Ø« Ù…ÙƒØªØ¨ÙŠ',
                'vehicles': 'Ø³ÙŠØ§Ø±Ø§Øª ÙˆÙ…Ø±ÙƒØ¨Ø§Øª',
                'equipment': 'Ù…Ø¹Ø¯Ø§Øª ÙˆØ¢Ù„Ø§Øª',
                'electronics': 'Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©',
                'buildings': 'Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ¹Ù‚Ø§Ø±Ø§Øª',
                'other': 'Ø£Ø®Ø±Ù‰'
            };
            return labels[type] || type;
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ³Ù…ÙŠØ© Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„
        function getAssetStatusLabel(status) {
            const labels = {
                'active': 'Ù†Ø´Ø·',
                'maintenance': 'ØªØ­Øª Ø§Ù„ØµÙŠØ§Ù†Ø©',
                'inactive': 'ØºÙŠØ± Ù†Ø´Ø·'
            };
            return labels[status] || status;
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£ØµÙˆÙ„
        function updateAssetsStats() {
            const totalValue = assets.reduce((sum, asset) => sum + asset.cost, 0);
            const totalDepreciation = assets.reduce((sum, asset) => {
                const depreciation = calculateDepreciation(asset);
                return sum + depreciation.accumulatedDepreciation;
            }, 0);
            const netValue = totalValue - totalDepreciation;
            const totalCount = assets.length;

            document.getElementById('totalAssetsValue').textContent = totalValue.toFixed(2);
            document.getElementById('totalDepreciation').textContent = totalDepreciation.toFixed(2);
            document.getElementById('netAssetsValue').textContent = netValue.toFixed(2);
            document.getElementById('totalAssetsCount').textContent = totalCount;
            document.getElementById('miniStatAssets').textContent = netValue.toFixed(2);
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø£ØµÙ„
        async function deleteAsset(assetId) {
            const asset = assets.find(a => a.id === assetId);
            if (!asset) return;

            const confirmed = await showConfirmDialog({
                title: 'ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø£ØµÙ„',
                message: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø£ØµÙ„ "${asset.name}"ØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.`,
                type: 'danger',
                icon: 'âš ï¸',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡',
                confirmButtonClass: 'danger'
            });

            if (confirmed) {
                const index = assets.findIndex(a => a.id === assetId);
                assets.splice(index, 1);
                
                try {
                    saveToLocalStorage('assets', assets);
                    showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£ØµÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    displayAssets();
                    updateAssetsStats();
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø£ØµÙ„:', error);
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø£ØµÙ„', 'error');
                }
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø£ØµÙ„ (Ù…Ø¨Ø³Ø·Ø©)
        function editAsset(assetId) {
            const asset = assets.find(a => a.id === assetId);
            if (!asset) return;

            // Ù…Ù„Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
            document.getElementById('assetName').value = asset.name;
            document.getElementById('assetType').value = asset.type;
            document.getElementById('assetPurchaseDate').value = asset.purchaseDate;
            document.getElementById('assetSupplier').value = asset.supplier;
            document.getElementById('assetInvoiceNumber').value = asset.invoiceNumber;
            document.getElementById('assetCost').value = asset.cost;
            document.getElementById('assetLifespan').value = asset.lifespan;
            document.getElementById('assetSalvageValue').value = asset.salvageValue;
            document.getElementById('assetStatus').value = asset.status;
            document.getElementById('assetNotes').value = asset.notes;

            // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ø£ØµÙ„ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡
            document.getElementById('assetForm').setAttribute('data-editing-id', assetId);
            
            // ØªØºÙŠÙŠØ± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            const formTitle = document.querySelector('#assetForm h3');
            if (formTitle) {
                formTitle.innerHTML = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ØµÙ„: ' + asset.name;
                formTitle.style.color = '#28a745';
            }
            
            // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ù„Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            const formInputs = document.querySelectorAll('#assetForm input, #assetForm select, #assetForm textarea');
            formInputs.forEach(input => {
                input.classList.add('editing-mode');
            });
            
            // ØªØºÙŠÙŠØ± Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
            const submitBtn = document.querySelector('#assetForm .btn-primary');
            if (submitBtn) {
                submitBtn.innerHTML = 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØµÙ„';
                submitBtn.classList.add('update-mode');
            }
            
            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
            document.getElementById('assetForm').scrollIntoView({ behavior: 'smooth' });
            
            // Ù†Ù‚Ù„ Ø§Ù„Ù…Ø¤Ø´Ø± Ù„Ù„Ø­Ù‚Ù„ Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
            setTimeout(() => {
                document.getElementById('assetName').focus();
                document.getElementById('assetName').select();
            }, 500);
        }

        // ===== Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© =====
        
        // ===== Ø¯ÙˆØ§Ù„ Ø·Ø¨Ø§Ø¹Ø© ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„ =====
        
        // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„ Ø¥Ù„Ù‰ Excel
        function exportAssetsToExcel() {
console.log('ğŸ” Reached exportAssetsToExcel function...');
            try {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
                const filteredAssets = getFilteredAssets();
                
                if (filteredAssets.length === 0) {
                    showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆÙ„ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§', 'warning');
                    return;
                }

                // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Excel
                const worksheetData = [];
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                worksheetData.push(['ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ©']);
                worksheetData.push(['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + new Date().toLocaleDateString('ar-SA')]);
                worksheetData.push(['']); // Ø³Ø·Ø± ÙØ§Ø±Øº
                
                // Ø¥Ø¶Ø§ÙØ© Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                worksheetData.push([
                    'ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„',
                    'Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„', 
                    'Ø§Ù„Ù†ÙˆØ¹',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡',
                    'Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ø±ÙŠØ§Ù„)',
                    'Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ (Ø³Ù†ÙˆØ§Øª)',
                    'Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ Ø§Ù„Ø³Ù†ÙˆÙŠ (Ø±ÙŠØ§Ù„)',
                    'Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ (Ø±ÙŠØ§Ù„)',
                    'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØªØ±ÙŠØ© (Ø±ÙŠØ§Ù„)',
                    'Ø§Ù„Ø­Ø§Ù„Ø©',
                    'Ø§Ù„Ù…ÙˆØ±Ø¯',
                    'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª'
                ]);
                
                // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙˆÙ„
                filteredAssets.forEach(asset => {
                    const depreciation = calculateDepreciation(asset);
                    worksheetData.push([
                        asset.code,
                        asset.name,
                        getAssetTypeLabel(asset.type),
                        asset.purchaseDate,
                        asset.cost.toFixed(2),
                        asset.lifespan,
                        depreciation.annualDepreciation.toFixed(2),
                        depreciation.accumulatedDepreciation.toFixed(2),
                        depreciation.bookValue.toFixed(2),
                        getAssetStatusLabel(asset.status),
                        asset.supplier || '',
                        asset.invoiceNumber || '',
                        asset.notes || ''
                    ]);
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± ÙØ§Ø±Øº
                worksheetData.push(['']);
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const totalValue = filteredAssets.reduce((sum, asset) => sum + asset.cost, 0);
                const totalDepreciation = filteredAssets.reduce((sum, asset) => {
                    const depreciation = calculateDepreciation(asset);
                    return sum + depreciation.accumulatedDepreciation;
                }, 0);
                const netValue = totalValue - totalDepreciation;
                
                worksheetData.push(['Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:']);
                worksheetData.push(['Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆÙ„:', filteredAssets.length]);
                worksheetData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙˆÙ„:', totalValue.toFixed(2) + ' Ø±ÙŠØ§Ù„']);
                worksheetData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ:', totalDepreciation.toFixed(2) + ' Ø±ÙŠØ§Ù„']);
                worksheetData.push(['ØµØ§ÙÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙˆÙ„:', netValue.toFixed(2) + ' Ø±ÙŠØ§Ù„']);

                // Ø¥Ù†Ø´Ø§Ø¡ workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(worksheetData);
                
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶
                ws['!cols'] = [
                    { width: 12 }, // ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„
                    { width: 25 }, // Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„
                    { width: 18 }, // Ø§Ù„Ù†ÙˆØ¹
                    { width: 15 }, // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡
                    { width: 18 }, // Ø§Ù„ØªÙƒÙ„ÙØ©
                    { width: 18 }, // Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ
                    { width: 18 }, // Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ Ø§Ù„Ø³Ù†ÙˆÙŠ
                    { width: 18 }, // Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ
                    { width: 18 }, // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØªØ±ÙŠØ©
                    { width: 15 }, // Ø§Ù„Ø­Ø§Ù„Ø©
                    { width: 20 }, // Ø§Ù„Ù…ÙˆØ±Ø¯
                    { width: 15 }, // Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                    { width: 30 }  // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                ];

                XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ©");
                
                // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù
                const fileName = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø£ØµÙˆÙ„_Ø§Ù„Ø«Ø§Ø¨ØªØ©_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', `ØªÙ… ØªØµØ¯ÙŠØ± ${filteredAssets.length} Ø£ØµÙ„ Ø¥Ù„Ù‰ Excel Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Excel:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Excel', 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„
        function printAssetsReport() {
            try {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
                const filteredAssets = getFilteredAssets();
                
                if (filteredAssets.length === 0) {
                    showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'warning');
                    return;
                }

                // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
                let printHTML = `
                    <html dir="rtl">
                    <head>
                        <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ©</title>
                        <style>
                            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .header h1 { color: #2c5aa0; margin-bottom: 10px; }
                            .header p { color: #666; margin: 5px 0; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                            th { background-color: #2c5aa0; color: white; font-weight: bold; }
                            tr:nth-child(even) { background-color: #f9f9f9; }
                            .summary { background-color: #f0f7ff; padding: 15px; border-radius: 5px; margin-top: 20px; }
                            .summary h3 { color: #2c5aa0; margin-bottom: 10px; }
                            .summary-item { margin: 5px 0; }
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>ğŸ¢ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ©</h1>
                            <p>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleDateString('ar-SA')}</p>
                            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆÙ„: ${filteredAssets.length}</p>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„</th>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„</th>
                                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                                    <th>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
                                    <th>Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ</th>
                                    <th>Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ Ø§Ù„Ø³Ù†ÙˆÙŠ</th>
                                    <th>Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ</th>
                                    <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØªØ±ÙŠØ©</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙˆÙ„
                filteredAssets.forEach(asset => {
                    const depreciation = calculateDepreciation(asset);
                    const statusIcons = {
                        'active': 'ğŸŸ¢',
                        'maintenance': 'ğŸŸ¡',
                        'inactive': 'ğŸ”´'
                    };
                    
                    printHTML += `
                        <tr>
                            <td>${asset.code}</td>
                            <td>${asset.name}</td>
                            <td>${getAssetTypeLabel(asset.type)}</td>
                            <td>${asset.purchaseDate}</td>
                            <td>${asset.cost.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${asset.lifespan} Ø³Ù†ÙˆØ§Øª</td>
                            <td>${depreciation.annualDepreciation.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${depreciation.accumulatedDepreciation.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${depreciation.bookValue.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${statusIcons[asset.status]} ${getAssetStatusLabel(asset.status)}</td>
                        </tr>
                    `;
                });

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const totalValue = filteredAssets.reduce((sum, asset) => sum + asset.cost, 0);
                const totalDepreciation = filteredAssets.reduce((sum, asset) => {
                    const depreciation = calculateDepreciation(asset);
                    return sum + depreciation.accumulatedDepreciation;
                }, 0);
                const netValue = totalValue - totalDepreciation;

                printHTML += `
                            </tbody>
                        </table>
                        
                        <div class="summary">
                            <h3>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
                            <div class="summary-item"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆÙ„:</strong> ${filteredAssets.length} Ø£ØµÙ„</div>
                            <div class="summary-item"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙˆÙ„:</strong> ${totalValue.toFixed(2)} Ø±ÙŠØ§Ù„</div>
                            <div class="summary-item"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ:</strong> ${totalDepreciation.toFixed(2)} Ø±ÙŠØ§Ù„</div>
                            <div class="summary-item"><strong>ØµØ§ÙÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙˆÙ„:</strong> ${netValue.toFixed(2)} Ø±ÙŠØ§Ù„</div>
                        </div>
                    </body>
                    </html>
                `;

                // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printHTML);
                printWindow.document.close();
                
                // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø«Ù… Ø·Ø¨Ø§Ø¹Ø©
                printWindow.onload = function() {
                    printWindow.print();
                };
                
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²', 'ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
        function getFilteredAssets() {
            const searchTerm = document.getElementById('searchAssets').value.toLowerCase();
            const typeFilter = document.getElementById('filterAssetType').value;
            const statusFilter = document.getElementById('filterAssetStatus').value;

            return assets.filter(asset => {
                const matchesSearch = asset.name.toLowerCase().includes(searchTerm) ||
                                    asset.code.toLowerCase().includes(searchTerm) ||
                                    asset.supplier.toLowerCase().includes(searchTerm);
                const matchesType = !typeFilter || asset.type === typeFilter;
                const matchesStatus = !statusFilter || asset.status === statusFilter;
                
                return matchesSearch && matchesType && matchesStatus;
            });
        }
        
        // ===== Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø·Ø¨Ø§Ø¹Ø© ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„ =====
        
        // ===== Ø¯ÙˆØ§Ù„ Ø·Ø¨Ø§Ø¹Ø© ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨ =====
        
        // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø¥Ù„Ù‰ Excel
        function exportSalariesToExcel() {
            try {
                // Ø¥Ø¶Ø§ÙØ© ØªØ´Ø®ÙŠØµ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                console.log('ğŸ” ØªØ´Ø®ÙŠØµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:');
                console.log('Ù…ØªØºÙŠØ± salaries:', salaries);
                console.log('Ø·ÙˆÙ„ Ù…ØµÙÙˆÙØ© salaries:', salaries ? salaries.length : 'ØºÙŠØ± Ù…Ø¹Ø±Ù');
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
                const filteredSalaries = getSalariesForExport();
                console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©:', filteredSalaries);
                console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©:', filteredSalaries.length);
                
                if (filteredSalaries.length === 0) {
                    showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙŠØ±Ø§Øª Ø±ÙˆØ§ØªØ¨ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§. Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${salaries ? salaries.length : 0}`, 'warning');
                    return;
                }

                // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Excel
                const worksheetData = [];
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                worksheetData.push(['ØªÙ‚Ø±ÙŠØ± Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨']);
                worksheetData.push(['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + new Date().toLocaleDateString('ar-SA')]);
                worksheetData.push(['']); // Ø³Ø·Ø± ÙØ§Ø±Øº
                
                // Ø¥Ø¶Ø§ÙØ© Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                worksheetData.push([
                    'Ø§Ù„Ù…ÙˆØ¸Ù',
                    'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©',
                    'Ø§Ù„Ø¬Ù†Ø³ÙŠØ©',
                    'Ø§Ù„Ø´Ù‡Ø±',
                    'Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ',
                    'Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ø±ÙŠØ§Ù„)',
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª (Ø±ÙŠØ§Ù„)',
                    'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø±ÙŠØ§Ù„)',
                    'Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ GOSI (Ø±ÙŠØ§Ù„)',
                    'Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰ (Ø±ÙŠØ§Ù„)',
                    'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨ (Ø±ÙŠØ§Ù„)',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©'
                ]);
                
                // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨
                filteredSalaries.forEach(salary => {
                    worksheetData.push([
                        salary.employeeName || '',
                        salary.nationalId || '',
                        salary.nationality || '',
                        salary.month || '',
                        salary.jobTitle || '',
                        (salary.basicSalary || 0).toFixed(2),
                        (salary.totalAllowances || 0).toFixed(2),
                        (salary.grossSalary || 0).toFixed(2),
                        (salary.gosiDeduction || 0).toFixed(2),
                        (salary.otherDeductions || 0).toFixed(2),
                        (salary.netSalary || 0).toFixed(2),
                        new Date(salary.createdAt || Date.now()).toLocaleDateString('ar-SA')
                    ]);
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± ÙØ§Ø±Øº
                worksheetData.push(['']);
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const totalBasicSalary = filteredSalaries.reduce((sum, salary) => sum + (salary.basicSalary || 0), 0);
                const totalAllowances = filteredSalaries.reduce((sum, salary) => sum + (salary.totalAllowances || 0), 0);
                const totalGrossSalary = filteredSalaries.reduce((sum, salary) => sum + (salary.grossSalary || 0), 0);
                const totalGosiDeduction = filteredSalaries.reduce((sum, salary) => sum + (salary.gosiDeduction || 0), 0);
                const totalOtherDeductions = filteredSalaries.reduce((sum, salary) => sum + (salary.otherDeductions || 0), 0);
                const totalNetSalary = filteredSalaries.reduce((sum, salary) => sum + (salary.netSalary || 0), 0);
                
                worksheetData.push(['Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:']);
                worksheetData.push(['Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:', filteredSalaries.length]);
                worksheetData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:', totalBasicSalary.toFixed(2) + ' Ø±ÙŠØ§Ù„']);
                worksheetData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª:', totalAllowances.toFixed(2) + ' Ø±ÙŠØ§Ù„']);
                worksheetData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨:', totalGrossSalary.toFixed(2) + ' Ø±ÙŠØ§Ù„']);
                worksheetData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª GOSI:', totalGosiDeduction.toFixed(2) + ' Ø±ÙŠØ§Ù„']);
                worksheetData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰:', totalOtherDeductions.toFixed(2) + ' Ø±ÙŠØ§Ù„']);
                worksheetData.push(['ØµØ§ÙÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨:', totalNetSalary.toFixed(2) + ' Ø±ÙŠØ§Ù„']);

                // Ø¥Ù†Ø´Ø§Ø¡ workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(worksheetData);
                
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶
                ws['!cols'] = [
                    { width: 20 }, // Ø§Ù„Ù…ÙˆØ¸Ù
                    { width: 18 }, // Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
                    { width: 15 }, // Ø§Ù„Ø¬Ù†Ø³ÙŠØ©
                    { width: 12 }, // Ø§Ù„Ø´Ù‡Ø±
                    { width: 20 }, // Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
                    { width: 18 }, // Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                    { width: 18 }, // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª
                    { width: 15 }, // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                    { width: 18 }, // Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ GOSI
                    { width: 18 }, // Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰
                    { width: 18 }, // ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨
                    { width: 15 }  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                ];

                XLSX.utils.book_append_sheet(wb, ws, "Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨");
                
                // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù
                const fileName = `ØªÙ‚Ø±ÙŠØ±_Ù…Ø³ÙŠØ±Ø§Øª_Ø§Ù„Ø±ÙˆØ§ØªØ¨_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', `ØªÙ… ØªØµØ¯ÙŠØ± ${filteredSalaries.length} Ù…Ø³ÙŠØ±Ø© Ø±Ø§ØªØ¨ Ø¥Ù„Ù‰ Excel Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Excel:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Excel', 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨
        function printSalariesReport() {
            try {
                // Ø¥Ø¶Ø§ÙØ© ØªØ´Ø®ÙŠØµ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                console.log('ğŸ–¨ï¸ ØªØ´Ø®ÙŠØµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:');
                console.log('Ù…ØªØºÙŠØ± salaries:', salaries);
                console.log('Ø·ÙˆÙ„ Ù…ØµÙÙˆÙØ© salaries:', salaries ? salaries.length : 'ØºÙŠØ± Ù…Ø¹Ø±Ù');
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
                const filteredSalaries = getSalariesForExport();
                console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©:', filteredSalaries);
                console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©:', filteredSalaries.length);
                
                if (filteredSalaries.length === 0) {
                    showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙŠØ±Ø§Øª Ø±ÙˆØ§ØªØ¨ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©. Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${salaries ? salaries.length : 0}`, 'warning');
                    return;
                }

                // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
                let printHTML = `
                    <html dir="rtl">
                    <head>
                        <title>ØªÙ‚Ø±ÙŠØ± Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨</title>
                        <style>
                            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .header h1 { color: #2c5aa0; margin-bottom: 10px; }
                            .header p { color: #666; margin: 5px 0; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px; }
                            th, td { border: 1px solid #ddd; padding: 6px; text-align: right; }
                            th { background-color: #2c5aa0; color: white; font-weight: bold; }
                            tr:nth-child(even) { background-color: #f9f9f9; }
                            .summary { background-color: #f0f7ff; padding: 15px; border-radius: 5px; margin-top: 20px; }
                            .summary h3 { color: #2c5aa0; margin-bottom: 10px; }
                            .summary-item { margin: 5px 0; }
                            .net-salary { font-weight: bold; color: #28a745; }
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>ğŸ’¼ ØªÙ‚Ø±ÙŠØ± Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨</h1>
                            <p>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleDateString('ar-SA')}</p>
                            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ${filteredSalaries.length}</p>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                                    <th>Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</th>
                                    <th>Ø§Ù„Ø´Ù‡Ø±</th>
                                    <th>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                                    <th>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
                                    <th>Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                    <th>GOSI</th>
                                    <th>Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰</th>
                                    <th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨
                filteredSalaries.forEach(salary => {
                    printHTML += `
                        <tr>
                            <td>${salary.employeeName || ''}</td>
                            <td>${salary.nationalId || ''}</td>
                            <td>${salary.nationality || ''}</td>
                            <td>${salary.month || ''}</td>
                            <td>${salary.jobTitle || ''}</td>
                            <td>${(salary.basicSalary || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${(salary.totalAllowances || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${(salary.grossSalary || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${(salary.gosiDeduction || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${(salary.otherDeductions || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td class="net-salary">${(salary.netSalary || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                        </tr>
                    `;
                });

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const totalBasicSalary = filteredSalaries.reduce((sum, salary) => sum + (salary.basicSalary || 0), 0);
                const totalAllowances = filteredSalaries.reduce((sum, salary) => sum + (salary.totalAllowances || 0), 0);
                const totalGrossSalary = filteredSalaries.reduce((sum, salary) => sum + (salary.grossSalary || 0), 0);
                const totalGosiDeduction = filteredSalaries.reduce((sum, salary) => sum + (salary.gosiDeduction || 0), 0);
                const totalOtherDeductions = filteredSalaries.reduce((sum, salary) => sum + (salary.otherDeductions || 0), 0);
                const totalNetSalary = filteredSalaries.reduce((sum, salary) => sum + (salary.netSalary || 0), 0);

                printHTML += `
                            </tbody>
                        </table>
                        
                        <div class="summary">
                            <h3 style="text-align: center; color: #2c5aa0; margin-bottom: 20px; border-bottom: 2px solid #2c5aa0; padding-bottom: 10px;">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
                            
                            <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ù†Ø¸Ù… -->
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px; background: #f8f9fa;">
                                <tbody>
                                    <tr style="background: #e3f2fd;">
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; font-weight: bold; background: #2c5aa0; color: white; width: 30%;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; text-align: center; font-weight: bold; color: #2c5aa0;">${filteredSalaries.length} Ù…ÙˆØ¸Ù</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; font-weight: bold; background: #2c5aa0; color: white; width: 30%;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; text-align: center; font-weight: bold; color: #27ae60;">${totalBasicSalary.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; font-weight: bold; background: #2c5aa0; color: white;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; text-align: center; font-weight: bold; color: #f39c12;">${totalAllowances.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; font-weight: bold; background: #2c5aa0; color: white;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; text-align: center; font-weight: bold; color: #9b59b6;">${totalGrossSalary.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                                    </tr>
                                    <tr style="background: #ffebee;">
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; font-weight: bold; background: #2c5aa0; color: white;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª GOSI</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; text-align: center; font-weight: bold; color: #e74c3c;">${totalGosiDeduction.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; font-weight: bold; background: #2c5aa0; color: white;">Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; text-align: center; font-weight: bold; color: #8e44ad;">${totalOtherDeductions.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- ØµØ§ÙÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙÙŠ Ù…Ø±Ø¨Ø¹ Ù…Ù…ÙŠØ² -->
                            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #e8f5e8, #f0fff0); border: 3px solid #2ecc71; border-radius: 10px; text-align: center; box-shadow: 0 4px 8px rgba(46, 204, 113, 0.2);">
                                <h2 style="margin: 0; color: #2ecc71; font-size: 1.8em;">ğŸ’¼ ØµØ§ÙÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h2>
                                <div style="font-size: 2.2em; font-weight: bold; color: #27ae60; margin-top: 10px;">${totalNetSalary.toFixed(2)} Ø±ÙŠØ§Ù„</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
                            </div>
                        </div>
                    </body>
                    </html>
                `;

                // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printHTML);
                printWindow.document.close();
                
                // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø«Ù… Ø·Ø¨Ø§Ø¹Ø©
                printWindow.onload = function() {
                    printWindow.print();
                };
                
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²', 'ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
        function getFilteredSalaries() {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ØªØºÙŠØ± ÙˆØ£Ù†Ù‡ Ù…ØµÙÙˆÙØ©
            if (!salaries || !Array.isArray(salaries)) {
                console.warn('Ù…ØµÙÙˆÙØ© Ø§Ù„Ø±ÙˆØ§ØªØ¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ ÙØ§Ø±ØºØ©:', salaries);
                return [];
            }
            
            const searchElement = document.getElementById('searchSalaries');
            const searchTerm = searchElement ? searchElement.value.toLowerCase() : '';

            return salaries.filter(salary => {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¨Ø­Ø«ØŒ Ø£Ø±Ø¬Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (!searchTerm) return true;
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ù‚Ø¨Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§
                const matchesSearch = (salary.employeeName || '').toLowerCase().includes(searchTerm) ||
                                    (salary.nationalId || '').toLowerCase().includes(searchTerm) ||
                                    (salary.nationality || '').toLowerCase().includes(searchTerm) ||
                                    (salary.month || '').toLowerCase().includes(searchTerm) ||
                                    (salary.jobTitle || '').toLowerCase().includes(searchTerm);
                
                return matchesSearch;
            });
        }

        // Ø¯Ø§Ù„Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§ØªØ¨ (ØªØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ renderSalaries)
        function getSalariesForExport() {
            if (!salaries || !Array.isArray(salaries)) {
                console.warn('Ù…ØµÙÙˆÙØ© Ø§Ù„Ø±ÙˆØ§ØªØ¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                return [];
            }

            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶
            return salaries.map(salary => {
                const allowances = typeof salary.allowancesTotal === 'number'
                    ? salary.allowancesTotal
                    : (salary.housing || 0) + (salary.transport || 0) + (salary.otherAllowances || 0) + (salary.overtime || 0);
                
                const gross = typeof salary.gross === 'number' ? salary.gross : (salary.basic || 0) + allowances;
                const gosiEmployee = salary.gosiEmployee || 0;
                const otherDeductions = salary.otherDeductions || 0;
                const net = typeof salary.net === 'number' ? salary.net : gross - gosiEmployee - otherDeductions;

                return {
                    employeeName: salary.employeeName || '',
                    nationalId: salary.nationalId || '',
                    nationality: salary.nationality || '',
                    month: salary.month || '',
                    jobTitle: salary.jobTitle || '',
                    basicSalary: salary.basic || 0,
                    totalAllowances: allowances,
                    grossSalary: gross,
                    gosiDeduction: gosiEmployee,
                    otherDeductions: otherDeductions,
                    netSalary: net,
                    createdAt: salary.createdAt || Date.now()
                };
            });
        }
        
        // ===== Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø·Ø¨Ø§Ø¹Ø© ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨ =====
        
        // Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© ÙƒØ´ÙˆÙ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        function initializeAccountStatements() {
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const today = new Date().toISOString().split('T')[0];
            const statementFromInput = document.getElementById('statementFrom');
            const statementToInput = document.getElementById('statementTo');
            
            if (statementFromInput) statementFromInput.value = today;
            if (statementToInput) statementToInput.value = today;
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            const statementTypeSelect = document.getElementById('statementType');
            if (statementTypeSelect) {
                statementTypeSelect.value = '';
                // Ù„Ø§ Ù†Ø³ØªØ¯Ø¹ÙŠ changeStatementType() Ù„ØªØ±ÙƒÙ‡ ÙØ§Ø±Øº
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙÙ„Ø§ØªØ±
            populateSpecificSupplierFilter();
            populateSpecificCustomerFilter();
            populateSpecificEmployeeFilter();
        }

        // ===== Password Management =====
        function openChangePasswordModal() {
            const isLogged = sessionStorage.getItem('isLoggedIn') === 'true';
            if (!isLogged) { alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.'); return; }
            const oldEl = document.getElementById('cp-old');
            const newEl = document.getElementById('cp-new');
            const confEl = document.getElementById('cp-confirm');
            if (!oldEl || !newEl || !confEl) return;
            oldEl.value = '';
            newEl.value = '';
            confEl.value = '';
            document.getElementById('change-password-overlay').style.display = 'flex';
        }
        function closeChangePasswordModal() {
            const overlay = document.getElementById('change-password-overlay');
            if (overlay) overlay.style.display = 'none';
        }
        async function submitPasswordChange() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser) { alert('ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„.'); return; }
            const oldP = document.getElementById('cp-old').value;
            const newP = document.getElementById('cp-new').value;
            const confP = document.getElementById('cp-confirm').value;
            if (!oldP || !newP || !confP) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.'); return; }
            if (newP.length < 6) { alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù/Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.'); return; }
            if (newP !== confP) { alert('ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚.'); return; }
            const idx = users.findIndex(u => String(u.id) === String(loggedInUser.id));
            if (idx === -1) { alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.'); return; }
            if (users[idx].password !== oldP) { alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.'); return; }
            users[idx].password = newP;
            await saveUsers();
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©
            loggedInUser.password = newP;
            sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
            updateLoggedInUserDisplay(loggedInUser);
            closeChangePasswordModal();
            alert('âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.');
        }

        function openForgotPasswordModal() {
            const emailEl = document.getElementById('fp-email');
            if (emailEl) emailEl.value = '';
            document.getElementById('forgot-password-overlay').style.display = 'flex';
        }
        function closeForgotPasswordModal() {
            const overlay = document.getElementById('forgot-password-overlay');
            if (overlay) overlay.style.display = 'none';
        }
        function requestPasswordReset() {
            const email = document.getElementById('fp-email').value.trim();
            if (!email) { 
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.'); 
                return; 
            }
            
            const user = users.find(u => u.email === email);
            if (!user) { 
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯.'); 
                return; 
            }
            
            // Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠØŒ Ù†Ù†Ø¨Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
            alert(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ.\nÙ„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù….\nØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³Ø¬Ù„: ${email}`);
            closeForgotPasswordModal();
        }
        // Ø¯ÙˆØ§Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù…Ø¨Ø³Ø·Ø© Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ)
        function openResetPasswordModal(token) {
            // ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠØŒ Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
            alert('Ù…ÙŠØ²Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ.\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.');
        }
        
        function closeResetPasswordModal() {
            const overlay = document.getElementById('reset-password-overlay');
            if (overlay) overlay.style.display = 'none';
            activeResetToken = null;
        }
        
        // Ø¯Ø§Ù„Ø© Ù…Ø¨Ø³Ø·Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© (Ù„Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§ÙÙ‚)
        function handleResetFlowFromURL() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('resetToken');
            if (token) {
                alert('Ù…ÙŠØ²Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ.\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù….');
            }
        }

// Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
function getStoredData(key) {
    try {
        // Ø¬Ø±Ø¨ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        const activityKey = currentActivityId ? `activity_${currentActivityId}_${key}` : key;
        
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:`, {
            key,
            currentActivityId,
            activityKey,
            keysInStorage: Object.keys(localStorage).filter(k => k.includes(key))
        });
        
        const data = localStorage.getItem(activityKey);
        if (data) {
            const parsed = JSON.parse(data);
            console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${key}:`, parsed.length, 'Ø¹Ù†ØµØ±');
            return parsed;
        }
        
        // Ø¬Ø±Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨Ø³ÙŠØ·
        const simpleData = localStorage.getItem(key);
        if (simpleData) {
            const parsed = JSON.parse(simpleData);
            console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${key} (Ù…ÙØªØ§Ø­ Ø¨Ø³ÙŠØ·):`, parsed.length, 'Ø¹Ù†ØµØ±');
            return parsed;
        }
        
        console.log(`âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${key}`);
        return null;
    } catch (error) {
        console.error(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ${key}:`, error);
        return null;
    }
}

// Ø¯ÙˆØ§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø«
function initAdvancedDashboard() {
    console.log('ğŸ“Š Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©');
    console.log('ğŸ“ˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:', {
        salesCount: sales.length,
        purchasesCount: purchases.length,
        expensesCount: expenses.length
    });
    
    updateLiveStats();
    updatePerformanceIndicators();
    
    // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
    window.dashboardRefreshInterval = setInterval(() => {
        updateLiveStats();
    }, 5000);
}

function updateLiveStats() {
    const today = new Date().toISOString().split('T')[0];
    const currentMonth = new Date().toISOString().substring(0, 7);
    
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:');
    console.log(`ğŸ“… Ø§Ù„ÙŠÙˆÙ…: ${today}, Ø§Ù„Ø´Ù‡Ø±: ${currentMonth}`);
    console.log(`ğŸ¯ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentActivityId}`);
    console.log(`ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„:`, {
        salesType: typeof sales,
        salesLength: sales ? sales.length : 'null',
        purchasesType: typeof purchases,
        purchasesLength: purchases ? purchases.length : 'null'
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ø£Ùˆ localStorage Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ø­Ù…Ù„Ø©
    async function reloadDataIfNeeded() {
        if (USE_FIREBASE && currentActivityId) {
            if (!sales || sales.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø­Ù…Ù„Ø© - Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase');
                const firebaseSales = await firebaseGetActivityData(currentActivityId, 'sales') || [];
                window.sales = sales = firebaseSales;
                console.log(`âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ${firebaseSales.length} Ù…Ø¨ÙŠØ¹Ø© Ù…Ù† Firebase`);
            }
            
            if (!purchases || purchases.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ø­Ù…Ù„Ø© - Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase');
                const firebasePurchases = await firebaseGetActivityData(currentActivityId, 'purchases') || [];
                window.purchases = purchases = firebasePurchases;
                console.log(`âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ${firebasePurchases.length} Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ù† Firebase`);
            }
            
            if (!expenses || expenses.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø­Ù…Ù„Ø© - Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase');
                const firebaseExpenses = await firebaseGetActivityData(currentActivityId, 'expenses') || [];
                window.expenses = expenses = firebaseExpenses;
                console.log(`âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ${firebaseExpenses.length} Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù† Firebase`);
            }
            
            if (!revenues || revenues.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…Ø­Ù…Ù„Ø© - Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase');
                const firebaseRevenues = await firebaseGetActivityData(currentActivityId, 'revenues') || [];
                window.revenues = revenues = firebaseRevenues;
                console.log(`âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ${firebaseRevenues.length} Ø¥ÙŠØ±Ø§Ø¯Ø© Ù…Ù† Firebase`);
            }
        } else {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage ÙƒØ­Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            if (!sales || sales.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø­Ù…Ù„Ø© - Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage');
                const storedSales = getStoredData('sales');
                if (storedSales && storedSales.length > 0) {
                    window.sales = sales = storedSales;
                    console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${storedSales.length} Ù…Ø¨ÙŠØ¹Ø© Ù…Ù† localStorage`);
                }
            }
            
            if (!purchases || purchases.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ø­Ù…Ù„Ø© - Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage');
                const storedPurchases = getStoredData('purchases');
                if (storedPurchases && storedPurchases.length > 0) {
                    window.purchases = purchases = storedPurchases;
                    console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${storedPurchases.length} Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ù† localStorage`);
                }
            }
            
            if (!expenses || expenses.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø­Ù…Ù„Ø© - Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage');
                const storedExpenses = getStoredData('expenses');
                if (storedExpenses && storedExpenses.length > 0) {
                    window.expenses = expenses = storedExpenses;
                    console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${storedExpenses.length} Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù† localStorage`);
                }
            }
            
            if (!revenues || revenues.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…Ø­Ù…Ù„Ø© - Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage');
                const storedRevenues = getStoredData('revenues');
                if (storedRevenues && storedRevenues.length > 0) {
                    window.revenues = revenues = storedRevenues;
                    console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${storedRevenues.length} Ø¥ÙŠØ±Ø§Ø¯Ø© Ù…Ù† localStorage`);
                }
            }
        }
    }
    
    // ØªÙ†ÙÙŠØ° Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± Ø«Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    reloadDataIfNeeded().then(() => {
        console.log(`ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„:`, { 
            sales: sales ? sales.length : 'null', 
            purchases: purchases ? purchases.length : 'null',
            expenses: expenses ? expenses.length : 'null',
            revenues: revenues ? revenues.length : 'null'
        });
        
        // ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!sales) {
            console.error('âŒ sales ØºÙŠØ± Ù…Ø¹Ø±Ù!');
            window.sales = sales = [];
        }
        if (!purchases) {
            console.error('âŒ purchases ØºÙŠØ± Ù…Ø¹Ø±Ù!');
            window.purchases = purchases = [];
        }
        if (!expenses) {
            console.error('âŒ expenses ØºÙŠØ± Ù…Ø¹Ø±Ù!');
            window.expenses = expenses = [];
        }
        if (!revenues) {
            console.error('âŒ revenues ØºÙŠØ± Ù…Ø¹Ø±Ù!');
            window.revenues = revenues = [];
        }
    
    // ğŸ’° Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…
    const todaySalesAmount = (sales && sales.length > 0) ? sales.filter(s => s.date === today)
                                  .reduce((sum, sale) => sum + (Number(sale.total) || 0), 0) : 0;
    const todaySalesEl = document.getElementById('todaySales');
    
    // ØªØ´Ø®ÙŠØµ: Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
    if (sales && sales.length > 0) {
        const salesDates = [...new Set(sales.map(s => s.date))];
        console.log(`ğŸ“… ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:`, salesDates);
        console.log(`ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø­Ø« (Ø§Ù„ÙŠÙˆÙ…):`, today);
        console.log(`âœï¸ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨ØªØ§Ø±ÙŠØ® ${today}:`, sales.filter(s => s.date === today).length);
    }
    
    console.log(`âœï¸ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…: ${todaySalesAmount}, Ø¹Ù†ØµØ± HTML: ${todaySalesEl ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}`);
    if (todaySalesEl) todaySalesEl.textContent = todaySalesAmount.toFixed(2);
    
    // ğŸ›’ Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…
    const todayPurchasesAmount = (purchases && purchases.length > 0) ? purchases.filter(p => p.date === today)
                                         .reduce((sum, purchase) => sum + (Number(purchase.total) || 0), 0) : 0;
    const todayPurchasesEl = document.getElementById('todayPurchases');
    console.log(`âœï¸ Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…: ${todayPurchasesAmount}, Ø¹Ù†ØµØ± HTML: ${todayPurchasesEl ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}`);
    if (todayPurchasesEl) todayPurchasesEl.textContent = todayPurchasesAmount.toFixed(2);
    
    // ï¿½ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…
    const todayExpensesAmount = expenses.filter(e => e.date === today)
                                       .reduce((sum, expense) => sum + (Number(expense.amount) || 0), 0);
    const todayExpensesEl = document.getElementById('todayExpenses');
    if (todayExpensesEl) todayExpensesEl.textContent = todayExpensesAmount.toFixed(2);
    
    // ğŸ’µ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ… (Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰)
    const todayRevenuesAmount = revenues.filter(r => r.date === today)
                                       .reduce((sum, revenue) => sum + (Number(revenue.amount) || 0), 0);
    const todayRevenuesEl = document.getElementById('todayRevenues');
    if (todayRevenuesEl) todayRevenuesEl.textContent = todayRevenuesAmount.toFixed(2);
    
    const monthlySalesAmount = (sales && sales.length > 0) ? sales.filter(s => s.date && s.date.substring(0, 7) === currentMonth)
                                   .reduce((sum, sale) => sum + (Number(sale.total) || 0), 0) : 0;
    const monthlySalesEl = document.getElementById('monthlySales');
    if (monthlySalesEl) monthlySalesEl.textContent = monthlySalesAmount.toFixed(2);
    
    const monthlyPurchasesAmount = (purchases && purchases.length > 0) ? purchases.filter(p => p.date && p.date.substring(0, 7) === currentMonth)
                                           .reduce((sum, purchase) => sum + (Number(purchase.total) || 0), 0) : 0;
    const monthlyPurchasesEl = document.getElementById('monthlyPurchases');
    if (monthlyPurchasesEl) monthlyPurchasesEl.textContent = monthlyPurchasesAmount.toFixed(2);
    
    // ğŸ’¸ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±
    const monthlyExpensesAmount = expenses.filter(e => e.date.substring(0, 7) === currentMonth)
                                         .reduce((sum, expense) => sum + (Number(expense.amount) || 0), 0);
    const monthlyExpensesCardEl = document.getElementById('monthlyExpensesCard');
    if (monthlyExpensesCardEl) monthlyExpensesCardEl.textContent = monthlyExpensesAmount.toFixed(2);
    
    // ğŸ’µ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø± (Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰)
    const monthlyRevenuesAmount = revenues.filter(r => r.date.substring(0, 7) === currentMonth)
                                         .reduce((sum, revenue) => sum + (Number(revenue.amount) || 0), 0);
    const monthlyRevenuesEl = document.getElementById('monthlyRevenues');
    if (monthlyRevenuesEl) monthlyRevenuesEl.textContent = monthlyRevenuesAmount.toFixed(2);

    // ğŸ”¥ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø© (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙÙ‚Ø·)
    const activity = activities.find(a => a.id == currentActivityId);
    
    const yearStart = new Date().getFullYear() + '-01-01';
    const cumulativeSales = sales.filter(s => s.date >= yearStart);
    const cumulativeSalesRevenue = cumulativeSales.reduce((sum, sale) => sum + sale.total, 0);
    const cumulativeRevenuesExtra = revenues.filter(r => r.date >= yearStart).reduce((sum, revenue) => sum + revenue.amount, 0);
    const cumulativeExpenses = expenses.filter(e => e.date >= yearStart).reduce((sum, expense) => sum + expense.amount, 0);
    const cumulativeCOGS = calculateCOGS(cumulativeSales);
    
    // ØµØ§ÙÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø© Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙÙ‚Ø·)
    const cumulativeGrossProfit = cumulativeSalesRevenue - cumulativeCOGS;
    const cumulativeNetProfitFromOperations = cumulativeGrossProfit + cumulativeRevenuesExtra - cumulativeExpenses;
    
    }).catch(error => {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
    });
}
// ğŸ“Š Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© - Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹

function renderSalesChart() {
    const ctx = document.getElementById('salesChart');
    if (!ctx) return;
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
    const last7Days = getLast7Days();
    const salesData = last7Days.map(day => 
        sales.filter(s => s.date === day)
             .reduce((sum, sale) => sum + sale.total, 0)
    );

    // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    if (window.salesChartInstance) {
        window.salesChartInstance.destroy();
    }

    window.salesChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: last7Days.map(day => formatDate(day)),
            datasets: [{
                label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                data: salesData,
                borderColor: '#2c5aa0',
                backgroundColor: 'rgba(44, 90, 160, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    rtl: true,
                    labels: {
                        font: {
                            family: 'Tajawal',
                            size: 14
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…',
                    font: {
                        family: 'Tajawal',
                        size: 16
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        }
                    }
                },
                y: {
                    ticks: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        },
                        callback: function(value) {
                            return value + ' Ø±.Ø³';
                        }
                    }
                }
            }
        }
    });
}

function renderRevenueChart() {
    const ctx = document.getElementById('revenueChart');
    if (!ctx) return;
    
    const revenueBySource = {
        'Ù…Ø¨ÙŠØ¹Ø§Øª': revenues.filter(r => r.source === 'sales').reduce((sum, r) => sum + r.amount, 0),
        'Ø®Ø¯Ù…Ø§Øª': revenues.filter(r => r.source === 'services').reduce((sum, r) => sum + r.amount, 0),
        'Ø§Ø³ØªØ«Ù…Ø§Ø±': revenues.filter(r => r.source === 'investment').reduce((sum, r) => sum + r.amount, 0),
        'Ø£Ø®Ø±Ù‰': revenues.filter(r => r.source === 'other').reduce((sum, r) => sum + r.amount, 0)
    };

    // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    if (window.revenueChartInstance) {
        window.revenueChartInstance.destroy();
    }

    window.revenueChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(revenueBySource),
            datasets: [{
                data: Object.values(revenueBySource),
                backgroundColor: [
                    '#2c5aa0',
                    '#27ae60',
                    '#e74c3c',
                    '#f39c12'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    rtl: true,
                    labels: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        },
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value.toFixed(2)} Ø±.Ø³ (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderExpensesChart() {
    const ctx = document.getElementById('expensesChart');
    if (!ctx) return;
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±
    const months = [];
    const expensesData = [];
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const monthStr = date.toISOString().substring(0, 7);
        months.push(monthStr);
        const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === monthStr)
                                     .reduce((sum, expense) => sum + expense.amount, 0);
        expensesData.push(monthExpenses);
    }
    
    if (window.expensesChartInstance) {
        window.expensesChartInstance.destroy();
    }
    
    window.expensesChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                data: expensesData,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function renderPurchasesSalesChart() {
    const ctx = document.getElementById('purchasesSalesChart');
    if (!ctx) return;
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±
    const months = [];
    const purchasesData = [];
    const salesData = [];
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const monthStr = date.toISOString().substring(0, 7);
        months.push(monthStr);
        const monthPurchases = purchases.filter(p => p.date.substring(0, 7) === monthStr)
                                       .reduce((sum, purchase) => sum + purchase.total, 0);
        const monthSales = sales.filter(s => s.date.substring(0, 7) === monthStr)
                               .reduce((sum, sale) => sum + sale.total, 0);
        purchasesData.push(monthPurchases);
        salesData.push(monthSales);
    }
    
    if (window.purchasesSalesChartInstance) {
        window.purchasesSalesChartInstance.destroy();
    }
    
    window.purchasesSalesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{
                label: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
                data: purchasesData,
                backgroundColor: '#e74c3c',
                borderColor: '#c0392b',
                borderWidth: 1
            }, {
                label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                data: salesData,
                backgroundColor: '#27ae60',
                borderColor: '#219a52',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updatePerformanceIndicators() {
    const monthlySummary = document.getElementById('monthlySummary');
    const financialPerformance = document.getElementById('financialPerformance');
    
    if (!monthlySummary || !financialPerformance) return;
    
    const currentMonth = new Date().toISOString().substring(0, 7);
    
    const monthSales = sales.filter(s => s.date.substring(0, 7) === currentMonth)
                          .reduce((sum, sale) => sum + sale.total, 0);
    const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === currentMonth)
                                .reduce((sum, expense) => sum + expense.amount, 0);
    const monthRevenue = revenues.filter(r => r.date.substring(0, 7) === currentMonth)
                               .reduce((sum, revenue) => sum + revenue.amount, 0);
    const monthPurchases = purchases.filter(p => p.date.substring(0, 7) === currentMonth)
                                  .reduce((sum, purchase) => sum + purchase.total, 0);

    const profitMargin = monthSales > 0 ? ((monthSales - monthPurchases - monthExpenses) / monthSales * 100).toFixed(1) : 0;
    const avgInvoice = monthSales / Math.max(sales.filter(s => s.date.substring(0, 7) === currentMonth).length, 1);

    monthlySummary.innerHTML = `
        <div style="margin-bottom: 15px;">
            <p style="margin: 8px 0; font-size: 14px;">ğŸ’° <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</strong> ${monthSales.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ’¸ <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</strong> ${monthExpenses.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ“ˆ <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:</strong> ${monthRevenue.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ¯ <strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</strong> ${sales.filter(s => s.date.substring(0, 7) === currentMonth).length}</p>
        </div>
    `;

    financialPerformance.innerHTML = `
        <div style="margin-bottom: 15px;">
            <p style="margin: 8px 0; font-size: 14px;">ğŸ“Š <strong>Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­:</strong> <span style="color: ${profitMargin > 0 ? '#27ae60' : '#e74c3c'}">${profitMargin}%</span></p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ“ˆ <strong>Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${avgInvoice.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ”„ <strong>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ:</strong> <span style="color: #27ae60">+15%</span></p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ¯ <strong>ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù:</strong> <span style="color: #27ae60">85%</span></p>
        </div>
    `;
}

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
function getLast7Days() {
    const days = [];
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toISOString().split('T')[0]);
    }
    return days;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-SA', { 
        month: 'short', 
        day: 'numeric' 
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ¬Ù‡ÙŠØ² Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹)
function formatPhoneNumberForWhatsApp(phone) {
    if (!phone) return null;

    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø³Ø§ÙØ§Øª Ø£Ùˆ Ø´Ø±Ø·Ø§Øª Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø© +
    let cleaned = phone.replace(/[\s\-+]/g, '');

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 (Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ)
    if (cleaned.startsWith('05')) {
        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ØµÙØ± Ø§Ù„Ø£ÙˆÙ„ Ø¨Ù€ 966
        return '966' + cleaned.substring(1);
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 5 Ù…Ø¨Ø§Ø´Ø±Ø©
    if (cleaned.length === 9 && cleaned.startsWith('5')) {
        return '966' + cleaned;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ù…ÙƒØªÙˆØ¨Ø§Ù‹ Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¯ÙˆÙ„ÙŠ Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ø§Ù„ÙØ¹Ù„
    if (cleaned.startsWith('966')) {
        return cleaned;
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙŠØºØ©ØŒ Ø£Ø±Ø¬Ø¹ Ø§Ù„Ø±Ù‚Ù… ÙƒÙ…Ø§ Ù‡Ùˆ (Ù‚Ø¯ ÙŠØ¹Ù…Ù„)
    return cleaned;
}

// Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
function sendWhatsAppInvoice(saleId) {
    const sale = sales.find(s => s.id === saleId);
    if (!sale) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©!');
        return;
    }

    const customer = customers.find(c => c.id === sale.customerId);
    if (!customer || !customer.phone) {
        alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.');
        return;
    }

    const formattedPhone = formatPhoneNumberForWhatsApp(customer.phone);
    if (!formattedPhone) {
        alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­.');
        return;
    }

    // --- ØªØ¬Ù‡ÙŠØ² Ù†Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© ---
    const activityList = (typeof activities !== 'undefined' && Array.isArray(activities)) ? activities : [];
    const activity = activityList.find(a => a.id == currentActivityId);
    const activityName = activity && activity.name ? activity.name : 'Ù†Ø´Ø§Ø·Ùƒ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ';
    let message = `*ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª - ${activityName}*\n\n`;
    message += `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${customer.name},\n`;
    message += `Ø¥Ù„ÙŠÙƒ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…: *SAL${sale.number.toString().padStart(3, '0')}*\n`;
    message += `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${sale.date}\n\n`;

    message += "*Ø§Ù„Ø£ØµÙ†Ø§Ù:*\n";
    sale.items.forEach(item => {
        message += `- ${item.name} (Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.quantity}, Ø§Ù„Ø³Ø¹Ø±: ${item.price.toFixed(2)}) = *${item.total.toFixed(2)}*\n`;
    });

    message += `\n*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${sale.total.toFixed(2)} Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ*\n`;
    message += `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${sale.paidAmount.toFixed(2)}\n`;
    message += `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${sale.remainingAmount.toFixed(2)}\n\n`;
    message += `Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§.`;
    // --- Ù†Ù‡Ø§ÙŠØ© Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ---

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ù„ÙŠÙƒÙˆÙ† Ù…ØªÙˆØ§ÙÙ‚Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø·
    const encodedMessage = encodeURIComponent(message);

    // Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙØªØ­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
    const whatsappUrl = `https://api.whatsapp.com/send?phone=${formattedPhone}&text=${encodedMessage}`;

    // ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
    window.open(whatsappUrl, '_blank');
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯Ù‡Ù…
function toggleAllCustomerCheckboxes(mainCheckbox) {
    const checkboxes = document.querySelectorAll('.customer-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = mainCheckbox.checked;
    });
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø©/Ø³Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
async function addAdvance() {
    const date = document.getElementById('advanceDate').value;
    const type = document.getElementById('advanceType').value;
    const employee = document.getElementById('advanceEmployee').value;
    const amount = parseFloat(document.getElementById('advanceAmount').value);
    const description = document.getElementById('advanceDescription').value;
    const status = document.getElementById('advanceStatus').value;

    if (!date || !employee || !amount) {
        showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©', 'error');
        return;
    }

    const newAdvance = {
        id: Date.now(),
        date,
        type,
        employee,
        amount,
        description,
        status,
        createdAt: new Date().toISOString()
    };

    advances.push(newAdvance);
    saveToLocalStorage('advances', advances);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    renderAdvances();
    updateAdvanceStats();
    clearAdvanceForm();
    
    showNotification('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù„ÙØ©/Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù
function renderAdvances() {
    const advancesList = document.getElementById('advancesList');
    if (!advancesList) return;

    advancesList.innerHTML = advances.map(advance => `
        <tr>
            <td>${advance.date}</td>
            <td>${advance.type}</td>
            <td>${advance.employee}</td>
            <td>${advance.amount.toFixed(2)}</td>
            <td>${getStatusBadge(advance.status)}</td>
            <td>${advance.description || '-'}</td>
            <td class="action-buttons">
                <button class="btn-warning edit-btn" onclick="editAdvance(${advance.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn-danger edit-btn" onclick="deleteAdvance(${advance.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </td>
        </tr>
    `).join('');

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØµØºØ±Ø©
    const miniStat = document.getElementById('miniStatAdvances');
    if (miniStat) {
        miniStat.textContent = advances.length;
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
async function clearAdvanceForm() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
    const confirmed = await confirmCancelEdit('#advances');
    if (!confirmed) return;
    
    document.getElementById('advanceDate').value = '';
    document.getElementById('advanceEmployee').value = '';
    document.getElementById('advanceAmount').value = '';
    document.getElementById('advanceDescription').value = '';
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    const addButton = document.querySelector('#advances .btn-add');
    if (addButton) {
        addButton.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø³Ù„ÙØ©';
        addButton.onclick = addAdvance;
    }
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
    removeEditMode('#advances', '#advances h2', 'ğŸ’µ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatAdvances" class="stat-mini-number">0</span></span>');
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù
function updateAdvanceStats() {
    const totalAdvancesEl = document.getElementById('totalAdvances');
    const dueAdvancesEl = document.getElementById('dueAdvances');
    const paidAdvancesEl = document.getElementById('paidAdvances');

    if (totalAdvancesEl) {
        const total = advances.reduce((sum, advance) => sum + advance.amount, 0);
        totalAdvancesEl.textContent = total.toFixed(2);
    }

    if (dueAdvancesEl) {
        const due = advances
            .filter(advance => advance.status === 'Ù…Ø³ØªØ­Ù‚')
            .reduce((sum, advance) => sum + advance.amount, 0);
        dueAdvancesEl.textContent = due.toFixed(2);
    }

    if (paidAdvancesEl) {
        const paid = advances
            .filter(advance => advance.status === 'Ù…Ø³Ø¯Ø¯')
            .reduce((sum, advance) => sum + advance.amount, 0);
        paidAdvancesEl.textContent = paid.toFixed(2);
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø´Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø©
function getStatusBadge(status) {
    const badges = {
        'Ù…Ø³ØªØ­Ù‚': '<span style="color: #e74c3c; font-weight: bold;">Ù…Ø³ØªØ­Ù‚</span>',
        'Ù…Ø³Ø¯Ø¯': '<span style="color: #27ae60; font-weight: bold;">Ù…Ø³Ø¯Ø¯</span>',
        'Ø¬Ø²Ø¦ÙŠ': '<span style="color: #f39c12; font-weight: bold;">Ù…Ø³Ø¯Ø¯ Ø¬Ø²Ø¦ÙŠØ§Ù‹</span>'
    };
    return badges[status] || status;
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
function editAdvance(id) {
    const advance = advances.find(a => a.id === id);
    if (!advance) return;

    document.getElementById('advanceDate').value = advance.date;
    document.getElementById('advanceType').value = advance.type;
    document.getElementById('advanceEmployee').value = advance.employee;
    document.getElementById('advanceAmount').value = advance.amount;
    document.getElementById('advanceDescription').value = advance.description || '';
    document.getElementById('advanceStatus').value = advance.status;

    // ØªØºÙŠÙŠØ± Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ ØªØ­Ø¯ÙŠØ«
    const addButton = document.querySelector('#advances .btn-add');
    addButton.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
    addButton.onclick = function() { updateAdvance(id); };

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
    applyEditMode('#advances', 'advanceEmployee', '#advances h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©: ${advance.employee}`);
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«
async function updateAdvance(id) {
    const advanceIndex = advances.findIndex(a => a.id === id);
    if (advanceIndex === -1) return;

    const date = document.getElementById('advanceDate').value;
    const type = document.getElementById('advanceType').value;
    const employee = document.getElementById('advanceEmployee').value;
    const amount = parseFloat(document.getElementById('advanceAmount').value);
    const description = document.getElementById('advanceDescription').value;
    const status = document.getElementById('advanceStatus').value;

    advances[advanceIndex] = {
        ...advances[advanceIndex],
        date,
        type,
        employee,
        amount,
        description,
        status
    };

    saveToLocalStorage('advances', advances);
    renderAdvances();
    updateAdvanceStats();
    clearAdvanceForm();

    // Ø¥Ø¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    const addButton = document.querySelector('#advances .btn-add');
    addButton.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø©/Ø³Ù„ÙØ©';
    addButton.onclick = addAdvance;

    showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„ÙØ©/Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}
// Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø¹Ù‡Ø¯Ø©/Ø³Ù„ÙØ©
async function deleteAdvance(id) {
    const confirmed = await showConfirmDialog({
        title: 'âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
        message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„ÙØ©/Ø§Ù„Ø¹Ù‡Ø¯Ø©ØŸ',
        type: 'danger',
        confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
        cancelText: 'Ø¥Ù„ØºØ§Ø¡'
    });

    if (!confirmed) return;

    const advanceIndex = advances.findIndex(a => a.id === id);
    if (advanceIndex === -1) return;

    // Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
    moveToTrash('advances', advances[advanceIndex]);
    
    advances.splice(advanceIndex, 1);
    saveToLocalStorage('advances', advances);
    
    renderAdvances();
    updateAdvanceStats();
    
    showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ù„ÙØ©/Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù
function setupAdvanceSearch() {
    const searchInput = document.getElementById('searchAdvances');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredAdvances = advances.filter(advance => 
                advance.employee.toLowerCase().includes(searchTerm) ||
                advance.type.toLowerCase().includes(searchTerm) ||
                advance.description.toLowerCase().includes(searchTerm) ||
                advance.status.toLowerCase().includes(searchTerm)
            );
            renderFilteredAdvances(filteredAdvances);
        });
    }
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
function renderFilteredAdvances(filteredAdvances) {
    const advancesList = document.getElementById('advancesList');
    if (!advancesList) return;

    advancesList.innerHTML = filteredAdvances.map(advance => `
        <tr>
            <td>${advance.date}</td>
            <td>${advance.type}</td>
            <td>${advance.employee}</td>
            <td>${advance.amount.toFixed(2)}</td>
            <td>${getStatusBadge(advance.status)}</td>
            <td>${advance.description || '-'}</td>
            <td class="action-buttons">
                <button class="btn-warning edit-btn" onclick="editAdvance(${advance.id})">âœï¸</button>
                <button class="btn-danger" onclick="deleteAdvance(${advance.id})">ğŸ—‘ï¸</button>
            </td>
        </tr>
    `).join('');
}

// === Ø¯ÙˆØ§Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª ===

// --- Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ---
async function deleteSaleReturn(returnId) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ Ø³ÙŠØªÙ… Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.')) {
        return;
    }

    const returnIndex = salesReturns.findIndex(sr => sr.id === returnId);
    if (returnIndex === -1) return;

    const returnToDelete = salesReturns[returnIndex];

    // Ø£Ù‡Ù… Ø®Ø·ÙˆØ©: Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    // Ø¹Ù†Ø¯ Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§ØªØŒ ÙŠØ¬Ø¨ Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
    returnToDelete.items.forEach(returnedItem => {
        const itemInStock = items.find(i => i.id === returnedItem.id);
        if (itemInStock) {
            itemInStock.stock -= returnedItem.quantity;
        }
    });

    moveToTrash('salesReturns', returnToDelete);
    salesReturns.splice(returnIndex, 1);

    saveToLocalStorage('salesReturns', salesReturns);
    saveToLocalStorage('items', items);

    renderSalesReturns();
    renderItems();
    updateDashboard();
    showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
}

// --- Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ---
async function deletePurchaseReturn(returnId) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø²ÙŠØ§Ø¯ØªÙ‡Ø§).')) {
        return;
    }

    const returnIndex = purchaseReturns.findIndex(pr => pr.id === returnId);
    if (returnIndex === -1) return;

    const returnToDelete = purchaseReturns[returnIndex];

    // Ø£Ù‡Ù… Ø®Ø·ÙˆØ©: Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    // Ø¹Ù†Ø¯ Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§ØªØŒ ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.
    returnToDelete.items.forEach(returnedItem => {
        const itemInStock = items.find(i => i.id === returnedItem.id);
        if (itemInStock) {
            itemInStock.stock += returnedItem.quantity;
        }
    });

    moveToTrash('purchaseReturns', returnToDelete);
    purchaseReturns.splice(returnIndex, 1);

    saveToLocalStorage('purchaseReturns', purchaseReturns);
    saveToLocalStorage('items', items);

    renderPurchaseReturns();
    renderItems();
    updateDashboard();
    showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
}

function loadSupplierAccount() {
    const supplierId = document.getElementById('accountSupplierSelect').value;
    const fromDate = document.getElementById('accountSupplierFromDate').value;
    const toDate = document.getElementById('accountSupplierToDate').value;
    
    if (!supplierId) {
        showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ±Ø¯', 'warning');
        return;
    }
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯...');
    setTimeout(() => {
        // Ø³Ù†Ù†ÙØ° generateSupplierAccountStatement Ù„Ø§Ø­Ù‚Ø§Ù‹
        showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø©', 'Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ° ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯ Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'info');
        hideLoading();
    }, 500);
}

function loadBankAccount() {
    const bankId = document.getElementById('accountBankSelect').value;
    const fromDate = document.getElementById('accountBankFromDate').value;
    const toDate = document.getElementById('accountBankToDate').value;
    
    if (!bankId) {
        showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ù†Ùƒ', 'warning');
        return;
    }
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ...');
    setTimeout(() => {
        // Ø³Ù†Ù†ÙØ° generateBankAccountStatement Ù„Ø§Ø­Ù‚Ø§Ù‹
        showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø©', 'Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ° ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'info');
        hideLoading();
    }, 500);
}

console.log('ğŸ¯ About to define loadRecentActivities...');

function loadRecentActivities() {
    // Ø¯Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ© Ù„Ø­Ù„ Ø§Ù„Ø®Ø·Ø£
    console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©...');
    return [];
}

// ØªØ­Ù…ÙŠÙ„ ØªØ®ØµÙŠØµØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
console.log('ğŸ¯ About to add DOMContentLoaded listener...');
document.addEventListener('DOMContentLoaded', function() {
    console.log('ï¿½ğŸš€ğŸš€ DOMContentLoaded FIRED! - Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
    console.log('ï¿½ğŸ“„ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© - ØªØ­Ù…ÙŠÙ„ ØªØ®ØµÙŠØµØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ…...');
    if (typeof loadDesignPreferences === 'function') {
        loadDesignPreferences();
        console.log('ğŸ¨ ØªÙ… ØªØ­Ù…ÙŠÙ„ ØªØ®ØµÙŠØµØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©');
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ DOM Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    console.log('ğŸ“„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„...');
    setTimeout(() => {
        console.log('â° setTimeout fired - checking loadFooterSettings...');
        if (typeof loadFooterSettings === 'function') {
            console.log('âœ… loadFooterSettings function found, calling it...');
            loadFooterSettings();
            console.log('ğŸ“„ ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ loadFooterSettings() Ù…Ù† DOMContentLoaded');
        } else {
            console.error('âŒ Ø¯Ø§Ù„Ø© loadFooterSettings ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!');
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            const footer = document.getElementById('appFooter');
            if (footer) {
                footer.style.opacity = '1';
                console.log('âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
            }
        }
    }, 200); // ØªØ£Ø®ÙŠØ± 200ms Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    
    // ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù…
    if (typeof checkFirstSetup === 'function') {
        console.log('ğŸš€ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ¸ÙŠÙØ© checkFirstSetup - Ø³ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø©');
        setTimeout(() => {
            console.log('ğŸ” Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù…...');
            checkFirstSetup();
        }, 1000); // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Firebase
    } else {
        console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ¸ÙŠÙØ© checkFirstSetup');
    }
    console.log('ğŸ DOMContentLoaded COMPLETED!');
});
}

</script>

    <!-- ğŸ†• Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
    <div id="footerSettingsModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative;">
            <span class="close" onclick="closeFooterSettingsModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">âš™ï¸ ØªØ®ØµÙŠØµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„</h2>
            
            <div class="form-grid grid-1">
                <div>
                    <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©:</label>
                    <input type="text" id="footerCompanyNameInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">
                </div>
                
                <div>
                    <label>ÙˆØµÙ Ø§Ù„Ø´Ø±ÙƒØ©:</label>
                    <textarea id="footerCompanyDescInput" rows="3" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ"></textarea>
                </div>
                
                <div class="form-grid grid-2">
                    <div>
                        <label>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
                        <input type="text" id="footerPhoneInput" placeholder="+966 xx xxx xxxx">
                    </div>
                    
                    <div>
                        <label>âœ‰ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                        <input type="email" id="footerEmailInput" placeholder="info@company.com">
                    </div>
                </div>
                
                <div>
                    <label>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
                    <input type="text" id="footerAddressInput" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø±ÙƒØ©">
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                
                <h4 style="margin-bottom: 10px; color: #667eea;">ğŸŒ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</h4>
                
                <div class="form-grid grid-2">
                    <div>
                        <label>ğ• ØªÙˆÙŠØªØ±/X:</label>
                        <input type="url" id="footerTwitterInput" placeholder="https://twitter.com/yourcompany">
                    </div>
                    
                    <div>
                        <label>ğŸ“˜ ÙÙŠØ³Ø¨ÙˆÙƒ:</label>
                        <input type="url" id="footerFacebookInput" placeholder="https://facebook.com/yourcompany">
                    </div>
                    
                    <div>
                        <label>ğŸ“· Ø§Ù†Ø³ØªÙ‚Ø±Ø§Ù…:</label>
                        <input type="url" id="footerInstagramInput" placeholder="https://instagram.com/yourcompany">
                    </div>
                    
                    <div>
                        <label>ğŸ’¼ Ù„ÙŠÙ†ÙƒØ¯Ø¥Ù†:</label>
                        <input type="url" id="footerLinkedinInput" placeholder="https://linkedin.com/company/yourcompany">
                    </div>
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                
                <div class="form-grid grid-2">
                    <div>
                        <label>Â© Ù†Øµ Ø§Ù„Ø­Ù‚ÙˆÙ‚:</label>
                        <input type="text" id="footerCopyrightInput" placeholder="Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©">
                    </div>
                    
                    <div>
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</label>
                        <input type="text" id="footerVersionInput" placeholder="Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.0">
                    </div>
                </div>
                
                <div class="form-grid grid-2" style="margin-top: 20px; gap: 10px;">
                    <button class="btn-success" onclick="saveFooterSettingsFromModal()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    <button class="btn-secondary" onclick="closeFooterSettingsModal()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ†• Ø§Ù„ØªØ°ÙŠÙŠÙ„ (Footer) -->
    <footer id="appFooter" style="background: linear-gradient(135deg, #1e3a5f 0%, #2c4a6f 100%); color: white; padding: 30px 20px; margin-top: 50px; margin-right: var(--sidebar-width); border-top: 4px solid #1e3a5f; opacity: 0; transition: opacity 0.3s ease-in-out, margin-right 0.3s ease; position: relative; z-index: 10; display: none;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-bottom: 20px;">
                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© -->
                <div>
                    <h4 style="margin: 0 0 15px 0; font-size: 18px; color: white;" id="footerCompanyName">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</h4>
                    <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;" id="footerCompanyDesc">ÙˆØµÙ Ù…Ø®ØªØµØ± Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</p>
                </div>
                
                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ -->
                <div>
                    <h4 style="margin: 0 0 15px 0; font-size: 18px; color: white;">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</h4>
                    <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;"><span id="footerPhone">ğŸ“ +966 xx xxx xxxx</span></p>
                    <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;"><span id="footerEmail">âœ‰ï¸ info@company.com</span></p>
                    <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;"><span id="footerAddress">ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span></p>
                </div>
                
                <!-- Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ -->
                <div>
                    <h4 style="margin: 0 0 15px 0; font-size: 18px; color: white;">ØªØ§Ø¨Ø¹Ù†Ø§</h4>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <a href="#" id="footerTwitterLink" style="color: white; font-size: 24px; opacity: 0.8; transition: opacity 0.3s;" title="ØªÙˆÙŠØªØ±" target="_blank">ğ•</a>
                        <a href="#" id="footerFacebookLink" style="color: white; font-size: 24px; opacity: 0.8; transition: opacity 0.3s;" title="ÙÙŠØ³Ø¨ÙˆÙƒ" target="_blank">ğŸ“˜</a>
                        <a href="#" id="footerInstagramLink" style="color: white; font-size: 24px; opacity: 0.8; transition: opacity 0.3s;" title="Ø§Ù†Ø³ØªÙ‚Ø±Ø§Ù…" target="_blank">ğŸ“·</a>
                        <a href="#" id="footerLinkedinLink" style="color: white; font-size: 24px; opacity: 0.8; transition: opacity 0.3s;" title="Ù„ÙŠÙ†ÙƒØ¯Ø¥Ù†" target="_blank">ğŸ’¼</a>
                    </div>
                </div>
            </div>
            
            <!-- Ø§Ù„Ø­Ù‚ÙˆÙ‚ ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚ -->
            <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; text-align: center;">
                <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;" id="footerCopyright">Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
                <p style="margin: 5px 0; font-size: 12px; opacity: 0.7;" id="footerVersion">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.0</p>
            </div>
        </div>
    </footer>

            <script>
                // Safety net: show footer only when the app UI is ready (avoid early flash)
                (function() {
                    try {
                                    const getStyle = (el) => el ? window.getComputedStyle(el) : null;
                                    const isAppReady = () => {
                                        // Ø§Ø¹ØªØ¨Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø²Ø§Ù‹ ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                                        const app = document.querySelector('.app-container');
                                        const appVisible = app && getStyle(app).display !== 'none';
                                        return Boolean(appVisible);
                                    };

                        const showFooter = () => {
                            const footer = document.getElementById('appFooter');
                            if (footer) footer.style.opacity = '1';
                        };

                        const run = () => {
                            if (typeof loadFooterSettings === 'function') {
                                try { loadFooterSettings(); } catch (e) { console.error('footer fallback load error:', e); }
                            }
                            showFooter();
                        };

                        const start = () => {
                            if (isAppReady()) {
                                run();
                                return;
                            }
                            const startTime = Date.now();
                            const maxWaitMs = 8000; // fallback after 8s even if not ready
                            const interval = setInterval(() => {
                                if (isAppReady() || (Date.now() - startTime) > maxWaitMs) {
                                    clearInterval(interval);
                                    run();
                                }
                            }, 150);
                        };

                        if (document.readyState === 'complete' || document.readyState === 'interactive') {
                            start();
                        } else {
                            document.addEventListener('DOMContentLoaded', start, { once: true });
                        }
                    } catch (err) {
                        console.error('Footer safety script error:', err);
                    }
                })();
            </script>

</body>
</html>

<!DOCTYPE html>

 
<head>
    <title>Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ - Ø¯ÙŠÙˆØ§Ù†ÙŠ</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Preconnect Ù„Ù„Ø®Ø·ÙˆØ· Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Ø§Ù„ÙØ§ÙÙŠÙƒÙˆÙ† -->
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dgjcr2bgq/image/upload/v1762349658/logo_vlldbc.png">
    <link rel="shortcut icon" type="image/png" href="https://res.cloudinary.com/dgjcr2bgq/image/upload/v1762349658/logo_vlldbc.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Reem+Kufi&display=swap" rel="stylesheet">
    
    <!-- Ù…ÙƒØªØ¨Ø© PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- CSS Ù…Ø®ØµØµ Ù„Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
        <style>
    /* ===== Action Menu Styles ===== */
    .action-menu-container {
        position: relative;
        display: inline-block;
    }
    
    .action-menu-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 4px;
        transition: background 0.2s;
    }
    
    .action-menu-btn:hover {
        background-color: #f0f0f0;
    }
    
    .action-menu-content {
        display: none;
        position: absolute;
        left: 0; /* Align to the left of the button */
        top: 100%;
        background-color: white;
        min-width: 160px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        z-index: 1000; /* Ensure it's above other elements */
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #eee;
    }
    
    .action-menu-content a {
        color: var(--text-color);
        padding: 12px 16px;
        text-decoration: none;
        display: block;
        font-size: 14px;
        transition: background 0.2s;
        text-align: right;
    }
    
    .action-menu-content a:hover {
        background-color: #f8f9fa;
        color: var(--primary-color);
    }
    
    .action-menu-content a.delete-action:hover {
        background-color: #ffebee;
        color: #dc3545;
    }
    
    /* Show class for JS toggle */
    .action-menu-content.show {
        display: block;
    }
        /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¨Ø´ÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ */
        #data-monitor-modal {
            display: none !important;
            position: fixed !important;
            z-index: 10001 !important;
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0,0,0,0.6) !important;
            justify-content: center !important;
            align-items: center !important;
        }
        
        #data-monitor-modal.show {
            display: flex !important;
        }
        
        #data-monitor-modal .modal-content {
            background: white !important;
            margin: auto !important;
            padding: 20px !important;
            border-radius: 10px !important;
            max-width: 800px !important;
            width: 90% !important;
            max-height: 90% !important;
            overflow-y: auto !important;
            position: relative !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
        }
        
        #data-monitor-modal .close {
            cursor: pointer !important;
            font-size: 28px !important;
            color: #999 !important;
            font-weight: bold !important;
            line-height: 1 !important;
            padding: 0 !important;
            border: none !important;
            background: none !important;
        }
        
        #data-monitor-modal .close:hover {
            color: #333 !important;
        }
    </style>
    
    <!-- Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© - Firebase Ø¨Ø¯ÙˆÙ† defer Ù„Ø£Ù†Ù‡ Ù…Ø·Ù„ÙˆØ¨ ÙÙˆØ±Ø§Ù‹ -->

<script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, set, get, update, remove, onValue, push, child } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase Configuration - Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ± (Development)
        const firebaseConfig = {
            apiKey: "AIzaSyD0vzY_eb9sN2uh5sn4cJyYQSI6YoyJAeI",
            authDomain: "diwanitestapp.firebaseapp.com",
            databaseURL: "https://diwanitestapp-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "diwanitestapp",
            storageBucket: "diwanitestapp.firebasestorage.app",
            messagingSenderId: "296228843355",
            appId: "1:296228843355:web:e2a30eced24e7fef16747e",
            measurementId: "G-7P91XB244P"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;
        window.firebaseModules = {
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            ref,
            set,
            get,
            update,
            remove,
            onValue,
            push,
            child
        };

        // ØªØ¹Ø±ÙŠÙ DEBUG_MODE Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† Ø¹Ù„Ù‰ window (Ù…Ø¹ Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©)
        window.DEBUG_MODE = typeof window.DEBUG_MODE === 'boolean' ? window.DEBUG_MODE : false;

        // ÙÙ„ØªØ±Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„: Ø¥Ø¸Ù‡Ø§Ø± info/log ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ DEBUG_MODEØŒ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª/Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¯Ø§Ø¦Ù…Ø§Ù‹
        (function setupConsoleFilter(){
            try {
                const original = window.__ORIGINAL_CONSOLE__ || window.console;
                if (!window.__ORIGINAL_CONSOLE__) {
                    window.__ORIGINAL_CONSOLE__ = original;
                }
                const filtered = {
                    ...original,
                    log: (...args) => { if (window.DEBUG_MODE) original.log(...args); },
                    info: (...args) => { if (window.DEBUG_MODE) (original.info ? original.info(...args) : original.log(...args)); },
                    debug: (...args) => { if (window.DEBUG_MODE && original.debug) original.debug(...args); },
                    warn: (...args) => (original.warn ? original.warn(...args) : original.log(...args)),
                    error: (...args) => (original.error ? original.error(...args) : original.log(...args)),
                };
                window.console = filtered;
            } catch (e) {
                // ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙÙ„ØªØ±
            }
        })();

        if (window.DEBUG_MODE) {
            console.log('âœ… Firebase initialized successfully!');
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø© Ù„ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Google services
        window.addEventListener('error', function(event) {
            // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ iframe.js Ùˆall-frames.js (Google services)
            if (event.filename && (event.filename.includes('iframe.js') || event.filename.includes('all-frames.js'))) {
                event.preventDefault();
                return false;
            }
            
            // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ handleLogin is not defined (ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§)
            if (event.error && event.error.message && event.error.message.includes('handleLogin is not defined')) {
                event.preventDefault();
                return false;
            }
            
            // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ postMessage
            if (event.error && event.error.message && event.error.message.includes('postMessage')) {
                event.preventDefault();
                return false;
            }
        }, true);

        // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ postMessage 
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && 
                (event.reason.message.includes('Could not establish connection') ||
                 event.reason.message.includes('postMessage') ||
                 event.reason.message.includes('target origin') ||
                 event.reason.message.includes('Receiving end does not exist'))) {
                event.preventDefault();
                return false;
            }
        });
    </script>
    
    <script>
        // Ù†Ø¸Ø§Ù… "ØªØ°ÙƒØ±Ù†ÙŠ" Ø§Ù„Ø¨Ø³ÙŠØ· - ÙŠØ¹Ù…Ù„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        // ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ ØªØ±ØªÙŠØ¨ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„
    </script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */
        .login-form.active {
            display: block !important;
        }
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border-top: 4px solid var(--primary-color);
            margin-bottom: 20px;
        }

        .stat-trend {
            font-size: 0.8em;
            margin-top: 5px;
            font-weight: bold;
        }

        .trend-up { 
            color: var(--success-color); 
        }

        .trend-down { 
            color: var(--accent-color); 
        }

        .analytics-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            .analytics-grid {
                grid-template-columns: 1fr;
            }
      
 
      
        }

        /* Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ */
        * {
            box-sizing: border-box;
        }
        
        html {
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
            position: relative;
        }
        
        /* Ù…Ù†Ø¹ Ø£ÙŠ overflow Ø£ÙÙ‚ÙŠ */
        .section, .container, .form-grid, table, .invoice-items, .report-controls {
            max-width: 100%;
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table {
            table-layout: auto;
            width: 100%;
        }
        
        /* ØªØ­Ø³ÙŠÙ† touch scrolling */
        .invoice-items, .section table {
            -webkit-overflow-scrolling: touch;
        }

        :root {
                    --primary-color: #2c5aa0;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --bg-color: #ecf0f1;
            --text-color: #2c3e50;
            --font-size: 16px;
            --font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --sidebar-width: 280px;
            --sidebar-bg: #1a3a5c;
            --sidebar-text: #ffffff;
            --header-bg: linear-gradient(135deg, #1a3a5c 0%, #0d2742 100%);
                    --header-height: 140px;
            
            /* Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
            --dark-bg: #1a1a2e;
            --dark-bg-secondary: #16213e;
            --dark-bg-tertiary: #0f3460;
            --dark-text: #e4e6ea;
            --dark-text-secondary: #b0b3b8;
            --dark-border: #3a3b3c;
            --dark-shadow: 0 4px 12px rgba(0,0,0,0.5);
            --dark-input-bg: #242526;
            --dark-card-bg: #242526;
            --dark-table-bg: #18191a;
            --dark-table-row: #242526;
            --dark-sidebar-bg: #18191a;
            --dark-header-bg: linear-gradient(135deg, #1c1e21 0%, #0f1013 100%);
        }
    

/* ===== ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ===== */
.chart-card {
    background: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border-top: 4px solid var(--primary-color);
    margin-bottom: 25px;
    height: 320px;
    position: relative;
    transition: all 0.3s ease;
}

@media (max-width: 480px) {
    .advanced-stats {
        gap: 15px !important;
    }

    .advanced-stats .stat-card {
        padding: 16px 12px;
    }

    .advanced-stats .stat-number {
        font-size: 1.7em;
    }
    th {
        padding: 10px 12px;
    }
}

.chart-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.chart-card canvas {
    width: 100% !important;
    height: 240px !important;
    margin-top: 10px;
}

.chart-card h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
    font-size: 1em;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 10px;
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.analytics-card {
    background: white;
    padding: 10px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-bottom: 20px;
    min-height: 120px;
    border-right: 4px solid var(--success-color);
    transition: all 0.3s ease;
}

.analytics-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.analytics-card h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
    font-size: 1.1em;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 8px;
    font-weight: 700;
}

.analytics-card p {
    margin: 8px 0;
    font-size: 14px;
    line-height: 1.5;
    color: var(--text-color);
}

.analytics-card strong {
    color: var(--secondary-color);
    font-weight: 700;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø¨ÙƒØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ© */
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 25px;
    margin: 30px 0;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ© */
.stat-card {
    background: white;
    padding: 10px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border-top: 5px solid var(--primary-color);
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color), var(--success-color));
}

.stat-number {
    font-size: 1.8em;
    font-weight: bold;
    color: var(--primary-color);
    margin: 8px 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-label {
    color: var(--secondary-color);
    font-size: 0.9em;
    font-weight: 600;
    margin-bottom: 8px;
}

.stat-trend {
    font-size: 0.9em;
    margin-top: 8px;
    font-weight: bold;
    padding: 4px 12px;
    border-radius: 20px;
    display: inline-block;
}

.trend-up {
    background: rgba(39, 174, 96, 0.1);
    color: var(--success-color);
}

.trend-down {
    background: rgba(231, 76, 60, 0.1);
    color: var(--accent-color);
}

/* ØªØ®ØµÙŠØµ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */
.advanced-stats {
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)) !important;
    gap: 20px !important;
    margin-bottom: 30px;
}

.advanced-stats .stat-card {
    padding: 20px 15px;
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.advanced-stats .stat-number {
    font-size: 2.4em;
    margin: 10px 0;
}

.advanced-stats .stat-label {
    font-size: 1.1em;
    margin-bottom: 8px;
}

.advanced-stats .stat-trend {
    font-size: 0.95em;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© */
@media (max-width: 1024px) {
    .analytics-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .charts-container {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .chart-card {
        height: 350px;
        padding: 20px;
    }
    
    .chart-card canvas {
        height: 250px !important;
    }
    
    .stat-number {
        font-size: 1.8em;
    }
    
    .analytics-card {
        padding: 15px;
        min-height: 140px;
    }

    .advanced-stats .stat-card {
        aspect-ratio: auto;
        padding: 18px 15px;
    }
    
    /* ğŸ†• Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© - Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    .charts-section > div[style*="grid"] {
        grid-template-columns: 1fr !important;
    }

    .advanced-stats .stat-number {
        font-size: 2em;
    }

    /* ğŸ“„ Ø§Ù„ØªØ°ÙŠÙŠÙ„ - ØªØ®Ø·ÙŠØ· Ø¹Ù…ÙˆØ¯ÙŠ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    #appFooter > div > div[style*="grid"] {
        grid-template-columns: 1fr !important;
        gap: 20px !important;
    }

    #appFooter {
        padding: 20px 15px !important;
        margin-top: 30px !important;
        margin-right: 0 !important; /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ø£ÙŠÙ…Ù† Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    }

    #appFooter h4 {
        font-size: 16px !important;
    }

    #appFooter p, #appFooter span, #appFooter a {
        font-size: 13px !important;
    }

    .section {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 15px 10px;
    }

    .section table {
        min-width: 540px;
    }

    table {
        font-size: calc(var(--font-size) * 0.85);
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }

    th,
    td {
        padding: 8px 6px;
        font-size: 13px;
    }
    
    /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª */
    .container {
        width: 100%;
        max-width: 100vw;
        padding: 10px 5px;
        overflow-x: hidden;
    }
    
    /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        justify-content: center;
    }
    
    .action-buttons button {
        font-size: 12px;
        padding: 6px 10px;
        min-width: auto;
    }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„ØªØ¯Ø±Ø¬Ø§Øª */
.charts-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin: 30px 0;
}

/* ØªØ£Ø«ÙŠØ±Ø§Øª ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
.chart-loading {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
.chart-card h3, 
.analytics-card h3,
.stat-label {
    font-family: 'Tajawal', sans-serif;
    font-weight: 700;
}

/* ØªØ®ØµÙŠØµ Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
:root {
    --chart-color-1: #2c5aa0;
    --chart-color-2: #27ae60;
    --chart-color-3: #e74c3c;
    --chart-color-4: #f39c12;
    --chart-color-5: #9b59b6;
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ===== */
#global-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    display: none;
}

.loader-overlay {
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

.loader-content {
    background: white;
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    text-align: center;
    animation: fadeIn 0.3s ease;
}

.spinner {
    width: 60px;
    height: 60px;
    margin: 0 auto 20px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loader-message {
    color: var(--text-color);
    font-size: 1.1em;
    font-weight: 600;
    margin: 0;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}
/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ===== */

/* ===== Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ===== */
#notifications-container {
    position: fixed;
    top: 80px;
    left: 20px;
    z-index: 99999;
    max-width: 400px;
    pointer-events: none;
}

.notification {
    background: white;
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 12px;
    box-shadow: 0 6px 25px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.4s ease;
    pointer-events: all;
    cursor: pointer;
    transition: all 0.3s ease;
    border-right: 4px solid var(--primary-color);
}

.notification:hover {
    transform: translateX(-5px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
}

.notification.success {
    border-right-color: var(--success-color);
}

.notification.warning {
    border-right-color: #f39c12;
}

.notification.error {
    border-right-color: var(--accent-color);
}

.notification.info {
    border-right-color: var(--primary-color);
}

.notification-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: 700;
    font-size: 0.95em;
    margin-bottom: 4px;
    color: var(--text-color);
}

.notification-message {
    font-size: 0.85em;
    color: #666;
    line-height: 1.4;
}

.notification-close {
    font-size: 20px;
    color: #999;
    cursor: pointer;
    padding: 4px;
    flex-shrink: 0;
}

.notification-close:hover {
    color: var(--accent-color);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideOut {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(100px);
    }
}

.notification.removing {
    animation: slideOut 0.3s ease forwards;
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± */
.notification-bell {
    position: relative;
    cursor: pointer;
    padding: 8px 12px;
    font-size: 1.3em;
    transition: all 0.3s ease;
}

.notification-bell:hover {
    color: var(--primary-color);
    transform: scale(1.1);
}

.notification-badge {
    position: absolute;
    top: 4px;
    right: 4px;
    background: var(--accent-color);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ===== */

/* ===== Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Confirm Dialog) ===== */
.confirm-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 20000;
    backdrop-filter: blur(3px);
    animation: fadeIn 0.3s ease;
}

.confirm-overlay.active {
    display: flex;
    justify-content: center;
    align-items: center;
}

.confirm-dialog {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    max-width: 480px;
    width: 90%;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    animation: scaleIn 0.3s ease;
    font-family: var(--font-family);
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.confirm-header {
    padding: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    border-bottom: 2px solid #f0f0f0;
}

.confirm-icon {
    font-size: 48px;
    line-height: 1;
}

.confirm-header.warning .confirm-icon {
    color: #f39c12;
}

.confirm-header.danger .confirm-icon {
    color: #e74c3c;
}

.confirm-header.info .confirm-icon {
    color: var(--primary-color);
}

.confirm-header.success .confirm-icon {
    color: var(--success-color);
}

.confirm-title {
    font-size: 1.4em;
    font-weight: 700;
    color: var(--text-color);
}

.confirm-body {
    padding: 24px;
    font-size: 1.05em;
    line-height: 1.6;
    color: #555;
    overflow-y: auto;
    flex: 1;
    max-height: calc(85vh - 220px);
}

.confirm-footer {
    padding: 20px 24px;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: #f8f9fa;
    border-top: 1px solid #e0e0e0;
    flex-shrink: 0;
}

.confirm-footer button {
    padding: 12px 28px;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: var(--font-family);
}

.confirm-btn-cancel {
    background: #e0e0e0;
    color: #666;
}

.confirm-btn-cancel:hover {
    background: #d0d0d0;
    transform: translateY(-2px);
}

.confirm-btn-confirm {
    background: var(--primary-color);
    color: white;
}

.confirm-btn-confirm:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

.confirm-btn-confirm.danger {
    background: #e74c3c;
}

.confirm-btn-confirm.danger:hover {
    background: #c0392b;
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
}

.confirm-btn-confirm.success {
    background: var(--success-color);
}

.confirm-btn-confirm.success:hover {
    background: #229954;
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}

/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ===== */

/* ===== Ø£Ù†Ù…Ø§Ø· Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ===== */
.edit-activity-modal input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    background: white;
    transform: translateY(-1px);
}

.edit-activity-modal button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2) !important;
}

.edit-activity-modal button:active {
    transform: translateY(0);
}

@media (max-width: 600px) {
    .edit-activity-modal {
        margin: 10px;
        max-width: calc(100% - 20px) !important;
    }
    
    .edit-activity-header {
        padding: 20px !important;
    }
    
    .edit-activity-body {
        padding: 20px !important;
    }
    
    .edit-activity-footer {
        padding: 15px 20px !important;
        flex-direction: column;
    }
    
    .edit-activity-footer button {
        width: 100%;
        margin-bottom: 10px;
    }
    
    .edit-activity-footer button:last-child {
        margin-bottom: 0;
    }
}

/* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù†ØªÙ‚Ø§Ù„ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø© */
.edit-activity-modal {
    transform-origin: center;
}

#edit-activity-overlay.show {
    display: flex !important;
    animation: fadeIn 0.3s ease;
}

#edit-activity-overlay.show .edit-activity-modal {
    animation: bounceIn 0.4s ease;
}

@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: scale(0.3) translateY(-50px);
    }
    50% {
        opacity: 1;
        transform: scale(1.05) translateY(0);
    }
    70% {
        transform: scale(0.95);
    }
    100% {
        transform: scale(1);
    }
}

#edit-activity-overlay.hide {
    animation: fadeOut 0.3s ease;
}

#edit-activity-overlay.hide .edit-activity-modal {
    animation: zoomOut 0.3s ease;
}

@keyframes zoomOut {
    0% {
        opacity: 1;
        transform: scale(1);
    }
    100% {
        opacity: 0;
        transform: scale(0.8);
    }
}
/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· ===== */

/* ===== Ø£Ù†Ù…Ø§Ø· Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ===== */
#trash-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

#trash-modal.active {
    display: flex;
}

.trash-content {
    background: white;
    border-radius: 15px;
    padding: 30px;
    max-width: 900px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    animation: fadeIn 0.3s ease;
}

.trash-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #eee;
}

.trash-header h2 {
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 10px;
}

.trash-tabs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 8px;
    margin-bottom: 20px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 8px;
}

.trash-tab {
    padding: 10px 8px;
    background: white;
    border: none;
    cursor: pointer;
    font-size: 0.8em;
    color: #666;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    text-align: center;
    white-space: normal;
    word-wrap: break-word;
}

.trash-tab:hover {
    color: var(--primary-color);
    background: #f0f8ff;
    transform: translateY(-2px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.trash-tab.active {
    color: white;
    background: var(--primary-color);
    font-weight: bold;
    box-shadow: 0 3px 8px rgba(44, 120, 208, 0.3);
}

.trash-items {
    margin-top: 20px;
}

.trash-item {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.trash-item:hover {
    background: #f0f0f0;
    border-color: var(--primary-color);
}

.trash-item-info {
    flex: 1;
}

.trash-item-name {
    font-weight: bold;
    color: var(--text-color);
    margin-bottom: 5px;
}

.trash-item-meta {
    font-size: 0.85em;
    color: #666;
}

.trash-item-actions {
    display: flex;
    gap: 8px;
}

.trash-empty-state {
    text-align: center;
    padding: 40px;
    color: #999;
}

.trash-empty-state i {
    font-size: 4em;
    margin-bottom: 15px;
    opacity: 0.3;
}

.trash-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    gap: 8px;
    margin-bottom: 15px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 8px;
}

.trash-stat {
    text-align: center;
    padding: 8px 6px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.trash-stat:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.trash-stat-value {
    font-size: 1.6em;
    font-weight: bold;
    color: var(--primary-color);
}

.trash-stat-label {
    font-size: 0.75em;
    color: #666;
    margin-top: 2px;
    white-space: normal;
    word-wrap: break-word;
    line-height: 1.2;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width: 768px) {
    .trash-stats {
        grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
        gap: 6px;
        padding: 8px;
    }
    
    .trash-tabs {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    }
    
    .trash-stat {
        padding: 6px 4px;
    }
    
    .trash-stat-value {
        font-size: 1.2em;
    }
    
    .trash-stat-label {
        font-size: 0.65em;
    }
    
    .trash-tab {
        font-size: 0.7em;
        padding: 8px 6px;
    }
}
/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ===== */


    * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; font-size: var(--font-size); background: var(--bg-color); color: var(--text-color); direction: rtl; line-height: 1.6; min-height: 100vh; opacity: 0; transition: opacity 0.3s ease; }
        body.loaded { opacity: 1; }
        input, button, select, textarea { font-family: 'Tajawal', sans-serif; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(5px); }
        #login-overlay.active ~ #appFooter { display: none !important; }
        #login-box { background: white; padding: 40px; border-radius: var(--border-radius); box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 420px; text-align: center; animation: fadeIn 0.5s ease; }
        
        /* Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        .login-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            display: block;
            object-fit: contain;
            animation: scaleIn 0.6s ease;
        }
        
        #login-box h2 { color: var(--primary-color); margin-bottom: 25px; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: var(--border-radius); font-size: calc(var(--font-size) * 0.95); }
        #login-error { color: var(--accent-color); margin-bottom: 15px; display: none; font-weight: bold; }
        .login-role-selector button { width: 100%; margin-bottom: 10px; padding: 15px; font-size: 1.1em; }
        .login-form { display: none; }
        .back-to-roles { color: var(--primary-color); cursor: pointer; display: block; margin-top: 20px; font-weight: bold; }
        
        /* First Setup Overlay Styles */
        #first-setup-overlay button:hover { background: rgba(255,255,255,0.3) !important; transform: translateY(-2px); }
        #first-setup-overlay .login-input::placeholder { color: rgba(0,0,0,0.6); }
        #first-setup-overlay .login-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(255,255,255,0.3); }

        #activity-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(8px); }
        #activity-box { background: white; padding: 40px; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.25); width: 100%; max-width: 500px; text-align: center; animation: fadeIn 0.5s ease; }
        #activity-box h2 { color: var(--primary-color); margin-bottom: 25px; }
        #activity-list { max-height: 200px; overflow-y: auto; margin-bottom: 20px; }
        .activity-btn { 
            width: 100%; 
            margin-bottom: 10px; 
            padding: 18px; 
            font-size: 1.1em; 
            white-space: normal; 
            word-wrap: break-word; 
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .app-container { display: flex; min-height: 100vh; }
        .container { flex: 1; margin-right: var(--sidebar-width); padding: 20px; transition: margin-right 0.3s ease; margin-top: var(--header-height); }
        .sidebar { width: var(--sidebar-width); background: #f5f7f9; height: 100vh; position: fixed; right: 0; top: 0; box-shadow: var(--shadow); padding: 0; overflow: hidden; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { text-align: center; padding: 20px; padding-bottom: 15px; border-bottom: 2px solid #d0d4d8; height: var(--header-height); flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: #f5f7f9; }
        .sidebar-scrollable-content { flex: 1; overflow-y: auto; padding: 20px; }
        .sidebar-header h1 { color: var(--sidebar-text); font-size: 1.5em; margin-bottom: 5px; }
        .sidebar-header .subtitle { color: #bdc3c7; font-size: 0.9em; }
        .sidebar-nav { display: flex; flex-direction: column; gap: 5px; }
        .sidebar-nav button { padding: 12px 15px; border: none; background: transparent; color: #2c3e50; border-radius: var(--border-radius); cursor: pointer; font-size: calc(var(--font-size) * 0.9); font-weight: 500; transition: all 0.3s ease; text-align: right; border: 1px solid transparent; width: 100%; }
        .sidebar-nav button:hover { background: rgba(59, 125, 195, 0.1); transform: translateX(-3px); color: #3b7dc3; border-color: #3b7dc3; }
    .sidebar-nav button.active { background: #3b7dc3; color: white; border-color: #3b7dc3; }
    .sidebar-subsection { padding-right: 15px; margin-top: 5px; display: none; }
    .sidebar-subsection.show { display: block; }
    .sidebar-subsection button { padding: 10px 15px; font-size: calc(var(--font-size) * 0.85); background: rgba(59, 125, 195, 0.08); margin-bottom: 3px; }
    .sidebar-nav button.has-subsection::after { content: 'â–¼'; float: left; font-size: 0.7em; transition: transform 0.3s; }
    .sidebar-nav button.has-subsection.expanded::after { transform: rotate(180deg); }
        .user-section { margin-top: 25px; padding: 15px; background: rgba(59, 125, 195, 0.08); border-radius: var(--border-radius); border: 1px solid rgba(59, 125, 195, 0.15); text-align: center; }
    /* Ø´Ø§Ø±Ø© Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
    .current-user { background: #2c3e50; color: #ecf0f1; padding: 12px; border-radius: var(--border-radius); font-weight: bold; font-size: 0.95em; line-height: 1.4; }
    .current-user .user-name { display: block; font-size: 1em; margin-bottom: 6px; }
    .current-user .user-description { display: block; font-size: 0.85em; opacity: 0.85; }
    /* Ø£Ù„ÙˆØ§Ù† Ù…Ø®ØµØµØ© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± */
    .current-user.role-admin { background: var(--success-color); color: #fff; }
    .current-user.role-manager { background: #2c78d0; color: #fff; }
    .current-user.role-user { background: #2980b9; color: #fff; }
        .header { position: fixed; top:0; right: var(--sidebar-width); left:0; display: flex; align-items: center; justify-content: center; padding: 30px 40px; background: #3b7dc3; border-radius: 0; box-shadow: var(--shadow); color: white; height: var(--header-height); z-index: 90; margin:0; }
        .header-logo { position: absolute; right: 30px; top: 50%; transform: translateY(-50%); width: 80px; height: 80px; object-fit: contain; border-radius: 8px; background: white; padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .header-content { text-align: center; flex: 1; }
        .header h1 { color: white; font-size: calc(var(--font-size) * 2); margin-bottom: 10px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .header .subtitle { color: rgba(255,255,255,0.95); font-size: calc(var(--font-size) * 1.1); }
        .developer-credit { position: absolute; left: 20px; bottom: 20px; color: rgba(255,255,255,0.85); font-size: calc(var(--font-size) * 0.8); font-style: italic; }
    .design-toggle { position: fixed; top: 20px; left: 20px; background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; font-size: 20px; box-shadow: var(--shadow); transition: all 0.3s ease; z-index: 101; }
    .design-toggle:hover { transform: scale(1.1); background: var(--secondary-color); }
        .control-panel { 
            position: fixed; 
            top: 20px; 
            right: calc(var(--sidebar-width) + 20px); 
            background: white; 
            padding: 20px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow); 
            z-index: 1000; 
            max-width: 300px; 
            max-height: 85vh; 
            overflow-y: auto; 
            display: none; 
        }
        .control-panel.show { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .control-panel h3 { color: var(--primary-color); margin-bottom: 15px; text-align: center; font-size: 1.1em; }
        .control-group { margin-bottom: 12px; }
        .control-group label { display: block; margin-bottom: 4px; font-weight: 600; color: var(--secondary-color); font-size: 0.9em; }
        .color-picker { width: 100%; height: 35px; border: none; border-radius: 5px; cursor: pointer; }
        .font-size-control { width: 100%; }
        
        /* ØªØ­Ø³ÙŠÙ† Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .control-panel::-webkit-scrollbar {
            width: 6px;
        }
        .control-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .control-panel::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }
        .control-panel::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
        .section { display: none; background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 20px; min-height: 500px; }
        .section.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .section h2 { 
            color: var(--primary-color); 
            margin-bottom: 25px; 
            font-size: calc(var(--font-size) * 1.5); 
            border-bottom: 3px solid var(--primary-color); 
            padding-bottom: 10px; 
            display: flex; /* Use flexbox */
            justify-content: space-between; /* Space between title and card */
            align-items: center; /* Align items vertically */
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .settings-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e3f2fd;
            flex-wrap: wrap;
        }
        
        .settings-tab {
            padding: 15px 30px;
            background: linear-gradient(135deg, rgba(25, 118, 210, 0.1), rgba(66, 165, 245, 0.1));
            border: 2px solid rgba(25, 118, 210, 0.2);
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #1565c0;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .settings-tab:hover {
            background: linear-gradient(135deg, rgba(25, 118, 210, 0.2), rgba(66, 165, 245, 0.2));
            color: #0d47a1;
            border-color: rgba(25, 118, 210, 0.4);
        }
        
        .settings-tab.active {
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
            color: white;
            border-bottom: 3px solid #0d47a1;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }
        
        .settings-tab-content {
            display: none;
        }
        
        .settings-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .settings-grid { display: flex; flex-direction: column; gap: 25px; }
    .settings-card { background: #ffffff; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 25px; display: flex; flex-direction: column; gap: 20px; width: 100%; position: relative; overflow: hidden; }
    .logo-settings { min-height: 500px; }
    .logo-settings .tips-container { margin-top: auto; }
    .settings-card::before { content: ''; position: absolute; top: 0; right: 0; left: 0; height: 4px; background: linear-gradient(90deg, #1976d2, #42a5f5); }
        .settings-card h3 { margin-top: 0; }
        .settings-card .data-actions { margin: 0; }
        .settings-card .data-actions-grid { gap: 15px; }

        .user-selector-controls select,
        .activity-selector-controls select { width: 100%; max-width: 320px; }

        .title-stat-card {
            background-color: #fff;
            color: #1a3556;
            border: none;
            padding: 8px 18px 10px;
            border-radius: var(--border-radius);
            font-size: 0.9em;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .title-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        }

        .title-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px #FFD70099, 0 2px 8px rgba(0,0,0,0.08);
        }

        .title-stat-card .stat-mini-label {
            font-weight: normal;
            margin-left: 8px;
            color: #1a3556;
        }

        .title-stat-card .stat-mini-number {
            font-weight: 700;
            font-size: 1.2em;
        }

        .search-container { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .search-input { flex: 1; min-width: 200px; padding: 12px 15px; border: 2px solid #ddd; border-radius: var(--border-radius); font-size: calc(var(--font-size) * 0.95); transition: all 0.3s ease; font-family: var(--font-family); }
        .search-input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        
        /* Advanced Filters */
        .filters-container { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: var(--border-radius); 
            margin-bottom: 20px; 
            border: 2px solid #e0e0e0;
            display: none;
        }
        .filters-container.show { display: block; animation: slideIn 0.3s ease; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: calc(var(--font-size) * 0.9); color: #555; font-weight: 600; }
        .filter-input { 
            padding: 10px 12px; 
            border: 2px solid #ddd; 
            border-radius: var(--border-radius); 
            font-size: calc(var(--font-size) * 0.9);
            transition: all 0.3s ease;
            font-family: var(--font-family);
        }
        .filter-input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        .filter-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; }
        .toggle-filters-btn { 
            padding: 12px 24px; 
            background: rgba(135, 206, 250, 0.6); 
            color: #1565c0; 
            border: 1px solid rgba(135, 206, 250, 0.8); 
            border-radius: var(--border-radius); 
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: var(--font-family);
            box-shadow: 0 2px 5px rgba(135, 206, 250, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(5px);
        }
        .toggle-filters-btn:hover { 
            background: rgba(135, 206, 250, 0.8); 
            color: #0d47a1;
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(135, 206, 250, 0.4);
        }
        
        /* Sortable Table Headers */
        .sortable { 
            cursor: pointer; 
            user-select: none; 
            position: relative;
            transition: all 0.3s ease;
        }
        .sortable.asc::after { content: 'â†‘'; opacity: 1; color: #4CAF50; position: absolute; left: 8px; font-size: 0.8em; }
        .sortable.desc::after { content: 'â†“'; opacity: 1; color: #f44336; position: absolute; left: 8px; font-size: 0.8em; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 25px; }
        .stat-card { 
            background: white; 
            padding: 25px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow); 
            border-top: 5px solid var(--primary-color); 
            text-align: center; 
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
        }
        .stat-card h3 { color: var(--secondary-color); margin-bottom: 15px; font-size: calc(var(--font-size) * 1.1); }
        .stat-number { 
            font-size: calc(var(--font-size) * 2.5); 
            font-weight: bold; 
            color: var(--primary-color); 
            margin: 15px 0; 
        }
        .stat-label { 
            color: var(--secondary-color); 
            font-size: calc(var(--font-size) * 1);
            font-weight: 600;
        }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: calc(var(--font-size) * 0.95); }
        th { background: rgba(33, 150, 243, 0.1); color: #1565c0; padding: 15px; text-align: right; font-weight: 600; border: 1px solid rgba(33, 150, 243, 0.2); }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: right; }
        tr:hover { background: #f8f9fa; }
    .form-grid { display: grid; gap: 20px; margin-bottom: 30px; }
    .grid-5 { grid-template-columns: repeat(5, 1fr); }
    .grid-users { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .data-actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    @media (min-width: 768px) {
        .data-actions-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        input, select, textarea { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: var(--border-radius); font-size: calc(var(--font-size) * 0.95); transition: all 0.3s ease; font-family: var(--font-family); }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        button { padding: 10px 15px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: calc(var(--font-size) * 0.95); font-weight: 600; transition: all 0.3s ease; font-family: var(--font-family); }
    .btn-primary { background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; border: none; }
    .btn-primary:hover { background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(25, 118, 210, 0.4); }
    .btn-add { background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); color: white; border: none; }
    .btn-add:hover { background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4); }
    .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; }
    .btn-success:hover { background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4); }
    .btn-success.code-generator-btn { background: linear-gradient(135deg, #0277bd 0%, #01579b 100%); color: #ffffff; border: none; box-shadow: 0 2px 6px rgba(1, 87, 155, 0.3); }
    .btn-success.code-generator-btn:hover { background: linear-gradient(135deg, #01579b 0%, #01396a 100%); color: #ffffff; box-shadow: 0 4px 12px rgba(1, 87, 155, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #e53935 0%, #c62828 100%); color: white; border: none; }
        .btn-danger:hover { background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(229, 57, 53, 0.4); }
    .btn-secondary { background: linear-gradient(135deg, #5e92f3 0%, #4a7cda 100%); color: white; border: none; }
    .btn-secondary:hover { background: linear-gradient(135deg, #4a7cda 0%, #3667c5 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(74, 124, 218, 0.4); }
        .btn-info { background: #1abc9c; color: white; }
        .btn-info:hover { background: #16a085; transform: translateY(-2px); }
        #settings .data-actions-grid button { background: #005189; color: #ffffff; border: 1px solid #003f68; box-shadow: 0 2px 6px rgba(0, 81, 137, 0.2); }
        #settings .data-actions-grid button:hover { background: #004373; color: #ffffff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 81, 137, 0.3); }
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨ØªØ¯Ø±Ø¬ Ø£Ø²Ø±Ù‚ */
    .btn-warning { background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%); color: #ffffff; border: none; box-shadow: 0 2px 6px rgba(30, 136, 229, 0.3); }
    .btn-warning:hover { background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); color: #ffffff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4); }
    /* ØªØ®ØµÙŠØµ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨ØªØ¯Ø±Ø¬ Ø£Ø²Ø±Ù‚ */
    .btn-warning.edit-btn { background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%); color: #ffffff; border: none; box-shadow: 0 2px 6px rgba(30, 136, 229, 0.3); }
    .btn-warning.edit-btn:hover { background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); color: #ffffff; box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4); }
    /* ØªØ®ØµÙŠØµ Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨ØªØ¯Ø±Ø¬ Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ */
    .btn-warning.backup-btn { background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); color: #ffffff; border: none; box-shadow: 0 2px 6px rgba(66, 165, 245, 0.3); }
    .btn-warning.backup-btn:hover { background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%); color: #ffffff; box-shadow: 0 4px 12px rgba(66, 165, 245, 0.4); }
      .remaining-unpaid { 
    color: var(--accent-color); /* Ø£Ø­Ù…Ø± - Ø¹Ù„ÙŠÙ‡ Ù…Ø¨Ù„Øº */
    font-weight: bold; 
}
.remaining-paid { 
    color: var(--text-color); /* Ø£Ø³ÙˆØ¯/Ø¹Ø§Ø¯ÙŠ - Ø§Ù„Ø±ØµÙŠØ¯ ØµÙØ± */
    font-weight: normal; 
}
.remaining-credit { 
    color: var(--success-color); /* Ø£Ø®Ø¶Ø± - Ù„Ù‡ Ø±ØµÙŠØ¯ */
    font-weight: bold; 
}
        .report-controls { display: block; margin-bottom: 20px; }
        .report-controls .form-grid label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--secondary-color); }
        .report-controls select, .report-controls input[type="date"] { width: 100%; padding: 12px; font-size: 14px; border: 2px solid #ddd; border-radius: var(--border-radius); }
        .report-controls button { min-width: 150px; }
        .export-options { display: flex; gap: 10px; margin-top: 20px; }
        .report-summary { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: var(--border-radius); }
        .invoice-print { display: none; background: white; padding: 30px; direction: rtl; max-width: 800px; margin: 20px auto; }
        /* ØªØ­Ø³ÙŠÙ† Ù…Ù†Ø·Ù‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„ÙŠØ¹Ù…Ù„ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„ÙŠØ³Øª Ø£Ø¨Ù†Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø±ÙŠÙ† Ù„Ù€ body */
        @media print {
            /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¸Ø§Ù‡Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¢Ø¨Ø§Ø¡ */
            #saleInvoicePrint, #purchaseInvoicePrint { display: block !important; }
            .no-print { display: none !important; }
        }
        .invoice-header-print { display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #2c5aa0; }
        .invoice-details { margin: 20px 0; }
        .invoice-items-print table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 1.1em; }
        .invoice-items-print th { background: #e3f2fd; color: #2c5aa0; padding: 12px; text-align: right; font-size: 1.1em; }
        .invoice-items-print th:nth-child(1) { width: 50%; } /* Ø§Ù„ØµÙ†Ù */
        .invoice-items-print th:nth-child(2) { width:35%; text-align: center; } /* Ø§Ù„ÙƒÙ…ÙŠØ© */
        .invoice-items-print th:nth-child(3) { width: 35%; text-align: center; } /* Ø§Ù„Ø³Ø¹Ø± */
        .invoice-items-print th:nth-child(4) { width: 35%; text-align: left; } /* Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ */
        .invoice-items-print td { padding: 10px 12px; border-bottom: 1px solid #ddd; text-align: right; font-size: 1.05em; }
        .invoice-items-print td:nth-child(2) { text-align: center; } /* Ø§Ù„ÙƒÙ…ÙŠØ© */
        .invoice-items-print td:nth-child(3) { text-align: center; } /* Ø§Ù„Ø³Ø¹Ø± */
        .invoice-items-print td:nth-child(4) { text-align: left; direction: ltr; } /* Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ */
    .invoice-totals { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .invoice-totals > div { display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 8px; }
    .invoice-totals > div.total { font-weight: bold; font-size: 1.1em; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; }
    .invoice-totals > div span:last-child { min-width: 120px; text-align: left; direction: ltr; display: inline-block; }
    .invoice-totals input[type="number"] { width: 120px; flex: 0 0 120px; text-align: left; direction: ltr; }
    .invoice-totals select { width: 120px; flex: 0 0 120px; text-align: right; direction: rtl; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .invoice-totals-print { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .invoice-totals-print div { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .invoice-totals-print .total { font-weight: bold; font-size: 1.1em; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; }
        .code-generator-btn { padding: 10px 15px; font-size: calc(var(--font-size) * 0.9); width: auto; min-width: 120px; }
        .user-management { background: #f8f9fa; padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; }
        .user-card { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 15px; border-right: 4px solid var(--primary-color); }
    #settings .user-selector { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 20px; }
    #settings .user-selector-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px; }
    #settings .user-selector-controls select { flex: 1 1 220px; min-width: 200px; padding: 12px; border: 2px solid #ddd; border-radius: var(--border-radius); font-family: var(--font-family); }
    #settings .selected-user-info { display: none; gap: 12px; align-items: center; flex-wrap: nowrap; }
    #settings .selected-user-grid { display: flex; gap: 12px; flex-wrap: nowrap; overflow-x: auto; align-items: center; padding-bottom: 5px; }
    #settings .selected-user-field { flex: 0 0 170px; }
    #settings .selected-user-field.role-field { flex: 0 0 120px; }
    #settings .selected-user-field.phone-field { flex: 0 0 140px; }
    #settings .selected-user-field label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--secondary-color); }
    #settings .selected-user-field input { width: 100%; padding: 8px 10px; border: 2px solid #ddd; border-radius: var(--border-radius); background: #f5f7fb; font-family: var(--font-family); font-size: 0.9em; color: #2c3e50; }
    #settings .selected-user-actions { display: flex; gap: 10px; align-items: center; flex: 0 0 auto; margin-top: 22px; }
    #settings .selected-user-actions button { flex: 0 0 120px; max-width: 130px; padding: 8px 10px; }
    #settings .activity-selector { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 20px; }
    #settings .activity-selector-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px; }
    #settings .activity-selector-controls select { flex: 1 1 220px; min-width: 200px; padding: 12px; border: 2px solid #ddd; border-radius: var(--border-radius); font-family: var(--font-family); }
    #settings .selected-activity-info { display: none; gap: 12px; align-items: center; flex-wrap: nowrap; }
    #settings .selected-activity-field { flex: 0 0 220px; }
    #settings .selected-activity-field label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--secondary-color); }
    #settings .selected-activity-field input { width: 100%; padding: 8px 10px; border: 2px solid #ddd; border-radius: var(--border-radius); background: #f5f7fb; font-family: var(--font-family); font-size: 0.9em; color: #2c3e50; }
    #settings .selected-activity-actions { display: flex; gap: 10px; align-items: center; flex: 0 0 auto; margin-top: 30px; }
    #settings .selected-activity-actions button { flex: 0 0 120px; max-width: 130px; padding: 8px 10px; }
        .user-role { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; margin-right: 10px; }
    .role-admin { background: #e74c3c; color: white; }
    .role-manager { background: #2c78d0; color: white; }
        .role-user { background: #3498db; color: white; }
        .role-viewer { background: #95a5a6; color: white; }
        .user-status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 10px; }
        .status-active { background: #27ae60; }
        .status-inactive { background: #e74c3c; }
        
        /* ===== ğŸ’° Payment System Styles - Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease;
        }
        
        .payment-modal {
            max-width: 700px;
        }
        
        .payments-history-modal {
            max-width: 900px;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #1565c0);
            color: white;
            padding: 20px 25px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.3em;
        }
        
        .modal-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
        }
        
        .payment-info-card {
            background: linear-gradient(135deg, #e3f2fd, #f5f9ff);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .payment-info-card p {
            margin: 10px 0;
            font-size: 1.05em;
        }
        
        .payment-info-card .remaining-amount {
            font-size: 1.2em;
            color: var(--accent-color);
            font-weight: bold;
            border-top: 2px solid #ddd;
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .payment-summary-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .summary-row:last-child {
            border-bottom: none;
        }
        
        .payment-details-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { 
                opacity: 0; 
                transform: scale(0.9) translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }
        
        @media (max-width: 1024px) { 
            .sidebar { width: 250px; } 
            .container { margin-right: 250px; } 
            .control-panel { 
                right: calc(250px + 20px); 
                max-height: 80vh; 
            } 
        }
        @media (max-width: 768px) { 
            * { max-width: 100vw; }
            body { flex-direction: column; overflow-x: hidden; width: 100%; } 
            .sidebar { position: fixed; width: 100%; height: 100vh; max-height: 100vh; overflow-y: auto; box-shadow: none; transform: translateX(100%); transition: transform 0.3s ease; padding: 15px; } 
            .sidebar.open { transform: translateX(0); } 
            .container { max-width: 100vw; width: 100%; margin-right: 0; padding: 10px 5px; overflow-x: hidden; box-sizing: border-box; } 
            .control-panel { right: 10px; } 
            .nav { flex-direction: column; } 
            .nav button { width: 100%; } 
            .form-grid { grid-template-columns: 1fr !important; gap: 10px; padding: 0; } 
            .form-grid input, .form-grid select, .form-grid textarea { width: 100%; max-width: 100%; box-sizing: border-box; }
            .control-panel { 
                position: fixed; 
                top: 0; 
                right: 0; 
                left: 0; 
                bottom: 0; 
                max-width: 100vw; 
                max-height: 100vh; 
                z-index: 2000; 
                overflow-y: auto; 
                padding: 15px; 
            } 
            .design-toggle { position: fixed; top: 20px; left: 20px; z-index: 2001; } 
            .invoice-header { flex-direction: column; gap: 10px; align-items: stretch; } 
            .report-controls { flex-direction: column; align-items: stretch; gap: 8px; } 
            .report-controls select, .report-controls input, .report-controls button { width: 100%; max-width: 100%; box-sizing: border-box; } 
            .invoice-header-print { flex-direction: column; gap: 10px; } 
            .search-container { flex-direction: column; gap: 10px; } 
            .search-container input { width: 100%; }
            .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr !important; } 
            .section { padding: 15px 10px; overflow-x: auto; max-width: 100vw; } 
            .section > * { max-width: 100%; }
            table { font-size: 12px; display: block; overflow-x: auto; width: 100%; } 
            th, td { padding: 6px 4px; white-space: nowrap; font-size: 11px; } 
            .invoice-items { overflow-x: auto; -webkit-overflow-scrolling: touch; max-width: 100%; } 
            .invoice-items table { min-width: 500px; display: table; }
            .invoice-totals { padding: 10px; font-size: 14px; }
            .action-buttons { flex-wrap: wrap; gap: 5px; justify-content: center; }
            .action-buttons button { min-width: 70px; padding: 6px 10px; font-size: 12px; }
            button, .btn { padding: 8px 12px; font-size: 13px; }
            
            /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */
            .advanced-stats { 
                display: flex !important; 
                flex-direction: column !important; 
                gap: 15px !important; 
            }
            .advanced-stats .stat-card { 
                width: 100% !important; 
                aspect-ratio: auto !important;
                padding: 20px !important; 
                min-height: 100px;
            }
            .advanced-stats .stat-number { font-size: 2em !important; }
            .advanced-stats .stat-label { font-size: 1em !important; }
            
            /* Ø¥ØµÙ„Ø§Ø­ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
            .charts-container {
                display: flex !important;
                flex-direction: column !important;
                gap: 20px !important;
            }
            .chart-card {
                width: 100% !important;
                height: auto !important;
                min-height: 300px;
                padding: 15px !important;
            }
            .chart-card canvas {
                height: 250px !important;
                max-height: 250px !important;
            }
        }
    .sidebar-toggle { display: none; position: fixed; top: 20px; right: 20px; background: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 10px 15px; cursor: pointer; z-index: 102; }
        @media (max-width: 768px) { .sidebar-toggle { display: block; } 


    }
@media (max-width: 640px) {
    .section {
        overflow-x: visible;
    }

    .section table {
        min-width: 100%;
        display: block;
        border: none;
        background: transparent;
    }

    .section thead {
        display: none;
    }

    .section tbody {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .section tbody tr {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        background: #ffffff;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 14px;
        border: 1px solid #e5e9f2;
    }

    .section tbody tr:hover {
        background: #f8f9fa;
    }

    .section tbody td {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
        border: none;
        text-align: right;
    }

    .section tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--secondary-color);
        flex-shrink: 0;
        min-width: 50px;
        font-size: 0.85em;
    }
    
    /* Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø§Ø³Ù… */
    .section tbody td:nth-child(1),
    .section tbody td:nth-child(2) {
        grid-column: span 1;
    }
    
    /* Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ */
    .section tbody td:nth-child(3),
    .section tbody td:nth-child(4) {
        grid-column: span 1;
    }
    
    /* Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
    .section tbody td:nth-child(5) {
        grid-column: 1;
    }
    
    .section tbody td:last-child {
        grid-column: 2;
        justify-content: flex-start;
        gap: 6px;
        flex-wrap: nowrap;
        flex-direction: row;
    }

    .section tbody td button,
    .section tbody td .btn {
        flex: 0 0 auto;
        min-width: 65px;
        padding: 6px 12px;
        font-size: 11px;
        white-space: nowrap;
    }
}






        /* === START: CSS for new Returns section === */
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

      .btn-whatsapp {
    background-color: #25D366; /* Ù„ÙˆÙ† ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø£Ø®Ø¶Ø± */
    color: white;
}
.btn-whatsapp:hover {
    background-color: #128C7E; /* Ù„ÙˆÙ† Ø£ØºÙ…Ù‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ£Ø´ÙŠØ± */
    transform: translateY(-2px);
}

        .email-btn {
            background-color: #221658;
            color: #ffffff;
            border: 1px solid #1a1246;
            box-shadow: 0 2px 6px rgba(34, 22, 88, 0.25);
        }

        .email-btn:hover {
            background-color: #1b124e;
            color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 22, 88, 0.35);
        }

      
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--secondary-color);
            position: relative;
            bottom: -2px;
        }
        .tab-button.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .return-invoice-details {
            background-color: #f8f9fa;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        .return-invoice-details p { margin-bottom: 5px; }
        .return-item-qty-input { width: 80px !important; padding: 8px !important; text-align: center;}
        /* === END: CSS for new Returns section === */

        .users-settings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-settings-table th,
        .users-settings-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            text-align: right;
        }

        .users-settings-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .users-settings-table tr:hover {
            background: #f8f9fa;
        }

        .activities-management table td:last-child {
            white-space: nowrap !important;
            min-width: 120px !important;
        }

        .activities-management .btn-danger, .activities-management .btn-warning {
            margin: 2px;
            padding: 8px 12px !important;
            font-size: 0.9em !important;
        }

        @media (max-width: 768px) {
            .activities-management table td:last-child {
                min-width: 100px !important;
            }
            
            .activities-management .btn-danger, .activities-management .btn-warning {
                padding: 6px 10px !important;
                font-size: 0.85em !important;
            }
        }



        @media (max-width: 768px) {
            .users-settings-table {
                font-size: 0.9em;
            }
            
            .users-settings-table th,
            .users-settings-table td {
                padding: 8px 10px;
            }
            
            .users-settings-table td:last-child {
                min-width: 100px;
            }
        }

        .report-total-row { background-color: var(--primary-color) !important; color: white !important; font-weight: bold !important; font-size: 1.1em !important; }
        .report-total-row td { padding: 15px !important; border-bottom: 2px solid var(--secondary-color) !important; }
   
        .users-settings-table td:last-child,
        .activities-management table td:last-child {
            white-space: nowrap !important;
            min-width: 120px !important;
            text-align: left !important;
        }

        .users-settings-table .btn-danger {
            margin: 2px;
            padding: 8px 12px !important;
        }

        /* === START: CSS for new Salaries section === */
        #salaries .form-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }

        .salary-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: var(--border-radius);
            border-left: 5px solid var(--primary-color);
        }

        .salary-card h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .salary-summary {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            font-size: 1.05em;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item span:first-child {
            font-weight: 600;
            color: var(--secondary-color);
        }

        .summary-item span:last-child {
            font-weight: bold;
        }

        .summary-total {
            font-size: 1.3em;
            color: var(--primary-color);
            border-top: 2px solid var(--primary-color);
            margin-top: 10px;
            padding-top: 15px;
        }
        
        .gosi-deduction {
            color: var(--accent-color);
        }

        .net-salary {
            color: var(--success-color);
        }

        .salary-actions {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        /* === END: CSS for new Salaries section === */

        @media (max-width: 768px) {
            .users-settings-table td:last-child,
            .activities-management table td:last-child {
                min-width: 100px !important;
            }
            
            .users-settings-table .btn-danger {
                padding: 6px 10px !important;
                font-size: 0.85em !important;
            }
        }
        #sales td.actions-cell {
            text-align: center !important;
            min-width: 240px !important;
        }

        #sales td.actions-cell .action-buttons {
            justify-content: center;
            flex-wrap: wrap;
        }

        #sales td.actions-cell .action-buttons button {
            flex: 1 1 110px;
            margin: 2px !important;
            padding: 8px 10px !important;
            font-size: 0.85em !important;
        }

/* === ØªÙ†Ø³ÙŠÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ === */
.action-buttons {
    display: flex; /* ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¯Ø§Ø®Ù„Ù‡ Ù…Ø±Ù†Ø© ÙˆÙ…ØªØ¬Ø§ÙˆØ±Ø© */
    gap: 10px;      /* ÙŠØ¶ÙŠÙ Ù…Ø³Ø§ÙØ© 5 Ø¨ÙƒØ³Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    min-width: 80px; /* ÙŠØ¶Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
}

.action-buttons button {
    flex: 1;       /* ÙŠØ¬Ø¹Ù„ ÙƒÙ„ Ø²Ø± ÙŠØ£Ø®Ø° Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ù… Ù„ÙŠÙ…Ù„Ø£ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© */
    padding: 6px 8px; /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„Ø²Ø± Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø­Ø¬Ù… */
    font-size: 0.9em; /* ØªØµØºÙŠØ± Ø·ÙÙŠÙ Ù„Ø­Ø¬Ù… Ø§Ù„Ø®Ø· */
}

/* Ø¥ØµÙ„Ø§Ø­ Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ´Ø§Ù…Ù„ Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width: 768px) {

    /* 1. Ø¥Ø¬Ø¨Ø§Ø± Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¸Ù‡ÙˆØ± */
    .sidebar-toggle {
        display: block !important;
    }

    /* 2. Ø¥ØµÙ„Ø§Ø­ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
    #items td .action-buttons,
    #customers td .action-buttons,
    #suppliers td .action-buttons,
    #purchases td .action-buttons,
    #sales td .action-buttons,
    #returns td .action-buttons,
    #expenses td .action-buttons,
    #revenues td .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    /* Ø£ÙƒÙˆØ§Ø¯ Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¬Ø§ÙˆØ¨ */
    body { flex-direction: column; }
    .sidebar { position: fixed; width: 100%; height: auto; box-shadow: none; transform: translateX(100%); transition: transform 0.3s ease; z-index: 2000; }
    .sidebar.open { transform: translateX(0); }
    .container { max-width: 100%; margin-right: 0; padding: 10px; }
    .form-grid, .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
    .search-container { flex-direction: column; }

    .form-grid button {
        font-size: 0.9em;
        padding: 10px;
    }
    
    .search-input {
        font-size: 0.9em;
        padding: 10px;
    }
    
    /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
    .charts-container {
        overflow-x: auto;
        padding-bottom: 10px;
    }
    
    .chart-card {
        min-width: 300px;
        flex-shrink: 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #items table {
        display: block;
        overflow-x: auto;
    }

    #items thead {
        display: none;
    }

    #items tbody {
        display: block;
    }

    #items tr {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-areas:
            "code name stock"
            "cost price price"
            "actions actions actions";
        row-gap: 8px;
        column-gap: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #items td {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 6px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
    }

    #items td::before {
        content: attr(data-label) " :";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
    }

    #items td[data-label="Ø§Ù„ÙƒÙˆØ¯"] { grid-area: code; }
    #items td[data-label="Ø§Ù„Ø§Ø³Ù…"] { grid-area: name; }
    #items td[data-label="Ø§Ù„Ø±ØµÙŠØ¯"] { grid-area: stock; }

    #items td[data-label="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡"] { grid-area: cost; }
    #items td[data-label="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹"] { grid-area: price; }

    #items td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        margin-top: 6px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #items td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #items td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        gap: 12px;
        width: 100%;
    }

    #items td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] button {
        flex: 1;
        font-size: 0.95em;
        padding: 11px 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #customers table {
        display: block;
        overflow-x: auto;
    }

    #customers thead {
        display: none;
    }

    #customers tbody {
        display: block;
    }

    #customers tr {
        display: grid;
        grid-template-columns: minmax(110px, auto) 1fr;
        grid-template-areas:
            "code name"
            "phone email"
            "address address"
            "actions actions";
        column-gap: 10px;
        row-gap: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #customers td {
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        gap: 6px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
    }

    #customers td::before {
        content: attr(data-label) " :";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
    }

    #customers td[data-label="Ø§Ù„ÙƒÙˆØ¯"] { grid-area: code; }
    #customers td[data-label="Ø§Ù„Ø§Ø³Ù…"] { grid-area: name; }
    #customers td[data-label="Ø§Ù„Ù‡Ø§ØªÙ"] { grid-area: phone; }
    #customers td[data-label="Ø§Ù„Ø¨Ø±ÙŠØ¯"] { grid-area: email; }
    #customers td[data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] {
        grid-area: address;
        word-break: break-word;
        margin-top: 6px;
    }

    #customers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        margin-top: 8px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #customers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #customers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    #customers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] button {
        width: 100%;
        font-size: 0.9em;
        padding: 9px 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #suppliers table {
        display: block;
        overflow-x: auto;
    }

    #suppliers thead {
        display: none;
    }

    #suppliers tbody {
        display: block;
    }

    #suppliers tr {
        display: grid;
        grid-template-columns: minmax(110px, auto) 1fr;
        grid-template-areas:
            "code name"
            "phone email"
            "address address"
            "actions actions";
        column-gap: 10px;
        row-gap: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #suppliers td {
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        gap: 6px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
    }

    #suppliers td::before {
        content: attr(data-label) " :";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
    }

    #suppliers td[data-label="Ø§Ù„ÙƒÙˆØ¯"] { grid-area: code; }
    #suppliers td[data-label="Ø§Ù„Ø§Ø³Ù…"] { grid-area: name; }
    #suppliers td[data-label="Ø§Ù„Ù‡Ø§ØªÙ"] { grid-area: phone; }
    #suppliers td[data-label="Ø§Ù„Ø¨Ø±ÙŠØ¯"] { grid-area: email; }
    #suppliers td[data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] {
        grid-area: address;
        word-break: break-word;
        margin-top: 6px;
    }

    #suppliers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        margin-top: 8px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #suppliers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #suppliers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    #suppliers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] button {
        width: 100%;
        font-size: 0.9em;
        padding: 9px 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #purchases table {
        display: block;
        overflow-x: auto;
    }

    #purchases thead {
        display: none;
    }

    #purchases tbody {
        display: block;
    }

    #purchases tr {
        display: grid;
        grid-template-columns: max-content max-content minmax(0, 1fr) minmax(0, 1fr);
        grid-template-areas:
            "number date supplier supplier"
            "quantity total paid paid"
            "remaining remaining remaining remaining"
            "actions actions actions actions";
        column-gap: 2px;
        row-gap: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #purchases td {
        display: flex;
        align-items: baseline;
        justify-content: flex-start;
        gap: 4px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
        min-width: 0;
        direction: rtl;
    }

    #purchases td::before {
        content: attr(data-label) ":";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
        background: transparent;
        flex-shrink: 0;
        display: inline-block;
    }
    #purchases td[data-label="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©"] {
        grid-area: number;
        white-space: nowrap;
    }
    #purchases td[data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®"] {
        grid-area: date;
        white-space: nowrap;
        margin-inline-start: 12px;
    }
    #purchases td[data-label="Ø§Ù„Ù…ÙˆØ±Ø¯"] {
        grid-area: supplier;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #purchases td[data-label="Ø§Ù„ÙƒÙ…ÙŠØ©"] {
        grid-area: quantity;
        white-space: nowrap;
    }
    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"] {
        grid-area: total;
        white-space: nowrap;
        margin-inline-end: 12px;
    }
    #purchases td[data-label="Ø§Ù„Ù…Ø¯ÙÙˆØ¹"] {
        grid-area: paid;
        white-space: nowrap;
        margin-inline-end: 12px;
    }
    #purchases td[data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ"] {
        grid-area: remaining;
        font-weight: 600;
        white-space: nowrap;
        justify-content: flex-start;
        padding-top: 6px;
        border-top: 1px solid #eee;
    }

    #purchases td[data-label="Ø§Ù„Ù…ÙˆØ±Ø¯"] {
        justify-content: flex-start;
        direction: rtl;
        text-align: right;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        margin-top: 6px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
    }

    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons button {
        width: 100%;
        font-size: 0.85em;
        padding: 8px 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #sales table {
        display: block;
        overflow-x: auto;
    }

    #sales thead {
        display: none;
    }

    #sales tbody {
        display: block;
    }

    #sales tr {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-areas:
            "number number date"
            "customer customer quantity"
            "total paid remaining"
            "actions actions actions";
        column-gap: 8px;
        row-gap: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #sales td {
        display: flex;
        align-items: baseline;
        justify-content: flex-start;
        gap: 4px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
        min-width: 0;
        direction: rtl;
    }

    #sales td::before {
        content: attr(data-label) ":";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
        background: transparent;
        flex-shrink: 0;
        display: inline-block;
    }

    #sales td[data-label="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©"] {
        grid-area: number;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®"] {
        grid-area: date;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„"] {
        grid-area: customer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #sales td[data-label="Ø§Ù„ÙƒÙ…ÙŠØ©"] {
        grid-area: quantity;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"] {
        grid-area: total;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„Ù…Ø¯ÙÙˆØ¹"] {
        grid-area: paid;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ"] {
        grid-area: remaining;
        font-weight: 600;
        white-space: nowrap;
        justify-content: flex-start;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons button {
        width: 100%;
        font-size: 0.85em;
        padding: 8px 0;
    }

}

@media (max-width: 480px) {
    /* Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ */
    * { font-size: 14px; }
    
    .analytics-card {
        min-width: 100%;
        margin: 0;
    }
    
    .chart-card {
        min-width: 100%;
        padding: 10px;
    }
    
    .container { padding: 5px 2px; }
    
    .section { padding: 10px 5px; }
    
    table { font-size: 10px; }
    
    th, td { padding: 4px 2px; font-size: 10px; }
    
    .form-grid input, .form-grid select, .form-grid textarea { 
        font-size: 14px;
        padding: 6px 8px;
    }
    
    .action-buttons button { 
        font-size: 11px;
        padding: 5px 8px;
        min-width: 60px;
    }
    
    .btn { 
        font-size: 12px;
        padding: 6px 10px;
    }
    
    h2 { font-size: 1.3em; }
    h3 { font-size: 1.1em; }
    
    .sidebar { font-size: 14px; }
    
    .nav button { font-size: 13px; padding: 8px; }
    
    .invoice-items table { min-width: 400px; }
    
    /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„ÙƒØ´ÙˆÙ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© */
    .account-statement-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        font-size: 14px;
        background: white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .account-statement-table th {
        background: linear-gradient(135deg, #4a90e2, #357abd);
        color: white;
        font-weight: 600;
        padding: 12px 10px;
        text-align: center;
        border-right: 1px solid rgba(255,255,255,0.2);
    }
    
    .account-statement-table td {
        padding: 10px;
        text-align: center;
        border-bottom: 1px solid #e5e5e5;
        border-right: 1px solid #e5e5e5;
    }
    
    .account-statement-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .account-statement-table tr:hover {
        background-color: #e7f3ff;
        transition: background-color 0.3s ease;
    }
    
    .remaining-unpaid {
        color: #dc3545;
        font-weight: 600;
    }
    
    .remaining-paid {
        color: #28a745;
        font-weight: 600;
    }
    
    .account-statement-summary {
        margin: 20px 0;
        background: transparent;
    }
    
    #statementSummary {
        background: transparent;
        border: none;
        border-radius: 0;
        padding: 0;
        margin: 20px 0;
        box-shadow: none;
    }
    
    #statementSummary h4 {
        color: #495057;
        margin-bottom: 10px;
        text-align: center;
        font-size: 16px;
    }
    
    #statementSummary p {
        margin: 5px 0;
        padding: 5px 10px;
        background: white;
        border-radius: 5px;
        border-left: 4px solid #4a90e2;
    }
    
    #statementResults {
        margin-top: 20px;
    }
    
    #statementResults h3 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 20px;
        font-size: 18px;
    }
    
    .statement-controls {
        display: flex !important;
        gap: 5px !important;
        margin-bottom: 20px !important;
        flex-wrap: nowrap !important;
        align-items: center !important;
        overflow-x: auto !important;
        white-space: nowrap !important;
        flex-direction: row !important;
    }
    
    .statement-controls select,
    .statement-controls input[type="date"] {
        width: auto !important;
        max-width: 120px !important;
        min-width: 80px !important;
        padding: 4px 6px !important;
        border: 1px solid #ddd !important;
        border-radius: 3px !important;
        font-size: 11px !important;
        flex-shrink: 0 !important;
        white-space: nowrap !important;
        display: inline-block !important;
    }
    
    .statement-controls button {
        min-width: 80px !important;
        padding: 4px 8px !important;
        font-size: 11px !important;
        flex-shrink: 0 !important;
        white-space: nowrap !important;
        display: inline-block !important;
    }
    
    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù„Ø®Øµ Ø§Ù„ÙƒØ´ÙˆÙ - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø«Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
    .statement-summary-cards {
        display: grid !important;
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 20px !important;
        margin: 20px 0 !important;
        width: 100% !important;
    }
    
    .summary-card {
        background: white !important;
        padding: 20px 15px !important;
        border-radius: 12px !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
        border-top: 5px solid #3498db !important;
        text-align: center !important;
        transition: all 0.3s ease !important;
        position: relative !important;
        overflow: hidden !important;
        min-height: 180px !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        align-items: center !important;
    }
    
    .summary-card:hover {
        transform: translateY(-5px) !important;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important;
    }
    
    .summary-card.sales {
        border-top-color: #667eea !important;
    }
    
    .summary-card.paid {
        border-top-color: #28a745 !important;
    }
    
    .summary-card.remaining {
        border-top-color: #17a2b8 !important;
    }
    
    .summary-card.profit {
        border-top-color: #ffc107 !important;
    }
    
    .summary-card.warning {
        border-top-color: #dc3545 !important;
    }
    
    .summary-card .card-value {
        font-size: 2.4em !important;
        font-weight: bold !important;
        color: #3498db !important;
        margin: 10px 0 !important;
    }
    
    .summary-card .card-title {
        font-size: 1.1em !important;
        margin-bottom: 8px !important;
        font-weight: 500 !important;
        color: #666 !important;
    }
    
    .summary-card .card-currency {
        font-size: 0.6em !important;
        color: #888 !important;
        font-weight: normal !important;
    }
    
    .summary-card .card-growth {
        position: absolute !important;
        bottom: 8px !important;
        right: 8px !important;
        font-size: 0.85em !important;
        display: flex !important;
        align-items: center !important;
        gap: 3px !important;
        color: #666 !important;
    }
    
    .summary-card .card-icon {
        position: absolute !important;
        bottom: 8px !important;
        left: 8px !important;
        font-size: 1.5em !important;
        opacity: 0.6 !important;
        color: #888 !important;
    }
    
    .summary-card .growth-icon {
        font-size: 1em !important;
    }
    
    @media (max-width: 768px) {
        .statement-summary-cards {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .summary-card {
            padding: 20px;
            min-height: 120px;
        }
        
        .summary-card .card-value {
            font-size: 2em;
        }
        
        .summary-card .card-icon {
            font-size: 2em;
            bottom: 10px;
            left: 10px;
        }
        
        .summary-card .card-title {
            font-size: 0.9em;
        }
        
        .summary-card .card-growth {
            bottom: 10px;
            right: 10px;
            font-size: 0.8em;
        }
    }
    
    @media (max-width: 480px) {
        .statement-summary-cards {
            grid-template-columns: 1fr;
        }
    }
    
    .statement-export-buttons {
        text-align: center;
        margin: 20px 0;
    }
    
    .statement-export-buttons button {
        margin: 0 10px;
        padding: 10px 20px;
        font-size: 14px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .statement-export-buttons .btn-excel {
        background: #28a745;
        color: white;
    }
    
    .statement-export-buttons .btn-excel:hover {
        background: #218838;
    }
    
    .statement-export-buttons .btn-print {
        background: #6c757d;
        color: white;
    }
    
    .statement-export-buttons .btn-print:hover {
        background: #5a6268;
    }
    
    /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© */
    @media (max-width: 400px) {
        .account-statement-table {
            font-size: 12px;
            overflow-x: auto;
            display: block;
            white-space: nowrap;
        }
        
        .account-statement-table th,
        .account-statement-table td {
            padding: 8px 6px;
            min-width: 80px;
        }
        
        #statementSummary {
            padding: 0;
            margin: 15px 0;
        }
        
        .account-statement-summary {
            margin: 15px 0;
        }
        
        .statement-controls {
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
        }
        
        .statement-controls select,
        .statement-controls input[type="date"],
        .statement-controls button {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            margin: 5px 0;
        }
        
        .statement-export-buttons button {
            display: block;
            width: 100%;
            margin: 5px 0;
        }
    }
    
    .user-section button {
        font-size: 0.95em;
        padding: 12px 15px;
        margin: 5px 0;
        min-height: 44px;
    }
}

/* ===== Ø£Ù†Ù…Ø§Ø· Tooltip Ù…Ø®ØµØµ Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ===== */
.transaction-id-wrapper {
    position: relative;
    display: inline-block;
}

.transaction-id-short {
    cursor: help;
    border-bottom: 1px dotted #999;
    padding: 2px 0;
}

.transaction-id-tooltip {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: #fff;
    text-align: center;
    padding: 8px 12px;
    border-radius: 6px;
    white-space: nowrap;
    z-index: 1000;
    font-size: 0.9em;
    font-family: 'Courier New', monospace;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transition: opacity 0.2s, visibility 0.2s;
    pointer-events: none;
}

.transaction-id-tooltip::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #333 transparent transparent transparent;
}

.transaction-id-wrapper:hover .transaction-id-tooltip {
    visibility: visible;
    opacity: 1;
}

/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Tooltip Ù…Ø®ØµØµ ===== */

/* ===== Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ===== */

/* Ø­Ù‚Ù„ Ø¨Ù‡ Ø®Ø·Ø£ */
input.input-error,
select.input-error,
textarea.input-error {
    border: 2px solid #e74c3c !important;
    background-color: #ffebee !important;
    animation: shake 0.5s ease;
}

/* Ø­Ù‚Ù„ ØµØ­ÙŠØ­ */
input.input-success,
select.input-success,
textarea.input-success {
    border: 2px solid #27ae60 !important;
    background-color: #f1f8f4 !important;
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ */
input.input-error::after,
input.input-success::after {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
}

input.input-error::after {
    content: 'âŒ';
}

input.input-success::after {
    content: 'âœ…';
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®Ø§Ø·Ø¦Ø© */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø£Ø³ÙÙ„ Ø§Ù„Ø­Ù‚Ù„ */
.field-error-message {
    color: #e74c3c;
    font-size: 0.85em;
    margin-top: 4px;
    display: block;
    animation: fadeIn 0.3s ease;
}

/* Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø£Ø³ÙÙ„ Ø§Ù„Ø­Ù‚Ù„ */
.field-success-message {
    color: #27ae60;
    font-size: 0.85em;
    margin-top: 4px;
    display: block;
    animation: fadeIn 0.3s ease;
}

/* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² */
input.input-error:focus,
select.input-error:focus,
textarea.input-error:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
}

input.input-success:focus,
select.input-success:focus,
textarea.input-success:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
}

/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ===== */

/* ===== Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ===== */
.dashboard-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.dashboard-card {
    background: #ffffff;
    color: #333;
    padding: 30px 25px;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    border-top: 4px solid transparent;
}

.dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.dashboard-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #1e3a8a 0%, #166534 100%);
}

.dashboard-card.customers {
    border-top-color: #1e3a8a;
}

.dashboard-card.customers::before {
    background: linear-gradient(135deg, #1e3a8a 0%, #166534 100%);
}

.dashboard-card.profit {
    border-top-color: #1e3a8a;
}

.dashboard-card.profit::before {
    background: linear-gradient(135deg, #1e3a8a 0%, #166534 100%);
}

.dashboard-card.revenue {
    border-top-color: #1e3a8a;
}

.dashboard-card.revenue::before {
    background: linear-gradient(135deg, #1e3a8a 0%, #166534 100%);
}

.dashboard-card.sales-today {
    border-top-color: #1e3a8a;
}

.dashboard-card.sales-today::before {
    background: linear-gradient(135deg, #1e3a8a 0%, #166534 100%);
}

.dashboard-card .card-value {
    font-size: 2.8rem;
    font-weight: 400;
    margin: 0 0 8px 0;
    line-height: 1;
    color: #1e40af;
}

.dashboard-card .card-title {
    font-size: 1rem;
    margin-bottom: 15px;
    opacity: 0.8;
    font-weight: 400;
    color: #1e40af;
}

.dashboard-card.revenue .card-value,
.dashboard-card.revenue .card-title {
    color: #dc2626;
}

.dashboard-card .card-growth {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
    font-weight: 400;
    color: #1e40af;
}

.dashboard-card .card-growth .growth-icon {
    margin-left: 8px;
    font-size: 1.2rem;
}

/* ===== Ù†Ù‡Ø§ÙŠØ© Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ===== */

/* ===== Ø£Ù†Ù…Ø§Ø· Ù‚Ø³Ù… Ø§Ù„Ø£ØµÙˆÙ„ ===== */
.asset-card {
    background: white;
    padding: 25px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-bottom: 20px;
    border-top: 4px solid var(--primary-color);
}

.asset-card h3 {
    color: var(--text-color);
    margin-bottom: 20px;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.asset-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.asset-actions button {
    flex: 1;
}

/* Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø± Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ - Ø¹Ø§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
input.editing-mode,
select.editing-mode,
textarea.editing-mode {
    border: 2px solid #28a745 !important;
    box-shadow: 0 0 8px rgba(40, 167, 69, 0.3) !important;
    animation: editPulse 1.5s ease-in-out infinite;
}

@keyframes editPulse {
    0%, 100% {
        box-shadow: 0 0 8px rgba(40, 167, 69, 0.3);
    }
    50% {
        box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
    }
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« */
.btn-primary.update-mode {
    background: linear-gradient(135deg, #28a745, #20c997) !important;
    animation: updateButton 2s ease-in-out infinite;
}

@keyframes updateButton {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.02);
    }
}

.assets-filters {
    display: flex;
    gap: 15px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.assets-filters select,
.assets-filters input {
    min-width: 200px;
    flex: 1;
}

.assets-summary {
    margin: 20px 0;
}

/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ù‚Ø³Ù… Ø§Ù„Ø£ØµÙˆÙ„ ===== */

/* ==== Ø£Ù†Ù…Ø§Ø· Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† ==== */
        
        /* Ø²Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
        .dark-mode-toggle { 
            position: fixed; 
            top: 20px; 
            left: 80px; 
            background: linear-gradient(135deg, #2c5aa0, #1a3a5c); 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 50px; 
            height: 50px; 
            cursor: pointer; 
            font-size: 20px; 
            box-shadow: var(--shadow); 
            transition: all 0.3s ease; 
            z-index: 102; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dark-mode-toggle:hover { 
            transform: scale(1.1); 
            background: linear-gradient(135deg, #1a3a5c, #0d2742); 
            box-shadow: 0 6px 15px rgba(44, 90, 160, 0.4);
        }
        
        body.dark-mode {
            background: var(--dark-bg);
            color: var(--dark-text);
        }
        
        body.dark-mode .section,
        body.dark-mode .chart-card,
        body.dark-mode .analytics-card,
        body.dark-mode .stat-card,
        body.dark-mode #login-box,
        body.dark-mode .control-panel,
        body.dark-mode .settings-card,
        body.dark-mode .modal-content,
        body.dark-mode .payment-modal,
        body.dark-mode .payments-history-modal {
            background: var(--dark-card-bg) !important;
            color: var(--dark-text) !important;
            border-color: var(--dark-border) !important;
            box-shadow: var(--dark-shadow) !important;
        }
        
        body.dark-mode .modal-body,
        body.dark-mode .modal-footer {
            background: var(--dark-card-bg) !important;
            color: var(--dark-text) !important;
            border-color: var(--dark-border) !important;
        }
        
        body.dark-mode .payment-info-card,
        body.dark-mode .payment-summary-card {
            background: var(--dark-bg-secondary) !important;
            color: var(--dark-text) !important;
            border-color: var(--primary-color) !important;
        }
        
        body.dark-mode .summary-row {
            border-color: var(--dark-border) !important;
        }
        
        /* ØªØ£ÙƒÙŠØ¯ Ø¥ØµÙ„Ø§Ø­ Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        body.dark-mode .stat-card {
            background: var(--dark-card-bg) !important;
        }
        
        body.dark-mode .stat-number {
            color: var(--primary-color) !important;
        }
        
        body.dark-mode .stat-label {
            color: var(--dark-text-secondary) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
        body.dark-mode button,
        body.dark-mode .btn,
        body.dark-mode .btn-primary,
        body.dark-mode .btn-success,
        body.dark-mode .btn-danger,
        body.dark-mode .btn-warning,
        body.dark-mode .btn-info,
        body.dark-mode .btn-secondary,
        body.dark-mode .btn-add {
            color: white !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        body.dark-mode .sidebar-nav button {
            color: var(--sidebar-text) !important;
        }
        
        body.dark-mode .sidebar-nav button.active {
            color: white !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ù†ØµÙˆØµ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© */
        body.dark-mode button:not(.sidebar-nav button) {
            color: white !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ù†ØµÙˆØµ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
        body.dark-mode .chart-card canvas {
            filter: brightness(1.1);
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ legend ÙÙŠ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
        body.dark-mode canvas {
            color-scheme: dark;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ù†ØµÙˆØµ Chart.js */
        body.dark-mode .chart-card {
            --chart-text-color: #e4e6ea;
        }
        
        body.dark-mode .sidebar {
            background: var(--dark-sidebar-bg);
        }
        
        body.dark-mode .header {
            background: var(--dark-header-bg);
        }
        
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea,
        body.dark-mode input[type="text"],
        body.dark-mode input[type="number"],
        body.dark-mode input[type="date"],
        body.dark-mode input[type="tel"],
        body.dark-mode input[type="email"],
        body.dark-mode input[type="password"] {
            background: #2c2d2e !important;
            color: var(--dark-text) !important;
            border-color: var(--dark-border) !important;
        }
        
        body.dark-mode input:focus,
        body.dark-mode select:focus,
        body.dark-mode textarea:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.3) !important;
            background: #2c2d2e !important;
        }
        
        body.dark-mode table {
            background: var(--dark-table-bg);
        }
        
        body.dark-mode th {
            background: var(--primary-color);
            color: white;
        }
        
        body.dark-mode td {
            background: var(--dark-table-row);
            color: var(--dark-text);
            border-bottom: 1px solid var(--dark-border);
        }
        
        body.dark-mode tr:hover td {
            background: var(--dark-bg-secondary);
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
        body.dark-mode .user-management,
        body.dark-mode .activities-management,
        body.dark-mode .branches-management,
        body.dark-mode .backup-settings,
        body.dark-mode .logo-settings,
        body.dark-mode .activity-logo-settings {
            background: var(--dark-card-bg) !important;
            color: var(--dark-text);
            border-color: var(--dark-border) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
        body.dark-mode .user-selector,
        body.dark-mode .activity-selector {
            background: var(--dark-card-bg) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø®Ù„ÙÙŠØ© user-management Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
        body.dark-mode #userManagementSection,
        body.dark-mode #activityManagementSection,
        body.dark-mode #branchManagementSection {
            background: var(--dark-card-bg) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
        body.dark-mode .user-selector > *,
        body.dark-mode .activity-selector > * {
            background: transparent !important;
        }
        
        body.dark-mode .current-user-info {
            background: var(--dark-bg-secondary) !important;
            border-right-color: var(--primary-color) !important;
        }
        
        body.dark-mode .user-management h3,
        body.dark-mode .user-management h4,
        body.dark-mode .activities-management h3,
        body.dark-mode .settings-card h3,
        body.dark-mode .settings-card h4 {
            color: var(--primary-color) !important;
        }
        
        body.dark-mode .current-user-info strong,
        body.dark-mode .settings-card p {
            color: var(--dark-text);
        }
        
        body.dark-mode .current-user-info span {
            color: var(--dark-text-secondary);
        }
        
        body.dark-mode #currentActivityDisplay {
            background: var(--dark-input-bg) !important;
            color: var(--dark-text);
        }
        
        body.dark-mode .tips-container {
            background: var(--dark-bg-secondary) !important;
            border-color: rgba(44, 90, 160, 0.3) !important;
        }
        
        body.dark-mode .tips-container p,
        body.dark-mode .tips-container li {
            color: var(--dark-text-secondary) !important;
        }
        
        body.dark-mode .tips-container strong {
            color: var(--primary-color) !important;
        }
        
        body.dark-mode .user-selector label,
        body.dark-mode .activity-selector label,
        body.dark-mode .selected-user-field label,
        body.dark-mode .selected-activity-field label {
            color: var(--dark-text);
        }
        
        body.dark-mode .logo-preview-container img {
            background: var(--dark-input-bg);
            border-color: var(--dark-border);
        }
        
        body.dark-mode #noLogoText,
        body.dark-mode #noActivityLogoText {
            color: var(--dark-text-secondary);
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ù„ÙˆÙ†Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        body.dark-mode h4[style*="background: linear-gradient"],
        body.dark-mode .current-user-info h4 {
            background: var(--dark-bg-tertiary) !important;
            border: 2px solid var(--primary-color) !important;
            color: var(--primary-color) !important;
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ù‚Ø³Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… */
        body.dark-mode div[style*="background: linear-gradient(135deg, #e3f2fd"] {
            background: linear-gradient(135deg, var(--dark-bg-secondary) 0%, var(--dark-bg-tertiary) 100%) !important;
            border-color: var(--primary-color) !important;
        }
        
        body.dark-mode div[style*="background: linear-gradient(135deg, #e3f2fd"] strong {
            color: var(--primary-color) !important;
        }
        
        body.dark-mode div[style*="background: linear-gradient(135deg, #e3f2fd"] div {
            color: var(--dark-text) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ù‚Ø³Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ */
        body.dark-mode .backup-settings {
            background: var(--dark-bg-secondary) !important;
            color: var(--dark-text) !important;
            border-color: rgba(44, 90, 160, 0.5) !important;
        }
        
        body.dark-mode .backup-settings h3,
        body.dark-mode .backup-settings h4 {
            color: var(--primary-color) !important;
        }
        
        body.dark-mode .backup-settings p,
        body.dark-mode .backup-settings li {
            color: var(--dark-text-secondary) !important;
        }
        
        body.dark-mode .backup-settings > div {
            background: var(--dark-bg-tertiary) !important;
            border-color: rgba(44, 90, 160, 0.3) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
        body.dark-mode .filters-container {
            background: var(--dark-bg-secondary);
            border-color: var(--dark-border);
        }
        
        body.dark-mode .notification {
            background: var(--dark-card-bg);
            color: var(--dark-text);
        }
        
        body.dark-mode .confirm-dialog {
            background: var(--dark-card-bg);
        }
        
        body.dark-mode .trash-content,
        body.dark-mode .modal-content {
            background: var(--dark-card-bg);
            color: var(--dark-text);
        }
        
        body.dark-mode .current-user {
            background: var(--dark-bg-tertiary);
            color: var(--dark-text);
        }
        
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode h3,
        body.dark-mode h4,
        body.dark-mode h5 {
            color: var(--dark-text);
        }
        
        body.dark-mode .sidebar-header h1 {
            color: white;
        }
        
        body.dark-mode .stat-number {
            color: var(--primary-color);
        }
        
        body.dark-mode .stat-label {
            color: var(--dark-text-secondary);
        }
        
        body.dark-mode .chart-card h3,
        body.dark-mode .analytics-card h3,
        body.dark-mode .section h2 {
            color: var(--primary-color);
        }
        
        body.dark-mode #appFooter {
            background: linear-gradient(135deg, var(--dark-bg-tertiary) 0%, var(--dark-bg-secondary) 100%);
            border-top-color: var(--dark-border);
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ ØµÙ†Ø¯ÙˆÙ‚ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† */
        body.dark-mode div[style*="background: #f8f9fa"][style*="border-right: 3px solid #ffc107"] {
            background: var(--dark-bg-secondary) !important;
            border-right-color: #ffc107 !important;
        }
        
        body.dark-mode div[style*="background: #f8f9fa"][style*="border-right: 3px solid #ffc107"] h5 {
            color: #ffc107 !important;
        }
        
        body.dark-mode div[style*="background: #f8f9fa"][style*="border-right: 3px solid #ffc107"] p {
            color: var(--dark-text-secondary) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ù…Ø¹ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø¯Ø±Ø¬Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ */
        body.dark-mode h4[style*="background: linear-gradient(135deg, rgba(25, 118, 210"] {
            background: linear-gradient(135deg, var(--dark-bg-tertiary), var(--dark-bg-secondary)) !important;
            color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ */
        body.dark-mode div[style*="background: #f0f7ff"] {
            background: var(--dark-bg-secondary) !important;
            border-right-color: var(--primary-color) !important;
        }
        
        body.dark-mode div[style*="background: #f0f7ff"] strong {
            color: var(--dark-text);
        }
        
        body.dark-mode div[style*="background: #f0f7ff"] span {
            color: var(--dark-text-secondary);
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø°Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        body.dark-mode #currentActivityDisplay[style*="background: white"] {
            background: var(--dark-input-bg) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¬ÙŠÙ† */
        body.dark-mode .settings-card div[style*="background: rgba(25, 118, 210, 0.1)"] {
            background: var(--dark-bg-tertiary) !important;
            border-color: rgba(44, 90, 160, 0.5) !important;
        }
        
        body.dark-mode .settings-card div[style*="background: rgba(25, 118, 210, 0.08)"] {
            background: var(--dark-bg-tertiary) !important;
            border-color: rgba(44, 90, 160, 0.3) !important;
        }
        
        body.dark-mode .settings-card div[style*="background: rgba(25, 118, 210, 0.08)"] ul {
            color: var(--dark-text-secondary) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¯Ø§Ø®Ù„ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† */
        body.dark-mode select[id*="SecurityQuestion"],
        body.dark-mode input[id*="SecurityAnswer"] {
            background: var(--dark-input-bg) !important;
            color: var(--dark-text) !important;
            border-color: var(--dark-border) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Labels ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        body.dark-mode .user-selector-label,
        body.dark-mode .activity-selector-label {
            color: var(--dark-text);
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        body.dark-mode #activitiesDropdown,
        body.dark-mode #usersDropdown,
        body.dark-mode #newUserActivity {
            background: var(--dark-input-bg);
            color: var(--dark-text);
            border-color: var(--dark-border);
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        body.dark-mode p[style*="font-size: 0.8em"][style*="color: #666"] {
            color: var(--dark-text-secondary) !important;
        }
        
        body.dark-mode p[style*="font-size: 0.9em"][style*="color: #666"] {
            color: var(--dark-text-secondary) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Label "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†" */
        body.dark-mode label[for="usersDropdown"],
        body.dark-mode label[for="activitiesDropdown"] {
            color: var(--dark-text) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ labels ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        body.dark-mode #settings label,
        body.dark-mode .settings-card label {
            color: var(--dark-text) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¨Ø§Ù‡ØªØ© */
        body.dark-mode .settings-card p[style*="color: #999"],
        body.dark-mode p[style*="font-style: italic"][style*="color: #999"] {
            color: var(--dark-text-secondary) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø£ÙŠ div Ø¨Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        body.dark-mode #settings div[style*="background: white"],
        body.dark-mode .settings-card div[style*="background: white"] {
            background: var(--dark-input-bg) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù€ placeholders */
        body.dark-mode input::placeholder,
        body.dark-mode textarea::placeholder {
            color: var(--dark-text-secondary);
            opacity: 0.6;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ readonly inputs */
        body.dark-mode input[readonly],
        body.dark-mode textarea[readonly] {
            background: #2c2d2e !important;
            color: var(--dark-text) !important;
            opacity: 1 !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        body.dark-mode #settings *[style*="color: #666"],
        body.dark-mode .settings-card *[style*="color: #666"] {
            color: var(--dark-text-secondary) !important;
        }
        
        body.dark-mode #settings *[style*="color: #999"],
        body.dark-mode .settings-card *[style*="color: #999"] {
            color: var(--dark-text-secondary) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ù†Øµ "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:" Ø§Ù„ÙˆØ§Ø¶Ø­ */
        body.dark-mode .user-selector > label,
        body.dark-mode .activity-selector > label {
            color: var(--dark-text) !important;
            font-weight: 600;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¨Ø§Ù‡ØªØ© Ø¬Ø¯Ø§Ù‹ */
        body.dark-mode .user-selector *,
        body.dark-mode .activity-selector * {
            color: var(--dark-text) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø´Ø§Ù…Ù„ Ù„Ø£ÙŠ Ù†Øµ Ø¨Ø§Ù‡Øª ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        body.dark-mode #settings h4,
        body.dark-mode #settings h5,
        body.dark-mode #settings p,
        body.dark-mode #settings label,
        body.dark-mode #settings span {
            opacity: 1 !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù†ØµÙˆØµ Ø°Ø§Øª opacity Ù…Ù†Ø®ÙØ¶ */
        body.dark-mode .settings-card * {
            opacity: 1 !important;
        }
        
        body.dark-mode .settings-card p[style*="opacity"],
        body.dark-mode .settings-card span[style*="opacity"] {
            opacity: 0.9 !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù€ label "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:" */
        body.dark-mode .user-selector-label,
        body.dark-mode .activity-selector-label,
        body.dark-mode label.user-selector-label,
        body.dark-mode label.activity-selector-label {
            color: #e4e6ea !important;
            opacity: 1 !important;
            font-weight: 600 !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ ÙƒÙ„ label ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
        body.dark-mode .user-selector label,
        body.dark-mode .activity-selector label {
            color: #e4e6ea !important;
            opacity: 1 !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ labels ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        body.dark-mode #usersTabContent label,
        body.dark-mode #activitiesTabContent label,
        body.dark-mode #generalTabContent label,
        body.dark-mode #backupTabContent label {
            color: var(--dark-text) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø®Ù„ÙÙŠØ© invoice-totals */
        body.dark-mode .invoice-totals,
        body.dark-mode .invoice-totals-print {
            background: var(--dark-card-bg) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠ invoice-totals */
        body.dark-mode .invoice-totals input[type="number"],
        body.dark-mode .invoice-totals select {
            background: #2c2d2e !important;
            color: var(--dark-text) !important;
            border-color: var(--dark-border) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ */
        body.dark-mode .salary-card,
        body.dark-mode .salary-summary {
            background: var(--dark-card-bg) !important;
        }
        
        body.dark-mode .dashboard-card[style*="background: white"] {
            background: var(--dark-card-bg) !important;
        }
        
        body.dark-mode .dashboard-card .card-value,
        body.dark-mode .dashboard-card .card-title,
        body.dark-mode .dashboard-card .card-growth span {
            color: inherit !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£ØµÙˆÙ„ */
        body.dark-mode .asset-card,
        body.dark-mode .assets-summary {
            background: var(--dark-card-bg) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ dashboard cards */
        body.dark-mode .dashboard-card.customers,
        body.dark-mode .dashboard-card.profit,
        body.dark-mode .dashboard-card.revenue,
        body.dark-mode .dashboard-card.sales-today {
            background: var(--dark-card-bg) !important;
        }
        
        body.dark-mode .dashboard-card .card-value,
        body.dark-mode .dashboard-card .card-title,
        body.dark-mode .dashboard-card .card-growth {
            color: var(--dark-text) !important;
        }
        
        body.dark-mode .dashboard-card.customers .card-value,
        body.dark-mode .dashboard-card.customers .card-title,
        body.dark-mode .dashboard-card.customers .card-growth,
        body.dark-mode .dashboard-card.profit .card-value,
        body.dark-mode .dashboard-card.profit .card-title,
        body.dark-mode .dashboard-card.profit .card-growth,
        body.dark-mode .dashboard-card.revenue .card-value,
        body.dark-mode .dashboard-card.revenue .card-title,
        body.dark-mode .dashboard-card.revenue .card-growth,
        body.dark-mode .dashboard-card.sales-today .card-value,
        body.dark-mode .dashboard-card.sales-today .card-title,
        body.dark-mode .dashboard-card.sales-today .card-growth {
            color: var(--dark-text) !important;
            opacity: 1 !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ ØµÙØ­Ø© "Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬" */
        body.dark-mode #about .settings-card {
            background: var(--dark-card-bg) !important;
            border-color: var(--dark-border) !important;
        }
        
        body.dark-mode #about .settings-card[style*="background: white"] {
            background: var(--dark-card-bg) !important;
        }
        
        body.dark-mode #about div[style*="background: #f8f9fa"],
        body.dark-mode #about div[style*="background: white"] {
            background: var(--dark-bg-secondary) !important;
            border-color: var(--dark-border) !important;
        }
        
        body.dark-mode #about div[style*="background: rgba(25, 118, 210, 0.05)"],
        body.dark-mode #about div[style*="background: rgba(25, 118, 210, 0.1)"] {
            background: var(--dark-bg-tertiary) !important;
            border-color: rgba(44, 90, 160, 0.5) !important;
        }
        
        body.dark-mode #about div[style*="background: rgba(25, 118, 210, 0.08)"] {
            background: var(--dark-bg-secondary) !important;
            border-color: rgba(44, 90, 160, 0.3) !important;
        }
        
        body.dark-mode #about h1,
        body.dark-mode #about h3,
        body.dark-mode #about strong {
            color: var(--primary-color) !important;
        }
        
        body.dark-mode #about p,
        body.dark-mode #about div[style*="color: #666"],
        body.dark-mode #about div[style*="color: #555"],
        body.dark-mode #about div[style*="color: #333"] {
            color: var(--dark-text-secondary) !important;
        }
        
        body.dark-mode #about div[style*="color: #999"] {
            color: var(--dark-text-secondary) !important;
            opacity: 0.7;
        }
        
        body.dark-mode #aboutProgramName {
            color: var(--primary-color) !important;
        }
        
        body.dark-mode #aboutVersion,
        body.dark-mode #aboutDescription {
            color: var(--dark-text-secondary) !important;
        }
        
        body.dark-mode #aboutDeveloper,
        body.dark-mode #aboutYear {
            color: var(--dark-text) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª */
        body.dark-mode #about div[style*="background: white"][style*="border-right"] {
            background: var(--dark-bg-secondary) !important;
        }
        
        body.dark-mode #about div[style*="background: white"][style*="border-right"] p {
            color: var(--dark-text-secondary) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© ÙÙŠ Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ */
        body.dark-mode #about > div > div:last-child {
            background: var(--dark-card-bg) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© about */
        body.dark-mode #about > div {
            background: transparent !important;
        }
        
        body.dark-mode #about > div > div {
            background: var(--dark-card-bg) !important;
            border-color: var(--dark-border) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØµØºÙŠØ±Ø© */
        body.dark-mode #about div[style*="font-size: 0.9em"],
        body.dark-mode #about div[style*="font-size: 0.85em"],
        body.dark-mode #about div[style*="font-size: 0.95em"] {
            color: var(--dark-text-secondary) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØµØºÙŠØ±Ø© ÙÙˆÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
        body.dark-mode #about div[style*="font-size: 0.9em"][style*="color: #666"] {
            color: var(--dark-text-secondary) !important;
        }
        
        /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
        body.dark-mode #about div[style*="font-size: 1.1em"][style*="font-weight: 600"] {
            color: var(--dark-text) !important;
        }
        
        @media (max-width: 768px) {
            .dark-mode-toggle { 
                top: 20px; 
                left: 20px; 
                z-index: 103; 
            }
        }
        
        /* Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ø§Ù„Ø³Ù„Ø³Ø© */
        body,
        .section,
        .settings-card,
        input,
        select,
        textarea {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ù„Ø¹ÙˆØ¯Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ */

 </style>


</head>
<body>
    <div id="login-overlay">
        <div id="login-box">
            <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ -->
            <img src="https://res.cloudinary.com/dgjcr2bgq/image/upload/v1762349658/logo_vlldbc.png" 
     alt="Ø´Ø¹Ø§Ø± Ù†Ø¸Ø§Ù… Ø¯ÙŠÙˆØ§Ù†ÙŠ" class="login-logo" id="loginLogo">
            
            <h2>Ø¯ÙŠÙˆØ§Ù†ÙŠ<br><span style="font-size: 0.8em; font-weight: normal; color: #1e3a5f;">Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù…ØªÙƒØ§Ù…Ù„</span></h2>
            <form id="loginForm" onsubmit="return false;" autocomplete="off">
           <input type="email" id="loginEmail" class="login-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" 
       onkeypress="if(event.key==='Enter')handleLogin()" autocomplete="new-email" name="email-new"> 

<input type="password" id="loginPassword" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" 
       onkeypress="if(event.key==='Enter')handleLogin()" autocomplete="new-password" name="password-new">
       
            <button class="btn-primary" onclick="handleLogin()" style="width: 100%; margin-top: 15px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </form>
            
            <!-- Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„ - ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
            <button id="firstSetupBtn" class="btn-secondary" onclick="showFirstSetup()" style="width: 100%; margin-top: 10px; background: #6c757d; border-color: #6c757d; padding: 12px; display: none;">
                ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„
            </button>
            
            <a class="back-to-roles" onclick="openForgotPasswordModal()">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a>
            <p id="login-error">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„.</p>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„ -->
    <div id="first-setup-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); justify-content: center; align-items: center; z-index: 10001; backdrop-filter: blur(5px);">
        <div id="first-setup-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); width: 100%; max-width: 500px; text-align: center;">
            <div style="font-size: 4em; margin-bottom: 20px;">ğŸš€</div>
            <h2 style="color: white; margin-bottom: 10px; font-size: 2em;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¯ÙŠÙˆØ§Ù†ÙŠ!</h2>
            <p style="margin-bottom: 30px; opacity: 0.9; font-size: 1.1em;">Ù„Ø¨Ø¯Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„</p>
            
            <form id="firstSetupForm" onsubmit="return false;" autocomplete="off" style="text-align: right;">
                <input type="text" id="adminName" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„" 
                       style="background: rgba(255,255,255,0.9); border: none; margin-bottom: 15px;"
                       onkeypress="if(event.key==='Enter')createFirstAdmin()" autocomplete="off" required>
                
                <input type="email" id="adminEmail" class="login-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø¯ÙŠØ±" 
                       style="background: rgba(255,255,255,0.9); border: none; margin-bottom: 15px;"
                       onkeypress="if(event.key==='Enter')createFirstAdmin()" autocomplete="off" required>
                
                <input type="tel" id="adminPhone" class="login-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" 
                       style="background: rgba(255,255,255,0.9); border: none; margin-bottom: 15px;"
                       onkeypress="if(event.key==='Enter')createFirstAdmin()" autocomplete="off">
                
                <input type="password" id="adminPassword" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" 
                       style="background: rgba(255,255,255,0.9); border: none; margin-bottom: 15px;"
                       onkeypress="if(event.key==='Enter')createFirstAdmin()" autocomplete="off" required>
                
                <input type="password" id="adminPasswordConfirm" class="login-input" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" 
                       style="background: rgba(255,255,255,0.9); border: none; margin-bottom: 20px;"
                       onkeypress="if(event.key==='Enter')createFirstAdmin()" autocomplete="off" required>
                
                <button class="btn-success" onclick="createFirstAdmin()" style="width: 100%; padding: 15px; font-size: 1.1em; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); color: white; border-radius: 10px; transition: all 0.3s; margin-bottom: 10px;">
                    ğŸ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
                </button>
                
                <button class="btn-secondary" onclick="cancelFirstSetup()" style="width: 100%; padding: 12px; font-size: 1em; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); color: white; border-radius: 10px; transition: all 0.3s;">
                    â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                </button>
            </form>
            
            <p id="setup-error" style="color: #ffcccb; margin-top: 15px; display: none; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;"></p>
        </div>
    </div>
    
    <div id="activity-overlay" style="display: none;">
        <div id="activity-box">
            <h2>Ø§Ø®ØªØ± Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ù†Ø´Ø§Ø·Ø§Ù‹ ØªØ¬Ø§Ø±ÙŠØ§Ù‹</h2>
            <div id="activity-list"></div>
            <hr style="margin: 20px 0;">
            <h3>Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ù†Ø´Ø§Ø·Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹</h3>
            <input type="text" id="newActivityName" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ø§Ù„: Ø¨ÙŠØ¹ Ù„Ø­Ø§ÙØ§Øª Ø§Ù„Ø£Ø·ÙØ§Ù„)">
            <button class="btn-success" onclick="addNewActivity()" style="width: 100%;">+ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù†Ø´Ø§Ø·</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div id="user-edit-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(5px);">
        <div id="user-edit-box" style="background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 500px; text-align: center; max-height: 90vh; overflow-y: auto;">
            <h2 style="color: var(--primary-color); margin-bottom: 20px;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
            <form id="editUserForm" onsubmit="return false;">
            <input type="text" id="editUserName" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="name">
            <input type="email" id="editUserEmail" class="login-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="email">
            <input type="tel" id="editUserPhone" class="login-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" autocomplete="tel">
            <input type="password" id="editUserPassword" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„ÙŠ)" autocomplete="new-password">
            <select id="editUserRole" class="login-input">
                <option value="admin">Ù…Ø¯ÙŠØ±</option>
                <option value="manager">Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·</option>
                <option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option>
            </select>
            <select id="editUserActivity" class="login-input" style="display: none;">
                <option value="">-- ØªØ¹ÙŠÙŠÙ† Ù„Ù†Ø´Ø§Ø· --</option>
            </select>
            <!-- Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: right; border-right: 3px solid #ffc107;">
                <h5 style="color: #856404; margin: 0 0 10px 0; font-size: 14px;">ğŸ” ØªØ­Ø¯ÙŠØ« Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h5>
                <div id="securityQuestionWarning" style="display: none; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 8px; margin-bottom: 10px; font-size: 12px; color: #856404;">
                    âš ï¸ <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¤Ø§Ù„ Ø£Ù…Ø§Ù† Ù…Ø­Ø¯Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. ÙŠÙÙ†ØµØ­ Ø¨ØªØ­Ø¯ÙŠØ¯ Ø³Ø¤Ø§Ù„ Ø£Ù…Ø§Ù† Ù„Ø¶Ù…Ø§Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.
                </div>
                <select id="editUserSecurityQuestion" class="login-input" style="margin-bottom: 10px;">
                    <option value="">-- Ø§Ø®ØªØ± Ø³Ø¤Ø§Ù„ Ø£Ù…Ø§Ù† --</option>
                    <option value="Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ØªÙƒØŸ">Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ØªÙƒØŸ</option>
                    <option value="Ù…Ø§ Ù‡ÙŠ Ù…Ø¯ÙŠÙ†Ø© Ù…ÙŠÙ„Ø§Ø¯ÙƒØŸ">Ù…Ø§ Ù‡ÙŠ Ù…Ø¯ÙŠÙ†Ø© Ù…ÙŠÙ„Ø§Ø¯ÙƒØŸ</option>
                    <option value="Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ù…Ø¯Ø±Ø³ØªÙƒ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©ØŸ">Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ù…Ø¯Ø±Ø³ØªÙƒ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©ØŸ</option>
                    <option value="Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø­ÙŠÙˆØ§Ù†Ùƒ Ø§Ù„Ø£Ù„ÙŠÙ Ø§Ù„Ø£ÙˆÙ„ØŸ">Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø­ÙŠÙˆØ§Ù†Ùƒ Ø§Ù„Ø£Ù„ÙŠÙ Ø§Ù„Ø£ÙˆÙ„ØŸ</option>
                    <option value="Ù…Ø§ Ù‡Ùˆ Ù„Ù‚Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø·ÙÙˆÙ„Ø©ØŸ">Ù…Ø§ Ù‡Ùˆ Ù„Ù‚Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø·ÙÙˆÙ„Ø©ØŸ</option>
                    <option value="Ù…Ø§ Ù‡Ùˆ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ù…ÙØ¶Ù„ØŸ">Ù…Ø§ Ù‡Ùˆ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ù…ÙØ¶Ù„ØŸ</option>
                </select>
                <input type="text" id="editUserSecurityAnswer" class="login-input" placeholder="Ø¥Ø¬Ø§Ø¨Ø© Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†">
                <p style="font-size: 11px; color: #856404; margin: 8px 0 0 0; text-align: right;">ğŸ’¡ Ø§ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
            </div>
            </form>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn-success" onclick="saveEditedUser()" style="flex:1;">Ø­ÙØ¸</button>
                <button class="btn-secondary" onclick="closeEditUserModal()" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ -->
    <div id="email-settings-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 10002; backdrop-filter: blur(5px);" onclick="if(event.target === this) closeEmailSettingsModal();">
        <div style="background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation();">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="color: var(--primary-color); margin: 0;">ğŸ“§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h2>
                <button onclick="closeEmailSettingsModal()" style="background: #f0f0f0; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #666; font-size: 18px;" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
            </div>
            <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 0.95em;">
                Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¶Ø±ÙˆØ±ÙŠØ© Ù„ØªÙØ¹ÙŠÙ„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯. Ø§Ø­ØµÙ„ Ø¹Ù„ÙŠÙ‡Ø§ Ù…Ù† <a href="https://www.emailjs.com/" target="_blank" style="color: var(--primary-color);">EmailJS</a>
            </p>
            
            <form id="emailSettingsForm" onsubmit="return false;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <!-- Service ID -->
                    <div>
                        <label for="emailJsServiceId" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Service ID</label>
                        <code style="display: block; background-color: #f0f0f0; padding: 8px; border-radius: 4px; margin-bottom: 8px; cursor: pointer; user-select: all; font-size: 0.85em;" onclick="navigator.clipboard.writeText(this.innerText); showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Service ID', 'success', 2000);">service_hu6ucxi</code>
                        <input type="text" id="emailJsServiceId" class="login-input" placeholder="Ø£Ø¯Ø®Ù„ Service ID">
                    </div>
                    
                    <!-- Public Key -->
                    <div>
                        <label for="emailJsPublicKey" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Public Key</label>
                        <code style="display: block; background-color: #f0f0f0; padding: 8px; border-radius: 4px; margin-bottom: 8px; cursor: pointer; user-select: all; font-size: 0.85em;" onclick="navigator.clipboard.writeText(this.innerText); showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Public Key', 'success', 2000);">-FKicwCTdzG90IoY6</code>
                        <input type="text" id="emailJsPublicKey" class="login-input" placeholder="Ø£Ø¯Ø®Ù„ Public Key">
                    </div>
                    
                    <!-- Template ID -->
                    <div>
                        <label for="emailJsTemplateId" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Template ID (Ø§Ù„ÙÙˆØ§ØªÙŠØ±)</label>
                        <code style="display: block; background-color: #f0f0f0; padding: 8px; border-radius: 4px; margin-bottom: 8px; cursor: pointer; user-select: all; font-size: 0.85em;" onclick="navigator.clipboard.writeText(this.innerText); showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Template ID', 'success', 2000);">template_cwep9ok</code>
                        <input type="text" id="emailJsTemplateId" class="login-input" placeholder="Ø£Ø¯Ø®Ù„ Template ID Ù„Ù„ÙÙˆØ§ØªÙŠØ±">
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9em; color: #555;">
                    <strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong>
                    <ul style="margin: 10px 0 0 20px; padding: 0;">
                        <li>Ù‚Ø§Ù„Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: <code style="background: #e9ecef; padding: 2px 5px; border-radius: 3px;">{{to_name}}, {{to_email}}, {{invoice_number}}, {{invoice_details}}</code></li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn-success" onclick="saveEmailJsSettings()" style="flex: 1;">ğŸ’¾ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
                    <button class="btn-secondary" onclick="closeEmailSettingsModal()" style="flex: 1;">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ®ØµÙŠØµ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ -->
    <div id="about-settings-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 10002; backdrop-filter: blur(5px);" onclick="if(event.target === this) closeAboutSettingsModal();">
        <div style="background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation();">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="color: var(--primary-color); margin: 0;">â„¹ï¸ ØªØ®ØµÙŠØµ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</h2>
                <button onclick="closeAboutSettingsModal()" style="background: #f0f0f0; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #666; font-size: 18px;" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
            </div>
            <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 0.95em;">
                Ù‚Ù… Ø¨ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙŠ ØªØ¸Ù‡Ø± ÙÙŠ ØµÙØ­Ø© "Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬"
            </p>
            
            <form id="aboutSettingsForm" onsubmit="return false;">
                <div style="margin-bottom: 20px;">
                    <!-- Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ -->
                    <div style="margin-bottom: 15px;">
                        <label for="aboutProgramNameInput" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ğŸ“± Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
                        <input type="text" id="aboutProgramNameInput" class="login-input" placeholder="Ù…Ø«Ø§Ù„: Ø¯ÙŠÙˆØ§Ù†ÙŠ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©" value="Ø¯ÙŠÙˆØ§Ù†ÙŠ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©">
                    </div>
                    
                    <!-- Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± -->
                    <div style="margin-bottom: 15px;">
                        <label for="aboutVersionInput" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø±</label>
                        <input type="text" id="aboutVersionInput" class="login-input" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2.0" value="Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2.0">
                    </div>
                    
                    <!-- ÙˆØµÙ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ -->
                    <div style="margin-bottom: 15px;">
                        <label for="aboutDescriptionInput" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ğŸ“ ÙˆØµÙ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
                        <textarea id="aboutDescriptionInput" class="login-input" rows="4" placeholder="Ø£Ø¯Ø®Ù„ ÙˆØµÙØ§Ù‹ ØªÙØµÙŠÙ„ÙŠØ§Ù‹ Ù„Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬..." style="resize: vertical; min-height: 100px;">Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©ØŒ ÙŠÙˆÙØ± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø³Ù‡Ù„Ø© ÙˆÙØ¹Ø§Ù„Ø©. ÙŠØ¯Ø¹Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆØ§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… FirebaseØŒ Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø¯ÙŠØ«Ø© ÙˆØ³Ù‡Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….</textarea>
                    </div>
                    
                    <!-- Ø§Ø³Ù… Ø§Ù„Ù…Ø·ÙˆØ± -->
                    <div style="margin-bottom: 15px;">
                        <label for="aboutDeveloperInput" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ğŸ‘¨â€ğŸ’» Ø§Ø³Ù… Ø§Ù„Ù…Ø·ÙˆØ±/Ø§Ù„ÙØ±ÙŠÙ‚</label>
                        <input type="text" id="aboutDeveloperInput" class="login-input" placeholder="Ù…Ø«Ø§Ù„: ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ·ÙˆÙŠØ±" value="ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ·ÙˆÙŠØ±">
                    </div>
                    
                    <!-- Ø³Ù†Ø© Ø§Ù„Ø¥ØµØ¯Ø§Ø± -->
                    <div style="margin-bottom: 15px;">
                        <label for="aboutYearInput" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ğŸ“… Ø³Ù†Ø© Ø§Ù„Ø¥ØµØ¯Ø§Ø±</label>
                        <input type="text" id="aboutYearInput" class="login-input" placeholder="Ù…Ø«Ø§Ù„: 2025" value="2025">
                    </div>
                    
                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label for="aboutWebsiteInput" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ğŸŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="text" id="aboutWebsiteInput" class="login-input" placeholder="Ù…Ø«Ø§Ù„: www.example.com">
                        </div>
                        <div>
                            <label for="aboutEmailInput" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="email" id="aboutEmailInput" class="login-input" placeholder="Ù…Ø«Ø§Ù„: info@example.com">
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9em; color: #555;">
                    <strong>ğŸ’¡ Ù†ØµÙŠØ­Ø©:</strong> ÙŠÙ…ÙƒÙ†Ùƒ ØªØ±Ùƒ Ø£ÙŠ Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„ÙŠÙ‡ØŒ ÙˆØ³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn-success" onclick="saveAboutSettings()" style="flex: 1;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ®ØµÙŠØµØ§Øª</button>
                    <button class="btn-secondary" onclick="closeAboutSettingsModal()" style="flex: 1;">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„) -->
    <div id="change-password-overlay" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10002; backdrop-filter: blur(5px);">
        <div style="background:white; padding: 24px; border-radius: var(--border-radius); width: 100%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <h2 style="margin-top:0; color: var(--primary-color);">ğŸ”’ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
            <form id="changePasswordForm" onsubmit="return false;">
            <input type="password" id="cp-old" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" autocomplete="current-password">
            <input type="password" id="cp-new" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" autocomplete="new-password">
            <input type="password" id="cp-confirm" class="login-input" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" autocomplete="new-password">
            </form>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-success" onclick="submitPasswordChange()" style="flex:1;">Ø­ÙØ¸</button>
                <button class="btn-secondary" onclick="closeChangePasswordModal()" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø·) -->
    <div id="forgot-password-overlay" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10002; backdrop-filter: blur(5px);">
        <div style="background:white; padding: 30px; border-radius: var(--border-radius); width: 100%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <h2 style="margin-top:0; color: var(--primary-color); text-align: center;">ğŸ“§ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
            <p style="margin: 0 0 20px; text-align: center; color: #666;">Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
            <form id="forgotPasswordForm" onsubmit="return false;">
            <input type="email" id="fp-email" class="login-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="email" style="margin-bottom: 20px;">
            </form>
            <div style="display:flex; gap:10px;">
                <button class="btn-success" onclick="requestPasswordReset()" style="flex:1;">Ø¥Ø±Ø³Ø§Ù„</button>
                <button class="btn-secondary" onclick="closeForgotPasswordModal()" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· -->
    <div id="reset-password-overlay" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10003; backdrop-filter: blur(5px);">
        <div style="background:white; padding: 30px; border-radius: var(--border-radius); width: 100%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <h2 style="margin-top:0; color: var(--primary-color); text-align: center;">ğŸ”‘ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <p style="margin: 0 0 20px; text-align: center; color: #666;">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</p>
            <form id="resetPasswordForm" onsubmit="return false;">
            <input type="password" id="rp-new" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" autocomplete="new-password" style="margin-bottom: 15px;">
            <input type="password" id="rp-confirm" class="login-input" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" autocomplete="new-password" style="margin-bottom: 20px;">
            </form>
            <div style="display:flex; gap:10px;">
                <button class="btn-success" onclick="submitTokenPasswordReset()" style="flex:1;">Ø­ÙØ¸</button>
                <button class="btn-secondary" onclick="closeResetPasswordModal()" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© -->
    <div id="edit-activity-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 10005; backdrop-filter: blur(5px);">
        <div class="edit-activity-modal" style="background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 520px; overflow: hidden; animation: scaleIn 0.3s ease;">
            <!-- Ø±Ø£Ø³ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
            <div class="edit-activity-header" style="background: linear-gradient(135deg, var(--primary-color) 0%, #2980b9 100%); padding: 25px 30px; text-align: center; color: white; position: relative;">
                <div style="font-size: 48px; margin-bottom: 10px;">âœï¸</div>
                <h2 style="margin: 0; font-size: 1.6em; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·</h2>
                <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 0.95em;">ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</p>
            </div>
            
            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
            <div class="edit-activity-body" style="padding: 30px;">
                <form id="editActivityForm" onsubmit="return false;">
                    <!-- Ø­Ù‚Ù„ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· -->
                    <div style="margin-bottom: 25px;">
                        <label for="editActivityName" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color); font-size: 1.1em;">
                            ğŸ“ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·
                        </label>
                        <input type="text" id="editActivityName" class="login-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯" 
                               style="width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1.1em; transition: all 0.3s ease; background: #f8f9fa;"
                               autocomplete="off" required>
                    </div>
                    
                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
                    <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <h3 style="margin: 0 0 15px 0; color: var(--primary-color); font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                            ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.95em;">
                            <div>
                                <span style="color: #666; font-weight: 600;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</span>
                                <div id="activityCreatedAt" style="color: var(--text-color); margin-top: 4px;"></div>
                            </div>
                            <div>
                                <span style="color: #666; font-weight: 600;">Ø§Ù„Ù…Ù†Ø´Ø¦:</span>
                                <div id="activityCreatedBy" style="color: var(--text-color); margin-top: 4px;"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© -->
            <div class="edit-activity-footer" style="padding: 20px 30px; background: #f8f9fa; border-top: 1px solid #e1e5e9; display: flex; gap: 15px;">
                <button class="btn-success" onclick="saveEditedActivity()" 
                        style="flex: 1; padding: 15px; font-size: 1.1em; font-weight: 600; border-radius: 12px; transition: all 0.3s ease; background: linear-gradient(135deg, var(--success-color) 0%, #229954 100%); box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);">
                    ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                </button>
                <button class="btn-secondary" onclick="closeEditActivityModal()" 
                        style="flex: 1; padding: 15px; font-size: 1.1em; font-weight: 600; border-radius: 12px; transition: all 0.3s ease; background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); color: white; box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);">
                    âŒ Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ -->
    <div id="confirm-overlay" class="confirm-overlay" role="dialog" aria-modal="true" aria-labelledby="confirm-title" aria-describedby="confirm-body">
        <div class="confirm-dialog">
            <div id="confirm-header" class="confirm-header">
                <span id="confirm-icon" class="confirm-icon" aria-hidden="true">âš ï¸</span>
                <h3 id="confirm-title" class="confirm-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
            </div>
            <div id="confirm-body" class="confirm-body">
                <p style="margin: 0; line-height: 1.8; color: #555;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ</p>
            </div>
            <div class="confirm-footer">
                <button id="confirm-btn-cancel" class="confirm-btn-cancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="confirm-btn-confirm" class="confirm-btn-confirm" type="button">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>

    <div class="app-container" style="display: none;">
        <button class="sidebar-toggle" onclick="toggleSidebar()">â˜° Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()" id="darkModeToggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†">ğŸŒ™</button>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
                <img src="https://res.cloudinary.com/dgjcr2bgq/image/upload/v1762349658/logo_vlldbc.png" 
     alt="Ø´Ø¹Ø§Ø± Ø¯ÙŠÙˆØ§Ù†ÙŠ" class="header-logo" id="sidebarLogo" 
     style="width: 100px; height: 100px; margin: 0 auto 15px; position: static; transform: none; border-radius: 8px; background: white; padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
            </div>
            
            <div class="sidebar-scrollable-content">
            <div class="sidebar-nav" id="sidebarNav">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>

            <div class="user-section">
                <div class="current-user" id="currentUserDisplay"></div>
                <button class="btn-secondary" id="sidebarChangeActivityBtn" onclick="showActivityModal()" style="width: 100%; margin-top: 10px;">ğŸ”„ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·</button>
                <button class="btn-danger" onclick="logout()" style="width: 100%; margin-top: 10px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
            </div>
        </div>

        <div class="control-panel" id="controlPanel">
            <h3>ğŸ¨ ØªØ®ØµÙŠØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</h3>
            
            <div class="control-group">
                <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø·:</label>
                <select id="fontFamilySelect" onchange="updateFontFamily(this.value)">
                    <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                    <option value="'Tajawal', sans-serif">Tajawal</option>
                    <option value="'Amiri', serif">Amiri</option>
                    <option value="'El Messiri', sans-serif">El Messiri</option>
                    <option value="'Reem Kufi', sans-serif">Reem Kufi</option>
                    <option value="'Arial', sans-serif">Arial</option>
                    <option value="'Helvetica', sans-serif">Helvetica</option>
                </select>
            </div>

            <div class="control-group">
                <label>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·:</label>
                <input type="range" class="font-size-control" min="12" max="20" value="16" onchange="updateFontSize(this.value)">
                <span id="font-size-value">16px</span>
            </div>

            <div class="control-group">
                <label>ğŸ¨ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:</label>
                <input type="color" class="color-picker" value="#2c5aa0" onchange="updateColor('--primary-color', this.value)">
            </div>

            <div class="control-group">
                <label>ğŸ–¼ï¸ Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©:</label>
                <input type="color" class="color-picker" value="#ecf0f1" onchange="updateColor('--bg-color', this.value)">
            </div>

            <div class="control-group">
                <label>ğŸ“ Ù„ÙˆÙ† Ø§Ù„Ù†Øµ:</label>
                <input type="color" class="color-picker" value="#2c3e50" onchange="updateColor('--text-color', this.value)">
            </div>

            <div class="control-group">
                <label>ğŸ›ï¸ Ù„ÙˆÙ† Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©:</label>
                <input type="color" class="color-picker" value="#2c5aa0" onchange="updateHeaderColor(this.value)" id="headerColorPicker">
            </div>

            <div class="control-group">
                <label>ğŸ“‹ Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©:</label>
                <input type="color" class="color-picker" value="#2c3e50" onchange="updateColor('--sidebar-bg', this.value)" id="sidebarColorPicker">
            </div>

            <hr style="margin: 15px 0; border: none; border-top: 1px solid #e0e0e0;">
            
            <!-- ØªØ®ØµÙŠØµ Ø§Ù„ØªØ°ÙŠÙŠÙ„ - Ø®Ø§Øµ Ø¨Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙ‚Ø· -->
            <div id="footerCustomizationSection">
            <h4 style="margin: 10px 0; font-size: 0.95em; color: #1a3a5c;">ğŸ“„ ØªØ®ØµÙŠØµ Ø§Ù„ØªØ°ÙŠÙŠÙ„</h4>
            
            <div class="control-group">
                <label>ğŸ¨ Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØ°ÙŠÙŠÙ„ (Ø£ÙˆÙ„):</label>
                <input type="color" class="color-picker" value="#1e3a5f" onchange="updateFooterGradient(this.value, 'start')" id="footerColor1Picker">
            </div>

            <div class="control-group">
                <label>ğŸ¨ Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØ°ÙŠÙŠÙ„ (Ø«Ø§Ù†ÙŠ):</label>
                <input type="color" class="color-picker" value="#2c4a6f" onchange="updateFooterGradient(this.value, 'end')" id="footerColor2Picker">
            </div>

            <div class="control-group">
                <label>âœï¸ Ø®Ø· Ø§Ù„ØªØ°ÙŠÙŠÙ„:</label>
                <select id="footerFontSelect" onchange="updateFooterFont(this.value)">
                    <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                    <option value="'Tajawal', sans-serif">Tajawal</option>
                    <option value="'Amiri', serif">Amiri</option>
                    <option value="'El Messiri', sans-serif">El Messiri</option>
                    <option value="'Reem Kufi', sans-serif">Reem Kufi</option>
                    <option value="'Arial', sans-serif">Arial</option>
                </select>
            </div>
            </div>

            <button onclick="resetDesign()" class="btn-primary" style="width: 100%; margin-top: 8px; padding: 8px 12px; font-size: 0.9em;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button onclick="toggleControlPanel()" class="btn-danger" style="width: 100%; margin-top: 8px; padding: 8px 12px; font-size: 0.9em;">âŒ Ø¥ØºÙ„Ø§Ù‚</button>
        </div>

<div class="container">
    <div class="header">
        <div class="header-content">
            <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· ÙÙŠ Ø§Ù„ÙˆØ³Ø· -->
            <img src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·" class="activity-header-logo" id="activityHeaderLogo" style="display: none; width: 80px; height: 80px; margin: 0 auto 10px; object-fit: contain; border-radius: 8px;">
            
            <h1 id="activityHeaderTitle">Ø¯ÙŠÙˆØ§Ù†ÙŠ</h1>
            <div class="subtitle" id="activityHeaderSubtitle">Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù…ØªÙƒØ§Ù…Ù„</div>
        </div>
    </div>

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
    <div id="notifications-container"></div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª -->
    <div id="trash-modal">
        <div class="trash-content">
            <div class="trash-header">
                <h2>ğŸ—‘ï¸ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</h2>
                <button class="btn-secondary" onclick="closeTrashModal()">âœ– Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            
            <p style="text-align: center; color: #666; font-size: 0.95em; margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 8px;">
                ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ù„Ù…Ø¯Ø© 30 ÙŠÙˆÙ…Ø§Ù‹
            </p>
            
            <div class="trash-stats">
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-items">0</div>
                    <div class="trash-stat-label">Ø£ØµÙ†Ø§Ù</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-customers">0</div>
                    <div class="trash-stat-label">Ø¹Ù…Ù„Ø§Ø¡</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-suppliers">0</div>
                    <div class="trash-stat-label">Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-purchases">0</div>
                    <div class="trash-stat-label">Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-sales">0</div>
                    <div class="trash-stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-expenses">0</div>
                    <div class="trash-stat-label">Ù…ØµØ±ÙˆÙØ§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-revenues">0</div>
                    <div class="trash-stat-label">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-salesReturns">0</div>
                    <div class="trash-stat-label">Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-purchaseReturns">0</div>
                    <div class="trash-stat-label">Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-total">0</div>
                    <div class="trash-stat-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                </div>
            </div>

            <div class="trash-tabs">
                <button class="trash-tab active" onclick="renderTrashItems('items')">ğŸ“¦ Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
                <button class="trash-tab" onclick="renderTrashItems('customers')">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
                <button class="trash-tab" onclick="renderTrashItems('suppliers')">ğŸ­ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</button>
                <button class="trash-tab" onclick="renderTrashItems('purchases')">ğŸ“¥ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('sales')">ğŸ“¤ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('expenses')">ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('revenues')">ğŸ’° Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('salesReturns')">â†©ï¸ Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('purchaseReturns')">â†ªï¸ Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª</button>
            </div>

            <div id="trash-items-container" class="trash-items"></div>
        </div>
    </div>

    <div id="home" class="section active">
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø¯ÙŠÙˆØ§Ù†ÙŠ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</h2>
        <p>Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù…Ù„ÙŠØ§ØªÙƒ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©</p>
       <div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
        <div class="stat-number" id="totalStockQuantity">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
        <div class="stat-number" id="stockValue">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
        <div class="stat-number" id="totalItems">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="stat-number" id="totalCustomers">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
        <div class="stat-number" id="totalSuppliers">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
        <div class="stat-number" id="totalSales">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
        <div class="stat-number" id="totalPurchases">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
        <div class="stat-number" id="totalExpensesHome">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
        <div class="stat-number" id="totalRevenuesHome">0</div>
    </div>
    <div class="stat-card">
    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù</div>
    <div class="stat-number" id="totalAdvancesHome">0</div>
</div>
<div class="stat-card">
    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„</div>
    <div class="stat-number" id="totalAssetsHome">0.00</div>
</div>
<div class="stat-card">
    <div class="stat-label">ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ù…ØªØ§Ø­</div>
    <div class="stat-number" id="availableCash">0.00</div>
</div>
</div>
</div> <!-- End of container -->

<div id="advanced-dashboard" class="section">
    <h2>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
    
    <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© -->
    <div class="stats-grid advanced-stats">
        <div class="stat-card">
            <div class="stat-number" id="todaySales">0</div>
            <div class="stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="stat-trend" id="salesTrend">â†—ï¸ +12%</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayPurchases">0</div>
            <div class="stat-label">Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="stat-trend" id="purchasesTrend">â†—ï¸ +8%</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayExpenses">0</div>
            <div class="stat-label">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="stat-trend" id="expensesTrend">â†—ï¸ +15%</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayRevenues">0</div>
            <div class="stat-label">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="stat-trend" id="revenuesTrend">â†—ï¸ +5%</div>
        </div>
    </div>

    <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© -->
    <div class="stats-grid advanced-stats" style="margin-top: 30px;">
        <div class="stat-card">
            <div class="stat-number" id="monthlySales">0</div>
            <div class="stat-label">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
            <div class="stat-trend" id="monthlySalesTrend">ğŸ“Š</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="monthlyPurchases">0</div>
            <div class="stat-label">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
            <div class="stat-trend" id="monthlyPurchasesTrend">ğŸ“Š</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="monthlyExpensesCard">0</div>
            <div class="stat-label">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
            <div class="stat-trend" id="monthlyExpensesTrend">ğŸ“Š</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="monthlyRevenues">0</div>
            <div class="stat-label">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
            <div class="stat-trend" id="monthlyRevenuesTrend">ğŸ“Š</div>
        </div>
    </div>

    <!-- ğŸ†• Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (KPIs) -->
    <div class="kpi-section" style="margin-top: 40px;">
        <h3 style="margin-bottom: 20px; color: var(--primary-color); font-size: 20px;">ğŸ’ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
        <div class="stats-grid advanced-stats">
            <div class="stat-card kpi-card" style="background: white; border: 3px solid #667eea; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);">
                <div class="stat-number" id="kpiNetProfit" style="color: #667eea;">0</div>
                <div class="stat-label" style="color: #555;">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø§Ù„Ø´Ù‡Ø±)</div>
                <div class="stat-trend" id="kpiNetProfitTrend" style="color: #667eea;">ğŸ“ˆ +0%</div>
            </div>
            <div class="stat-card kpi-card" style="background: white; border: 3px solid #f5576c; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.2);">
                <div class="stat-number" id="kpiCustomersDebt" style="color: #f5576c;">0</div>
                <div class="stat-label" style="color: #555;">Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                <div class="stat-trend" id="kpiCustomersCount" style="color: #f5576c;">ğŸ‘¥ 0 Ø¹Ù…ÙŠÙ„</div>
            </div>
            <div class="stat-card kpi-card" style="background: white; border: 3px solid #4facfe; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.2);">
                <div class="stat-number" id="kpiSuppliersDebt" style="color: #4facfe;">0</div>
                <div class="stat-label" style="color: #555;">Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
                <div class="stat-trend" id="kpiSuppliersCount" style="color: #4facfe;">ğŸ¢ 0 Ù…ÙˆØ±Ø¯</div>
            </div>
            <div class="stat-card kpi-card" style="background: white; border: 3px solid #43e97b; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.2);">
                <div class="stat-number" id="kpiCashFlow" style="color: #43e97b;">0</div>
                <div class="stat-label" style="color: #555;">Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ù…ØªØ§Ø­</div>
                <div class="stat-trend" id="kpiCashFlowTrend" style="color: #43e97b;">ğŸ’° Ø§Ù„ÙŠÙˆÙ…</div>
            </div>
        </div>
    </div>

    <!-- ğŸ†• Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="charts-section" style="margin-top: 40px;">
        <h3 style="margin-bottom: 20px; color: var(--primary-color); font-size: 20px;">ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</h3>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
            <!-- Ø±Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª vs Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
            <div class="chart-card">
                <h3>ğŸ“ˆ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª vs Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±)</h3>
                <canvas id="salesVsPurchasesChart"></canvas>
            </div>
            
            <!-- Ø±Ø³Ù… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª -->
            <div class="chart-card">
                <h3>ğŸ¯ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h3>
                <canvas id="expensesDistributionChart"></canvas>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <!-- Ø±Ø³Ù… Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ø¨ÙŠØ¹Ø§Ù‹ -->
            <div class="chart-card">
                <h3>ğŸ† Ø£Ø¹Ù„Ù‰ 5 Ø£ØµÙ†Ø§Ù Ù…Ø¨ÙŠØ¹Ø§Ù‹</h3>
                <canvas id="topItemsChart"></canvas>
            </div>
            
            <!-- Ø±Ø³Ù… Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ -->
            <div class="chart-card">
                <h3>ğŸ’° Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h3>
                <canvas id="cashFlowChart"></canvas>
            </div>
        </div>
    </div>
</div>

    <div id="warehouses" class="section">
        <!-- Top Stats Bar -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
            <div style="background: linear-gradient(135deg, rgba(21, 101, 192, 0.9) 0%, rgba(33, 150, 243, 0.9) 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);">
                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">ğŸ­ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</div>
                <div id="totalWarehousesCount" style="font-size: 2.2em; font-weight: bold;">0</div>
            </div>
            <div style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.8) 0%, rgba(66, 165, 245, 0.8) 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);">
                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
                <div id="totalItemsQuantity" style="font-size: 2.2em; font-weight: bold;">0</div>
            </div>
            <div style="background: linear-gradient(135deg, rgba(3, 169, 244, 0.8) 0%, rgba(79, 195, 247, 0.8) 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(3, 169, 244, 0.3);">
                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
                <div id="totalInventoryValue" style="font-size: 2.2em; font-weight: bold;">0 Ø±.Ø³</div>
            </div>
        </div>

        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: #1a3a5c;">ğŸ­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</h2>
            <button class="btn-primary" onclick="openAddWarehouse()" style="background: linear-gradient(135deg, rgba(21, 101, 192, 0.9) 0%, rgba(33, 150, 243, 0.9) 100%); padding: 12px 24px; font-weight: 600;">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆØ¯Ø¹ Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <!-- Warehouses Grid -->
        <div id="warehousesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <!-- Warehouse cards will be injected here -->
        </div>

        <!-- Add/Edit Warehouse Modal -->
        <div id="warehouseModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
            <div class="modal-content" style="max-width: 600px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #667eea; padding-bottom: 15px;">
                    <h2 id="warehouseModalTitle" style="margin: 0; color: #667eea;">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆØ¯Ø¹ Ø¬Ø¯ÙŠØ¯</h2>
                    <button onclick="closeWarehouseModal()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 16px;">âœ–</button>
                </div>
                
                <div class="form-grid grid-2" style="gap: 15px;">
                    <div>
                        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ *</label>
                        <input type="text" id="warehouseName" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ" required>
                    </div>
                    <div>
                        <label>Ø§Ù„ÙƒÙˆØ¯</label>
                        <input type="text" id="warehouseCode" placeholder="ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly style="background: #f8f9fa;">
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                    <textarea id="warehouseAddress" rows="2" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø£Ùˆ Ù…ÙˆÙ‚Ø¹Ù‡"></textarea>
                </div>
                
                <div class="form-grid grid-2" style="gap: 15px; margin-top: 15px;">
                    <div>
                        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±</label>
                        <input type="text" id="warehouseManager" placeholder="Ø§Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹">
                    </div>
                    <div>
                        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="text" id="warehousePhone" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹">
                    </div>
                </div>
                
                <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <input type="checkbox" id="warehouseIsPrimary" style="transform: scale(1.3); cursor: pointer;">
                    <label for="warehouseIsPrimary" style="margin: 0; cursor: pointer; font-weight: 600;">ğŸ† ØªØ¹ÙŠÙŠÙ† ÙƒÙ…Ø³ØªÙˆØ¯Ø¹ Ø±Ø¦ÙŠØ³ÙŠ</label>
                </div>
                
                <div style="margin-top: 25px; display: flex; gap: 15px; justify-content: center;">
                    <button class="btn-primary" onclick="saveWarehouse()" style="padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</button>
                    <button class="btn-secondary" onclick="closeWarehouseModal()" style="padding: 12px 30px;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

<div id="items" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatItems" class="stat-mini-number">0</span></span></h2>
        <button type="button" class="btn-primary" onclick="showSection('addItem')" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">Ø§Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</button>
    </div>
    
    <div class="search-container">
        <input type="text" id="searchItems" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('itemsFilters')">
            <span> </span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="itemsFilters" class="filters-container">
        <div class="filters-grid">
            <div class="filter-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ù…Ù†)</label>
                <input type="number" id="itemCostFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="itemCostTo" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ù…Ù†)</label>
                <input type="number" id="itemPriceFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="itemPriceTo" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ø±ØµÙŠØ¯ (Ù…Ù†)</label>
                <input type="number" id="itemStockFrom" class="filter-input" placeholder="0">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ø±ØµÙŠØ¯ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="itemStockTo" class="filter-input" placeholder="0">
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetItemsFilters()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button class="btn-primary" onclick="applyItemsFilters()">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        </div>
    </div>

    <table id="itemsTable">
   <thead>
    <tr>
        <th class="sortable" data-column="code">Ø§Ù„ÙƒÙˆØ¯</th>
        <th class="sortable" data-column="name">Ø§Ù„Ø§Ø³Ù…</th>
        <th class="sortable" data-column="category">Ø§Ù„ÙØ¦Ø©</th>
        <th class="sortable" data-column="unit">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
        <th class="sortable" data-column="cost">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
        <th class="sortable" data-column="price">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
        <th class="sortable" data-column="stock">Ø§Ù„Ø±ØµÙŠØ¯</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    </tr>
</thead>
        <tbody id="itemsList"></tbody>
    </table>
</div>

<div id="addItem" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h2>
        <button type="button" class="btn-secondary" onclick="showSection('items')">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    
    <div class="form-grid grid-3">
        <input type="text" id="itemCodeNew" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù" onchange="warnCodeChange(this)">
        <input type="text" id="itemNameNew" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù *" required>
        <select id="itemCategoryNew" style="padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø© *</option>
            <option value="food">ğŸ” Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©</option>
            <option value="beverages">ğŸ¥¤ Ù…Ø´Ø±ÙˆØ¨Ø§Øª</option>
            <option value="cleaning">ğŸ§¹ Ù…Ù†Ø¸ÙØ§Øª</option>
            <option value="stationery">ğŸ“ Ù‚Ø±Ø·Ø§Ø³ÙŠØ©</option>
            <option value="electronics">âš¡ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</option>
            <option value="clothing">ğŸ‘• Ù…Ù„Ø§Ø¨Ø³</option>
            <option value="cosmetics">ğŸ’„ Ø¹Ø·ÙˆØ± ÙˆØªØ¬Ù…ÙŠÙ„</option>
            <option value="medical">ğŸ’Š Ø£Ø¯ÙˆÙŠØ© ÙˆÙ…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø·Ø¨ÙŠØ©</option>
            <option value="building">ğŸ”¨ Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡</option>
            <option value="spare_parts">ğŸ”§ Ù‚Ø·Ø¹ ØºÙŠØ§Ø±</option>
            <option value="other">ğŸ“¦ Ø£Ø®Ø±Ù‰</option>
        </select>
    </div>
    
    <div class="form-grid grid-3">
        <input type="number" id="itemCostNew" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" min="0" step="0.01">
        <input type="number" id="itemStockNew" placeholder="Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ *" required>
        <input type="number" id="itemMinStockNew" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†" min="0">
    </div>

    <!-- ğŸ“ Multi-Unit System -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border: 2px solid #667eea;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #667eea;">ğŸ“ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©</h3>
            <button type="button" class="btn-primary" onclick="addUnitRow()" style="padding: 8px 16px;">â• Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø©</button>
        </div>
        
        <div id="unitsContainer">
            <!-- Base Unit Row (Required) -->
            <div class="unit-row" data-unit-index="0" style="display: grid; grid-template-columns: 2fr 1.5fr 2fr 80px; gap: 10px; margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px; border: 2px solid #28a745;">
                <div>
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© *</label>
                    <input type="text" class="unit-name" placeholder="Ù…Ø«Ø§Ù„: Ø¬Ø±Ø§Ù…" required style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                </div>
                <div>
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</label>
                    <input type="number" class="unit-factor" value="1" readonly style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; background: #e9ecef;">
                </div>
                <div>
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ *</label>
                    <input type="number" class="unit-price" placeholder="0.00" min="0" step="0.01" required style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button type="button" class="btn-secondary" disabled style="padding: 10px; opacity: 0.5; cursor: not-allowed;">ğŸ”’ Ø£Ø³Ø§Ø³ÙŠØ©</button>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 6px; border-right: 4px solid #2196f3;">
            <small style="color: #1976d2;">
                <strong>ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù‡ÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† (Ù…Ø«Ù„: Ø¬Ø±Ø§Ù… Ù„Ù„Ø¹ÙˆØ¯). Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ = ÙƒÙ… ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©ØŸ (Ù…Ø«Ø§Ù„: ØªÙˆÙ„Ø© = 12 Ø¬Ø±Ø§Ù…)
            </small>
        </div>
    </div>
    
    <div style="text-align: center; margin-top: 20px;">
        <button class="btn-primary btn-add" onclick="addItemNew()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); padding: 12px 40px; font-size: 16px;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
    </div>
</div>

<div id="storePermissions" class="section">
    <h2>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©</h2>
    
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e9ecef;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; font-size: 1.1em;">Ø¨Ø­Ø«</h3>
        </div>
        
        <div class="form-grid grid-3">
            <div class="filter-group">
                <label>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ</label>
                <input type="text" id="permNumber" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ù…ØµØ¯Ø± Ø§Ù„Ø¥Ø°Ù†</label>
                <select id="permSource" class="filter-input">
                    <option value="">Ø§Ù„ÙƒÙ„</option>
                    <option value="sales">Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                    <option value="purchases">Ù…Ø´ØªØ±ÙŠØ§Øª</option>
                    <option value="sales_return">Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                    <option value="purchase_return">Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª</option>
                    <option value="manual">ÙŠØ¯ÙˆÙŠ</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø±Ù</label>
                <input type="text" id="permRef" class="filter-input">
            </div>
        </div>
        
        <div class="form-grid grid-3">
            <div class="filter-group">
                <label>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</label>
                <select id="permWarehouse" class="filter-input">
                    <option value="">Ø§Ù„ÙƒÙ„</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                <select id="permCustomer" class="filter-input">
                    <option value="">Ø£ÙŠ Ø¹Ù…ÙŠÙ„</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                <select id="permSupplier" class="filter-input">
                    <option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>
                </select>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; margin-top: 15px;">
            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="searchPermissions()">Ø¨Ø­Ø«</button>
                <button class="btn-secondary" onclick="openAdvancedPermissionsSearch()">
                    ğŸ” Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…
                </button>
            </div>
            <button class="btn-success" onclick="openManualPermissionModal()">
                â• Ø¥Ø°Ù† ØªØ³ÙˆÙŠØ© (Ø¬Ø±Ø¯)
            </button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… -->
    <div id="advancedPermissionsSearchModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 800px; max-height: 85vh; overflow-y: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #667eea;">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©</h2>
                <button onclick="closeAdvancedPermissionsSearch()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 16px;">âœ–</button>
            </div>
            
            <div class="form-grid grid-2">
                <div>
                    <label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="permDateFrom" class="filter-input">
                </div>
                <div>
                    <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="permDateTo" class="filter-input">
                </div>
            </div>
            
            <div class="form-grid grid-2" style="margin-top: 15px;">
                <div>
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø°Ù†:</label>
                    <select id="permTypeAdvanced" class="filter-input">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                        <option value="in">ğŸ“¥ Ø¥Ø¯Ø®Ø§Ù„</option>
                        <option value="out">ğŸ“¤ ØµØ±Ù</option>
                    </select>
                </div>
                <div>
                    <label>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</label>
                    <select id="permWarehouseAdvanced" class="filter-input">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                    </select>
                </div>
            </div>
            
            <div class="form-grid grid-2" style="margin-top: 15px;">
                <div>
                    <label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                    <select id="permCustomerAdvanced" class="filter-input">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                    </select>
                </div>
                <div>
                    <label>Ø§Ù„Ù…ÙˆØ±Ø¯:</label>
                    <select id="permSupplierAdvanced" class="filter-input">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                <button class="btn-primary" onclick="applyAdvancedPermissionsSearch()" style="padding: 12px 30px;">ğŸ” Ø¨Ø­Ø«</button>
                <button class="btn-secondary" onclick="resetAdvancedPermissionsSearch()" style="padding: 12px 30px;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø¥Ø°Ù† ØªØ³ÙˆÙŠØ© ÙŠØ¯ÙˆÙŠ -->
    <div id="manualPermissionModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; overflow-y: auto;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); margin: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #2c5aa0;">ğŸ“‹ Ø¥Ø°Ù† ØªØ³ÙˆÙŠØ© Ù…Ø®Ø²Ù†ÙŠØ© ÙŠØ¯ÙˆÙŠ</h2>
                <button onclick="closeManualPermissionModal()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 16px;">âœ–</button>
            </div>
            
            <div class="form-grid grid-3">
                <div>
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                    <input type="date" id="manualPermDate" required>
                </div>
                <div>
                    <label>Ù†ÙˆØ¹ Ø§Ù„ØªØ³ÙˆÙŠØ© *</label>
                    <select id="manualPermType" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                        <option value="in">ğŸ“¥ Ø²ÙŠØ§Ø¯Ø© (ÙØ§Ø¦Ø¶ Ø¬Ø±Ø¯)</option>
                        <option value="out">ğŸ“¤ Ù†Ù‚Øµ (Ø¹Ø¬Ø²/ØªØ§Ù„Ù/Ù…Ø³Ø­ÙˆØ¨Ø§Øª)</option>
                    </select>
                </div>
                <div>
                    <label>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ *</label>
                    <select id="manualPermWarehouse" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <label>Ø§Ù„Ø³Ø¨Ø¨/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª *</label>
                <textarea id="manualPermNotes" rows="3" placeholder="Ù…Ø«Ø§Ù„: ÙØ§Ø¦Ø¶ Ø¬Ø±Ø¯ØŒ ØªÙ„ÙØŒ Ù…Ø³Ø­ÙˆØ¨Ø§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©..." required></textarea>
            </div>
            
            <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
                    <button class="btn-success" onclick="addManualPermissionRow()" type="button">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
                </div>
                
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; border: 1px solid #dee2e6;">Ø§Ù„ØµÙ†Ù</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; width: 150px;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; width: 120px;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; width: 80px;">Ø­Ø°Ù</th>
                        </tr>
                    </thead>
                    <tbody id="manualPermItemsBody">
                        <!-- Rows will be added dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 25px; display: flex; gap: 15px; justify-content: center;">
                <button class="btn-primary" onclick="saveManualPermission()" style="padding: 12px 30px;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø°Ù†</button>
                <button class="btn-secondary" onclick="closeManualPermissionModal()" style="padding: 12px 30px;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <table id="permissionsTable">
        <thead>
            <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù†</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</th>
                <th>Ø§Ù„Ø·Ø±Ù</th>
                <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                <th>Ø§Ù„Ø£ØµÙ†Ø§Ù</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="permissionsList"></tbody>
    </table>
</div>

<!-- ===== ğŸ“‹ Inventory Management Section ===== -->
<div id="inventory" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø±Ø¯ ÙˆØ§Ù„ØªØ³ÙˆÙŠØ§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatInventory" class="stat-mini-number">0</span></span></h2>
        <button class="btn-primary" onclick="openInventoryModal()" style="background: linear-gradient(135deg, rgba(21, 101, 192, 0.9) 0%, rgba(33, 150, 243, 0.9) 100%);">â• Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¬Ø±Ø¯ Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
    
    <div style="background: linear-gradient(135deg, rgba(21, 101, 192, 0.9) 0%, rgba(33, 150, 243, 0.9) 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                <div style="color: rgba(255,255,255,0.9); font-size: 0.9em; margin-bottom: 5px;">ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
                <div id="inventoryTotalItems" style="color: white; font-size: 1.8em; font-weight: bold;">0</div>
            </div>
            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                <div style="color: rgba(255,255,255,0.9); font-size: 0.9em; margin-bottom: 5px;">âœ… Ø¬Ø±Ø¯ ÙƒØ§Ù…Ù„</div>
                <div id="inventoryFullCount" style="color: #4caf50; font-size: 1.8em; font-weight: bold;">0</div>
            </div>
            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                <div style="color: rgba(255,255,255,0.9); font-size: 0.9em; margin-bottom: 5px;">ğŸ“ˆ ÙØ§Ø¦Ø¶ (Ø²ÙŠØ§Ø¯Ø©)</div>
                <div id="inventorySurplusCount" style="color: #4caf50; font-size: 1.8em; font-weight: bold;">0</div>
            </div>
            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                <div style="color: rgba(255,255,255,0.9); font-size: 0.9em; margin-bottom: 5px;">ğŸ“‰ Ø¹Ø¬Ø² (Ù†Ù‚Øµ)</div>
                <div id="inventoryShortageCount" style="color: #ff5252; font-size: 1.8em; font-weight: bold;">0</div>
            </div>
        </div>
    </div>
    
    <div style="margin-bottom: 20px;">
        <h3 style="color: #1976d2; margin-bottom: 15px;">ğŸ“œ Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¬Ø±Ø¯</h3>
        <table id="inventoryHistoryTable">
            <thead>
                <tr>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</th>
                    <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</th>
                    <th>Ø§Ù„ÙØ§Ø¦Ø¶</th>
                    <th>Ø§Ù„Ø¹Ø¬Ø²</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¨Ø§ÙŠÙ†</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="inventoryHistoryList">
                <tr>
                    <td colspan="9" style="text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“‹</div>
                        <div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¬Ø±Ø¯ Ù…Ø³Ø¬Ù„Ø©. Ø§Ø¨Ø¯Ø£ Ø¹Ù…Ù„ÙŠØ© Ø¬Ø±Ø¯ Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ø¢Ù†!</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal for Inventory Counting -->
<div id="inventoryModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; overflow-y: auto;">
    <div class="modal-content" style="max-width: 95%; width: 1400px; max-height: 90vh; overflow-y: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); margin: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 3px solid #667eea; padding-bottom: 15px;">
            <h2 style="margin: 0; color: #1976d2;">ğŸ“‹ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ</h2>
            <button onclick="closeInventoryModal()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 16px;">âœ–</button>
        </div>
        
        <div class="form-grid grid-3" style="margin-bottom: 20px;">
            <div>
                <label>Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                <input type="date" id="inventoryDate" required>
            </div>
            <div>
                <label>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ *</label>
                <select id="inventoryWarehouse" required>
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</option>
                </select>
            </div>
            <div>
                <label>Ø§Ù„Ù…Ø±Ø¬Ø¹</label>
                <input type="text" id="inventoryReference" placeholder="Ù…Ø«Ø§Ù„: Ø¬Ø±Ø¯ Ø³Ù†ÙˆÙŠ 2024">
            </div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <textarea id="inventoryNotes" rows="2" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¬Ø±Ø¯..."></textarea>
        </div>
        
        <div style="margin-bottom: 15px; background: #e3f2fd; padding: 15px; border-radius: 8px; border-right: 4px solid #2196f3;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong style="color: #1976d2;">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¬Ø±Ø¯:</strong>
                    <span style="margin-right: 20px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù: <strong id="inventoryItemsCount">0</strong></span>
                    <span style="margin-right: 20px; color: #4caf50;">ÙØ§Ø¦Ø¶: <strong id="inventorySurplusDisplay">0</strong></span>
                    <span style="color: #f44336;">Ø¹Ø¬Ø²: <strong id="inventoryShortageDisplay">0</strong></span>
                </div>
                <div>
                    <input type="text" id="inventorySearchInput" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù..." style="padding: 8px; border: 1px solid #ced4da; border-radius: 6px; width: 250px;" oninput="filterInventoryItems()">
                </div>
            </div>
        </div>
        
        <div style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 100;">
                    <tr>
                        <th style="padding: 12px; border: 1px solid #dee2e6; white-space: nowrap;">Ø§Ù„ÙƒÙˆØ¯</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6;">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6; width: 120px;">Ø§Ù„Ø±ØµÙŠØ¯ (Ù†Ø¸Ø§Ù…)</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6; width: 120px; background: #fff3cd;">Ø§Ù„Ø±ØµÙŠØ¯ (ÙØ¹Ù„ÙŠ)</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6; width: 120px;">Ø§Ù„ÙØ±Ù‚</th>
                        <th style="padding: 12px; border: 1px solid #dee2e6; width: 80px;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    </tr>
                </thead>
                <tbody id="inventoryCountingBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 25px; display: flex; gap: 15px; justify-content: center;">
            <button class="btn-primary" onclick="saveInventoryAdjustment()" style="padding: 12px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ’¾ Ø­ÙØ¸ ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª</button>
            <button class="btn-secondary" onclick="closeInventoryModal()" style="padding: 12px 40px;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div id="customers" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatCustomers" class="stat-mini-number">0</span></span></h2>
        <button class="btn-primary" onclick="showAddCustomerForm()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
    </div>
    
    <div id="addCustomerForm" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e9ecef;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
            <button class="btn-secondary" onclick="hideAddCustomerForm()">âŒ Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        <div class="form-grid grid-3">
            <input type="text" id="customerCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„">
            <input type="text" id="customerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *" required>
            <input type="text" id="customerPhone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
        </div>
        
        <div class="form-grid grid-3">
            <input type="email" id="customerEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="text" id="customerAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
            <button id="btnSaveCustomer" class="btn-primary btn-add" onclick="addCustomer()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
        </div>
    </div>

    <div id="customersListContainer">
        <div class="search-container">
            <input type="text" id="searchCustomers" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...">
            <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('customersFilters')">
                <span> </span>
                <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
                <span>â–¼</span>
            </button>
        </div>
        
        <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
        <div id="customersFilters" class="filters-container">
            <p style="color: #666; margin-bottom: 10px;">ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø£Ø¹Ù„Ø§Ù‡ Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø§Ù„ÙƒÙˆØ¯ØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)</p>
            <div class="filter-actions">
                <button class="btn-secondary" onclick="resetCustomersFilters()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ø­Ø«</button>
            </div>
        </div>

        <table id="customersTable">
            <thead>
        <tr>
            <th class="sortable" data-column="code">Ø§Ù„ÙƒÙˆØ¯</th>
            <th class="sortable" data-column="name">Ø§Ù„Ø§Ø³Ù…</th>
            <th class="sortable" data-column="phone">Ø§Ù„Ù‡Ø§ØªÙ</th>
            <th class="sortable" data-column="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
            <th class="sortable" data-column="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
    </thead>
            <tbody id="customersList"></tbody>
        </table>
    </div>
</div>

<div id="suppliers" class="section">
    <h2>ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatSuppliers" class="stat-mini-number">0</span></span></h2>
    
    <div class="form-grid grid-3">
        <input type="text" id="supplierCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯">
        <input type="text" id="supplierName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ *" required>
        <input type="text" id="supplierPhone" placeholder=" Ø§Ù„Ù‡Ø§ØªÙ">
    </div>
    
    <div class="form-grid grid-3">
        <input type="email" id="supplierEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="text" id="supplierAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
        <button class="btn-primary btn-add" onclick="addSupplier()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchSuppliers" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('suppliersFilters')">
            <span> </span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="suppliersFilters" class="filters-container">
        <p style="color: #666; margin-bottom: 10px;">ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø£Ø¹Ù„Ø§Ù‡ Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø§Ù„ÙƒÙˆØ¯ØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)</p>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetSuppliersFilters()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ø­Ø«</button>
        </div>
    </div>

    <table id="suppliersTable">
        <thead>
            <tr>
                <th class="sortable" data-column="code">Ø§Ù„ÙƒÙˆØ¯</th>
                <th class="sortable" data-column="name">Ø§Ù„Ø§Ø³Ù…</th>
                <th class="sortable" data-column="phone">Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th class="sortable" data-column="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                <th class="sortable" data-column="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="suppliersList"></tbody>
    </table>
</div>

<div id="purchasesManagement" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
        <button type="button" class="btn-primary" onclick="showSection('purchases'); newPurchase();" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">â• Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchPurchases" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('purchasesFilters')">
            <span>ğŸ”½</span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="purchasesFilters" class="filters-container">
        <div class="filters-grid">
            <div class="filter-group">
                <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="purchasesDateFrom" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="purchasesDateTo" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ù…Ù†)</label>
                <input type="number" id="purchasesAmountFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="purchasesAmountTo" class="filter-input" placeholder="0.00">
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetPurchasesFilters()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button class="btn-primary" onclick="applyPurchasesFilters()">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        </div>
    </div>
    
    <table id="purchasesTable">
        <thead>
            <tr>
                <th class="sortable" data-column="code">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th class="sortable" data-column="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th class="sortable" data-column="supplierId">Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                <th class="sortable" data-column="itemsCount">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th class="sortable" data-column="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th class="sortable" data-column="paidAmount">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                <th class="sortable" data-column="remainingAmount">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                <th>Ø§Ù„Ù…Ø±ÙÙ‚</th> <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="purchasesList"></tbody>
    </table>
</div>

<div id="purchases" class="section">
    <h2>ğŸ›’ ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯Ø©</h2>
    <p>ğŸ“ Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>
    
    <div class="form-grid grid-4">
        <input type="text" id="purchaseCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©" readonly>
        <input type="date" id="purchaseDate">
        <select id="purchaseSupplier" onchange="updateSupplierFields()">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯</option>
        </select>
        <select id="purchaseBranch">
            <option value="general_admin">ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>
            <option value="">ğŸª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
        </select>
    </div>
    
    <div class="form-grid grid-4">
        <input type="text" id="purchaseSupplierName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯" readonly>
        <input type="text" id="purchaseSupplierCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯" readonly>
        <input type="text" id="purchaseSupplierPhone" placeholder="Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ±Ø¯" readonly>
        <input type="text" id="purchaseSupplierAddress" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ±Ø¯">
    </div>
    
    <div class="form-grid grid-4">
        <select id="purchaseItem" onchange="updatePurchaseItemUnits()">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>
        </select>
        <input type="number" id="purchaseQuantity" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" min="1" value="1">
        <select id="purchaseUnit" onchange="updatePurchaseUnitPrice()">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© --</option>
        </select>
        <input type="number" id="purchasePrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
        <input type="text" id="purchaseNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª" style="grid-column: span 3;">
        <button class="btn-primary btn-add" onclick="addPurchaseItem()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; white-space: nowrap;"> Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    </div>
    
    <div class="invoice-items">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø§Ù„ÙØ¦Ø©</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="purchaseItemsList"></tbody>
        </table>
    </div>
    
    <div class="invoice-totals">
        <div>
            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
            <span id="purchaseSubtotal">0.00</span>
        </div>
        <div>
            <span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
            <span id="purchaseTax">0.00</span>
        </div>
         <div>
            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
            <input type="number" id="purchasePaidAmount" placeholder="0.00" oninput="updatePurchaseTotals()">
        </div>
        <div>
            <span>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</span>
            <select id="purchasePaymentMethod" style="padding: 8px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                <option value="cash">ğŸ’µ Ù†Ù‚Ø¯ÙŠ</option>
                <option value="bank">ğŸ¦ Ø¨Ù†Ùƒ</option>
            </select>
        </div>
        <div>
            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
            <span id="purchaseRemainingAmount" class="remaining-unpaid">0.00</span>
        </div>
        <div class="total">
            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
            <span id="purchaseTotal">0.00</span>
        </div>
    </div>
    
   <div style="display: flex; gap: 10px; margin-top: 20px; align-items: center; flex-wrap: wrap;">
    <button class="btn-primary" id="savePurchaseBtn" onclick="savePurchase()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 40px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
    <button class="btn-secondary" onclick="showSection('purchasesManagement')" style="padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">âŒ Ø¥Ù„ØºØ§Ø¡</button>

    <input type="file" id="purchaseAttachment" accept="image/*,application/pdf" style="flex: 1; min-width: 250px; padding: 10px; border: 2px dashed var(--primary-color); background: #f8f9fa;">
</div>
</div>

<div id="salesManagement" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2>
        <button type="button" class="btn-primary" onclick="showSection('sales')" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">â• Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
    
    <div class="search-container">
        <input type="text" id="searchSalesManagement" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±..." onkeyup="searchInSales()">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('salesFiltersManagement')">
            <span>ğŸ”½</span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <div id="salesFiltersManagement" class="filters-container">
        <div class="filters-grid">
            <div class="filter-group">
                <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="salesFromDateManagement" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="salesToDateManagement" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                <select id="salesCustomerFilterManagement" class="filter-input">
                    <option value="">Ø§Ù„ÙƒÙ„</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                <select id="salesPaymentMethodFilterManagement" class="filter-input">
                    <option value="">Ø§Ù„ÙƒÙ„</option>
                    <option value="cash">ğŸ’µ Ù†Ù‚Ø¯ÙŠ</option>
                    <option value="bank">ğŸ¦ Ø¨Ù†Ùƒ</option>
                    <option value="mixed">ğŸ”€ Ù…Ø®ØªÙ„Ø·</option>
                </select>
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetSalesFiltersManagement()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button class="btn-primary" onclick="applySalesFiltersManagement()">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        </div>
    </div>

    <table id="salesTableManagement">
        <thead>
            <tr>
                <th class="sortable" data-column="number">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th class="sortable" data-column="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th class="sortable" data-column="customer">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th class="sortable" data-column="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th class="sortable" data-column="paid">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                <th class="sortable" data-column="remaining">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                <th class="sortable" data-column="paymentMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="salesListManagement"></tbody>
    </table>
</div>

<div id="sales" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div>
            <h2>ğŸ’° ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatSales" class="stat-mini-number">0</span></span></h2>
            <p style="margin-bottom: 0;">ğŸ“ˆ Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
        </div>
        <button class="btn-secondary" onclick="showSection('salesManagement')">âŒ Ø¥Ù„ØºØ§Ø¡ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©</button>
    </div>
    
    <div class="form-grid grid-4">
        <input type="text" id="saleCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©" readonly>
        <input type="date" id="saleDate">
        <select id="saleCustomer" onchange="updateCustomerFields()">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
        </select>
        <select id="saleBranch">
            <option value="">ğŸª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
        </select>
    </div>
    
    <div class="form-grid grid-4">
        <input type="text" id="saleCustomerCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„" readonly>
        <input type="text" id="saleCustomerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" readonly>
        <input type="text" id="saleCustomerPhone" placeholder="Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„" readonly>
        <input type="text" id="saleCustomerAddress" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„">
    </div>
    
    <div class="form-grid grid-4">
        <select id="saleItem" onchange="updateSaleItemUnits()">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>
        </select>
        <input type="number" id="saleQuantity" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" min="1" value="1">
        <select id="saleUnit" onchange="updateSaleUnitPrice()">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© --</option>
        </select>
        <input type="number" id="salePrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
        <input type="text" id="saleNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª" style="grid-column: span 3;">
        <button class="btn-primary btn-add" onclick="addSaleItem()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; white-space: nowrap;"> Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    </div>
    
    <div class="invoice-items" id="saleItemsTableContainer" style="display: none;">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="saleItemsList"></tbody>
        </table>
    </div>
    
    <div class="invoice-totals">
        <div>
            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
            <span id="saleSubtotal">0.00</span>
        </div>
        <div>
            <span>Ø§Ù„Ø®ØµÙ…:</span>
            <input type="number" id="saleDiscount" placeholder="0.00" oninput="updateSaleTotals()" min="0" step="0.01">
        </div>
        <div>
            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…:</span>
            <span id="saleAfterDiscount">0.00</span>
        </div>
       <div>
            <span>
                <input type="checkbox" id="applySaleTax" onchange="updateSaleTotals()" checked style="margin-right: 5px; vertical-align: middle;">
                <label for="applySaleTax" style="cursor: pointer;">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%)</label>
            </span>
            <span id="saleTax">0.00</span>
        </div>
         <div>
            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
            <input type="number" id="salePaidAmount" placeholder="0.00" oninput="updateSaleTotals()">
        </div>
        <div>
            <span>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</span>
            <select id="salePaymentMethod">
                <option value="cash">ğŸ’° ÙƒØ§Ø´</option>
                <option value="bank">ğŸ¦ Ø¨Ù†Ùƒ</option>
                <option value="mixed">ğŸ”„ Ù…Ø®ØªÙ„Ø·</option>
            </select>
        </div>
        <div>
            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
            <span id="saleRemainingAmount" class="remaining-unpaid">0.00</span>
        </div>
        <div class="total">
            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
            <span id="saleTotal">0.00</span>
        </div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn-primary" id="saveSaleBtn" onclick="saveSale()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 40px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
    </div>

<!-- ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ - Ù…ØªÙˆÙØ± ÙÙŠ ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± -->
<div style="display: none;">
    <h3 style="margin-top: 30px;">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
    
    <div class="search-container">
        <input type="text" id="searchSales" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('salesFilters')">
            <span> </span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="salesFilters" class="filters-container">
        <div class="filters-grid">
            <div class="filter-group">
                <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="salesDateFrom" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="salesDateTo" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ù…Ù†)</label>
                <input type="number" id="salesAmountFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="salesAmountTo" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                <select id="salesPaymentMethodFilter" class="filter-input">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</option>
                    <option value="cash">ğŸ’° ÙƒØ§Ø´</option>
                    <option value="bank">ğŸ¦ Ø¨Ù†Ùƒ</option>
                    <option value="mixed">ğŸ”„ Ù…Ø®ØªÙ„Ø·</option>
                </select>
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetSalesFilters()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button class="btn-primary" onclick="applySalesFilters()">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        </div>
    </div>
    
    <table id="salesTable">
        <thead>
            <tr>
                <th class="sortable" data-column="code">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th class="sortable" data-column="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th class="sortable" data-column="customerId">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th class="sortable" data-column="itemsCount">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th class="sortable" data-column="discount">Ø§Ù„Ø®ØµÙ…</th>
                <th class="sortable" data-column="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th class="sortable" data-column="paidAmount">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                <th class="sortable" data-column="paymentMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                <th class="sortable" data-column="remainingAmount">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                <th style="text-align: center;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="salesList"></tbody>
    </table>
    </div>
    <!-- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ÙÙŠ -->
</div>

<div id="returns" class="section">
    <h2>â†©ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</h2>
    <div class="tabs">
        <button id="salesReturnTabBtn" class="tab-button active" onclick="showReturnTab('sales')">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
        <button id="purchasesReturnTabBtn" class="tab-button" onclick="showReturnTab('purchases')">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
    </div>

    <div id="salesReturnContent" class="tab-content active">
        <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø§Ø¦Ù†)</h3>
        <div class="search-container">
            <input type="number" id="salesReturnInvoiceSearch" class="search-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©...">
            <button class="btn-primary" onclick="findSaleForReturn()">ğŸ” Ø¨Ø­Ø«</button>
        </div>
        
        <div id="salesReturnInvoiceDetails" class="return-invoice-details" style="display: none;"></div>

        <div id="salesReturnItemsContainer" style="display: none;">
            <h4>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹:</h4>
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„ØµÙ†Ù</th>
                        <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©</th>
                    </tr>
                </thead>
                <tbody id="salesReturnItemsList"></tbody>
            </table>
            <div class="invoice-totals">
                <div class="total">
                    <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</span>
                    <span id="salesReturnTotal">0.00</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-success" onclick="saveSaleReturn()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</button>
                <button class="btn-secondary" onclick="newSaleReturn()">ğŸ†• Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>
        
        <h3 style="margin-top: 30px;">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
        <table>
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
            </thead>
            <tbody id="salesReturnsList"></tbody>
        </table>
    </div>

    <div id="purchaseReturnContent" class="tab-content">
        <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª (Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¯ÙŠÙ†)</h3>
        <div class="search-container">
            <input type="number" id="purchaseReturnInvoiceSearch" class="search-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©...">
            <button class="btn-primary" onclick="findPurchaseForReturn()">ğŸ” Ø¨Ø­Ø«</button>
        </div>

        <div id="purchaseReturnInvoiceDetails" class="return-invoice-details" style="display: none;"></div>

        <div id="purchaseReturnItemsContainer" style="display: none;">
            <h4>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹:</h4>
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„ØµÙ†Ù</th>
                        <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©</th>
                    </tr>
                </thead>
                <tbody id="purchaseReturnItemsList"></tbody>
            </table>
            <div class="invoice-totals">
                <div class="total">
                    <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</span>
                    <span id="purchaseReturnTotal">0.00</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-success" onclick="savePurchaseReturn()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</button>
                <button class="btn-secondary" onclick="newPurchaseReturn()">ğŸ†• Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>

        <h3 style="margin-top: 30px;">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
        <table>
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                    <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
            </thead>
            <tbody id="purchaseReturnsList"></tbody>
        </table>
    </div>
</div>

<!-- ØµÙØ­Ø© Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† -->
<div id="supplierPayments" class="section">
    <h2>ğŸ’³ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h2>

    <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="dashboard-cards" style="margin-bottom: 20px;">
        <div class="dashboard-card" style="background: white; border: 3px solid #2c5aa0;">
            <div class="card-value" id="totalSupplierPaymentsAmount" style="color: #2c5aa0;">0.00 Ø±.Ø³</div>
            <div class="card-title" style="color: #2c5aa0;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</div>
        </div>
        <div class="dashboard-card" style="background: white; border: 3px solid #2c5aa0;">
            <div class="card-value" id="totalSupplierPaymentsCount" style="color: #2c5aa0;">0</div>
            <div class="card-title" style="color: #2c5aa0;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</div>
        </div>
        <div class="dashboard-card" style="background: white; border: 3px solid #2c5aa0;">
            <div class="card-value" id="partialSupplierPaymentsCount" style="color: #2c5aa0;">0</div>
            <div class="card-title" style="color: #2c5aa0;">ÙÙˆØ§ØªÙŠØ± Ù…Ø³Ø¯Ø¯Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹</div>
        </div>
        <div class="dashboard-card" style="background: white; border: 3px solid #2c5aa0;">
            <div class="card-value" id="initialSupplierPaymentsCount" style="color: #2c5aa0;">0</div>
            <div class="card-title" style="color: #2c5aa0;">Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</div>
        </div>
    </div>

    <!-- Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„Ø¨Ø­Ø« -->
    <div class="search-container">
        <div class="form-grid grid-4">
            <input type="text" id="supplierPaymentSearchSupplier" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯...">
            <input type="text" id="supplierPaymentSearchTransactionId" placeholder="Ø±Ù‚Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹">
            <input type="text" id="supplierPaymentSearchInvoiceId" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
            <select id="supplierPaymentTypeFilter">
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª</option>
                <option value="initial">Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ÙÙ‚Ø·</option>
                <option value="additional">Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ÙÙ‚Ø·</option>
            </select>
        </div>
        <div class="form-grid grid-4" style="margin-top: 10px;">
            <input type="date" id="supplierPaymentDateFrom" placeholder="Ù…Ù† ØªØ§Ø±ÙŠØ®">
            <input type="date" id="supplierPaymentDateTo" placeholder="Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®">
            <select id="supplierPaymentMethodFilter">
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</option>
                <option value="cash">ğŸ’° ÙƒØ§Ø´</option>
                <option value="bank">ğŸ¦ Ø¨Ù†Ùƒ</option>
                <option value="check">ğŸ“ Ø´ÙŠÙƒ</option>
            </select>
            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="searchSupplierPayments()" style="flex: 1;">ğŸ” Ø¨Ø­Ø«</button>
                <button class="btn-secondary" onclick="resetSupplierPaymentsFilters()" style="flex: 1;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            </div>
        </div>
    </div>

    <table id="supplierPaymentsTable">
        <thead>
            <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="supplierPaymentsList"></tbody>
    </table>
</div>

<div id="customerPayments" class="section">
    <h2>ğŸ’µ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>

    <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="dashboard-cards" style="margin-bottom: 20px;">
        <div class="dashboard-card" style="background: white; border: 3px solid #2c5aa0;">
            <div class="card-value" id="totalPaymentsAmount" style="color: #2c5aa0;">0.00 Ø±.Ø³</div>
            <div class="card-title" style="color: #2c5aa0;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</div>
        </div>
        <div class="dashboard-card" style="background: white; border: 3px solid #2c5aa0;">
            <div class="card-value" id="totalPaymentsCount" style="color: #2c5aa0;">0</div>
            <div class="card-title" style="color: #2c5aa0;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</div>
        </div>
        <div class="dashboard-card" style="background: white; border: 3px solid #2c5aa0;">
            <div class="card-value" id="partialPaymentsCount" style="color: #2c5aa0;">0</div>
            <div class="card-title" style="color: #2c5aa0;">ÙÙˆØ§ØªÙŠØ± Ù…Ø³Ø¯Ø¯Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹</div>
        </div>
        <div class="dashboard-card" style="background: white; border: 3px solid #2c5aa0;">
            <div class="card-value" id="initialPaymentsCount" style="color: #2c5aa0;">0</div>
            <div class="card-title" style="color: #2c5aa0;">Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</div>
        </div>
    </div>

    <!-- Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„Ø¨Ø­Ø« -->
    <div class="search-container">
        <div class="form-grid grid-4">
            <input type="text" id="paymentSearchCustomer" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„...">
            <input type="text" id="paymentSearchTransactionId" placeholder="Ø±Ù‚Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹">
            <input type="text" id="paymentSearchInvoiceId" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
            <select id="paymentTypeFilter">
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª</option>
                <option value="initial">Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ÙÙ‚Ø·</option>
                <option value="additional">Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ÙÙ‚Ø·</option>
            </select>
        </div>
        <div class="form-grid grid-4" style="margin-top: 10px;">
            <input type="date" id="paymentDateFrom" placeholder="Ù…Ù† ØªØ§Ø±ÙŠØ®">
            <input type="date" id="paymentDateTo" placeholder="Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®">
            <select id="paymentMethodFilter">
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</option>
                <option value="cash">ğŸ’° ÙƒØ§Ø´</option>
                <option value="bank">ğŸ¦ Ø¨Ù†Ùƒ</option>
                <option value="check">ğŸ“ Ø´ÙŠÙƒ</option>
            </select>
            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="searchCustomerPayments()" style="flex: 1;">ğŸ” Ø¨Ø­Ø«</button>
                <button class="btn-secondary" onclick="resetPaymentsFilters()" style="flex: 1;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            </div>
        </div>
    </div>

    <table id="paymentsTable">
        <thead>
            <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="paymentsList"></tbody>
    </table>
</div>

<div id="salesReturns" class="section">
    <h2>â†©ï¸ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
    <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø§Ø¦Ù†)</h3>
    <div class="search-container">
        <input type="number" id="salesReturnInvoiceSearchNew" class="search-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©...">
        <button class="btn-primary" onclick="findSaleForReturnNew()">ğŸ” Ø¨Ø­Ø«</button>
    </div>
    
    <div id="salesReturnInvoiceDetailsNew" class="return-invoice-details" style="display: none;"></div>

    <div id="salesReturnItemsContainerNew" style="display: none;">
        <h4>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹:</h4>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©</th>
                </tr>
            </thead>
            <tbody id="salesReturnItemsListNew"></tbody>
        </table>
        <div class="invoice-totals">
            <div class="total">
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</span>
                <span id="salesReturnTotalNew">0.00</span>
            </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-success" onclick="saveSaleReturnNew()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</button>
            <button class="btn-secondary" onclick="newSaleReturnNew()">ğŸ†• Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>
    
    <h3 style="margin-top: 30px;">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
    <table>
        <thead>
            <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="salesReturnHistoryNew"></tbody>
    </table>
</div>

<div id="purchaseReturns" class="section">
    <h2>â†©ï¸ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
    <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª (Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¯ÙŠÙ†)</h3>
    <div class="search-container">
        <input type="number" id="purchaseReturnInvoiceSearchNew" class="search-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©...">
        <button class="btn-primary" onclick="findPurchaseForReturnNew()">ğŸ” Ø¨Ø­Ø«</button>
    </div>
    
    <div id="purchaseReturnInvoiceDetailsNew" class="return-invoice-details" style="display: none;"></div>

    <div id="purchaseReturnItemsContainerNew" style="display: none;">
        <h4>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹:</h4>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©</th>
                </tr>
            </thead>
            <tbody id="purchaseReturnItemsListNew"></tbody>
        </table>
        <div class="invoice-totals">
            <div class="total">
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</span>
                <span id="purchaseReturnTotalNew">0.00</span>
            </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-success" onclick="savePurchaseReturnNew()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</button>
            <button class="btn-secondary" onclick="newPurchaseReturnNew()">ğŸ†• Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>
    
    <h3 style="margin-top: 30px;">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
    <table>
        <thead>
            <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="purchaseReturnHistoryNew"></tbody>
    </table>
</div>

<div id="expenses" class="section">
    <h2>ğŸ’¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatExpenses" class="stat-mini-number">0</span></span></h2>
    <p>ğŸ’° Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØµÙ†ÙŠÙ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p>
    
    <div class="form-grid grid-4">
        <input type="date" id="expenseDate" value="">
        <input type="text" id="expenseCategory" placeholder="ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ØµØ±ÙˆÙ *" required>
        <input type="number" id="expenseAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº *" required min="0">
        <select id="expenseBranchId">
            <option value="general_admin">ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>
            <option value="">ğŸª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
        </select>
    </div>
    
    <div class="form-grid grid-3">
        <input type="text" id="expenseDescription" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ">
        <select id="expensePaymentMethod">
            <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
            <option value="bank">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
            <option value="check">Ø´ÙŠÙƒ</option>
            <option value="card">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
        </select>
        <input type="text" id="expenseReference" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
        <button class="btn-primary btn-add" onclick="addExpense()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease;"> Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
        <input type="file" id="expenseAttachment" accept="image/*,application/pdf" style="padding: 10px; border: 2px dashed var(--primary-color); background: #f8f9fa; grid-column: span 2;">
    </div>
    <div class="search-container">
        <input type="text" id="searchExpenses" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª...">
    </div>

   <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                <th>Ø§Ù„ÙˆØµÙ</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                <th>Ø§Ù„Ù…Ø±ÙÙ‚</th> <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="expensesList"></tbody>
    </table>
    <div class="stats-grid" style="margin-top: 30px;">
        <div class="stat-card">
            <div class="stat-number" id="totalExpenses">0</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayExpenses">0</div>
            <div class="stat-label">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="monthExpenses">0</div>
            <div class="stat-label">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±</div>
        </div>
    </div>
</div>

<div id="revenues" class="section">
    <h2>ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatRevenues" class="stat-mini-number">0</span></span></h2>
    <p>ğŸ’µ Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØµÙ†ÙŠÙ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©</p>
    
    <div class="form-grid grid-4">
        <input type="date" id="revenueDate" value="">
        <input type="text" id="revenueCategory" placeholder="ØªØµÙ†ÙŠÙ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ *" required>
        <input type="number" id="revenueAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº *" required min="0">
        <select id="revenueBranchId">
            <option value="">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
        </select>
    </div>
    
    <div class="form-grid grid-4">
        <input type="text" id="revenueDescription" placeholder="ÙˆØµÙ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯">
        <select id="revenueSource">
            <option value="sales">Ù…Ø¨ÙŠØ¹Ø§Øª</option>
            <option value="services">Ø®Ø¯Ù…Ø§Øª</option>
            <option value="investment">Ø§Ø³ØªØ«Ù…Ø§Ø±</option>
            <option value="other">Ø£Ø®Ø±Ù‰</option>
        </select>
        <input type="text" id="revenueReference" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <button class="btn-primary btn-add" onclick="addRevenue()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease;"> Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ±Ø§Ø¯</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchRevenues" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª...">
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„ÙˆØµÙ</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="revenuesList"></tbody>
    </table>
    
    <div class="stats-grid" style="margin-top: 30px;">
        <div class="stat-card">
            <div class="stat-number" id="totalRevenues">0</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayRevenues">0</div>
            <div class="stat-label">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="monthRevenues">0</div>
            <div class="stat-label">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div>
        </div>
    </div>
</div>

<div id="bonds" class="section">
    <h2>ğŸ“„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù†Ø¯Ø§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatBonds" class="stat-mini-number">0</span></span></h2>
    <p>ğŸ“ Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶ ÙˆØ§Ù„ØµØ±Ù</p>
    
    <div class="form-grid grid-4">
        <input type="date" id="bondDate" value="">
        <select id="bondType">
            <option value="receipt">ğŸ“¥ Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</option>
            <option value="payment">ğŸ“¤ Ø³Ù†Ø¯ ØµØ±Ù</option>
        </select>
        <input type="number" id="bondAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº *" required min="0">
        <select id="bondBranchId">
            <option value="">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
        </select>
    </div>
    
    <div class="form-grid grid-4">
        <select id="bondPartyType" onchange="updateBondPartySelect()">
            <option value="customer">Ø¹Ù…ÙŠÙ„</option>
            <option value="supplier">Ù…ÙˆØ±Ø¯</option>
            <option value="employee">Ù…ÙˆØ¸Ù</option>
            <option value="other">Ø¢Ø®Ø±</option>
        </select>
        <select id="bondPartyId">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø±Ù</option>
        </select>
        <input type="text" id="bondDescription" placeholder="ÙˆØµÙ Ø§Ù„Ø³Ù†Ø¯ / Ø§Ù„Ø¨ÙŠØ§Ù†">
        <button class="btn-primary btn-add" onclick="addBond()" style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchBonds" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ù†Ø¯Ø§Øª..." onkeyup="renderBonds()">
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯</th>
                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ø·Ø±Ù</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="bondsList"></tbody>
    </table>
</div>


<!-- Ø¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ Ù‚Ø³Ù… Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆÙ‚Ø¨Ù„ Ù‚Ø³Ù… Ø§Ù„ØµØ¯Ù‚Ø© -->
<div id="advances" class="section">
    <h2>ğŸ’³ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatAdvances" class="stat-mini-number">0.00</span></span></h2>
    <p>ğŸ’° Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø³Ù„Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠØ©</p>
    
    <div class="form-grid grid-4">
        <input type="date" id="advanceDate" value="">
        <select id="advanceType">
            <option value="Ø³Ù„ÙØ©">Ø³Ù„ÙØ© Ù…ÙˆØ¸Ù</option>
            <option value="Ø¹Ù‡Ø¯Ø©">Ø¹Ù‡Ø¯Ø© Ù…Ø§Ù„ÙŠØ©</option>
            <option value="Ø³Ø¯Ø§Ø¯">Ø³Ø¯Ø§Ø¯</option>
        </select>
        <input type="text" id="advanceEmployee" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù / Ø§Ù„Ù…Ø³ØªÙ„Ù… *" required>
        <input type="number" id="advanceAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº *" required min="0">
    </div>
    
    <div class="form-grid grid-3">
        <input type="text" id="advanceDescription" placeholder="Ø§Ù„ÙˆØµÙ / Ø§Ù„ØºØ±Ø¶">
        <select id="advanceStatus">
            <option value="Ù…Ø³ØªØ­Ù‚">Ù…Ø³ØªØ­Ù‚</option>
            <option value="Ù…Ø³Ø¯Ø¯">Ù…Ø³Ø¯Ø¯</option>
            <option value="Ø¬Ø²Ø¦ÙŠ">Ù…Ø³Ø¯Ø¯ Ø¬Ø²Ø¦ÙŠØ§Ù‹</option>
        </select>
        <button class="btn-success btn-add" onclick="addAdvance()" style="white-space: nowrap; padding: 12px 20px;">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø©/Ø³Ù„ÙØ©</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchAdvances" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù...">
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù / Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„ÙˆØµÙ</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="advancesList"></tbody>
    </table>
    
    <div class="stats-grid" style="margin-top: 30px;">
        <div class="stat-card">
            <div class="stat-number" id="totalAdvances">0.00</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ù ÙˆØ§Ù„Ø¹Ù‡Ø¯</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="dueAdvances">0.00</div>
            <div class="stat-label">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="paidAdvances">0.00</div>
            <div class="stat-label">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³Ø¯Ø¯Ø©</div>
        </div>
    </div>
</div>

<!-- ğŸ‘¨â€ğŸ’¼ ØµÙØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
<div id="employees" class="section">
    <h2>ğŸ‘¨â€ğŸ’¼ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¹Ø¯Ø¯:</span><span id="miniStatEmployees" class="stat-mini-number">0</span></span></h2>
    <p>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ§Ù„ÙˆØ¸ÙŠÙÙŠØ© ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ©.</p>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
    <div style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; direction: ltr;">
            <button onclick="openAddEmployee()" class="btn-primary" style="background: linear-gradient(135deg, #28a745, #20c997);">
                â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
            </button>
            <input type="text" id="employeeSearchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¸Ù..." style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 300px;" onkeyup="searchEmployees()">
        </div>
        
        <div id="employeesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
            <!-- Ø³ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù‡Ù†Ø§ -->
        </div>
    </div>
</div>

<!-- Modal Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¸Ù -->
<div id="addEmployeeModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto; padding: 20px;">
    <div class="modal-content" style="max-width: 1100px; max-height: 90vh; overflow-y: auto; margin: 0 auto; background: white; border-radius: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
            <h2 id="employeeModalTitle" style="margin: 0; color: #2c3e50;">
                ğŸ‘¨â€ğŸ’¼ Ø¨Ø·Ø§Ù‚Ø© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
            </h2>
            <div style="display: flex; gap: 10px;">
                <button onclick="saveEmployee()" class="btn-primary" style="background: linear-gradient(135deg, #28a745, #20c997);">
                    ğŸ’¾ Ø­ÙØ¸
                </button>
                <button onclick="closeAddEmployee()" class="btn-secondary">
                    âŒ Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 25px;">
            <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
            <div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid #dee2e6;">
                    <h3 style="margin: 0 0 20px 0; color: #495057; font-size: 16px; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                        ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                    </h3>
                    
                    <!-- ØµÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ¸Ù -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div id="employeeImagePreview" style="width: 150px; height: 150px; margin: 0 auto 10px; border: 2px dashed #dee2e6; border-radius: 12px; background: #fff; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            <span style="color: #adb5bd; font-size: 48px;">ğŸ‘¤</span>
                        </div>
                        <input type="file" id="employeeImage" accept="image/*" style="display: none;" onchange="previewEmployeeImage(event)">
                        <button onclick="document.getElementById('employeeImage').click()" class="btn-secondary" style="font-size: 13px; padding: 8px 16px;">
                            ğŸ“· Ø±ÙØ¹ ØµÙˆØ±Ø©
                        </button>
                    </div>

                    <!-- Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 600; font-size: 14px;">Ø§Ù„Ø§Ø³Ù… (Ø¹Ø±Ø¨ÙŠ): <span style="color: red;">*</span></label>
                        <input type="text" id="employeeNameAr" placeholder="Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø§Ù„Ø¹Ù„ÙŠ" required style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 8px;">
                    </div>

                    <!-- Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 600; font-size: 14px;">Ø§Ù„Ø§Ø³Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ):</label>
                        <input type="text" id="employeeNameEn" placeholder="Mohammed Ahmed Al-Ali" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 8px;">
                    </div>

                    <!-- ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 600; font-size: 14px;">ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù:</label>
                        <input type="text" id="employeeCode" placeholder="EMP-101" readonly style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 8px; background: #e9ecef;">
                    </div>

                    <!-- Ø§Ù„Ø­Ø§Ù„Ø© -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 600; font-size: 14px;">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                        <select id="employeeStatus" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 8px;">
                            <option value="active">ğŸŸ¢ Ù†Ø´Ø·</option>
                            <option value="inactive">âšª ØºÙŠØ± Ù†Ø´Ø·</option>
                            <option value="suspended">ğŸ”´ Ù…ÙˆÙ‚ÙˆÙ</option>
                        </select>
                    </div>

                    <!-- Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 600; font-size: 14px;">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</label>
                        <input type="tel" id="employeePhone" placeholder="05xxxxxxxx" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 8px;">
                    </div>

                    <!-- Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ -->
                    <div style="margin-bottom: 0;">
                        <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 600; font-size: 14px;">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                        <input type="email" id="employeeEmail" placeholder="example@mail.com" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 8px;">
                    </div>
                </div>
            </div>

            <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ© ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ© -->
            <div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid #dee2e6;">
                    <h3 style="margin: 0 0 20px 0; color: #495057; font-size: 16px; border-bottom: 2px solid #007bff; padding-bottom: 10px;">
                        ğŸ’¼ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ© ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ©
                    </h3>

                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙØ© -->
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
                        <h4 style="margin: 0 0 15px 0; color: #6c757d; font-size: 14px;">-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙØ© --</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px;">Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</label>
                                <input type="text" id="employeeJobTitle" placeholder="Ù…Ø­Ø§Ø³Ø¨" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px;">Ø§Ù„Ù‚Ø³Ù…:</label>
                                <select id="employeeDepartment" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
                                    <option value="accounting">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</option>
                                    <option value="sales">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                                    <option value="purchases">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
                                    <option value="hr">Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</option>
                                    <option value="it">ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</option>
                                    <option value="operations">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
                                    <option value="management">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px;">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†:</label>
                                <input type="date" id="employeeHireDate" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px;">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯:</label>
                                <input type="date" id="employeeContractEnd" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;">
                            </div>
                            <div style="grid-column: span 2;">
                                <label style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px;">Ù…Ø±ÙÙ‚ Ø§Ù„Ø¹Ù‚Ø¯ (PDF/ØµÙˆØ±Ø©):</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="file" id="employeeContractFile" accept=".pdf,image/*" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;">
                                    <button type="button" id="viewContractBtn" onclick="viewContractFile()" style="display: none; background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø¯</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø§ØªØ¨ -->
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
                        <h4 style="margin: 0 0 15px 0; color: #6c757d; font-size: 14px;">ğŸ’° Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø§ØªØ¨ (Ø´Ù‡Ø±ÙŠ)</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px;">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:</label>
                                <input type="number" id="employeeBasicSalary" placeholder="4000.00" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;" onchange="calculateEmployeeTotalSalary()">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px;">Ø¨Ø¯Ù„ Ø³ÙƒÙ†:</label>
                                <input type="number" id="employeeHousingAllowance" placeholder="1000.00" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;" onchange="calculateEmployeeTotalSalary()">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px;">Ø¨Ø¯Ù„ Ù†Ù‚Ù„:</label>
                                <input type="number" id="employeeTransportAllowance" placeholder="400.00" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;" onchange="calculateEmployeeTotalSalary()">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px;">Ø¨Ø¯Ù„Ø§Øª Ø£Ø®Ø±Ù‰:</label>
                                <input type="number" id="employeeOtherAllowances" placeholder="0.00" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;" onchange="calculateEmployeeTotalSalary()">
                            </div>
                        </div>

                        <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 8px; border: 2px solid #4caf50;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600; color: #2e7d32; font-size: 14px;">ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø§ØªØ¨:</span>
                                <span id="employeeTotalSalary" style="font-weight: 700; color: #1b5e20; font-size: 18px;">0.00</span>
                            </div>
                            <div style="margin-top: 5px; font-size: 11px; color: #558b2f;">
                                (ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
                            </div>
                        </div>
                    </div>

                    <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ© -->
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                        <h4 style="margin: 0 0 15px 0; color: #6c757d; font-size: 14px;">-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ© --</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px;">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©: <span style="color: red;">*</span></label>
                                <input type="text" id="employeeNationalId" placeholder="10xxxxxxxx" required style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px;">Ø§Ù„Ø¬Ù†Ø³ÙŠØ©: <span style="color: red;">*</span></label>
                                <select id="employeeNationality" required style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</option>
                                    <option value="saudi">ğŸ‡¸ğŸ‡¦ Ø³Ø¹ÙˆØ¯ÙŠ</option>
                                    <option value="non-saudi">ğŸŒ ØºÙŠØ± Ø³Ø¹ÙˆØ¯ÙŠ</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</label>
                                <input type="date" id="employeeBirthDate" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px;">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©:</label>
                                <select id="employeeMaritalStatus" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;">
                                    <option value="">Ø§Ø®ØªØ±</option>
                                    <option value="single">Ø£Ø¹Ø²Ø¨</option>
                                    <option value="married">Ù…ØªØ²ÙˆØ¬</option>
                                </select>
                            </div>
                        </div>

                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
                            <textarea id="employeeAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„" rows="2" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ù‚Ø³Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ -->
<div id="attendance" class="section">
    <h2>ğŸ“… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h2>
    <p>ğŸ“Š Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ø´ÙƒÙ„ ÙŠÙˆÙ…ÙŠ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©.</p>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„Ø§ØªØ± -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #dee2e6;">
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">ğŸ“… Ø§Ù„Ø³Ù†Ø©:</label>
                <select id="attendanceYear" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 8px; background: white;">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ù€ JavaScript -->
                </select>
            </div>
            
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">ğŸ“† Ø§Ù„Ø´Ù‡Ø±:</label>
                <select id="attendanceMonth" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 8px; background: white;">
                    <option value="1">ÙŠÙ†Ø§ÙŠØ±</option>
                    <option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option>
                    <option value="3">Ù…Ø§Ø±Ø³</option>
                    <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option>
                    <option value="5">Ù…Ø§ÙŠÙˆ</option>
                    <option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
                    <option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option>
                    <option value="8">Ø£ØºØ³Ø·Ø³</option>
                    <option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                    <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
                    <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                    <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                </select>
            </div>
            
            <div>
                <button onclick="loadAttendanceData()" class="btn-primary" style="background: linear-gradient(135deg, #007bff, #0056b3); padding: 10px 30px; white-space: nowrap;">
                    ğŸ” Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
            </div>
        </div>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
    <div id="attendanceDataContainer" style="min-height: 400px;">
        <!-- Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© -->
        <div id="attendanceEmptyState" style="text-align: center; padding: 80px 20px; color: #6c757d;">
            <div style="font-size: 80px; margin-bottom: 20px; opacity: 0.3;">ğŸ“…</div>
            <h3 style="color: #495057; margin-bottom: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ø±ÙˆØ¶Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</h3>
            <p style="font-size: 15px;">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø± Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"</p>
        </div>
        
        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± (Ø³ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¹Ø±Ø¶) -->
        <div id="attendanceTableContainer" style="display: none;">
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: rgba(66, 133, 244, 0.15); color: #1a73e8; border-bottom: 2px solid rgba(66, 133, 244, 0.3);">
                            <th style="padding: 15px; text-align: center; font-weight: 700; width: 50px;">#</th>
                            <th style="padding: 15px; text-align: center; font-weight: 700; min-width: 200px;">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                            <th style="padding: 15px; text-align: center; font-weight: 700; width: 120px;">Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</th>
                            <th style="padding: 15px; text-align: center; font-weight: 700; width: 120px;">Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ£Ø®ÙŠØ±</th>
                            <th style="padding: 15px; text-align: center; font-weight: 700; width: 120px;">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</th>
                            <th style="padding: 15px; text-align: center; font-weight: 700; min-width: 200px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                        <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ØµÙÙˆÙ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù‡Ù†Ø§ -->
                    </tbody>
                </table>
            </div>
            
            <!-- Ø²Ø± Ø§Ù„Ø­ÙØ¸ -->
            <div style="margin-top: 20px; text-align: left;">
                <button onclick="saveAttendanceData()" class="btn-primary" style="padding: 12px 30px; font-size: 15px; font-weight: 600;">
                    ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
            </div>
        </div>
    </div>
</div>

    <div class="salary-summary" style="margin-bottom: 25px;">
        <div class="dashboard-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div class="dashboard-card" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 4px solid #3498db;">
             <div id="salaries" class="section">
    <h2>ğŸ’¼ Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatSalaries" class="stat-mini-number">0.00</span></span></h2>
    <p>ğŸ§¾ Ø§Ø­ØªØ³Ø§Ø¨ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø±Ø¨Ø· Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©.</p>

    <div class="salary-card" style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #e9ecef;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
            <div>
                <label style="color: #2c3e50; font-size: 13px; display: block; margin-bottom: 5px; font-weight: 600;">ğŸ“… Ø§Ù„Ø³Ù†Ø©</label>
                <select id="payrollYear" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #dee2e6; font-size: 15px; font-weight: 600;">
                    <option value="2025" selected>2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>
            </div>
            
            <div>
                <label style="color: #2c3e50; font-size: 13px; display: block; margin-bottom: 5px; font-weight: 600;">ğŸ“† Ø§Ù„Ø´Ù‡Ø±</label>
                <select id="payrollMonth" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #dee2e6; font-size: 15px; font-weight: 600;">
                    <option value="1">ÙŠÙ†Ø§ÙŠØ±</option>
                    <option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option>
                    <option value="3">Ù…Ø§Ø±Ø³</option>
                    <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option>
                    <option value="5">Ù…Ø§ÙŠÙˆ</option>
                    <option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
                    <option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option>
                    <option value="8">Ø£ØºØ³Ø·Ø³</option>
                    <option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                    <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
                    <option value="11" selected>Ù†ÙˆÙÙ…Ø¨Ø±</option>
                    <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                </select>
            </div>
            
            <button onclick="calculatePayroll()" class="btn-primary" style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer; transition: all 0.3s; height: 46px;">
                âš™ï¸ Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø±ÙˆØ§ØªØ¨
            </button>
            
            <button id="approvePayrollBtn" onclick="approvePayroll()" style="display: none; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer; transition: all 0.3s; height: 46px;">
                ğŸ”’ Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù…Ø³ÙŠØ±
            </button>
        </div>
    </div>

    <div class="salary-summary" style="margin-bottom: 25px;">
        <div class="dashboard-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div class="dashboard-card" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 4px solid #3498db;">
                <div class="card-value" id="payrollTotalGross" style="color: #3498db; font-size: 28px; font-weight: bold; margin-bottom: 5px;">0.00</div>
                <div class="card-title" style="color: #7f8c8d; font-weight: 600;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª</div>
            </div>
            
            <div class="dashboard-card" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 4px solid #e74c3c;">
                <div class="card-value" id="payrollTotalDeductions" style="color: #e74c3c; font-size: 28px; font-weight: bold; margin-bottom: 5px;">0.00</div>
                <div class="card-title" style="color: #7f8c8d; font-weight: 600;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</div>
            </div>
            
            <div class="dashboard-card" style="background: #f0fff4; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 2px solid #27ae60;">
                <div class="card-value" id="payrollTotalNet" style="color: #27ae60; font-size: 32px; font-weight: bold; margin-bottom: 5px;">0.00</div>
                <div class="card-title" style="color: #27ae60; font-weight: 700;">ØµØ§ÙÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨</div>
            </div>
        </div>
    </div>

    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h3 style="color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span>ğŸ“‹</span>
                    <span>Ø§Ù„Ù…Ø³ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</span>
                    <span id="payrollPeriodLabel" style="color: #7f8c8d; font-size: 14px; font-weight: normal;"></span>
                </h3>
                <div class="export-options" style="display: flex; gap: 10px;">
                    <button class="btn-success" onclick="exportPayrollToExcel()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s;">
                        ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
                    </button>
                    <button class="btn-secondary" onclick="printPayrollTable()" style="background: linear-gradient(135deg, #2c3e50, #2980b9); color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s;">
                        ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø³ÙŠØ±
                    </button>
                </div>
            </div>
        
        <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
            <thead>
                <tr style="background: #f8f9fa; color: #2c3e50; border-bottom: 2px solid #dee2e6;">
                    <th style="padding: 15px; text-align: center;">#</th>
                    <th style="padding: 15px; text-align: right;">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                    <th style="padding: 15px; text-align: center;">Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
                    <th style="padding: 15px; text-align: center;">Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</th>
                    <th style="padding: 15px; text-align: center; color: #27ae60;">Ø¥Ø¶Ø§ÙÙŠ (+)</th>
                    <th style="padding: 15px; text-align: center; color: #c0392b;">ØºÙŠØ§Ø¨ (-)</th>
                    <th style="padding: 15px; text-align: center; color: #e67e22;">ØªØ£Ù…ÙŠÙ†Ø§Øª (-)</th>
                    <th style="padding: 15px; text-align: center; background: #f0fff4; color: #27ae60; font-weight: bold;">Ø§Ù„ØµØ§ÙÙŠ</th>
                    <th style="padding: 15px; text-align: center;">Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="payrollTableBody">
                <tr>
                    <td colspan="9" style="text-align: center; padding: 60px 20px; color: #95a5a6;">
                        <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">ğŸ‘†</div>
                        <p style="font-size: 16px; margin: 0;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø±ÙˆØ§ØªØ¨" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
<div id="assets" class="section">
    <h2>ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© <span class="title-stat-card"><span class="stat-mini-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©:</span><span id="miniStatAssets" class="stat-mini-number">0.00</span></span></h2>
    <p>ğŸ­ Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØªØ¨Ø¹ Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</p>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ„ Ø¬Ø¯ÙŠØ¯ -->
    <div class="asset-card" id="assetForm">
        <h3>Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ„ Ø«Ø§Ø¨Øª Ø¬Ø¯ÙŠØ¯</h3>
        <div class="form-grid grid-3">
            <input type="text" id="assetName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„ *" required>
            <select id="assetType" required>
                <option value="">Ù†ÙˆØ¹ Ø§Ù„Ø£ØµÙ„</option>
                <option value="computers">ğŸ’» Ø£Ø¬Ù‡Ø²Ø© ÙƒÙ…Ø¨ÙŠÙˆØªØ±</option>
                <option value="furniture">ğŸª‘ Ø£Ø«Ø§Ø« Ù…ÙƒØªØ¨ÙŠ</option>
                <option value="vehicles">ğŸš— Ø³ÙŠØ§Ø±Ø§Øª ÙˆÙ…Ø±ÙƒØ¨Ø§Øª</option>
                <option value="equipment">âš™ï¸ Ù…Ø¹Ø¯Ø§Øª ÙˆØ¢Ù„Ø§Øª</option>
                <option value="electronics">ğŸ“± Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
                <option value="buildings">ğŸ¢ Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ¹Ù‚Ø§Ø±Ø§Øª</option>
                <option value="other">ğŸ“¦ Ø£Ø®Ø±Ù‰</option>
            </select>
            <input type="date" id="assetPurchaseDate" required>
        </div>
        
        <div class="form-grid grid-3">
            <input type="text" id="assetSupplier" placeholder="Ø§Ù„Ù…ÙˆØ±Ø¯ Ø£Ùˆ Ø§Ù„Ù…ØªØ¬Ø±">
            <input type="text" id="assetInvoiceNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
            <input type="number" id="assetCost" placeholder="ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡ *" min="0" step="0.01" required>
        </div>
        
        <div class="form-grid grid-3">
            <input type="number" id="assetLifespan" placeholder="Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ (Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª) *" min="1" max="50" required>
            <input type="number" id="assetSalvageValue" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø±Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" min="0" step="0.01">
            <select id="assetStatus">
                <option value="active">ğŸŸ¢ Ù†Ø´Ø·</option>
                <option value="maintenance">ğŸŸ¡ ØªØ­Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</option>
                <option value="inactive">ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·</option>
            </select>
        </div>
        
        <div class="form-grid" style="grid-template-columns: 2fr 1fr; gap: 15px; align-items: stretch;">
            <textarea id="assetNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©" rows="1" style="resize: none; height: 45px; padding: 12px;"></textarea>
            <button class="btn-success" onclick="addAsset()" style="height: 45px; padding: 0 20px; white-space: nowrap;">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ„</button>
        </div>
    </div>

    <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ù„Ù„Ø£ØµÙˆÙ„ -->
    <div class="assets-summary" id="assetsSummary">
        <div class="dashboard-cards">
            <div class="dashboard-card customers">
                <div class="card-value" id="totalAssetsValue">0.00</div>
                <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙˆÙ„</div>
                <div class="card-growth">
                    <span>+0%</span>
                    <span class="growth-icon">ğŸ¢</span>
                </div>
            </div>
            <div class="dashboard-card revenue">
                <div class="card-value" id="totalDepreciation">0.00</div>
                <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ</div>
                <div class="card-growth">
                    <span>+0%</span>
                    <span class="growth-icon">ğŸ“‰</span>
                </div>
            </div>
            <div class="dashboard-card profit">
                <div class="card-value" id="netAssetsValue">0.00</div>
                <div class="card-title">ØµØ§ÙÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙˆÙ„</div>
                <div class="card-growth">
                    <span>+0%</span>
                    <span class="growth-icon">ğŸ’</span>
                </div>
            </div>
            <div class="dashboard-card sales-today">
                <div class="card-value" id="totalAssetsCount">0</div>
                <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆÙ„</div>
                <div class="card-growth">
                    <span>+0%</span>
                    <span class="growth-icon">ğŸ“‹</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø« -->
    <div class="assets-filters">
        <select id="filterAssetType">
            <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
            <option value="computers">ğŸ’» Ø£Ø¬Ù‡Ø²Ø© ÙƒÙ…Ø¨ÙŠÙˆØªØ±</option>
            <option value="furniture">ğŸª‘ Ø£Ø«Ø§Ø« Ù…ÙƒØªØ¨ÙŠ</option>
            <option value="vehicles">ğŸš— Ø³ÙŠØ§Ø±Ø§Øª ÙˆÙ…Ø±ÙƒØ¨Ø§Øª</option>
            <option value="equipment">âš™ï¸ Ù…Ø¹Ø¯Ø§Øª ÙˆØ¢Ù„Ø§Øª</option>
            <option value="electronics">ğŸ“± Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
            <option value="buildings">ğŸ¢ Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ¹Ù‚Ø§Ø±Ø§Øª</option>
            <option value="other">ğŸ“¦ Ø£Ø®Ø±Ù‰</option>
        </select>
        <select id="filterAssetStatus">
            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="active">ğŸŸ¢ Ù†Ø´Ø·</option>
            <option value="maintenance">ğŸŸ¡ ØªØ­Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</option>
            <option value="inactive">ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·</option>
        </select>
        <input type="text" id="searchAssets" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£ØµÙˆÙ„...">
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„ØªØµØ¯ÙŠØ± -->
    <div class="export-options" style="margin: 20px 0;">
        <div class="form-grid grid-2">
            <button class="btn-success" onclick="exportAssetsToExcel()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease;">ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
            <button class="btn-secondary" onclick="printAssetsReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙˆÙ„ -->
    <table>
        <thead>
            <tr>
                <th>ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„</th>
                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                <th>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
                <th>Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ</th>
                <th>Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ Ø§Ù„Ø³Ù†ÙˆÙŠ</th>
                <th>Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ</th>
                <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØªØ±ÙŠØ©</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="assetsList"></tbody>
    </table>
</div>

<div id="reports" class="section">
    <h2>ï¿½ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
    <p>ï¿½ Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</p>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div class="tabs">
        <button id="reportsTabBtn" class="tab-button active" onclick="switchAccountingTab('reports')">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
        <button id="accountStatementsTabBtn" class="tab-button" onclick="switchAccountingTab('accountStatements')">ğŸ“‹ ÙƒØ´ÙˆÙ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
    </div>

    <!-- ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
    <div id="reportsTab" class="tab-content active">
        <div class="report-controls">
            <div class="form-grid grid-3" style="margin-bottom: 20px;">
                <div>
                    <select id="reportType" onchange="changeReportType()" style="width: 100%; padding: 12px; font-size: 14px;" placeholder="Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±">
                        <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</option>
                        <option value="sales">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                        <option value="purchases">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
                        <option value="sales_returns">â†©ï¸ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                        <option value="purchase_returns">â†©ï¸ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
                        <option value="expenses">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</option>
                        <option value="revenues">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</option>
                        <option value="salaries">ğŸ’¼ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨</option>
                        <option value="profit_loss">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø©</option>
                        <option value="balance_sheet">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©</option>
                    </select>
                </div>
                <div>
                    <input type="date" id="reportFrom" placeholder="Ù…Ù† ØªØ§Ø±ÙŠØ®" style="width: 100%; padding: 12px; font-size: 14px;">
                </div>
                <div>
                    <input type="date" id="reportTo" placeholder="Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®" style="width: 100%; padding: 12px; font-size: 14px;">
                </div>
            </div>
            
            <div class="form-grid grid-3" style="margin-bottom: 20px;">
                <div>
                    <select id="paymentStatusFilter" style="width: 100%; padding: 12px; font-size: 14px;">
                        <option value="all">ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</option>
                        <option value="paid">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</option>
                        <option value="unpaid">ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</option>
                    </select>
                </div>
                <div>
                    <select id="reportItemFilter" onchange="updateReportItemFilter()" style="width: 100%; padding: 12px; font-size: 14px;">
                        <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù</option>
                        <option value="specific">ØµÙ†Ù Ù…Ø­Ø¯Ø¯</option>
                    </select>
                </div>
                <div>
                    <select id="reportSpecificItem" style="display: none; width: 100%; padding: 12px; font-size: 14px;">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>
                    </select>
                </div>
            </div>
            
            <!-- Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø®ÙÙŠØ© -->
            <select id="reportSupplierFilter" style="display: none;">
                <option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>
            </select>
            <select id="reportCustomerFilter" style="display: none;">
                <option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
            </select>
            
            <!-- ğŸª ÙÙ„ØªØ± Ø§Ù„ÙØ±ÙˆØ¹ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
            <div class="form-grid grid-1" style="margin-bottom: 20px;">
                <select id="reportBranchFilter" style="width: 100%; padding: 12px; font-size: 14px;">
                    <option value="all">ğŸª ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
                </select>
            </div>
        </div>
        
        <div class="export-options">
            <div class="form-grid grid-3">
                <button class="btn-primary" onclick="generateReport()">ğŸ” Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                <button class="btn-success" onclick="exportToExcel()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease;">ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
                <button class="btn-secondary" onclick="exportToWeb()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            </div>
        </div>
        
        <div class="report-summary" id="reportSummary">
               
        </div>
        
        <div id="reportResults">
        </div>
    </div>

    <!-- ØªØ¨ÙˆÙŠØ¨Ø© ÙƒØ´ÙˆÙ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª -->
    <div id="accountStatementsTab" class="tab-content">
        <div class="report-controls">
            <div class="form-grid grid-3" style="margin-bottom: 20px;">
                <div>
                    <label>Ù†ÙˆØ¹ Ø§Ù„ÙƒØ´Ù</label>
                    <select id="statementType" onchange="changeStatementType()" style="width: 100%; padding: 12px; font-size: 14px;">
                        <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙƒØ´Ù</option>
                        <option value="suppliers">ğŸ“¦ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>
                        <option value="customers">ğŸ‘¥ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
                        <option value="employees">ğŸ‘· ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
                        <option value="bank">ğŸ¦ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ</option>
                        <option value="cash">ğŸ’° ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</option>
                        <option value="tax">ğŸ“Š ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</option>
                    </select>
                </div>
                <div>
                    <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="statementFrom" placeholder="Ù…Ù† ØªØ§Ø±ÙŠØ®" style="width: 100%; padding: 12px; font-size: 14px;">
                </div>
                <div>
                    <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="statementTo" placeholder="Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®" style="width: 100%; padding: 12px; font-size: 14px;">
                </div>
            </div>
            
            <!-- Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø®ÙÙŠØ© -->
            <select id="specificSupplierFilter" style="display: none;" onchange="autoRefreshStatement()">
                <option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>
            </select>
            <select id="specificCustomerFilter" style="display: none;" onchange="autoRefreshStatement()">
                <option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
            </select>
            <select id="specificEmployeeFilter" style="display: none;" onchange="autoRefreshStatement()">
                <option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
            </select>
            <select id="taxFilterType" style="display: none; width: 100%; padding: 12px; font-size: 14px; margin-bottom: 15px;" onchange="autoRefreshStatement()">
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
                <option value="withTax">ÙÙ‚Ø· Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙŠ ÙÙŠÙ‡Ø§ Ø¶Ø±ÙŠØ¨Ø©</option>
                <option value="withoutTax">ÙÙ‚Ø· Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©</option>
            </select>
            <!-- ğŸª ÙÙ„ØªØ± Ø§Ù„ÙØ±ÙˆØ¹ - Ø¬Ø¯ÙŠØ¯ -->
            <select id="statementBranchFilter" style="width: 100%; padding: 12px; font-size: 14px; margin-bottom: 15px;" onchange="autoRefreshStatement()">
                <option value="all">ğŸª ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
            </select>
        </div>
        
        <div class="export-options">
            <div class="form-grid grid-3">
                <button class="btn-primary" onclick="generateAccountStatement()" style="padding: 12px 20px; font-size: 14px;">ğŸ” Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´Ù</button>
                <button class="btn-success" onclick="exportStatementToExcel()" style="padding: 12px 20px; font-size: 14px;">ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
                <button class="btn-secondary" onclick="printAccountStatement()" style="padding: 12px 20px; font-size: 14px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù</button>
            </div>
        </div>
        
        <div class="account-statement-summary" id="statementSummary">
            <div class="dashboard-cards">
                <div class="dashboard-card customers">
                    <div class="card-value" id="summaryTotalTransactions">0.00</div>
                    <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</div>
                    <div class="card-growth">
                        <span id="transactionsGrowth">+0%</span>
                        <span class="growth-icon">ğŸ“Š</span>
                    </div>
                </div>
                <div class="dashboard-card profit">
                    <div class="card-value" id="summaryTotalPaid">0.00</div>
                    <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
                    <div class="card-growth">
                        <span id="paidGrowth">+0%</span>
                        <span class="growth-icon">âœ…</span>
                    </div>
                </div>
                <div class="dashboard-card revenue">
                    <div class="card-value" id="summaryTotalRemaining">0.00</div>
                    <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                    <div class="card-growth">
                        <span id="remainingGrowth">+0%</span>
                        <span class="growth-icon">â³</span>
                    </div>
                </div>
                <div class="dashboard-card sales-today">
                    <div class="card-value" id="summaryRecordsCount">0</div>
                    <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
                    <div class="card-growth">
                        <span id="recordsGrowth">+0%</span>
                        <span class="growth-icon">ğŸ“‹</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="statementResults">
        </div>
    </div>
</div>

<div id="settings" class="section">
    <h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù†Ø¸Ø§Ù…</h2>

    <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div class="settings-tabs">
        <button class="settings-tab active" onclick="switchSettingsTab('activities')">
            ğŸ¢ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙˆØ§Ù„ÙØ±ÙˆØ¹
        </button>
        <button class="settings-tab" onclick="switchSettingsTab('users')">
            ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        </button>
        <button class="settings-tab" onclick="switchSettingsTab('general')">
            âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        </button>
        <button class="settings-tab" onclick="switchSettingsTab('backup')">
            ğŸ’¾ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        </button>
    </div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
    <div id="usersTabContent" class="settings-tab-content">
        <div id="userManagementSection" class="user-management settings-card">
            <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            
            <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ -->
            <div style="margin-bottom: 25px;">
                <h4 style="background: linear-gradient(135deg, rgba(25, 118, 210, 0.15), rgba(66, 165, 245, 0.15)); color: #1976d2; margin-bottom: 15px; padding: 12px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2); border: 2px solid rgba(25, 118, 210, 0.3);"> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h4>
                <form id="newUserForm" onsubmit="return false;">
                <!-- Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø§Ø³Ù… + Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© + Ø§Ù„Ø¨Ø±ÙŠØ¯ -->
                <div class="form-grid grid-3">
                    <input type="text" id="newUserName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… *" autocomplete="name">
                    <select id="newUserRole">
                        <option value="admin">Ù…Ø¯ÙŠØ±</option>
                        <option value="manager">Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·</option>
                        <option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option>
                    </select>
                    <input type="email" id="newUserEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *" autocomplete="email">
                </div>
                <!-- Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ + ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± + Ø§Ù„Ù†Ø´Ø§Ø· -->
                <div class="form-grid grid-3" style="margin-top: 15px;">
                    <input type="tel" id="newUserPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ *" autocomplete="tel">
                    <input type="password" id="newUserPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *" autocomplete="new-password">
                    <select id="newUserActivity">
                        <option value="">-- ØªØ¹ÙŠÙŠÙ† Ù„Ù†Ø´Ø§Ø· --</option>
                    </select>
                </div>
                <!-- Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù„Ø«: Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† + Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© + Ø§Ù„Ø²Ø± -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-right: 3px solid #ffc107;">
                    <h5 style="color: #856404; margin: 0 0 10px 0;">ğŸ” Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù…ÙˆØµÙ‰ Ø¨Ù‡)</h5>
                    <div style="display: grid; grid-template-columns: 2fr 2fr 1fr; gap: 15px; align-items: end;">
                        <select id="newUserSecurityQuestion" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px;">
                            <option value="">-- Ø§Ø®ØªØ± Ø³Ø¤Ø§Ù„ Ø£Ù…Ø§Ù† --</option>
                            <option value="Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ØªÙƒØŸ">Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ØªÙƒØŸ</option>
                            <option value="Ù…Ø§ Ù‡ÙŠ Ù…Ø¯ÙŠÙ†Ø© Ù…ÙŠÙ„Ø§Ø¯ÙƒØŸ">Ù…Ø§ Ù‡ÙŠ Ù…Ø¯ÙŠÙ†Ø© Ù…ÙŠÙ„Ø§Ø¯ÙƒØŸ</option>
                            <option value="Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ù…Ø¯Ø±Ø³ØªÙƒ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©ØŸ">Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ù…Ø¯Ø±Ø³ØªÙƒ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©ØŸ</option>
                            <option value="Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø­ÙŠÙˆØ§Ù†Ùƒ Ø§Ù„Ø£Ù„ÙŠÙ Ø§Ù„Ø£ÙˆÙ„ØŸ">Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø­ÙŠÙˆØ§Ù†Ùƒ Ø§Ù„Ø£Ù„ÙŠÙ Ø§Ù„Ø£ÙˆÙ„ØŸ</option>
                            <option value="Ù…Ø§ Ù‡Ùˆ Ù„Ù‚Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø·ÙÙˆÙ„Ø©ØŸ">Ù…Ø§ Ù‡Ùˆ Ù„Ù‚Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø·ÙÙˆÙ„Ø©ØŸ</option>
                            <option value="Ù…Ø§ Ù‡Ùˆ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ù…ÙØ¶Ù„ØŸ">Ù…Ø§ Ù‡Ùˆ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ù…ÙØ¶Ù„ØŸ</option>
                        </select>
                        <input type="text" id="newUserSecurityAnswer" placeholder="Ø¥Ø¬Ø§Ø¨Ø© Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px;">
                        <button class="btn-primary btn-add" onclick="addUser()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease; white-space: nowrap;">âœ… Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                    <p style="font-size: 12px; color: #856404; margin: 8px 0 0 0;">ğŸ’¡ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† ÙŠØ³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†</p>
                </div>
                </form>
            </div>
            
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
            <div class="user-selector" style="margin-bottom: 25px;">
                <h4 style="background: linear-gradient(135deg, rgba(25, 118, 210, 0.15), rgba(66, 165, 245, 0.15)); color: #1976d2; margin-bottom: 15px; padding: 12px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2); border: 2px solid rgba(25, 118, 210, 0.3);">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
                <label for="usersDropdown" class="user-selector-label">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:</label>
                <div class="user-selector-controls">
                    <select id="usersDropdown" onchange="handleUserSelection()">
                        <option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§</option>
                    </select>
                </div>
                <div id="selectedUserInfo" class="selected-user-info" style="display: none;">
                    <div class="selected-user-grid">
                        <div class="selected-user-field">
                            <label for="selectedUserName">Ø§Ù„Ø§Ø³Ù…</label>
                            <input type="text" id="selectedUserName" readonly>
                        </div>
                        <div class="selected-user-field role-field">
                            <label for="selectedUserRole">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                            <input type="text" id="selectedUserRole" readonly>
                        </div>
                        <div class="selected-user-field">
                            <label for="selectedUserEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="text" id="selectedUserEmail" readonly>
                        </div>
                        <div class="selected-user-field phone-field">
                            <label for="selectedUserPhone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                            <input type="text" id="selectedUserPhone" readonly>
                        </div>
                        <div class="selected-user-field">
                            <label for="selectedUserActivity">Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø®ØµØµ</label>
                            <input type="text" id="selectedUserActivity" readonly>
                        </div>
                    </div>
                    <div class="selected-user-actions">
                        <button class="btn-warning edit-btn" id="editSelectedUserBtn" onclick="handleEditSelectedUser()" disabled>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger" id="deleteSelectedUserBtn" onclick="handleDeleteSelectedUser()" disabled>ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                </div>
            </div>
            
            <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ -->
            <div class="current-user-info" style="background: #f0f7ff; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-right: 4px solid var(--primary-color);">
                <h4 style="background: linear-gradient(135deg, rgba(25, 118, 210, 0.15), rgba(66, 165, 245, 0.15)); color: #1976d2; margin-bottom: 15px; padding: 12px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2); border: 2px solid rgba(25, 118, 210, 0.3);">ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</h4>
                <div class="form-grid grid-2" style="margin-bottom: 15px;">
                    <div>
                        <strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="currentUserNameDisplay">-</span>
                    </div>
                    <div>
                        <strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> <span id="currentUserEmailDisplay">-</span>
                    </div>
                    <div>
                        <strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> <span id="currentUserPhoneDisplay">-</span>
                    </div>
                    <div>
                        <strong>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:</strong> <span id="currentUserRoleDisplay">-</span>
                    </div>
                </div>
                <div id="currentActivityDisplay" style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <strong>ğŸ¢ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> <span id="currentActivityNameDisplay">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø·</span>
                </div>
                <div class="form-grid grid-2">
                    <button class="btn-primary" onclick="openSelfEditUserModal()" style="background: linear-gradient(135deg, #1976d2, #42a5f5); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</button>
                    <button class="btn-warning" id="changeActivityBtn" onclick="showActivityModal()" style="display: none; background: linear-gradient(135deg, #0d47a1, #1565c0); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease;">ğŸ”„ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·</button>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙˆØ§Ù„ÙØ±ÙˆØ¹ -->
    <div id="activitiesTabContent" class="settings-tab-content active">
        <div id="activityManagementSection" class="activities-management settings-card">
            <h3>ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</h3>
            
            <div class="activity-selector" style="margin-bottom: 20px;">
                <label for="activitiesDropdown" class="activity-selector-label">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø©:</label>
                <div class="form-grid grid-3" style="align-items: center;">
                    <select id="activitiesDropdown" onchange="handleActivitySelection()" style="height: 48px; padding: 10px 12px; font-size: 1em;">
                        <option value="">Ø§Ø®ØªØ± Ù†Ø´Ø§Ø·Ù‹Ø§</option>
                    </select>
                    <div id="selectedActivityInfo" class="selected-activity-info" style="display: none;">
                        <input type="text" id="selectedActivityName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·" readonly style="width: 100%; height: 48px; padding: 10px 12px; font-size: 1em;">
                    </div>
                    <div id="selectedActivityActions" class="selected-activity-actions" style="display: none; display: flex; gap: 10px; align-items: stretch;">
                        <button class="btn-warning edit-btn" id="editSelectedActivityBtn" onclick="handleEditSelectedActivity()" disabled style="flex: 1; height: 48px; padding: 0; font-size: 1em; display: flex; align-items: center; justify-content: center; line-height: 1;">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-info" id="openingBalanceBtn" onclick="openOpeningBalanceModal()" style="flex: 1; height: 48px; padding: 0; font-size: 1em; display: flex; align-items: center; justify-content: center; line-height: 1; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ’° Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ©</button>
                        <button class="btn-danger" id="deleteSelectedActivityBtn" onclick="handleDeleteSelectedActivity()" disabled style="flex: 1; height: 48px; padding: 0; font-size: 1em; display: flex; align-items: center; justify-content: center; line-height: 1;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                </div>
            </div>
            
            <div class="form-grid grid-2">
                <input type="text" id="settingNewActivityName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                <button class="btn-primary btn-add" onclick="addNewActivity(true)" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease;"> Ø¥Ø¶Ø§ÙØ© Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>

        <!-- ğŸ¢ Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹ - Ø¬Ø¯ÙŠØ¯ -->
        <div id="branchManagementSection" class="branches-management settings-card" style="display: none;">
            <h3>ğŸª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹</h3>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙØ±ÙˆØ¹ Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙˆØ§Ø­Ø¯ ÙˆØªØªØ¨Ø¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„ÙƒÙ„ ÙØ±Ø¹ Ø¹Ù„Ù‰ Ø­Ø¯Ø©
            </p>
            
            <div class="form-grid grid-2" style="margin-bottom: 20px;">
                <input type="text" id="newBranchName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ø§Ù„: Ø§Ù„Ø±ÙŠØ§Ø¶ - Ø­ÙŠ Ø§Ù„Ù†Ø®ÙŠÙ„)">
                <button class="btn-primary btn-add" onclick="addBranch()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease;">Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹</button>
            </div>
            
            <div id="branchesTableContainer">
                <table id="branchesTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                            <th style="text-align: left;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="branchesTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999; padding: 30px;">
                                Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹ - Ø£Ø¶Ù ÙØ±Ø¹Ùƒ Ø§Ù„Ø£ÙˆÙ„
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
    <div id="generalTabContent" class="settings-tab-content">
        <!-- ğŸ“„ Ù‚Ø³Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø© - Ø¬Ø¯ÙŠØ¯ -->
        <div class="settings-card">
            <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©</h3>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                ØªØ®ØµÙŠØµ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
            </p>
            
            <div class="form-grid grid-4" style="gap: 15px;">
                <button class="btn-primary" onclick="openFooterSettingsModal()" style="padding: 15px 30px; font-size: 1.1em; background: linear-gradient(135deg, #1976d2, #42a5f5);" id="footerSettingsBtn">
                    ğŸ“„ ØªØ®ØµÙŠØµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„
                </button>
                <button class="btn-info" onclick="openAboutSettingsModal()" style="padding: 15px 30px; font-size: 1.1em; background: linear-gradient(135deg, #0d47a1, #1565c0);" id="aboutSettingsBtn">
                    â„¹ï¸ ØªØ®ØµÙŠØµ Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
                </button>
                <button class="btn-success" onclick="toggleControlPanel()" style="padding: 15px 30px; font-size: 1.1em; background: linear-gradient(135deg, #7b1fa2, #9c27b0);">
                    ğŸ¨ ØªØ®ØµÙŠØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                </button>
                <button id="toggleEmailSettingsBtn" class="btn-success" onclick="toggleEmailSettings()" style="padding: 15px 30px; font-size: 1.1em; background: linear-gradient(135deg, #16a34a, #22c55e);">
                    ğŸ“§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                </button>
            </div>
            
            <div class="tips-container" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 0.85em; border: 1px solid rgba(25, 118, 210, 0.2);">
                <p><strong>ğŸ’¡ Ù†ØµØ§Ø¦Ø­:</strong></p>
                <ul style="margin: 5px 0; padding-right: 20px;">
                    <li>Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "ØªØ®ØµÙŠØµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„" Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</li>
                    <li>Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "ØªØ®ØµÙŠØµ Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬" Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</li>
                    <li>Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "ØªØ®ØµÙŠØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©" Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø®Ø·ÙˆØ·</li>
                    <li>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø­Ù„ÙŠ</li>
                </ul>
            </div>
        </div>

        <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆØ´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: stretch;">
            <div id="programLogoSection" class="logo-settings settings-card" style="display: flex; flex-direction: column; min-height: 450px;">
                <div style="flex: 1;">
                <h3>ï¿½ Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</h3>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Ø§Ø®ØªØ± Ø´Ø¹Ø§Ø±Ø§Ù‹ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</p>
                
                <div class="logo-preview-container" style="text-align: center; margin-bottom: 20px;">
                    <img id="logoPreview" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¹Ø§Ø±" style="max-width: 150px; max-height: 150px; display: none; border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
                    <p id="noLogoText" style="color: #999; font-style: italic;">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯</p>
                </div>
                
                <div class="logo-actions" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <input type="file" id="logoFileInput" accept="image/*" style="display: none;" onchange="handleLogoUpload(this)">
                    <button class="btn-primary" onclick="document.getElementById('logoFileInput').click()">ğŸ“¤ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø¹Ø§Ø±</button>
                    <button class="btn-danger" id="removeLogoBtn" onclick="removeLogo()" style="display: none;">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø±</button>
                </div>
                </div>
                
                <div class="tips-container" style="background: #e3f2fd; padding: 15px; border-radius: 8px; font-size: 0.85em; border: 1px solid rgba(25, 118, 210, 0.2);">
                    <p><strong>ğŸ’¡ Ù†ØµØ§Ø¦Ø­:</strong></p>
                    <ul style="margin: 5px 0; padding-right: 20px;">
                        <li>ÙŠÙÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø¨Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© (PNG)</li>
                        <li>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡: 500Ã—500 Ø¨ÙƒØ³Ù„</li>
                        <li>Ø£Ù‚ØµÙ‰ Ø­Ø¬Ù… Ù„Ù„Ù…Ù„Ù: 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª</li>
                    </ul>
                </div>
            </div>

            <div id="activityLogoSection" class="activity-logo-settings settings-card" style="display: none; flex-direction: column; min-height: 450px;">
                <div style="flex: 1;">
                <h3>ï¿½ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</h3>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Ø§Ø®ØªØ± Ø´Ø¹Ø§Ø±Ø§Ù‹ Ù„Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±)</p>
                
                <div class="logo-preview-container" style="text-align: center; margin-bottom: 20px;">
                    <img id="activityLogoPreview" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·" style="max-width: 150px; max-height: 150px; display: none; border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
                    <p id="noActivityLogoText" style="color: #999; font-style: italic;">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ù„Ù„Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯</p>
                </div>
                
                <div class="logo-actions" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px;">
                    <input type="file" id="activityLogoFileInput" accept="image/*" style="display: none;" onchange="handleActivityLogoUpload(this)">
                    <button class="btn-primary" onclick="document.getElementById('activityLogoFileInput').click()">ğŸ“¤ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·</button>
                    <button class="btn-danger" id="removeActivityLogoBtn" onclick="removeActivityLogo()" style="display: none;">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø±</button>
                </div>
                </div>
                
                <div class="tips-container" style="background: #e3f2fd; padding: 15px; border-radius: 8px; font-size: 0.85em; border: 1px solid rgba(25, 118, 210, 0.2);">
                    <p><strong>ğŸ’¡ Ù†ØµØ§Ø¦Ø­:</strong></p>
                    <ul style="margin: 5px 0; padding-right: 20px;">
                        <li>Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ ÙˆØ³Ø· Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· ØªØ­ØªÙ‡</li>
                        <li>ÙŠÙÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø¨Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© (PNG)</li>
                        <li>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡: 400Ã—400 Ø¨ÙƒØ³Ù„</li>
                        <li>Ø£Ù‚ØµÙ‰ Ø­Ø¬Ù… Ù„Ù„Ù…Ù„Ù: 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©: Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
    <div id="backupTabContent" class="settings-tab-content">
        <div class="backup-settings settings-card" style="background: rgba(25, 118, 210, 0.1); color: #1976d2; border: 2px solid rgba(25, 118, 210, 0.3);">
            <h3 style="color: #1976d2;">ğŸ’¾ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</h3>
            <p style="opacity: 0.85; margin-bottom: 20px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙˆØ­ÙØ¸Ù‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</p>
            
            <div class="data-actions-grid" style="gap: 15px;">
                <button id="fullBackupBtn" class="btn-secondary" onclick="downloadAutoBackup()" style="background: #6366f1; display: none;">
                    ğŸ“¥ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
                <button class="btn-success" onclick="exportActivityData()" style="background: #059669;">
                    ğŸ“¥ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ù†Ø´Ø§Ø·
                </button>
                <button class="btn-info" onclick="exportActivityDataExcel()" style="background: #0284c7;">
                    ğŸ“Š ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Excel
                </button>
                <button class="btn-primary" onclick="importData()" style="background: #7c3aed;">
                    ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ø´Ø§Ø·
                </button>
                <button class="btn-danger" onclick="showTrashModal()">
                    ğŸ—‘ï¸ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                    <span id="trash-count-badge" style="background: #fff; color: #d32f2f; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-right: 5px; font-weight: bold;"></span>
                </button>
                <button class="btn-danger" onclick="clearActivityData()" style="background: #dc2626;">
                    ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·
                </button>
            </div>
            
            <div style="background: rgba(25, 118, 210, 0.08); padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid rgba(25, 118, 210, 0.2);">
                <h4 style="color: #1976d2; margin-bottom: 10px;">ğŸ’¡ Ù†ØµØ§Ø¦Ø­ Ù…Ù‡Ù…Ø©:</h4>
                <ul style="margin: 0; padding-right: 20px; opacity: 0.85; color: #333;">
                    <li>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø£Ø¹Ù„Ø§Ù‡ Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·</li>
                    <li>Ø§Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„ÙƒÙ„ Ù†Ø´Ø§Ø· Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ</li>
                    <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØµØ­ÙŠØ­ Ù‚Ø¨Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ùˆ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
                    <li>Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªØ´Ù…Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· (Ø§Ù„Ø£ØµÙ†Ø§ÙØŒ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŒ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†ØŒ Ø§Ù„ÙÙˆØ§ØªÙŠØ±ØŒ Ø¥Ù„Ø®.)</li>
                </ul>
            </div>
            
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(this.files)">
            <input type="file" id="importExcelFile" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelImport(this.files)">
        </div>
    </div>
</div>

<!-- ğŸ“’ ØµÙØ­Ø© Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
<div id="journal" class="section">
    <h2>ğŸ“’ Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Journal Entries)</h2>
    
    <div class="settings-card" style="margin-bottom: 20px;">
        <h3>âœï¸ Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø¬Ø¯ÙŠØ¯</h3>
        <div class="form-grid grid-3">
            <input type="date" id="journalDate" placeholder="Ø§Ù„ØªØ§Ø±ÙŠØ® *" required>
            <input type="text" id="journalDescription" placeholder="Ø§Ù„ÙˆØµÙ / Ø§Ù„Ø¨ÙŠØ§Ù† *" required>
            <input type="text" id="journalReference" placeholder="Ø§Ù„Ù…Ø±Ø¬Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        </div>
        
        <div id="journalEntriesContainer" style="margin-top: 15px;">
            <h4>Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù‚ÙŠØ¯:</h4>
            <div class="form-grid grid-4" id="journalEntryRows">
                <div class="journal-entry-row" style="display: contents;" data-index="0">
                    <select class="account-select" data-index="0">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨ *</option>
                    </select>
                    <input type="number" class="debit-input" data-index="0" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†" min="0" step="0.01">
                    <input type="number" class="credit-input" data-index="0" placeholder="Ø§Ù„Ø¯Ø§Ø¦Ù†" min="0" step="0.01">
                    <!-- Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°ÙÙ‡ -->
                    <div></div>
                </div>
            </div>
            <button type="button" class="btn-secondary" onclick="addJournalRow()" style="margin-top: 10px;"> Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ©</button>
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center;">
                <div>
                    <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†:</strong>
                    <div id="totalDebit" style="color: #c62828; font-size: 1.2em;">0.00</div>
                </div>
                <div>
                    <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù†:</strong>
                    <div id="totalCredit" style="color: #2e7d32; font-size: 1.2em;">0.00</div>
                </div>
                <div>
                    <strong>Ø§Ù„ÙØ±Ù‚:</strong>
                    <div id="balanceDiff" style="font-size: 1.2em;">0.00</div>
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 15px; align-items: center; margin-top: 15px;">
            <textarea id="journalNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" rows="2" style="flex: 1; min-width: 0; resize: vertical;"></textarea>
            <button class="btn-primary" onclick="saveJournalEntry()" style="flex-shrink: 0; height: fit-content; padding: 12px 30px; white-space: nowrap;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯</button>
        </div>
    </div>
    
    <div class="settings-card">
        <h3>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</h3>
        
        <div class="form-grid grid-4" style="margin-bottom: 15px;">
            <input type="date" id="journalFilterFrom" placeholder="Ù…Ù† ØªØ§Ø±ÙŠØ®">
            <input type="date" id="journalFilterTo" placeholder="Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®">
            <input type="text" id="journalSearchText" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØµÙ Ø£Ùˆ Ø§Ù„Ù…Ø±Ø¬Ø¹">
            <button class="btn-secondary" onclick="renderJournalList()">ğŸ” Ø¨Ø­Ø«</button>
        </div>
        
        <div style="margin-bottom: 15px;">
            <button class="btn-primary" onclick="exportJournalToExcel()" style="background: linear-gradient(135deg, #28a745, #20c997);">
                ğŸ“Š ØªØµØ¯ÙŠØ± Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¥Ù„Ù‰ Excel
            </button>
            <button class="btn-primary" onclick="exportJournalToPDF()" style="background: linear-gradient(135deg, #007bff, #0056b3);">
                ğŸ“„ ØªØµØ¯ÙŠØ± Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¥Ù„Ù‰ PDF
            </button>
        </div>
        
        <div id="journalList" style="max-height: 500px; overflow-y: auto;"></div>
    </div>
</div>

<!-- ğŸ—‚ï¸ ØµÙØ­Ø© Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª -->
<div id="chartOfAccounts" class="section">
    <h2>ğŸ—‚ï¸ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Chart of Accounts)</h2>
    
    <div class="settings-card" style="margin-bottom: 20px;">
        <div class="form-grid grid-3">
            <input type="text" id="accountSearchText" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø³Ù…)">
            <select id="accountCategoryFilter">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
                <option value="asset">Ø§Ù„Ø£ØµÙˆÙ„</option>
                <option value="liability">Ø§Ù„Ø®ØµÙˆÙ…</option>
                <option value="equity">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</option>
                <option value="revenue">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</option>
                <option value="expense">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</option>
            </select>
            <button class="btn-secondary" onclick="renderChartOfAccounts()">ğŸ” Ø¨Ø­Ø«</button>
        </div>
    </div>
    
    <div class="settings-card">
        <h3>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div style="background: linear-gradient(135deg, #2196f3, #42a5f5); padding: 15px; border-radius: 8px; text-align: center; color: white;">
                <div style="font-size: 0.9em; opacity: 0.9;">ğŸ’° Ø§Ù„Ø£ØµÙˆÙ„</div>
                <div style="font-size: 1.5em; font-weight: bold;" id="assetsBalance">0.00</div>
            </div>
            <div style="background: linear-gradient(135deg, #f44336, #ef5350); padding: 15px; border-radius: 8px; text-align: center; color: white;">
                <div style="font-size: 0.9em; opacity: 0.9;">ğŸ“Š Ø§Ù„Ø®ØµÙˆÙ…</div>
                <div style="font-size: 1.5em; font-weight: bold;" id="liabilitiesBalance">0.00</div>
            </div>
            <div style="background: linear-gradient(135deg, #9c27b0, #ab47bc); padding: 15px; border-radius: 8px; text-align: center; color: white;">
                <div style="font-size: 0.9em; opacity: 0.9;">ğŸ¢ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</div>
                <div style="font-size: 1.5em; font-weight: bold;" id="equityBalance">0.00</div>
            </div>
            <div style="background: linear-gradient(135deg, #4caf50, #66bb6a); padding: 15px; border-radius: 8px; text-align: center; color: white;">
                <div style="font-size: 0.9em; opacity: 0.9;">ğŸ’µ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                <div style="font-size: 1.5em; font-weight: bold;" id="revenueBalance">0.00</div>
            </div>
            <div style="background: linear-gradient(135deg, #ff9800, #ffa726); padding: 15px; border-radius: 8px; text-align: center; color: white;">
                <div style="font-size: 0.9em; opacity: 0.9;">ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
                <div style="font-size: 1.5em; font-weight: bold;" id="expenseBalance">0.00</div>
            </div>
        </div>
        
        <div id="chartOfAccountsList"></div>
    </div>
</div>

<!-- ğŸ“± ØµÙØ­Ø© Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ -->
<div id="about" class="section">
    <h2>â„¹ï¸ Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</h2>
    
    <div style="max-width: 800px; margin: 0 auto;">
        <!-- Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div class="settings-card" style="text-align: center; background: white; border: 1px solid #ddd; padding: 30px;">
            <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ -->
            <img id="aboutProgramLogo" src="https://res.cloudinary.com/dgjcr2bgq/image/upload/v1762349658/logo_vlldbc.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬" style="width: 100px; height: 100px; margin: 0 auto 15px; border-radius: 8px; display: block;">
            
            <!-- Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆØ§Ù„Ø¥ØµØ¯Ø§Ø± -->
            <h1 id="aboutProgramName" style="color: #1976d2; margin: 0 0 5px 0; font-size: 1.8em;">Ø¯ÙŠÙˆØ§Ù†ÙŠ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©</h1>
            <p id="aboutVersion" style="color: #666; font-size: 1em; margin: 0 0 20px 0;">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2.0</p>
            
            <!-- ÙˆØµÙ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #e1e5e9;">
                <p id="aboutDescription" style="color: #555; line-height: 1.8; text-align: justify; font-size: 1em; margin: 0;">
                    Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©ØŒ ÙŠÙˆÙØ± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø³Ù‡Ù„Ø© ÙˆÙØ¹Ø§Ù„Ø©. 
                    ÙŠØ¯Ø¹Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆØ§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… FirebaseØŒ Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø¯ÙŠØ«Ø© ÙˆØ³Ù‡Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….
                </p>
            </div>
        </div>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù†ØµÙŠØ© -->
        <div class="settings-card" style="background: white; border: 1px solid #ddd; padding: 25px; margin-top: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
                <div>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">ğŸ‘¨â€ğŸ’» Ø§Ù„Ù…Ø·ÙˆØ±</div>
                    <div id="aboutDeveloper" style="font-size: 1.1em; font-weight: 600; color: #333;">ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ·ÙˆÙŠØ±</div>
                </div>
                <div>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">ğŸ“… Ø³Ù†Ø© Ø§Ù„Ø¥ØµØ¯Ø§Ø±</div>
                    <div id="aboutYear" style="font-size: 1.1em; font-weight: 600; color: #333;">2025</div>
                </div>
                <div>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">ğŸ“œ Ø§Ù„ØªØ±Ø®ÙŠØµ</div>
                    <div style="font-size: 1.1em; font-weight: 600; color: #333;">Ù…ÙØªÙˆØ­ Ø§Ù„Ù…ØµØ¯Ø±</div>
                </div>
            </div>
        </div>

        <!-- Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ -->
        <div class="settings-card" style="margin-top: 20px; background: rgba(25, 118, 210, 0.05); border: 2px solid rgba(25, 118, 210, 0.2);">
            <h3 style="color: #1976d2; margin-bottom: 20px; font-size: 1.5em;">âœ¨ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div style="background: white; padding: 15px; border-radius: 8px; border-right: 4px solid #1976d2;">
                    <strong style="color: #1976d2;">ğŸ“Š Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙƒØ§Ù…Ù„Ø©</strong>
                    <p style="margin: 8px 0 0 0; color: #666; font-size: 0.95em;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</p>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border-right: 4px solid #2e7d32;">
                    <strong style="color: #2e7d32;">â˜ï¸ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</strong>
                    <p style="margin: 8px 0 0 0; color: #666; font-size: 0.95em;">Ø¯Ø¹Ù… Firebase Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</p>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border-right: 4px solid #e65100;">
                    <strong style="color: #e65100;">ğŸ”’ Ø§Ù„Ø£Ù…Ø§Ù†</strong>
                    <p style="margin: 8px 0 0 0; color: #666; font-size: 0.95em;">Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù† Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø©</p>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border-right: 4px solid #7b1fa2;">
                    <strong style="color: #7b1fa2;">ğŸ“± ÙˆØ§Ø¬Ù‡Ø© Ø­Ø¯ÙŠØ«Ø©</strong>
                    <p style="margin: 8px 0 0 0; color: #666; font-size: 0.95em;">ØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠ ÙˆØ³Ù‡Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø®ØªÙ„ÙØ©</p>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border-right: 4px solid #c62828;">
                    <strong style="color: #c62828;">ğŸ“ˆ ØªÙ‚Ø§Ø±ÙŠØ± Ù…ÙØµÙ„Ø©</strong>
                    <p style="margin: 8px 0 0 0; color: #666; font-size: 0.95em;">ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø§Ù„ÙŠØ© Ø´Ø§Ù…Ù„Ø© ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¯Ù‚ÙŠÙ‚Ø©</p>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border-right: 4px solid #0277bd;">
                    <strong style="color: #0277bd;">ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</strong>
                    <p style="margin: 8px 0 0 0; color: #666; font-size: 0.95em;">Ù†Ø¸Ø§Ù… Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù…ØªÙ‚Ø¯Ù… Ù„Ø­Ù…Ø§ÙŠØ© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</p>
                </div>
            </div>
        </div>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø¯Ø¹Ù… -->
        <div class="settings-card" style="margin-top: 20px; text-align: center; background: rgba(25, 118, 210, 0.1); border: 2px solid rgba(25, 118, 210, 0.3); color: #333;">
            <h3 style="color: #1976d2; margin-bottom: 15px; font-size: 1.3em;">ğŸ“ Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„ØªÙˆØ§ØµÙ„</h3>
            <p style="font-size: 1em; margin: 10px 0; color: #555;">
                ğŸ’¡ Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª
            </p>
            <div style="background: rgba(25, 118, 210, 0.08); padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid rgba(25, 118, 210, 0.2);">
                <p style="margin: 0; font-size: 0.95em; color: #333;">
                    ğŸŒ <strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> Ù‚Ø±ÙŠØ¨Ø§Ù‹<br>
                    ğŸ“§ <strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> Ù‚Ø±ÙŠØ¨Ø§Ù‹
                </p>
            </div>
        </div>

        <!-- Ø´ÙƒØ± ÙˆØªÙ‚Ø¯ÙŠØ± -->
        <div style="text-align: center; margin-top: 25px; padding: 15px; color: #666;">
            <p style="font-size: 1em; margin: 0;">
                â¤ï¸ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¯ÙŠÙˆØ§Ù†ÙŠ
            </p>
            <p style="font-size: 0.85em; margin: 8px 0 0 0; color: #999;">
                Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025
            </p>
        </div>
    </div>
</div>

<div id="purchaseInvoicePrint" class="invoice-print">
    <!-- Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ -->
    <div style="border: 4px double #2c5aa0; padding: 15px; position: relative;">
        
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø±: Ø§Ù„Ø´Ø¹Ø§Ø± (Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø±) + Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· -->
        <div style="border: 2px solid #2c5aa0; border-radius: 15px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center;">
            <div style="width: 60px; display: flex; justify-content: flex-start;">
                <img id="printPurchaseActivityLogo" src="" alt="Ø´Ø¹Ø§Ø±" style="width: 50px; height: 50px; display: none; margin: 0; border-radius: 50%; border: 2px solid #2c5aa0;">
            </div>
            <div style="text-align: center; flex: 1;">
                <h2 id="printPurchaseActivityName" style="margin: 0; color: #2c5aa0; font-size: 1.5em; font-weight: bold;">Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·</h2>
                <div style="font-size: 0.85em; margin-top: 2px;">ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</div>
            </div>
            <div style="width: 60px;"></div>
        </div>
        
        <!-- ØµÙ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 0.95em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px;">
                <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="printPurchaseDate"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px;">
                <strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> <span id="printPurchaseNumber"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px;">
                <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> <span id="printPurchaseTime">--:--</span>
            </div>
        </div>
        
        <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ -->
        <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 10px; font-size: 0.95em;">
            <strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> <span id="printSupplierName">-----</span>
        </div>
        
        <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 10px; font-size: 0.9em;">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> <span id="printPurchaseNotes">-----</span>
        </div>
        
        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù -->
        <table class="invoice-items-table" style="width: 100%; border-collapse: collapse; margin-bottom: 10px; table-layout: fixed; display: table; margin: 0;">
            <colgroup>
                <col style="width: 5%;">    <!-- Ù… -->
                <col style="width: 25%;">   <!-- Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù -->
                <col style="width: 12.5%;"> <!-- Ø§Ù„ÙƒÙ…ÙŠØ© -->
                <col style="width: 12.5%;"> <!-- Ø§Ù„ÙˆØ­Ø¯Ø© -->
                <col style="width: 12.5%;"> <!-- Ø§Ù„Ø³Ø¹Ø± -->
                <col style="width: 12.5%;"> <!-- Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ -->
            </colgroup>
            <thead>
                <tr style="background: #e3f2fd; color: #2c5aa0;">
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">Ù…</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: right;">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">Ø§Ù„Ø³Ø¹Ø±</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                </tr>
            </thead>
            <tbody id="printPurchaseItems" style="font-size: 0.95em;">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </tbody>
        </table>
        
        <!-- Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± Ø§Ù„ØµÙØ­Ø© -->
        <div style="margin-top: 15px; width: 280px; float: left;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #f8f9fa; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</strong>
                <span id="printPurchaseSubtotal">0.00</span>
            </div>
            <div id="printPurchaseTaxRow" style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%):</strong>
                <span id="printPurchaseTax">0.00</span>
            </div>
            <div style="border: 2px solid #2c5aa0; padding: 10px; background: #e3f2fd; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-weight: bold; font-size: 1em; color: #2c5aa0;">
                <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong>
                <span id="printPurchaseTotal">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong>
                <span id="printPurchasePaid">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #fff3cd; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong>
                <span id="printPurchaseRemaining">0.00</span>
            </div>
        </div>
        
        <div style="clear: both;"></div>
    </div>
</div>

<div id="saleInvoicePrint" class="invoice-print">
    <!-- Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ -->
    <div style="border: 4px double #2c5aa0; padding: 15px; position: relative;">
        
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø±: Ø§Ù„Ø´Ø¹Ø§Ø± (Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø±) + Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· -->
        <div style="border: 2px solid #2c5aa0; border-radius: 15px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center;">
            <div style="width: 60px; display: flex; justify-content: flex-start;">
                <img id="printSaleActivityLogo" src="" alt="Ø´Ø¹Ø§Ø±" style="width: 50px; height: 50px; display: none; margin: 0; border-radius: 50%; border: 2px solid #2c5aa0;">
            </div>
            <div style="text-align: center; flex: 1;">
                <h2 id="printSaleActivityName" style="margin: 0; color: #2c5aa0; font-size: 1.5em; font-weight: bold;">Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·</h2>
                <div style="font-size: 0.85em; margin-top: 2px;">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</div>
            </div>
            <div style="width: 60px;"></div>
        </div>
        
        <!-- ØµÙ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div style="display: grid; grid-template-columns: 1fr 1.5fr 0.8fr; gap: 10px; margin-bottom: 10px; font-size: 0.95em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; font-size: 0.85em; border-radius: 8px;">
                <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="printSaleDate"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; background: #e3f2fd; font-size: 0.85em; border-radius: 8px;">
                <strong>ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø© Ù€ Ø±Ù‚Ù…:</strong> <span id="printSaleNumber"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; font-size: 0.85em; border-radius: 8px;">
                <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> <span id="printSaleTime">--:--</span>
            </div>
        </div>
        
        <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
        <div style="display: grid; grid-template-columns: 1.5fr 0.8fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 0.95em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="printCustomerName">-----</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="printCustomerCode">-----</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> <span id="printCustomerPhone">-----</span>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 0.9em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="printCustomerAddress">-----</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> <span id="printSaleNotes">-----</span>
            </div>
        </div>
        
        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù -->
    <table class="invoice-items-table" style="width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 10px;">
            <thead>
                <tr style="background: #e3f2fd; color: #2c5aa0;">
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 5%; border-radius: 6px;">Ù…</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15%; border-radius: 6px;">Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 33%; border-radius: 6px;">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15.5%; border-radius: 6px;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15.5%; border-radius: 6px;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15.5%; border-radius: 6px;">Ø§Ù„Ø³Ø¹Ø±</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 12.5%; border-radius: 6px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                </tr>
            </thead>
            <tbody id="printSaleItems" style="font-size: 0.9em;">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </tbody>
        </table>
        
        <!-- Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± Ø§Ù„ØµÙØ­Ø© -->
            <div style="margin-top: 15px; width: 280px; float: left;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #f8f9fa; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</strong>
                <span id="printSaleSubtotal">0.00</span>
            </div>
            <div id="printSaleDiscountRow" style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #fff8e1; font-size: 0.9em;">
                <strong>Ø§Ù„Ø®ØµÙ…:</strong>
                <span id="printSaleDiscount">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #e8f5e8; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…:</strong>
                <span id="printSaleAfterDiscount">0.00</span>
            </div>
            <div id="printSaleTaxRow" style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%):</strong>
                <span id="printSaleTax">0.00</span>
            </div>
            <div style="border: 2px solid #2c5aa0; padding: 10px; background: #e3f2fd; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-weight: bold; font-size: 1em; color: #2c5aa0;">
                <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong>
                <span id="printSaleTotal">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong>
                <span id="printSalePaid">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #e8f4fd; font-size: 0.9em;">
                <strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong>
                <span id="printSalePaymentMethod">ğŸ’° ÙƒØ§Ø´</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #fff3cd; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong>
                <span id="printSaleRemaining">0.00</span>
            </div>
        </div>
        
        <div style="clear: both;"></div>
    </div>
</div>
        </div>
    </div>
    <script>
// === Ø¯ÙˆØ§Ù„ Firebase Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ===
// ... (Ø£Ø³ÙÙ„ Ø¯ÙˆØ§Ù„ firebaseGet, firebaseSet, etc.)

console.log('ğŸ”¥ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ...');

console.log('ğŸ” Checking if we reach this point...');

// ===== Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰) =====
function loadFromLocalStorage(key) {
    try {
        const fullKey = resolveStorageKey(key);
        const data = localStorage.getItem(fullKey);
        const parsed = data ? JSON.parse(data) : null;
        
        // ØªØ³Ø¬ÙŠÙ„ Ù…ÙØµÙ„ ÙÙ‚Ø· Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ø£Ùˆ ÙÙŠ Ø­Ø§Ù„Ø© Debug
        if (window.DEBUG_MODE || key === 'users' || key === 'activities') {
            console.log(`ğŸ“‚ loadFromLocalStorage: key="${key}" -> fullKey="${fullKey}"`);
            console.log(`ğŸ“Š ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${Array.isArray(parsed) ? parsed.length : 'null'} Ø¹Ù†ØµØ±`);
        }
        
        return parsed;
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
        return null;
    }
}

// ØªÙ… Ù†Ù‚Ù„ resolveStorageKey Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ù…ÙˆØ­Ø¯ Ø£Ø¯Ù†Ø§Ù‡

// ===== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ù…Ø¨ÙƒØ±Ø© =====
let currentActivityId = null;

// ===== Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† =====
function calculateTotalStock() {
    if (!items || !Array.isArray(items)) return 0;
    return items.reduce((total, item) => total + (parseInt(item.stock) || 0), 0);
}

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª (ØªØ¹Ø±ÙŠÙ Ù…Ø¨ÙƒØ±) =====
// Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ø©
const GLOBAL_STORAGE_KEYS = new Set(['diwan_users', 'diwan_activities']);

function generateWarehouseCode() {
    const list = (typeof warehouses !== 'undefined' && warehouses) ? warehouses : (typeof branches !== 'undefined' ? branches : []);
    return 'WH' + (list.length + 1).toString().padStart(3, '0');
}

function ensurePrimaryWarehouse() {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    if (typeof warehouses === 'undefined') {
        warehouses = [];
    }
    if (typeof branches === 'undefined') {
        branches = [];
    }
    
    // ØªØ²Ø§Ù…Ù† warehouses Ù…Ø¹ branches Ø¥Ø°Ø§ ÙƒØ§Ù† branches ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª
    if (branches.length > 0 && warehouses.length === 0) {
        warehouses = branches;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªÙˆØ¯Ø¹ Ø±Ø¦ÙŠØ³ÙŠ
    if (!warehouses.some(w => w.type === 'primary' || w.isPrimary)) {
        console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
        const primary = {
            id: Date.now(),
            code: generateWarehouseCode(),
            name: 'Primary Warehouse',
            type: 'primary',
            isPrimary: true,
            shippingAddress: '',
            city: '',
            manager: '',
            phone: '',
            notes: '',
            account: 'Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ',
            active: true
        };
        warehouses.push(primary);
        branches = warehouses; // ØªØ²Ø§Ù…Ù†
        try { if(typeof saveToLocalStorage === 'function') saveToLocalStorage('branches', branches); } catch(e){ console.warn(e); }
    }
}

/**
 * Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø§Ù„Ù…ØªØµÙ„Ø© Ù…Ø¹ Ø§Ù„Ø£ØµÙ†Ø§Ù
 */
function renderWarehouses() {
    ensurePrimaryWarehouse();
    
    const grid = document.getElementById('warehousesGrid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    let totalQuantity = 0;
    let totalValue = 0;
    
    if (!warehouses || warehouses.length === 0) {
        grid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: #999;">
                <div style="font-size: 4em; margin-bottom: 15px;">ğŸ­</div>
                <div style="font-size: 1.2em; margin-bottom: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>
                <div style="font-size: 0.9em;">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆØ¯Ø¹ Ø¬Ø¯ÙŠØ¯ Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø²ÙˆÙ†Ùƒ</div>
            </div>
        `;
        updateWarehousesTopStats(0, 0, 0);
        return;
    }
    
    warehouses.forEach(warehouse => {
        // Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ù…Ù† Ø§Ù„Ø£ØµÙ†Ø§Ù
        const warehouseItems = items.filter(item => 
            item.warehouseId === warehouse.id || 
            (!item.warehouseId && (warehouse.isPrimary || warehouse.type === 'primary'))
        );
        
        const itemsCount = warehouseItems.length;
        const stockQuantity = warehouseItems.reduce((sum, item) => sum + (item.stock || 0), 0);
        const stockValue = warehouseItems.reduce((sum, item) => 
            sum + ((item.stock || 0) * (item.cost || item.purchasePrice || 0)), 0
        );
        
        totalQuantity += stockQuantity;
        totalValue += stockValue;
        
        // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        const card = document.createElement('div');
        card.style.cssText = `
            background: white;
            border: 2px solid ${warehouse.isPrimary || warehouse.type === 'primary' ? '#2196f3' : '#e0e6ed'};
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        `;
        card.onmouseenter = function() { this.style.transform = 'translateY(-5px)'; this.style.boxShadow = '0 6px 20px rgba(33, 150, 243, 0.15)'; };
        card.onmouseleave = function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)'; };
        
        const isPrimary = warehouse.isPrimary || warehouse.type === 'primary';
        const statusColor = warehouse.active !== false ? '#4caf50' : '#f44336';
        const statusText = warehouse.active !== false ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·';
        
        card.innerHTML = `
            <!-- Header -->
            <div style="background: ${isPrimary ? 'linear-gradient(135deg, rgba(21, 101, 192, 0.9) 0%, rgba(33, 150, 243, 0.9) 100%)' : 'linear-gradient(135deg, rgba(33, 150, 243, 0.7) 0%, rgba(66, 165, 245, 0.7) 100%)'}; padding: 15px; color: white;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 5px;">${warehouse.name}</div>
                        <div style="font-size: 0.85em; opacity: 0.9;">ğŸ“ ${warehouse.address || warehouse.shippingAddress || 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'}</div>
                    </div>
                    <div style="display: flex; gap: 5px; flex-direction: column; align-items: flex-end;">
                        ${isPrimary ? '<span style="background: rgba(255,255,255,0.3); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: bold; backdrop-filter: blur(10px);">ğŸ† Ø±Ø¦ÙŠØ³ÙŠ</span>' : ''}
                        <span style="background: ${statusColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: bold;">â— ${statusText}</span>
                    </div>
                </div>
                ${warehouse.manager ? `<div style="font-size: 0.85em; opacity: 0.9;">ğŸ‘¤ ${warehouse.manager}</div>` : ''}
            </div>
            
            <!-- Stats Section -->
            <div style="padding: 20px; background: #f8f9fa;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e0e6ed;">
                        <div style="font-size: 1.8em; font-weight: bold; color: #1976d2;">${itemsCount}</div>
                        <div style="font-size: 0.75em; color: #666; margin-top: 4px;">ğŸ“¦ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e0e6ed;">
                        <div style="font-size: 1.8em; font-weight: bold; color: #2196f3;">${stockQuantity.toFixed(0)}</div>
                        <div style="font-size: 0.75em; color: #666; margin-top: 4px;">ğŸ“Š Ø§Ù„ÙƒÙ…ÙŠØ©</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e0e6ed;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #03a9f4;">${stockValue.toFixed(0)}</div>
                        <div style="font-size: 0.75em; color: #666; margin-top: 4px;">ğŸ’° Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø±.Ø³)</div>
                    </div>
                </div>
                
                <!-- Additional Info -->
                <div style="display: flex; gap: 8px; flex-wrap: wrap; padding: 10px; background: white; border-radius: 8px; border: 1px solid #e0e6ed;">
                    <span style="background: #e3f2fd; color: #1976d2; padding: 4px 10px; border-radius: 6px; font-size: 0.8em;">ğŸ”– ${warehouse.code || 'N/A'}</span>
                    ${warehouse.phone ? `<span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 10px; border-radius: 6px; font-size: 0.8em;">ğŸ“ ${warehouse.phone}</span>` : ''}
                </div>
            </div>
            
            <!-- Actions Footer -->
            <div style="padding: 15px; background: white; border-top: 1px solid #e0e6ed; display: flex; gap: 8px; justify-content: space-between;">
                <button onclick="editWarehouse(${warehouse.id})" class="btn-secondary" style="flex: 1; padding: 10px; border: 1px solid #667eea; color: #667eea; background: white; font-weight: 600;">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                <button onclick="viewWarehouseInventory(${warehouse.id})" class="btn-primary" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-weight: 600;">ğŸ“‹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
                ${!isPrimary ? `<button onclick="deleteWarehouse(${warehouse.id})" class="btn-danger" style="padding: 10px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">ğŸ—‘ï¸</button>` : ''}
            </div>
        `;
        
        grid.appendChild(card);
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ù„ÙŠØ§
    updateWarehousesTopStats(warehouses.length, totalQuantity, totalValue);
}

/**
 * ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙŠØ§
 */
function updateWarehousesTopStats(count, quantity, value) {
    const countEl = document.getElementById('totalWarehousesCount');
    const quantityEl = document.getElementById('totalItemsQuantity');
    const valueEl = document.getElementById('totalInventoryValue');
    
    if (countEl) countEl.textContent = count;
    if (quantityEl) quantityEl.textContent = quantity.toFixed(0);
    if (valueEl) valueEl.textContent = value.toFixed(2) + ' Ø±.Ø³';
}

/**
 * Ø¹Ø±Ø¶ Ù…Ø®Ø²ÙˆÙ† Ù…Ø³ØªÙˆØ¯Ø¹ Ù…Ø¹ÙŠÙ†
 */
function viewWarehouseInventory(warehouseId) {
    const warehouse = warehouses.find(w => w.id === warehouseId);
    if (!warehouse) {
        showNotification('âŒ Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', 'error');
        return;
    }
    
    const warehouseItems = items.filter(item => 
        item.warehouseId === warehouseId || 
        (!item.warehouseId && (warehouse.isPrimary || warehouse.type === 'primary'))
    );
    
    if (warehouseItems.length === 0) {
        showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø©', `Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ÙÙŠ ${warehouse.name}`, 'info');
        return;
    }
    
    let itemsHtml = '';
    warehouseItems.forEach((item, index) => {
        const stockValue = (item.stock || 0) * (item.cost || item.purchasePrice || 0);
        itemsHtml += `
            <tr style="${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                <td style="padding: 10px; border: 1px solid #dee2e6;">${index + 1}</td>
                <td style="padding: 10px; border: 1px solid #dee2e6;">${item.code || 'N/A'}</td>
                <td style="padding: 10px; border: 1px solid #dee2e6;">${item.name}</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${(item.stock || 0).toFixed(2)}</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${item.unit || 'Ù‚Ø·Ø¹Ø©'}</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${(item.cost || item.purchasePrice || 0).toFixed(2)}</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: bold; color: #4facfe;">${stockValue.toFixed(2)}</td>
            </tr>
        `;
    });
    
    const totalQuantity = warehouseItems.reduce((sum, item) => sum + (item.stock || 0), 0);
    const totalValue = warehouseItems.reduce((sum, item) => sum + ((item.stock || 0) * (item.cost || item.purchasePrice || 0)), 0);
    
    const modalHtml = `
        <div id="warehouse-inventory-modal" class="modal-overlay" onclick="closeWarehouseInventoryModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h3>ğŸ“‹ Ù…Ø®Ø²ÙˆÙ† ${warehouse.name}</h3>
                    <button class="modal-close-btn" onclick="closeWarehouseInventoryModal()">âœ–</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white;">
                            <div style="font-size: 0.9em; opacity: 0.9;">ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
                            <div style="font-size: 2em; font-weight: bold; margin-top: 5px;">${warehouseItems.length}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px; color: white;">
                            <div style="font-size: 0.9em; opacity: 0.9;">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</div>
                            <div style="font-size: 2em; font-weight: bold; margin-top: 5px;">${totalValue.toFixed(2)} Ø±.Ø³</div>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="padding: 12px; border: 1px solid #dee2e6;">#</th>
                                <th style="padding: 12px; border: 1px solid #dee2e6;">Ø§Ù„ÙƒÙˆØ¯</th>
                                <th style="padding: 12px; border: 1px solid #dee2e6;">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                                <th style="padding: 12px; border: 1px solid #dee2e6;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th style="padding: 12px; border: 1px solid #dee2e6;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th style="padding: 12px; border: 1px solid #dee2e6;">Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                                <th style="padding: 12px; border: 1px solid #dee2e6;">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                        <tfoot>
                            <tr style="background: #f8f9fa; font-weight: bold;">
                                <td colspan="3" style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">${totalQuantity.toFixed(2)}</td>
                                <td colspan="2" style="padding: 12px; border: 1px solid #dee2e6;"></td>
                                <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center; color: #4facfe;">${totalValue.toFixed(2)} Ø±.Ø³</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeWarehouseInventoryModal()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeWarehouseInventoryModal(event) {
    if (event && event.target !== event.currentTarget) return;
    const modal = document.getElementById('warehouse-inventory-modal');
    if (modal) modal.remove();
}

function openAddWarehouse() {
    const modal = document.getElementById('warehouseModal');
    if (!modal) return;
    
    // Clear edit mode
    editingWarehouse = null;
    
    // Update modal title
    const title = document.getElementById('warehouseModalTitle');
    if (title) title.textContent = 'â­ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆØ¯Ø¹ Ø¬Ø¯ÙŠØ¯';
    
    // Generate new code
    const codeEl = document.getElementById('warehouseCode');
    if (codeEl) codeEl.value = generateWarehouseCode();
    
    // Clear form
    clearWarehouseForm();
    
    // Show modal
    modal.style.display = 'flex';
}

function closeWarehouseModal() {
    const modal = document.getElementById('warehouseModal');
    if (!modal) return;
    modal.style.display = 'none';
    clearWarehouseForm();
    editingWarehouse = null;
}

function clearWarehouseForm() {
    ['warehouseName', 'warehouseAddress', 'warehouseManager', 'warehousePhone'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    const primaryEl = document.getElementById('warehouseIsPrimary');
    if (primaryEl) primaryEl.checked = false;
}

function saveWarehouse() {
    const name = document.getElementById('warehouseName').value.trim();
    const address = document.getElementById('warehouseAddress').value.trim();
    const manager = document.getElementById('warehouseManager').value.trim();
    const phone = document.getElementById('warehousePhone').value.trim();
    const isPrimary = document.getElementById('warehouseIsPrimary').checked;
    
    if (!name) {
        if (typeof showNotification === 'function') {
            showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', 'warning');
        }
        return;
    }
    
    if (editingWarehouse) {
        // Edit mode
        const index = warehouses.findIndex(w => w.id === editingWarehouse.id);
        if (index !== -1) {
            warehouses[index] = {
                ...warehouses[index],
                name,
                address,
                shippingAddress: address,
                manager,
                phone,
                isPrimary,
                type: isPrimary ? 'primary' : 'secondary'
            };
            branches = warehouses; // ØªØ²Ø§Ù…Ù†
            if (typeof saveToLocalStorage === 'function') {
                saveToLocalStorage('branches', branches);
            }
            if (typeof showNotification === 'function') {
                showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        }
    } else {
        // Add mode
        const newWarehouse = {
            id: Date.now(),
            code: generateWarehouseCode(),
            name,
            address,
            shippingAddress: address,
            manager,
            phone,
            isPrimary,
            type: isPrimary ? 'primary' : 'secondary',
            active: true,
            account: 'Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ'
        };
        warehouses.push(newWarehouse);
        branches = warehouses; // ØªØ²Ø§Ù…Ù†
        if (typeof saveToLocalStorage === 'function') {
            saveToLocalStorage('branches', branches);
        }
        if (typeof showNotification === 'function') {
            showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
    }
    
    renderWarehouses();
    closeWarehouseModal();
}

function toggleWarehouseDropdown(id) {
    // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø®Ø±Ù‰
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
        if (menu.id !== `dropdown-${id}`) {
            menu.style.display = 'none';
        }
    });
    
    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const dropdown = document.getElementById(`dropdown-${id}`);
    if (dropdown) {
        const willShow = dropdown.style.display === 'none';
        dropdown.style.display = willShow ? 'block' : 'none';
        // Ù„Ù… Ù†Ø¹Ø¯ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØŒ Ø§Ø¹ØªÙ…Ø¯Ù†Ø§ Ø¹Ù„Ù‰ left Ø«Ø§Ø¨Øª = 15px Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©.
    }
}

// Generic Action Menu Functions
function toggleActionMenu(arg1, arg2, arg3) {
    // Ø¯Ø¹Ù… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©: (event, itemId) Ø£Ùˆ (buttonEl, menuId, event)
    let e = null;
    let itemId = null;
    if (typeof arg1 === 'object' && arg1 && (arg1.preventDefault || arg1.type)) {
        // Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: (event, itemId)
        e = arg1;
        itemId = arg2;
    } else {
        // Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: (buttonEl, menuId, event)
        e = arg3 || window.event;
        itemId = arg2;
    }
    // Handle both event parameter and global window.event
    e = e || window.event;
    if (e && e.stopPropagation) {
        e.stopPropagation();
    }
    if (e && e.preventDefault) {
        e.preventDefault();
    }
    
    console.log('toggleActionMenu called for:', itemId);
    
    // Ø¯Ø¹Ù… ÙƒÙ„Ù Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø¯Ø¦Ø© 'menu-'
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù‡Ø¯Ù Ø¨Ø°ÙƒØ§Ø¡:
    // 1) Ø¥Ø°Ø§ ÙƒØ§Ù† itemId ÙŠØ·Ø§Ø¨Ù‚ Ø¹Ù†ØµØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ DOM Ù†Ø³ØªØ®Ø¯Ù…Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ.
    // 2) ÙˆØ¥Ù„Ø§ Ù†Ø¬Ø±Ø¨ Ø¥Ø¶Ø§ÙØ© 'menu-' ÙƒØ¨Ø§Ø¯Ø¦Ø©.
    let targetId = itemId;
    if (!document.getElementById(targetId)) {
        targetId = `menu-${itemId}`;
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
    document.querySelectorAll('.action-menu-content').forEach(menu => {
        if (menu.id !== targetId) {
            menu.style.display = 'none';
        }
    });

    const menu = document.getElementById(targetId);
    if (menu) {
        const isVisible = menu.style.display === 'block';
        menu.style.display = isVisible ? 'none' : 'block';
        console.log('Menu display set to:', menu.style.display);
    } else {
        console.error('Menu not found:', targetId);
    }
}

function closeActionMenu(menuId) {
    const menu = document.getElementById(menuId);
    if (menu) {
        menu.style.display = 'none';
    }
}

// Close menus when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.action-menu-container')) {
        document.querySelectorAll('.action-menu-content, .action-dropdown-menu, .action-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    }
});

function viewWarehouse(id) {
    const warehouse = warehouses.find(w => w.id === id);
    if (!warehouse) return;
    
    if(typeof showNotification === 'function') {
        showNotification('ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', `Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: ${warehouse.name}\nØ§Ù„ÙƒÙˆØ¯: ${warehouse.code}\nØ§Ù„Ø­Ø§Ù„Ø©: ${warehouse.active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}`, 'info');
    }
    closeDropdown(id);
}

function editWarehouse(id) {
    const warehouse = warehouses.find(w => w.id === id);
    if (!warehouse) {
        if (typeof showNotification === 'function') {
            showNotification('âš ï¸ Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', 'error');
        }
        return;
    }
    
    editingWarehouse = warehouse;
    
    // Update modal title
    const title = document.getElementById('warehouseModalTitle');
    if (title) title.textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙˆØ¯Ø¹';
    
    // Fill form with existing data
    const nameEl = document.getElementById('warehouseName');
    if (nameEl) nameEl.value = warehouse.name || '';
    
    const codeEl = document.getElementById('warehouseCode');
    if (codeEl) codeEl.value = warehouse.code || '';
    
    const addressEl = document.getElementById('warehouseAddress');
    if (addressEl) addressEl.value = warehouse.address || warehouse.shippingAddress || '';
    
    const managerEl = document.getElementById('warehouseManager');
    if (managerEl) managerEl.value = warehouse.manager || '';
    
    const phoneEl = document.getElementById('warehousePhone');
    if (phoneEl) phoneEl.value = warehouse.phone || '';
    
    const primaryEl = document.getElementById('warehouseIsPrimary');
    if (primaryEl) primaryEl.checked = warehouse.isPrimary || warehouse.type === 'primary';
    
    // Show modal
    const modal = document.getElementById('warehouseModal');
    if (modal) modal.style.display = 'flex';
}

function deleteWarehouse(id) {
    const warehouse = warehouses.find(w => w.id === id);
    if (!warehouse) return;
    
    if (warehouse.isPrimary || warehouse.type === 'primary') {
        if(typeof showNotification === 'function') {
            showNotification('âš ï¸ ØªØ­Ø°ÙŠØ±', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ', 'warning');
        }
        closeDropdown(id);
        return;
    }
    
    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ "${warehouse.name}"ØŸ`)) {
        warehouses = warehouses.filter(w => w.id !== id);
        branches = warehouses; // ØªØ²Ø§Ù…Ù†
        try { if(typeof saveToLocalStorage === 'function') saveToLocalStorage('branches', branches); } catch(e){ console.warn(e); }
        renderWarehouses();
        if(typeof showNotification === 'function') {
            showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
    }
    closeDropdown(id);
}

function showWarehouseOperations(id) {
    if(typeof showNotification === 'function') {
        showNotification('ğŸ“Š Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', 'Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ø§Ø­Ù‚Ø§Ù‹', 'info');
    }
    closeDropdown(id);
}

function showWarehouseValue(id) {
    if(typeof showNotification === 'function') {
        showNotification('ğŸ’° Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', 'Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ± Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ø§Ø­Ù‚Ø§Ù‹', 'info');
    }
    closeDropdown(id);
}

function showWarehouseInventory(id) {
    if(typeof showNotification === 'function') {
        showNotification('ğŸ“‹ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¬Ø±Ø¯', 'Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ÙˆØ±Ù‚Ø© Ø§Ù„Ø¬Ø±Ø¯ Ù„Ø§Ø­Ù‚Ø§Ù‹', 'info');
    }
    closeDropdown(id);
}

function closeDropdown(id) {
    const dropdown = document.getElementById(`dropdown-${id}`);
    if (dropdown) dropdown.style.display = 'none';
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', function(e) {
    if (!e.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    }
});

function toggleWarehouseActive(id) {
    const w = warehouses.find(w => w.id === id); if(!w) return;
    w.active = !w.active;
    branches = warehouses; // ØªØ²Ø§Ù…Ù†
    try { if(typeof saveToLocalStorage === 'function') saveToLocalStorage('branches', branches); } catch(e){ console.warn(e); }
    renderWarehouses();
}

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
try {
    if(typeof loadFromLocalStorage === 'function') {
        // Ø£ÙˆÙ„Ø§Ù‹: Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† branches (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)
        const storedBranches = loadFromLocalStorage('branches');
        if (storedBranches && Array.isArray(storedBranches)) {
            branches = storedBranches;
            warehouses = branches; // ØªØ²Ø§Ù…Ù†
        } else {
            // Ø«Ø§Ù†ÙŠØ§Ù‹: Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† warehouses (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
            const storedWh = loadFromLocalStorage('warehouses');
            if (storedWh && Array.isArray(storedWh)) {
                warehouses = storedWh;
                branches = warehouses;
                // Ø­ÙØ¸ Ø¹Ù„Ù‰ branches Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
                saveToLocalStorage('branches', branches);
            }
        }
    }
} catch(e){ console.warn('Error loading warehouses:', e); }

console.log('âœ… ØªÙ… ØªØ¹Ø±ÙŠÙ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ù…Ø¨ÙƒØ±Ø§Ù‹');

/**
 * Ø¯Ø§Ù„Ø© Ù„Ø±ÙØ¹ Ù…Ù„Ù Ø¥Ù„Ù‰ Firebase Storage
 * @param {File} file - Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±ÙØ¹Ù‡
 * @param {string} path - Ø§Ù„Ù…Ø³Ø§Ø± Ø¯Ø§Ø®Ù„ Storage (Ù…Ø«Ù„ 'purchases' Ø£Ùˆ 'expenses')
 * @returns {Promise<string|null>} - Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø£Ùˆ null Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„
 */
/**
 * Ø¯Ø§Ù„Ø© Ù„Ø±ÙØ¹ Ù…Ù„Ù Ø¥Ù„Ù‰ Cloudinary
 * @param {File} file - Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±ÙØ¹Ù‡
 * @param {string} path - (Ù„Ù… Ù†Ø¹Ø¯ Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ù‡Ù†Ø§ ÙˆÙ„ÙƒÙ† Ø³Ù†Ø¨Ù‚ÙŠÙ‡ Ù„Ù„ØªÙˆØ§ÙÙ‚)
 * @returns {Promise<string|null>} - Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø£Ùˆ null Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„
 */
async function uploadFile(file, path) {
    if (!file) return null;

    // --- â¬‡ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Cloudinary Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ â¬‡ï¸ ---
    const CLOUD_NAME = "dgjcr2bgq";
    const UPLOAD_PRESET = "diwani_uploads";
    // --- â¬†ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â¬†ï¸ ---

    const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… FormData Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', UPLOAD_PRESET);

    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù„Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø·
    if (currentActivityId) {
        formData.append('folder', `diwani_attachments/${currentActivityId}/${path}`);
    }

    try {
        showLoading(`Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚... ${file.name}`);

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Cloudinary
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok && data.secure_url) {
            // Ù†Ø¬Ø­ Ø§Ù„Ø±ÙØ¹!
            hideLoading();
            showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            return data.secure_url; // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¢Ù…Ù† Ù„Ù„Ù…Ù„Ù
        } else {
            // ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹
            throw new Error(data.error.message || 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹');
        }

    } catch (error) {
        hideLoading();
        logError('Cloudinary Upload', error);
        showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ' + error.message, 'error');
        return null;
    }
}

// ========================================
// ğŸ”¥ Firebase Integration - ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„
// ========================================
const USE_FIREBASE = true; // true = Firebase, false = LocalStorage ÙÙ‚Ø·

// Ø§Ø¬Ø¹Ù„ Ù‚ÙŠÙ…Ø© DEBUG_MODE Ù…ØªØ²Ø§Ù…Ù†Ø© Ù…Ø¹ window.DEBUG_MODE Ø§Ù„Ø°ÙŠ ØªÙ… ØªØ¹Ø±ÙŠÙÙ‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹
let DEBUG_MODE = typeof window.DEBUG_MODE === 'boolean' ? window.DEBUG_MODE : false;

function debugLog(...args) {
    if (window.DEBUG_MODE) {
        console.log(...args);
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ¨Ø¯ÙŠÙ„ DEBUG_MODE Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
function toggleDebugMode(enable = null) {
    const original = window.__ORIGINAL_CONSOLE__ || console;
    if (enable === null) {
        window.DEBUG_MODE = !window.DEBUG_MODE;
    } else {
        window.DEBUG_MODE = !!enable;
    }
    DEBUG_MODE = window.DEBUG_MODE; // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙŠ Ù…ØªØ²Ø§Ù…Ù†Ø§Ù‹
    // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø­ØªÙ‰ Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
    original.log(`ğŸ› DEBUG_MODE: ${window.DEBUG_MODE ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…Ø¹Ø·Ù‘Ù„'}`);
    return window.DEBUG_MODE;
}

// ÙƒØ´Ù Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
if (typeof window !== 'undefined') {
    // Ù„Ø§ ØªØ¹ÙŠØ¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù„Ù‰ window.DEBUG_MODE Ù‡Ù†Ø§ Ø­ØªÙ‰ Ù„Ø§ ØªÙØ³Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¨ÙƒØ±Ø©
    window.toggleDebugMode = toggleDebugMode;
}

// ========================================
// ğŸ”’ Ø¯ÙˆØ§Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± - ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù…Ø¨ÙƒØ±Ø§Ù‹
// ========================================
function openForgotPasswordModal() {
    console.log('ğŸ”“ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    const emailEl = document.getElementById('fp-email');
    if (emailEl) emailEl.value = '';
    const overlay = document.getElementById('forgot-password-overlay');
    if (overlay) {
        overlay.style.display = 'flex';
    } else {
        console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    }
}

function closeForgotPasswordModal() {
    console.log('ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    const overlay = document.getElementById('forgot-password-overlay');
    if (overlay) overlay.style.display = 'none';
}

function requestPasswordReset() {
    console.log('ğŸ“§ Ø·Ù„Ø¨ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    const email = document.getElementById('fp-email').value.trim();
    if (!email) { 
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.'); 
        return; 
    }
    
    console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯:', email);
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† localStorage
    let tempUsers = [];
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
    try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© 1: Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ diwan_users
        const storedUsers1 = localStorage.getItem('diwan_users');
        if (storedUsers1) {
            tempUsers = JSON.parse(storedUsers1);
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${tempUsers.length} Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† diwan_users`);
        }
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© 2: Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨Ø¯ÙŠÙ„ users (Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ ÙÙŠ diwan_users)
        if (tempUsers.length === 0) {
            const storedUsers2 = localStorage.getItem('users');
            if (storedUsers2) {
                tempUsers = JSON.parse(storedUsers2);
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${tempUsers.length} Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† users`);
            }
        }
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© 3: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØºÙŠØ± users Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
        if (tempUsers.length === 0 && typeof users !== 'undefined' && Array.isArray(users)) {
            tempUsers = users;
            console.log(`âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØºÙŠØ± users Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ: ${tempUsers.length} Ù…Ø³ØªØ®Ø¯Ù…`);
        }
        
        if (tempUsers.length === 0) {
            console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù….');
            return;
        }
        
        console.log('ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†:', tempUsers.map(u => u.email));
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const user = tempUsers.find(u => u.email && u.email.toLowerCase() === email.toLowerCase());
        
        if (!user) { 
            console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯:', email);
            alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'); 
            return; 
        }
        
        console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', user.name);
        
        // âœ¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø³Ø¤Ø§Ù„ Ø£Ù…Ø§Ù†
        if (!user.securityQuestion || !user.securityAnswer) {
            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù… ÙŠØ­Ø¯Ø¯ Ø³Ø¤Ø§Ù„ Ø£Ù…Ø§Ù† Ø¨Ø¹Ø¯
            createCustomAlertDialog({
                title: 'ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ø§Ù†',
                icon: 'âš ï¸',
                content: `
                    <div style="padding: 20px 0; text-align: right;">
                        <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-right: 3px solid #ffc107;">
                            <p style="margin: 8px 0; color: #856404; font-size: 15px;"><strong>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:</strong> ${user.name}</p>
                            <p style="margin: 8px 0; color: #856404; font-size: 15px;"><strong>ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> ${email}</p>
                        </div>
                        <p style="font-size: 15px; color: #34495e; line-height: 1.6; margin: 15px 0;">
                            âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ø³Ø¤Ø§Ù„ Ø£Ù…Ø§Ù† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨.
                        </p>
                        <p style="font-size: 14px; color: #7f8c8d; line-height: 1.5; margin: 10px 0;">
                            ğŸ“ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£Ùˆ ØªÙØ¹ÙŠÙ„ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†.
                        </p>
                    </div>
                `,
                buttonText: 'Ø­Ø³Ù†Ø§Ù‹',
                onClose: () => {
                    closeForgotPasswordModal();
                }
            });
            return;
        }
        
        // Ø¹Ø±Ø¶ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† Ù„Ù„ØªØ­Ù‚Ù‚
        createSecurityQuestionDialog({
            user: user,
            tempUsers: tempUsers,
            email: email
        });
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.');
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†
function createSecurityQuestionDialog({ user, tempUsers, email }) {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 10100; backdrop-filter: blur(4px);';
    
    const dialog = document.createElement('div');
    dialog.style.cssText = 'background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 90%; max-width: 500px; animation: fadeIn 0.3s ease;';
    
    dialog.innerHTML = `
        <div style="padding: 25px 30px; border-bottom: 1px solid #ecf0f1;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 32px;">ğŸ”</span>
                <h3 style="margin: 0; color: var(--primary-color); font-size: 1.4em;">Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†</h3>
            </div>
        </div>
        <div style="padding: 25px 30px;">
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-right: 3px solid var(--primary-color);">
                <p style="margin: 8px 0; color: #2c3e50; font-size: 15px;"><strong>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:</strong> ${user.name}</p>
                <p style="margin: 8px 0; color: #2c3e50; font-size: 15px;"><strong>ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> ${email}</p>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #34495e; font-size: 15px;">
                    â“ ${user.securityQuestion}
                </label>
                <input type="text" id="securityAnswerInput" placeholder="Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ø§Ø¨Ø© Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†" 
                       style="width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; font-family: var(--font-family);">
            </div>
            <p id="securityError" style="color: #e74c3c; font-size: 14px; margin: 10px 0; display: none;"></p>
            <p style="font-size: 13px; color: #7f8c8d; line-height: 1.5; margin: 15px 0;">
                ğŸ’¡ <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø­Ø³Ø§Ø³Ø© Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù (ÙƒØ¨ÙŠØ±Ø©/ØµØºÙŠØ±Ø©)
            </p>
        </div>
        <div style="padding: 20px 30px; border-top: 1px solid #ecf0f1; display: flex; gap: 10px; justify-content: flex-end;">
            <button id="securityCancelBtn" style="padding: 12px 30px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 15px; cursor: pointer; transition: all 0.3s;">
                Ø¥Ù„ØºØ§Ø¡
            </button>
            <button id="securityVerifyBtn" style="padding: 12px 30px; border: none; background: var(--primary-color); color: white; border-radius: 8px; font-size: 15px; cursor: pointer; transition: all 0.3s; font-weight: 600;">
                Ø§Ù„ØªØ­Ù‚Ù‚
            </button>
        </div>
    `;
    
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    const answerInput = dialog.querySelector('#securityAnswerInput');
    const errorMsg = dialog.querySelector('#securityError');
    const verifyBtn = dialog.querySelector('#securityVerifyBtn');
    const cancelBtn = dialog.querySelector('#securityCancelBtn');
    
    // Focus Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    setTimeout(() => answerInput.focus(), 100);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
    verifyBtn.addEventListener('click', () => {
        const answer = answerInput.value.trim();
        
        if (!answer) {
            errorMsg.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø© Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†';
            errorMsg.style.display = 'block';
            answerInput.style.borderColor = '#e74c3c';
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø­Ø³Ø§Ø³ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù)
        if (answer === user.securityAnswer) {
            // Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© âœ…
            document.body.removeChild(overlay);
            closeForgotPasswordModal();
            openAdminPasswordReset(user, tempUsers);
        } else {
            // Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© âŒ
            errorMsg.textContent = 'âŒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
            errorMsg.style.display = 'block';
            answerInput.style.borderColor = '#e74c3c';
            answerInput.value = '';
            answerInput.focus();
        }
    });
    
    // Ø§Ù„Ø¥Ù„ØºØ§Ø¡
    cancelBtn.addEventListener('click', () => {
        document.body.removeChild(overlay);
        closeForgotPasswordModal();
    });
    
    // Enter Ù„Ù„ØªØ­Ù‚Ù‚
    answerInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            verifyBtn.click();
        }
    });
    
    // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
    answerInput.addEventListener('input', () => {
        errorMsg.style.display = 'none';
        answerInput.style.borderColor = '#ddd';
    });
    
    // Hover effects
    verifyBtn.addEventListener('mouseenter', () => {
        verifyBtn.style.transform = 'translateY(-2px)';
        verifyBtn.style.boxShadow = '0 4px 12px rgba(44, 90, 160, 0.3)';
    });
    verifyBtn.addEventListener('mouseleave', () => {
        verifyBtn.style.transform = 'translateY(0)';
        verifyBtn.style.boxShadow = 'none';
    });
    
    cancelBtn.addEventListener('mouseenter', () => {
        cancelBtn.style.background = '#f8f9fa';
    });
    cancelBtn.addEventListener('mouseleave', () => {
        cancelBtn.style.background = 'white';
    });
}

// Ø¯Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±
function openAdminPasswordReset(adminUser, usersArray) {
    console.log('ğŸ” ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±');
    
    const overlay = document.getElementById('reset-password-overlay');
    if (!overlay) {
        console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†');
        return;
    }
    
    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¤Ù‚ØªØ§Ù‹
    window.tempAdminReset = { user: adminUser, users: usersArray };
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
    const newPass = document.getElementById('rp-new');
    const confirmPass = document.getElementById('rp-confirm');
    if (newPass) newPass.value = '';
    if (confirmPass) confirmPass.value = '';
    
    overlay.style.display = 'flex';
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø¯ÙŠØ±
function submitTokenPasswordReset() {
    console.log('ğŸ’¾ Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø¯ÙŠØ±');
    
    if (!window.tempAdminReset) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        closeResetPasswordModal();
        return;
    }
    
    const newPass = document.getElementById('rp-new').value;
    const confirmPass = document.getElementById('rp-confirm').value;
    
    if (!newPass || !confirmPass) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§.');
        return;
    }
    
    if (newPass.length < 6) {
        alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
        return;
    }
    
    if (newPass !== confirmPass) {
        alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ†.');
        return;
    }
    
    try {
        const { user, users: tempUsers } = window.tempAdminReset;
        
        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        const userIndex = tempUsers.findIndex(u => u.id === user.id);
        if (userIndex === -1) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
            return;
        }
        
        tempUsers[userIndex].password = newPass;
        
        // Ø­ÙØ¸ ÙÙŠ localStorage
        localStorage.setItem('diwan_users', JSON.stringify(tempUsers));
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        if (typeof users !== 'undefined' && Array.isArray(users)) {
            users = tempUsers;
        }
        
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        delete window.tempAdminReset;
        
        closeResetPasswordModal();
        
        alert(`âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ‘¤ ${user.name}\nğŸ“§ ${user.email}\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.`);
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
}

function openResetPasswordModal(token) {
    // ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠØŒ Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
    console.log('âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø·');
    alert('Ù…ÙŠØ²Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ.\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.');
}

function closeResetPasswordModal() {
    const overlay = document.getElementById('reset-password-overlay');
    if (overlay) overlay.style.display = 'none';
}

// ÙƒØ´Ù Ø¯ÙˆØ§Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
if (typeof window !== 'undefined') {
    window.openForgotPasswordModal = openForgotPasswordModal;
    window.closeForgotPasswordModal = closeForgotPasswordModal;
    window.requestPasswordReset = requestPasswordReset;
    window.openResetPasswordModal = openResetPasswordModal;
    window.closeResetPasswordModal = closeResetPasswordModal;
    window.openAdminPasswordReset = openAdminPasswordReset;
    window.submitTokenPasswordReset = submitTokenPasswordReset;
}

// ==========================================
// Ø¯ÙˆØ§Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
// ==========================================

// Ø¯Ø§Ù„Ø© Ù„ØªØ¬Ù‡ÙŠØ² Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹)
function formatPhoneNumberForWhatsApp(phone) {
    if (!phone) return null;

    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø³Ø§ÙØ§Øª Ø£Ùˆ Ø´Ø±Ø·Ø§Øª Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø© +
    let cleaned = phone.replace(/[\s\-+]/g, '');

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 (Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ)
    if (cleaned.startsWith('05')) {
        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ØµÙØ± Ø§Ù„Ø£ÙˆÙ„ Ø¨Ù€ 966
        return '966' + cleaned.substring(1);
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 5 Ù…Ø¨Ø§Ø´Ø±Ø©
    if (cleaned.length === 9 && cleaned.startsWith('5')) {
        return '966' + cleaned;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ù…ÙƒØªÙˆØ¨Ø§Ù‹ Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¯ÙˆÙ„ÙŠ Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ø§Ù„ÙØ¹Ù„
    if (cleaned.startsWith('966')) {
        return cleaned;
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙŠØºØ©ØŒ Ø£Ø±Ø¬Ø¹ Ø§Ù„Ø±Ù‚Ù… ÙƒÙ…Ø§ Ù‡Ùˆ (Ù‚Ø¯ ÙŠØ¹Ù…Ù„)
    return cleaned;
}

// Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
function sendWhatsAppInvoice(saleId) {
    const sale = typeof sales !== 'undefined' ? sales.find(s => s.id === saleId) : null;
    if (!sale) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©!');
        return;
    }

    const customer = typeof customers !== 'undefined' ? customers.find(c => c.id === sale.customerId) : null;
    if (!customer || !customer.phone) {
        alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.');
        return;
    }

    const formattedPhone = formatPhoneNumberForWhatsApp(customer.phone);
    if (!formattedPhone) {
        alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­.');
        return;
    }

    // --- ØªØ¬Ù‡ÙŠØ² Ù†Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© ---
    const activityList = (typeof activities !== 'undefined' && Array.isArray(activities)) ? activities : [];
    const activity = activityList.find(a => a.id == currentActivityId);
    const activityName = activity && activity.name ? activity.name : 'Ù†Ø´Ø§Ø·Ùƒ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ';
    let message = `*ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª - ${activityName}*\n\n`;
    message += `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${customer.name},\n`;
    message += `Ø¥Ù„ÙŠÙƒ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…: *SAL${sale.number.toString().padStart(3, '0')}*\n`;
    message += `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${sale.date}\n\n`;

    message += "*Ø§Ù„Ø£ØµÙ†Ø§Ù:*\n";
    sale.items.forEach(item => {
        message += `- ${item.name} (Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.quantity}, Ø§Ù„Ø³Ø¹Ø±: ${item.price.toFixed(2)}) = *${item.total.toFixed(2)}*\n`;
    });

    message += `\n*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${sale.total.toFixed(2)} Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ*\n`;
    message += `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${sale.paidAmount.toFixed(2)}\n`;
    message += `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${sale.remainingAmount.toFixed(2)}\n\n`;
    message += `Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§.`;
    // --- Ù†Ù‡Ø§ÙŠØ© Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ---

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ù„ÙŠÙƒÙˆÙ† Ù…ØªÙˆØ§ÙÙ‚Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø·
    const encodedMessage = encodeURIComponent(message);

    // Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙØªØ­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
    const whatsappUrl = `https://api.whatsapp.com/send?phone=${formattedPhone}&text=${encodedMessage}`;

    // ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
    window.open(whatsappUrl, '_blank');
}

// ÙƒØ´Ù Ø¯ÙˆØ§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
if (typeof window !== 'undefined') {
    window.formatPhoneNumberForWhatsApp = formatPhoneNumberForWhatsApp;
    window.sendWhatsAppInvoice = sendWhatsAppInvoice;
}

// ==========================================
// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
// ==========================================

function emailSaleInvoice(saleId) {
    if (!emailJsConfig.serviceID || !emailJsConfig.templateID || !emailJsConfig.publicKey) {
        showNotification('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªÙƒÙˆÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.', 'warning');
        return;
    }

    const sale = typeof sales !== 'undefined' ? sales.find(s => s.id === saleId) : null;
    if (!sale) return;

    const customer = typeof customers !== 'undefined' ? customers.find(c => c.id === sale.customerId) : null;
    if (!customer || !customer.email) {
        showNotification('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.', 'error');
        return;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
    const activityList = (typeof activities !== 'undefined' && Array.isArray(activities)) ? activities : [];
    const currentActivity = activityList.find(a => a.id == currentActivityId);
    const activityName = currentActivity ? currentActivity.name : 'Ø¨Ø³Ù…Ø© Ø¨ÙˆØªÙŠÙƒ';

    // Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
    let emailContent = `
        <div style="font-family: Arial, sans-serif; direction: rtl; text-align: right;">
            <h2 style="color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 10px;">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
            
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
            <div style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> SAL${sale.number.toString().padStart(3, '0')}</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${sale.date}</p>
                <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${customer.name}</p>
                <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${sale.notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}</p>
            </div>

            <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù -->
            <h3 style="color: #34495e;">Ø£ØµÙ†Ø§Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</h3>
            <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                <tr style="background-color: #2c5aa0; color: white;">
                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„ØµÙ†Ù</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                </tr>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù
    sale.items.forEach(item => {
        emailContent += `
            <tr>
                <td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.quantity}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: left;">${item.price.toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: left;">${item.total.toFixed(2)}</td>
            </tr>
        `;
    });

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
    emailContent += `
            </table>
            
            <div style="margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: left; max-width: 350px; margin-left: 0; margin-right: auto;">
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span> <strong>${sale.subtotal.toFixed(2)}</strong></p>
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span> <strong>${sale.tax.toFixed(2)}</strong></p>
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span> <strong>${(sale.paidAmount || 0).toFixed(2)}</strong></p>
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span> <strong>${(sale.remainingAmount ?? sale.total).toFixed(2)}</strong></p>
                <h3 style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #2c5aa0; color: #2c5aa0; display: flex; justify-content: space-between;"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span> <strong>${sale.total.toFixed(2)}</strong></h3>
            </div>

            <!-- Ø§Ù„ØªØ­ÙŠØ© -->
            <div style="margin-top: 30px; text-align: center; font-style: italic; border-top: 1px solid #ddd; padding-top: 15px;">
                <p>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹ ${activityName}</p>
            </div>
        </div>
    `;

    const templateParams = {
        to_name: customer.name,
        to_email: customer.email,
        from_name: activityName,
        invoice_number: `SAL${sale.number.toString().padStart(3, '0')}`,
        invoice_details: emailContent,
        email_subject: `ÙØ§ØªÙˆØ±Ø© ${activityName} - SAL${sale.number.toString().padStart(3, '0')}`
    };

    emailjs.send(emailJsConfig.serviceID, emailJsConfig.templateID, templateParams, emailJsConfig.publicKey)
        .then(function(response) {
           showNotification('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }, function(error) {
           showNotification('âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + error.text, 'error');
        });
}

// ÙƒØ´Ù Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù„Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
if (typeof window !== 'undefined') {
    window.emailSaleInvoice = emailSaleInvoice;
}

// ========================================
// ğŸ¨ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­ÙˆØ§Ø±Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
// ========================================
function createCustomConfirmDialog({ title, icon, content, confirmText, cancelText, onConfirm }) {
    // Ø¥Ù†Ø´Ø§Ø¡ overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 10100; backdrop-filter: blur(4px);';
    
    // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø­ÙˆØ§Ø±
    const dialog = document.createElement('div');
    dialog.style.cssText = 'background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 90%; max-width: 450px; animation: fadeIn 0.3s ease;';
    
    dialog.innerHTML = `
        <div style="padding: 25px 30px; border-bottom: 1px solid #ecf0f1;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 32px;">${icon}</span>
                <h3 style="margin: 0; color: var(--primary-color); font-size: 1.4em;">${title}</h3>
            </div>
        </div>
        <div style="padding: 25px 30px;">
            ${content}
        </div>
        <div style="padding: 20px 30px; border-top: 1px solid #ecf0f1; display: flex; gap: 10px; justify-content: flex-end;">
            <button id="customCancelBtn" style="padding: 12px 30px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 15px; cursor: pointer; transition: all 0.3s;">
                ${cancelText}
            </button>
            <button id="customConfirmBtn" style="padding: 12px 30px; border: none; background: var(--primary-color); color: white; border-radius: 8px; font-size: 15px; cursor: pointer; transition: all 0.3s; font-weight: 600;">
                ${confirmText}
            </button>
        </div>
    `;
    
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    // Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    const confirmBtn = dialog.querySelector('#customConfirmBtn');
    const cancelBtn = dialog.querySelector('#customCancelBtn');
    
    confirmBtn.addEventListener('click', () => {
        document.body.removeChild(overlay);
        if (onConfirm) onConfirm();
    });
    
    cancelBtn.addEventListener('click', () => {
        document.body.removeChild(overlay);
    });
    
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            document.body.removeChild(overlay);
        }
    });
    
    // Hover effects
    confirmBtn.addEventListener('mouseenter', () => {
        confirmBtn.style.transform = 'translateY(-2px)';
        confirmBtn.style.boxShadow = '0 4px 12px rgba(44, 90, 160, 0.3)';
    });
    confirmBtn.addEventListener('mouseleave', () => {
        confirmBtn.style.transform = 'translateY(0)';
        confirmBtn.style.boxShadow = 'none';
    });
    
    cancelBtn.addEventListener('mouseenter', () => {
        cancelBtn.style.background = '#f8f9fa';
        cancelBtn.style.borderColor = '#bbb';
    });
    cancelBtn.addEventListener('mouseleave', () => {
        cancelBtn.style.background = 'white';
        cancelBtn.style.borderColor = '#ddd';
    });
}

function createCustomAlertDialog({ title, icon, content, buttonText, onClose }) {
    // Ø¥Ù†Ø´Ø§Ø¡ overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 10100; backdrop-filter: blur(4px);';
    
    // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø­ÙˆØ§Ø±
    const dialog = document.createElement('div');
    dialog.style.cssText = 'background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 90%; max-width: 450px; animation: fadeIn 0.3s ease;';
    
    dialog.innerHTML = `
        <div style="padding: 25px 30px; border-bottom: 1px solid #ecf0f1;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 32px;">${icon}</span>
                <h3 style="margin: 0; color: var(--primary-color); font-size: 1.4em;">${title}</h3>
            </div>
        </div>
        <div style="padding: 25px 30px;">
            ${content}
        </div>
        <div style="padding: 20px 30px; border-top: 1px solid #ecf0f1; display: flex; justify-content: center;">
            <button id="customOkBtn" style="padding: 12px 40px; border: none; background: var(--primary-color); color: white; border-radius: 8px; font-size: 15px; cursor: pointer; transition: all 0.3s; font-weight: 600;">
                ${buttonText}
            </button>
        </div>
    `;
    
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    // Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    const okBtn = dialog.querySelector('#customOkBtn');
    
    okBtn.addEventListener('click', () => {
        document.body.removeChild(overlay);
        if (onClose) onClose();
    });
    
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            document.body.removeChild(overlay);
            if (onClose) onClose();
        }
    });
    
    // Hover effect
    okBtn.addEventListener('mouseenter', () => {
        okBtn.style.transform = 'translateY(-2px)';
        okBtn.style.boxShadow = '0 4px 12px rgba(44, 90, 160, 0.3)';
    });
    okBtn.addEventListener('mouseleave', () => {
        okBtn.style.transform = 'translateY(0)';
        okBtn.style.boxShadow = 'none';
    });
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
function systemStatus() {
    console.log('ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©:');
    console.log(`ğŸ”¥ Firebase: ${USE_FIREBASE ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…Ø¹Ø·Ù‘Ù„'}`);
    console.log(`ğŸ› Debug Mode: ${DEBUG_MODE ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…Ø¹Ø·Ù‘Ù„'}`);
    console.log(`ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: ${window.currentUser ? window.currentUser.name : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}`);
    console.log(`ğŸ¢ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentActivityId ? currentActivityId : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`);
    console.log('ğŸ”§ Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Debug Mode: toggleDebugMode()');
    return {
        firebase: USE_FIREBASE,
        debugMode: DEBUG_MODE,
        currentUser: window.currentUser,
        currentActivityId: currentActivityId
    };
}

// ÙƒØ´Ù Ø¯Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
if (typeof window !== 'undefined') {
    window.systemStatus = systemStatus;
}

// ========================================
// ğŸ”¥ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
// ========================================
let activities = [];
// currentActivityId already defined early in script
let items = [], customers = [], suppliers = [], purchases = [], sales = [], expenses = [], revenues = [], salaries = [], assets = [];
let branches = []; // ğŸ¢ Ø§Ù„ÙØ±ÙˆØ¹/Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª - Ø¬Ø¯ÙŠØ¯
var warehouses = []; // ğŸ­ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª - Ù…ØªØ²Ø§Ù…Ù† Ù…Ø¹ branches
let advances = [];
let employees = []; // ğŸ‘¨â€ğŸ’¼ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ø¬Ø¯ÙŠØ¯
let currentContractFile = null; // ğŸ“„ Ù…Ù„Ù Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø¤Ù‚Øª

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù…Ù„Ù Ø§Ù„Ø¹Ù‚Ø¯
function viewContractFile() {
    if (currentContractFile) {
        const win = window.open();
        win.document.write('<iframe src="' + currentContractFile + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
    } else {
        showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ø¹Ù‚Ø¯ Ù„Ù„Ø¹Ø±Ø¶', 'warning');
    }
}
let salesReturns = [], purchaseReturns = [];
let salePayments = [], purchasePayments = []; // ğŸ’° Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª - Ø¬Ø¯ÙŠØ¯
let journalEntries = []; // ğŸ“’ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© - Ø¬Ø¯ÙŠØ¯
let inventoryAdjustments = []; // ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ - Ø¬Ø¯ÙŠØ¯
let chartOfAccounts = []; // ğŸ—‚ï¸ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª - Ø¬Ø¯ÙŠØ¯
let permissions = []; // ğŸ“‹ Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ© - Ø¬Ø¯ÙŠØ¯
let currentPurchaseItems = [], currentSaleItems = [];
let editingPurchaseId = null, editingSaleId = null, editingSalaryId = null;
let currentPurchaseNumber = 1, currentSaleNumber = 1;
let currentSaleReturnNumber = 1, currentPurchaseReturnNumber = 1;
let activeSaleReturn = null, activePurchaseReturn = null;
let users = [];
let editingWarehouse = null; // ğŸ­ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª - Ø¬Ø¯ÙŠØ¯
const GOSI_RATE = 0.09;
const GOSI_SALARY_CAP = 45000;

// ========================================
// ğŸ“Š Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Chart of Accounts)
// ========================================
const DEFAULT_CHART_OF_ACCOUNTS = [
    // 1 - Ø§Ù„Ø£ØµÙˆÙ„ (Assets)
    { code: "1", name: "Ø§Ù„Ø£ØµÙˆÙ„", nameEn: "Assets", type: "header", parent: null, balance: 0, debit: 0, credit: 0 },
    
    // 11 - Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©
    { code: "11", name: "Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©", nameEn: "Current Assets", type: "header", parent: "1", balance: 0, debit: 0, credit: 0 },
    
    // 111 - Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
    { code: "111", name: "Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚", nameEn: "Cash Box", type: "header", parent: "11", balance: 0, debit: 0, credit: 0 },
    { code: "1111", name: "ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ", nameEn: "Main Branch Box", type: "account", parent: "111", balance: 0, debit: 0, credit: 0, category: "asset" },
    
    // 112 - Ø§Ù„Ø¨Ù†Ùƒ
    { code: "112", name: "Ø§Ù„Ø¨Ù†Ùƒ", nameEn: "Bank", type: "header", parent: "11", balance: 0, debit: 0, credit: 0 },
    { code: "1121", name: "Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ", nameEn: "NCB Bank", type: "account", parent: "112", balance: 0, debit: 0, credit: 0, category: "asset" },
    
    // 113 - Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    { code: "113", name: "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡", nameEn: "Customers", type: "header", parent: "11", balance: 0, debit: 0, credit: 0 },
    { code: "1131", name: "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø¹Ø§Ù…)", nameEn: "General Customers", type: "account", parent: "113", balance: 0, debit: 0, credit: 0, category: "asset" },
    
    // 114 - Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    { code: "114", name: "Ø§Ù„Ù…Ø®Ø²ÙˆÙ†", nameEn: "Inventory", type: "header", parent: "11", balance: 0, debit: 0, credit: 0 },
    { code: "1141", name: "Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹", nameEn: "Merchandise Inventory", type: "account", parent: "114", balance: 0, debit: 0, credit: 0, category: "asset" },
    
    // 115 - Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù
    { code: "115", name: "Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù", nameEn: "Advances", type: "header", parent: "11", balance: 0, debit: 0, credit: 0 },
    { code: "1151", name: "Ø¹Ù‡Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†", nameEn: "Employee Advances", type: "account", parent: "115", balance: 0, debit: 0, credit: 0, category: "asset" },

    // 12 - Ø§Ù„Ø£ØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©
    { code: "12", name: "Ø§Ù„Ø£ØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©", nameEn: "Non-Current Assets", type: "header", parent: "1", balance: 0, debit: 0, credit: 0 },
    
    // 121 - Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ©
    { code: "121", name: "Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ©", nameEn: "Fixed Assets", type: "header", parent: "12", balance: 0, debit: 0, credit: 0 },
    { code: "1211", name: "Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ", nameEn: "Buildings", type: "account", parent: "121", balance: 0, debit: 0, credit: 0, category: "asset" },
    { code: "1212", name: "Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª", nameEn: "Vehicles", type: "account", parent: "121", balance: 0, debit: 0, credit: 0, category: "asset" },
    { code: "1213", name: "Ø§Ù„Ø£Ø«Ø§Ø« ÙˆØ§Ù„Ù…Ø¹Ø¯Ø§Øª", nameEn: "Furniture & Equipment", type: "account", parent: "121", balance: 0, debit: 0, credit: 0, category: "asset" },
    
    // 2 - Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Liabilities)
    { code: "2", name: "Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª", nameEn: "Liabilities", type: "header", parent: null, balance: 0, debit: 0, credit: 0 },
    
    // 21 - Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©
    { code: "21", name: "Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©", nameEn: "Current Liabilities", type: "header", parent: "2", balance: 0, debit: 0, credit: 0 },
    
    // 211 - Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
    { code: "211", name: "Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†", nameEn: "Suppliers", type: "header", parent: "21", balance: 0, debit: 0, credit: 0 },
    { code: "2111", name: "Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Ø¹Ø§Ù…)", nameEn: "General Suppliers", type: "account", parent: "211", balance: 0, debit: 0, credit: 0, category: "liability" },
    
    // 212 - Ù…ØµØ§Ø±ÙŠÙ Ù…Ø³ØªØ­Ù‚Ø©
    { code: "212", name: "Ù…ØµØ§Ø±ÙŠÙ Ù…Ø³ØªØ­Ù‚Ø©", nameEn: "Accrued Expenses", type: "header", parent: "21", balance: 0, debit: 0, credit: 0 },
    { code: "2121", name: "Ø±ÙˆØ§ØªØ¨ Ù…Ø³ØªØ­Ù‚Ø©", nameEn: "Salaries Payable", type: "account", parent: "212", balance: 0, debit: 0, credit: 0, category: "liability" },
    { code: "2122", name: "Ø¶Ø±Ø§Ø¦Ø¨ Ù…Ø³ØªØ­Ù‚Ø©", nameEn: "Taxes Payable", type: "account", parent: "212", balance: 0, debit: 0, credit: 0, category: "liability" },
    
    // 22 - Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©
    { code: "22", name: "Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©", nameEn: "Non-Current Liabilities", type: "header", parent: "2", balance: 0, debit: 0, credit: 0 },
    { code: "221", name: "Ø§Ù„Ù‚Ø±ÙˆØ¶", nameEn: "Loans", type: "header", parent: "22", balance: 0, debit: 0, credit: 0 },
    { code: "2211", name: "Ù‚Ø±ÙˆØ¶ Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ø£Ø¬Ù„", nameEn: "Long-term Loans", type: "account", parent: "221", balance: 0, debit: 0, credit: 0, category: "liability" },
    
    // 3 - Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (Equity)
    { code: "3", name: "Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©", nameEn: "Equity", type: "header", parent: null, balance: 0, debit: 0, credit: 0 },
    
    // 31 - Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„
    { code: "31", name: "Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„", nameEn: "Capital", type: "header", parent: "3", balance: 0, debit: 0, credit: 0 },
    { code: "3111", name: "Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹", nameEn: "Paid-in Capital", type: "account", parent: "31", balance: 0, debit: 0, credit: 0, category: "equity" },
    { code: "3112", name: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø§Ù„Ùƒ", nameEn: "Owner's Draw", type: "account", parent: "31", balance: 0, debit: 0, credit: 0, category: "equity" },
    { code: "3113", name: "Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø¨Ù‚Ø§Ø©", nameEn: "Retained Earnings", type: "account", parent: "31", balance: 0, debit: 0, credit: 0, category: "equity" },
    
    // 4 - Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Revenues)
    { code: "4", name: "Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª", nameEn: "Revenues", type: "header", parent: null, balance: 0, debit: 0, credit: 0 },
    
    // 41 - Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
    { code: "41", name: "Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", nameEn: "Sales Revenues", type: "header", parent: "4", balance: 0, debit: 0, credit: 0 },
    { code: "4111", name: "Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", nameEn: "Sales", type: "account", parent: "41", balance: 0, debit: 0, credit: 0, category: "revenue" },
    { code: "4112", name: "Ù…Ø±Ø¯ÙˆØ¯Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", nameEn: "Sales Returns", type: "account", parent: "41", balance: 0, debit: 0, credit: 0, category: "revenue" },
    { code: "4113", name: "Ø®ØµÙ… Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡", nameEn: "Sales Discount", type: "account", parent: "41", balance: 0, debit: 0, credit: 0, category: "revenue" },
    
    // 42 - Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰
    { code: "42", name: "Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰", nameEn: "Other Revenues", type: "header", parent: "4", balance: 0, debit: 0, credit: 0 },
    { code: "4211", name: "Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø®Ø¯Ù…Ø§Øª", nameEn: "Service Revenue", type: "account", parent: "42", balance: 0, debit: 0, credit: 0, category: "revenue" },
    { code: "4212", name: "Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø©", nameEn: "Miscellaneous Revenue", type: "account", parent: "42", balance: 0, debit: 0, credit: 0, category: "revenue" },
    
    // 5 - Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Expenses)
    { code: "5", name: "Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª", nameEn: "Expenses", type: "header", parent: null, balance: 0, debit: 0, credit: 0 },
    
    // 51 - Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©
    { code: "51", name: "Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©", nameEn: "Operating Expenses", type: "header", parent: "5", balance: 0, debit: 0, credit: 0 },
    { code: "5111", name: "Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ø£Ø¬ÙˆØ±", nameEn: "Salaries & Wages", type: "account", parent: "51", balance: 0, debit: 0, credit: 0, category: "expense" },
    { code: "5112", name: "Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±", nameEn: "Rent", type: "account", parent: "51", balance: 0, debit: 0, credit: 0, category: "expense" },
    { code: "5113", name: "Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØ§Ù„Ù…Ø§Ø¡", nameEn: "Utilities", type: "account", parent: "51", balance: 0, debit: 0, credit: 0, category: "expense" },
    { code: "5114", name: "Ø§Ù„ØµÙŠØ§Ù†Ø©", nameEn: "Maintenance", type: "account", parent: "51", balance: 0, debit: 0, credit: 0, category: "expense" },
    { code: "5115", name: "Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚", nameEn: "Marketing Expenses", type: "account", parent: "51", balance: 0, debit: 0, credit: 0, category: "expense" },
    { code: "5116", name: "Ù…ØµØ±ÙˆÙØ§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©", nameEn: "Administrative Expenses", type: "account", parent: "51", balance: 0, debit: 0, credit: 0, category: "expense" },
    
    // 52 - ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
    { code: "52", name: "ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª", nameEn: "Purchase Costs", type: "header", parent: "5", balance: 0, debit: 0, credit: 0 },
    { code: "5211", name: "Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª", nameEn: "Purchases", type: "account", parent: "52", balance: 0, debit: 0, credit: 0, category: "expense" },
    { code: "5212", name: "Ù…Ø±Ø¯ÙˆØ¯Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª", nameEn: "Purchase Returns", type: "account", parent: "52", balance: 0, debit: 0, credit: 0, category: "expense" }
];

// ========================================
// ğŸ“’ Ø¯ÙˆØ§Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©
// ========================================

// ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø±Ù‚Ù…ÙŠØ§Ù‹ ÙˆØ¥Ø¶Ø§ÙØ© Ù…Ø³Ø§ÙØ© Ø¨Ø§Ø¯Ø¦Ø© Ø­Ø³Ø¨ Ø¹Ù…Ù‚Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¯Ù„ÙŠÙ„
function buildAccountsSortedWithDepth() {
    const map = new Map(chartOfAccounts.map(a => [a.code, a]));
    return chartOfAccounts
        .filter(a => a.type === 'account')
        .map(a => {
            let depth = 0;
            let p = a.parent;
            while (p) {
                const parent = map.get(p);
                if (!parent) break;
                depth++;
                p = parent.parent;
            }
            return { ...a, _depth: depth };
        })
        .sort((a, b) => parseInt(a.code) - parseInt(b.code));
}

function renderAccountOptions(selectEl) {
    const accounts = buildAccountsSortedWithDepth();
    selectEl.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨ *</option>';
    accounts.forEach(acc => {
        const indent = 'â€” '.repeat(Math.max(0, acc._depth));
        const opt = document.createElement('option');
        opt.value = acc.code;
        opt.textContent = `${indent}${acc.code} - ${acc.name}`;
        selectEl.appendChild(opt);
    });
}

let journalRowIndex = 1;

/**
 * ØªÙ‡ÙŠØ¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ù‚ÙŠÙˆØ¯
 */
function initializeAccountSelects() {
    const selects = document.querySelectorAll('.account-select');
    selects.forEach(select => renderAccountOptions(select));
}

/**
 * Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù‚ÙŠØ¯
 */
function addJournalRow() {
    const container = document.getElementById('journalEntryRows');
    const newRow = document.createElement('div');
    newRow.className = 'journal-entry-row';
    newRow.style.display = 'contents';
    newRow.dataset.index = journalRowIndex;
    
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø±Ù‚Ù…ÙŠØ§Ù‹ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§ÙØ© Ø¨Ø§Ø¯Ø¦Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ù‚
    const sortedAccounts = buildAccountsSortedWithDepth();
    
    newRow.innerHTML = `
        <select class="account-select" data-index="${journalRowIndex}">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨ *</option>
            ${sortedAccounts.map(a => {
                const indent = 'â€” '.repeat(Math.max(0, a._depth));
                return `<option value="${a.code}">${indent}${a.code} - ${a.name}</option>`;
            }).join('')}
        </select>
        <input type="number" class="debit-input" data-index="${journalRowIndex}" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†" min="0" step="0.01" oninput="updateJournalTotals()">
        <input type="number" class="credit-input" data-index="${journalRowIndex}" placeholder="Ø§Ù„Ø¯Ø§Ø¦Ù†" min="0" step="0.01" oninput="updateJournalTotals()">
        <div class="action-menu-container" style="display: flex; justify-content: center; align-items: center;">
            <button class="action-menu-btn" onclick="toggleActionMenu(event, 'journal-row-menu-${journalRowIndex}')" style="padding: 5px 10px;">â‹®</button>
            <div id="journal-row-menu-${journalRowIndex}" class="action-menu-content">
                <a href="javascript:void(0)" onclick="removeJournalRow(${journalRowIndex})" class="delete-action">ğŸ—‘ï¸ Ø­Ø°Ù</a>
            </div>
        </div>
    `;
    
    container.appendChild(newRow);
    journalRowIndex++;
    updateJournalTotals();
}

/**
 * Ø­Ø°Ù ØµÙ Ù…Ù† Ø§Ù„Ù‚ÙŠØ¯
 */
function removeJournalRow(index) {
    const rows = document.querySelectorAll('.journal-entry-row');
    if (rows.length <= 1) {
        showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù‚ÙŠØ¯ Ø¹Ù„Ù‰ Ø­Ø±ÙƒØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warning');
        return;
    }
    
    const row = document.querySelector(`[data-index="${index}"]`);
    if (row) {
        row.remove();
        updateJournalTotals();
    }
}

/**
 * ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ù‚ÙŠØ¯
 */
function updateJournalTotals() {
    const debitInputs = document.querySelectorAll('.debit-input');
    const creditInputs = document.querySelectorAll('.credit-input');
    
    let totalDebit = 0;
    let totalCredit = 0;
    
    debitInputs.forEach(input => {
        totalDebit += parseFloat(input.value) || 0;
    });
    
    creditInputs.forEach(input => {
        totalCredit += parseFloat(input.value) || 0;
    });
    
    document.getElementById('totalDebit').textContent = totalDebit.toFixed(2);
    document.getElementById('totalCredit').textContent = totalCredit.toFixed(2);
    
    const diff = Math.abs(totalDebit - totalCredit);
    const diffEl = document.getElementById('balanceDiff');
    diffEl.textContent = diff.toFixed(2);
    diffEl.style.color = diff < 0.01 ? '#2e7d32' : '#c62828';
}

/**
 * Ø­ÙØ¸ Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ
 */
async function saveJournalEntry() {
    const date = document.getElementById('journalDate').value;
    const description = document.getElementById('journalDescription').value;
    const reference = document.getElementById('journalReference').value;
    const notes = document.getElementById('journalNotes').value;
    
    if (!date || !description) {
        showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆØµÙ', 'error');
        return;
    }
    
    // Ø¬Ù…Ø¹ Ø§Ù„Ø­Ø±ÙƒØ§Øª
    const entries = [];
    const rows = document.querySelectorAll('.journal-entry-row');
    
    rows.forEach(row => {
        const index = row.dataset.index;
        const accountCode = document.querySelector(`.account-select[data-index="${index}"]`).value;
        const debit = parseFloat(document.querySelector(`.debit-input[data-index="${index}"]`).value) || 0;
        const credit = parseFloat(document.querySelector(`.credit-input[data-index="${index}"]`).value) || 0;
        
        if (accountCode && (debit > 0 || credit > 0)) {
            const account = getAccountByCode(accountCode);
            entries.push({
                accountCode: accountCode,
                accountName: account ? account.name : '',
                debit: debit,
                credit: credit
            });
        }
    });
    
    if (entries.length < 2) {
        showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù‚ÙŠØ¯ Ø¹Ù„Ù‰ Ø­Ø±ÙƒØªÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        return;
    }
    
    const totalDebit = entries.reduce((sum, e) => sum + e.debit, 0);
    const totalCredit = entries.reduce((sum, e) => sum + e.credit, 0);
    
    const result = await createJournalEntry({
        date: date,
        description: description,
        reference: reference || null,
        referenceType: 'manual',
        entries: entries,
        total: totalDebit,
        notes: notes
    });
    
    if (result) {
        showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        clearJournalForm();
        renderJournalList();
    }
}

/**
 * Ù…Ø³Ø­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚ÙŠØ¯
 */
function clearJournalForm() {
    document.getElementById('journalDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('journalDescription').value = '';
    document.getElementById('journalReference').value = '';
    document.getElementById('journalNotes').value = '';
    
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø±Ù‚Ù…ÙŠØ§Ù‹ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§ÙØ© Ø¨Ø§Ø¯Ø¦Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ù‚
    const sortedAccounts = buildAccountsSortedWithDepth();
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙÙˆÙ
    const container = document.getElementById('journalEntryRows');
    container.innerHTML = `
        <div class="journal-entry-row" style="display: contents;" data-index="0">
            <select class="account-select" data-index="0" onchange="updateJournalTotals()">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨ *</option>
                ${sortedAccounts.map(a => {
                    const indent = 'â€” '.repeat(Math.max(0, a._depth));
                    return `<option value="${a.code}">${indent}${a.code} - ${a.name}</option>`;
                }).join('')}
            </select>
            <input type="number" class="debit-input" data-index="0" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†" min="0" step="0.01" oninput="updateJournalTotals()">
            <input type="number" class="credit-input" data-index="0" placeholder="Ø§Ù„Ø¯Ø§Ø¦Ù†" min="0" step="0.01" oninput="updateJournalTotals()">
            <!-- Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°ÙÙ‡ -->
            <div></div>
        </div>
    `;
    journalRowIndex = 1;
    updateJournalTotals();
}

/**
 * Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©
 */
function renderJournalList() {
    const container = document.getElementById('journalList');
    const filterFrom = document.getElementById('journalFilterFrom').value;
    const filterTo = document.getElementById('journalFilterTo').value;
    const searchText = document.getElementById('journalSearchText').value.toLowerCase();
    
    let filtered = journalEntries;
    
    if (filterFrom) {
        filtered = filtered.filter(e => e.date >= filterFrom);
    }
    if (filterTo) {
        filtered = filtered.filter(e => e.date <= filterTo);
    }
    if (searchText) {
        filtered = filtered.filter(e => 
            e.description.toLowerCase().includes(searchText) ||
            (e.reference && e.reference.toString().includes(searchText))
        );
    }
    
    if (filtered.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</p>';
        return;
    }
    
    let html = '';
    filtered.forEach(entry => {
        html += `
            <div class="journal-entry-card" style="background: white; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 2px solid #1976d2; padding-bottom: 10px;">
                    <div>
                        <strong style="color: #1976d2;">ğŸ“„ ${entry.description}</strong>
                        ${entry.reference ? `<span style="color: #666; margin-right: 10px;">| Ø§Ù„Ù…Ø±Ø¬Ø¹: ${entry.reference}</span>` : ''}
                    </div>
                    <div style="text-align: left;">
                        <span style="color: #666;">ğŸ“… ${entry.date}</span>
                        <div class="action-menu-container">
                            <button class="action-menu-btn" onclick="toggleActionMenu(event, ${entry.id})">â‹®</button>
                            <div class="action-menu-content" id="menu-${entry.id}">
                                <a href="#" onclick="event.preventDefault(); deleteJournalEntryUI(${entry.id});" style="color: #dc3545;">ğŸ—‘ï¸ Ø­Ø°Ù</a>
                            </div>
                        </div>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; color: #333;">Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #c62828;">Ø§Ù„Ù…Ø¯ÙŠÙ†</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #2e7d32;">Ø§Ù„Ø¯Ø§Ø¦Ù†</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${entry.entries.map(e => `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">${e.accountCode} - ${e.accountName}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: ${e.debit > 0 ? '#c62828' : '#999'};">${e.debit > 0 ? e.debit.toFixed(2) : '-'}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: ${e.credit > 0 ? '#2e7d32' : '#999'};">${e.credit > 0 ? e.credit.toFixed(2) : '-'}</td>
                            </tr>
                        `).join('')}
                        <tr style="background: #f5f5f5; font-weight: bold;">
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #c62828;">${entry.entries.reduce((sum, e) => sum + e.debit, 0).toFixed(2)}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #2e7d32;">${entry.entries.reduce((sum, e) => sum + e.credit, 0).toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table>
                ${entry.notes ? `<div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 4px;"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${entry.notes}</div>` : ''}
                <div style="margin-top: 10px; font-size: 0.85em; color: #999;">ğŸ‘¤ ${entry.createdBy} | ğŸ• ${new Date(entry.createdAt).toLocaleString('ar-EG')}</div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

/**
 * Ø­Ø°Ù Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
 */
async function deleteJournalEntryUI(entryId) {
    const confirmed = await showConfirmDialog({
        title: 'âš ï¸ Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ',
        message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚ÙŠØ¯ØŸ\n\nØ³ÙŠØªÙ… Ø¹ÙƒØ³ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡.\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.',
        type: 'danger',
        icon: 'ğŸ—‘ï¸',
        confirmText: 'Ù†Ø¹Ù…ØŒ Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ¯',
        cancelText: 'Ø¥Ù„ØºØ§Ø¡',
        confirmButtonClass: 'danger'
    });
    
    if (!confirmed) return;
    
    const success = await deleteJournalEntry(entryId);
    if (success) {
        showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        renderJournalList();
        renderChartOfAccounts();
    }
}

/**
 * Ø¹Ø±Ø¶ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
 */

function exportJournalToPDF() {
    try {
        const filterFrom = document.getElementById('journalFilterFrom')?.value;
        const filterTo = document.getElementById('journalFilterTo')?.value;
        const searchText = document.getElementById('journalSearchText')?.value.toLowerCase();
        
        let filtered = [...journalEntries];
        
        if (filterFrom) filtered = filtered.filter(e => e.date >= filterFrom);
        if (filterTo) filtered = filtered.filter(e => e.date <= filterTo);
        if (searchText) {
            filtered = filtered.filter(e => 
                e.description.toLowerCase().includes(searchText) ||
                (e.reference && e.reference.toLowerCase().includes(searchText))
            );
        }
        
        if (filtered.length === 0) {
            showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯ Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');
            return;
        }
        
        filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        // Create a temporary container for the PDF content
        // We wrap it to ensure it's rendered in the DOM but not visible to the user
        const wrapper = document.createElement('div');
        wrapper.style.position = 'absolute';
        wrapper.style.left = '-9999px';
        wrapper.style.top = '0';
        wrapper.style.width = '1200px'; // Fixed width for landscape
        document.body.appendChild(wrapper);

        const container = document.createElement('div');
        container.style.padding = '20px';
        container.style.direction = 'rtl';
        container.style.fontFamily = 'Tajawal, sans-serif';
        container.style.backgroundColor = '#ffffff';
        container.style.color = '#000000';
        wrapper.appendChild(container);
        
        // Add Header
        const activityName = activities.find(a => a.id == currentActivityId)?.name 
            || document.getElementById('currentActivityNameDisplay')?.textContent 
            || 'Ø§Ù„Ù†Ø´Ø§Ø·';
        const header = document.createElement('div');
        header.innerHTML = `
            <h2 style="text-align: center; color: #333; margin-bottom: 10px;">Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© - ${activityName}</h2>
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 14px; color: #666;">
                <span>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ${new Date().toLocaleDateString('ar-SA')}</span>
                <span>${filterFrom || filterTo ? `Ø§Ù„ÙØªØ±Ø©: ${filterFrom || 'Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'} Ø¥Ù„Ù‰ ${filterTo || 'Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'}` : 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª'}</span>
            </div>
        `;
        container.appendChild(header);
        
        // Add Table
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.fontSize = '12px';
        
        // Table Header
        table.innerHTML = `
            <thead>
                <tr style="background-color: rgba(33, 150, 243, 0.15); color: #000; border-bottom: 2px solid #333;">
                    <th style="padding: 8px; border: 1px solid #999; width: 10%;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th style="padding: 8px; border: 1px solid #999; width: 25%;">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                    <th style="padding: 8px; border: 1px solid #999; width: 10%;">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                    <th style="padding: 8px; border: 1px solid #999; width: 20%;">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                    <th style="padding: 8px; border: 1px solid #999; width: 12%;">Ù…Ø¯ÙŠÙ†</th>
                    <th style="padding: 8px; border: 1px solid #999; width: 12%;">Ø¯Ø§Ø¦Ù†</th>
                    <th style="padding: 8px; border: 1px solid #999; width: 11%;">Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        
        const tbody = table.querySelector('tbody');
        
        filtered.forEach(entry => {
            entry.entries.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.style.backgroundColor = index % 2 === 0 ? '#fff' : '#f9f9f9';
                
                tr.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${index === 0 ? entry.date : ''}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${index === 0 ? entry.description : ''}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${row.accountCode}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${row.accountName}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: left;">${formatCurrency(row.debit)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: left;">${formatCurrency(row.credit)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${entry.reference || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Add separator row
            const separator = document.createElement('tr');
            separator.innerHTML = '<td colspan="7" style="height: 10px; background-color: #eee; border: none;"></td>';
            tbody.appendChild(separator);
        });
        
        container.appendChild(table);
        
        // Generate PDF
        const opt = {
            margin: 10,
            filename: 'journal-entries.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
        };
        
        // Show loading
        const btn = document.querySelector('button[onclick="exportJournalToPDF()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...';
        btn.disabled = true;
        
        html2pdf().set(opt).from(container).save().then(() => {
            document.body.removeChild(wrapper); // Cleanup
            btn.innerHTML = originalText;
            btn.disabled = false;
            showNotification('âœ… ØªÙ…', 'ØªÙ… ØªØµØ¯ÙŠØ± Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }).catch(err => {
            if (document.body.contains(wrapper)) document.body.removeChild(wrapper); // Cleanup on error
            console.error(err);
            btn.innerHTML = originalText;
            btn.disabled = false;
            showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± PDF', 'error');
        });
        
    } catch (error) {
        console.error('PDF Export Error:', error);
        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± PDF', 'error');
    }
}

function exportJournalToExcel() {
    try {
        const filterFrom = document.getElementById('journalFilterFrom')?.value;
        const filterTo = document.getElementById('journalFilterTo')?.value;
        const searchText = document.getElementById('journalSearchText')?.value.toLowerCase();
        
        let filtered = [...journalEntries];
        
        if (filterFrom) {
            filtered = filtered.filter(e => e.date >= filterFrom);
        }
        
        if (filterTo) {
            filtered = filtered.filter(e => e.date <= filterTo);
        }
        
        if (searchText) {
            filtered = filtered.filter(e => 
                e.description.toLowerCase().includes(searchText) ||
                (e.reference && e.reference.toLowerCase().includes(searchText))
            );
        }
        
        if (filtered.length === 0) {
            showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯ Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');
            return;
        }
        
        filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        const activityName = activities.find(a => a.id === currentActivityId)?.name || 'Ø§Ù„Ù†Ø´Ø§Ø·';
        
        let csv = '\uFEFF';
        csv += 'Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© - ' + activityName + '\n';
        csv += 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ' + new Date().toLocaleDateString('ar-SA') + '\n';
        if (filterFrom || filterTo) {
            csv += 'Ø§Ù„ÙØªØ±Ø©: Ù…Ù† ' + (filterFrom || 'Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©') + ' Ø¥Ù„Ù‰ ' + (filterTo || 'Ø§Ù„Ù†Ù‡Ø§ÙŠØ©') + '\n';
        }
        csv += '\n';
        csv += 'Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ø¨ÙŠØ§Ù†,Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨,Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨,Ø§Ù„Ù…Ø¯ÙŠÙ†,Ø§Ù„Ø¯Ø§Ø¦Ù†,Ø§Ù„Ù…Ø±Ø¬Ø¹\n';
        
        let totalDebit = 0;
        let totalCredit = 0;
        
        filtered.forEach(entry => {
            entry.entries.forEach((row, index) => {
                if (index === 0) {
                    csv += entry.date + ',';
                    csv += '"' + entry.description + '",';
                } else {
                    csv += ',,';
                }
                csv += row.accountCode + ',';
                csv += '"' + row.accountName + '",';
                csv += row.debit.toFixed(2) + ',';
                csv += row.credit.toFixed(2) + ',';
                if (index === 0) {
                    csv += (entry.reference || '') + '\n';
                } else {
                    csv += '\n';
                }
                
                totalDebit += row.debit;
                totalCredit += row.credit;
            });
        });
        
        csv += '\n';
        csv += ',,,Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª,' + totalDebit.toFixed(2) + ',' + totalCredit.toFixed(2) + '\n';
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'Ø¯ÙØªØ±_Ø§Ù„ÙŠÙˆÙ…ÙŠØ©_' + new Date().toISOString().split('T')[0] + '.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØµØ¯ÙŠØ± ' + filtered.length + ' Ù‚ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:', error);
        showNotification('âŒ Ø®Ø·Ø£', 'ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}

function renderChartOfAccounts() {
    const container = document.getElementById('chartOfAccountsList');
    if (!container) return;
    
    console.log('ğŸ“Š Ø¹Ø±Ø¶ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:', chartOfAccounts.length, 'Ø­Ø³Ø§Ø¨');
    
    const searchText = document.getElementById('accountSearchText')?.value?.toLowerCase() || '';
    const categoryFilter = document.getElementById('accountCategoryFilter')?.value || '';
    
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ØªØ³Ù„Ø³Ù„ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„ÙƒÙˆØ¯ (Ø±Ù‚Ù…ÙŠØ§Ù‹)
    let filtered = chartOfAccounts.filter(a => a.type === 'account').sort((a, b) => parseInt(a.code) - parseInt(b.code));
    console.log('ğŸ“‹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©:', filtered.length);
    
    if (searchText) {
        filtered = filtered.filter(a => 
            a.code.includes(searchText) ||
            a.name.toLowerCase().includes(searchText) ||
            a.nameEn.toLowerCase().includes(searchText)
        );
    }
    
    if (categoryFilter) {
        filtered = filtered.filter(a => a.category === categoryFilter);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ
    let assetsTotal = 0, liabilitiesTotal = 0, equityTotal = 0, revenueTotal = 0, expenseTotal = 0;
    
    chartOfAccounts.forEach(account => {
        if (account.type === 'account') {
            switch(account.category) {
                case 'asset': assetsTotal += account.balance; break;
                case 'liability': liabilitiesTotal += account.balance; break;
                case 'equity': equityTotal += account.balance; break;
                case 'revenue': revenueTotal += account.balance; break;
                case 'expense': expenseTotal += account.balance; break;
            }
        }
    });
    
    document.getElementById('assetsBalance').textContent = assetsTotal.toFixed(2);
    document.getElementById('liabilitiesBalance').textContent = liabilitiesTotal.toFixed(2);
    document.getElementById('equityBalance').textContent = equityTotal.toFixed(2);
    document.getElementById('revenueBalance').textContent = revenueTotal.toFixed(2);
    document.getElementById('expenseBalance').textContent = expenseTotal.toFixed(2);
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    if (filtered.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª</p>';
        return;
    }
    
    let html = '<table style="width: 100%; border-collapse: collapse; background: white;">';
    html += `
        <thead>
            <tr style="background: linear-gradient(135deg, #1976d2, #42a5f5);">
                <th style="border: 1px solid #ddd; padding: 12px; text-align: center; color: white;">Ø§Ù„ÙƒÙˆØ¯</th>
                <th style="border: 1px solid #ddd; padding: 12px; text-align: right; color: white;">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                <th style="border: 1px solid #ddd; padding: 12px; text-align: right; color: white;">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</th>
                <th style="border: 1px solid #ddd; padding: 12px; text-align: center; color: white;">Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                <th style="border: 1px solid #ddd; padding: 12px; text-align: center; color: white;">Ø§Ù„Ù…Ø¯ÙŠÙ†</th>
                <th style="border: 1px solid #ddd; padding: 12px; text-align: center; color: white;">Ø§Ù„Ø¯Ø§Ø¦Ù†</th>
                <th style="border: 1px solid #ddd; padding: 12px; text-align: center; color: white;">Ø§Ù„Ø±ØµÙŠØ¯</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    filtered.forEach((account, index) => {
        const categoryLabels = {
            'asset': 'ğŸ’° Ø£ØµÙˆÙ„',
            'liability': 'ğŸ“Š Ø®ØµÙˆÙ…',
            'equity': 'ğŸ¢ Ø­Ù‚ÙˆÙ‚ Ù…Ù„ÙƒÙŠØ©',
            'revenue': 'ğŸ’µ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',
            'expense': 'ğŸ’¸ Ù…ØµØ±ÙˆÙØ§Øª'
        };
        
        html += `
            <tr style="background: ${index % 2 === 0 ? '#f9f9f9' : 'white'};">
                <td style="border: 1px solid #ddd; padding: 10px; text-align: center; font-weight: bold; color: #1976d2;">${account.code}</td>
                <td style="border: 1px solid #ddd; padding: 10px;">${account.name}</td>
                <td style="border: 1px solid #ddd; padding: 10px; color: #666;">${account.nameEn}</td>
                <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${categoryLabels[account.category] || ''}</td>
                <td style="border: 1px solid #ddd; padding: 10px; text-align: center; color: ${account.debit > 0 ? '#c62828' : '#999'};">${account.debit.toFixed(2)}</td>
                <td style="border: 1px solid #ddd; padding: 10px; text-align: center; color: ${account.credit > 0 ? '#2e7d32' : '#999'};">${account.credit.toFixed(2)}</td>
                <td style="border: 1px solid #ddd; padding: 10px; text-align: center; font-weight: bold; color: ${account.balance >= 0 ? '#2e7d32' : '#c62828'};">${account.balance.toFixed(2)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

// ğŸ“ Migrate old items to multi-unit structure
function migrateItemsToMultiUnit() {
    console.log('ğŸ“ Ø¨Ø¯Ø¡ ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù„Ù„Ù†Ø¸Ø§Ù… Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª...');
    
    let migratedCount = 0;
    items.forEach(item => {
        // Check if item uses old structure (has 'unit' and 'price' but not 'units')
        if (item.unit && item.price !== undefined && !item.units) {
            // Convert to new structure
            item.units = [{
                name: item.unit,
                factor: 1,
                price: item.price,
                isBase: true
            }];
            
            // Remove old properties
            delete item.unit;
            delete item.price;
            
            migratedCount++;
            console.log(`âœ… ØªÙ… ØªØ±Ø­ÙŠÙ„: ${item.name} (${item.units[0].name})`);
        }
    });
    
    if (migratedCount > 0) {
        console.log(`âœ… ØªÙ… ØªØ±Ø­ÙŠÙ„ ${migratedCount} ØµÙ†Ù Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯`);
        saveToLocalStorage('items', items);
    } else {
        console.log('âœ“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');
    }
}

// ========================================
// ğŸ”¥ ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© initializeApp Ù…Ø¨ÙƒØ±Ø§Ù‹
// ========================================
async function initializeApp() {
    console.log('ğŸ¯ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
    console.log('ğŸš€ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¯ÙŠÙˆØ§Ù†ÙŠ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ v23.0');
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ù† Firebase/LocalStorage
    console.log('ğŸ“‹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©...');
    await loadUsers();
    await loadActivities();
    
    // ğŸ“’ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ
    console.log('ğŸ“Š ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ...');
    // Ù„Ø§ Ù†Ø³ØªØ¯Ø¹ÙŠ initializeChartOfAccounts Ù‡Ù†Ø§ - Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ù…Ù† Firebase Ø£ÙˆÙ„Ø§Ù‹
    
    if (!currentActivityId) { 
        console.log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ù…Ø­Ø¯Ø¯ - Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø©');
        showActivityModal(); 
        return; 
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ø£Ùˆ LocalStorage
    if (USE_FIREBASE) {
        debugLog('ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...');
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© ÙˆØ¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù† Firebase Ø£ÙˆÙ„Ø§Ù‹
        const firebaseJournalEntries = await firebaseGetActivityData(currentActivityId, 'journalEntries') || [];
        console.log(`ğŸ“’ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseJournalEntries.length} Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù…Ù† Firebase`);
        
        const firebaseChartOfAccounts = await firebaseGetActivityData(currentActivityId, 'chartOfAccounts') || [];
        console.log(`ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseChartOfAccounts.length} Ø­Ø³Ø§Ø¨ Ù…Ù† Firebase`);
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
        console.log(`ğŸ” Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ø´Ø§Ø·: ${currentActivityId}`);
        
        const firebaseItems = await firebaseGetActivityData(currentActivityId, 'items') || [];
        console.log(`ğŸ“¦ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseItems.length} ØµÙ†Ù Ù…Ù† Firebase`);
        
        const firebaseCustomers = await firebaseGetActivityData(currentActivityId, 'customers') || [];
        console.log(`ğŸ‘¥ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseCustomers.length} Ø¹Ù…ÙŠÙ„ Ù…Ù† Firebase`);
        
        const firebaseSuppliers = await firebaseGetActivityData(currentActivityId, 'suppliers') || [];
        console.log(`ğŸª ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseSuppliers.length} Ù…ÙˆØ±Ø¯ Ù…Ù† Firebase`);
        
        const firebasePurchases = await firebaseGetActivityData(currentActivityId, 'purchases') || [];
        console.log(`ğŸ›’ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebasePurchases.length} Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ù† Firebase`);
        
        const firebaseSales = await firebaseGetActivityData(currentActivityId, 'sales') || [];
        console.log(`ğŸ’° ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseSales.length} Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† Firebase`);
        
        const firebaseExpenses = await firebaseGetActivityData(currentActivityId, 'expenses') || [];
        console.log(`ğŸ’¸ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseExpenses.length} Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù† Firebase`);
        
        const firebaseRevenues = await firebaseGetActivityData(currentActivityId, 'revenues') || [];
        console.log(`ğŸ’µ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseRevenues.length} Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…Ù† Firebase`);
        
        const firebaseSalaries = await firebaseGetActivityData(currentActivityId, 'salaries') || [];
        console.log(`ğŸ’¼ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseSalaries.length} Ø±Ø§ØªØ¨ Ù…Ù† Firebase`);
        
        const firebaseAssets = await firebaseGetActivityData(currentActivityId, 'assets') || [];
        console.log(`ğŸ¦ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseAssets.length} Ø£ØµÙ„ Ù…Ù† Firebase`);
        
        const firebaseSalesReturns = await firebaseGetActivityData(currentActivityId, 'salesReturns') || [];
        console.log(`â†©ï¸ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseSalesReturns.length} Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† Firebase`);
        
        const firebaseAdvances = await firebaseGetActivityData(currentActivityId, 'advances') || [];

        const firebaseEmployees = await firebaseGetActivityData(currentActivityId, 'employees') || [];
        console.log(`ğŸ’³ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseAdvances.length} Ø¹Ù‡Ø¯Ø©/Ø³Ù„ÙØ© Ù…Ù† Firebase`);
        
        const firebasePurchaseReturns = await firebaseGetActivityData(currentActivityId, 'purchaseReturns') || [];
        console.log(`ğŸ”™ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebasePurchaseReturns.length} Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ù† Firebase`);
        
        const firebaseBranches = await firebaseGetActivityData(currentActivityId, 'branches') || [];
        console.log(`ğŸª ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseBranches.length} ÙØ±Ø¹ Ù…Ù† Firebase`);
        
        const firebaseSalePayments = await firebaseGetActivityData(currentActivityId, 'salePayments') || [];
        console.log(`ğŸ’° ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseSalePayments.length} Ø¯ÙØ¹Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† Firebase`);
        
        const firebasePurchasePayments = await firebaseGetActivityData(currentActivityId, 'purchasePayments') || [];
        console.log(`ğŸ’³ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebasePurchasePayments.length} Ø¯ÙØ¹Ø© Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ù† Firebase`);
        
        const firebasePermissions = await firebaseGetActivityData(currentActivityId, 'permissions') || [];
        console.log(`ğŸ“‹ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebasePermissions.length} Ø¥Ø°Ù† Ù…Ø®Ø²Ù†ÙŠ Ù…Ù† Firebase`);
        
        const firebaseInventoryAdjustments = await firebaseGetActivityData(currentActivityId, 'inventoryAdjustments') || [];
        console.log(`ğŸ“¦ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseInventoryAdjustments.length} Ø¹Ù…Ù„ÙŠØ© Ø¬Ø±Ø¯ Ù…Ù† Firebase`);
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ù…Ø¨Ø§Ø´Ø±Ø©
        items = firebaseItems || [];
        customers = firebaseCustomers || [];
        suppliers = firebaseSuppliers || [];
        purchases = firebasePurchases || [];
        sales = firebaseSales || [];
        expenses = firebaseExpenses || [];
        revenues = firebaseRevenues || [];
        salaries = firebaseSalaries || [];
        assets = firebaseAssets || [];
        salesReturns = firebaseSalesReturns || [];
        advances = firebaseAdvances || [];
        employees = firebaseEmployees || [];
        branches = firebaseBranches || [];
        warehouses = branches; // ğŸ”— ØªØ²Ø§Ù…Ù† Ù…Ø¹ branches
        purchaseReturns = firebasePurchaseReturns || [];
        salePayments = firebaseSalePayments || [];
        purchasePayments = firebasePurchasePayments || [];
        permissions = firebasePermissions || [];
        inventoryAdjustments = firebaseInventoryAdjustments || [];
        
        // ğŸ“’ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ù…Ù† Firebase
        journalEntries = firebaseJournalEntries || [];
        
        // Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù† Firebase Ø£Ùˆ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        if (firebaseChartOfAccounts && firebaseChartOfAccounts.length > 0) {
            chartOfAccounts = firebaseChartOfAccounts;
        } else {
            chartOfAccounts = JSON.parse(JSON.stringify(DEFAULT_CHART_OF_ACCOUNTS));
        }
        
        console.log('ğŸ”¥ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase:');
        console.log(`  - items: ${items.length}`);
        console.log(`  - customers: ${customers.length}`);
        console.log(`  - suppliers: ${suppliers.length}`);
        console.log(`  - purchases: ${purchases.length}`);
        console.log(`  - sales: ${sales.length}`);
        console.log(`  - journalEntries: ${journalEntries.length}`);
        console.log(`  - chartOfAccounts: ${chartOfAccounts.length}`);
        
    } else {
        debugLog('ğŸ“¦ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage...');
        
        items = (loadFromLocalStorage('items')) || [];
        customers = (loadFromLocalStorage('customers')) || [];
        suppliers = (loadFromLocalStorage('suppliers')) || [];
        purchases = (loadFromLocalStorage('purchases')) || [];
        sales = (loadFromLocalStorage('sales')) || [];
        expenses = (loadFromLocalStorage('expenses')) || [];
        revenues = (loadFromLocalStorage('revenues')) || [];
        salaries = (loadFromLocalStorage('salaries')) || [];
        assets = (loadFromLocalStorage('assets')) || [];
        salesReturns = (loadFromLocalStorage('salesReturns')) || [];
        advances = (loadFromLocalStorage('advances')) || [];
        employees = (loadFromLocalStorage('employees')) || [];
        purchaseReturns = (loadFromLocalStorage('purchaseReturns')) || [];
        branches = (loadFromLocalStorage('branches')) || [];
        warehouses = branches; // ğŸ”— ØªØ²Ø§Ù…Ù† Ù…Ø¹ branches
        salePayments = (loadFromLocalStorage('salePayments')) || [];
        purchasePayments = (loadFromLocalStorage('purchasePayments')) || [];
        permissions = (loadFromLocalStorage('permissions')) || [];
        inventoryAdjustments = (loadFromLocalStorage('inventoryAdjustments')) || [];
        console.log('ğŸ” After loading inventoryAdjustments from localStorage:', inventoryAdjustments);
        console.log('ğŸ” inventoryAdjustments length:', inventoryAdjustments.length);
        window.inventoryAdjustments = inventoryAdjustments; // ğŸŒ Make globally accessible
        journalEntries = (loadFromLocalStorage('journalEntries')) || [];
        
        // Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª: LocalStorage > Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        const localChartOfAccounts = loadFromLocalStorage('chartOfAccounts');
        if (localChartOfAccounts && localChartOfAccounts.length > 0) {
            console.log('âœ… ØªØ­Ù…ÙŠÙ„ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù† LocalStorage');
            chartOfAccounts = localChartOfAccounts;
        } else {
            console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ LocalStorage - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ');
            chartOfAccounts = JSON.parse(JSON.stringify(DEFAULT_CHART_OF_ACCOUNTS));
            saveToLocalStorage('chartOfAccounts', chartOfAccounts);
        }
        
        console.log('ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage:');
        console.log(`  - journalEntries: ${journalEntries.length}`);
        console.log(`  - chartOfAccounts: ${chartOfAccounts.length}`);
    }

    currentPurchaseNumber = purchases.length > 0 ? Math.max(0, ...purchases.map(p => p.number)) + 1 : 1;
    currentSaleNumber = sales.length > 0 ? Math.max(0, ...sales.map(s => s.number)) + 1 : 1;
    currentSaleReturnNumber = salesReturns.length > 0 ? Math.max(0, ...salesReturns.map(r => r.number)) + 1 : 1;
    
    // ğŸ“ Migrate old items to new multi-unit structure
    migrateItemsToMultiUnit();
    
    // ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
    if (typeof upgradeSalesData === 'function') {
        await upgradeSalesData();
    }
    currentPurchaseReturnNumber = purchaseReturns.length > 0 ? Math.max(0, ...purchaseReturns.map(r => r.number)) + 1 : 1;
    
    const today = new Date().toISOString().split('T')[0];
    ['purchaseDate', 'saleDate', 'expenseDate', 'revenueDate', 'reportFrom', 'reportTo'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = today;
    });
    
    const monthInput = document.getElementById('salaryMonth');
    if (monthInput) {
        if (!monthInput.value) {
            monthInput.value = new Date().toISOString().slice(0, 7);
        }
        monthInput.onchange = () => { if (typeof updateSalarySummary === 'function') updateSalarySummary(); };
    }
    
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¨Ø£Ù…Ø§Ù†
    const safeFunctions = [
        'generatePurchaseCode', 'generateSaleCode', 'updateDashboard', 'updateExpenseStats', 
        'updateRevenueStats', 'updateDataStats', 'renderItems', 'renderCustomers', 'renderSuppliers', 
        'renderExpenses', 'renderRevenues', 'renderSalaries', 'updateSalarySummary', 'displayAssets', 
        'updateAssetsStats', 'clearSalaryForm', 'renderSalesList', 'renderPurchasesList', 
        'renderSalesReturns', 'renderPurchaseReturns', 'updatePurchaseDropdowns', 'updateSaleDropdowns', 
        'updateReportItemFilter', 'loadTrashFromLocalStorage', 'updateTrashBadge', 'renderPermissionsList', 'loadPermissionsFilters'
    ];
    
    safeFunctions.forEach(funcName => {
        if (typeof window[funcName] === 'function') {
            try { window[funcName](); } catch (e) { console.warn(`ØªØ­Ø°ÙŠØ± ÙÙŠ ${funcName}:`, e.message); }
        }
    });
    
    // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¥Ø¶Ø§ÙÙŠ ÙÙˆØ±ÙŠ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
    console.log('ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:');
    console.log(`  - items: ${items.length}`);
    console.log(`  - customers: ${customers.length}`);
    console.log(`  - suppliers: ${suppliers.length}`);
    console.log(`  - purchases: ${purchases.length}`);
    console.log(`  - sales: ${sales.length}`);
    console.log(`  - expenses: ${expenses.length}`);
    console.log(`  - revenues: ${revenues.length}`);
    
    if (purchases.length > 0) {
        console.log('ğŸ›’ ØªÙØ§ØµÙŠÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:');
        purchases.forEach((p, idx) => {
            console.log(`  - ÙØ§ØªÙˆØ±Ø© ${idx + 1}: Ø±Ù‚Ù…=${p.number}, ØªØ§Ø±ÙŠØ®=${p.date}, Ø¥Ø¬Ù…Ø§Ù„ÙŠ=${p.total}`);
        });
        console.log(`  - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${purchases.reduce((s, i) => s + (Number(i.total) || 0), 0).toFixed(2)}`);
    }
    
    if (typeof updateDashboard === 'function') {
        try {
            updateDashboard();
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù†Ø¬Ø§Ø­');
            
            // ÙØ­Øµ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            setTimeout(() => {
                const displayedValue = document.getElementById('totalPurchases')?.textContent;
                console.log(`ğŸ” Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙŠ #totalPurchases Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«: "${displayedValue}"`);
            }, 200);
        } catch (e) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:', e);
        }
    }

    const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser') || 'null');
    if (typeof updateLoggedInUserDisplay === 'function' && loggedInUser) {
        updateLoggedInUserDisplay(loggedInUser);
    }
    
    // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø¯ÙŠÙˆÙ† ÙÙ‚Ø· Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ
    setTimeout(() => {
        if (typeof checkLowStock === 'function') checkLowStock();
        if (typeof checkUnpaidDebts === 'function') checkUnpaidDebts();
        if (typeof checkOverduePayments === 'function') checkOverduePayments();
    }, 10000);
    
    // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„Ø£ØµÙˆÙ„
    const searchAssetsInput = document.getElementById('searchAssets');
    const filterAssetTypeSelect = document.getElementById('filterAssetType');
    const filterAssetStatusSelect = document.getElementById('filterAssetStatus');
    
    if (searchAssetsInput && typeof displayAssets === 'function') {
        searchAssetsInput.addEventListener('input', displayAssets);
    }
    if (filterAssetTypeSelect && typeof displayAssets === 'function') {
        filterAssetTypeSelect.addEventListener('change', displayAssets);
    }
    if (filterAssetStatusSelect && typeof displayAssets === 'function') {
        filterAssetStatusSelect.addEventListener('change', displayAssets);
    }
    
    // ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    setTimeout(() => {
        if (typeof initBackupReminderSystem === 'function') {
            initBackupReminderSystem();
        }
    }, 3000);
    
    const activity = activities.find(a => a.id == currentActivityId);
    console.log(`âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ù†Ø´Ø§Ø·: ${activity ? activity.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`);
    
    // ØªØ­Ù…ÙŠÙ„ ØªØ®ØµÙŠØµØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    if (typeof loadDesignPreferences === 'function') {
        loadDesignPreferences();
        console.log('ğŸ¨ ØªÙ… ØªØ­Ù…ÙŠÙ„ ØªØ®ØµÙŠØµØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ…');
    }
    
    console.log('ğŸ“Š ØªÙ… ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…');
    
    // ğŸ” ÙØ­Øµ Ø´Ø§Ù…Ù„ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase
    setTimeout(async () => {
        if (USE_FIREBASE && currentActivityId) {
            console.log('ğŸ” ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ù„Ù„Ù†Ø´Ø§Ø·:', currentActivityId);
            try {
                const { ref, get } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                // ÙØ­Øµ Ø¨Ù†ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase
                const activityRef = ref(db, `activities/${currentActivityId}`);
                const snapshot = await get(activityRef);
                
                if (snapshot.exists()) {
                    const activityData = snapshot.val();
                    console.log('ğŸ“Š Ø¨Ù†ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase:', Object.keys(activityData));
                    console.log('ğŸ” Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù…Ù† Firebase:', activityData);
                    
                    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ÙØµÙ„Ø©
                    Object.keys(activityData).forEach(dataType => {
                        const data = activityData[dataType];
                        console.log(`ğŸ” ÙØ­Øµ ${dataType}:`, data);
                        if (data && typeof data === 'object') {
                            const count = Array.isArray(data) ? data.length : Object.keys(data).length;
                            console.log(`ğŸ“Š Firebase ${dataType}: ${count} Ø¹Ù†ØµØ±`);
                        }
                    });
                } else {
                    console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ø´Ø§Ø· ÙÙŠ Firebase:', currentActivityId);
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Firebase:', error);
            }
        }
    }, 1000);
    
    // ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    setTimeout(() => {
        const dataStatus = {
            items: items?.length || 0,
            customers: customers?.length || 0,
            suppliers: suppliers?.length || 0,
            purchases: purchases?.length || 0,
            sales: sales?.length || 0,
            expenses: expenses?.length || 0,
            revenues: revenues?.length || 0,
            salaries: salaries?.length || 0,
            users: users?.length || 0,
            activities: activities?.length || 0,
            currentUser: !!window.currentUser,
            currentActivityId: currentActivityId || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
        };
        
        console.log('ğŸ“Š ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', dataStatus);
        
        const totalData = Object.values(dataStatus).reduce((sum, val) => 
            typeof val === 'number' ? sum + val : sum, 0);
        
        if (totalData === 0 && window.currentUser) {
            console.error('ğŸš¨ Ù…Ø´ÙƒÙ„Ø© Ø®Ø·ÙŠØ±Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª!');
            showNotification('ğŸš¨ ØªØ­Ø°ÙŠØ±', 'ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'warning');
        } else if (totalData > 0) {
            console.log(`âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù…Ù„Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (${totalData} Ø¹Ù†ØµØ±)`);
        }
        
        // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        if (typeof updateDashboard === 'function') {
            updateDashboard();
        }
    }, 2000);
    
    // ØªØ­Ù‚Ù‚ Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
    if (window.currentUser) {
        console.log('âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„:', window.currentUser.name);
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        const loginSection = document.getElementById('loginSection');
        const appContent = document.getElementById('appContent');
        if (loginSection && appContent) {
            loginSection.style.display = 'none';
            appContent.style.display = 'block';
        }
    } else {
        console.log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„');
    }
}

// ÙƒØ´Ù Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ø¹Ø§Ù„Ù…ÙŠØ© ÙÙˆØ±Ø§Ù‹
if (typeof window !== 'undefined') {
    window.initializeApp = initializeApp;
    debugLog('ğŸ¯ ØªÙ… ØªØ¹Ø±ÙŠÙ window.initializeApp Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù…ÙƒØ§Ù† Ù…Ø¨ÙƒØ±!');
}

console.log('ğŸ”¥ Firebase initialization completed, continuing...');

// ========================================
// ğŸ“§ Ø¯ÙˆØ§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (EmailJS)
// ========================================
function toggleEmailSettings() {
    console.log('ğŸ“§ ÙØªØ­ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ...');
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† emailJsConfig Ùˆ LocalStorage
    const savedConfig = localStorage.getItem('diwan_email_config');
    if (savedConfig) {
        try {
            const config = JSON.parse(savedConfig);
            Object.assign(emailJsConfig, config);
        } catch (error) {
            console.warn('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯:', error);
        }
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø£Ùˆ LocalStorage)
    const serviceId = emailJsConfig.serviceID || localStorage.getItem('emailjs_service_id') || '';
    const templateId = emailJsConfig.templateID || localStorage.getItem('emailjs_template_id') || '';
    const publicKey = emailJsConfig.publicKey || localStorage.getItem('emailjs_public_key') || '';
    
    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById('emailJsServiceId').value = serviceId;
    document.getElementById('emailJsTemplateId').value = templateId;
    document.getElementById('emailJsPublicKey').value = publicKey;
    
    // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
    const overlay = document.getElementById('email-settings-overlay');
    if (overlay) {
        overlay.style.display = 'flex';
        console.log('âœ… ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯');
    } else {
        console.error('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯');
        showNotification('âŒ Ø®Ø·Ø£', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯', 'error');
    }
}

function closeEmailSettingsModal() {
    const overlay = document.getElementById('email-settings-overlay');
    if (overlay) {
        overlay.style.display = 'none';
        console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯');
    }
}

async function saveEmailJsSettings() {
    console.log('ğŸ’¾ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ...');
    
    const serviceId = document.getElementById('emailJsServiceId').value.trim();
    const templateId = document.getElementById('emailJsTemplateId').value.trim();
    const publicKey = document.getElementById('emailJsPublicKey').value.trim();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
    emailJsConfig = {
        serviceID: serviceId,
        templateID: templateId,
        publicKey: publicKey
    };
    
    // Ø­ÙØ¸ ÙÙŠ LocalStorage
    try {
        localStorage.setItem('diwan_email_config', JSON.stringify(emailJsConfig));
        
        // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù†ÙØµÙ„Ø© Ø£ÙŠØ¶Ø§Ù‹ Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
        localStorage.setItem('emailjs_service_id', serviceId);
        localStorage.setItem('emailjs_template_id', templateId);
        localStorage.setItem('emailjs_public_key', publicKey);
        
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­');
        showNotification('âœ… Ù†Ø¬Ø­', 'ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        closeEmailSettingsModal();
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯:', error);
        showNotification('âŒ Ø®Ø·Ø£', 'ÙØ´Ù„ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'error');
    }
}

// ØªØ­Ù…ÙŠÙ„ Ù‚ÙŠÙ… EmailJS Ø¥Ù„Ù‰ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (ÙŠÙØ³ØªØ¯Ø¹Ù‰ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©)
function loadEmailJsSettings() {
    try {
        const serviceId = emailJsConfig.serviceID || localStorage.getItem('emailjs_service_id') || '';
        const templateId = emailJsConfig.templateID || localStorage.getItem('emailjs_template_id') || '';
        const resetTemplateId = emailJsConfig.resetTemplateID || localStorage.getItem('emailjs_reset_template_id') || '';
        const publicKey = emailJsConfig.publicKey || localStorage.getItem('emailjs_public_key') || '';

        const serviceEl = document.getElementById('emailJsServiceId');
        const templateEl = document.getElementById('emailJsTemplateId');
        const resetTplEl = document.getElementById('emailJsResetTemplateId');
        const publicKeyEl = document.getElementById('emailJsPublicKey');

        if (serviceEl) serviceEl.value = serviceId;
        if (templateEl) templateEl.value = templateId;
        if (resetTplEl) resetTplEl.value = resetTemplateId;
        if (publicKeyEl) publicKeyEl.value = publicKey;
    } catch (e) {
        console.warn('âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª EmailJS Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„:', e?.message || e);
    }
}

// Ø¥ØªØ§Ø­Ø© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
window.toggleEmailSettings = toggleEmailSettings;
window.closeEmailSettingsModal = closeEmailSettingsModal;
window.saveEmailJsSettings = saveEmailJsSettings;

// ========================================
// ğŸ”¥ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ (LocalStorage ÙÙ‚Ø· - Ù…Ø¹Ø·Ù„ ÙÙŠ Firebase)
// ========================================
async function createDefaultUser() {
    const existingUsers = loadFromLocalStorage('diwan_users') || [];
    
    // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ LocalStorage
    if (existingUsers.length === 0) {
        const defaultUser = {
            id: 'admin-001',
            name: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…',
            email: 'admin@diwani.com',
            password: '123456',
            phone: '+966500000000',
            role: 'admin',
            activityId: null,
            createdAt: new Date().toISOString()
        };
        
        existingUsers.push(defaultUser);
        saveToLocalStorage('diwan_users', existingUsers);
        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ LocalStorage: admin@diwani.com / 123456');
        
        // âš ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Ù…Ø¹Ø·Ù„ - Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø¯Ø§Ø© Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ
        console.log('â„¹ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Firebase Ù…Ø¹Ø·Ù„ - Ù‚Ù… Ø¨Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        
        /* // ÙƒÙˆØ¯ Ø¥Ù†Ø´Ø§Ø¡ Firebase Ù…Ø¹Ø·Ù„
        if (USE_FIREBASE) {
            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const { signInWithEmailAndPassword } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                try {
                    await signInWithEmailAndPassword(auth, defaultUser.email, defaultUser.password);
                    console.log('â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Firebase');
                } catch (signInError) {
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡
                    if (signInError.code === 'auth/user-not-found' || signInError.code === 'auth/invalid-credential') {
                        const firebaseUser = await firebaseCreateUser(
                            defaultUser.email,
                            defaultUser.password,
                            {
                                id: defaultUser.id,
                                name: defaultUser.name,
                                email: defaultUser.email,
                                phone: defaultUser.phone,
                                role: defaultUser.role,
                                activityId: defaultUser.activityId
                            }
                        );
                        
                        if (firebaseUser) {
                            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Firebase');
                        }
                    }
                }
            } catch (error) {
                console.log('â„¹ï¸ ØªØ®Ø·ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase:', error.message);
            }
        }
        */ // Ù†Ù‡Ø§ÙŠØ© ÙƒÙˆØ¯ Firebase Ø§Ù„Ù…Ø¹Ø·Ù„
    }
}

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª =====
let notifications = [];
let trashBin = {
    items: [],
    customers: [],
    suppliers: [],
    purchases: [],
    sales: [],
    expenses: [],
    revenues: [],
    salaries: [],
    advances: []
};
const LOW_STOCK_THRESHOLD = 5; // Ø­Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†

// ===== ØªÙƒÙˆÙŠÙ† EmailJS Ø§Ù„Ø«Ø§Ø¨Øª (Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø£Ø¯Ù†Ø§Ù‡ Ø«Ù… ÙØ¹Ù‘Ù„ Ø§Ù„Ø¹Ù„Ù… EMAILJS_FIXED) =====
const EMAILJS_FIXED = false; // true = Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø© Ø£Ø¯Ù†Ø§Ù‡ ÙˆØ¹Ø¯Ù… Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯

const EMAILJS_DEFAULTS = {
    serviceID: 'service_hu6ucxi',
    templateID: 'template_cwep9ok',
    publicKey: '-FKicwCTdzG90IoY6'
};
let emailJsConfig = { ...EMAILJS_DEFAULTS };

// ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
function loadSavedEmailSettings() {
    try {
        const savedConfig = localStorage.getItem('diwan_email_config');
        if (savedConfig) {
            const config = JSON.parse(savedConfig);
            Object.assign(emailJsConfig, config);
            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©');
        }
    } catch (error) {
        console.warn('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯:', error);
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙˆØ±Ø§Ù‹
loadSavedEmailSettings();
    // ===== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ´ÙÙŠØ± Ù„Ù„Ø£Ù…Ø§Ù† =====
    async function hashPassword(password) {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… SHA-256 Ù„ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        const msgBuffer = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    }

    async function verifyPassword(inputPassword, hashedPassword) {
        const inputHash = await hashPassword(inputPassword);
        return inputHash === hashedPassword;
    }

    // ===== Ù†Ø¸Ø§Ù… Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ =====
    function showLoading(message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
        let loader = document.getElementById('global-loader');
        if (!loader) {
            loader = document.createElement('div');
            loader.id = 'global-loader';
            loader.innerHTML = `
                <div class="loader-overlay">
                    <div class="loader-content">
                        <div class="spinner"></div>
                        <p class="loader-message">${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loader);
            loader.style.display = 'block';
        } else {
            loader.querySelector('.loader-message').textContent = message;
            loader.style.display = 'block';
        }
    }

    function hideLoading() {
        const loader = document.getElementById('global-loader');
        if (loader) {
            loader.style.display = 'none';
        }
    }

    function updateLoadingMessage(message) {
        const loader = document.getElementById('global-loader');
        if (loader) {
            loader.querySelector('.loader-message').textContent = message;
        }
    }

    // ===== Ù†Ø¸Ø§Ù… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… =====
    function logError(context, error, showToUser = true) {
        const timestamp = new Date().toISOString();
        const errorLog = {
            timestamp,
            context,
            error: error.message || error,
            stack: error.stack || 'No stack trace'
        };
        
        console.error('ğŸ”´ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…:', errorLog);
        
        // Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ localStorage Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
        try {
            let errorLogs = JSON.parse(localStorage.getItem('systemErrors') || '[]');
            errorLogs.push(errorLog);
            // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 50 Ø®Ø·Ø£ ÙÙ‚Ø·
            if (errorLogs.length > 50) errorLogs = errorLogs.slice(-50);
            localStorage.setItem('systemErrors', JSON.stringify(errorLogs));
        } catch (e) {
            console.error('ÙØ´Ù„ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:', e);
        }
        
        if (showToUser) {
            showNotification(
                'âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…',
                `${error.message || error}\n\nÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.`,
                'error',
                8000
            );
        }
    }

    async function safeAsyncOperation(operation, context, loadingMessage = null) {
        try {
            if (loadingMessage) showLoading(loadingMessage);
            const result = await operation();
            return { success: true, data: result };
        } catch (error) {
            logError(context, error);
            return { success: false, error: error.message || error };
        } finally {
            if (loadingMessage) hideLoading();
        }
    }

    // ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =====
    function showNotification(title, message, type = 'info', duration = 5000) {
        const container = document.getElementById('notifications-container') || createNotificationContainer();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø·Ø§Ø¨Ù‚ Ù…Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹
        const existingNotifications = container.querySelectorAll('.notification');
        for (let existingNotif of existingNotifications) {
            const existingTitle = existingNotif.querySelector('.notification-title')?.textContent;
            const existingMessage = existingNotif.querySelector('.notification-message')?.textContent;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø·Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ø§Ù‹ØŒ Ù„Ø§ Ù†Ø¶ÙŠÙ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯
            if (existingTitle === title && existingMessage === message && existingNotif.classList.contains(type)) {
                // Ù†Ø¹ÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                return existingNotif;
            }
        }
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const icons = {
            success: 'âœ…',
            warning: 'âš ï¸',
            error: 'âŒ',
            info: 'â„¹ï¸'
        };
        
        notification.innerHTML = `
            <div class="notification-icon">${icons[type]}</div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <div class="notification-close" onclick="closeNotification(this)">âœ–</div>
        `;
        
        container.appendChild(notification);
        
        // Ø¥Ø²Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        setTimeout(() => {
            if (notification.parentElement) {
                closeNotification(notification.querySelector('.notification-close'));
            }
        }, duration);
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        notifications.push({
            id: Date.now(),
            title,
            message,
            type,
            timestamp: new Date().toISOString()
        });
        
        return notification;
    }

    function createNotificationContainer() {
        const container = document.createElement('div');
        container.id = 'notifications-container';
        document.body.appendChild(container);
        return container;
    }

    function closeNotification(closeButton) {
        const notification = closeButton.closest('.notification');
        notification.classList.add('removing');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }

    // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„Ø¨ØµØ±ÙŠØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ =====
    
    /**
     * ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø± Ø¹Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
     * @param {string} formSelector - Ù…Ø­Ø¯Ø¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ù…Ø«Ù„: '#itemForm')
     * @param {string} firstFieldId - Ù…Ø¹Ø±Ù Ø£ÙˆÙ„ Ø­Ù‚Ù„ Ù„Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„ÙŠÙ‡
     * @param {string} titleSelector - Ù…Ø­Ø¯Ø¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
     * @param {string} titleText - Ù†Øµ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
     */
    function applyEditMode(formSelector, firstFieldId, titleSelector = null, titleText = null) {
        const form = document.querySelector(formSelector);
        if (!form) return;
        
        // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ù„Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø± Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
        const formInputs = form.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            input.classList.add('editing-mode');
            // Ø¥Ø²Ø§Ù„Ø© readonly Ùˆ disabled Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
            input.removeAttribute('readonly');
            input.removeAttribute('disabled');
            input.disabled = false;
            input.readOnly = false;
        });
        
        // ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¥Ù† ÙˆØ¬Ø¯
        if (titleSelector && titleText) {
            const titleElement = document.querySelector(titleSelector);
            if (titleElement) {
                titleElement.innerHTML = titleText;
                titleElement.style.color = '#28a745';
            }
        }
        
        // ØªØºÙŠÙŠØ± Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
        const submitBtn = form.querySelector('.btn-primary');
        if (submitBtn && !submitBtn.innerHTML.includes('ØªØ­Ø¯ÙŠØ«')) {
            submitBtn.setAttribute('data-original-text', submitBtn.innerHTML);
            submitBtn.innerHTML = 'ğŸ”„ ØªØ­Ø¯ÙŠØ«';
            submitBtn.classList.add('update-mode');
        }
        
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
        form.scrollIntoView({ behavior: 'smooth' });
        
        // Ù†Ù‚Ù„ Ø§Ù„Ù…Ø¤Ø´Ø± Ù„Ù„Ø­Ù‚Ù„ Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
        setTimeout(() => {
            const firstField = document.getElementById(firstFieldId);
            if (firstField) {
                firstField.focus();
                if (firstField.type === 'text' || firstField.tagName === 'TEXTAREA') {
                    firstField.select();
                }
            }
        }, 500);
    }
    
    /**
     * Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
     * @param {string} formSelector - Ù…Ø­Ø¯Ø¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
     * @param {string} titleSelector - Ù…Ø­Ø¯Ø¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
     * @param {string} originalTitleText - Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
     */
    function removeEditMode(formSelector, titleSelector = null, originalTitleText = null) {
        const form = document.querySelector(formSelector);
        if (!form) return;
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
        const formInputs = form.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            input.classList.remove('editing-mode');
        });
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£ØµÙ„ÙŠ
        if (titleSelector && originalTitleText) {
            const titleElement = document.querySelector(titleSelector);
            if (titleElement) {
                titleElement.innerHTML = originalTitleText;
                titleElement.style.color = '';
            }
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„ÙŠ
        const submitBtn = form.querySelector('.btn-primary');
        if (submitBtn) {
            const originalText = submitBtn.getAttribute('data-original-text');
            if (originalText) {
                submitBtn.innerHTML = originalText;
                submitBtn.removeAttribute('data-original-text');
            }
            submitBtn.classList.remove('update-mode');
        }
    }
    
    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙ‚Ø·
     * @returns {Promise<boolean>} - true Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„ØŒ false Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡
     */
    async function confirmCancelItemEdit() {
        const form = document.querySelector('#items');
        if (!form) return true;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ù‚ÙˆÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙ‚Ø·
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            const confirmed = await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ†Ø§ÙØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            return confirmed;
        }
        return true;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙ‚Ø·
     * @returns {Promise<boolean>} - true Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„ØŒ false Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡
     */
    async function confirmCancelCustomerEdit() {
        const form = document.querySelector('#customers');
        if (!form) return true;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ù‚ÙˆÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙ‚Ø·
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            const confirmed = await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            return confirmed;
        }
        return true;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙÙ‚Ø·
     */
    async function confirmCancelSupplierEdit() {
        const form = document.querySelector('#suppliers');
        if (!form) return true;
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            return await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†ØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
        }
        return true;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙÙ‚Ø·
     */
    async function confirmCancelExpenseEdit() {
        const form = document.querySelector('#expenses');
        if (!form) return true;
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            return await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§ØªØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
        }
        return true;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙÙ‚Ø·
     */
    async function confirmCancelRevenueEdit() {
        const form = document.querySelector('#revenues');
        if (!form) return true;
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            return await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§ØªØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
        }
        return true;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙÙ‚Ø·
     */
    async function confirmCancelSalaryEdit() {
        const form = document.querySelector('#salaries');
        if (!form) return true;
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            return await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨ØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
        }
        return true;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø£ØµÙˆÙ„ ÙÙ‚Ø·
     */
    async function confirmCancelAssetEdit() {
        const form = document.querySelector('#assets');
        if (!form) return true;
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            return await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø£ØµÙˆÙ„ØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
        }
        return true;
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù ÙÙ‚Ø·
     */
    async function confirmCancelAdvanceEdit() {
        const form = document.querySelector('#advances');
        if (!form) return true;
        const editingFields = form.querySelectorAll('.editing-mode');
        if (editingFields.length > 0) {
            return await showConfirmDialog({
                title: 'Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„ÙØŸ\nØ³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
        }
        return true;
    }

    function checkLowStock() {
        const lowStockItems = items.filter(item => item.stock <= LOW_STOCK_THRESHOLD && item.stock > 0);
        const outOfStockItems = items.filter(item => item.stock <= 0);
        
        if (outOfStockItems.length > 0) {
            showNotification(
                'ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡: Ø£ØµÙ†Ø§Ù Ù†ÙØ°Øª',
                `${outOfStockItems.length} ØµÙ†Ù Ù†ÙØ° Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ²ÙˆÙŠØ¯ ÙÙˆØ±Ø§Ù‹.`,
                'error',
                8000
            );
        }
        
        if (lowStockItems.length > 0) {
            showNotification(
                'âš ï¸ ØªØ­Ø°ÙŠØ±: Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶',
                `${lowStockItems.length} ØµÙ†Ù Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ù†ÙØ§Ø¯ (Ø£Ù‚Ù„ Ù…Ù† ${LOW_STOCK_THRESHOLD} ÙˆØ­Ø¯Ø§Øª).`,
                'warning',
                7000
            );
        }
    }

    function checkUnpaidDebts() {
        const unpaidSales = sales.filter(s => {
            const totalPaid = getTotalPaid(s.id, 'sale');
            const remaining = s.total - totalPaid;
            return remaining > 0.5; // ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø£ÙƒØ«Ø± Ù…Ù† 0.5
        });
        
        const totalDebt = unpaidSales.reduce((sum, s) => {
            const totalPaid = getTotalPaid(s.id, 'sale');
            return sum + (s.total - totalPaid);
        }, 0);
        
        if (unpaidSales.length > 0) {
            showNotification(
                'ğŸ’° ØªØ°ÙƒÙŠØ±: Ø¯ÙŠÙˆÙ† ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©',
                `Ù„Ø¯ÙŠÙƒ ${unpaidSales.length} ÙØ§ØªÙˆØ±Ø© Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${totalDebt.toFixed(2)} Ø±.Ø³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©.`,
                'warning',
                6000
            );
        }
    }
    
    // ğŸ’° ÙØ­Øµ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© (Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯)
    function checkOverduePayments() {
        const today = new Date();
        const overdueThreshold = 30; // Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ù„Ù„Ø§Ø¹ØªØ¨Ø§Ø± ÙƒÙ…ØªØ£Ø®Ø±
        
        const overdueSales = sales.filter(sale => {
            const totalPaid = getTotalPaid(sale.id, 'sale');
            const remaining = sale.total - totalPaid;
            
            if (remaining <= 0.5) return false; // ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
            
            const saleDate = new Date(sale.date);
            const daysDiff = Math.floor((today - saleDate) / (1000 * 60 * 60 * 24));
            
            return daysDiff > overdueThreshold;
        });
        
        if (overdueSales.length > 0) {
            const totalOverdue = overdueSales.reduce((sum, sale) => {
                const totalPaid = getTotalPaid(sale.id, 'sale');
                return sum + (sale.total - totalPaid);
            }, 0);
            
            showNotification(
                'ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡: Ø¯ÙŠÙˆÙ† Ù…ØªØ£Ø®Ø±Ø©',
                `Ù„Ø¯ÙŠÙƒ ${overdueSales.length} ÙØ§ØªÙˆØ±Ø© Ù…ØªØ£Ø®Ø±Ø© Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${totalOverdue.toFixed(2)} Ø±.Ø³ (Ø£ÙƒØ«Ø± Ù…Ù† ${overdueThreshold} ÙŠÙˆÙ…)`,
                'error',
                8000
            );
        }
        
        // ÙØ­Øµ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„ØªØ£Ø®Ø± (15-30 ÙŠÙˆÙ…)
        const upcomingOverdue = sales.filter(sale => {
            const totalPaid = getTotalPaid(sale.id, 'sale');
            const remaining = sale.total - totalPaid;
            
            if (remaining <= 0.5) return false;
            
            const saleDate = new Date(sale.date);
            const daysDiff = Math.floor((today - saleDate) / (1000 * 60 * 60 * 24));
            
            return daysDiff >= 15 && daysDiff <= overdueThreshold;
        });
        
        if (upcomingOverdue.length > 0) {
            showNotification(
                'âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¯ÙŠÙˆÙ† Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„ØªØ£Ø®Ø±',
                `Ù„Ø¯ÙŠÙƒ ${upcomingOverdue.length} ÙØ§ØªÙˆØ±Ø© Ù„Ù… ÙŠØªÙ… Ø³Ø¯Ø§Ø¯Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù†Ø° 15-30 ÙŠÙˆÙ…`,
                'warning',
                6000
            );
        }
    }

    // ===== Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª =====
    function moveToTrash(type, item) {
        if (!trashBin[type]) trashBin[type] = [];
        
        const trashItem = {
            ...item,
            deletedAt: new Date().toISOString(),
            deletedBy: JSON.parse(sessionStorage.getItem('loggedInUser'))?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
            type: type
        };
        
        trashBin[type].push(trashItem);
        saveTrashToLocalStorage();
        
        showNotification(
            'ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
            `ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…Ø§Ù‹.`,
            'info',
            4000
        );
        
        // ØªØ­Ø¯ÙŠØ« Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
        refreshTrashModalIfOpen(type);
        
        return true;
    }

    function restoreFromTrash(type, itemId) {
        const itemIndex = trashBin[type].findIndex(item => item.id === itemId);
        if (itemIndex === -1) return false;
        
        const item = trashBin[type][itemIndex];
        trashBin[type].splice(itemIndex, 1);
        
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        const { deletedAt, deletedBy, type: itemType, ...originalItem } = item;
        
        switch(type) {
            case 'items': items.push(originalItem); break;
            case 'customers': customers.push(originalItem); break;
            case 'suppliers': suppliers.push(originalItem); break;
            case 'purchases': purchases.push(originalItem); break;
            case 'sales': sales.push(originalItem); break;
            case 'expenses': expenses.push(originalItem); break;
            case 'revenues': revenues.push(originalItem); break;
            case 'salaries': salaries.push(originalItem); break;
        }
        
        saveTrashToLocalStorage();
        showNotification(
            'âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
            'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­.',
            'success'
        );
        
        // ØªØ­Ø¯ÙŠØ« Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
        refreshTrashModalIfOpen(type);
        
        return true;
    }

    async function permanentlyDelete(type, itemId) {
        const confirmed = await showConfirmDialog({
            title: 'âš ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ',
            message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ\nâŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!',
            type: 'danger',
            confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
            cancelText: 'Ø¥Ù„ØºØ§Ø¡',
            icon: 'ğŸš«'
        });
        
        if (!confirmed) {
            return false;
        }
        
        const itemIndex = trashBin[type].findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            trashBin[type].splice(itemIndex, 1);
            saveTrashToLocalStorage();
            showNotification(
                'ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
                'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ.',
                'info'
            );
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
            refreshTrashModalIfOpen(type);
            
            return true;
        }
        return false;
    }

    function saveTrashToLocalStorage() {
        const key = currentActivityId ? `trash_${currentActivityId}` : 'trash_global';
        localStorage.setItem(key, JSON.stringify(trashBin));
    }

    function loadTrashFromLocalStorage() {
        const key = currentActivityId ? `trash_${currentActivityId}` : 'trash_global';
        const saved = localStorage.getItem(key);
        if (saved) {
            trashBin = JSON.parse(saved);
            cleanOldTrashItems();
        }
    }

    function cleanOldTrashItems() {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        Object.keys(trashBin).forEach(type => {
            trashBin[type] = trashBin[type].filter(item => {
                const deletedDate = new Date(item.deletedAt);
                return deletedDate > thirtyDaysAgo;
            });
        });
        
        saveTrashToLocalStorage();
    }

    function getTrashCount() {
        let count = 0;
        Object.keys(trashBin).forEach(type => {
            count += (trashBin[type] || []).length;
        });
        return count;
    }

    function refreshTrashModalIfOpen(type) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ù…ÙØªÙˆØ­Ø©
        const trashModal = document.getElementById('trash-modal');
        if (trashModal && trashModal.classList.contains('active')) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
            updateTrashBadge();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù„Ù„Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
            // Ù†Ø¬Ø¯ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø·
            const activeTab = document.querySelector('.trash-tab.active');
            if (activeTab) {
                // Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† onclick attribute
                const onclickAttr = activeTab.getAttribute('onclick');
                const match = onclickAttr.match(/renderTrashItems\('([^']+)'\)/);
                if (match) {
                    const currentType = match[1];
                    renderTrashItems(currentType);
                }
            }
        }
    }

    function showTrashModal() {
        loadTrashFromLocalStorage();
        document.getElementById('trash-modal').classList.add('active');
        renderTrashItems('items');
    }

    function closeTrashModal() {
        document.getElementById('trash-modal').classList.remove('active');
    }

    function renderTrashItems(type) {
        const container = document.getElementById('trash-items-container');
        const items = trashBin[type] || [];
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø´Ø·Ø©
        document.querySelectorAll('.trash-tab').forEach(tab => tab.classList.remove('active'));
        event?.target?.classList.add('active');
        
        if (items.length === 0) {
            container.innerHTML = `
                <div class="trash-empty-state">
                    <i>ğŸ—‘ï¸</i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = items.map(item => {
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹Ù‡
            let displayName = item.name || item.code || 'Ø¹Ù†ØµØ±';
            if (type === 'purchases' || type === 'sales' || type === 'salesReturns' || type === 'purchaseReturns') {
                displayName = `ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… ${item.id} - ${item.date || ''}`;
            }
            
            return `
                <div class="trash-item">
                    <div class="trash-item-info">
                        <div class="trash-item-name">${displayName}</div>
                        <div class="trash-item-meta">
                            Ø­Ø°Ù Ø¨ÙˆØ§Ø³Ø·Ø©: ${item.deletedBy} | 
                            ${formatDate(item.deletedAt)}
                        </div>
                    </div>
                    <div class="trash-item-actions">
                        <button class="btn-success btn-sm" onclick="restoreItem('${type}', ${item.id})">
                            â†º Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                        </button>
                        <button class="btn-danger btn-sm" onclick="deleteItemPermanently('${type}', ${item.id})">
                            ğŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function restoreItem(type, itemId) {
        if (restoreFromTrash(type, itemId)) {
            // Ø®Ø±ÙŠØ·Ø© Ø¢Ù…Ù†Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† eval()
            const dataMap = {
                'items': items,
                'customers': customers,
                'suppliers': suppliers,
                'purchases': purchases,
                'sales': sales,
                'expenses': expenses,
                'revenues': revenues,
                'salesReturns': salesReturns,
                'purchaseReturns': purchaseReturns
            };
            
            saveToLocalStorage(type, dataMap[type]);
            renderTrashItems(type);
            updateDashboard();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            switch(type) {
                case 'items': renderItems(); break;
                case 'customers': renderCustomers(); break;
                case 'suppliers': renderSuppliers(); break;
                case 'purchases': renderPurchasesList(); break;
                case 'sales': renderSalesList(); break;
                case 'expenses': renderExpenses(); break;
                case 'revenues': renderRevenues(); break;
                case 'salesReturns': renderSalesReturns(); break;
                case 'purchaseReturns': renderPurchaseReturns(); break;
            }
            
            showNotification('âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', `ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© ${getTypeNameAr(type)} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        }
    }

    function deleteItemPermanently(type, itemId) {
        if (permanentlyDelete(type, itemId)) {
            renderTrashItems(type);
        }
    }

    function emptyTrash(type) {
        if (!confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙØ±Ø§Øº Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ù„Ù€ ${getTypeNameAr(type)}ØŸ`)) {
            return;
        }
        
        trashBin[type] = [];
        saveTrashToLocalStorage();
        renderTrashItems(type);
        showNotification(
            'ğŸ—‘ï¸ ØªÙ… Ø¥ÙØ±Ø§Øº Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
            `ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± ${getTypeNameAr(type)} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`,
            'success'
        );
    }

    function getTypeNameAr(type) {
        const names = {
            items: 'Ø§Ù„Ø£ØµÙ†Ø§Ù',
            customers: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',
            suppliers: 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†',
            purchases: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
            sales: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
            expenses: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
            revenues: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',
            salesReturns: 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
            purchaseReturns: 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
            salaries: 'Ø§Ù„Ø±ÙˆØ§ØªØ¨'
        };
        return names[type] || type;
    }

    function updateTrashBadge() {
        const totalCount = getTrashCount();
        const badge = document.getElementById('trash-count-badge');
        
        if (badge) {
            if (totalCount > 0) {
                badge.textContent = totalCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
        ['items', 'customers', 'suppliers', 'purchases', 'sales', 'expenses', 'revenues', 'salesReturns', 'purchaseReturns'].forEach(type => {
            const el = document.getElementById(`trash-count-${type}`);
            if (el) el.textContent = (trashBin[type] || []).length;
        });
        
        const totalEl = document.getElementById('trash-count-total');
        if (totalEl) totalEl.textContent = totalCount;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return 'Ø§Ù„ÙŠÙˆÙ…';
        if (diffDays === 1) return 'Ø£Ù…Ø³';
        if (diffDays < 7) return `Ù…Ù†Ø° ${diffDays} Ø£ÙŠØ§Ù…`;
        if (diffDays < 30) return `Ù…Ù†Ø° ${Math.floor(diffDays / 7)} Ø£Ø³Ø§Ø¨ÙŠØ¹`;
        return date.toLocaleDateString('ar-SA');
    }

    // ===== Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… =====
    
    /**
     * Ù†Ø¸Ø§Ù… Ø´Ø§Ù…Ù„ Ù„ÙÙ„ØªØ±Ø© ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
     */
    const FilterSortHelper = {
        // Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ÙƒÙ„ Ù‚Ø³Ù…
        currentFilters: {},
        
        // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ÙƒÙ„ Ù‚Ø³Ù…
        currentSort: {},
        
        /**
         * ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
         * @param {Array} data - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ÙÙ„ØªØ±ØªÙ‡Ø§
         * @param {Object} filters - Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ±Ø©
         * @returns {Array} - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
         */
        applyFilters(data, filters) {
            if (!data || !Array.isArray(data)) return [];
            
            return data.filter(item => {
                // ÙÙ„ØªØ±Ø© Ø§Ù„Ù†Øµ (Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…)
                if (filters.searchText) {
                    const searchLower = filters.searchText.toLowerCase();
                    const matchFound = Object.values(item).some(value => 
                        value && value.toString().toLowerCase().includes(searchLower)
                    );
                    if (!matchFound) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…Ù†)
                if (filters.dateFrom && item.date) {
                    if (new Date(item.date) < new Date(filters.dateFrom)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø¥Ù„Ù‰)
                if (filters.dateTo && item.date) {
                    if (new Date(item.date) > new Date(filters.dateTo)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø± (Ù…Ù†)
                if (filters.priceFrom !== undefined && filters.priceFrom !== '' && item.price !== undefined) {
                    if (parseFloat(item.price) < parseFloat(filters.priceFrom)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø± (Ø¥Ù„Ù‰)
                if (filters.priceTo !== undefined && filters.priceTo !== '' && item.price !== undefined) {
                    if (parseFloat(item.price) > parseFloat(filters.priceTo)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº (Ù…Ù†)
                if (filters.amountFrom !== undefined && filters.amountFrom !== '' && item.total !== undefined) {
                    if (parseFloat(item.total) < parseFloat(filters.amountFrom)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº (Ø¥Ù„Ù‰)
                if (filters.amountTo !== undefined && filters.amountTo !== '' && item.total !== undefined) {
                    if (parseFloat(item.total) > parseFloat(filters.amountTo)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© (Ù…Ù†)
                if (filters.quantityFrom !== undefined && filters.quantityFrom !== '' && item.quantity !== undefined) {
                    if (parseFloat(item.quantity) < parseFloat(filters.quantityFrom)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© (Ø¥Ù„Ù‰)
                if (filters.quantityTo !== undefined && filters.quantityTo !== '' && item.quantity !== undefined) {
                    if (parseFloat(item.quantity) > parseFloat(filters.quantityTo)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©/Ø§Ù„Ù†ÙˆØ¹
                if (filters.status && item.status) {
                    if (item.status !== filters.status) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
                if (filters.category && item.category) {
                    if (item.category !== filters.category) return false;
                }
                
                return true;
            });
        },
        
        /**
         * ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø¹Ù…ÙˆØ¯ Ù…Ø¹ÙŠÙ†
         * @param {Array} data - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ±ØªÙŠØ¨Ù‡Ø§
         * @param {String} column - Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯
         * @param {String} direction - Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªØ±ØªÙŠØ¨ (asc/desc)
         * @returns {Array} - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø©
         */
        sortData(data, column, direction = 'asc') {
            if (!data || !Array.isArray(data)) return [];
            
            const sortedData = [...data].sort((a, b) => {
                let valueA = a[column];
                let valueB = b[column];
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ§Ø±ØºØ©
                if (valueA === null || valueA === undefined) valueA = '';
                if (valueB === null || valueB === undefined) valueB = '';
                
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
                if (!isNaN(valueA) && !isNaN(valueB)) {
                    valueA = parseFloat(valueA);
                    valueB = parseFloat(valueB);
                }
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
                else if (this.isDate(valueA) && this.isDate(valueB)) {
                    valueA = new Date(valueA);
                    valueB = new Date(valueB);
                }
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†ØµÙˆØµ
                else {
                    valueA = valueA.toString().toLowerCase();
                    valueB = valueB.toString().toLowerCase();
                }
                
                if (valueA < valueB) return direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            return sortedData;
        },
        
        /**
         * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© ØªØ§Ø±ÙŠØ®
         */
        isDate(value) {
            return value && !isNaN(Date.parse(value)) && /\d{4}-\d{2}-\d{2}/.test(value);
        },
        
        /**
         * Ø¥Ø¶Ø§ÙØ© Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ±ØªÙŠØ¨ Ù„Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
         * @param {String} tableId - Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„
         * @param {String} section - Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…
         * @param {Function} renderCallback - Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
         */
        makeSortable(tableId, section, renderCallback) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const headers = table.querySelectorAll('thead th.sortable');
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-column');
                    if (!column) return;
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªØ±ØªÙŠØ¨
                    let direction = 'asc';
                    if (this.currentSort[section]?.column === column) {
                        direction = this.currentSort[section].direction === 'asc' ? 'desc' : 'asc';
                    }
                    
                    // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±ØªÙŠØ¨
                    this.currentSort[section] = { column, direction };
                    
                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                    headers.forEach(h => {
                        h.classList.remove('asc', 'desc');
                    });
                    header.classList.add(direction);
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
                    if (renderCallback) renderCallback();
                });
            });
        },
        
        /**
         * Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø©
         */
        toggleFilters(filterId) {
            const filtersContainer = document.getElementById(filterId);
            if (filtersContainer) {
                filtersContainer.classList.toggle('show');
            }
        },
        
        /**
         * Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±
         */
        resetFilters(section, filterId) {
            this.currentFilters[section] = {};
            const filtersContainer = document.getElementById(filterId);
            if (filtersContainer) {
                const inputs = filtersContainer.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            }
        }
    };
    
    // ===== Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Input Validation) =====
    
    /**
     * Ù…Ø¬Ù…ÙˆØ¹Ø© Ø´Ø§Ù…Ù„Ø© Ù…Ù† Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
     */
    const ValidationHelper = {
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø­Ù‚Ù„ Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹
        required(value, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            if (!value || value.toString().trim() === '') {
                return `âŒ ${fieldName} Ù…Ø·Ù„ÙˆØ¨ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø·ÙˆÙ„
        minLength(value, min, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            if (value && value.toString().trim().length < min) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${min} Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·ÙˆÙ„
        maxLength(value, max, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            if (value && value.toString().length > max) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² ${max} Ø­Ø±ÙØ§Ù‹`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø±Ù‚Ù… ØµØ­ÙŠØ­
        isNumber(value, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            if (value !== '' && isNaN(parseFloat(value))) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨
        isPositive(value, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            const num = parseFloat(value);
            if (!isNaN(num) && num < 0) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹ Ù…ÙˆØ¬Ø¨Ø§Ù‹`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù‚Ù… Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±
        isGreaterThanZero(value, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            const num = parseFloat(value);
            if (!isNaN(num) && num <= 0) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù‚Ù… Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ Ù…Ø¹ÙŠÙ†
        inRange(value, min, max, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            const num = parseFloat(value);
            if (!isNaN(num) && (num < min || num > max)) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† ${min} Ùˆ ${max}`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        isEmail(value, fieldName = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') {
            if (value && value.trim() !== '') {
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailPattern.test(value)) {
                    return `âŒ ${fieldName} ØºÙŠØ± ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„: user@example.com)`;
                }
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ
        isSaudiPhone(value, fieldName = 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') {
            if (value && value.trim() !== '') {
                const phonePattern = /^(05|5)[0-9]{8}$/;
                if (!phonePattern.test(value.replace(/\s/g, ''))) {
                    return `âŒ ${fieldName} ØºÙŠØ± ØµØ­ÙŠØ­ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù…)`;
                }
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø©
        isUnique(value, list, field, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„', excludeId = null) {
            if (value && value.trim() !== '') {
                const exists = list.some(item => {
                    const isDifferentItem = excludeId ? item.id !== excludeId : true;
                    return isDifferentItem && item[field] && 
                           item[field].toString().toLowerCase() === value.toString().toLowerCase();
                });
                
                if (exists) {
                    return `âŒ ${fieldName} Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ…Ø© Ù…Ø®ØªÙ„ÙØ©`;
                }
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
        isValidDate(value, fieldName = 'Ø§Ù„ØªØ§Ø±ÙŠØ®') {
            if (value && value.trim() !== '') {
                const date = new Date(value);
                if (isNaN(date.getTime())) {
                    return `âŒ ${fieldName} ØºÙŠØ± ØµØ­ÙŠØ­`;
                }
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ÙŠØ³ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
        notFutureDate(value, fieldName = 'Ø§Ù„ØªØ§Ø±ÙŠØ®') {
            if (value && value.trim() !== '') {
                const date = new Date(value);
                const today = new Date();
                today.setHours(23, 59, 59, 999);
                
                if (date > today) {
                    return `âŒ ${fieldName} Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„`;
                }
            }
            return null;
        }
    };
    
    /**
     * Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ù†Ù…ÙˆØ°Ø¬
     * @param {Object} validations - ÙƒØ§Ø¦Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚
     * @returns {Object} - { isValid: boolean, errors: Array }
     */
    function validateForm(validations) {
        const errors = [];
        
        for (const [fieldId, rules] of Object.entries(validations)) {
            const element = document.getElementById(fieldId);
            if (!element) continue;
            
            const value = element.value;
            let hasError = false;
            
            // ØªØ·Ø¨ÙŠÙ‚ ÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© ØªØ­Ù‚Ù‚
            for (const rule of rules) {
                const error = rule.validator(value);
                if (error) {
                    errors.push({
                        fieldId,
                        element,
                        message: error
                    });
                    hasError = true;
                    break; // Ø¥ÙŠÙ‚Ø§Ù Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø®Ø·Ø£ Ù„ÙƒÙ„ Ø­Ù‚Ù„
                }
            }
            
            // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
            if (hasError) {
                element.classList.add('input-error');
                element.classList.remove('input-success');
            } else {
                element.classList.remove('input-error', 'input-success');
            }
        }
        
        return {
            isValid: errors.length === 0,
            errors
        };
    }
    
    /**
     * Ø¹Ø±Ø¶ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
     */
    function displayValidationErrors(errors) {
        if (errors.length === 0) return;
        
        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø­Ù‚Ù„ Ø®Ø§Ø·Ø¦
        if (errors[0].element) {
            errors[0].element.focus();
            errors[0].element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø¥Ø´Ø¹Ø§Ø±
        const errorMessages = errors.map(e => e.message).join('\n');
        showNotification(
            'âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ§Ù„ÙŠØ©',
            errorMessages,
            'error',
            6000
        );
    }
    
    /**
     * Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
     */
    function clearValidationStyles() {
        document.querySelectorAll('.input-error, .input-success').forEach(el => {
            el.classList.remove('input-error', 'input-success');
        });
    }

    // ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Professional Confirm Dialog) =====
    
    /**
     * Ø¹Ø±Ø¶ Ø­ÙˆØ§Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ø­ØªØ±Ø§ÙÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† confirm() Ø§Ù„Ø¹Ø§Ø¯ÙŠ
     * @param {Object} options - Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­ÙˆØ§Ø±
     * @param {string} options.title - Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­ÙˆØ§Ø±
     * @param {string} options.message - Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
     * @param {string} options.type - Ù†ÙˆØ¹ Ø§Ù„Ø­ÙˆØ§Ø± (warning, danger, info, success)
     * @param {string} options.confirmText - Ù†Øµ Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
     * @param {string} options.cancelText - Ù†Øµ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
     * @param {string} options.icon - Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­ÙˆØ§Ø±
     * @returns {Promise<boolean>} - true Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ØŒ false Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡
     */
    function showConfirmDialog(options = {}) {
        return new Promise((resolve) => {
            const {
                title = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',
                message = '<p style="margin: 0; line-height: 1.8; color: #555;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ</p>',
                type = 'warning', // warning, danger, info, success
                confirmText = 'ØªØ£ÙƒÙŠØ¯',
                cancelText = 'Ø¥Ù„ØºØ§Ø¡',
                icon = null,
                confirmButtonClass = '' // Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
            } = options;
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø­ÙˆØ§Ø±
            const overlay = document.getElementById('confirm-overlay');
            const header = document.getElementById('confirm-header');
            const iconEl = document.getElementById('confirm-icon');
            const titleEl = document.getElementById('confirm-title');
            const bodyEl = document.getElementById('confirm-body');
            const confirmBtn = document.getElementById('confirm-btn-confirm');
            const cancelBtn = document.getElementById('confirm-btn-cancel');
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            const icons = {
                warning: 'âš ï¸',
                danger: 'âŒ',
                info: 'â„¹ï¸',
                success: 'âœ…'
            };
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            iconEl.textContent = icon || icons[type] || 'âš ï¸';
            titleEl.textContent = title;
            bodyEl.innerHTML = message; // Ø§Ø³ØªØ®Ø¯Ø§Ù… innerHTML Ù„Ø¯Ø¹Ù… HTML
            confirmBtn.textContent = confirmText;
            cancelBtn.textContent = cancelText;
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙØ¦Ø§Øª - Ø§Ø³ØªØ®Ø¯Ø§Ù… confirmButtonClass Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            header.className = `confirm-header ${type}`;
            const buttonClass = confirmButtonClass || (type === 'danger' ? 'danger' : type === 'success' ? 'success' : '');
            confirmBtn.className = `confirm-btn-confirm ${buttonClass}`;
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø­ÙˆØ§Ø±
            overlay.classList.add('active');
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            const handleConfirm = () => {
                overlay.classList.remove('active');
                cleanup();
                resolve(true);
            };
            
            const handleCancel = () => {
                overlay.classList.remove('active');
                cleanup();
                resolve(false);
            };
            
            const handleOverlayClick = (e) => {
                if (e.target === overlay) {
                    handleCancel();
                }
            };
            
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    handleCancel();
                }
            };
            
            const cleanup = () => {
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
                overlay.removeEventListener('click', handleOverlayClick);
                document.removeEventListener('keydown', handleEscape);
            };
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
            overlay.addEventListener('click', handleOverlayClick);
            document.addEventListener('keydown', handleEscape);
        });
    }
    
    // ===== Ù†Ù‡Ø§ÙŠØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ =====

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    async function confirmCancelEdit(formSelector) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        const form = document.querySelector(formSelector);
        if (!form) return true;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø±Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        const editingId = form.getAttribute('data-editing-id');
        if (!editingId) return true; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
        
        // Ø¹Ø±Ø¶ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
        return await showConfirmDialog({
            title: 'âš ï¸ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„',
            message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØŸ\n\nØ³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.',
            type: 'warning',
            icon: 'âš ï¸',
            confirmText: 'Ù†Ø¹Ù…ØŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„',
            cancelText: 'Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„',
            confirmButtonClass: 'warning'
        });
    }

        // === Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ===

        function resolveStorageKey(key) {
            if (GLOBAL_STORAGE_KEYS.has(key)) {
                return key;
            }
            return currentActivityId ? `activity_${currentActivityId}_${key}` : key;
        }

        async function saveToLocalStorage(key, data) {
            try {
                const fullKey = resolveStorageKey(key);
                console.log(`ğŸ’¾ saveToLocalStorage: key="${key}" -> fullKey="${fullKey}", items=${Array.isArray(data) ? data.length : 'N/A'}`);
                
                // ØªØ´Ø®ÙŠØµ Ø®Ø§Øµ Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                if (key === 'diwan_users' && Array.isArray(data)) {
                    console.log('ğŸ“± ØªØ´Ø®ÙŠØµ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:');
                    data.forEach(user => {
                        if (user.phone) {
                            console.log(`  ğŸ“± ${user.email}: phone="${user.phone}" (${typeof user.phone}) - Ø·ÙˆÙ„: ${user.phone.length}`);
                        } else {
                            console.log(`  ğŸ“± ${user.email}: phone ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (${typeof user.phone})`);
                        }
                    });
                }
                
                // Ø­ÙØ¸ ÙÙŠ LocalStorage
                localStorage.setItem(fullKey, JSON.stringify(data));
                console.log(`âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ LocalStorage: ${fullKey}`);
                
                // ğŸ” ØªØ­Ù‚Ù‚ ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø­ÙØ¸ ÙÙŠ localStorage
                const immediateVerify = localStorage.getItem(fullKey);
                if (immediateVerify) {
                    const parsedVerify = JSON.parse(immediateVerify);
                    if (Array.isArray(parsedVerify) && Array.isArray(data)) {
                        if (parsedVerify.length === data.length) {
                            console.log(`âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­ (${parsedVerify.length} Ø¹Ù†ØµØ±)`);
                        } else {
                            console.error(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ ÙÙŠ Ø§Ù„Ø­ÙØ¸! Ù…Ø­ÙÙˆØ¸=${parsedVerify.length}, Ù…Ø·Ù„ÙˆØ¨=${data.length}`);
                        }
                    }
                } else {
                    console.error(`âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ localStorage!`);
                }
                
                // ØªØ­Ù‚Ù‚ ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø­ÙØ¸ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†) - ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù„Ø£Ù†Ù‡ Ù…ÙƒØ±Ø±
                if (key === 'diwan_users') {
                    const immediateCheck = JSON.parse(localStorage.getItem(fullKey) || '[]');
                    console.log('ğŸ” ØªØ­Ù‚Ù‚ ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø­ÙØ¸ ÙÙŠ localStorage:');
                    immediateCheck.forEach(user => {
                        if (user.phone) {
                            console.log(`  âœ… ${user.email}: phone="${user.phone}" Ù…Ø­ÙÙˆØ¸ Ø¨Ù†Ø¬Ø§Ø­`);
                        } else {
                            console.log(`  âš ï¸ ${user.email}: phone ÙØ§Ø±Øº ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©`);
                        }
                    });
                }
                
                // Ø­ÙØ¸ ÙÙŠ Firebase Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù‘Ù„Ø§Ù‹
                if (USE_FIREBASE && currentActivityId && !GLOBAL_STORAGE_KEYS.has(key)) {
                    console.log(`ğŸ”¥ Firebase: Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ ${key}...`);
                    console.log(`  - USE_FIREBASE: ${USE_FIREBASE}`);
                    console.log(`  - currentActivityId: ${currentActivityId}`);
                    console.log(`  - GLOBAL_STORAGE_KEYS.has('${key}'): ${GLOBAL_STORAGE_KEYS.has(key)}`);
                    console.log(`  - Array.isArray(data): ${Array.isArray(data)}`);
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­
                    const dataType = key;
                    const firebaseResult = await firebaseSaveActivityData(currentActivityId, dataType, data);
                    
                    if (firebaseResult) {
                        console.log(`âœ… Firebase: ØªÙ… Ø­ÙØ¸ ${dataType} Ø¨Ù†Ø¬Ø§Ø­`);
                        debugLog(`ğŸ”¥ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase: ${dataType}`);
                    } else {
                        console.error(`âŒ Firebase: ÙØ´Ù„ Ø­ÙØ¸ ${dataType}`);
                    }
                } else {
                    if (!USE_FIREBASE) {
                        console.log(`âš ï¸ ØªØ®Ø·ÙŠ Firebase: ØºÙŠØ± Ù…ÙØ¹Ù„`);
                    } else if (!currentActivityId) {
                        console.log(`âš ï¸ ØªØ®Ø·ÙŠ Firebase: currentActivityId ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
                    } else if (GLOBAL_STORAGE_KEYS.has(key)) {
                        console.log(`âš ï¸ ØªØ®Ø·ÙŠ Firebase: ${key} Ù…Ù† Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¹Ø§Ù…Ø©`);
                    }
                }
                
                return true;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                console.error('âŒ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.message, error.stack);
                return false;
            }
        }

        // ØªÙ… Ù†Ù‚Ù„ Ø¯Ø§Ù„Ø© loadFromLocalStorage Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª

        function removeFromLocalStorage(key) {
            try {
                const fullKey = resolveStorageKey(key);
                localStorage.removeItem(fullKey);
                return true;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
                return false;
            }
        }

        // ========================================
        // ğŸ“’ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© (Accounting Entries)
        // ========================================
        
        /**
         * ØªÙ‡ÙŠØ¦Ø© Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù…
         */
        function initializeChartOfAccounts() {
            console.log('ğŸ” Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª...');
            console.log('ğŸ“Š DEFAULT_CHART_OF_ACCOUNTS length:', DEFAULT_CHART_OF_ACCOUNTS?.length);
            
            const saved = loadFromLocalStorage('chartOfAccounts');
            console.log('ğŸ’¾ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', saved?.length);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ØªØªØ¨Ø¹ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø­Ø³Ø§Ø¨ 1121 - Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ)
            const isNewStructure = saved && saved.some(a => a.code === '1121');
            
            if (!saved || saved.length === 0 || !isNewStructure) {
                console.log('âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù‡ÙŠÙƒÙ„ Ø­Ø³Ø§Ø¨Ø§Øª Ù‚Ø¯ÙŠÙ… Ø£Ùˆ Ù…ÙÙ‚ÙˆØ¯. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯...');
                chartOfAccounts = JSON.parse(JSON.stringify(DEFAULT_CHART_OF_ACCOUNTS));
                saveToLocalStorage('chartOfAccounts', chartOfAccounts);
                console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ:', chartOfAccounts.length);
            } else {
                chartOfAccounts = saved;
                console.log(`ğŸ“‚ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª: ${chartOfAccounts.length} Ø­Ø³Ø§Ø¨`);
            }
            
            console.log('ğŸ¯ chartOfAccounts Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:', chartOfAccounts.length);
        }
        
        /**
         * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙƒÙˆØ¯
         */
        function getAccountByCode(code) {
            return chartOfAccounts.find(acc => acc.code === code);
        }
        
        /**
         * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø§Ø³Ù…
         */
        function getAccountByName(name) {
            return chartOfAccounts.find(acc => acc.name === name);
        }
        
        /**
         * ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø­Ø³Ø§Ø¨
         */
        async function updateAccountBalance(accountCode, debit, credit) {
            const account = getAccountByCode(accountCode);
            if (!account) {
                console.error(`âŒ Ø§Ù„Ø­Ø³Ø§Ø¨ ${accountCode} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
                return false;
            }
            
            account.debit += debit;
            account.credit += credit;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨
            if (account.category === 'asset' || account.category === 'expense') {
                // Ø§Ù„Ø£ØµÙˆÙ„ ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª: Ø§Ù„Ù…Ø¯ÙŠÙ† - Ø§Ù„Ø¯Ø§Ø¦Ù†
                account.balance = account.debit - account.credit;
            } else {
                // Ø§Ù„Ø®ØµÙˆÙ… ÙˆØ­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© ÙˆØ§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: Ø§Ù„Ø¯Ø§Ø¦Ù† - Ø§Ù„Ù…Ø¯ÙŠÙ†
                account.balance = account.credit - account.debit;
            }
            
            await saveToLocalStorage('chartOfAccounts', chartOfAccounts);
            return true;
        }
        
        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø¬Ø¯ÙŠØ¯
         */
        async function createJournalEntry(data) {
            const entry = {
                id: Date.now(),
                date: data.date || new Date().toISOString().split('T')[0],
                description: data.description,
                reference: data.reference || null, // Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
                referenceType: data.referenceType || null, // Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (sale, purchase, expense, etc)
                entries: data.entries, // Ù…ØµÙÙˆÙØ© Ù…Ù† {accountCode, accountName, debit, credit}
                total: data.total,
                createdBy: data.createdBy || window.currentUser?.name || 'Ø§Ù„Ù†Ø¸Ø§Ù…',
                createdAt: new Date().toISOString(),
                approved: data.approved !== false, // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù…Ø¹ØªÙ…Ø¯
                notes: data.notes || ''
            };
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆØ§Ø²Ù† Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ
            const totalDebit = entry.entries.reduce((sum, e) => sum + e.debit, 0);
            const totalCredit = entry.entries.reduce((sum, e) => sum + e.credit, 0);
            
            if (Math.abs(totalDebit - totalCredit) > 0.01) {
                console.error('âŒ Ø§Ù„Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†:', { totalDebit, totalCredit });
                showNotification('âŒ Ø®Ø·Ø£', 'Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù† (Ø§Ù„Ù…Ø¯ÙŠÙ† â‰  Ø§Ù„Ø¯Ø§Ø¦Ù†)', 'error');
                return null;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
            for (const e of entry.entries) {
                await updateAccountBalance(e.accountCode, e.debit, e.credit);
            }
            
            // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯
            console.log('ğŸ“’ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ:', entry.id, entry.description);
            journalEntries.unshift(entry);
            console.log(`ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${journalEntries.length}`);
            
            const saveResult = await saveToLocalStorage('journalEntries', journalEntries);
            console.log(`ğŸ’¾ Ù†ØªÙŠØ¬Ø© Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙˆØ¯: ${saveResult ? 'âœ… Ù†Ø¬Ø­' : 'âŒ ÙØ´Ù„'}`);
            
            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ:', entry.id);
            return entry;
        }
        
        /**
         * Ø­Ø°Ù Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ (Ø¹ÙƒØ³ Ø§Ù„Ù‚ÙŠØ¯)
         */
        async function deleteJournalEntry(entryId) {
            const entry = journalEntries.find(e => e.id === entryId);
            if (!entry) {
                console.error('âŒ Ø§Ù„Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return false;
            }
            
            // Ø¹ÙƒØ³ Ø§Ù„Ù‚ÙŠØ¯ (Ø¹ÙƒØ³ Ø§Ù„Ù…Ø¯ÙŠÙ† ÙˆØ§Ù„Ø¯Ø§Ø¦Ù†)
            for (const e of entry.entries) {
                await updateAccountBalance(e.accountCode, -e.debit, -e.credit);
            }
            
            // Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ¯
            journalEntries = journalEntries.filter(e => e.id !== entryId);
            await saveToLocalStorage('journalEntries', journalEntries);
            
            console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ:', entryId);
            return true;
        }
        
        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª
         */
        async function createSaleJournalEntry(sale) {
            const total = sale.total || 0;
            const paidAmount = sale.paidAmount || 0;
            const remainingAmount = total - paidAmount;
            const customer = customers.find(c => c.id === sale.customerId);
            const customerName = customer ? customer.name : 'Ø¹Ù…ÙŠÙ„';
            
            const entries = [];
            
            // Ù…Ù† Ø­Ù€/ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚/Ø§Ù„Ø¨Ù†Ùƒ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…)
            if (paidAmount > 0) {
                if (sale.paymentMethod === 'bank') {
                    entries.push({
                        accountCode: '1121',
                        accountName: 'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ',
                        debit: paidAmount,
                        credit: 0
                    });
                } else {
                    // cash Ø£Ùˆ Ø£ÙŠ Ø·Ø±ÙŠÙ‚Ø© Ø¯ÙØ¹ Ø£Ø®Ø±Ù‰
                    entries.push({
                        accountCode: '1111',
                        accountName: 'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',
                        debit: paidAmount,
                        credit: 0
                    });
                }
            }
            
            // Ù…Ù† Ø­Ù€/ Ø§Ù„Ù…Ø¯ÙŠÙ†ÙˆÙ† (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡) - Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
            if (remainingAmount > 0) {
                entries.push({
                    accountCode: '1131',
                    accountName: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø¹Ø§Ù…)',
                    debit: remainingAmount,
                    credit: 0
                });
            }
            
            // Ø¥Ù„Ù‰ Ø­Ù€/ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)
            entries.push({
                accountCode: '4111',
                accountName: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                debit: 0,
                credit: total
            });
            
            return await createJournalEntry({
                date: sale.date,
                description: `ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ø±Ù‚Ù… SAL${String(sale.number).padStart(3, '0')} - ${customerName}${paidAmount > 0 && remainingAmount > 0 ? ' (Ù…Ù‚Ø³Ø·Ø©)' : ''}`,
                reference: sale.id,
                referenceType: 'sale',
                entries: entries,
                total: total,
                notes: sale.notes || ''
            });
        }
        
        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª
         */
        async function createPurchaseJournalEntry(purchase) {
            const total = purchase.total || 0;
            const paidAmount = purchase.paidAmount || 0;
            const remainingAmount = total - paidAmount;
            const supplier = suppliers.find(s => s.id === purchase.supplierId);
            const supplierName = supplier ? supplier.name : 'Ù…ÙˆØ±Ø¯';
            
            const entries = [];
            
            // Ù…Ù† Ø­Ù€/ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)
            entries.push({
                accountCode: '5211',
                accountName: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
                debit: total,
                credit: 0
            });
            
            // Ø¥Ù„Ù‰ Ø­Ù€/ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚/Ø§Ù„Ø¨Ù†Ùƒ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹)
            if (paidAmount > 0) {
                if (purchase.paymentMethod === 'bank') {
                    entries.push({
                        accountCode: '1121',
                        accountName: 'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ',
                        debit: 0,
                        credit: paidAmount
                    });
                } else {
                    entries.push({
                        accountCode: '1111',
                        accountName: 'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',
                        debit: 0,
                        credit: paidAmount
                    });
                }
            }
            
            // Ø¥Ù„Ù‰ Ø­Ù€/ Ø§Ù„Ø¯Ø§Ø¦Ù†ÙˆÙ† (Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†) - Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
            if (remainingAmount > 0) {
                entries.push({
                    accountCode: '2111',
                    accountName: 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Ø¹Ø§Ù…)',
                    debit: 0,
                    credit: remainingAmount
                });
            }
            
            return await createJournalEntry({
                date: purchase.date,
                description: `ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª Ø±Ù‚Ù… PUR${String(purchase.number).padStart(3, '0')} - ${supplierName}${paidAmount > 0 && remainingAmount > 0 ? ' (Ù…Ù‚Ø³Ø·Ø©)' : ''}`,
                reference: purchase.id,
                referenceType: 'purchase',
                entries: entries,
                total: total,
                notes: purchase.notes || ''
            });
        }
        
        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…ØµØ±ÙˆÙ
         */
        async function createExpenseJournalEntry(expense) {
            const amount = expense.amount || 0;
            
            const entries = [];
            
            // Ù…Ù† Ø­Ù€/ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
            let expenseAccountCode = '5920'; // Ù…ØµØ±ÙˆÙØ§Øª Ø£Ø®Ø±Ù‰ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ
            if (expense.category) {
                const categoryMap = {
                    'rent': '5400',
                    'utilities': '5500',
                    'communications': '5600',
                    'maintenance': '5700',
                    'marketing': '5800',
                    'administrative': '5900'
                };
                expenseAccountCode = categoryMap[expense.category] || '5920';
            }
            
            const expenseAccount = getAccountByCode(expenseAccountCode);
            
            entries.push({
                accountCode: expenseAccountCode,
                accountName: expenseAccount ? expenseAccount.name : 'Ù…ØµØ±ÙˆÙØ§Øª Ø£Ø®Ø±Ù‰',
                debit: amount,
                credit: 0
            });
            
            // Ø¥Ù„Ù‰ Ø­Ù€/ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø£Ùˆ Ø§Ù„Ø¨Ù†Ùƒ
            if (expense.paymentMethod === 'bank') {
                entries.push({
                    accountCode: '1112',
                    accountName: 'Ø§Ù„Ø¨Ù†Ùƒ',
                    debit: 0,
                    credit: amount
                });
            } else {
                entries.push({
                    accountCode: '1111',
                    accountName: 'Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚',
                    debit: 0,
                    credit: amount
                });
            }
            
            return await createJournalEntry({
                date: expense.date,
                description: `Ù…ØµØ±ÙˆÙ: ${expense.description || 'Ù…ØµØ±ÙˆÙ'}`,
                reference: expense.id,
                referenceType: 'expense',
                entries: entries,
                total: amount,
                notes: expense.notes || ''
            });
        }
        
        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ØµØ¯Ù‚Ø©
         */
        async function createCharityJournalEntry(charity) {
            const amount = charity.amount || 0;
            
            const entries = [];
            
            // Ù…Ù† Ø­Ù€/ Ø§Ù„ØµØ¯Ù‚Ø§Øª ÙˆØ§Ù„ØªØ¨Ø±Ø¹Ø§Øª
            entries.push({
                accountCode: '5930',
                accountName: 'Ø§Ù„ØµØ¯Ù‚Ø§Øª ÙˆØ§Ù„ØªØ¨Ø±Ø¹Ø§Øª',
                debit: amount,
                credit: 0
            });
            
            // Ø¥Ù„Ù‰ Ø­Ù€/ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø£Ùˆ Ø§Ù„Ø¨Ù†Ùƒ
            if (charity.paymentMethod === 'bank') {
                entries.push({
                    accountCode: '1112',
                    accountName: 'Ø§Ù„Ø¨Ù†Ùƒ',
                    debit: 0,
                    credit: amount
                });
            } else {
                entries.push({
                    accountCode: '1111',
                    accountName: 'Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚',
                    debit: 0,
                    credit: amount
                });
            }
            
            return await createJournalEntry({
                date: charity.date,
                description: `ØµØ¯Ù‚Ø©: ${charity.desc || 'ØµØ¯Ù‚Ø© ÙˆØªØ¨Ø±Ø¹'}`,
                reference: charity.id,
                referenceType: 'charity',
                entries: entries,
                total: amount,
                notes: charity.desc || ''
            });
        }
        
        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø±Ø§ØªØ¨
         */
        async function createSalaryJournalEntry(salary) {
            const netSalary = salary.net || salary.basic || 0;
            
            const entries = [];
            
            // Ù…Ù† Ø­Ù€/ Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ø£Ø¬ÙˆØ±
            entries.push({
                accountCode: '5300',
                accountName: 'Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ø£Ø¬ÙˆØ±',
                debit: netSalary,
                credit: 0
            });
            
            // Ø¥Ù„Ù‰ Ø­Ù€/ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)
            entries.push({
                accountCode: '1111',
                accountName: 'Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚',
                debit: 0,
                credit: netSalary
            });
            
            return await createJournalEntry({
                date: salary.month ? `${salary.month}-01` : new Date().toISOString().split('T')[0],
                description: `Ø±Ø§ØªØ¨: ${salary.employeeName || 'Ù…ÙˆØ¸Ù'} - ${salary.month || ''}`,
                reference: salary.id,
                referenceType: 'salary',
                entries: entries,
                total: netSalary,
                notes: salary.notes || ''
            });
        }



        // === Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© ===
        async function saveActivities() {
            const success = saveToLocalStorage('diwan_activities', activities);
            if (success) {
                loadActivities();
            }
        }

        // === Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase (ØªØ¬Ø§Ù‡Ù„ GLOBAL_STORAGE_KEYS) ===
        async function firebaseSaveUsersDirectly(usersArray) {
            if (!USE_FIREBASE) return false;
            
            try {
                const { ref, set } = window.firebaseModules;
                const database = window.firebaseDatabase;
                
                if (!database) {
                    console.warn('âš ï¸ Firebase Database ØºÙŠØ± Ù…ØªØ§Ø­');
                    return false;
                }
                
                // Ø­ÙØ¸ ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Authentication + Database
                for (const user of usersArray) {
                    if (!user.firebaseUid) {
                        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Authentication Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
                        try {
                            const firebaseUser = await firebaseCreateUser(user.email, user.password, {
                                name: user.name,
                                phone: user.phone,
                                role: user.role,
                                activityId: user.activityId,
                                createdAt: user.createdAt
                            });
                            
                            if (firebaseUser) {
                                user.firebaseUid = firebaseUser.uid;
                                console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase: ${user.email}`);
                            }
                        } catch (authError) {
                            if (authError.code === 'auth/email-already-in-use') {
                                console.log(`â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Firebase: ${user.email}`);
                            } else {
                                console.warn(`âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Authentication: ${authError.message}`);
                            }
                        }
                    }
                }
                
                // Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Database
                const usersRef = ref(database, 'users'); // ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† 'system/users' Ø¥Ù„Ù‰ 'users'
                
                // ØªØ­ÙˆÙŠÙ„ Array Ø¥Ù„Ù‰ Object Ù…ÙÙ‡Ø±Ø³ Ø¨Ø§Ù„Ù€ email Ù„Ø¶Ù…Ø§Ù† Ø¨Ù†ÙŠØ© Ø«Ø§Ø¨ØªØ©
                const usersObject = {};
                usersArray.forEach(user => {
                    if (user.email) {
                        // Ø¥Ø²Ø§Ù„Ø© Ø­Ù‚Ù„ password Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ (ÙŠÙØ­ÙØ¸ ÙÙ‚Ø· ÙÙŠ Authentication)
                        const { password, ...userDataWithoutPassword } = user;
                        usersObject[user.email.replace(/[.#$[\]]/g, '_')] = userDataWithoutPassword;
                    }
                });
                
                await set(usersRef, usersObject);
                
                console.log('ğŸ”¥âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase Database');
                return true;
                
            } catch (error) {
                console.error('ğŸ”¥âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase:', error);
                return false;
            }
        }

        async function saveUsers() {
            console.log('ğŸ’¾ Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...', users.length, 'Ù…Ø³ØªØ®Ø¯Ù…');
            
            // ØªØ´Ø®ÙŠØµ ØªÙØµÙŠÙ„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
            const userWithPhone = users.find(u => u.phone);
            if (userWithPhone) {
                console.log('ğŸ“± Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸:', {
                    id: userWithPhone.id,
                    name: userWithPhone.name,
                    phone: userWithPhone.phone,
                    phoneType: typeof userWithPhone.phone
                });
            }
            
            // 1. Ø­ÙØ¸ ÙÙŠ LocalStorage Ø£ÙˆÙ„Ø§Ù‹ (ÙƒØ§Ù„Ù…Ø¹ØªØ§Ø¯)
            const success = saveToLocalStorage('diwan_users', users);
            
            // 2. Ø­ÙØ¸ ÙÙŠ Firebase Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (ØªØ¬Ø§Ù‡Ù„ GLOBAL_STORAGE_KEYS)
            if (success && USE_FIREBASE) {
                console.log('ğŸ”¥ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase...');
                const firebaseSuccess = await firebaseSaveUsersDirectly(users);
                if (firebaseSuccess) {
                    console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­');
                    // Ø¥Ø´Ø¹Ø§Ø± Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    // showNotification('ğŸ”¥ Firebase', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase', 'success');
                }
            }
            if (success) {
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ localStorage');
                // ØªØ­Ù‚Ù‚ Ù…Ø¨Ø§Ø´Ø±
                const verification = loadFromLocalStorage('diwan_users');
                console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸:', verification ? verification.length : 0, 'Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ÙÙˆØ¸');
                
                // ØªØ´Ø®ÙŠØµ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                if (verification && verification.length > 0) {
                    const savedUserWithPhone = verification.find(u => u.phone);
                    if (savedUserWithPhone) {
                        console.log('ğŸ“± Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸:', {
                            id: savedUserWithPhone.id,
                            name: savedUserWithPhone.name,
                            phone: savedUserWithPhone.phone,
                            phoneType: typeof savedUserWithPhone.phone
                        });
                    } else {
                        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸!');
                    }
                }
            } else {
                console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†!');
            }
            return success;
        }

        // ========================================
        // ğŸ”¥ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ù„Ù‰ Firebase Database
        // ========================================
        async function migrateUsersToFirebase() {
            if (!USE_FIREBASE) {
                showNotification('âš ï¸ Firebase Ù…Ø¹Ø·Ù„', 'ØªÙØ¹ÙŠÙ„ Firebase Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù†Ù‚Ù„', 'warning');
                return;
            }

            const confirmed = await showConfirmDialog(
                'ğŸ”¥ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ù„Ù‰ Firebase',
                `Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (${users.length}) Ù…Ù† LocalStorage Ø¥Ù„Ù‰ Firebase DatabaseØŸ\n\nâš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªÙ†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ø§Øª Firebase Authentication Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù….`,
                'primary',
                'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„ Ø§Ù„Ø¢Ù†',
                'Ø¥Ù„ØºØ§Ø¡'
            );

            if (!confirmed) return;

            showLoading('ğŸ”¥ Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ù„Ù‰ Firebase...');
            
            let successCount = 0;
            let failCount = 0;
            const errors = [];

            for (const user of users) {
                try {
                    console.log(`ğŸ”„ Ù…Ø¹Ø§Ù„Ø¬Ø©: ${user.email}...`);
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Firebase Authentication
                    let firebaseUser = null;
                    try {
                        firebaseUser = await firebaseCreateUser(user.email, user.password, {
                            id: user.id,
                            name: user.name,
                            email: user.email,
                            phone: user.phone,
                            role: user.role,
                            activityId: user.activityId,
                            createdAt: user.createdAt || new Date().toISOString()
                        });
                    } catch (authError) {
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ AuthenticationØŒ Ù†Ø¬Ù„Ø¨ Ø§Ù„Ù€ UID
                        if (authError.code === 'auth/email-already-in-use') {
                            console.log(`â„¹ï¸ ${user.email} Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Firebase Auth - Ø³Ù†Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·`);
                            
                            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ UID
                            const { signInWithEmailAndPassword, signOut } = window.firebaseModules;
                            const auth = window.firebaseAuth;
                            try {
                                // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                                const currentUser = auth.currentUser;
                                
                                // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø¤Ù‚Øª
                                const userCred = await signInWithEmailAndPassword(auth, user.email, user.password);
                                firebaseUser = { uid: userCred.user.uid };
                                console.log(`âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ UID: ${firebaseUser.uid}`);
                                
                                // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ÙÙˆØ±ÙŠ
                                await signOut(auth);
                                
                                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£ØµÙ„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                                if (currentUser) {
                                    const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                                    if (loggedInUser) {
                                        await signInWithEmailAndPassword(auth, loggedInUser.email, loggedInUser.password);
                                    }
                                }
                            } catch (signInError) {
                                console.warn(`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ UID Ù„Ù€ ${user.email}:`, signInError.message);
                            }
                        }
                    }

                    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Database
                    if (firebaseUser && firebaseUser.uid) {
                        await firebaseSaveUserData(firebaseUser.uid, {
                            id: user.id,
                            name: user.name,
                            email: user.email,
                            phone: user.phone,
                            role: user.role,
                            activityId: user.activityId,
                            createdAt: user.createdAt || new Date().toISOString()
                        });
                        
                        console.log(`âœ… ØªÙ… Ù†Ù‚Ù„: ${user.email}`);
                        successCount++;
                    } else {
                        throw new Error('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ UID');
                    }
                    
                } catch (error) {
                    console.error(`âŒ ÙØ´Ù„ Ù†Ù‚Ù„ ${user.email}:`, error);
                    failCount++;
                    errors.push({ email: user.email, error: error.message });
                }
            }

            hideLoading();

            // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            if (successCount === users.length) {
                showNotification(
                    'âœ… Ù†Ø¬Ø­ Ø§Ù„Ù†Ù‚Ù„',
                    `ØªÙ… Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (${successCount}) Ø¥Ù„Ù‰ Firebase Ø¨Ù†Ø¬Ø§Ø­!`,
                    'success',
                    8000
                );
            } else if (successCount > 0) {
                showNotification(
                    'âš ï¸ Ù†Ù‚Ù„ Ø¬Ø²Ø¦ÙŠ',
                    `ØªÙ… Ù†Ù‚Ù„ ${successCount} Ù…Ø³ØªØ®Ø¯Ù…ØŒ ÙØ´Ù„ ${failCount} Ù…Ø³ØªØ®Ø¯Ù….\nØªØ­Ù‚Ù‚ Ù…Ù† Console Ù„Ù„ØªÙØ§ØµÙŠÙ„.`,
                    'warning',
                    10000
                );
                console.log('âŒ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:', errors);
            } else {
                showNotification(
                    'âŒ ÙØ´Ù„ Ø§Ù„Ù†Ù‚Ù„',
                    'ÙØ´Ù„ Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†. ØªØ­Ù‚Ù‚ Ù…Ù† Console.',
                    'error',
                    8000
                );
            }
        }

        /**
         * Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰
         */
        async function fixUsersPhoneField() {
            const confirmed = await showConfirmDialog({
                title: 'ğŸ“± Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡Ø§ØªÙ',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡Ù… Ø±Ù‚Ù… Ù‡Ø§ØªÙØŸ\n\nØ³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ phone ÙØ§Ø±Øº ÙŠÙ…ÙƒÙ† ØªØ¹Ø¨Ø¦ØªÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹.',
                type: 'info',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø¥ØµÙ„Ø­ Ø§Ù„Ø¢Ù†',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });

            if (!confirmed) return;

            showLoading('ğŸ“± Ø¬Ø§Ø±ÙŠ Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡Ø§ØªÙ...');

            try {
                let fixedCount = 0;
                
                users.forEach(user => {
                    if (!user.hasOwnProperty('phone') || user.phone === undefined) {
                        user.phone = '';
                        fixedCount++;
                        console.log(`âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚Ù„ phone Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user.email}`);
                    }
                });

                if (fixedCount > 0) {
                    // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                    saveUsers();
                    
                    hideLoading();
                    showNotification(
                        'âœ… ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­',
                        `ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚Ù„ Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù€ ${fixedCount} Ù…Ø³ØªØ®Ø¯Ù…`,
                        'success'
                    );
                    
                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                    renderUsersInSettings();
                } else {
                    hideLoading();
                    showNotification(
                        'â„¹ï¸ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„Ø¥ØµÙ„Ø§Ø­',
                        'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø­Ù‚Ù„ Ø§Ù„Ù‡Ø§ØªÙ',
                        'info'
                    );
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡Ø§ØªÙ:', error);
                hideLoading();
                showNotification(
                    'âŒ ÙØ´Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­',
                    'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‡Ø§ØªÙ: ' + error.message,
                    'error'
                );
            }
        }

        /**
         * Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ© ÙÙŠ Firebase Database
         */
        async function fixFirebaseUserData() {
            if (!USE_FIREBASE) {
                showNotification('âš ï¸ Firebase Ù…Ø¹Ø·Ù„', 'ØªÙØ¹ÙŠÙ„ Firebase Ù…Ø·Ù„ÙˆØ¨', 'warning');
                return;
            }

            const confirmed = await showConfirmDialog(
                'ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',
                'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ© ÙÙŠ Firebase DatabaseØŸ\n\nØ³ÙŠØªÙ… Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage Ù…Ø¹ Firebase.',
                'primary',
                'Ù†Ø¹Ù…ØŒ Ø£ØµÙ„Ø­ Ø§Ù„Ø¢Ù†',
                'Ø¥Ù„ØºØ§Ø¡'
            );

            if (!confirmed) return;

            showLoading('ğŸ”§ Ø¬Ø§Ø±ÙŠ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

            try {
                const { ref, get } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Firebase
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                
                if (!snapshot.exists()) {
                    hideLoading();
                    showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase', 'warning');
                    return;
                }

                const firebaseUsers = snapshot.val();
                let fixedCount = 0;

                // Ù…Ø·Ø§Ø¨Ù‚Ø© ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Firebase Ù…Ø¹ LocalStorage
                for (const uid in firebaseUsers) {
                    const fbUser = firebaseUsers[uid];
                    
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ LocalStorage Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
                    const localUser = users.find(u => u.email === fbUser.email);
                    
                    if (localUser) {
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ©
                        await firebaseSaveUserData(uid, {
                            id: localUser.id,
                            name: localUser.name,
                            email: localUser.email,
                            phone: localUser.phone,
                            role: localUser.role,
                            activityId: localUser.activityId,
                            createdAt: localUser.createdAt || new Date().toISOString()
                        });
                        
                        console.log(`âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø¨ÙŠØ§Ù†Ø§Øª: ${localUser.email}`);
                        fixedCount++;
                    }
                }

                hideLoading();
                showNotification(
                    'âœ… ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­',
                    `ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø¨ÙŠØ§Ù†Ø§Øª ${fixedCount} Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase!`,
                    'success'
                );

            } catch (error) {
                hideLoading();
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­:', error);
                showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­', error.message, 'error');
            }
        }

        /**
         * Ù†Ù‚Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø¥Ù„Ù‰ Firebase Database
         */
        async function migrateActivitiesToFirebase() {
            if (!USE_FIREBASE) {
                showNotification('âš ï¸ Firebase Ù…Ø¹Ø·Ù„', 'ØªÙØ¹ÙŠÙ„ Firebase Ù…Ø·Ù„ÙˆØ¨', 'warning');
                return;
            }

            const confirmed = await showConfirmDialog(
                'ğŸ”¥ Ù†Ù‚Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø¥Ù„Ù‰ Firebase',
                `Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø© (${activities.length}) Ø¥Ù„Ù‰ Firebase DatabaseØŸ\n\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§.`,
                'primary',
                'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„ Ø§Ù„Ø¢Ù†',
                'Ø¥Ù„ØºØ§Ø¡'
            );

            if (!confirmed) return;

            showLoading('ğŸ”¥ Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©...');

            try {
                const { ref, set } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                let successCount = 0;
                let errorCount = 0;

                // Ù†Ù‚Ù„ ÙƒÙ„ Ù†Ø´Ø§Ø· Ø¥Ù„Ù‰ Firebase
                for (const activity of activities) {
                    try {
                        const activityRef = ref(db, `activities/${activity.id}`);
                        await set(activityRef, {
                            id: activity.id,
                            name: activity.name,
                            createdAt: activity.createdAt || new Date().toISOString(),
                            createdBy: activity.createdBy || 'admin'
                        });
                        
                        console.log(`âœ… ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù†Ø´Ø§Ø·: ${activity.name}`);
                        successCount++;
                    } catch (error) {
                        console.error(`âŒ ÙØ´Ù„ Ù†Ù‚Ù„ Ø§Ù„Ù†Ø´Ø§Ø· ${activity.name}:`, error);
                        errorCount++;
                    }
                }

                hideLoading();
                
                if (errorCount === 0) {
                    showNotification(
                        'âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­',
                        `ØªÙ… Ù†Ù‚Ù„ ${successCount} Ù†Ø´Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Firebase!`,
                        'success'
                    );
                } else {
                    showNotification(
                        'âš ï¸ Ù†Ù‚Ù„ Ø¬Ø²Ø¦ÙŠ',
                        `Ù†Ø¬Ø­: ${successCount} | ÙØ´Ù„: ${errorCount}`,
                        'warning'
                    );
                }

            } catch (error) {
                hideLoading();
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù†Ù‚Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©:', error);
                showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ù‚Ù„', error.message, 'error');
            }
        }

        /**
         * Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Firebase
         */
        async function migrateActivityDataToFirebase() {
            if (!USE_FIREBASE) {
                showNotification('âš ï¸ Firebase Ù…Ø¹Ø·Ù„', 'ØªÙØ¹ÙŠÙ„ Firebase Ù…Ø·Ù„ÙˆØ¨', 'warning');
                return;
            }

            if (!currentActivityId) {
                showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·', 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø´Ø§Ø· Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }

            const activity = activities.find(a => a.id == currentActivityId);
            const activityName = activity ? activity.name : currentActivityId;

            const dataTypes = [
                { name: 'Ø§Ù„Ø£ØµÙ†Ø§Ù', key: 'items', data: items },
                { name: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', key: 'customers', data: customers },
                { name: 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†', key: 'suppliers', data: suppliers },
                { name: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', key: 'purchases', data: purchases },
                { name: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', key: 'sales', data: sales },
                { name: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', key: 'expenses', data: expenses },
                { name: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', key: 'revenues', data: revenues },
                { name: 'Ø§Ù„Ø±ÙˆØ§ØªØ¨', key: 'salaries', data: salaries },
                { name: 'Ø§Ù„Ø£ØµÙˆÙ„', key: 'assets', data: assets },
                { name: 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', key: 'salesReturns', data: salesReturns },
                { name: 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', key: 'purchaseReturns', data: purchaseReturns },
                { name: 'Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù', key: 'advances', data: advances }
            ];

            const totalItems = dataTypes.reduce((sum, type) => sum + (type.data ? type.data.length : 0), 0);

            const confirmed = await showConfirmDialog(
                'ğŸ”¥ Ù†Ù‚Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·',
                `Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· "${activityName}" Ø¥Ù„Ù‰ FirebaseØŸ\n\n` +
                `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${totalItems}\n\n` +
                dataTypes.map(t => `${t.name}: ${t.data ? t.data.length : 0}`).join('\n'),
                'primary',
                'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„ Ø§Ù„Ø¢Ù†',
                'Ø¥Ù„ØºØ§Ø¡'
            );

            if (!confirmed) return;

            showLoading('ğŸ”¥ Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·...');

            try {
                const { ref, set } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                let totalSuccess = 0;
                let totalError = 0;

                // Ù†Ù‚Ù„ ÙƒÙ„ Ù†ÙˆØ¹ Ø¨ÙŠØ§Ù†Ø§Øª
                for (const dataType of dataTypes) {
                    if (!dataType.data || dataType.data.length === 0) {
                        console.log(`â­ï¸ ØªØ®Ø·ÙŠ ${dataType.name} (Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª)`);
                        continue;
                    }

                    try {
                        const dataRef = ref(db, `activities/${currentActivityId}/${dataType.key}`);
                        
                        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† Ø¨Ù…ÙØ§ØªÙŠØ­ ÙØ±ÙŠØ¯Ø©
                        const dataObject = {};
                        dataType.data.forEach(item => {
                            const itemId = item.id || item.number || Date.now() + Math.random();
                            dataObject[itemId] = item;
                        });
                        
                        await set(dataRef, dataObject);
                        
                        console.log(`âœ… ØªÙ… Ù†Ù‚Ù„ ${dataType.name}: ${dataType.data.length} Ø³Ø¬Ù„`);
                        totalSuccess += dataType.data.length;
                    } catch (error) {
                        console.error(`âŒ ÙØ´Ù„ Ù†Ù‚Ù„ ${dataType.name}:`, error);
                        totalError += dataType.data.length;
                    }
                }

                hideLoading();
                
                if (totalError === 0) {
                    showNotification(
                        'âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­',
                        `ØªÙ… Ù†Ù‚Ù„ ${totalSuccess} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Firebase!`,
                        'success'
                    );
                } else {
                    showNotification(
                        'âš ï¸ Ù†Ù‚Ù„ Ø¬Ø²Ø¦ÙŠ',
                        `Ù†Ø¬Ø­: ${totalSuccess} | ÙØ´Ù„: ${totalError}`,
                        'warning'
                    );
                }

            } catch (error) {
                hideLoading();
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ù‚Ù„', error.message, 'error');
            }
        }

        // === ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Firebase ===
        async function firebaseLoadUsersDirectly() {
            if (!USE_FIREBASE) return null;
            
            try {
                const { ref, get } = window.firebaseModules;
                const database = window.firebaseDatabase;
                
                if (!database) {
                    console.warn('âš ï¸ Firebase Database ØºÙŠØ± Ù…ØªØ§Ø­');
                    return null;
                }
                
                const usersRef = ref(database, 'users'); // ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† 'system/users' Ø¥Ù„Ù‰ 'users'
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const firebaseUsers = snapshot.val();
                    
                    // ØªØ­ÙˆÙŠÙ„ Object Ø¥Ù„Ù‰ Array Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Object
                    let usersArray = [];
                    if (Array.isArray(firebaseUsers)) {
                        usersArray = firebaseUsers;
                    } else if (firebaseUsers && typeof firebaseUsers === 'object') {
                        // ØªØ­ÙˆÙŠÙ„ Object Ø¥Ù„Ù‰ Array Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Object.values
                        usersArray = Object.values(firebaseUsers).filter(u => u && u.id && u.email);
                    }
                    
                    console.log('ğŸ”¥âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Firebase:', usersArray?.length || 0);
                    return usersArray;
                } else {
                    console.log('ğŸ”¥â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase - Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©');
                    return [];
                }
                
            } catch (error) {
                console.error('ğŸ”¥âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Firebase:', error);
                return null;
            }
        }

        // === ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ù† Firebase ===
        async function firebaseLoadActivitiesDirectly() {
            if (!USE_FIREBASE) return null;
            
            try {
                const { ref, get, set, remove } = window.firebaseModules;
                const database = window.firebaseDatabase;
                
                if (!database) {
                    console.warn('âš ï¸ Firebase Database ØºÙŠØ± Ù…ØªØ§Ø­');
                    return null;
                }
                
                // ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·
                const activitiesRef = ref(database, 'activities');
                let snapshot = await get(activitiesRef);
                
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (!snapshot.exists()) {
                    console.log('ğŸ” Ù„Ù… ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© ÙÙŠ activitiesØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ activitiesList Ø§Ù„Ù‚Ø¯ÙŠÙ…...');
                    const oldActivitiesRef = ref(database, 'activitiesList');
                    const oldSnapshot = await get(oldActivitiesRef);
                    
                    if (oldSnapshot.exists()) {
                        const firebaseActivities = oldSnapshot.val();
                        const activitiesArray = [];
                        
                        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„Ø·Ø©
                        Object.keys(firebaseActivities).forEach(key => {
                            const value = firebaseActivities[key];
                            if (value && typeof value === 'object' && value.id && value.name) {
                                activitiesArray.push(value);
                            }
                        });
                        
                        if (activitiesArray.length > 0) {
                            console.log(`ğŸ”„ Ù†Ù‚Ù„ ${activitiesArray.length} Ù†Ø´Ø§Ø· Ù…Ù† activitiesList Ø¥Ù„Ù‰ activities`);
                            const activitiesObject = {};
                            activitiesArray.forEach(activity => {
                                if (activity.id) {
                                    activitiesObject[activity.id] = {
                                        id: activity.id,
                                        name: activity.name,
                                        createdAt: activity.createdAt || new Date().toISOString(),
                                        createdBy: activity.createdBy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
                                    };
                                }
                            });
                            await set(activitiesRef, activitiesObject);
                            
                            // Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…
                            await remove(oldActivitiesRef);
                            console.log('ï¿½ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… activities');
                            
                            return activitiesArray;
                        }
                    }
                }
                
                if (snapshot.exists()) {
                    const firebaseActivities = snapshot.val();
                    
                    // ØªØ­ÙˆÙŠÙ„ Object Ø¥Ù„Ù‰ Array Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Object
                    let activitiesArray = [];
                    if (Array.isArray(firebaseActivities)) {
                        activitiesArray = firebaseActivities;
                    } else if (firebaseActivities && typeof firebaseActivities === 'object') {
                        // ØªØ­ÙˆÙŠÙ„ Object Ø¥Ù„Ù‰ Array Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Object.values
                        activitiesArray = Object.values(firebaseActivities).filter(a => a && a.id && a.name);
                    }
                    
                    console.log('ğŸ”¥âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ù† Firebase:', activitiesArray?.length || 0);
                    return activitiesArray;
                } else {
                    console.log('ğŸ”¥â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase - Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©');
                    return [];
                }
                
            } catch (error) {
                console.error('ğŸ”¥âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ù† Firebase:', error);
                return null;
            }
        }

       async function loadUsers() {
    try {
        console.log("ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...");
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase Ø£ÙˆÙ„Ø§Ù‹
        if (USE_FIREBASE) {
            const firebaseUsers = await firebaseLoadUsersDirectly();
            if (firebaseUsers && firebaseUsers.length > 0) {
                users = firebaseUsers;
                console.log(`ğŸ”¥âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${users.length} Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firebase`);
                return;
            }
        }
        
        // Ø¥Ø°Ø§ ÙØ´Ù„ FirebaseØŒ Ø­Ù…Ù‘Ù„ Ù…Ù† LocalStorage
        console.log("ğŸ”„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ...");
        let storedUsers = loadFromLocalStorage('diwan_users');

        if (!Array.isArray(storedUsers)) {
            storedUsers = [];
        }

        if (storedUsers.length === 0 && typeof localStorage !== 'undefined') {
            const legacyUsers = [];
            const legacyKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.endsWith('_diwan_users')) {
                    try {
                        const raw = JSON.parse(localStorage.getItem(key) || '[]');
                        if (Array.isArray(raw) && raw.length) {
                            raw.forEach(candidate => {
                                if (!candidate || !candidate.email) return;
                                const exists = legacyUsers.some(user => user.email === candidate.email);
                                if (!exists) {
                                    legacyUsers.push(candidate);
                                }
                            });
                        }
                        legacyKeys.push(key);
                    } catch (legacyError) {
                        console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù‚Ø¯ÙŠÙ…Ø©:', legacyError);
                    }
                }
            }

            if (legacyUsers.length) {
                console.log(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${legacyUsers.length} Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù…ÙØ§ØªÙŠØ­ Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ø³ÙŠØªÙ… Ù†Ù‚Ù„Ù‡Ù… Ù„Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯`);
                storedUsers = legacyUsers;
                saveToLocalStorage('diwan_users', storedUsers);
                legacyKeys.forEach(key => localStorage.removeItem(key));
            }
        }

        users = storedUsers;
        
        // Ø¥ØµÙ„Ø§Ø­: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ù‚Ù„ phone ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        users.forEach(user => {
            if (!user.hasOwnProperty('phone')) {
                user.phone = '';
                console.log(`âš ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ phone ÙØ§Ø±Øº Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user.email}`);
            }
        });
        
        console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${users.length} Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ`);
        if (users.length > 0) {
            console.log('ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ù…Ù„Ø©:');
            users.forEach(u => {
                console.log(`  - ${u.email}: role=${u.role}, phone=${u.phone || 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}, activityId=${u.activityId} (${typeof u.activityId})`);
            });
            
            // ØªØ´Ø®ÙŠØµ Ø®Ø§Øµ Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ù„Ø§Øª
            console.log('ğŸ“± ØªØ´Ø®ÙŠØµ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ù„Ø§Øª:');
            users.forEach(u => {
                if (u.phone) {
                    console.log(`  ğŸ“± ${u.email}: phone="${u.phone}" (${typeof u.phone}) - Ø·ÙˆÙ„: ${u.phone.length}`);
                } else {
                    console.log(`  ğŸ“± ${u.email}: phone ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (${typeof u.phone})`);
                }
            });
        }
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:", error);
        users = [];
    }
}

        // === Ø¯ÙˆØ§Ù„ ØªØ®ØµÙŠØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===
        function toggleControlPanel() {
            const panel = document.getElementById('controlPanel');
            panel.classList.toggle('show');
        }

        function updateFontSize(size) {
            document.documentElement.style.setProperty('--font-size', size + 'px');
            document.getElementById('font-size-value').textContent = size + 'px';
            saveDesignPreferences(); // Ø­ÙØ¸ Ø§Ù„ØªØ®ØµÙŠØµØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        }

        function updateColor(variable, color) {
            document.documentElement.style.setProperty(variable, color);
            saveDesignPreferences(); // Ø­ÙØ¸ Ø§Ù„ØªØ®ØµÙŠØµØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        }

        function updateHeaderColor(color) {
            // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¯Ø±Ø¬
            const gradient = `linear-gradient(135deg, ${color} 0%, #34495e 100%)`;
            document.documentElement.style.setProperty('--header-bg', gradient);
            saveDesignPreferences(); // Ø­ÙØ¸ Ø§Ù„ØªØ®ØµÙŠØµØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        }

        // ØªØ­Ø¯ÙŠØ« ØªØ¯Ø±Ø¬ Ø§Ù„ØªØ°ÙŠÙŠÙ„
        function updateFooterGradient(color, position) {
            const footer = document.getElementById('appFooter');
            if (!footer) return;
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const currentStyle = footer.style.background;
            let color1 = '#667eea';
            let color2 = '#764ba2';
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù…Ù† Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const match = currentStyle.match(/linear-gradient\(135deg,\s*([^)]+)\s+0%,\s*([^)]+)\s+100%\)/);
            if (match) {
                color1 = match[1].trim();
                color2 = match[2].trim();
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            if (position === 'start') {
                color1 = color;
            } else {
                color2 = color;
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const newGradient = `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
            footer.style.background = newGradient;
            
            saveDesignPreferences();
        }

        // ØªØ­Ø¯ÙŠØ« Ø®Ø· Ø§Ù„ØªØ°ÙŠÙŠÙ„
        function updateFooterFont(font) {
            const footer = document.getElementById('appFooter');
            if (footer) {
                footer.style.fontFamily = font;
                saveDesignPreferences();
            }
        }

        function saveDesignPreferences() {
            const footer = document.getElementById('appFooter');
            const preferences = {
                primaryColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
                bgColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim(),
                textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
                headerBg: getComputedStyle(document.documentElement).getPropertyValue('--header-bg').trim(),
                sidebarBg: getComputedStyle(document.documentElement).getPropertyValue('--sidebar-bg').trim(),
                fontSize: getComputedStyle(document.documentElement).getPropertyValue('--font-size').trim(),
                fontFamily: getComputedStyle(document.documentElement).getPropertyValue('--font-family').trim(),
                footerBg: footer ? footer.style.background : '',
                footerFont: footer ? footer.style.fontFamily : ''
            };
            localStorage.setItem('designPreferences', JSON.stringify(preferences));
        }

        function loadDesignPreferences() {
            const saved = localStorage.getItem('designPreferences');
            if (saved) {
                try {
                    const preferences = JSON.parse(saved);
                    
                    if (preferences.primaryColor) {
                        document.documentElement.style.setProperty('--primary-color', preferences.primaryColor);
                        const primaryPicker = document.querySelector('input[onchange*="--primary-color"]');
                        if (primaryPicker) primaryPicker.value = preferences.primaryColor;
                    }
                    
                    if (preferences.bgColor) {
                        document.documentElement.style.setProperty('--bg-color', preferences.bgColor);
                        const bgPicker = document.querySelector('input[onchange*="--bg-color"]');
                        if (bgPicker) bgPicker.value = preferences.bgColor;
                    }
                    
                    if (preferences.textColor) {
                        document.documentElement.style.setProperty('--text-color', preferences.textColor);
                        const textPicker = document.querySelector('input[onchange*="--text-color"]');
                        if (textPicker) textPicker.value = preferences.textColor;
                    }
                    
                    if (preferences.headerBg) {
                        document.documentElement.style.setProperty('--header-bg', preferences.headerBg);
                        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ù† Ø§Ù„ØªØ¯Ø±Ø¬
                        const colorMatch = preferences.headerBg.match(/linear-gradient\(135deg,\s*([^,]+)/);
                        if (colorMatch && colorMatch[1]) {
                            const headerPicker = document.getElementById('headerColorPicker');
                            if (headerPicker) headerPicker.value = colorMatch[1].trim();
                        }
                    }
                    
                    if (preferences.sidebarBg) {
                        document.documentElement.style.setProperty('--sidebar-bg', preferences.sidebarBg);
                        const sidebarPicker = document.getElementById('sidebarColorPicker');
                        if (sidebarPicker) sidebarPicker.value = preferences.sidebarBg;
                    }
                    
                    if (preferences.fontSize) {
                        document.documentElement.style.setProperty('--font-size', preferences.fontSize);
                        const sizeValue = parseInt(preferences.fontSize);
                        const rangeInput = document.querySelector('input[type="range"]');
                        const sizeDisplay = document.getElementById('font-size-value');
                        if (rangeInput) rangeInput.value = sizeValue;
                        if (sizeDisplay) sizeDisplay.textContent = preferences.fontSize;
                    }
                    
                    if (preferences.fontFamily) {
                        document.documentElement.style.setProperty('--font-family', preferences.fontFamily);
                        const fontSelect = document.getElementById('fontFamilySelect');
                        if (fontSelect) fontSelect.value = preferences.fontFamily;
                    }
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„
                    const footer = document.getElementById('appFooter');
                    if (footer) {
                        if (preferences.footerBg) {
                            footer.style.background = preferences.footerBg;
                            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù…Ù† Ø§Ù„ØªØ¯Ø±Ø¬
                            const match = preferences.footerBg.match(/linear-gradient\(135deg,\s*([^)]+)\s+0%,\s*([^)]+)\s+100%\)/);
                            if (match) {
                                const footerColor1 = document.getElementById('footerColor1Picker');
                                const footerColor2 = document.getElementById('footerColor2Picker');
                                if (footerColor1) footerColor1.value = match[1].trim();
                                if (footerColor2) footerColor2.value = match[2].trim();
                            }
                        }
                        if (preferences.footerFont) {
                            footer.style.fontFamily = preferences.footerFont;
                            const footerFontSelect = document.getElementById('footerFontSelect');
                            if (footerFontSelect) footerFontSelect.value = preferences.footerFont;
                        }
                    }
                    
                } catch (e) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªØ®ØµÙŠØµØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ…:', e);
                }
            }
        }

        function updateFontFamily(font) {
            document.documentElement.style.setProperty('--font-family', font);
            saveDesignPreferences(); // Ø­ÙØ¸ Ø§Ù„ØªØ®ØµÙŠØµØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        }

        function resetDesign() {
            document.documentElement.style.setProperty('--primary-color', '#2c5aa0');
            document.documentElement.style.setProperty('--bg-color', '#ecf0f1');
            document.documentElement.style.setProperty('--text-color', '#2c3e50');
            document.documentElement.style.setProperty('--header-bg', 'linear-gradient(135deg, #2c5aa0 0%, #34495e 100%)');
            document.documentElement.style.setProperty('--sidebar-bg', '#1a3a5c');
            document.documentElement.style.setProperty('--font-size', '16px');
            document.documentElement.style.setProperty('--font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif");
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ°ÙŠÙŠÙ„
            const footer = document.getElementById('appFooter');
            if (footer) {
                footer.style.background = 'linear-gradient(135deg, #1e3a5f 0%, #2c4a6f 100%)';
                footer.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            }
            
            document.querySelector('input[type="range"]').value = 16;
            document.getElementById('font-size-value').textContent = '16px';
            document.querySelector('input[value="#2c5aa0"]').value = '#2c5aa0';
            document.querySelector('input[value="#ecf0f1"]').value = '#ecf0f1';
            document.querySelector('input[value="#2c3e50"]').value = '#1a3a5c';
            document.getElementById('headerColorPicker').value = '#2c5aa0';
            document.getElementById('sidebarColorPicker').value = '#2c3e50';
            document.getElementById('fontFamilySelect').value = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            
            // Ø­Ø°Ù Ø§Ù„ØªØ®ØµÙŠØµØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            localStorage.removeItem('designPreferences');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
            showNotification('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­! ğŸ¨', 'success');
        }

        // === Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Ù…Ø¤Ù‚ØªØ©) ===
        function showAutoBackupInfo() {
            try {
                // Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ LocalStorage
                let totalSize = 0;
                let itemsCount = 0;
                
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length;
                        itemsCount++;
                    }
                }
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ø¥Ù„Ù‰ ÙˆØ­Ø¯Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
                let sizeText = '';
                if (totalSize < 1024) {
                    sizeText = `${totalSize} Ø¨Ø§ÙŠØª`;
                } else if (totalSize < 1024 * 1024) {
                    sizeText = `${(totalSize / 1024).toFixed(1)} ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª`;
                } else {
                    sizeText = `${(totalSize / (1024 * 1024)).toFixed(1)} Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª`;
                }
                
                // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Firebase
                const firebaseStatus = USE_FIREBASE ? 'Ù…ÙÙØ¹Ù‘Ù„ âœ…' : 'Ù…Ø¹Ø·Ù‘Ù„ âŒ';
                
                // Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
                const lastActivity = sessionStorage.getItem('lastActivityTime') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                
                const message = `
ğŸ”„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¬ÙŠÙ† Ø§Ù„Ù†Ø´Ø·:
â€¢ Firebase: ${firebaseStatus}
â€¢ LocalStorage: Ù†Ø´Ø· âœ…
â€¢ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©: ${sizeText}
â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙØ§ØªÙŠØ­: ${itemsCount}
â€¢ Ø¢Ø®Ø± Ù†Ø´Ø§Ø·: ${lastActivity}

ğŸ’¡ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ù…ÙƒØ§Ù†ÙŠÙ† Ù„Ø¶Ù…Ø§Ù† Ø£Ù‚ØµÙ‰ Ø­Ù…Ø§ÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª.`;
                
                showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', message, 'info');
                
            } catch (error) {
                showNotification('â„¹ï¸ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¬ÙŠÙ† ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Firebase + LocalStorage ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'info');
            }
        }
        
        /**
         * Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ø¯Ø© ØªØ¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
         */
        async function showBackupInfoWithRestore() {
            try {
                // Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ LocalStorage
                let totalSize = 0;
                let itemsCount = 0;
                
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length;
                        itemsCount++;
                    }
                }
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ø¥Ù„Ù‰ ÙˆØ­Ø¯Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
                let sizeText = '';
                if (totalSize < 1024) {
                    sizeText = `${totalSize} Ø¨Ø§ÙŠØª`;
                } else if (totalSize < 1024 * 1024) {
                    sizeText = `${(totalSize / 1024).toFixed(1)} ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª`;
                } else {
                    sizeText = `${(totalSize / (1024 * 1024)).toFixed(1)} Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª`;
                }
                
                // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Firebase
                const firebaseStatus = USE_FIREBASE ? 'Ù…ÙÙØ¹Ù‘Ù„ âœ…' : 'Ù…Ø¹Ø·Ù‘Ù„ âŒ';
                
                // Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
                const lastActivity = sessionStorage.getItem('lastActivityTime') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                
                const message = `
ğŸ”„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:
â€¢ Firebase: ${firebaseStatus}
â€¢ LocalStorage: Ù†Ø´Ø· âœ…
â€¢ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©: ${sizeText}
â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙØ§ØªÙŠØ­: ${itemsCount}
â€¢ Ø¢Ø®Ø± Ù†Ø´Ø§Ø·: ${lastActivity}

ğŸ’¡ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ù…ÙƒØ§Ù†ÙŠÙ† Ù„Ø¶Ù…Ø§Ù† Ø£Ù‚ØµÙ‰ Ø­Ù…Ø§ÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª.

Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©ØŸ`;
                
                const confirmed = await showConfirmDialog(
                    'ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©',
                    message,
                    'info',
                    'Ù†Ø¹Ù…ØŒ Ø§Ø³ØªØ¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                    'Ø¥Ù„ØºØ§Ø¡'
                );

                if (confirmed) {
                    // ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø£Ø®Ø±Ù‰
                    await restoreAutoBackup(true);
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ:', error);
                showNotification('â„¹ï¸ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¬ÙŠÙ† ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Firebase + LocalStorage ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'info');
            }
        }
        
        async function restoreAutoBackup(skipConfirmation = false) {
            if (!skipConfirmation) {
                const confirmed = await showConfirmDialog(
                    'ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©',
                    'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (LocalStorage)ØŸ\n\nâš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø³ÙŠØ³ØªØ¨Ø¯Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©.',
                    'warning',
                    'Ù†Ø¹Ù…ØŒ Ø§Ø³ØªØ¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                    'Ø¥Ù„ØºØ§Ø¡'
                );

                if (!confirmed) return;
            }

            try {
                showLoading('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                
                console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† LocalStorage...');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                await loadUsers();
                await loadActivities();
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
                if (window.currentActivityId) {
                    console.log('ğŸ“Š Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·:', window.currentActivityId);
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage
                    items = JSON.parse(localStorage.getItem(`diwan_items_${window.currentActivityId}`) || '[]');
                    customers = JSON.parse(localStorage.getItem(`diwan_customers_${window.currentActivityId}`) || '[]');
                    suppliers = JSON.parse(localStorage.getItem(`diwan_suppliers_${window.currentActivityId}`) || '[]');
                    purchases = JSON.parse(localStorage.getItem(`diwan_purchases_${window.currentActivityId}`) || '[]');
                    sales = JSON.parse(localStorage.getItem(`diwan_sales_${window.currentActivityId}`) || '[]');
                    expenses = JSON.parse(localStorage.getItem(`diwan_expenses_${window.currentActivityId}`) || '[]');
                    revenues = JSON.parse(localStorage.getItem(`diwan_revenues_${window.currentActivityId}`) || '[]');
                    salaries = JSON.parse(localStorage.getItem(`diwan_salaries_${window.currentActivityId}`) || '[]');
                    assets = JSON.parse(localStorage.getItem(`diwan_assets_${window.currentActivityId}`) || '[]');
                    salesReturns = JSON.parse(localStorage.getItem(`diwan_salesReturns_${window.currentActivityId}`) || '[]');
                    purchaseReturns = JSON.parse(localStorage.getItem(`diwan_purchaseReturns_${window.currentActivityId}`) || '[]');
                    advances = JSON.parse(localStorage.getItem(`diwan_advances_${window.currentActivityId}`) || '[]');
                    
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage:');
                    console.log(`  - Ø§Ù„Ø£ØµÙ†Ø§Ù: ${items.length}`);
                    console.log(`  - Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${customers.length}`);
                    console.log(`  - Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†: ${suppliers.length}`);
                    console.log(`  - Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${sales.length}`);
                    console.log(`  - Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${purchases.length}`);
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
                const currentSection = document.querySelector('.section:not([style*="display: none"])');
                if (currentSection && currentSection.id) {
                    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:', currentSection.id);
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                    const sectionName = currentSection.id.replace('Section', '');
                    if (typeof showSection === 'function') {
                        showSection(sectionName);
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                sessionStorage.setItem('lastRestoreTime', new Date().toLocaleString('ar-SA'));
                
                hideLoading();
                showNotification('âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'success');
                
            } catch (error) {
                hideLoading();
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©:', error);
                showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message, 'error');
            }
        }
        
        function downloadAutoBackup() {
            try {
                // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage
                const backupData = {
                    timestamp: new Date().toISOString(),
                    type: 'local_storage_backup',
                    users: JSON.parse(localStorage.getItem('users') || '[]'),
                    activities: JSON.parse(localStorage.getItem('activities') || '[]'),
                    activityData: {}
                };
                
                // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ù†Ø´Ø§Ø·
                backupData.activities.forEach(activity => {
                    const activityId = activity.id;
                    backupData.activityData[activityId] = {
                        items: JSON.parse(localStorage.getItem(`items_${activityId}`) || '[]'),
                        customers: JSON.parse(localStorage.getItem(`customers_${activityId}`) || '[]'),
                        suppliers: JSON.parse(localStorage.getItem(`suppliers_${activityId}`) || '[]'),
                        purchases: JSON.parse(localStorage.getItem(`purchases_${activityId}`) || '[]'),
                        sales: JSON.parse(localStorage.getItem(`sales_${activityId}`) || '[]'),
                        expenses: JSON.parse(localStorage.getItem(`expenses_${activityId}`) || '[]'),
                        revenues: JSON.parse(localStorage.getItem(`revenues_${activityId}`) || '[]'),
                        salaries: JSON.parse(localStorage.getItem(`salaries_${activityId}`) || '[]'),
                        assets: JSON.parse(localStorage.getItem(`assets_${activityId}`) || '[]'),
                        salesReturns: JSON.parse(localStorage.getItem(`salesReturns_${activityId}`) || '[]'),
                        purchaseReturns: JSON.parse(localStorage.getItem(`purchaseReturns_${activityId}`) || '[]'),
                        advances: JSON.parse(localStorage.getItem(`advances_${activityId}`) || '[]')
                    };
                });
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù„Ù„ØªÙ†Ø²ÙŠÙ„
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ†Ø²ÙŠÙ„
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `backup_localStorage_${new Date().toISOString().split('T')[0]}.json`;
                
                // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('âœ… ØªÙ… Ø§Ù„ØªÙ†Ø²ÙŠÙ„', 'ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† LocalStorage Ø¨Ù†Ø¬Ø§Ø­', 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
            }
        }

        // === ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ù‡ÙˆØ§ØªÙ ===
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        function updateAccountInfoSection(user) {
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            const currentUserNameEl = document.getElementById('currentUserNameDisplay');
            const currentUserEmailEl = document.getElementById('currentUserEmailDisplay');
            const currentUserPhoneEl = document.getElementById('currentUserPhoneDisplay');
            const currentUserRoleEl = document.getElementById('currentUserRoleDisplay');
            const currentActivityNameEl = document.getElementById('currentActivityNameDisplay');
            const changeActivityBtn = document.getElementById('changeActivityBtn');

            const fallbackText = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            const fallbackActivity = 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø·';
            
            if (currentUserNameEl) {
                const hasName = user && user.name && user.name.trim();
                currentUserNameEl.textContent = hasName ? user.name : (user && user.email ? user.email : fallbackText);
            }
            if (currentUserEmailEl) {
                currentUserEmailEl.textContent = user && user.email ? user.email : fallbackText;
            }
            if (currentUserPhoneEl) {
                const hasPhone = user && user.phone && user.phone.trim();
                currentUserPhoneEl.textContent = hasPhone ? user.phone : fallbackText;
            }
            if (currentUserRoleEl) {
                if (user && user.role) {
                    const roleNames = { admin: 'ğŸ”‘ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', manager: 'ğŸ§­ Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·', user: 'ğŸ‘¨â€ğŸ’¼ Ù…Ø³ØªØ®Ø¯Ù…' };
                    currentUserRoleEl.textContent = roleNames[user.role] || 'Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                } else {
                    currentUserRoleEl.textContent = fallbackText;
                }
            }
            if (currentActivityNameEl) {
                let activityName = fallbackActivity;
                if (currentActivityId) {
                    const activity = activities.find(a => a.id == currentActivityId);
                    activityName = activity ? activity.name : 'Ù†Ø´Ø§Ø· ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                }
                currentActivityNameEl.textContent = activityName;
            }
            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ±
            const showChange = (user && user.role === 'admin');

            if (changeActivityBtn) {
                changeActivityBtn.style.display = showChange ? 'inline-block' : 'none';
            }

            const sidebarChangeBtn = document.getElementById('sidebarChangeActivityBtn');
            if (sidebarChangeBtn) {
                sidebarChangeBtn.style.display = showChange ? 'block' : 'none';
            }
        }

        function updateSidebar(role) {
            const sidebarNav = document.getElementById('sidebarNav');
            if (!sidebarNav) return;

            // Refreshes the navigation menu according to the signed-in role.
            const baseSections = [
                { id: 'home', label: 'ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' },
                { id: 'advanced-dashboard', label: 'ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©' },
                { 
                    id: 'sales', 
                    label: 'ğŸ’° Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                    subsections: [
                        { id: 'salesManagement', label: 'ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±' },
                        { id: 'salesReturns', label: 'â†©ï¸ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¯Ø§Ø¦Ù†Ø©' },
                        { id: 'customerPayments', label: 'ğŸ’µ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' },
                        { id: 'customers', label: 'ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' }
                    ]
                },
                { 
                    id: 'purchases', 
                    label: 'ğŸ›’ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
                    subsections: [
                        { id: 'purchasesManagement', label: 'ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±' },
                        { id: 'supplierPayments', label: 'ğŸ’³ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†' },
                        { id: 'suppliers', label: 'ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†' },
                        { id: 'purchaseReturns', label: 'â†©ï¸ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª' }
                    ]
                },
                { 
                    id: 'items', 
                    label: 'ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',
                    subsections: [
                        { id: 'items', label: 'ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù' },
                        { id: 'storePermissions', label: 'ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©' },
                        { id: 'warehouses', label: 'ğŸ­ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª' },
                        { id: 'inventory', label: 'ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø±Ø¯' }
                    ]
                },
                { 
                    id: 'finance', 
                    label: 'ğŸ’¼ Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
                    subsections: [
                        { id: 'revenues', label: 'ğŸ’° Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰' },
                        { id: 'expenses', label: 'ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª' },
                        { id: 'bonds', label: 'ğŸ“„ Ø§Ù„Ø³Ù†Ø¯Ø§Øª' },
                        { id: 'advances', label: 'ğŸ’³ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù' },
                        { id: 'sadaqa', label: 'ğŸ¤² Ø§Ù„ØµØ¯Ù‚Ø©' }
                    ]
                },
                { 
                    id: 'accounting', 
                    label: 'ğŸ“š Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø©',
                    subsections: [
                        { id: 'journal', label: 'ğŸ““ Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©' },
                        { id: 'chartOfAccounts', label: 'ğŸ“‹ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª' }
                    ]
                },
                { 
                    id: 'hr', 
                    label: 'ğŸ‘¥ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©',
                    subsections: [
                        { id: 'employees', label: 'ğŸ‘¨â€ğŸ’¼ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†' },
                        { id: 'attendance', label: 'ğŸ“… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨Ø§Øª' },
                        { id: 'salaries', label: 'ğŸ’° Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨' }
                    ]
                },
                { id: 'assets', label: 'ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙˆÙ„' },
                { id: 'reports', label: 'ğŸ“Š Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±' },
                { id: 'settings', label: 'âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù†Ø¸Ø§Ù…' },
                { id: 'about', label: 'â„¹ï¸ Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬' }
            ];

            let sectionsToRender;
            if (role === 'admin') {
                sectionsToRender = baseSections;
            } else if (role === 'manager') {
                // Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ÙŠØ±Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø§Ø¹Ø¯Ø§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                sectionsToRender = baseSections;
            } else if (role === 'user') {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙŠØ±Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø§Ø¹Ø¯Ø§ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨
                sectionsToRender = baseSections.filter(section => !['settings', 'salaries'].includes(section.id));
            } else {
                sectionsToRender = baseSections.filter(section => !['salaries'].includes(section.id));
            }

            sidebarNav.innerHTML = '';
            sectionsToRender.forEach(section => {
                if (section.subsections) {
                    // Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø¹ Ø£Ù‚Ø³Ø§Ù… ÙØ±Ø¹ÙŠØ©
                    const button = document.createElement('button');
                    button.textContent = section.label;
                    button.className = 'has-subsection';
                    button.onclick = function() {
                        const subsectionDiv = this.nextElementSibling;
                        subsectionDiv.classList.toggle('show');
                        const isExpanded = this.classList.toggle('expanded');
                        
                        // If this is the Sales section, show Invoice Management by default when expanding
                        if (isExpanded && section.id === 'sales') {
                            showSection('salesManagement');
                        }
                    };
                    sidebarNav.appendChild(button);
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ div Ù„Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ©
                    const subsectionDiv = document.createElement('div');
                    subsectionDiv.className = 'sidebar-subsection';
                    section.subsections.forEach(sub => {
                        const subButton = document.createElement('button');
                        subButton.textContent = sub.label;
                        subButton.setAttribute('onclick', `showSection('${sub.id}')`);
                        subsectionDiv.appendChild(subButton);
                    });
                    sidebarNav.appendChild(subsectionDiv);
                } else {
                    // Ù‚Ø³Ù… Ø¹Ø§Ø¯ÙŠ Ø¨Ø¯ÙˆÙ† Ø£Ù‚Ø³Ø§Ù… ÙØ±Ø¹ÙŠØ©
                    const button = document.createElement('button');
                    button.textContent = section.label;
                    button.setAttribute('onclick', `showSection('${section.id}')`);
                    sidebarNav.appendChild(button);
                }
            });
            // Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø§Ù„ØµØ¯Ù‚Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (!document.getElementById('sadaqa')) {
                const container = document.querySelector('.container');
                if (container) {
                    const sadaqaSection = document.createElement('div');
                    sadaqaSection.id = 'sadaqa';
                    sadaqaSection.className = 'section';
                    sadaqaSection.innerHTML = `
                        <h2>ğŸ¤² Ø­Ø³Ø§Ø¨ Ø§Ù„ØµØ¯Ù‚Ø©</h2>
                        <div class="form-grid grid-4">
                            <input type="number" id="sadaqaAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„) *" min="1" required>
                            <input type="date" id="sadaqaDate" required>
                            <input type="text" id="sadaqaDesc" placeholder="ÙˆØµÙ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯">
                            <select id="sadaqaPaymentMethod" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                                <option value="cash">ğŸ’µ Ù†Ù‚Ø¯ÙŠ (ØµÙ†Ø¯ÙˆÙ‚)</option>
                                <option value="bank">ğŸ¦ Ø¨Ù†Ùƒ</option>
                            </select>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn-primary btn-add" onclick="addSadaqa()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease;">ğŸ’š Ø¥Ø¶Ø§ÙØ© ØµØ¯Ù‚Ø©</button>
                        </div>
                        <div id="sadaqaList" style="margin-top:2em;"></div>
                        <div id="sadaqaTotal" style="margin-top:1em; font-weight:bold;"></div>
                    `;
                    container.appendChild(sadaqaSection);
                    // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø³Ù…
                    setTimeout(() => { window.renderSadaqaList(); }, 0);
                }
            }
            // Ø¯ÙˆØ§Ù„ Ø§Ù„ØµØ¯Ù‚Ø©
            window.addSadaqa = async function() {
                const amount = parseFloat(document.getElementById('sadaqaAmount').value);
                const date = document.getElementById('sadaqaDate').value;
                const desc = document.getElementById('sadaqaDesc').value;
                const paymentMethod = document.getElementById('sadaqaPaymentMethod').value;
                if (!amount || !date) {
                    showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®', 'error');
                    return;
                }
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                const newSadaqa = { id: Date.now(), amount, date, desc, paymentMethod };
                sadaqat.push(newSadaqa);
                localStorage.setItem('sadaqat', JSON.stringify(sadaqat));
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ
                await createCharityJournalEntry(newSadaqa);
                
                document.getElementById('sadaqaAmount').value = '';
                document.getElementById('sadaqaDate').value = '';
                document.getElementById('sadaqaDesc').value = '';
                document.getElementById('sadaqaPaymentMethod').value = 'cash';
                renderSadaqaList();
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµØ¯Ù‚Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ', 'success');
            };
            window.renderSadaqaList = function() {
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                let html = '<table border="1" style="width:100%;text-align:center"><tr><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><th>Ø§Ù„ÙˆØµÙ</th><th style="text-align:left">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>';
                let total = 0;
                sadaqat.forEach((s, i) => {
                    const paymentIcon = s.paymentMethod === 'bank' ? 'ğŸ¦ Ø¨Ù†Ùƒ' : 'ğŸ’µ Ù†Ù‚Ø¯ÙŠ';
                    html += `<tr>
                        <td>${s.amount}</td>
                        <td>${s.date}</td>
                        <td>${paymentIcon}</td>
                        <td>${s.desc || ''}</td>
                        <td style='text-align:left'>
                            <div class='action-buttons' style='justify-content: flex-start;'>
                                <button class='btn-warning edit-btn' onclick="editSadaqa(${i})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class='btn-danger' onclick="deleteSadaqa(${i})">Ø­Ø°Ù</button>
                            </div>
                        </td>
                    </tr>`;
                    total += s.amount;
                });
                html += '</table>';
                document.getElementById('sadaqaList').innerHTML = html;
                document.getElementById('sadaqaTotal').innerText = 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ¯Ù‚Ø§Øª: ' + total + ' Ø±ÙŠØ§Ù„';
            };
            // Ø­Ø°Ù Ø³Ø¬Ù„ ØµØ¯Ù‚Ø©
            window.deleteSadaqa = function(idx) {
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) {
                    sadaqat.splice(idx, 1);
                    localStorage.setItem('sadaqat', JSON.stringify(sadaqat));
                    renderSadaqaList();
                }
            };
            // ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„ ØµØ¯Ù‚Ø©
            window.editSadaqa = function(idx) {
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                const s = sadaqat[idx];
                document.getElementById('sadaqaAmount').value = s.amount;
                document.getElementById('sadaqaDate').value = s.date;
                document.getElementById('sadaqaDesc').value = s.desc;
                document.getElementById('sadaqaPaymentMethod').value = s.paymentMethod || 'cash';
                // Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ØŒ Ù†Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…
                window._sadaqaEditIdx = idx;
                const btn = document.querySelector('#sadaqa .btn-add');
                if (btn) {
                    btn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
                    btn.onclick = function() {
                        const amount = parseFloat(document.getElementById('sadaqaAmount').value);
                        const date = document.getElementById('sadaqaDate').value;
                        const desc = document.getElementById('sadaqaDesc').value;
                        const paymentMethod = document.getElementById('sadaqaPaymentMethod').value;
                        if (!amount || !date) {
                            showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®', 'error');
                            return;
                        }
                        sadaqat[idx] = { ...sadaqat[idx], amount, date, desc, paymentMethod };
                        localStorage.setItem('sadaqat', JSON.stringify(sadaqat));
                        renderSadaqaList();
                        document.getElementById('sadaqaAmount').value = '';
                        document.getElementById('sadaqaDate').value = '';
                        document.getElementById('sadaqaDesc').value = '';
                        document.getElementById('sadaqaPaymentMethod').value = 'cash';
                        btn.textContent = 'ğŸ’š Ø¥Ø¶Ø§ÙØ© ØµØ¯Ù‚Ø©';
                        btn.onclick = addSadaqa;
                        window._sadaqaEditIdx = null;
                    };
                }
            };
            // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø³Ù…
            if (!window._sadaqaListLoaded) {
                document.addEventListener('DOMContentLoaded', window.renderSadaqaList);
                window._sadaqaListLoaded = true;
            }

            const activeSection = document.querySelector('.section.active');
            if (activeSection) {
                const activeButton = sidebarNav.querySelector(`button[onclick="showSection('${activeSection.id}')"]`);
                if (activeButton) {
                    activeButton.classList.add('active');
                }
            }
        }

        function updateLoggedInUserDisplay(user) {
            const userEl = document.getElementById('currentUserDisplay');
            if (userEl) {
                if (user) {
                    const displayName = (user.name && user.name.trim()) ? user.name : user.email || 'Ù…Ø³ØªØ®Ø¯Ù…';
                    const roleInfo = {
                        admin: { label: 'ğŸ”‘ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', cls: 'role-admin' },
                        manager: { label: 'ğŸ§­ Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·', cls: 'role-manager' },
                        user: { label: 'ğŸ‘¨â€ğŸ’¼ Ù…Ø³ØªØ®Ø¯Ù…', cls: 'role-user' }
                    };
                    const currentRole = roleInfo[user.role] || { label: 'Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', cls: '' };
                    userEl.innerHTML = `<span class="user-name">ğŸ‘¤ ${displayName}</span><span class="user-description">${currentRole.label}</span>`;
                    userEl.classList.remove('role-admin', 'role-manager', 'role-user');
                    if (currentRole.cls) {
                        userEl.classList.add(currentRole.cls);
                    }
                } else {
                    userEl.innerHTML = '<span class="user-name">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span><span class="user-description">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„</span>';
                    userEl.classList.remove('role-admin', 'role-manager', 'role-user');
                }
            }

            updateAccountInfoSection(user);
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ®ØµÙŠØµ Ø¹Ù† Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·
        function hideCustomizationForManagers(userRole) {
            if (userRole === 'manager') {
                // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ®ØµÙŠØµ
                const footerBtn = document.getElementById('footerSettingsBtn');
                const aboutBtn = document.getElementById('aboutSettingsBtn');
                if (footerBtn) footerBtn.style.display = 'none';
                if (aboutBtn) aboutBtn.style.display = 'none';
                
                // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… ØªØ®ØµÙŠØµ Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                const footerSection = document.getElementById('footerCustomizationSection');
                if (footerSection) footerSection.style.display = 'none';
            } else {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„Ù…Ø¯ÙŠØ±
                const footerBtn = document.getElementById('footerSettingsBtn');
                const aboutBtn = document.getElementById('aboutSettingsBtn');
                if (footerBtn) footerBtn.style.display = '';
                if (aboutBtn) aboutBtn.style.display = '';
                
                const footerSection = document.getElementById('footerCustomizationSection');
                if (footerSection) footerSection.style.display = '';
            }
        }

function updatePerformanceIndicators() {
    const monthlySummary = document.getElementById('monthlySummary');
    const financialPerformance = document.getElementById('financialPerformance');
    
    if (!monthlySummary || !financialPerformance) return;
    
    const currentMonth = new Date().toISOString().substring(0, 7);
    
    const monthSales = sales.filter(s => s.date.substring(0, 7) === currentMonth)
                          .reduce((sum, sale) => sum + sale.total, 0);
    const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === currentMonth)
                                .reduce((sum, expense) => sum + expense.amount, 0);
    const monthRevenue = revenues.filter(r => r.date.substring(0, 7) === currentMonth)
                               .reduce((sum, revenue) => sum + revenue.amount, 0);
    const monthPurchases = purchases.filter(p => p.date.substring(0, 7) === currentMonth)
                                  .reduce((sum, purchase) => sum + purchase.total, 0);

    const profitMargin = monthSales > 0 ? ((monthSales - monthPurchases - monthExpenses) / monthSales * 100).toFixed(1) : 0;
    const avgInvoice = monthSales / Math.max(sales.filter(s => s.date.substring(0, 7) === currentMonth).length, 1);

    monthlySummary.innerHTML = `
        <div style="margin-bottom: 15px;">
            <p style="margin: 8px 0; font-size: 14px;">ğŸ’° <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</strong> ${monthSales.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ’¸ <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</strong> ${monthExpenses.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ“ˆ <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:</strong> ${monthRevenue.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ¯ <strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</strong> ${sales.filter(s => s.date.substring(0, 7) === currentMonth).length}</p>
        </div>
    `;

    financialPerformance.innerHTML = `
        <div style="margin-bottom: 15px;">
            <p style="margin: 8px 0; font-size: 14px;">ğŸ“Š <strong>Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­:</strong> <span style="color: ${profitMargin > 0 ? '#27ae60' : '#e74c3c'}">${profitMargin}%</span></p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ“ˆ <strong>Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${avgInvoice.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ”„ <strong>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ:</strong> <span style="color: #27ae60">+15%</span></p>
            <p style="margin: 8px 0; font-size: 14px;">ğŸ¯ <strong>ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù:</strong> <span style="color: #27ae60">85%</span></p>
        </div>
    `;
}

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
function getLast7Days() {
    const days = [];
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toISOString().split('T')[0]);
    }
    return days;
}

        // === Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ===
        // ØªØ¹Ø±ÙŠÙ Ù…Ø¨ÙƒØ± Ù„Ø¯Ø§Ù„Ø© ØªØ¹Ø¨Ø¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ© Ù„Ù…Ù†Ø¹ Ø®Ø·Ø£ Ø¹Ø¯Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ
        function populateStorePermissionsSelects() {
            try {
                console.log('âš™ï¸ [Early] ØªØ¹Ø¨Ø¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©...');
                // ØªØ­Ù…ÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…ØµÙÙˆÙØ§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©
                if ((typeof customers === 'undefined' || !Array.isArray(customers)) && typeof loadFromLocalStorage === 'function') {
                    customers = loadFromLocalStorage('customers') || [];
                }
                if ((typeof suppliers === 'undefined' || !Array.isArray(suppliers)) && typeof loadFromLocalStorage === 'function') {
                    suppliers = loadFromLocalStorage('suppliers') || [];
                }
                if ((typeof warehouses === 'undefined' || !Array.isArray(warehouses)) && typeof loadFromLocalStorage === 'function') {
                    warehouses = loadFromLocalStorage('warehouses') || [];
                }

                const customerSelect = document.getElementById('permCustomer');
                if (customerSelect) {
                    customerSelect.innerHTML = '<option value="">Ø£ÙŠ Ø¹Ù…ÙŠÙ„</option>';
                    (customers || []).forEach(c => {
                        if (!c) return;
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.name || ('Ø¹Ù…ÙŠÙ„ #' + c.id);
                        customerSelect.appendChild(opt);
                    });
                }

                const supplierSelect = document.getElementById('permSupplier');
                if (supplierSelect) {
                    supplierSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>';
                    (suppliers || []).forEach(s => {
                        if (!s) return;
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.name || ('Ù…ÙˆØ±Ø¯ #' + s.id);
                        supplierSelect.appendChild(opt);
                    });
                }

                const warehouseSelect = document.getElementById('permWarehouse');
                if (warehouseSelect) {
                    warehouseSelect.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
                    (warehouses || []).forEach(w => {
                        if (!w) return;
                        const opt = document.createElement('option');
                        opt.value = w.id;
                        opt.textContent = w.name || ('Ù…Ø³ØªÙˆØ¯Ø¹ #' + w.id);
                        warehouseSelect.appendChild(opt);
                    });
                }

                console.log('âœ… [Early] Ø¥Ù†Ù‡Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©: Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', (customers||[]).length, 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†', (suppliers||[]).length);
            } catch (e) {
                console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø¨ÙƒØ±Ø© Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©', e);
            }
        }

       async function showSection(sectionId) {
    if (editingSaleId || editingPurchaseId) {
        const confirmed = await showConfirmDialog(
            'ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° âš ï¸',
            'Ù„Ø¯ÙŠÙƒ ÙØ§ØªÙˆØ±Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ØŸ',
            'warning',
            'Ø­Ø³Ù†Ø§Ù‹ØŒ Ø¥Ù„ØºØ§Ø¡',
            'Ø¥Ù„ØºØ§Ø¡'
        );
        if (!confirmed) {
            return;
        }
        resetInvoiceForms();
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙ‚Ø· Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù†Ù‡Ø§
    const currentSection = document.querySelector('.section.active');
    if (currentSection && currentSection.id === 'items' && sectionId !== 'items') {
        const confirmed = await confirmCancelItemEdit();
        if (!confirmed) {
            return; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ÙˆØ§Ù„Ø¨Ù‚Ø§Ø¡ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù
        }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù†Ù‡Ø§
    if (currentSection && currentSection.id === 'customers' && sectionId !== 'customers') {
        const confirmed = await confirmCancelCustomerEdit();
        if (!confirmed) {
            return; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ÙˆØ§Ù„Ø¨Ù‚Ø§Ø¡ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
    if (currentSection && currentSection.id === 'suppliers' && sectionId !== 'suppliers') {
        const confirmed = await confirmCancelSupplierEdit();
        if (!confirmed) return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    if (currentSection && currentSection.id === 'expenses' && sectionId !== 'expenses') {
        const confirmed = await confirmCancelExpenseEdit();
        if (!confirmed) return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
    if (currentSection && currentSection.id === 'revenues' && sectionId !== 'revenues') {
        const confirmed = await confirmCancelRevenueEdit();
        if (!confirmed) return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨
    if (currentSection && currentSection.id === 'salaries' && sectionId !== 'salaries') {
        const confirmed = await confirmCancelSalaryEdit();
        if (!confirmed) return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø£ØµÙˆÙ„
    if (currentSection && currentSection.id === 'assets' && sectionId !== 'assets') {
        const confirmed = await confirmCancelAssetEdit();
        if (!confirmed) return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù
    if (currentSection && currentSection.id === 'advances' && sectionId !== 'advances') {
        const confirmed = await confirmCancelAdvanceEdit();
        if (!confirmed) return;
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„Ø¨ØµØ±ÙŠØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
    document.querySelectorAll('input.editing-mode, select.editing-mode, textarea.editing-mode').forEach(input => {
        input.classList.remove('editing-mode');
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
    document.querySelectorAll('.btn-primary.update-mode').forEach(btn => {
        const originalText = btn.getAttribute('data-original-text');
        if (originalText) {
            btn.innerHTML = originalText;
            btn.removeAttribute('data-original-text');
        }
        btn.classList.remove('update-mode');
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    document.querySelectorAll('.section h2').forEach(h2 => {
        h2.style.color = '';
    });
    
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ±ÙŠØº Ù„Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡Ø§
    if (typeof clearItemForm === 'function') clearItemForm();
    if (typeof clearCustomerForm === 'function') clearCustomerForm();
    if (typeof clearSupplierForm === 'function') clearSupplierForm();
    if (typeof clearExpenseForm === 'function') clearExpenseForm();
    if (typeof clearRevenueForm === 'function') clearRevenueForm();
    if (typeof clearSalaryForm === 'function') clearSalaryForm();
    if (typeof clearAssetForm === 'function') clearAssetForm();
    if (typeof clearAdvanceForm === 'function') clearAdvanceForm();

    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    document.querySelectorAll('.sidebar-nav button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙ‚Ø·
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø· ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    const activeButton = Array.from(document.querySelectorAll('.sidebar-nav button')).find(
        btn => btn.getAttribute('onclick') === `showSection('${sectionId}')`
    );
    if(activeButton) activeButton.classList.add('active');

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
    if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('open');
    }
    
    // ğŸ  ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    if (sectionId === 'home') {
        console.log('ğŸ  ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª...');
        if (typeof updateDashboard === 'function') {
            updateDashboard();
        }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØµØºØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
    if (sectionId === 'items') {
        const miniStatItemsEl = document.getElementById('miniStatItems');
        if (miniStatItemsEl) miniStatItemsEl.textContent = items.length;
        renderItems();
        generateItemCode();
    }
    else if (sectionId === 'addItem') {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        const codeField = document.getElementById('itemCodeNew');
        const isEditMode = codeField && codeField.dataset.originalCode;
        
        // ÙÙ‚Ø· ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ù„Ù… Ù†ÙƒÙ† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        if (!isEditMode) {
            generateItemCodeNew();
        }
    }
    else if (sectionId === 'customers') {
        const miniStatCustomersEl = document.getElementById('miniStatCustomers');
        if (miniStatCustomersEl) miniStatCustomersEl.textContent = customers.length;
        renderCustomers();
        generateCustomerCode();
    }
    else if (sectionId === 'suppliers') {
        const miniStatSuppliersEl = document.getElementById('miniStatSuppliers');
        if (miniStatSuppliersEl) miniStatSuppliersEl.textContent = suppliers.length;
        renderSuppliers();
        generateSupplierCode();
    }
    else if (sectionId === 'storePermissions') {
        // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø©
        setTimeout(() => {
            if (typeof populateStorePermissionsSelects === 'function') {
                populateStorePermissionsSelects();
            } else {
                console.error('populateStorePermissionsSelects is not defined even after timeout');
            }
        }, 100);
    }
    else if (sectionId === 'warehouses') {
        if (typeof renderWarehouses === 'function') {
            renderWarehouses();
        }
    }
    else if (sectionId === 'purchases') {
        const miniStatPurchasesEl = document.getElementById('miniStatPurchases');
        if (miniStatPurchasesEl) miniStatPurchasesEl.textContent = purchases.length;
        updatePurchaseDropdowns();
        generatePurchaseCode();
        const purchaseDateEl = document.getElementById('purchaseDate');
        if (purchaseDateEl) purchaseDateEl.value = new Date().toISOString().split('T')[0];
    }
    else if (sectionId === 'sales') {
        const miniStatSalesEl = document.getElementById('miniStatSales');
        if (miniStatSalesEl) miniStatSalesEl.textContent = sales.length;
        updateSaleDropdowns();
        generateSaleCode();
        const saleDateEl = document.getElementById('saleDate');
        if (saleDateEl) saleDateEl.value = new Date().toISOString().split('T')[0];
    }
    else if (sectionId === 'expenses') {
        const miniStatExpensesEl = document.getElementById('miniStatExpenses');
        if (miniStatExpensesEl) miniStatExpensesEl.textContent = expenses.length;
        updateExpenseStats();
        renderExpenses();
        const expenseDateEl = document.getElementById('expenseDate');
        if (expenseDateEl) expenseDateEl.value = new Date().toISOString().split('T')[0];
    } else if (sectionId === 'revenues') {
        const miniStatRevenuesEl = document.getElementById('miniStatRevenues');
        if (miniStatRevenuesEl) miniStatRevenuesEl.textContent = revenues.length;
        updateRevenueStats();
        renderRevenues();
        const revenueDateEl = document.getElementById('revenueDate');
        if (revenueDateEl) revenueDateEl.value = new Date().toISOString().split('T')[0];
    } else if (sectionId === 'bonds') {
        renderBonds();
        const bondDateEl = document.getElementById('bondDate');
        if (bondDateEl) bondDateEl.value = new Date().toISOString().split('T')[0];
    } else if (sectionId === 'salaries') {
        renderSalaries();
        updateSalarySummary();
    } else if (sectionId === 'employees') {
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        const storedEmployees = loadFromLocalStorage('employees');
        if (storedEmployees) employees = storedEmployees;
        renderEmployees();
    } else if (sectionId === 'attendance') {
        // ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨
        initializeAttendanceYears();
        initializeAttendanceMonth();
    } else if (sectionId === 'salaries') {
        // ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨
        initializePayrollYears();
        initializePayrollMonth();
    } else if (sectionId === 'advances') {
        const miniStatAdvancesEl = document.getElementById('miniStatAdvances');
        if (miniStatAdvancesEl) miniStatAdvancesEl.textContent = advances.length;
        renderAdvances();
        updateAdvanceStats();
        setupAdvanceSearch();
        const advanceDateEl = document.getElementById('advanceDate');
        if (advanceDateEl) advanceDateEl.value = new Date().toISOString().split('T')[0];
 
    } else if (sectionId === 'inventory') {
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø±Ø¯
        if (typeof renderInventoryHistory === 'function') {
            renderInventoryHistory();
        }
        if (typeof updateInventoryStatistics === 'function') {
            updateInventoryStatistics();
        }
        const miniStatInventoryEl = document.getElementById('miniStatInventory');
        if (miniStatInventoryEl && inventoryAdjustments) {
            miniStatInventoryEl.textContent = inventoryAdjustments.length;
        }
 
    } else if (sectionId === 'advanced-dashboard') {
        try {
            console.log('ğŸ“Š ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© - Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ØªÙˆÙØ±Ù‡Ø§
            if (!sales || sales.length === 0) {
                const stored = loadFromLocalStorage('sales');
                if (stored) sales = stored;
            }
            if (!purchases || purchases.length === 0) {
                const stored = loadFromLocalStorage('purchases');
                if (stored) purchases = stored;
            }
            if (!expenses || expenses.length === 0) {
                const stored = loadFromLocalStorage('expenses');
                if (stored) expenses = stored;
            }
            if (!revenues || revenues.length === 0) {
                const stored = loadFromLocalStorage('revenues');
                if (stored) revenues = stored;
            }
            
            console.log('ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„:', {
                sales: sales ? sales.length : 0,
                purchases: purchases ? purchases.length : 0,
                expenses: expenses ? expenses.length : 0,
                revenues: revenues ? revenues.length : 0
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
            if (typeof updateAdvancedDashboardCards === 'function') {
                updateAdvancedDashboardCards();
            }
            
            // ğŸ†• ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
            setTimeout(() => {
                if (typeof updateAllCharts === 'function') {
                    updateAllCharts();
                }
            }, 300); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            
            if (typeof initAdvancedDashboard === 'function') {
                initAdvancedDashboard();
            } else {
                console.warn('âš ï¸ Ø¯Ø§Ù„Ø© initAdvancedDashboard ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©:', error);
        }
    } else if (sectionId === 'returns') {
        showReturnTab('sales');
    } else if (sectionId === 'customerPayments') {
        // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø³Ù… Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        console.log('ğŸ’µ ÙØªØ­ Ù‚Ø³Ù… Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡');
        renderCustomerPayments();
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„Ø§ØªØ±
        if (document.getElementById('paymentSearchCustomer')) {
            document.getElementById('paymentSearchCustomer').value = '';
            document.getElementById('paymentSearchTransactionId').value = '';
            document.getElementById('paymentSearchInvoiceId').value = '';
            document.getElementById('paymentTypeFilter').value = 'all';
            document.getElementById('paymentDateFrom').value = '';
            document.getElementById('paymentDateTo').value = '';
            document.getElementById('paymentMethodFilter').value = 'all';
        }
    } else if (sectionId === 'supplierPayments') {
        // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø³Ù… Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        console.log('ğŸ’³ ÙØªØ­ Ù‚Ø³Ù… Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†');
        renderSupplierPayments();
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„Ø§ØªØ±
        if (document.getElementById('supplierPaymentSearchSupplier')) {
            document.getElementById('supplierPaymentSearchSupplier').value = '';
            document.getElementById('supplierPaymentSearchTransactionId').value = '';
            document.getElementById('supplierPaymentSearchInvoiceId').value = '';
            document.getElementById('supplierPaymentTypeFilter').value = 'all';
            document.getElementById('supplierPaymentDateFrom').value = '';
            document.getElementById('supplierPaymentDateTo').value = '';
            document.getElementById('supplierPaymentMethodFilter').value = 'all';
        }
    } else if (sectionId === 'inventory') {
        // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø±Ø¯
        console.log('ğŸ“‹ ÙØªØ­ Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø±Ø¯');
        if (typeof renderInventoryHistory === 'function') {
            renderInventoryHistory();
        }
        if (typeof updateInventoryStatistics === 'function') {
            updateInventoryStatistics();
        }
    } else if (sectionId === 'salesReturns') {
        renderSalesReturnsNew();
    } else if (sectionId === 'salesManagement') {
        renderSalesManagement();
        loadCustomersToSalesFilterManagement();
    } else if (sectionId === 'purchaseReturns') {
        renderPurchaseReturnsNew();
    } else if (sectionId === 'settings') {
        const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        const userManagementSection = document.getElementById('userManagementSection');
        const activityManagementSection = document.getElementById('activityManagementSection');
        const branchManagementSection = document.getElementById('branchManagementSection');
        const footerSettingsSection = document.getElementById('footerSettingsSection');

        if (userManagementSection) {
            if (loggedInUser && (loggedInUser.role === 'admin' || loggedInUser.role === 'manager')) {
                userManagementSection.style.display = 'block';
            } else {
                userManagementSection.style.display = 'none';
            }
        }

        if (activityManagementSection) {
            // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆÙ…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø§Ù„ÙˆØµÙˆÙ„
            if (loggedInUser && (loggedInUser.role === 'admin' || loggedInUser.role === 'manager')) {
                activityManagementSection.style.display = 'block';
                
                // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ±
                const newActivityInput = document.getElementById('settingNewActivityName');
                const addActivityContainer = newActivityInput ? newActivityInput.parentElement : null;
                const deleteBtn = document.getElementById('deleteSelectedActivityBtn');
                
                if (loggedInUser.role === 'manager') {
                    // Ø¥Ø®ÙØ§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯ ÙˆØ­Ø°Ù Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·
                    if (addActivityContainer) addActivityContainer.style.display = 'none';
                    if (deleteBtn) deleteBtn.style.display = 'none';
                } else {
                    // Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…
                    if (addActivityContainer) addActivityContainer.style.display = 'grid';
                    if (deleteBtn) deleteBtn.style.display = 'flex';
                }
            } else {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø©
                activityManagementSection.style.display = 'none';
            }
        }

        // ğŸª Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆÙ…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·
        if (branchManagementSection) {
            if (loggedInUser && (loggedInUser.role === 'admin' || loggedInUser.role === 'manager')) {
                branchManagementSection.style.display = 'block';
                renderBranches(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else {
                branchManagementSection.style.display = 'none';
            }
        }

        // ğŸ“„ Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        if (footerSettingsSection) {
            footerSettingsSection.style.display = 'block';
            loadFooterSettings(); // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· Ø¹Ù„Ù‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        if (loggedInUser && loggedInUser.role === 'manager') {
            restrictManagerUserManagement(loggedInUser);
        }

        if (loggedInUser && (loggedInUser.role === 'admin' || loggedInUser.role === 'manager')) {
            document.getElementById('activityLogoSection').style.display = 'block';
        } else {
            document.getElementById('activityLogoSection').style.display = 'none';
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        console.log('ğŸ“‹ ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        renderActivitiesInSettings();
        renderUsersInSettings();
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙ‚Ø·
        const fullBackupBtn = document.getElementById('fullBackupBtn');
        if (fullBackupBtn) {
            if (loggedInUser && loggedInUser.role === 'admin') {
                fullBackupBtn.style.display = 'block';
            } else {
                fullBackupBtn.style.display = 'none';
            }
        }
        
        // ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙˆØ§Ù„ÙØ±ÙˆØ¹)
        switchSettingsTab('activities');
        
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø¹Ù„Ù‰ Ø¹Ù†Ø¯ ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        setTimeout(() => {
            const settingsSection = document.getElementById('settings');
            if (settingsSection) {
                settingsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 100);
    } else if (sectionId === 'about') {
        // ğŸ“± ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        loadAboutPageOnOpen();
    } else if (sectionId === 'journal') {
        // ğŸ“’ ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
        if (chartOfAccounts.length === 0) {
            console.log('âš ï¸ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙØ§Ø±Øº - Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©');
            initializeChartOfAccounts();
        }
        initializeAccountSelects();
        clearJournalForm();
        renderJournalList();
    } else if (sectionId === 'chartOfAccounts') {
        // ğŸ—‚ï¸ ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        if (chartOfAccounts.length === 0) {
            console.log('âš ï¸ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙØ§Ø±Øº - Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©');
            initializeChartOfAccounts();
        }
        renderChartOfAccounts();
    }
}

        /**
         * Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
         */
        function switchSettingsTab(tabName) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
            document.querySelectorAll('.settings-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            const tabContents = {
                'users': 'usersTabContent',
                'activities': 'activitiesTabContent',
                'general': 'generalTabContent',
                'backup': 'backupTabContent'
            };
            
            const contentId = tabContents[tabName];
            const contentElement = document.getElementById(contentId);
            if (contentElement) {
                contentElement.classList.add('active');
            }
            
            // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø©
            event.currentTarget.classList.add('active');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø©
            if (tabName === 'activities') {
                renderActivitiesInSettings();
                renderBranches();
            } else if (tabName === 'users') {
                renderUsersInSettings();
            } else if (tabName === 'general') {
                loadFooterSettings();
            }
        }

        /**
         * ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
         */
        function restrictManagerUserManagement(loggedInUser) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù… Ø£Ùˆ Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø· Ø¢Ø®Ø±
            const roleSelect = document.getElementById('newUserRole');
            if (roleSelect) {
                // Ø¥Ø®ÙØ§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± - ÙÙ‚Ø· ÙŠØ³ØªØ·ÙŠØ¹ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ø§Ø¯ÙŠÙŠÙ†
                Array.from(roleSelect.options).forEach(option => {
                    if (option.value === 'admin' || option.value === 'manager') {
                        option.style.display = 'none';
                    } else if (option.value === 'user') {
                        option.style.display = 'block';
                        option.selected = true; // ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ ÙƒØ®ÙŠØ§Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ
                    }
                });
            }

            // Ù‚ÙŠØ¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø´Ø§Ø· - ÙÙ‚Ø· Ù†Ø´Ø§Ø· Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
            const activitySelect = document.getElementById('newUserActivity');
            if (activitySelect && loggedInUser.activityId) {
                // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø¹Ø¯Ø§ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø¯ÙŠØ±
                Array.from(activitySelect.options).forEach(option => {
                    if (option.value === '' || option.value === loggedInUser.activityId) {
                        option.style.display = 'block';
                        if (option.value === loggedInUser.activityId) {
                            option.selected = true; // ØªØ­Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
                        }
                    } else {
                        option.style.display = 'none';
                    }
                });

                // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
                const managerNote = document.createElement('p');
                managerNote.id = 'manager-restriction-note';
                managerNote.style.cssText = 'color: #2196F3; font-size: 0.9em; margin: 10px 0; padding: 15px; background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); border-radius: 8px; border-right: 4px solid #2196F3; box-shadow: 0 2px 4px rgba(33,150,243,0.1);';
                managerNote.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5em;">ğŸ§­</span>
                        <div>
                            <strong>ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·:</strong>
                            <ul style="margin: 5px 0; padding-right: 15px;">
                                <li>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ø§Ø¯ÙŠÙŠÙ† Ù„Ù†Ø´Ø§Ø·Ùƒ ÙÙ‚Ø·</li>
                                <li>ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ù†Ø´Ø§Ø·Ùƒ ÙÙ‚Ø·</li>
                                <li>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠØ±ÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø£Ùˆ Ù…Ø¯ÙŠØ±ÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø£Ø®Ø±Ù‰</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
                const existingNote = document.getElementById('manager-restriction-note');
                if (existingNote) {
                    existingNote.remove();
                }
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ form Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const newUserForm = document.getElementById('newUserForm');
                if (newUserForm && newUserForm.parentNode) {
                    newUserForm.parentNode.insertBefore(managerNote, newUserForm.nextSibling);
                }
            }

            // ØªÙ‚ÙŠÙŠØ¯ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ù†Ø´Ø§Ø·Ù‡ ÙÙ‚Ø·
            restrictManagerUsersList(loggedInUser);
        }

        /**
         * ØªÙ‚ÙŠÙŠØ¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· - Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ù†Ø´Ø§Ø·Ù‡ ÙÙ‚Ø·
         */
        function restrictManagerUsersList(loggedInUser) {
            const usersDropdown = document.getElementById('usersDropdown');
            if (usersDropdown && loggedInUser.activityId) {
                // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù†Ø´Ø§Ø·
                Array.from(usersDropdown.options).forEach(option => {
                    if (option.value === '') {
                        option.style.display = 'block'; // Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ "Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§"
                        return;
                    }

                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                    const user = users.find(u => u.email === option.value);
                    if (user) {
                        if (user.activityId === loggedInUser.activityId || user.email === loggedInUser.email) {
                            option.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ù†ÙØ³ Ø§Ù„Ù†Ø´Ø§Ø· + Ø§Ù„Ù…Ø¯ÙŠØ± Ù†ÙØ³Ù‡
                        } else {
                            option.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
                        }
                    } else {
                        option.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
                    }
                });
            }
        }

        // ===== Activity and Header Functions =====
        function updateHeaderForActivity(activity) {
            if (activity) {
                document.getElementById('activityHeaderTitle').textContent = activity.name;
                document.getElementById('activityHeaderSubtitle').style.display = 'none';
                
                // Load activity logo
                loadActivityLogo();
            } else {
                document.getElementById('activityHeaderTitle').textContent = 'Ø¯ÙŠÙˆØ§Ù†ÙŠ';
                document.getElementById('activityHeaderSubtitle').style.display = 'block';
                
                // Hide activity logo
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) headerLogo.style.display = 'none';
            }

console.log('ğŸ” Reached line ~10000 in main script...');

            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            updateAccountInfoSection(loggedInUser);
        }
        
        function getActivityDataKey(baseKey) {
            if (!currentActivityId) return null;
            return `activity_${currentActivityId}_${baseKey}`;
        }
        
        async function loadActivities() {
            try {
                console.log("ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©...");
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase Ø£ÙˆÙ„Ø§Ù‹
                if (USE_FIREBASE) {
                    const firebaseActivities = await firebaseLoadActivitiesDirectly();
                    if (firebaseActivities && firebaseActivities.length > 0) {
                        activities = firebaseActivities;
                        console.log(`ğŸ”¥âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${activities.length} Ù†Ø´Ø§Ø· Ù…Ù† Firebase`);
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
                        const activitySelect = document.getElementById('userActivitySelect');
                        if (activitySelect) {
                            activitySelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø£ÙˆÙ„Ø§Ù‹ --</option>';
                            activities.forEach(act => {
                                activitySelect.innerHTML += `<option value="${act.id}">${act.name}</option>`;
                            });
                        }
                        return;
                    }
                }
                
                // Ø¥Ø°Ø§ ÙØ´Ù„ FirebaseØŒ Ø­Ù…Ù‘Ù„ Ù…Ù† LocalStorage
                console.log("ğŸ”„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ...");
                let rawData = loadFromLocalStorage('diwan_activities');
                console.log("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù… Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ:", rawData);

                if (!Array.isArray(rawData) && rawData) {
                    rawData = [];
                }

                if ((!rawData || rawData.length === 0) && typeof localStorage !== 'undefined') {
                    const legacyActivities = [];
                    const legacyKeys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.endsWith('_diwan_activities')) {
                            try {
                                const raw = JSON.parse(localStorage.getItem(key) || '[]');
                                if (Array.isArray(raw) && raw.length) {
                                    raw.forEach(candidate => {
                                        if (!candidate || !candidate.id) return;
                                        const exists = legacyActivities.some(act => String(act.id) === String(candidate.id));
                                        if (!exists) {
                                            legacyActivities.push(candidate);
                                        }
                                    });
                                }
                                legacyKeys.push(key);
                            } catch (legacyError) {
                                console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ù†Ø´Ø·Ø© Ù‚Ø¯ÙŠÙ…Ø©:', legacyError);
                            }
                        }
                    }

                    if (legacyActivities.length) {
                        console.log(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${legacyActivities.length} Ù†Ø´Ø§Ø· ÙÙŠ Ù…ÙØ§ØªÙŠØ­ Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ø³ÙŠØªÙ… Ù†Ù‚Ù„Ù‡Ù… Ù„Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯`);
                        rawData = legacyActivities;
                        saveToLocalStorage('diwan_activities', rawData);
                        legacyKeys.forEach(key => localStorage.removeItem(key));
                    }
                }

                activities = rawData || [];
                console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${activities.length} Ù†Ø´Ø§Ø·:`, activities);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ù†ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (activities.length > 0) {
                    console.log("Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø£Ù†Ø´Ø·Ø©:");
                    activities.forEach((act, index) => {
                        console.log(`Ø§Ù„Ù†Ø´Ø§Ø· ${index + 1}:`, { id: act.id, name: act.name });
                    });
                }
                
                const activitySelect = document.getElementById('userActivitySelect');
                if (activitySelect) {
                    activitySelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø£ÙˆÙ„Ø§Ù‹ --</option>';
                    activities.forEach(act => {
                        activitySelect.innerHTML += `<option value="${act.id}">${act.name}</option>`;
                    });
                }
            } catch (error) {
                console.error("Ø®Ø·Ø£ ØªÙØµÙŠÙ„ÙŠ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©:", error);
                activities = [];
            }
        }

        // === Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase (ØªØ¬Ø§Ù‡Ù„ GLOBAL_STORAGE_KEYS) ===
        async function firebaseSaveActivitiesDirectly(activitiesArray) {
            if (!USE_FIREBASE) return false;
            
            try {
                const { ref, set } = window.firebaseModules;
                const database = window.firebaseDatabase;
                
                if (!database) {
                    console.warn('âš ï¸ Firebase Database ØºÙŠØ± Ù…ØªØ§Ø­');
                    return false;
                }

                console.log('ğŸ”¥ Ø­ÙØ¸ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase...');
                
                // Ø­ÙØ¸ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase Database Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù†Ø´Ø·Ø©
                // Ù†Ø³ØªØ®Ø¯Ù… activities Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† activitiesList Ù„ØªØ¬Ù†Ø¨ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·
                const activitiesListRef = ref(database, 'activities');
                
                // ØªØ­ÙˆÙŠÙ„ Array Ø¥Ù„Ù‰ Object Ù…ÙÙ‡Ø±Ø³ Ø¨Ø§Ù„Ù€ id Ù…Ø¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const activitiesObject = {};
                activitiesArray.forEach(activity => {
                    if (activity.id) {
                        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                        activitiesObject[activity.id] = {
                            id: activity.id,
                            name: activity.name || 'Ù†Ø´Ø§Ø· Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
                            createdAt: activity.createdAt || new Date().toISOString(),
                            createdBy: activity.createdBy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
                        };
                    }
                });
                
                // Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Ù…ÙƒØ§Ù† Ù…Ù†ÙØµÙ„ Ù„ØªØ¬Ù†Ø¨ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù†Ø´Ø·Ø©
                await set(activitiesListRef, activitiesObject);
                
                console.log('ğŸ”¥âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase Database (activities)');
                console.log('ğŸ›¡ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ© Ù…Ø­Ù…ÙŠØ© ÙˆÙ„Ù† ØªÙÙ…Ø³Ø­');
                return true;
                
            } catch (error) {
                console.error('ğŸ”¥âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Firebase:', error);
                return false;
            }
        }
        
        function showActivityModal() {
            // Security Check: Only Admin can switch activities
            const user = JSON.parse(sessionStorage.getItem('loggedInUser') || 'null');
            if (user && user.role !== 'admin') {
                 showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù….', 'warning');
                 return;
            }

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©
            loadActivities();
            
            document.getElementById('activity-overlay').style.display = 'flex';
            document.querySelector('.app-container').style.display = 'none';
            renderActivitiesInModal();
        }
        
        function renderActivitiesInModal() {
            console.log(`Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© - Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù†Ø´Ø·Ø©: ${activities.length}`);
            const listDiv = document.getElementById('activity-list');
            listDiv.innerHTML = '';
            if (activities.length === 0) {
                console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§");
                listDiv.innerHTML = '<p>Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯. Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯ Ù„Ù„Ø¨Ø¯Ø¡.</p>';
            } else {
                console.log("Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù†Ø´Ø·Ø©:", activities.map(a => a.name));
                activities.forEach(activity => {
                    const button = document.createElement('button');
                    button.className = 'btn-primary activity-btn';
                    button.textContent = activity.name;
                    button.onclick = () => selectActivity(activity.id);
                    listDiv.appendChild(button);
                });
            }
        }
        
    async function addNewActivity(fromSettings = false) {
            const inputId = fromSettings ? 'settingNewActivityName' : 'newActivityName';
            const activityName = document.getElementById(inputId).value.trim();
            if (!activityName) {
                showNotification('âš ï¸ Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„Ù†Ø´Ø§Ø·', 'warning');
                return;
            }

            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const newActivity = {
                id: Date.now(),
                name: activityName,
                createdBy: loggedInUser ? loggedInUser.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                createdAt: new Date().toISOString()
            };
            activities.push(newActivity);
            await saveActivities();
            document.getElementById(inputId).value = '';

            if (fromSettings) {
                renderActivitiesInSettings();
            } else {
                selectActivity(newActivity.id);
            }
        }

        async function selectActivity(id) {
            console.log(`Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø´Ø§Ø·: ${id}`);
            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·...');
            
            try {
                // Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
                if (!activities || activities.length === 0) {
                    console.log('âš ï¸ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ØºÙŠØ± Ù…Ø­Ù…Ù„Ø© ÙÙŠ selectActivityØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
                    await loadActivities();
                }

                currentActivityId = id;
                sessionStorage.setItem('currentActivityId', id);
                console.log(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø´Ø§Ø· ÙÙŠ sessionStorage: ${id}`);
                
                const activity = activities.find(a => a.id == id);
                
                console.log('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·:', activity);
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ sessionStorage Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø±
                if (activity) {
                    sessionStorage.setItem('currentActivity', JSON.stringify(activity));
                }
                
                updateHeaderForActivity(activity);
                document.getElementById('activity-overlay').style.display = 'none';
                document.querySelector('.app-container').style.display = 'flex';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø´Ø§Ø·
                const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
                if (user) {
                    updateSidebar(user.role);
                }

                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆÙØ± Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡
                console.log('ğŸ” ÙØ­Øµ Ø­Ø§Ù„Ø© initializeApp:', {
                    'window.initializeApp type': typeof window.initializeApp,
                    'window.initializeApp value': window.initializeApp,
                    'initializeApp type': typeof initializeApp,
                    'initializeApp value': initializeApp
                });
                
                if (typeof window.initializeApp === 'function') {
                    console.log('âœ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ initializeApp Ù…Ù† window');
                    await window.initializeApp();
                } else if (typeof initializeApp === 'function') {
                    console.log('âœ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ initializeApp Ù…Ø¨Ø§Ø´Ø±Ø©');
                    await initializeApp();
                } else {
                    console.warn('âš ï¸ initializeApp ØºÙŠØ± Ù…ØªØ§Ø­Ø© - Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ¹Ø±ÙŠÙ Ù…Ø¤Ø¬Ù„...');
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
                    let attempts = 0;
                    const maxAttempts = 10;
                    const checkInterval = 100;
                    
                    const tryInitialize = async () => {
                        console.log(`ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ${attempts + 1}/${maxAttempts} - Ù†ÙˆØ¹ window.initializeApp:`, typeof window.initializeApp);
                        
                        if (typeof window.initializeApp === 'function') {
                            console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ initializeApp - Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¢Ù†...');
                            try { 
                                await window.initializeApp(); 
                                console.log('âœ… ØªÙ…Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­');
                            } catch (e) { 
                                console.error('âŒ Ø¥Ø®ÙØ§Ù‚ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¤Ø¬Ù„Ø©:', e); 
                            }
                            return;
                        }
                        
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(tryInitialize, checkInterval);
                        } else {
                            console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ initializeApp Ø¨Ø¹Ø¯', maxAttempts, 'Ù…Ø­Ø§ÙˆÙ„Ø§Øª');
                            console.log('ğŸš¨ Ø­Ø§Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©:', {
                                'window.initializeApp': window.initializeApp,
                                'typeof window.initializeApp': typeof window.initializeApp
                            });
                        }
                    };
                    
                    tryInitialize();
                }
                
                // ğŸ  Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
                console.log('ğŸ  Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...');
                setTimeout(() => {
                    const homeSection = document.getElementById('home');
                    if (homeSection && !homeSection.classList.contains('active')) {
                        console.log('ğŸ”„ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...');
                        showSection('home');
                    } else {
                        console.log('âœ… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù†Ø´Ø·Ø© Ø¨Ø§Ù„ÙØ¹Ù„');
                        // ğŸ”„ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ù†Ø´Ø·Ø©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
                        console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...');
                        if (typeof updateDashboard === 'function') {
                            updateDashboard();
                        }
                    }
                }, 500);
                
                hideLoading();
            } catch (error) {
                hideLoading();
                logError('Select Activity', error);
            }
        }
        
        function renderActivitiesInSettings() {
            const dropdown = document.getElementById('activitiesDropdown');
            if (!dropdown) return;

            const previousSelection = dropdown.value;
            dropdown.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù†Ø´Ø§Ø·Ù‹Ø§</option>';

            activities.forEach(activity => {
                const option = document.createElement('option');
                option.value = activity.id;
                option.textContent = activity.name;
                dropdown.appendChild(option);
            });

            if (previousSelection && activities.some(a => String(a.id) === previousSelection)) {
                dropdown.value = previousSelection;
            } else {
                dropdown.value = '';
            }

            handleActivitySelection();
        }

        function handleActivitySelection() {
            const dropdown = document.getElementById('activitiesDropdown');
            const infoBox = document.getElementById('selectedActivityInfo');
            const actionsBox = document.getElementById('selectedActivityActions');
            const nameInput = document.getElementById('selectedActivityName');
            const editBtn = document.getElementById('editSelectedActivityBtn');
            const deleteBtn = document.getElementById('deleteSelectedActivityBtn');

            if (!dropdown) return;

            const selectedId = dropdown.value;
            const activity = activities.find(a => String(a.id) === selectedId);

            if (!activity) {
                if (infoBox) infoBox.style.display = 'none';
                if (actionsBox) actionsBox.style.display = 'none';
                if (nameInput) nameInput.value = '';
                if (editBtn) editBtn.disabled = true;
                if (deleteBtn) deleteBtn.disabled = true;
                return;
            }

            if (infoBox) infoBox.style.display = 'block';
            if (actionsBox) actionsBox.style.display = 'flex';
            if (nameInput) nameInput.value = activity.name;
            if (editBtn) editBtn.disabled = false;
            if (deleteBtn) deleteBtn.disabled = false;
        }

        function handleEditSelectedActivity() {
            const dropdown = document.getElementById('activitiesDropdown');
            if (!dropdown || !dropdown.value) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø´Ø§Ø· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'warning');
                return;
            }
            const activityId = Number(dropdown.value);
            if (!Number.isNaN(activityId)) {
                editActivity(activityId);
            }
        }

        function handleDeleteSelectedActivity() {
            const dropdown = document.getElementById('activitiesDropdown');
            if (!dropdown || !dropdown.value) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø´Ø§Ø· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'warning');
                return;
            }
            const activityId = Number(dropdown.value);
            if (!Number.isNaN(activityId)) {
                deleteActivity(activityId);
            }
        }

        async function editActivity(id) {
            const activityIndex = activities.findIndex(a => a.id === id);
            if (activityIndex === -1) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }

            // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            openEditActivityModal(id);
        }
        
        async function deleteActivity(id) {
            if (id == currentActivityId) {
                showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…ÙØªÙˆØ­ Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            const activity = activities.find(a => a.id === id);
            const confirmed = await showConfirmDialog(
                'Ø­Ø°Ù Ø§Ù„Ù†Ø´Ø§Ø· Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
                `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù†Ø´Ø§Ø· "${activity.name}"ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`,
                'danger',
                'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                const dataKeys = ['items', 'customers', 'suppliers', 'purchases', 'sales', 'salesReturns', 'purchaseReturns', 'expenses', 'revenues', 'lastBackup'];
                for (const key of dataKeys) {
                    removeFromLocalStorage(key);
                }
                activities = activities.filter(a => a.id !== id);
                await saveActivities();
                renderActivitiesInSettings();
            }
        }

        // ===== ğŸª Branch Management Functions - Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹ =====
        
        // Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯
        async function addBranch() {
            const branchName = document.getElementById('newBranchName').value.trim();
            
            if (!branchName) {
                showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹', 'warning');
                return;
            }
            
            if (!currentActivityId) {
                showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø´Ø§Ø· Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ø³Ù…
            const exists = branches.find(b => b.name === branchName && b.activityId === currentActivityId);
            if (exists) {
                showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠÙˆØ¬Ø¯ ÙØ±Ø¹ Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
                return;
            }
            
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            
            const newBranch = {
                id: Date.now(),
                activityId: currentActivityId,
                name: branchName,
                createdAt: new Date().toISOString(),
                createdBy: loggedInUser ? loggedInUser.email : 'unknown'
            };
            
            branches.push(newBranch);
            await saveBranches();
            
            document.getElementById('newBranchName').value = '';
            renderBranches();
            
            showNotification('âœ… Ù†Ø¬Ø§Ø­', `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹ "${branchName}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„ÙØ±ÙˆØ¹ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        function renderBranches() {
            const tbody = document.getElementById('branchesTableBody');
            
            if (!currentActivityId) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Ø§Ø®ØªØ± Ù†Ø´Ø§Ø·Ø§Ù‹ Ù„Ø¹Ø±Ø¶ ÙØ±ÙˆØ¹Ù‡</td></tr>';
                return;
            }
            
            const activityBranches = branches.filter(b => b.activityId === currentActivityId);
            
            if (activityBranches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹ - Ø£Ø¶Ù ÙØ±Ø¹Ùƒ Ø§Ù„Ø£ÙˆÙ„</td></tr>';
                return;
            }
            
            tbody.innerHTML = activityBranches.map((branch, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${branch.name}</td>
                    <td>${new Date(branch.createdAt).toLocaleDateString('ar-SA')}</td>
                    <td style="text-align: left;">
                        <button class="btn-warning btn-sm" onclick="editBranch(${branch.id})" title="ØªØ¹Ø¯ÙŠÙ„" style="margin-left: 5px;">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger btn-sm" onclick="deleteBranch(${branch.id})" title="Ø­Ø°Ù">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // ØªØ¹Ø¯ÙŠÙ„ ÙØ±Ø¹
        async function editBranch(branchId) {
            const branch = branches.find(b => b.id === branchId);
            if (!branch) return;
            
            const newName = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹:', branch.name);
            if (!newName || newName.trim() === '') return;
            
            const trimmedName = newName.trim();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ø³Ù…
            const exists = branches.find(b => b.name === trimmedName && b.activityId === currentActivityId && b.id !== branchId);
            if (exists) {
                showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠÙˆØ¬Ø¯ ÙØ±Ø¹ Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
                return;
            }
            
            branch.name = trimmedName;
            branch.updatedAt = new Date().toISOString();
            
            await saveBranches();
            renderBranches();
            
            showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
        
        // Ø­Ø°Ù ÙØ±Ø¹
        async function deleteBranch(branchId) {
            const branch = branches.find(b => b.id === branchId);
            if (!branch) return;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙØ±Ø¹
            const hasTransactions = 
                sales.some(s => s.branchId === branchId) ||
                purchases.some(p => p.branchId === branchId) ||
                expenses.some(e => e.branchId === branchId) ||
                revenues.some(r => r.branchId === branchId);
            
            let message = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹ "${branch.name}"ØŸ`;
            if (hasTransactions) {
                message += '\n\nâš ï¸ ØªØ­Ø°ÙŠØ±: ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹. Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ.';
            }
            
            const confirmed = confirm(message);
            if (!confirmed) return;
            
            // Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹
            branches = branches.filter(b => b.id !== branchId);
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (null = Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)
            if (hasTransactions) {
                sales.forEach(s => { if (s.branchId === branchId) s.branchId = null; });
                purchases.forEach(p => { if (p.branchId === branchId) p.branchId = null; });
                expenses.forEach(e => { if (e.branchId === branchId) e.branchId = null; });
                revenues.forEach(r => { if (r.branchId === branchId) r.branchId = null; });
                
                // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                await saveData('sales', sales);
                await saveData('purchases', purchases);
                await saveData('expenses', expenses);
                await saveData('revenues', revenues);
            }
            
            await saveBranches();
            renderBranches();
            
            showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
        
        // Ø­ÙØ¸ Ø§Ù„ÙØ±ÙˆØ¹ ÙÙŠ Firebase Ùˆ localStorage
        async function saveBranches() {
            if (!currentActivityId) return;
            
            // Ø­ÙØ¸ ÙÙŠ localStorage
            saveToLocalStorage('branches', branches);
            
            // Ø­ÙØ¸ ÙÙŠ Firebase
            if (typeof firebaseSaveActivityData === 'function') {
                await firebaseSaveActivityData(currentActivityId, 'branches', branches);
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹ Ø¹Ù†Ø¯ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        async function loadBranches() {
            if (!currentActivityId) return;
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase Ø£ÙˆÙ„Ø§Ù‹
            if (typeof firebaseGetActivityData === 'function') {
                const firebaseBranches = await firebaseGetActivityData(currentActivityId, 'branches');
                if (firebaseBranches && firebaseBranches.length > 0) {
                    branches = firebaseBranches;
                    saveToLocalStorage('branches', branches);
                    return;
                }
            }
            
            // Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage ÙƒØ¨Ø¯ÙŠÙ„
            const localBranches = loadFromLocalStorage('branches');
            if (localBranches && Array.isArray(localBranches)) {
                branches = localBranches.filter(b => b.activityId === currentActivityId);
            } else {
                branches = [];
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹
        function getBranchName(branchId) {
            if (!branchId) return 'Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ';
            const branch = branches.find(b => b.id === branchId);
            return branch ? branch.name : 'ÙØ±Ø¹ Ù…Ø­Ø°ÙˆÙ';
        }

        // ===== Search Functions =====
        function searchItems() {
            const searchTerm = document.getElementById('searchItems').value.toLowerCase();
            const filteredItems = items.filter(item => 
                item.name.toLowerCase().includes(searchTerm) || 
                item.code.toLowerCase().includes(searchTerm)
            );
            renderFilteredItems(filteredItems);
        }

        function renderFilteredItems(filteredItems) {
            const tbody = document.getElementById('itemsList');
            tbody.innerHTML = '';
            if (filteredItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</td></tr>';
                return;
            }
            filteredItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Ø§Ù„ÙƒÙˆØ¯">${item.code}</td>
                    <td data-label="Ø§Ù„Ø§Ø³Ù…">${item.name}</td>
                    <td data-label="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">${item.cost}</td>
                    <td data-label="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">${item.price}</td>
                    <td data-label="Ø§Ù„Ø±ØµÙŠØ¯">${item.stock}</td>
                    <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                     <div class="action-buttons">
                        <button class="btn-warning edit-btn" onclick="editItem(${item.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger" onclick="deleteItem(${item.id})">Ø­Ø°Ù</button>
                    </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
function newPurchaseReturn() {
    activePurchaseReturn = null;
    document.getElementById('purchaseReturnInvoiceSearch').value = '';
    document.getElementById('purchaseReturnInvoiceDetails').style.display = 'none';
    document.getElementById('purchaseReturnItemsContainer').style.display = 'none';
    document.getElementById('purchaseReturnItemsList').innerHTML = '';
    document.getElementById('purchaseReturnTotal').textContent = '0.00';
}

function findPurchaseForReturn() {
    const invoiceNumber = parseInt(document.getElementById('purchaseReturnInvoiceSearch').value);
    if (isNaN(invoiceNumber)) {
        showNotification('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ØµØ­ÙŠØ­', 'warning');
        return;
    }
    
    const purchase = purchases.find(p => p.number === invoiceNumber);
    if (!purchase) {
        showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…', 'error');
        newPurchaseReturn();
        return;
    }

    activePurchaseReturn = purchase;
    const supplier = suppliers.find(s => s.id === purchase.supplierId);
    
    const detailsDiv = document.getElementById('purchaseReturnInvoiceDetails');
    detailsDiv.innerHTML = `
        <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> PUR${purchase.number.toString().padStart(3, '0')}</p>
        <p><strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${purchase.date}</p>
    `;
    detailsDiv.style.display = 'block';

    const itemsTbody = document.getElementById('purchaseReturnItemsList');
    itemsTbody.innerHTML = '';
    purchase.items.forEach(item => {
        const tr = document.createElement('tr');
        tr.dataset.itemId = item.id;
        tr.dataset.price = item.price;
        tr.innerHTML = `
            <td>${item.name}</td>
            <td>${item.price.toFixed(2)}</td>
            <td>${item.quantity}</td>
            <td><input type="number" class="return-item-qty-input" min="0" max="${item.quantity}" value="0" oninput="updatePurchaseReturnTotal()"></td>
        `;
        itemsTbody.appendChild(tr);
    });
    
    document.getElementById('purchaseReturnItemsContainer').style.display = 'block';
    updatePurchaseReturnTotal();
}

function updatePurchaseReturnTotal() {
    let total = 0;
    document.querySelectorAll('#purchaseReturnItemsList tr').forEach(tr => {
        const price = parseFloat(tr.dataset.price);
        const qty = parseInt(tr.querySelector('input').value) || 0;
        total += price * qty;
    });
    document.getElementById('purchaseReturnTotal').textContent = total.toFixed(2);
}

async function savePurchaseReturn() {
    if (!activePurchaseReturn) {
        showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø«', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        return;
    }
    
    const returnedItems = [];
    let totalReturnValue = 0;
    document.querySelectorAll('#purchaseReturnItemsList tr').forEach(tr => {
        const qty = parseInt(tr.querySelector('input').value) || 0;
        if (qty > 0) {
            const originalItem = activePurchaseReturn.items.find(i => i.id == tr.dataset.itemId);
            returnedItems.push({
                id: originalItem.id,
                name: originalItem.name,
                price: originalItem.price,
                quantity: qty
            });
            totalReturnValue += originalItem.price * qty;
        }
    });

    if (returnedItems.length === 0) {
        showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙ…ÙŠØ§Øª', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ ÙƒÙ…ÙŠØ§Øª Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹', 'warning');
        return;
    }

    returnedItems.forEach(returnedItem => {
        const itemInStock = items.find(i => i.id === returnedItem.id);
        if (itemInStock) {
            itemInStock.stock -= returnedItem.quantity;
        }
    });

    const newReturn = {
        id: Date.now(),
        number: currentPurchaseReturnNumber,
        date: new Date().toISOString().split('T')[0],
        originalInvoiceId: activePurchaseReturn.id,
        originalInvoiceNumber: activePurchaseReturn.number,
        supplierId: activePurchaseReturn.supplierId,
        items: returnedItems,
        total: totalReturnValue
    };

    const originalPurchaseIndex = purchases.findIndex(p => p.id === activePurchaseReturn.id);

    if (originalPurchaseIndex > -1) {
        const originalPurchase = purchases[originalPurchaseIndex];
        originalPurchase.total = roundCurrency((originalPurchase.total || 0) - totalReturnValue);
        originalPurchase.remainingAmount = roundCurrency((originalPurchase.remainingAmount || 0) - totalReturnValue);
        originalPurchase.notes = (originalPurchase.notes || '') + ` [Ù…Ø±ØªØ¬Ø¹ Ø¨Ù‚ÙŠÙ…Ø©: ${totalReturnValue.toFixed(2)}]`;
        debugLog('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©:', purchases[originalPurchaseIndex]);
    }

    purchaseReturns.push(newReturn);
    currentPurchaseReturnNumber++;
    
    console.log('ğŸ’¾ Ø­ÙØ¸ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª...');
    const success1 = await saveToLocalStorage('purchaseReturns', purchaseReturns);
    const success2 = await saveToLocalStorage('items', items);
    const success3 = await saveToLocalStorage('purchases', purchases); 
    console.log(`ğŸ’¾ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­ÙØ¸: purchaseReturns=${success1}, items=${success2}, purchases=${success3}`);
    
    if (success1 && success2 && success3) { 
        showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø±Ù‚Ù… S-PR${newReturn.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        newPurchaseReturn();
        renderPurchaseReturns();
        updateDashboard();
        renderItems();
        renderPurchasesList(); 
    } else {
        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}

function renderPurchaseReturns() {
    const tbody = document.getElementById('purchaseReturnsList');
    tbody.parentElement.querySelector('thead tr').innerHTML = `
        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
        <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    `;

    tbody.innerHTML = '';
    if (purchaseReturns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø´ØªØ±ÙŠØ§Øª</td></tr>';
        return;
    }
    purchaseReturns.forEach(pr => {
        const supplier = suppliers.find(s => s.id === pr.supplierId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>PR${pr.number.toString().padStart(3, '0')}</td>
            <td>${pr.date}</td>
            <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>PUR${pr.originalInvoiceNumber.toString().padStart(3, '0')}</td>
            <td>${pr.total.toFixed(2)}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-danger" onclick="deletePurchaseReturn(${pr.id})">Ø­Ø°Ù</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function searchCustomers() {
    const searchTerm = document.getElementById('searchCustomers').value.toLowerCase();
    const filteredCustomers = customers.filter(customer => 
        customer.name.toLowerCase().includes(searchTerm) || 
        customer.code.toLowerCase().includes(searchTerm) ||
                (customer.phone && customer.phone.toLowerCase().includes(searchTerm))
            );
            renderFilteredCustomers(filteredCustomers);
        }

        function renderFilteredCustomers(filteredCustomers) {
            const tbody = document.getElementById('customersList');
            tbody.innerHTML = '';
            if (filteredCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</td></tr>';
                return;
            }
            filteredCustomers.forEach(customer => {
                const tr = document.createElement('tr');
                tr.innerHTML = `

                    <td data-label="Ø§Ù„ÙƒÙˆØ¯">${customer.code}</td>
                    <td data-label="Ø§Ù„Ø§Ø³Ù…">${customer.name}</td>
                    <td data-label="Ø§Ù„Ù‡Ø§ØªÙ">${customer.phone || ''}</td>
                    <td data-label="Ø§Ù„Ø¨Ø±ÙŠØ¯">${customer.email || ''}</td>
                    <td data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">${customer.address || ''}</td>
                    <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                        <div class="action-buttons">
                            <button class="btn-warning edit-btn" onclick="editCustomer(${customer.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn-danger" onclick="deleteCustomer(${customer.id})">Ø­Ø°Ù</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function searchSuppliers() {
            const searchTerm = document.getElementById('searchSuppliers').value.toLowerCase();
            const filteredSuppliers = suppliers.filter(supplier => 
                supplier.name.toLowerCase().includes(searchTerm) || 
                supplier.code.toLowerCase().includes(searchTerm) ||
                (supplier.phone && supplier.phone.toLowerCase().includes(searchTerm))
            );
            renderFilteredSuppliers(filteredSuppliers);
        }

        function renderFilteredSuppliers(filteredSuppliers) {
            const tbody = document.getElementById('suppliersList');
            tbody.innerHTML = '';
            if (filteredSuppliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ±Ø¯ÙˆÙ† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</td></tr>';
                return;
            }
            filteredSuppliers.forEach(supplier => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td data-label="Ø§Ù„ÙƒÙˆØ¯">${supplier.code}</td>
                        <td data-label="Ø§Ù„Ø§Ø³Ù…">${supplier.name}</td>
                        <td data-label="Ø§Ù„Ù‡Ø§ØªÙ">${supplier.phone || ''}</td>
                        <td data-label="Ø§Ù„Ø¨Ø±ÙŠØ¯">${supplier.email || ''}</td>
                        <td data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">${supplier.address || ''}</td>
                        <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                            <div class="action-buttons">
                                <button class="btn-warning edit-btn" onclick="editSupplier(${supplier.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="btn-danger" onclick="deleteSupplier(${supplier.id})">Ø­Ø°Ù</button>
                            </div>
                        </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function searchSalaries() {
            const input = document.getElementById('searchSalaries');
            if (!input) return;
            const term = input.value.trim().toLowerCase();
            if (!term) {
                renderSalaries();
                return;
            }
            const filtered = salaries.filter(salary => {
                const nameMatch = (salary.employeeName || '').toLowerCase().includes(term);
                const idMatch = (salary.employeeId || '').toLowerCase().includes(term);
                const jobMatch = (salary.jobTitle || '').toLowerCase().includes(term);
                const monthMatch = (salary.month || '').toLowerCase().includes(term);
                return nameMatch || idMatch || jobMatch || monthMatch;
            });
            renderSalaries(filtered, true);
        }

        // ===== Items Functions =====
        function generateItemCode() {
            const itemCode = document.getElementById('itemCode');
            if (itemCode) {
                itemCode.value = 'IT' + (items.length + 1).toString().padStart(3, '0');
            }
        }

        async function addItem() {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            const validation = validateForm({
                itemName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') },
                    { validator: (v) => ValidationHelper.isUnique(v, items, 'name', 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') }
                ],
                itemCategory: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ù„ÙØ¦Ø©') }
                ],
                itemUnit: [
                    { validator: (v) => ValidationHelper.required(v, 'ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³') }
                ],
                itemCost: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡') }
                ],
                itemPrice: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹') },
                    { validator: (v) => ValidationHelper.isGreaterThanZero(v, 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹') }
                ],
                itemStock: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø§Ù„ÙƒÙ…ÙŠØ©') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'Ø§Ù„ÙƒÙ…ÙŠØ©') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const code = document.getElementById('itemCode').value;
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const unit = document.getElementById('itemUnit').value;
            const cost = document.getElementById('itemCost').value;
            const price = document.getElementById('itemPrice').value;
            const stock = document.getElementById('itemStock').value;
            const minStock = document.getElementById('itemMinStock').value;

            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù...');

            try {
                const item = {
                    id: Date.now(),
                    code: code || 'IT' + (items.length + 1).toString().padStart(3, '0'),
                    name: name,
                    category: category,
                    unit: unit,
                    cost: parseFloat(cost) || 0,
                    price: parseFloat(price) || 0,
                    stock: parseInt(stock) || 0,
                    minStock: parseInt(minStock) || 0
                };

                items.push(item);
                const success = await saveToLocalStorage('items', items);
                
                hideLoading();
                
                if (success) {
                    updateDashboard();
                    clearItemForm();
                    renderItems();
                    showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                } else {
                    items.pop(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙ†Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            } catch (error) {
                hideLoading();
                logError('Add Item', error);
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ù…Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        async function addItemNew() {
            const code = document.getElementById('itemCodeNew').value;
            const name = document.getElementById('itemNameNew').value.trim();
            const category = document.getElementById('itemCategoryNew').value;
            const cost = document.getElementById('itemCostNew').value;
            const stock = document.getElementById('itemStockNew').value;
            const minStock = document.getElementById('itemMinStockNew').value;

            if (!name || !category) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ÙØ¦Ø©)', 'warning');
                return;
            }
            
            // ğŸ“ Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
            const units = [];
            const unitRows = document.querySelectorAll('#unitsContainer .unit-row');
            
            if (unitRows.length === 0) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ù‚ÙŠØ§Ø³ ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warning');
                return;
            }
            
            unitRows.forEach((row, index) => {
                const unitName = row.querySelector('.unit-name').value.trim();
                const factor = parseFloat(row.querySelector('.unit-factor').value) || 1;
                const price = parseFloat(row.querySelector('.unit-price').value);
                
                if (!unitName || isNaN(price) || price < 0) {
                    return; // Skip invalid rows
                }
                
                units.push({
                    name: unitName,
                    factor: factor,
                    price: price,
                    isBase: index === 0 // First unit is always base
                });
            });
            
            if (units.length === 0) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ù‚ÙŠØ§Ø³ ØµØ­ÙŠØ­Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warning');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„ÙƒÙˆØ¯
            if (code && items.some(item => item.code === code)) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø¢Ø®Ø±', 'warning');
                return;
            }

            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù...');

            try {
                // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ ÙØ±ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹
                let finalCode = code;
                if (!finalCode) {
                    let maxNumber = 0;
                    items.forEach(item => {
                        if (item.code && item.code.startsWith('IT')) {
                            const num = parseInt(item.code.substring(2));
                            if (!isNaN(num) && num > maxNumber) {
                                maxNumber = num;
                            }
                        }
                    });
                    finalCode = 'IT' + (maxNumber + 1).toString().padStart(3, '0');
                }
                
                const item = {
                    id: Date.now(),
                    code: finalCode,
                    name: name,
                    category: category,
                    units: units, // ğŸ“ Multi-Unit Array
                    cost: parseFloat(cost) || 0,
                    stock: parseInt(stock) || 0, // Always in Base Unit
                    minStock: parseInt(minStock) || 0
                };

                items.push(item);
                const success = await saveToLocalStorage('items', items);
                
                hideLoading();
                
                if (success) {
                    updateDashboard();
                    clearItemFormNew();
                    renderItems();
                    showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
                    setTimeout(() => {
                        showSection('items');
                    }, 500);
                } else {
                    items.pop();
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            } catch (error) {
                hideLoading();
                logError('Add Item New', error);
            }
        }

        // ğŸ“ ===== Multi-Unit Helper Functions =====
        
        let unitRowCounter = 0;
        
        function addUnitRow() {
            unitRowCounter++;
            const container = document.getElementById('unitsContainer');
            
            const row = document.createElement('div');
            row.className = 'unit-row';
            row.dataset.unitIndex = unitRowCounter;
            row.style.cssText = 'display: grid; grid-template-columns: 2fr 1.5fr 2fr 80px; gap: 10px; margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #ddd;';
            
            row.innerHTML = `
                <div>
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø© *</label>
                    <input type="text" class="unit-name" placeholder="Ù…Ø«Ø§Ù„: ØªÙˆÙ„Ø©" required style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                </div>
                <div>
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ *</label>
                    <input type="number" class="unit-factor" placeholder="12" min="0.001" step="0.001" required style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                </div>
                <div>
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ *</label>
                    <input type="number" class="unit-price" placeholder="0.00" min="0" step="0.01" required style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button type="button" class="btn-danger" onclick="removeUnitRow(${unitRowCounter})" style="padding: 10px; width: 100%;">ğŸ—‘ï¸</button>
                </div>
            `;
            
            container.appendChild(row);
        }
        
        function removeUnitRow(index) {
            const row = document.querySelector(`.unit-row[data-unit-index="${index}"]`);
            if (row) {
                row.remove();
            }
        }
        
        function clearUnitsContainer() {
            const container = document.getElementById('unitsContainer');
            // Keep only the base unit row
            const allRows = container.querySelectorAll('.unit-row');
            allRows.forEach((row, index) => {
                if (index > 0) { // Remove all except first (base)
                    row.remove();
                }
            });
            
            // Reset base unit values
            const baseRow = container.querySelector('.unit-row:first-child');
            if (baseRow) {
                baseRow.querySelector('.unit-name').value = '';
                baseRow.querySelector('.unit-price').value = '';
            }
            
            unitRowCounter = 0;
        }
        
        // ğŸ“ ===== End Multi-Unit Helper Functions =====

        function clearItemFormNew() {
            document.getElementById('itemCodeNew').value = '';
            document.getElementById('itemNameNew').value = '';
            document.getElementById('itemCategoryNew').value = '';
            document.getElementById('itemCostNew').value = '';
            document.getElementById('itemStockNew').value = '';
            document.getElementById('itemMinStockNew').value = '';
            
            clearUnitsContainer(); // ğŸ“ Clear units
            
            const addButton = document.querySelector('#addItem .btn-primary');
            if (addButton) {
                addButton.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù';
                addButton.onclick = addItemNew;
            }
            
            const title = document.querySelector('#addItem h2');
            if (title) title.innerHTML = 'â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯';
            
            generateItemCodeNew();
        }

        function generateItemCodeNew() {
            const codeField = document.getElementById('itemCodeNew');
            const priceField = document.getElementById('itemPriceNew');
            
            if (codeField) {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¹Ù„Ù‰ Ø±Ù‚Ù… ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯
                let maxNumber = 0;
                items.forEach(item => {
                    if (item.code && item.code.startsWith('IT')) {
                        const num = parseInt(item.code.substring(2));
                        if (!isNaN(num) && num > maxNumber) {
                            maxNumber = num;
                        }
                    }
                });
                // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                codeField.value = 'IT' + (maxNumber + 1).toString().padStart(3, '0');
                // Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ
                codeField.dataset.originalCode = codeField.value;
            }
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹
            if (priceField && !priceField.value) {
                priceField.value = '0';
            }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        let codeChangeWarned = false;
        async function warnCodeChange(input) {
            const originalCode = input.dataset.originalCode;
            const currentCode = input.value;
            
            // Ø¥Ø°Ø§ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…ÙˆØ¬ÙˆØ¯
            if (originalCode && currentCode !== originalCode && !codeChangeWarned) {
                const confirmed = await showConfirmDialog({
                    title: 'ğŸš¨ ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ± - ØªØ¹Ø¯ÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù!',
                    message: `<div style="text-align: right; line-height: 2;">
                        <p style="margin-bottom: 15px;">âš ï¸ Ø£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ ØªØ¹Ø¯ÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù Ù…Ù† <strong>"${originalCode}"</strong> Ø¥Ù„Ù‰ <strong>"${currentCode}"</strong></p>
                        
                        <p style="color: #d32f2f; font-weight: bold; margin-bottom: 15px;">ğŸ”´ Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø®Ø·ÙŠØ± Ø¬Ø¯Ø§Ù‹ ÙˆØ³ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰:</p>
                        
                        <div style="margin-bottom: 15px;">
                            <p style="font-weight: bold; color: #1976d2;">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:</p>
                            <p style="margin-right: 20px;">â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù Ø³ØªØµØ¨Ø­ ØºÙŠØ± Ø¯Ù‚ÙŠÙ‚Ø©</p>
                            <p style="margin-right: 20px;">â€¢ Ù„Ù† ÙŠØªÙ… ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</p>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <p style="font-weight: bold; color: #1976d2;">ğŸ“ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:</p>
                            <p style="margin-right: 20px;">â€¢ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø³ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…</p>
                            <p style="margin-right: 20px;">â€¢ ØµØ¹ÙˆØ¨Ø© ÙÙŠ ØªØªØ¨Ø¹ Ø­Ø±ÙƒØ© Ø§Ù„ØµÙ†Ù Ø¹Ø¨Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ±</p>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <p style="font-weight: bold; color: #1976d2;">ğŸ“¦ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:</p>
                            <p style="margin-right: 20px;">â€¢ Ù‚Ø¯ ØªÙ†ÙØµÙ„ Ø­Ø±ÙƒØ© Ø§Ù„ØµÙ†Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</p>
                            <p style="margin-right: 20px;">â€¢ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±ØµØ¯Ø© ÙˆØ§Ù„Ø¬Ø±Ø¯</p>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <p style="font-weight: bold; color: #856404;">ğŸ’¡ Ø§Ù„Ø¨Ø¯ÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­:</p>
                            <p style="margin-right: 20px; color: #856404;">â€¢ Ø£Ù†Ø´Ø¦ ØµÙ†ÙØ§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯</p>
                            <p style="margin-right: 20px; color: #856404;">â€¢ Ø£ÙˆÙ‚Ù Ø§Ù„ØµÙ†Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¹Ù† Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</p>
                        </div>
                        
                        <p style="color: #d32f2f; font-weight: bold; text-align: center;">âŒ ÙŠÙÙ†ØµØ­ Ø¨Ø´Ø¯Ø© Ø¨Ø¹Ø¯Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©!</p>
                        <p style="text-align: center; margin-top: 10px;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ 100% Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø±ØºÙ… Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø®Ø§Ø·Ø±ØŸ</p>
                    </div>`,
                    type: 'danger',
                    confirmText: 'Ù†Ø¹Ù…ØŒ Ø£ÙÙ‡Ù… Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ£Ø±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©',
                    cancelText: 'Ø¥Ù„ØºØ§Ø¡ - Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø¢Ù…Ù†'
                });
                
                if (!confirmed) {
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ
                    input.value = originalCode;
                    showNotification('âœ… Ù‚Ø±Ø§Ø± Ø­ÙƒÙŠÙ…', 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ', 'success');
                    return false; // Ø¥Ø±Ø¬Ø§Ø¹ false Ù„Ù…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸
                } else {
                    codeChangeWarned = true;
                    showNotification('âš ï¸ ØªØ­Ø°ÙŠØ±', 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©!', 'warning');
                    return true; // Ø¥Ø±Ø¬Ø§Ø¹ true Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø­ÙØ¸
                }
            }
            return true; // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø­ÙØ¸
        }

        async function updateItemNew(id) {
            const codeField = document.getElementById('itemCodeNew');
            const code = codeField.value;
            const name = document.getElementById('itemNameNew').value.trim();
            const category = document.getElementById('itemCategoryNew').value;
            const cost = document.getElementById('itemCostNew').value;
            const stock = document.getElementById('itemStockNew').value;
            const minStock = document.getElementById('itemMinStockNew').value;
            
            // ğŸ“ Collect units from UI
            const unitRows = document.querySelectorAll('#unitsContainer .unit-row');
            const units = [];
            
            for (let i = 0; i < unitRows.length; i++) {
                const row = unitRows[i];
                const unitName = row.querySelector('.unit-name').value.trim();
                const unitFactor = parseFloat(row.querySelector('.unit-factor').value) || 1;
                const unitPrice = parseFloat(row.querySelector('.unit-price').value);
                
                if (!unitName || isNaN(unitPrice) || unitPrice < 0) {
                    showNotification('âš ï¸ Ø®Ø·Ø£', `ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø±Ù‚Ù… ${i + 1} Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†)`, 'warning');
                    return;
                }
                
                units.push({
                    name: unitName,
                    factor: unitFactor,
                    price: unitPrice,
                    isBase: i === 0
                });
            }

            if (!name || !category || units.length === 0) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ÙØ¦Ø©ØŒ ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)', 'warning');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ø°ÙŠØ± ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
            const originalCode = codeField.dataset.originalCode;
            if (originalCode && code !== originalCode && !codeChangeWarned) {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù„Ù… Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                codeChangeWarned = false;
                const canProceed = await warnCodeChange(codeField);
                if (!canProceed) {
                    return; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­ÙØ¸
                }
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„ÙƒÙˆØ¯ (Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„ØµÙ†Ù Ø§Ù„Ø­Ø§Ù„ÙŠ)
            if (code && items.some(item => item.code === code && item.id !== id)) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„ØµÙ†Ù Ø¢Ø®Ø±ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø¢Ø®Ø±', 'warning');
                return;
            }
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹ Ø£Ùˆ Ø³Ø§Ù„Ø¨Ø§Ù‹
            const priceValue = parseFloat(price);
            if (isNaN(priceValue) || priceValue < 0) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù…Ø·Ù„ÙˆØ¨ ÙˆÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØµÙØ± Ø£Ùˆ Ø£ÙƒØ«Ø±', 'warning');
                return;
            }

            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù...');

            try {
                const itemIndex = items.findIndex(item => item.id === id);
                if (itemIndex !== -1) {
                    const oldName = items[itemIndex].name;
                    
                    items[itemIndex] = {
                        id: id,
                        code: code || items[itemIndex].code,
                        name: name,
                        category: category,
                        units: units,
                        cost: parseFloat(cost) || 0,
                        stock: parseInt(stock) || 0,
                        minStock: parseInt(minStock) || 0
                    };

                    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                    sales.forEach(sale => {
                        sale.items.forEach(item => {
                            if (item.id === id || item.name === oldName) {
                                item.name = name;
                            }
                        });
                    });

                    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
                    purchases.forEach(purchase => {
                        purchase.items.forEach(item => {
                            if (item.id === id || item.name === oldName) {
                                item.name = name;
                            }
                        });
                    });

                    const success = await saveToLocalStorage('items', items);
                    await saveToLocalStorage('sales', sales);
                    await saveToLocalStorage('purchases', purchases);

                    hideLoading();

                    if (success) {
                        updateDashboard();
                        clearItemFormNew();
                        renderItems();
                        showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                        setTimeout(() => {
                            showSection('items');
                        }, 500);
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            } catch (error) {
                hideLoading();
                logError('Update Item New', error);
            }
        }

function loadCustomersToSelect() {
    const select = document.getElementById('accountClientSelect');
    if (!select) return;
    
    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>';
    
    customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.name + ' - ' + (customer.code || '');
        select.appendChild(option);
    });
}

        function renderItems() {
            const tbody = document.getElementById('itemsList');
            tbody.innerHTML = '';
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
            let filteredItems = [...items];
            const searchText = document.getElementById('searchItems')?.value || '';
            
            // Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
            const filters = {
                searchText: searchText,
                priceFrom: document.getElementById('itemCostFrom')?.value,
                priceTo: document.getElementById('itemCostTo')?.value,
            };
            
            // Ø¥Ø¶Ø§ÙØ© ÙÙ„Ø§ØªØ± Ø¥Ø¶Ø§ÙÙŠØ©
            if (document.getElementById('itemPriceFrom')?.value) {
                filters.price = { 
                    from: parseFloat(document.getElementById('itemPriceFrom').value),
                    to: parseFloat(document.getElementById('itemPriceTo')?.value || Infinity)
                };
            }
            
            if (document.getElementById('itemStockFrom')?.value) {
                filters.quantity = {
                    from: parseFloat(document.getElementById('itemStockFrom').value),
                    to: parseFloat(document.getElementById('itemStockTo')?.value || Infinity)
                };
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… FilterSortHelper
            if (searchText) {
                filteredItems = filteredItems.filter(item => 
                    item.name.toLowerCase().includes(searchText.toLowerCase()) ||
                    item.code.toLowerCase().includes(searchText.toLowerCase())
                );
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡
            if (filters.priceFrom) {
                filteredItems = filteredItems.filter(item => parseFloat(item.cost) >= parseFloat(filters.priceFrom));
            }
            if (filters.priceTo) {
                filteredItems = filteredItems.filter(item => parseFloat(item.cost) <= parseFloat(filters.priceTo));
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹
            if (filters.price) {
                filteredItems = filteredItems.filter(item => {
                    const price = parseFloat(item.price);
                    return price >= filters.price.from && price <= filters.price.to;
                });
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø±ØµÙŠØ¯
            if (filters.quantity) {
                filteredItems = filteredItems.filter(item => {
                    const stock = parseFloat(item.stock);
                    return stock >= filters.quantity.from && stock <= filters.quantity.to;
                });
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
            const sortState = FilterSortHelper.currentSort['items'];
            if (sortState) {
                filteredItems = FilterSortHelper.sortData(filteredItems, sortState.column, sortState.direction);
            }
            
            if (filteredItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
                return;
            }
            
            // Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ¦Ø§Øª Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            const categoryNames = {
                'food': 'ğŸ” Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©',
                'beverages': 'ğŸ¥¤ Ù…Ø´Ø±ÙˆØ¨Ø§Øª',
                'cleaning': 'ğŸ§¹ Ù…Ù†Ø¸ÙØ§Øª',
                'stationery': 'ğŸ“ Ù‚Ø±Ø·Ø§Ø³ÙŠØ©',
                'electronics': 'âš¡ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª',
                'clothing': 'ğŸ‘• Ù…Ù„Ø§Ø¨Ø³',
                'cosmetics': 'ğŸ’„ Ø¹Ø·ÙˆØ± ÙˆØªØ¬Ù…ÙŠÙ„',
                'medical': 'ğŸ’Š Ø£Ø¯ÙˆÙŠØ© ÙˆÙ…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø·Ø¨ÙŠØ©',
                'building': 'ğŸ”¨ Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡',
                'spare_parts': 'ğŸ”§ Ù‚Ø·Ø¹ ØºÙŠØ§Ø±',
                'other': 'ğŸ“¦ Ø£Ø®Ø±Ù‰'
            };
            
            // Ø£Ø³Ù…Ø§Ø¡ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            const unitNames = {
                'piece': 'Ù‚Ø·Ø¹Ø©', 'box': 'Ø¹Ù„Ø¨Ø©', 'carton': 'ÙƒØ±ØªÙˆÙ†', 'kg': 'ÙƒØ¬Ù…', 'gram': 'Ø¬Ø±Ø§Ù…', 'tola': 'ØªÙˆÙ„Ø©',
                'liter': 'Ù„ØªØ±', 'meter': 'Ù…ØªØ±', 'pack': 'Ø­Ø²Ù…Ø©', 'bottle': 'Ø²Ø¬Ø§Ø¬Ø©',
                'can': 'Ø¹Ù„Ø¨Ø© Ù…Ø¹Ø¯Ù†ÙŠØ©', 'bag': 'ÙƒÙŠØ³', 'dozen': 'Ø¯Ø³ØªØ©', 'set': 'Ø·Ù‚Ù…', 'roll': 'Ù„ÙØ©'
            };
            
            filteredItems.forEach(item => {
                const tr = document.createElement('tr');
                
                // ØªØ­Ø°ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰
                const lowStock = item.minStock && item.stock <= item.minStock;
                const stockStyle = lowStock ? 'color: red; font-weight: bold;' : '';
                const stockWarning = lowStock ? ' âš ï¸' : '';
                
                // ğŸ“ Display units info
                let unitDisplay = '-';
                let priceDisplay = '0.00';
                
                if (item.units && item.units.length > 0) {
                    const baseUnit = item.units[0];
                    unitDisplay = baseUnit.name;
                    priceDisplay = baseUnit.price.toFixed(2);
                    
                    // Add conversion tooltip if multiple units exist
                    if (item.units.length > 1) {
                        const conversions = item.units.slice(1).map(u => 
                            `${(item.stock / u.factor).toFixed(2)} ${u.name}`
                        ).join('ØŒ ');
                        unitDisplay += ` <span style="color: #666; font-size: 0.9em;" title="Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª: ${conversions}">(+${item.units.length - 1})</span>`;
                    }
                } else {
                    // Old structure fallback
                    unitDisplay = unitNames[item.unit] || item.unit || '-';
                    priceDisplay = item.price ? item.price.toFixed(2) : '0.00';
                }
                
                tr.innerHTML = `
                    <td>${item.code}</td>
                    <td>${item.name}</td>
                    <td>${categoryNames[item.category] || item.category || '-'}</td>
                    <td>${unitDisplay}</td>
                    <td>${item.cost.toFixed(2)}</td>
                    <td>${priceDisplay}</td>
                    <td style="${stockStyle}">${item.stock}${stockWarning}</td>
                    <td>
                        <div class="action-menu-container">
                            <button class="action-menu-btn" onclick="toggleActionMenu(event, ${item.id})">â‹®</button>
                            <div class="action-menu-content" id="menu-${item.id}">
                                <a href="#" onclick="editItem(${item.id}); return false;">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>
                                <a href="#" onclick="deleteItem(${item.id}); return false;" style="color: #dc3545;">ğŸ—‘ï¸ Ø­Ø°Ù</a>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ø£ØµÙ†Ø§Ù
        function applyItemsFilters() {
            renderItems();
        }
        
        function resetItemsFilters() {
            document.getElementById('itemCostFrom').value = '';
            document.getElementById('itemCostTo').value = '';
            document.getElementById('itemPriceFrom').value = '';
            document.getElementById('itemPriceTo').value = '';
            document.getElementById('itemStockFrom').value = '';
            document.getElementById('itemStockTo').value = '';
            renderItems();
        }

        function editItem(id) {
            const item = items.find(item => item.id === id);
            if (!item) return;
            
            showSection('addItem');
            
            const codeField = document.getElementById('itemCodeNew');
            codeField.value = item.code;
            // Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„ØªØ­Ø°ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            codeField.dataset.originalCode = item.code;
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù„Ù…
            codeChangeWarned = false;
            
            document.getElementById('itemNameNew').value = item.name;
            document.getElementById('itemCategoryNew').value = item.category || '';
            document.getElementById('itemCostNew').value = item.cost;
            document.getElementById('itemStockNew').value = item.stock;
            document.getElementById('itemMinStockNew').value = item.minStock || '';
            
            // ğŸ“ Populate units container with existing units
            clearUnitsContainer();
            if (item.units && item.units.length > 0) {
                item.units.forEach((unit, index) => {
                    if (index === 0) {
                        // Update base unit (first row)
                        const baseRow = document.querySelector('.unit-row[data-unit-index="0"]');
                        if (baseRow) {
                            baseRow.querySelector('.unit-name').value = unit.name;
                            baseRow.querySelector('.unit-price').value = unit.price;
                        }
                    } else {
                        // Add sub-units
                        addUnitRow();
                        const newRow = document.querySelector(`.unit-row[data-unit-index="${unitRowCounter - 1}"]`);
                        if (newRow) {
                            newRow.querySelector('.unit-name').value = unit.name;
                            newRow.querySelector('.unit-factor').value = unit.factor;
                            newRow.querySelector('.unit-price').value = unit.price;
                        }
                    }
                });
            } else {
                // Old item structure - set default base unit
                const baseRow = document.querySelector('.unit-row[data-unit-index="0"]');
                if (baseRow && item.unit) {
                    baseRow.querySelector('.unit-name').value = item.unit;
                    baseRow.querySelector('.unit-price').value = item.price;
                }
            }
            
            const addButton = document.querySelector('#addItem .btn-primary');
            if (addButton) {
                addButton.textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù';
                addButton.onclick = function() { updateItemNew(id); };
            }
            
            const title = document.querySelector('#addItem h2');
            if (title) title.innerHTML = `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ù: ${item.name}`;
        }

        async function updateItem(id) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ø¹ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±
            const validation = validateForm({
                itemName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') },
                    { validator: (v) => ValidationHelper.isUnique(v, items, 'name', 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù', id) }
                ],
                itemCategory: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ù„ÙØ¦Ø©') }
                ],
                itemUnit: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ù„ÙˆØ­Ø¯Ø©') }
                ],
                itemCost: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡') }
                ],
                itemPrice: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹') },
                    { validator: (v) => ValidationHelper.isGreaterThanZero(v, 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹') }
                ],
                itemStock: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø§Ù„ÙƒÙ…ÙŠØ©') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'Ø§Ù„ÙƒÙ…ÙŠØ©') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('itemName').value.trim();

            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù...');

            try {
                const itemIndex = items.findIndex(item => item.id === id);
                if (itemIndex !== -1) {
                    const oldName = items[itemIndex].name; // Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
                    debugLog('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù:', { oldName, newName: name, itemId: id });
                    
                    items[itemIndex] = {
                        id: id,
                        code: document.getElementById('itemCode').value,
                        name: name,
                        category: document.getElementById('itemCategory').value,
                        unit: document.getElementById('itemUnit').value,
                        cost: parseFloat(document.getElementById('itemCost').value) || 0,
                        price: parseFloat(document.getElementById('itemPrice').value) || 0,
                        stock: parseInt(document.getElementById('itemStock').value) || 0,
                        minStock: parseInt(document.getElementById('itemMinStock').value) || 0
                    };
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ÙÙŠ Ø¬Ù…ÙŠØ¹ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                    let salesUpdated = false;
                    let salesCount = 0;
                    sales.forEach(sale => {
                        sale.items.forEach(item => {
                            if (item.id === id || item.name === oldName) {
                                item.name = name;
                                salesUpdated = true;
                                salesCount++;
                            }
                        });
                    });
                    debugLog(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${salesCount} ØµÙ†Ù ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª`);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ÙÙŠ Ø¬Ù…ÙŠØ¹ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
                    let purchasesCount = 0;
                    purchases.forEach(purchase => {
                        purchase.items.forEach(item => {
                            if (item.id === id || item.name === oldName) {
                                item.name = name;
                                purchasesCount++;
                            }
                        });
                    });
                    debugLog(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${purchasesCount} ØµÙ†Ù ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª`);
                    
                    const success = await saveToLocalStorage('items', items);
                    const salesSuccess = salesUpdated ? await saveToLocalStorage('sales', sales) : true;
                    const purchasesSuccess = await saveToLocalStorage('purchases', purchases);
                    
                    debugLog('ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', { success, salesSuccess, purchasesSuccess });
                    
                    hideLoading();
                    
                    if (success && salesSuccess && purchasesSuccess) {
                        updateDashboard();
                        clearItemForm();
                        renderItems();
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù…ÙØªÙˆØ­Ø©
                        if (document.getElementById('advanced-dashboard') && 
                            document.getElementById('advanced-dashboard').classList.contains('active')) {
                            debugLog('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...');
                            updateLiveStats();
                        }
                        
                        // ...existing code...
                        showNotification('âœ… Ù†Ø¬Ø§Ø­', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­!\n- ØªÙ… ØªØ­Ø¯ÙŠØ« ${salesCount} ØµÙ†Ù ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª\n- ØªÙ… ØªØ­Ø¯ÙŠØ« ${purchasesCount} ØµÙ†Ù ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª`, 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            } catch (error) {
                hideLoading();
                logError('Update Item', error);
            }



        }

        async function deleteItem(id) {
            const confirmed = await showConfirmDialog({
                title: 'ğŸ—‘ï¸ Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…Ø§Ù‹.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„Ù‡',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            
            if (confirmed) {
                showLoading('Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„ØµÙ†Ù...');
                
                try {
                    const item = items.find(i => i.id === id);
                    if (!item) {
                        hideLoading();
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                        return;
                    }
                    
                    // Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                    moveToTrash('items', item);
                    
                    // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©
                    const itemsCopy = [...items];
                    items = items.filter(item => item.id !== id);
                    const success = saveToLocalStorage('items', items);
                    
                    hideLoading();
                    
                    if (success) {
                        renderItems();
                        updateDashboard();
                        updateTrashBadge();
                    } else {
                        items = itemsCopy; // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
                        showNotification(
                            'âŒ Ø®Ø·Ø£',
                            'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                            'error'
                        );
                    }
                } catch (error) {
                    hideLoading();
                    logError('Delete Item', error);
                }
            }
        }

        function clearItemForm() {
            clearValidationStyles(); // Ø¥Ø²Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚
            const itemName = document.getElementById('itemName');
            const itemCategory = document.getElementById('itemCategory');
            const itemUnit = document.getElementById('itemUnit');
            const itemCost = document.getElementById('itemCost');
            const itemPrice = document.getElementById('itemPrice');
            const itemStock = document.getElementById('itemStock');
            const itemMinStock = document.getElementById('itemMinStock');
            
            if (itemName) itemName.value = '';
            if (itemCategory) itemCategory.value = '';
            if (itemUnit) itemUnit.value = '';
            if (itemCost) itemCost.value = '';
            if (itemPrice) itemPrice.value = '';
            if (itemStock) itemStock.value = '';
            if (itemMinStock) itemMinStock.value = '';
            
            // ...existing code...
            generateItemCode(); // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ±ÙŠØº
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            removeEditMode('#items', '#items h2', 'ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatItems" class="stat-mini-number">0</span></span>');
        }
        
        // ===== Customers Functions =====
        function showAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'block';
            document.getElementById('customersListContainer').style.display = 'none';
            generateCustomerCode();
        }

        function hideAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'none';
            document.getElementById('customersListContainer').style.display = 'block';
            // We don't call clearCustomerForm here to avoid async confirmation dialogs when just closing
            // But we should clear inputs manually if needed, or just leave them.
            // Better to clear them so next time it's empty.
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerAddress').value = '';
            clearValidationStyles();
        }

        function generateCustomerCode() {
            document.getElementById('customerCode').value = 'CU' + (customers.length + 1).toString().padStart(3, '0');
        }

        async function addCustomer() {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            const validation = validateForm({
                customerName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') },
                    { validator: (v) => ValidationHelper.isUnique(v, customers, 'name', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') }
                ],
                customerPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') }
                ],
                customerEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('customerName').value.trim();
            const code = document.getElementById('customerCode').value.trim();

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
            if (code) {
                if (typeof chartOfAccounts !== 'undefined' && chartOfAccounts.some(a => a.code === code)) {
                    showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª', 'warning');
                    return;
                }
                if (typeof suppliers !== 'undefined' && suppliers.some(s => s.code === code)) {
                    showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù…ÙˆØ±Ø¯', 'warning');
                    return;
                }
                if (customers.some(c => c.code === code)) {
                    showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ø¹Ù…ÙŠÙ„ Ø¢Ø®Ø±', 'warning');
                    return;
                }
            }

            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„...');

            try {
                const customer = {
                    id: Date.now(),
                    code: document.getElementById('customerCode').value || 'CU' + (customers.length + 1).toString().padStart(3, '0'),
                    name: name,
                    phone: document.getElementById('customerPhone').value,
                    email: document.getElementById('customerEmail').value,
                    address: document.getElementById('customerAddress').value
                };
                customers.push(customer);
                const success = saveToLocalStorage('customers', customers);
                
                hideLoading();
                
                if (success) {
                    updateDashboard();
                    clearCustomerForm();
                    renderCustomers();
                    showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    loadCustomersToSelect();
                    hideAddCustomerForm();
                } else {
                    customers.pop();
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            } catch (error) {
                hideLoading();
                logError('Add Customer', error);
            }
        }

        function renderCustomers() {
            const tbody = document.getElementById('customersList');
            tbody.innerHTML = '';
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
            let filteredCustomers = [...customers];
            const searchText = document.getElementById('searchCustomers')?.value || '';
            
            if (searchText) {
                filteredCustomers = filteredCustomers.filter(customer => 
                    customer.name.toLowerCase().includes(searchText.toLowerCase()) ||
                    customer.code.toLowerCase().includes(searchText.toLowerCase()) ||
                    (customer.phone && customer.phone.includes(searchText)) ||
                    (customer.email && customer.email.toLowerCase().includes(searchText.toLowerCase())) ||
                    (customer.address && customer.address.toLowerCase().includes(searchText.toLowerCase()))
                );
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
            const sortState = FilterSortHelper.currentSort['customers'];
            if (sortState) {
                filteredCustomers = FilterSortHelper.sortData(filteredCustomers, sortState.column, sortState.direction);
            }

            if (filteredCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
                return;
            }

            filteredCustomers.forEach(customer => {
                const tr = document.createElement('tr');
                tr.innerHTML = `

                    <td>${customer.code}</td>
                    <td>${customer.name}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.email}</td>
                    <td>${customer.address}</td>
                    <td>
                        <div class="action-menu-container">
                            <button class="action-menu-btn" onclick="toggleActionMenu(event, ${customer.id})">â‹®</button>
                            <div class="action-menu-content" id="menu-${customer.id}">
                                <a href="#" onclick="event.preventDefault(); editCustomer(${customer.id});">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>
                                <a href="#" onclick="event.preventDefault(); deleteCustomer(${customer.id});" style="color: #dc3545;">ğŸ—‘ï¸ Ø­Ø°Ù</a>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡
        function resetCustomersFilters() {
            document.getElementById('searchCustomers').value = '';
            renderCustomers();
        }

        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer) return;
            
            // Show the form first
            showAddCustomerForm();

            document.getElementById('customerCode').value = customer.code;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('customerEmail').value = customer.email;
            document.getElementById('customerAddress').value = customer.address;
            const addButton = document.getElementById('btnSaveCustomer');
            addButton.textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„';
            addButton.onclick = () => updateCustomer(id);
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            applyEditMode('#customers', 'customerName', '#customers h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customer.name}`);
        }

        async function updateCustomer(id) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ø¹ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±
            const validation = validateForm({
                customerName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') },
                    { validator: (v) => ValidationHelper.isUnique(v, customers, 'name', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', id) }
                ],
                customerPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') }
                ],
                customerEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('customerName').value.trim();
            const newCode = document.getElementById('customerCode').value.trim();
            const currentCustomer = customers.find(c => c.id === id);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… (ÙÙ‚Ø· Ø¥Ø°Ø§ ØªØºÙŠØ± Ø§Ù„ÙƒÙˆØ¯)
            if (newCode && currentCustomer && newCode !== currentCustomer.code) {
                if (typeof chartOfAccounts !== 'undefined' && chartOfAccounts.some(a => a.code === newCode)) {
                    showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª', 'warning');
                    return;
                }
                if (typeof suppliers !== 'undefined' && suppliers.some(s => s.code === newCode)) {
                    showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù…ÙˆØ±Ø¯', 'warning');
                    return;
                }
                if (customers.some(c => c.code === newCode)) {
                    showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ø¹Ù…ÙŠÙ„ Ø¢Ø®Ø±', 'warning');
                    return;
                }
            }

            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„...');

            try {
                const customerIndex = customers.findIndex(c => c.id === id);
                if (customerIndex !== -1) {
                    customers[customerIndex] = {
                        id: id,
                        code: document.getElementById('customerCode').value,
                        name: name,
                        phone: document.getElementById('customerPhone').value,
                        email: document.getElementById('customerEmail').value,
                        address: document.getElementById('customerAddress').value
                    };
                    const success = saveToLocalStorage('customers', customers);
                    
                    hideLoading();
                    
                    if (success) {
                        updateDashboard();
                        clearCustomerForm();
                        renderCustomers();
                        
                        const addButton = document.getElementById('btnSaveCustomer');
                        addButton.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„';
                        addButton.onclick = addCustomer;
                        
                        showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        hideAddCustomerForm();
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            } catch (error) {
                hideLoading();
                logError('Update Customer', error);
            }
        }

        async function deleteCustomer(id) {
            const confirmed = await showConfirmDialog({
                title: 'ğŸ—‘ï¸ Ù†Ù‚Ù„ Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…Ø§Ù‹.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„Ù‡',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            
            if (confirmed) {
                const customer = customers.find(c => c.id === id);
                if (customer) {
                    moveToTrash('customers', customer);
                    customers = customers.filter(c => c.id !== id);
                    const success = saveToLocalStorage('customers', customers);
                    if (success) {
                        renderCustomers();
                        updateDashboard();
                        showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            }
        }

        async function clearCustomerForm() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            const confirmed = await confirmCancelEdit('#customers');
            if (!confirmed) return;
            
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerAddress').value = '';
            const addButton = document.getElementById('btnSaveCustomer');
            if (addButton) {
                addButton.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„';
                addButton.onclick = addCustomer;
            }
            generateCustomerCode(); // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ±ÙŠØº
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            removeEditMode('#customers', '#customers h2', 'ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatCustomers" class="stat-mini-number">0</span></span>');
        }

        // ===== Suppliers Functions =====
        function generateSupplierCode() {
            document.getElementById('supplierCode').value = 'SU' + (suppliers.length + 1).toString().padStart(3, '0');
        }

        async function addSupplier() {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            const validation = validateForm({
                supplierName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') },
                    { validator: (v) => ValidationHelper.isUnique(v, suppliers, 'name', 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') }
                ],
                supplierPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') }
                ],
                supplierEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('supplierName').value.trim();
            const code = document.getElementById('supplierCode').value.trim();

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
            if (code) {
                if (typeof chartOfAccounts !== 'undefined' && chartOfAccounts.some(a => a.code === code)) {
                    showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª', 'warning');
                    return;
                }
                if (typeof customers !== 'undefined' && customers.some(c => c.code === code)) {
                    showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ø¹Ù…ÙŠÙ„', 'warning');
                    return;
                }
                if (suppliers.some(s => s.code === code)) {
                    showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù…ÙˆØ±Ø¯ Ø¢Ø®Ø±', 'warning');
                    return;
                }
            }

            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ±Ø¯...');

            try {
                const supplier = {
                    id: Date.now(),
                    code: document.getElementById('supplierCode').value || 'SU' + (suppliers.length + 1).toString().padStart(3, '0'),
                    name: name,
                    phone: document.getElementById('supplierPhone').value,
                    email: document.getElementById('supplierEmail').value,
                    address: document.getElementById('supplierAddress').value
                };
                suppliers.push(supplier);
                const success = saveToLocalStorage('suppliers', suppliers);
                
                hideLoading();
                
                if (success) {
                    updateDashboard();
                    clearSupplierForm();
                    renderSuppliers();
                    showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                } else {
                    suppliers.pop();
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            } catch (error) {
                hideLoading();
                logError('Add Supplier', error);
            }
        }

        function renderSuppliers() {
            const tbody = document.getElementById('suppliersList');
            tbody.innerHTML = '';
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
            let filteredSuppliers = [...suppliers];
            const searchText = document.getElementById('searchSuppliers')?.value || '';
            
            if (searchText) {
                filteredSuppliers = filteredSuppliers.filter(supplier => 
                    supplier.name.toLowerCase().includes(searchText.toLowerCase()) ||
                    supplier.code.toLowerCase().includes(searchText.toLowerCase()) ||
                    (supplier.phone && supplier.phone.includes(searchText)) ||
                    (supplier.email && supplier.email.toLowerCase().includes(searchText.toLowerCase())) ||
                    (supplier.address && supplier.address.toLowerCase().includes(searchText.toLowerCase()))
                );
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
            const sortState = FilterSortHelper.currentSort['suppliers'];
            if (sortState) {
                filteredSuppliers = FilterSortHelper.sortData(filteredSuppliers, sortState.column, sortState.direction);
            }

            if (filteredSuppliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
                return;
            }

            filteredSuppliers.forEach(supplier => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${supplier.code}</td>
                    <td>${supplier.name}</td>
                    <td>${supplier.phone}</td>
                    <td>${supplier.email}</td>
                    <td>${supplier.address}</td>
                    <td>
                        <div class="action-menu-container">
                            <button class="action-menu-btn" onclick="toggleActionMenu(event, ${supplier.id})">â‹®</button>
                            <div class="action-menu-content" id="menu-${supplier.id}">
                                <a href="#" onclick="event.preventDefault(); editSupplier(${supplier.id});">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>
                                <a href="#" onclick="event.preventDefault(); deleteSupplier(${supplier.id});" style="color: #dc3545;">ğŸ—‘ï¸ Ø­Ø°Ù</a>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        function resetSuppliersFilters() {
            document.getElementById('searchSuppliers').value = '';
            renderSuppliers();
        }

        function editSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (!supplier) return;
            
            document.getElementById('supplierCode').value = supplier.code;
            document.getElementById('supplierName').value = supplier.name;
            document.getElementById('supplierPhone').value = supplier.phone;
            document.getElementById('supplierEmail').value = supplier.email;
            document.getElementById('supplierAddress').value = supplier.address;
            const addButton = document.querySelector('#suppliers .btn-primary');
            addButton.textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ±Ø¯';
            addButton.onclick = () => updateSupplier(id);
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            applyEditMode('#suppliers', 'supplierName', '#suppliers h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯: ${supplier.name}`);
        }

        async function updateSupplier(id) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ø¹ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±
            const validation = validateForm({
                supplierName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') },
                    { validator: (v) => ValidationHelper.isUnique(v, suppliers, 'name', 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯', id) }
                ],
                supplierPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') }
                ],
                supplierEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('supplierName').value.trim();
            const newCode = document.getElementById('supplierCode').value.trim();
            const currentSupplier = suppliers.find(s => s.id === id);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… (ÙÙ‚Ø· Ø¥Ø°Ø§ ØªØºÙŠØ± Ø§Ù„ÙƒÙˆØ¯)
            if (newCode && currentSupplier && newCode !== currentSupplier.code) {
                if (typeof chartOfAccounts !== 'undefined' && chartOfAccounts.some(a => a.code === newCode)) {
                    showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª', 'warning');
                    return;
                }
                if (typeof customers !== 'undefined' && customers.some(c => c.code === newCode)) {
                    showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ø¹Ù…ÙŠÙ„', 'warning');
                    return;
                }
                if (suppliers.some(s => s.code === newCode)) {
                    showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù…ÙˆØ±Ø¯ Ø¢Ø®Ø±', 'warning');
                    return;
                }
            }

            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ±Ø¯...');

            try {
                const supplierIndex = suppliers.findIndex(s => s.id === id);
                if (supplierIndex !== -1) {
                    suppliers[supplierIndex] = {
                        id: id,
                        code: document.getElementById('supplierCode').value,
                        name: name,
                        phone: document.getElementById('supplierPhone').value,
                        email: document.getElementById('supplierEmail').value,
                        address: document.getElementById('supplierAddress').value
                    };
                    const success = saveToLocalStorage('suppliers', suppliers);
                    
                    hideLoading();
                    
                    if (success) {
                        updateDashboard();
                        clearSupplierForm();
                        renderSuppliers();
                        
                        const addButton = document.querySelector('#suppliers .btn-primary');
                        addButton.textContent = ' Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯';
                        addButton.onclick = addSupplier;
                        
                        showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            } catch (error) {
                hideLoading();
                logError('Update Supplier', error);
            }
        }

        async function deleteSupplier(id) {
            const confirmed = await showConfirmDialog({
                title: 'ğŸ—‘ï¸ Ù†Ù‚Ù„ Ù…ÙˆØ±Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…Ø§Ù‹.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„Ù‡',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            
            if (confirmed) {
                const supplier = suppliers.find(s => s.id === id);
                if (supplier) {
                    moveToTrash('suppliers', supplier);
                    suppliers = suppliers.filter(s => s.id !== id);
                    const success = saveToLocalStorage('suppliers', suppliers);
                    if (success) {
                        renderSuppliers();
                        updateDashboard();
                        showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            }
        }

        async function clearSupplierForm() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            const confirmed = await confirmCancelEdit('#suppliers');
            if (!confirmed) return;
            
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierAddress').value = '';
            const addButton = document.querySelector('#suppliers .btn-primary');
            addButton.textContent = ' Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯';
            addButton.onclick = addSupplier;
            generateSupplierCode(); // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ±ÙŠØº
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            removeEditMode('#suppliers', '#suppliers h2', 'ğŸª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatSuppliers" class="stat-mini-number">0</span></span>');
        }
        
        // ===== General Invoice Functions =====
        function resetInvoiceForms() {
            editingSaleId = null;
            editingPurchaseId = null;
            newSale();
            newPurchase();
        }

        // ===== Purchases Functions =====
        function generatePurchaseCode() {
            document.getElementById('purchaseCode').value = 'PUR' + currentPurchaseNumber.toString().padStart(3, '0');
        }
        
        function updatePurchaseDropdowns() {
            const supplierSelect = document.getElementById('purchaseSupplier');
            const itemSelect = document.getElementById('purchaseItem');
            
            supplierSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯</option>';
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name;
                supplierSelect.appendChild(option);
            });

            itemSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                
                // ğŸ“ Display base unit stock
                const baseUnit = item.units && item.units[0] ? item.units[0].name : 'ÙˆØ­Ø¯Ø©';
                option.textContent = `${item.name} (${item.stock} ${baseUnit} Ù…ØªÙˆÙØ±)`;
                
                option.dataset.price = item.cost;
                itemSelect.appendChild(option);
            });
            
            // ğŸª ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙØ±ÙˆØ¹
            updateBranchDropdowns();
            
            renderPurchasesList();
        }
        
        // ğŸ“ Update unit dropdown when item is selected (Purchases)
        function updatePurchaseItemUnits() {
            const itemSelect = document.getElementById('purchaseItem');
            const unitSelect = document.getElementById('purchaseUnit');
            const priceInput = document.getElementById('purchasePrice');
            
            const itemId = parseInt(itemSelect.value);
            const item = items.find(i => i.id === itemId);
            
            unitSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© --</option>';
            
            if (item && item.units && item.units.length > 0) {
                item.units.forEach((unit, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${unit.name}${unit.isBase ? ' (Ø£Ø³Ø§Ø³ÙŠØ©)' : ` (${unit.factor} ${item.units[0].name})`}`;
                    option.dataset.price = unit.price;
                    option.dataset.factor = unit.factor;
                    unitSelect.appendChild(option);
                });
                
                // Auto-select first unit
                unitSelect.value = '0';
                priceInput.value = item.cost || item.units[0].price;
            } else {
                // Fallback for old items
                priceInput.value = item ? (item.cost || 0) : '';
            }
        }
        
        // ğŸ“ Update price when unit is selected (Purchases)
        function updatePurchaseUnitPrice() {
            const unitSelect = document.getElementById('purchaseUnit');
            const priceInput = document.getElementById('purchasePrice');
            
            const selectedOption = unitSelect.options[unitSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.price) {
                priceInput.value = selectedOption.dataset.price;
            }
        }
        
        function addPurchaseItem() {
            const itemId = parseInt(document.getElementById('purchaseItem').value);
            const quantity = parseInt(document.getElementById('purchaseQuantity').value);
            const unitSelect = document.getElementById('purchaseUnit');
            const unitIndex = parseInt(unitSelect.value);
            const price = parseFloat(document.getElementById('purchasePrice').value);
            
            if (!itemId || !quantity || unitSelect.value === '' || isNaN(price)) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'warning');
                return;
            }
            
            const item = items.find(i => i.id === itemId);
            if (!item) {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }
            
            // ğŸ“ Get unit data
            let unitData = { name: 'Ù‚Ø·Ø¹Ø©', factor: 1 };
            if (item.units && item.units[unitIndex]) {
                unitData = item.units[unitIndex];
            }
            
            const existingItem = currentPurchaseItems.find(i => i.id === itemId && i.unitName === unitData.name);
            if (existingItem) {
                existingItem.quantity += quantity;
                existingItem.total = existingItem.quantity * existingItem.price;
            } else {
                currentPurchaseItems.push({
                    id: itemId,
                    name: item.name,
                    category: item.category || 'other',
                    quantity: quantity,
                    unitName: unitData.name,
                    unitFactor: unitData.factor,
                    price: price,
                    total: quantity * price
                });
            }
            
            renderPurchaseItems();
            updatePurchaseTotals();
            
            document.getElementById('purchaseItem').value = '';
            document.getElementById('purchaseQuantity').value = '1';
            document.getElementById('purchaseUnit').value = '';
            document.getElementById('purchasePrice').value = '';
        }
        
        function renderPurchaseItems() {
            const tbody = document.getElementById('purchaseItemsList');
            tbody.innerHTML = '';
            
            if (currentPurchaseItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù</td></tr>';
                return;
            }
            
            // Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ¦Ø§Øª Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            const categoryNames = {
                'food': 'ğŸ” Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©',
                'beverages': 'ğŸ¥¤ Ù…Ø´Ø±ÙˆØ¨Ø§Øª',
                'cleaning': 'ğŸ§¹ Ù…Ù†Ø¸ÙØ§Øª',
                'stationery': 'ğŸ“ Ù‚Ø±Ø·Ø§Ø³ÙŠØ©',
                'electronics': 'âš¡ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª',
                'clothing': 'ğŸ‘• Ù…Ù„Ø§Ø¨Ø³',
                'cosmetics': 'ğŸ’„ Ø¹Ø·ÙˆØ± ÙˆØªØ¬Ù…ÙŠÙ„',
                'medical': 'ğŸ’Š Ø£Ø¯ÙˆÙŠØ© ÙˆÙ…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø·Ø¨ÙŠØ©',
                'building': 'ğŸ”¨ Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡',
                'spare_parts': 'ğŸ”§ Ù‚Ø·Ø¹ ØºÙŠØ§Ø±',
                'other': 'ğŸ“¦ Ø£Ø®Ø±Ù‰'
            };
            
            // Ø£Ø³Ù…Ø§Ø¡ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            const unitNames = {
                'piece': 'Ù‚Ø·Ø¹Ø©', 'box': 'Ø¹Ù„Ø¨Ø©', 'carton': 'ÙƒØ±ØªÙˆÙ†', 'kg': 'ÙƒØ¬Ù…', 'gram': 'Ø¬Ø±Ø§Ù…', 'tola': 'ØªÙˆÙ„Ø©',
                'liter': 'Ù„ØªØ±', 'meter': 'Ù…ØªØ±', 'pack': 'Ø­Ø²Ù…Ø©', 'bottle': 'Ø²Ø¬Ø§Ø¬Ø©',
                'can': 'Ø¹Ù„Ø¨Ø© Ù…Ø¹Ø¯Ù†ÙŠØ©', 'bag': 'ÙƒÙŠØ³', 'dozen': 'Ø¯Ø³ØªØ©', 'set': 'Ø·Ù‚Ù…', 'roll': 'Ù„ÙØ©'
            };
            
            currentPurchaseItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${categoryNames[item.category] || item.category || '-'}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unitName || 'Ù‚Ø·Ø¹Ø©'}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.total.toFixed(2)}</td>
                    <td>
                        <button class="btn-danger" onclick="removePurchaseItem(${index})">Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function removePurchaseItem(index) {
            currentPurchaseItems.splice(index, 1);
            renderPurchaseItems();
            updatePurchaseTotals();
        }
        
        function updatePurchaseTotals() {
            const subtotal = currentPurchaseItems.reduce((sum, item) => sum + item.total, 0);
            const tax = subtotal * 0.15;
            const total = subtotal + tax;
            const paidAmount = parseFloat(document.getElementById('purchasePaidAmount').value) || 0;
            const remainingAmount = total - paidAmount;

            document.getElementById('purchaseSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('purchaseTax').textContent = tax.toFixed(2);
            document.getElementById('purchaseTotal').textContent = total.toFixed(2);
            
            const remainingEl = document.getElementById('purchaseRemainingAmount');
            remainingEl.textContent = remainingAmount.toFixed(2);
            remainingEl.className = remainingAmount <= 0 ? 'remaining-paid' : 'remaining-unpaid';
        }
        
       async function savePurchase() {
    const date = document.getElementById('purchaseDate').value;
    const supplierId = parseInt(document.getElementById('purchaseSupplier').value);
    const branchId = document.getElementById('purchaseBranch').value ? parseInt(document.getElementById('purchaseBranch').value) : null;
    const notes = document.getElementById('purchaseNotes').value;
    const paidAmount = parseFloat(document.getElementById('purchasePaidAmount').value) || 0;
    const paymentMethod = document.getElementById('purchasePaymentMethod').value;

    if (!date || !supplierId || currentPurchaseItems.length === 0) {
        showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù Ù„Ù„ÙØ§ØªÙˆØ±Ø©', 'warning');
        return;
    }
    
    const attachmentFile = document.getElementById('purchaseAttachment').files[0];
    let attachmentUrl = null;

    if (attachmentFile) {
        attachmentUrl = await uploadFile(attachmentFile, 'purchases');
        if (!attachmentUrl) {
            showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹', 'ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚ØŒ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
            return;
        }
    }
    
    const subtotal = currentPurchaseItems.reduce((sum, item) => sum + item.total, 0);
    const tax = subtotal * 0.15;
    const total = subtotal + tax;
    const remainingAmount = total - paidAmount;

    if (editingPurchaseId) {
        const purchaseIndex = purchases.findIndex(p => p.id === editingPurchaseId);
        if (purchaseIndex > -1) {
            const originalPurchase = purchases[purchaseIndex];
            
            originalPurchase.items.forEach(pi => {
                const item = items.find(i => i.id === pi.id);
                if (item) item.stock -= pi.quantity;
            });

            const updatedPurchase = {
                ...originalPurchase,
                date,
                supplierId,
                branchId,
                notes,
                paidAmount,
                paymentMethod,
                items: [...currentPurchaseItems],
                subtotal,
                tax,
                total,
                remainingAmount,
                attachmentUrl: attachmentUrl || originalPurchase.attachmentUrl
            };

            purchases[purchaseIndex] = updatedPurchase;
            
            showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… PUR${originalPurchase.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
        }
    } else {
         const newPurchaseData = { 
             id: Date.now(), 
             number: currentPurchaseNumber, 
             date, 
             supplierId, 
             branchId,
             notes, 
             paidAmount,
             paymentMethod, 
             items: [...currentPurchaseItems], 
             subtotal, 
             tax, 
             total, 
             remainingAmount,
             attachmentUrl: attachmentUrl 
         };
        purchases.push(newPurchaseData);
        currentPurchaseNumber++;
        showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… PUR${newPurchaseData.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
        
        // ğŸ“’ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        console.log('ğŸ“’ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª...');
        await createPurchaseJournalEntry(newPurchaseData);
        
        // ğŸ“‹ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø°Ù† Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø®Ø²Ù†ÙŠ
        await createStockPermission('in', newPurchaseData);
    }
    
    console.log('ğŸ’¾ Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª...');
    console.log(`ğŸ“Š Ø¹Ø¯Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸: ${purchases.length}`);
    const success1 = await saveToLocalStorage('purchases', purchases);
    console.log(`ğŸ’¾ Ù†ØªÙŠØ¬Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${success1 ? 'âœ… Ù†Ø¬Ø­' : 'âŒ ÙØ´Ù„'}`);
    
    // ğŸ” ØªØ­Ù‚Ù‚ ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø­ÙØ¸ ÙÙŠ LocalStorage
    const fullKey = currentActivityId ? `activity_${currentActivityId}_purchases` : 'purchases';
    const immediateCheck = localStorage.getItem(fullKey);
    if (immediateCheck) {
        const parsedData = JSON.parse(immediateCheck);
        console.log(`âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ: ØªÙ… Ø­ÙØ¸ ${parsedData.length} ÙØ§ØªÙˆØ±Ø© ÙÙŠ localStorage`);
        if (parsedData.length !== purchases.length) {
            console.error(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚! Ù…Ø­ÙÙˆØ¸=${parsedData.length}, Ù…ØªÙˆÙ‚Ø¹=${purchases.length}`);
        }
    } else {
        console.error(`âŒ Ø®Ø·Ø£ Ø®Ø·ÙŠØ±: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ localStorage Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸!`);
    }
    
    currentPurchaseItems.forEach(pi => {
        const item = items.find(i => i.id === pi.id);
        if (item) {
            // ğŸ“ Add stock in base units (quantity Ã— unitFactor)
            const baseQuantity = pi.quantity * (pi.unitFactor || 1);
            item.stock += baseQuantity;
        }
    });
    
    console.log('ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ†Ø§Ù...');
    const success2 = await saveToLocalStorage('items', items);
    console.log(`ğŸ’¾ Ù†ØªÙŠØ¬Ø© Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ†Ø§Ù: ${success2 ? 'âœ… Ù†Ø¬Ø­' : 'âŒ ÙØ´Ù„'}`);
    
    if (success1 && success2) {
        console.log('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ… Ø­ÙØ¸Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­ - Ø§Ù„Ø¢Ù† Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…');
        console.log(`ğŸ“Š Ø¹Ø¯Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${purchases.length}`);
        console.log(`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${purchases.reduce((s, i) => s + (Number(i.total) || 0), 0).toFixed(2)}`);
        
        await newPurchase();
        showSection('purchasesManagement'); // Return to list view after save
            
        console.log('ğŸ”„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ updateDashboard...');
        updateDashboard();
        console.log('âœ… ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ updateDashboard');
        
        renderItems();
    } else {
        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}        
        async function newPurchase() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            const confirmed = await confirmCancelEdit('#purchases');
            if (!confirmed) return;
            
            currentPurchaseItems = [];
            editingPurchaseId = null;
            document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('purchaseSupplier').value = '';
            document.getElementById('purchaseSupplierName').value = '';
            document.getElementById('purchaseSupplierCode').value = '';
            document.getElementById('purchaseSupplierPhone').value = '';
            document.getElementById('purchaseSupplierAddress').value = '';
            document.getElementById('purchaseNotes').value = '';
            document.getElementById('purchasePaidAmount').value = '';
            document.getElementById('purchasePaymentMethod').value = 'cash';
            generatePurchaseCode();
            document.getElementById('savePurchaseBtn').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            renderPurchaseItems();
            updatePurchaseTotals();
            renderPurchasesList();
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            removeEditMode('#purchases', '#purchases h2', 'ğŸ›’ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatPurchases" class="stat-mini-number">0</span></span>');
      
  }
  function renderPurchasesList() {
    const tbody = document.getElementById('purchasesList');
    tbody.innerHTML = '';
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
    let filteredPurchases = [...purchases];
    const searchText = document.getElementById('searchPurchases')?.value || '';
    
    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
    if (searchText) {
        filteredPurchases = filteredPurchases.filter(purchase => {
            const supplier = suppliers.find(s => s.id === purchase.supplierId);
            return (`pur${purchase.number}`.toLowerCase().includes(searchText.toLowerCase()) || 
                    (supplier && supplier.name.toLowerCase().includes(searchText.toLowerCase())) || 
                    purchase.date.includes(searchText));
        });
    }
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const dateFrom = document.getElementById('purchasesDateFrom')?.value;
    const dateTo = document.getElementById('purchasesDateTo')?.value;
    if (dateFrom) {
        filteredPurchases = filteredPurchases.filter(purchase => new Date(purchase.date) >= new Date(dateFrom));
    }
    if (dateTo) {
        filteredPurchases = filteredPurchases.filter(purchase => new Date(purchase.date) <= new Date(dateTo));
    }
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº
    const amountFrom = document.getElementById('purchasesAmountFrom')?.value;
    const amountTo = document.getElementById('purchasesAmountTo')?.value;
    if (amountFrom) {
        filteredPurchases = filteredPurchases.filter(purchase => purchase.total >= parseFloat(amountFrom));
    }
    if (amountTo) {
        filteredPurchases = filteredPurchases.filter(purchase => purchase.total <= parseFloat(amountTo));
    }
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
    const sortState = FilterSortHelper.currentSort['purchases'];
    if (sortState) {
        filteredPurchases = FilterSortHelper.sortData(filteredPurchases, sortState.column, sortState.direction);
    }
    
    if (filteredPurchases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>'; // ğŸ’¡ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø¥Ù„Ù‰ 9
        return;
    }
    
    // --- Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØµØ­ÙŠØ­ (Ø­Ù„Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) ---
    filteredPurchases.forEach(purchase => {
        const supplier = suppliers.find(s => s.id === purchase.supplierId);
        const totalQty = purchase.items.reduce((sum, item) => sum + item.quantity, 0);

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ (Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© + Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
        const totalPaid = getTotalPaid(purchase.id, 'purchase');
        const remaining = purchase.total - totalPaid;
        const remainingClass = remaining > 0.01 ? 'remaining-unpaid' : (remaining < -0.01 ? 'remaining-credit' : 'remaining-paid');
        const remainingText = remaining.toFixed(2);
        
        const attachmentLink = purchase.attachmentUrl 
            ? `<a href="${purchase.attachmentUrl}" target="_blank" class="btn-info" style="padding: 4px 8px; text-decoration: none;">Ø¹Ø±Ø¶</a>`
            : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>PUR${purchase.number.toString().padStart(3, '0')}</td>
            <td>${purchase.date}</td>
            <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>${totalQty}</td>
            <td>${purchase.total.toFixed(2)}</td>
            <td>${totalPaid.toFixed(2)}</td>
            <td class="${remainingClass}">${remainingText}</td>
            <td>${attachmentLink}</td>
            <td>
            <div class="action-menu-container">
                <button class="action-menu-btn" onclick="toggleActionMenu(this, 'purchase-menu-${purchase.id}', event)">â‹®</button>
                <div id="purchase-menu-${purchase.id}" class="action-menu-content">
                    <a href="#" onclick="event.preventDefault(); event.stopPropagation(); printPurchaseInvoice(${purchase.id});">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</a>
                    <a href="#" onclick="event.preventDefault(); event.stopPropagation(); editPurchase(${purchase.id});">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>
                    ${remaining > 0.01 ? `<a href="#" onclick="event.preventDefault(); event.stopPropagation(); showAddPaymentModal(${purchase.id}, 'purchase');">â±ï¸ Ø³Ø¯Ø§Ø¯ Ù‚Ø³Ø·</a>` : ''}
                    <a href="#" onclick="event.preventDefault(); event.stopPropagation(); showPaymentsHistory(${purchase.id}, 'purchase');">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª</a>
                    <a href="#" class="delete-action" onclick="event.preventDefault(); event.stopPropagation(); deletePurchase(${purchase.id});">ğŸ—‘ï¸ Ø­Ø°Ù</a>
                </div>
            </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
        function applyPurchasesFilters() {
            renderPurchasesList();
        }
        
        function resetPurchasesFilters() {
            document.getElementById('purchasesDateFrom').value = '';
            document.getElementById('purchasesDateTo').value = '';
            document.getElementById('purchasesAmountFrom').value = '';
            document.getElementById('purchasesAmountTo').value = '';
            document.getElementById('searchPurchases').value = '';
            renderPurchasesList();
        }

        function searchPurchases() {
            renderPurchasesList();
        }

        function renderFilteredPurchases(filtered) {
            // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù… ØªØ¹Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø© - ØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ ÙÙŠ renderPurchasesList
            renderPurchasesList();
        }

        function printPurchaseInvoice(purchaseId) {
            const purchase = purchases.find(p => p.id === purchaseId);
            if (!purchase) return;
            
            const supplier = suppliers.find(s => s.id === purchase.supplierId);
            
            // ØªØ­Ù…ÙŠÙ„ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· ÙˆØ§Ø³Ù…Ù‡
            const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
            if (currentActivity) {
                document.getElementById('printPurchaseActivityName').textContent = currentActivity.name;
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† localStorage
                const storageKey = `activity_${currentActivity.id}_data`;
                const activityData = JSON.parse(localStorage.getItem(storageKey));
                const logoImg = document.getElementById('printPurchaseActivityLogo');
                
                if (activityData && activityData.logo) {
                    logoImg.src = activityData.logo;
                    logoImg.style.display = 'block';
                } else {
                    logoImg.style.display = 'none';
                }
            }
            
            // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
            document.getElementById('printPurchaseDate').textContent = purchase.date;
            const now = new Date();
            document.getElementById('printPurchaseTime').textContent = now.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('printPurchaseNumber').textContent = purchase.number.toString().padStart(3, '0');
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯
            document.getElementById('printSupplierName').textContent = supplier ? supplier.name : '-----';
            
            // Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            const notesElement = document.getElementById('printPurchaseNotes');
            if (notesElement) {
                notesElement.textContent = purchase.notes || '-----';
            }
            
            // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù
            const itemsBody = document.getElementById('printPurchaseItems');
            itemsBody.innerHTML = '';
            purchase.items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${index + 1}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: right;">${item.name}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${item.quantity}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${item.unit || 'Ù‚Ø·Ø¹Ø©'}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${item.price.toFixed(2)}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; direction: ltr; font-weight: bold;">${item.total.toFixed(2)}</td>
                `;
                itemsBody.appendChild(tr);
            });
            
            // Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
            document.getElementById('printPurchaseSubtotal').textContent = (purchase.subtotal || 0).toFixed(2);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹
            const taxAmount = purchase.tax || 0;
            document.getElementById('printPurchaseTax').textContent = taxAmount.toFixed(2);
            const taxRow = document.getElementById('printPurchaseTaxRow');
            if (taxRow) taxRow.style.display = 'grid'; // Ø¥Ø¸Ù‡Ø§Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹
            
            document.getElementById('printPurchaseTotal').textContent = (purchase.total || 0).toFixed(2);
            document.getElementById('printPurchasePaid').textContent = (purchase.paidAmount || 0).toFixed(2);
            const remaining = (purchase.remainingAmount !== undefined) ? purchase.remainingAmount : ((purchase.total || 0) - (purchase.paidAmount || 0));
            document.getElementById('printPurchaseRemaining').textContent = remaining.toFixed(2);
            
            const printSection = document.getElementById('purchaseInvoicePrint');
            if (!printSection) {
                showNotification('âŒ Ø®Ø·Ø£', 'Ù‚Ø³Ù… Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }
            // Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø¨Ø± Ù†Ø§ÙØ°Ø© Ù…Ø³ØªÙ‚Ù„Ø© Ù„ØªØ¬Ù†Ø¨ ØªØ¹Ø§Ø±Ø¶Ø§Øª CSS
            const opened = typeof openPrintWindowWithSection === 'function'
                ? openPrintWindowWithSection(printSection, `ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª Ø±Ù‚Ù… PUR${purchase.number.toString().padStart(3, '0')}`)
                : false;
            if (!opened) {
                // Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
                printSection.style.display = 'block';
                setTimeout(() => {
                    window.print();
                    setTimeout(() => { printSection.style.display = 'none'; }, 150);
                }, 350);
            }
        }
        window.printPurchaseInvoice = printPurchaseInvoice;
        
        async function deletePurchase(id) {
            const confirmed = await showConfirmDialog({
                title: 'ğŸ—‘ï¸ Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nâš ï¸ Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡Ø§',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡',
                icon: 'ğŸ“¦'
            });
            
            if (confirmed) {
                const pIndex = purchases.findIndex(p => p.id === id);
                if (pIndex > -1) {
                    const purchase = purchases[pIndex];
                    
                    // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª
                    purchase.items.forEach(pi => {
                        const item = items.find(i => i.id === pi.id);
                        if (item) item.stock -= pi.quantity;
                    });
                    saveToLocalStorage('items', items);
                    
                    // Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                    moveToTrash('purchases', purchase);
                    purchases.splice(pIndex, 1);
                    saveToLocalStorage('purchases', purchases);
                    
                    renderPurchasesList();
                    updateDashboard();
                    renderItems();
                    showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                }
            }
        }
        
        function editPurchase(id) {
            const purchase = purchases.find(p => p.id === id);
            if (!purchase) return;
            
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹
            showSection('purchases');
            
            editingPurchaseId = id;
            currentPurchaseItems = JSON.parse(JSON.stringify(purchase.items));
            
            document.getElementById('purchaseDate').value = purchase.date;
            document.getElementById('purchaseSupplier').value = purchase.supplierId;
            document.getElementById('purchaseNotes').value = purchase.notes;
            document.getElementById('purchasePaidAmount').value = purchase.paidAmount || 0;
            document.getElementById('purchaseCode').value = `ØªØ¹Ø¯ÙŠÙ„ PUR${purchase.number.toString().padStart(3, '0')}`;
            document.getElementById('savePurchaseBtn').textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            
            renderPurchaseItems();
            updatePurchaseTotals();
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            const supplierName = suppliers.find(s => s.id === purchase.supplierId)?.name || 'Ø§Ù„Ù…ÙˆØ±Ø¯';
            applyEditMode('#purchases', 'purchaseSupplier', '#purchases h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${supplierName}`);
        }
        
        // Expose functions to window
        window.deletePurchase = deletePurchase;
        window.editPurchase = editPurchase;

        // ===== Sales Functions =====
        function generateSaleCode() {
            document.getElementById('saleCode').value = 'SAL' + currentSaleNumber.toString().padStart(3, '0');
        }
        
        function updateSaleDropdowns() {
            const customerSelect = document.getElementById('saleCustomer');
            const itemSelect = document.getElementById('saleItem');
            
            customerSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                customerSelect.appendChild(option);
            });

            itemSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                
                // ğŸ“ Display base unit stock
                const baseUnit = item.units && item.units[0] ? item.units[0].name : 'ÙˆØ­Ø¯Ø©';
                option.textContent = `${item.name} (${item.stock} ${baseUnit} Ù…ØªÙˆÙØ±)`;
                
                // Keep for backward compatibility
                option.dataset.price = item.units && item.units[0] ? item.units[0].price : (item.price || 0);
                itemSelect.appendChild(option);
            });
            
            // ğŸª ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙØ±ÙˆØ¹
            updateBranchDropdowns();
            
            renderSalesList();
        }
        
        // ğŸ“ Update unit dropdown when item is selected (Sales)
        function updateSaleItemUnits() {
            const itemSelect = document.getElementById('saleItem');
            const unitSelect = document.getElementById('saleUnit');
            const priceInput = document.getElementById('salePrice');
            
            const itemId = parseInt(itemSelect.value);
            const item = items.find(i => i.id === itemId);
            
            unitSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© --</option>';
            
            if (item && item.units && item.units.length > 0) {
                item.units.forEach((unit, index) => {
                    const option = document.createElement('option');
                    option.value = index; // Store unit index
                    option.textContent = `${unit.name}${unit.isBase ? ' (Ø£Ø³Ø§Ø³ÙŠØ©)' : ` (${unit.factor} ${item.units[0].name})`}`;
                    option.dataset.price = unit.price;
                    option.dataset.factor = unit.factor;
                    unitSelect.appendChild(option);
                });
                
                // Auto-select first unit (base)
                unitSelect.value = '0';
                priceInput.value = item.units[0].price;
            } else {
                // Fallback for old items without units
                priceInput.value = item ? (item.price || 0) : '';
            }
        }
        
        // ğŸ“ Update price when unit is selected (Sales)
        function updateSaleUnitPrice() {
            const unitSelect = document.getElementById('saleUnit');
            const priceInput = document.getElementById('salePrice');
            
            const selectedOption = unitSelect.options[unitSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.price) {
                priceInput.value = selectedOption.dataset.price;
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        function updateCustomerFields() {
            const customerSelect = document.getElementById('saleCustomer');
            const customerId = parseInt(customerSelect.value);
            const customer = customers.find(c => c.id === customerId);
            
            if (customer) {
                document.getElementById('saleCustomerName').value = customer.name || '';
                document.getElementById('saleCustomerCode').value = customer.code || '';
                document.getElementById('saleCustomerPhone').value = customer.phone || '';
                document.getElementById('saleCustomerAddress').value = customer.address || '';
            } else {
                document.getElementById('saleCustomerName').value = '';
                document.getElementById('saleCustomerCode').value = '';
                document.getElementById('saleCustomerPhone').value = '';
                document.getElementById('saleCustomerAddress').value = '';
            }
        }
        
        // ğŸª ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙØ±ÙˆØ¹ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
        function updateBranchDropdowns() {
            const activityBranches = branches.filter(b => b.activityId === currentActivityId);
            
            // Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©)
            const adminSelects = ['expenseBranchId', 'salaryBranchId', 'purchaseBranch'];
            
            // Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© Ø§Ù„Ø£Ø®Ø±Ù‰ (Ø¨Ø¯ÙˆÙ† Ø®ÙŠØ§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©)
            const regularSelects = ['saleBranch', 'revenueBranchId'];
            
            // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨ (Ù…Ø¹ Ø®ÙŠØ§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©)
            adminSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="general_admin">ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>';
                select.innerHTML += '<option value="">ğŸª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>';
                
                activityBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id;
                    option.textContent = branch.name;
                    select.appendChild(option);
                });
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                if (currentValue === 'general_admin' || currentValue === '' || activityBranches.find(b => b.id == currentValue)) {
                    select.value = currentValue;
                }
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø®ÙŠØ§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©)
            regularSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">ğŸª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>';
                
                activityBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id;
                    option.textContent = branch.name;
                    select.appendChild(option);
                });
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                if (currentValue && activityBranches.find(b => b.id == currentValue)) {
                    select.value = currentValue;
                }
            });
        }

        // === ğŸ“„ Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ ===
        
        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ù…Ù† localStorage
        function loadFooterSettings() {
            console.log('ğŸ¯ loadFooterSettings() CALLED!');
            try {
                const savedSettings = localStorage.getItem('footerSettings');
                const settings = savedSettings ? JSON.parse(savedSettings) : getDefaultFooterSettings();
                
                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©)
                const companyNameInput = document.getElementById('footerCompanyNameInput');
                if (companyNameInput) {
                    companyNameInput.value = settings.companyName || '';
                    document.getElementById('footerCompanyDescInput').value = settings.companyDesc || '';
                    document.getElementById('footerPhoneInput').value = settings.phone || '';
                    document.getElementById('footerEmailInput').value = settings.email || '';
                    document.getElementById('footerAddressInput').value = settings.address || '';
                    document.getElementById('footerTwitterInput').value = settings.twitterUrl || '';
                    document.getElementById('footerFacebookInput').value = settings.facebookUrl || '';
                    document.getElementById('footerInstagramInput').value = settings.instagramUrl || '';
                    document.getElementById('footerLinkedinInput').value = settings.linkedinUrl || '';
                    document.getElementById('footerCopyrightInput').value = settings.copyright || '';
                    document.getElementById('footerVersionInput').value = settings.version || '';
                }
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ
                updateFooterDisplay(settings);
                
                console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„:', error);
                // Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø£Ø¸Ù‡Ø± Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                updateFooterDisplay(getDefaultFooterSettings());
            }
        }
        
        // Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„
        function saveFooterSettings() {
            try {
                const settings = {
                    companyName: document.getElementById('footerCompanyNameInput').value.trim(),
                    companyDesc: document.getElementById('footerCompanyDescInput').value.trim(),
                    phone: document.getElementById('footerPhoneInput').value.trim(),
                    email: document.getElementById('footerEmailInput').value.trim(),
                    address: document.getElementById('footerAddressInput').value.trim(),
                    twitterUrl: document.getElementById('footerTwitterInput').value.trim(),
                    facebookUrl: document.getElementById('footerFacebookInput').value.trim(),
                    instagramUrl: document.getElementById('footerInstagramInput').value.trim(),
                    linkedinUrl: document.getElementById('footerLinkedinInput').value.trim(),
                    copyright: document.getElementById('footerCopyrightInput').value.trim(),
                    version: document.getElementById('footerVersionInput').value.trim()
                };
                
                localStorage.setItem('footerSettings', JSON.stringify(settings));
                updateFooterDisplay(settings);
                
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'error');
            }
        }
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ØªØ°ÙŠÙŠÙ„
        function updateFooterDisplay(settings) {
            try {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ
                const footerCompanyName = document.getElementById('footerCompanyName');
                const footerCompanyDesc = document.getElementById('footerCompanyDesc');
                const footerPhone = document.getElementById('footerPhone');
                const footerEmail = document.getElementById('footerEmail');
                const footerAddress = document.getElementById('footerAddress');
                const footerCopyright = document.getElementById('footerCopyright');
                const footerVersion = document.getElementById('footerVersion');
                
                if (footerCompanyName) footerCompanyName.textContent = settings.companyName || 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©';
                if (footerCompanyDesc) footerCompanyDesc.textContent = settings.companyDesc || 'ÙˆØµÙ Ù…Ø®ØªØµØ± Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ';
                if (footerPhone) footerPhone.textContent = settings.phone ? `ğŸ“ ${settings.phone}` : 'ğŸ“ +966 xx xxx xxxx';
                if (footerEmail) footerEmail.textContent = settings.email ? `âœ‰ï¸ ${settings.email}` : 'âœ‰ï¸ info@company.com';
                if (footerAddress) footerAddress.textContent = settings.address ? `ğŸ“ ${settings.address}` : 'ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†';
                if (footerCopyright) footerCopyright.textContent = settings.copyright || 'Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©';
                if (footerVersion) footerVersion.textContent = settings.version || 'Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.0';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„ÙØ§Ø±ØºØ© Ù…Ù†Ù‡Ø§
                const links = [
                    { id: 'footerTwitterLink', url: settings.twitterUrl },
                    { id: 'footerFacebookLink', url: settings.facebookUrl },
                    { id: 'footerInstagramLink', url: settings.instagramUrl },
                    { id: 'footerLinkedinLink', url: settings.linkedinUrl }
                ];
                
                links.forEach(link => {
                    const element = document.getElementById(link.id);
                    if (element) {
                        if (link.url) {
                            element.href = link.url;
                            element.style.display = 'inline-block';
                        } else {
                            element.href = '#';
                            element.style.display = 'none';
                        }
                    }
                });
                
                console.log('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¹Ù„Ù‰ DOM');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„:', error);
            } finally {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£)
                setTimeout(() => {
                    console.log('â° setTimeout fired - about to show footer...');
                    const footer = document.getElementById('appFooter');
                    if (footer) {
                        footer.style.opacity = '1';
                        console.log('âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ°ÙŠÙŠÙ„');
                    } else {
                        console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± Ø§Ù„ØªØ°ÙŠÙŠÙ„ #appFooter');
                    }
                }, 50);
            }
        }
        
        // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        function getDefaultFooterSettings() {
            return {
                companyName: 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©',
                companyDesc: 'ÙˆØµÙ Ù…Ø®ØªØµØ± Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ',
                phone: '+966 xx xxx xxxx',
                email: 'info@company.com',
                address: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†',
                twitterUrl: '',
                facebookUrl: '',
                instagramUrl: '',
                linkedinUrl: '',
                copyright: 'Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©',
                version: 'Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.0'
            };
        }
        
        // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function openFooterSettingsModal() {
            const modal = document.getElementById('footerSettingsModal');
            if (modal) {
                modal.style.display = 'flex';
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„
                loadFooterSettings();
            }
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function closeFooterSettingsModal() {
            const modal = document.getElementById('footerSettingsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function saveFooterSettingsFromModal() {
            saveFooterSettings();
            closeFooterSettingsModal();
        }
        
        // === Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© ØªØ®ØµÙŠØµ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ===
        
        // ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ®ØµÙŠØµ Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
        function openAboutSettingsModal() {
            const modal = document.getElementById('about-settings-overlay');
            if (modal) {
                modal.style.display = 'flex';
                loadAboutSettingsToModal();
            }
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªØ®ØµÙŠØµ Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
        function closeAboutSettingsModal() {
            const modal = document.getElementById('about-settings-overlay');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function loadAboutSettingsToModal() {
            const aboutData = loadFromLocalStorage('about_info') || {
                programName: 'Ø¯ÙŠÙˆØ§Ù†ÙŠ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©',
                version: 'Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2.0',
                description: 'Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©ØŒ ÙŠÙˆÙØ± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø³Ù‡Ù„Ø© ÙˆÙØ¹Ø§Ù„Ø©. ÙŠØ¯Ø¹Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆØ§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… FirebaseØŒ Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø¯ÙŠØ«Ø© ÙˆØ³Ù‡Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….',
                developer: 'ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ·ÙˆÙŠØ±',
                year: '2025',
                website: '',
                email: ''
            };
            
            document.getElementById('aboutProgramNameInput').value = aboutData.programName || '';
            document.getElementById('aboutVersionInput').value = aboutData.version || '';
            document.getElementById('aboutDescriptionInput').value = aboutData.description || '';
            document.getElementById('aboutDeveloperInput').value = aboutData.developer || '';
            document.getElementById('aboutYearInput').value = aboutData.year || '';
            document.getElementById('aboutWebsiteInput').value = aboutData.website || '';
            document.getElementById('aboutEmailInput').value = aboutData.email || '';
        }
        
        // Ø­ÙØ¸ ØªØ®ØµÙŠØµØ§Øª Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
        function saveAboutSettings() {
            const aboutData = {
                programName: document.getElementById('aboutProgramNameInput').value.trim() || 'Ø¯ÙŠÙˆØ§Ù†ÙŠ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©',
                version: document.getElementById('aboutVersionInput').value.trim() || 'Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2.0',
                description: document.getElementById('aboutDescriptionInput').value.trim() || 'Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©',
                developer: document.getElementById('aboutDeveloperInput').value.trim() || 'ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ·ÙˆÙŠØ±',
                year: document.getElementById('aboutYearInput').value.trim() || '2025',
                website: document.getElementById('aboutWebsiteInput').value.trim(),
                email: document.getElementById('aboutEmailInput').value.trim()
            };
            
            // Ø­ÙØ¸ ÙÙŠ LocalStorage
            saveToLocalStorage('about_info', aboutData);
            
            // ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
            updateAboutPage(aboutData);
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
            closeAboutSettingsModal();
            
            showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø­ÙØ¸ ØªØ®ØµÙŠØµØ§Øª Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
        
        // ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        function updateAboutPage(aboutData) {
            const programNameEl = document.getElementById('aboutProgramName');
            const versionEl = document.getElementById('aboutVersion');
            const descriptionEl = document.getElementById('aboutDescription');
            const developerEl = document.getElementById('aboutDeveloper');
            const yearEl = document.getElementById('aboutYear');
            const logoEl = document.getElementById('aboutProgramLogo');
            
            if (programNameEl) programNameEl.textContent = aboutData.programName;
            if (versionEl) versionEl.textContent = aboutData.version;
            if (descriptionEl) descriptionEl.textContent = aboutData.description;
            if (developerEl) developerEl.textContent = aboutData.developer;
            if (yearEl) yearEl.textContent = aboutData.year;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† localStorage
            if (logoEl) {
                const logoData = loadFromLocalStorage('programLogo');
                if (logoData) {
                    logoEl.src = logoData;
                    logoEl.style.display = 'block';
                } else {
                    // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                    logoEl.src = 'https://res.cloudinary.com/dgjcr2bgq/image/upload/v1762349658/logo_vlldbc.png';
                    logoEl.style.display = 'block';
                }
            }
            
            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„
            updateContactInfo(aboutData);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ ÙÙŠ ØµÙØ­Ø© Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
        function updateContactInfo(aboutData) {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù†ØµØ± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØªØ­Ø¯ÙŠØ«Ù‡
            const contactInfoDiv = document.querySelector('#about .settings-card:nth-last-of-type(2) > div:last-child');
            if (contactInfoDiv) {
                let html = '<p style="margin: 0; font-size: 0.95em; color: #333;">';
                if (aboutData.website) {
                    html += `ğŸŒ <strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> ${aboutData.website}<br>`;
                } else {
                    html += 'ğŸŒ <strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> Ù‚Ø±ÙŠØ¨Ø§Ù‹<br>';
                }
                if (aboutData.email) {
                    html += `ğŸ“§ <strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> ${aboutData.email}`;
                } else {
                    html += 'ğŸ“§ <strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> Ù‚Ø±ÙŠØ¨Ø§Ù‹';
                }
                html += '</p>';
                contactInfoDiv.innerHTML = html;
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        function loadAboutPageOnOpen() {
            const aboutData = loadFromLocalStorage('about_info');
            if (aboutData) {
                updateAboutPage(aboutData);
            }
        }
        
        // === Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ ØªØ®ØµÙŠØµ Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ===
        
        // === Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ ===
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        function updateSupplierFields() {
            const supplierSelect = document.getElementById('purchaseSupplier');
            const supplierId = parseInt(supplierSelect.value);
            const supplier = suppliers.find(s => s.id === supplierId);
            
            if (supplier) {
                document.getElementById('purchaseSupplierName').value = supplier.name || '';
                document.getElementById('purchaseSupplierCode').value = supplier.code || '';
                document.getElementById('purchaseSupplierPhone').value = supplier.phone || '';
                document.getElementById('purchaseSupplierAddress').value = supplier.address || '';
            } else {
                document.getElementById('purchaseSupplierName').value = '';
                document.getElementById('purchaseSupplierCode').value = '';
                document.getElementById('purchaseSupplierPhone').value = '';
                document.getElementById('purchaseSupplierAddress').value = '';
            }
        }
        
        function updatePurchaseItemFields() {
            const itemId = parseInt(document.getElementById('purchaseItem').value);
            const item = items.find(i => i.id === itemId);
            
            if (item) {
                // Ù…Ù„Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù
                document.getElementById('purchaseUnit').value = item.unit || '';
                // Ù…Ù„Ø¡ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø§Ù„ØªÙƒÙ„ÙØ©) Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù
                document.getElementById('purchasePrice').value = item.cost || '';
            } else {
                document.getElementById('purchaseUnit').value = '';
                document.getElementById('purchasePrice').value = '';
            }
        }
        
        function addSaleItem() {
            const itemId = parseInt(document.getElementById('saleItem').value);
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const unitSelect = document.getElementById('saleUnit');
            const unitIndex = parseInt(unitSelect.value);
            const price = parseFloat(document.getElementById('salePrice').value);
            
            if (!itemId || !quantity || unitSelect.value === '' || isNaN(price)) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'warning');
                return;
            }
            
            const item = items.find(i => i.id === itemId);
            if (!item) {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }
            
            // ğŸ“ Get unit data
            let unitData = { name: 'Ù‚Ø·Ø¹Ø©', factor: 1 };
            if (item.units && item.units[unitIndex]) {
                unitData = item.units[unitIndex];
            }
            
            // ğŸ“ Calculate quantity in base units for stock check
            const baseQuantity = quantity * unitData.factor;
            
            // Check existing items with same unit in cart
            const existingInCart = currentSaleItems.find(i => i.id === itemId && i.unitName === unitData.name);
            const baseQtyInCart = existingInCart ? (existingInCart.quantity * existingInCart.unitFactor) : 0;

            // Stock validation in base units
            if (item.stock < (baseQuantity + baseQtyInCart)) {
                const baseUnitName = item.units && item.units[0] ? item.units[0].name : 'ÙˆØ­Ø¯Ø©';
                showNotification('âš ï¸ Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙ', `Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${baseQuantity + baseQtyInCart} ${baseUnitName}) ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©. Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${item.stock} ${baseUnitName}`, 'warning', 6000);
                return;
            }
            
            if (existingInCart) {
                existingInCart.quantity += quantity;
                existingInCart.total = existingInCart.quantity * existingInCart.price;
            } else {
                currentSaleItems.push({ 
                    id: itemId, 
                    name: item.name, 
                    quantity: quantity, 
                    unitName: unitData.name, 
                    unitFactor: unitData.factor,
                    price: price, 
                    total: quantity * price 
                });
            }
            
            renderSaleItems();
            updateSaleTotals();
            
            document.getElementById('saleItem').value = '';
            document.getElementById('saleQuantity').value = '1';
            document.getElementById('saleUnit').value = '';
            document.getElementById('salePrice').value = '';
        }
        
        function renderSaleItems() {
            const tbody = document.getElementById('saleItemsList');
            const tableContainer = document.getElementById('saleItemsTableContainer');
            tbody.innerHTML = '';
            
            if (currentSaleItems.length === 0) {
                tableContainer.style.display = 'none';
                return;
            }
            
            tableContainer.style.display = 'block';
            currentSaleItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unitName || item.unit || 'Ù‚Ø·Ø¹Ø©'}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.total.toFixed(2)}</td>
                    <td><button class="btn-danger" onclick="removeSaleItem(${index})">Ø­Ø°Ù</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function removeSaleItem(index) {
            currentSaleItems.splice(index, 1);
            renderSaleItems();
            updateSaleTotals();
        }
        
        function updateSaleTotals() {
            const subtotal = currentSaleItems.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
            const afterDiscount = Math.max(0, subtotal - discount); // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù‚ÙŠÙ… Ø³Ø§Ù„Ø¨Ø©
            const applyTax = document.getElementById('applySaleTax').checked;
            const tax = applyTax ? afterDiscount * 0.15 : 0;
            const total = afterDiscount + tax;
            const paidAmount = parseFloat(document.getElementById('salePaidAmount').value) || 0;
            const remainingAmount = total - paidAmount;

            document.getElementById('saleSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('saleAfterDiscount').textContent = afterDiscount.toFixed(2);
            document.getElementById('saleTax').textContent = tax.toFixed(2);
            document.getElementById('saleTotal').textContent = total.toFixed(2);
            
            const remainingEl = document.getElementById('saleRemainingAmount');
            remainingEl.textContent = remainingAmount.toFixed(2);
            remainingEl.className = remainingAmount <= 0 ? 'remaining-paid' : 'remaining-unpaid';
        }
        
        async function newSale() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            const confirmed = await confirmCancelEdit('#sales');
            if (!confirmed) return;
            
            currentSaleItems = [];
            editingSaleId = null;
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('saleCustomer').value = '';
            document.getElementById('saleCustomerName').value = '';
            document.getElementById('saleCustomerCode').value = '';
            document.getElementById('saleCustomerPhone').value = '';
            document.getElementById('saleCustomerAddress').value = '';
            document.getElementById('saleNotes').value = '';
            document.getElementById('saleDiscount').value = '';
            document.getElementById('salePaidAmount').value = '';
            document.getElementById('salePaymentMethod').value = 'cash';
            generateSaleCode();
            document.getElementById('saveSaleBtn').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            renderSaleItems();
            updateSaleTotals();
            renderSalesList();
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            removeEditMode('#sales', '#sales h2', 'ğŸ§¾ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatSales" class="stat-mini-number">0</span></span>');
        }

        async function saveSale() {
            const date = document.getElementById('saleDate').value;
            const customerId = parseInt(document.getElementById('saleCustomer').value);
            const branchId = document.getElementById('saleBranch').value ? parseInt(document.getElementById('saleBranch').value) : null;
            const notes = document.getElementById('saleNotes').value;
            const customerAddress = document.getElementById('saleCustomerAddress').value;
            const paidAmount = parseFloat(document.getElementById('salePaidAmount').value) || 0;
            const paymentMethod = document.getElementById('salePaymentMethod').value;
            const taxApplied = document.getElementById('applySaleTax').checked;

            if (!date || !customerId || currentSaleItems.length === 0) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù Ù„Ù„ÙØ§ØªÙˆØ±Ø©', 'warning');
                return;
            }
            
            const subtotal = currentSaleItems.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
            const afterDiscount = Math.max(0, subtotal - discount);
            const tax = taxApplied ? afterDiscount * 0.15 : 0;
            const total = afterDiscount + tax;
            const remainingAmount = total - paidAmount;

            if (editingSaleId) {
                const saleIndex = sales.findIndex(s => s.id === editingSaleId);
                if (saleIndex > -1) {
                    const originalSale = sales[saleIndex];
                    
                    originalSale.items.forEach(si => {
                        const item = items.find(i => i.id === si.id);
                        if (item) item.stock += si.quantity;
                    });

                    const updatedSale = {
                        ...originalSale,
                        date,
                        customerId,
                        branchId,
                        notes,
                        customerAddress,
                        paidAmount,
                        paymentMethod,
                        items: [...currentSaleItems],
                        subtotal,
                        discount,
                        afterDiscount,
                        tax,
                        total,
                        remainingAmount,
                        taxApplied
                    };
                    
                    sales[saleIndex] = updatedSale;
                    
                    showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… SAL${originalSale.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                }
            } else {
                const newSaleData = { id: Date.now(), number: currentSaleNumber, date, customerId, branchId, notes, customerAddress, paidAmount, paymentMethod, items: [...currentSaleItems], subtotal, discount, afterDiscount, tax, total, remainingAmount, taxApplied };
                sales.push(newSaleData);
                currentSaleNumber++;
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… SAL${newSaleData.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                
                // ğŸ“’ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                await createSaleJournalEntry(newSaleData);
                
                // ğŸ“‹ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø°Ù† ØµØ±Ù Ù…Ø®Ø²Ù†ÙŠ
                await createStockPermission('out', newSaleData);
            }
            
            const success1 = saveToLocalStorage('sales', sales);
            
            // ğŸ“ Deduct stock using base units (quantity * unitFactor)
            currentSaleItems.forEach(si => {
                const item = items.find(i => i.id === si.id);
                if (item) {
                    const baseQuantity = si.quantity * (si.unitFactor || 1);
                    item.stock -= baseQuantity;
                }
            });
            const success2 = saveToLocalStorage('items', items);
            
            if (success1 && success2) {
                newSale();
                updateDashboard();
                renderItems();
                renderSalesManagement(); // ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                showSection('salesManagement'); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }
        
        function renderSalesList() {
            const tbody = document.getElementById('salesList');
            tbody.innerHTML = '';
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
    let filteredSales = [...sales];
    const searchText = document.getElementById('searchSales')?.value || '';
    
    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
    if (searchText) {
        filteredSales = filteredSales.filter(sale => {
            const customer = customers.find(c => c.id === sale.customerId);
            return (`sal${sale.number}`.toLowerCase().includes(searchText.toLowerCase()) || 
                    (customer && customer.name.toLowerCase().includes(searchText.toLowerCase())) || 
                    sale.date.includes(searchText));
        });
    }
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const dateFrom = document.getElementById('salesDateFrom')?.value;
    const dateTo = document.getElementById('salesDateTo')?.value;
    if (dateFrom) {
        filteredSales = filteredSales.filter(sale => new Date(sale.date) >= new Date(dateFrom));
    }
    if (dateTo) {
        filteredSales = filteredSales.filter(sale => new Date(sale.date) <= new Date(dateTo));
    }
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº
    const amountFrom = document.getElementById('salesAmountFrom')?.value;
    const amountTo = document.getElementById('salesAmountTo')?.value;
    if (amountFrom) {
        filteredSales = filteredSales.filter(sale => sale.total >= parseFloat(amountFrom));
    }
    if (amountTo) {
        filteredSales = filteredSales.filter(sale => sale.total <= parseFloat(amountTo));
    }
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
    const paymentMethodFilter = document.getElementById('salesPaymentMethodFilter')?.value;
    if (paymentMethodFilter) {
        filteredSales = filteredSales.filter(sale => (sale.paymentMethod || 'cash') === paymentMethodFilter);
    }
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
    const sortState = FilterSortHelper.currentSort['sales'];
    if (sortState) {
        filteredSales = FilterSortHelper.sortData(filteredSales, sortState.column, sortState.direction);
    }
    
    if (filteredSales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
        return;
    }
    
    filteredSales.forEach(sale => {
        const customer = customers.find(c => c.id === sale.customerId);
        const totalQty = sale.items.reduce((sum, item) => sum + item.quantity, 0);
        
        // ğŸ’° Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª
        const totalPaidFromPayments = getTotalPaid(sale.id, 'sale');
        const totalPaidDisplay = totalPaidFromPayments > 0 ? totalPaidFromPayments : (sale.paidAmount || 0);
        const remaining = sale.total - totalPaidDisplay;
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
        const remainingClass = remaining > 0.01 ? 'remaining-unpaid' : (remaining < -0.01 ? 'remaining-credit' : 'remaining-paid');
        const remainingText = remaining.toFixed(2);

        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
        const getPaymentMethodDisplay = (method) => {
            switch(method) {
                case 'cash': return 'ğŸ’° ÙƒØ§Ø´';
                case 'bank': return 'ğŸ¦ Ø¨Ù†Ùƒ';
                case 'mixed': return 'ğŸ”„ Ù…Ø®ØªÙ„Ø·';
                default: return 'ğŸ’° ÙƒØ§Ø´';
            }
        };
        
        // Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª
        const paymentsCount = salePayments.filter(p => p.invoiceId === sale.id).length;
        const paymentsInfo = paymentsCount > 0 ? ` (${paymentsCount} Ø¯ÙØ¹Ø©)` : '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td data-label="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©">SAL${sale.number.toString().padStart(3, '0')}</td>
            <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${sale.date}</td>
            <td data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„">${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td data-label="Ø§Ù„ÙƒÙ…ÙŠØ©">${totalQty}</td>
            <td data-label="Ø§Ù„Ø®ØµÙ…">${(sale.discount || 0).toFixed(2)}</td>
            <td data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ">${sale.total.toFixed(2)}</td>
            <td data-label="Ø§Ù„Ù…Ø¯ÙÙˆØ¹">${totalPaidDisplay.toFixed(2)}${paymentsInfo}</td>
            <td data-label="Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹">${getPaymentMethodDisplay(sale.paymentMethod)}</td>
            <td data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ" class="${remainingClass}">${remainingText}</td>
            <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                <div class="action-menu-container">
                    <button class="action-menu-btn" onclick="event.stopPropagation(); toggleActionMenu(event, ${sale.id})">â‹®</button>
                    <div class="action-menu-content" id="menu-${sale.id}">
                        ${remaining > 0.5 ? `<a href="#" onclick="event.preventDefault(); event.stopPropagation(); showAddPaymentModal(${sale.id}, 'sale');">ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</a>` : ''}
                        ${paymentsCount > 0 ? `<a href="#" onclick="event.preventDefault(); event.stopPropagation(); showPaymentsHistory(${sale.id}, 'sale');">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª</a>` : ''}
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); printSaleInvoice(${sale.id});">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</a>
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); sendWhatsAppInvoice(${sale.id});">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</a>
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); emailSaleInvoice(${sale.id});">ğŸ“§ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</a>
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); editSale(${sale.id});">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); deleteSale(${sale.id});" style="color: #dc3545;">ğŸ—‘ï¸ Ø­Ø°Ù</a>
                    </div>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
        function applySalesFilters() {
            renderSalesList();
        }
        
        function resetSalesFilters() {
            document.getElementById('salesDateFrom').value = '';
            document.getElementById('salesDateTo').value = '';
            document.getElementById('salesAmountFrom').value = '';
            document.getElementById('salesAmountTo').value = '';
            document.getElementById('salesPaymentMethodFilter').value = '';
            document.getElementById('searchSales').value = '';
            renderSalesList();
        }

        function searchSales() {
            renderSalesList();
        }

     function renderFilteredSales(filtered) {
    // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù… ØªØ¹Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø© - ØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ ÙÙŠ renderSalesList
    renderSalesList();
}

        // ===== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± =====
        function renderSalesManagement() {
            const tbody = document.getElementById('salesListManagement');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±</td></tr>';
                return;
            }
            
            sales.forEach(sale => {
                const customer = customers.find(c => c.id === sale.customerId);
                const paymentMethodText = sale.paymentMethod === 'cash' ? 'ğŸ’µ Ù†Ù‚Ø¯ÙŠ' : 
                                           sale.paymentMethod === 'bank' ? 'ğŸ¦ Ø¨Ù†Ùƒ' : 
                                           sale.paymentMethod === 'mixed' ? 'ğŸ”€ Ù…Ø®ØªÙ„Ø·' : 'ğŸ’µ Ù†Ù‚Ø¯ÙŠ';
                
                // ğŸ’° Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª
                const totalPaidFromPayments = getTotalPaid(sale.id, 'sale');
                const totalPaidDisplay = totalPaidFromPayments > 0 ? totalPaidFromPayments : (sale.paidAmount || 0);
                const remaining = sale.total - totalPaidDisplay;
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
                const remainingClass = remaining > 0.01 ? 'remaining-unpaid' : (remaining < -0.01 ? 'remaining-credit' : 'remaining-paid');
                
                // Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª
                const paymentsCount = salePayments.filter(p => p.invoiceId === sale.id).length;
                const paymentsInfo = paymentsCount > 0 ? ` (${paymentsCount} Ø¯ÙØ¹Ø©)` : '';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>SAL${sale.number.toString().padStart(3, '0')}</td>
                    <td>${sale.date}</td>
                    <td>${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                    <td>${sale.total.toFixed(2)}</td>
                    <td>${totalPaidDisplay.toFixed(2)}${paymentsInfo}</td>
                    <td class="${remainingClass}">${remaining.toFixed(2)}</td>
                    <td>${paymentMethodText}</td>
                    <td>
                        <div class="action-menu-container">
                            <button class="action-menu-btn" onclick="event.stopPropagation(); toggleActionMenu(event, ${sale.id})">â‹®</button>
                            <div class="action-menu-content" id="menu-${sale.id}">
                                ${remaining > 0.5 ? `<a href="#" onclick="event.preventDefault(); event.stopPropagation(); showAddPaymentModal(${sale.id}, 'sale');">ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</a>` : ''}
                                ${paymentsCount > 0 ? `<a href="#" onclick="event.preventDefault(); event.stopPropagation(); showPaymentsHistory(${sale.id}, 'sale');">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª</a>` : ''}
                                <a href="#" onclick="event.preventDefault(); event.stopPropagation(); printSaleInvoice(${sale.id});">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</a>
                                <a href="#" onclick="event.preventDefault(); event.stopPropagation(); sendWhatsAppInvoice(${sale.id});">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</a>
                                <a href="#" onclick="event.preventDefault(); event.stopPropagation(); emailSaleInvoice(${sale.id});">ğŸ“§ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</a>
                                <a href="#" onclick="event.preventDefault(); event.stopPropagation(); editSale(${sale.id});">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>
                                <a href="#" onclick="event.preventDefault(); event.stopPropagation(); deleteSale(${sale.id});" style="color: #dc3545;">ğŸ—‘ï¸ Ø­Ø°Ù</a>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function searchInSales() {
            const searchTerm = document.getElementById('searchSalesManagement').value.toLowerCase();
            const rows = document.querySelectorAll('#salesListManagement tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø¨Ø± Ù†Ø§ÙØ°Ø© Ù…Ù†ÙØµÙ„Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØ¹Ø§Ø±Ø¶ Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØµÙØ­Ø© Ù…Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        function openPrintWindowWithSection(sectionEl, title = 'Ø·Ø¨Ø§Ø¹Ø©') {
            try {
                const printWin = window.open('', '_blank');
                if (!printWin) {
                    showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'warning');
                    return false;
                }
                const html = `<!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>${title}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
                    <style>
                        html, body { height: 100%; }
                        body { font-family: 'Tajawal', Arial, Tahoma, sans-serif; margin: 0; padding: 20px; background: #ffffff; }
                        .invoice-print { display: block !important; background: white; padding: 30px; direction: rtl; max-width: 900px; margin: 0 auto; }
                        @media print { body { padding: 10px; } }
                    </style>
                </head>
                <body>${sectionEl.outerHTML}</body>
                </html>`;
                printWin.document.open();
                printWin.document.write(html);
                printWin.document.close();
                printWin.focus();
                setTimeout(() => {
                    try { printWin.print(); } catch (e) { console.error('Print error:', e); }
                    setTimeout(() => { try { printWin.close(); } catch(_) {} }, 300);
                }, 400);
                return true;
            } catch (e) {
                console.error('openPrintWindowWithSection error:', e);
                return false;
            }
        }

        function printSaleInvoice(saleId) {
            console.log('printSaleInvoice called with ID:', saleId);
            const sale = sales.find(s => s.id === saleId);
            if (!sale) {
                console.error('Sale not found:', saleId);
                showNotification('âŒ Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
                return;
            }
            
            console.log('Sale found:', sale);
            
            const customer = customers.find(c => c.id === sale.customerId);
            
            // ØªØ­Ù…ÙŠÙ„ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· ÙˆØ§Ø³Ù…Ù‡
            const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
            if (currentActivity) {
                const nameElement = document.getElementById('printSaleActivityName');
                if (nameElement) {
                    nameElement.textContent = currentActivity.name;
                } else {
                    console.error('Element printSaleActivityName not found');
                }
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† localStorage
                const storageKey = `activity_${currentActivity.id}_data`;
                const activityData = JSON.parse(localStorage.getItem(storageKey));
                const logoImg = document.getElementById('printSaleActivityLogo');
                
                if (logoImg) {
                    if (activityData && activityData.logo) {
                        logoImg.src = activityData.logo;
                        logoImg.style.display = 'block';
                    } else {
                        logoImg.style.display = 'none';
                    }
                } else {
                    console.error('Element printSaleActivityLogo not found');
                }
            }
            
            // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
            const dateElement = document.getElementById('printSaleDate');
            if (dateElement) dateElement.textContent = sale.date;
            
            const now = new Date();
            const timeElement = document.getElementById('printSaleTime');
            if (timeElement) timeElement.textContent = now.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});
            
            const numberElement = document.getElementById('printSaleNumber');
            if (numberElement) numberElement.textContent = 'SAL' + sale.number.toString().padStart(3, '0');
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
            const customerNameEl = document.getElementById('printCustomerName');
            if (customerNameEl) customerNameEl.textContent = customer ? customer.name : '-----';
            
            const customerCodeEl = document.getElementById('printCustomerCode');
            if (customerCodeEl) customerCodeEl.textContent = customer ? customer.code : '-----';
            
            const customerPhoneEl = document.getElementById('printCustomerPhone');
            if (customerPhoneEl) customerPhoneEl.textContent = customer ? customer.phone : '-----';
            
            const customerAddressEl = document.getElementById('printCustomerAddress');
            if (customerAddressEl) customerAddressEl.textContent = sale.customerAddress || '-----';
            
            // Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            const notesElement = document.getElementById('printSaleNotes');
            if (notesElement) {
                notesElement.textContent = sale.notes || '-----';
            }
            
            // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù - Ø¯Ù…Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯
            const itemsBody = document.getElementById('printSaleItems');
            if (!itemsBody) {
                console.error('Element printSaleItems not found');
                showNotification('âŒ Ø®Ø·Ø£', 'Ø¹Ù†ØµØ± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }
            
            itemsBody.innerHTML = '';
            
            // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ ÙˆØ§Ø­Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù
            const tr = document.createElement('tr');
            
            // Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ³Ù„Ø³Ù„
            let numbersHtml = '';
            let codesHtml = '';
            let namesHtml = '';
            let quantitiesHtml = '';
            let unitsHtml = '';
            let pricesHtml = '';
            let totalsHtml = '';
            
            sale.items.forEach((item, index) => {
                const itemData = items.find(i => i.id === item.id);
                const itemCode = itemData ? itemData.code : '---';
                
                const separator = index < sale.items.length - 1 ? '<hr style="margin: 4px 0; border: none; border-top: 1px solid #ccc;">' : '';
                
                numbersHtml += `${index + 1}${separator}`;
                codesHtml += `${itemCode}${separator}`;
                namesHtml += `${item.name}${separator}`;
                quantitiesHtml += `${item.quantity}${separator}`;
                unitsHtml += `${item.unitName || item.unit || 'Ù‚Ø·Ø¹Ø©'}${separator}`;
                pricesHtml += `${item.price.toFixed(2)}${separator}`;
                totalsHtml += `${item.total.toFixed(2)}${separator}`;
            });
            
            tr.innerHTML = `
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${numbersHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${codesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: right; vertical-align: top; border-radius: 6px;">${namesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${quantitiesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${unitsHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${pricesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; vertical-align: top; direction: ltr; font-weight: bold; border-radius: 6px;">${totalsHtml}</td>
            `;
            itemsBody.appendChild(tr);
            
            // Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
            const subtotalEl = document.getElementById('printSaleSubtotal');
            if (subtotalEl) subtotalEl.textContent = (sale.subtotal || 0).toFixed(2);
            
            // Ø§Ù„Ø®ØµÙ… ÙˆÙ…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
            const discount = sale.discount || 0;
            const afterDiscount = sale.afterDiscount || ((sale.subtotal || 0) - discount);
            
            const discountEl = document.getElementById('printSaleDiscount');
            if (discountEl) discountEl.textContent = discount.toFixed(2);
            
            const afterDiscountEl = document.getElementById('printSaleAfterDiscount');
            if (afterDiscountEl) afterDiscountEl.textContent = afterDiscount.toFixed(2);
            
            // Ø¥Ø®ÙØ§Ø¡ Ø£Ùˆ Ø¥Ø¸Ù‡Ø§Ø± ØµÙ Ø§Ù„Ø®ØµÙ…
            const discountRow = document.getElementById('printSaleDiscountRow');
            if (discount > 0) {
                if (discountRow) discountRow.style.display = 'grid';
            } else {
                if (discountRow) discountRow.style.display = 'none';
            }
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ù‚ÙŠÙ…Ø© ÙØ¹Ù„ÙŠØ© Ø£Ùˆ 0.00)
            const taxAmount = sale.includeTax ? (sale.tax || 0) : 0;
            const taxEl = document.getElementById('printSaleTax');
            if (taxEl) taxEl.textContent = taxAmount.toFixed(2);
            
            const taxRow = document.getElementById('printSaleTaxRow');
            if (taxRow) taxRow.style.display = 'grid'; // Ø¥Ø¸Ù‡Ø§Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹
            
            const totalEl = document.getElementById('printSaleTotal');
            if (totalEl) totalEl.textContent = (sale.total || 0).toFixed(2);
            
            const paidEl = document.getElementById('printSalePaid');
            if (paidEl) paidEl.textContent = (sale.paidAmount || 0).toFixed(2);
            
            // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
            const getPaymentMethodText = (method) => {
                switch(method) {
                    case 'cash': return 'ğŸ’° ÙƒØ§Ø´';
                    case 'bank': return 'ğŸ¦ Ø¨Ù†Ùƒ';
                    case 'mixed': return 'ğŸ”„ Ù…Ø®ØªÙ„Ø·';
                    default: return 'ğŸ’° ÙƒØ§Ø´';
                }
            };
            const paymentMethodEl = document.getElementById('printSalePaymentMethod');
            if (paymentMethodEl) paymentMethodEl.textContent = getPaymentMethodText(sale.paymentMethod);
            
            const remaining = (sale.remainingAmount !== undefined) ? sale.remainingAmount : ((sale.total || 0) - (sale.paidAmount || 0));
            const remainingEl = document.getElementById('printSaleRemaining');
            if (remainingEl) remainingEl.textContent = remaining.toFixed(2);
            
            const printSection = document.getElementById('saleInvoicePrint');
            if (!printSection) {
                console.error('Element saleInvoicePrint not found');
                showNotification('âŒ Ø®Ø·Ø£', 'Ù‚Ø³Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }
            
            // Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø¨Ø± Ù†Ø§ÙØ°Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ØªØ¬Ù†Ø¨ Ø£ÙŠ ØªØ¹Ø§Ø±Ø¶Ø§Øª CSS ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const opened = openPrintWindowWithSection(printSection, `ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ø±Ù‚Ù… ${numberElement ? numberElement.textContent : ''}`);
            if (!opened) {
                // ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†ÙØµÙ„Ø©ØŒ Ù†Ø¹ÙˆØ¯ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© ÙƒØ®Ø·Ø© Ø¨Ø¯ÙŠÙ„Ø©
                console.log('Fallback to same-window print...');
                printSection.style.display = 'block';
                setTimeout(() => {
                    window.print();
                    setTimeout(() => { printSection.style.display = 'none'; }, 150);
                }, 350);
            }
        }
        
        // Make printSaleInvoice globally accessible
        window.printSaleInvoice = printSaleInvoice;
        console.log('âœ… printSaleInvoice function defined and exposed globally');
        
        async function deleteSale(id) {
            const confirmed = await showConfirmDialog({
                title: 'ğŸ—‘ï¸ Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nâš ï¸ Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡Ø§',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡',
                icon: 'ğŸ“'
            });
            
            if (confirmed) {
                 const saleIndex = sales.findIndex(s => s.id === id);
                if (saleIndex > -1) {
                    const sale = sales[saleIndex];
                    
                    // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª
                    sale.items.forEach(si => {
                        const item = items.find(i => i.id === si.id);
                        if (item) item.stock += si.quantity;
                    });
                    saveToLocalStorage('items', items);
                    
                    // Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                    moveToTrash('sales', sale);
                    sales.splice(saleIndex, 1);
                    saveToLocalStorage('sales', sales);
                    
                    renderSalesList();
                    renderSalesManagement(); // ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                    updateDashboard();
                    renderItems();
                    showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                }
            }
        }
        
        function editSale(id) {
            const sale = sales.find(s => s.id === id);
            if (!sale) return;
            
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ ØªØµÙÙŠØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            showSection('sales');
            
            editingSaleId = id;
            currentSaleItems = JSON.parse(JSON.stringify(sale.items));
            
            document.getElementById('saleDate').value = sale.date;
            document.getElementById('saleCustomer').value = sale.customerId;
            
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
            updateCustomerFields();
            
            document.getElementById('saleCustomerAddress').value = sale.customerAddress || '';
            document.getElementById('saleNotes').value = sale.notes;
            document.getElementById('saleDiscount').value = sale.discount || 0;
            document.getElementById('salePaidAmount').value = sale.paidAmount || 0;
            document.getElementById('salePaymentMethod').value = sale.paymentMethod || 'cash';
            document.getElementById('saleCode').value = `ØªØ¹Ø¯ÙŠÙ„ SAL${sale.number.toString().padStart(3, '0')}`;
            document.getElementById('saveSaleBtn').textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            
            document.getElementById('applySaleTax').checked = sale.taxApplied ?? true;
            
            renderSaleItems();
            updateSaleTotals();
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            const customerName = customers.find(c => c.id === sale.customerId)?.name || 'Ø§Ù„Ø¹Ù…ÙŠÙ„';
            applyEditMode('#sales', 'saleCustomer', '#sales h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${customerName}`);
        }

        // Expose functions to window
        window.deleteSale = deleteSale;
        window.editSale = editSale;

        // ===== ğŸ’° Payment System Functions - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª =====
        
        // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
        function showAddPaymentModal(invoiceId, type = 'sale') {
            const invoice = type === 'sale' ? sales.find(s => s.id === invoiceId) : purchases.find(p => p.id === invoiceId);
            if (!invoice) {
                showNotification('âŒ Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
                return;
            }
            
            const payments = type === 'sale' ? 
                salePayments.filter(p => p.invoiceId === invoiceId) : 
                purchasePayments.filter(p => p.invoiceId === invoiceId);
            
            const paymentsTotal = payments.reduce((sum, p) => sum + p.amount, 0);
            const originalPaid = invoice.paidAmount || 0;
            const totalPaid = paymentsTotal + originalPaid;
            const remaining = invoice.total - totalPaid;
            
            if (remaining <= 0) {
                showNotification('â„¹ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ØªÙ… Ø³Ø¯Ø§Ø¯ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„', 'info');
                return;
            }
            
            const entityName = type === 'sale' ? 
                customers.find(c => c.id === invoice.customerId)?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' :
                suppliers.find(s => s.id === invoice.supplierId)?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            
            const invoiceNumber = type === 'sale' ? 
                `SAL${invoice.number.toString().padStart(3, '0')}` :
                `PUR${invoice.number.toString().padStart(3, '0')}`;
            
            const modalHtml = `
                <div id="payment-modal" class="modal-overlay" onclick="closePaymentModal(event)">
                    <div class="modal-content payment-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                            <button class="modal-close-btn" onclick="closePaymentModal()">âœ–</button>
                        </div>
                        <div class="modal-body">
                            <div class="payment-info-card">
                                <p><strong>Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${invoiceNumber}</p>
                                <p><strong>${type === 'sale' ? 'Ø§Ù„Ø¹Ù…ÙŠÙ„' : 'Ø§Ù„Ù…ÙˆØ±Ø¯'}:</strong> ${entityName}</p>
                                <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${invoice.total.toFixed(2)} Ø±.Ø³</p>
                                <p><strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø³Ø§Ø¨Ù‚Ø§Ù‹:</strong> ${totalPaid.toFixed(2)} Ø±.Ø³</p>
                                <p class="remaining-amount"><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${remaining.toFixed(2)} Ø±.Ø³</p>
                            </div>
                            <div class="form-grid grid-2" style="margin-top: 20px;">
                                <div>
                                    <label for="paymentAmount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ *</label>
                                    <input type="number" id="paymentAmount" placeholder="0.00" min="0" max="${remaining}" step="0.01" required>
                                </div>
                                <div>
                                    <label for="paymentMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ *</label>
                                    <select id="paymentMethod" required>
                                        <option value="cash">ğŸ’° ÙƒØ§Ø´</option>
                                        <option value="bank">ğŸ¦ Ø¨Ù†Ùƒ</option>
                                        <option value="check">ğŸ“ Ø´ÙŠÙƒ</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="paymentDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹ *</label>
                                    <input type="date" id="paymentDate" required>
                                </div>
                                <div>
                                    <label for="paymentReference">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</label>
                                    <input type="text" id="paymentReference" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ/Ø§Ù„Ø­ÙˆØ§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <label for="paymentNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea id="paymentNotes" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-primary" onclick="savePayment(${invoiceId}, '${type}')">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</button>
                            <button class="btn-secondary" onclick="closePaymentModal()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentAmount').focus();
        }
        window.showAddPaymentModal = showAddPaymentModal;
        
        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹Ø©
        function closePaymentModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('payment-modal');
            if (modal) modal.remove();
        }
        window.closePaymentModal = closePaymentModal;
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù„Ù„Ø¯ÙØ¹Ø©
        function createPaymentJournalEntry(payment, invoice, type) {
            const accountCode = payment.method === 'cash' ? '1111' : '1121';
            const accountName = payment.method === 'cash' ? 'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ' : 'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ';
            
            if (type === 'sale') {
                // Ù‚ÙŠØ¯ Ø¯ÙØ¹Ø© Ù…Ø¨ÙŠØ¹Ø§Øª: Ù…Ù† Ø­/Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø£Ùˆ Ø§Ù„Ø¨Ù†Ùƒ Ø¥Ù„Ù‰ Ø­/Ø§Ù„Ù…Ø¯ÙŠÙ†ÙˆÙ†
                const entry = {
                    id: Date.now(),
                    date: payment.date,
                    description: `Ø¯ÙØ¹Ø© Ù…Ù† ${invoice.customerName || 'Ø¹Ù…ÙŠÙ„'} - ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… SAL${invoice.number.toString().padStart(3, '0')}`,
                    reference: `PAY-${payment.id}`,
                    referenceType: 'salePayment',
                    referenceId: payment.id,
                    entries: [
                        {
                            accountCode: accountCode,
                            accountName: accountName,
                            debit: payment.amount,
                            credit: 0
                        },
                        {
                            accountCode: '1131',
                            accountName: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø¹Ø§Ù…)',
                            debit: 0,
                            credit: payment.amount
                        }
                    ]
                };
                journalEntries.push(entry);
            } else {
                // Ù‚ÙŠØ¯ Ø¯ÙØ¹Ø© Ù…Ø´ØªØ±ÙŠØ§Øª: Ù…Ù† Ø­/Ø§Ù„Ø¯Ø§Ø¦Ù†ÙˆÙ† Ø¥Ù„Ù‰ Ø­/Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø£Ùˆ Ø§Ù„Ø¨Ù†Ùƒ
                const entry = {
                    id: Date.now(),
                    date: payment.date,
                    description: `Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ ${invoice.supplierName || 'Ù…ÙˆØ±Ø¯'} - ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… PUR${invoice.number.toString().padStart(3, '0')}`,
                    reference: `PAY-${payment.id}`,
                    referenceType: 'purchasePayment',
                    referenceId: payment.id,
                    entries: [
                        {
                            accountCode: '2111',
                            accountName: 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Ø¹Ø§Ù…)',
                            debit: payment.amount,
                            credit: 0
                        },
                        {
                            accountCode: accountCode,
                            accountName: accountName,
                            debit: 0,
                            credit: payment.amount
                        }
                    ]
                };
                journalEntries.push(entry);
            }
            
            saveToLocalStorage('journalEntries', journalEntries);
        }
        
        // Ø­ÙØ¸ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
        async function savePayment(invoiceId, type) {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const method = document.getElementById('paymentMethod').value;
            const date = document.getElementById('paymentDate').value;
            const reference = document.getElementById('paymentReference').value;
            const notes = document.getElementById('paymentNotes').value;
            
            if (!amount || amount <= 0 || !method || !date) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning');
                return;
            }
            
            const invoice = type === 'sale' ? sales.find(s => s.id === invoiceId) : purchases.find(p => p.id === invoiceId);
            const payments = type === 'sale' ? 
                salePayments.filter(p => p.invoiceId === invoiceId) : 
                purchasePayments.filter(p => p.invoiceId === invoiceId);
            
            const paymentsTotal = payments.reduce((sum, p) => sum + p.amount, 0);
            const originalPaid = invoice.paidAmount || 0;
            const totalPaid = paymentsTotal + originalPaid;
            const remaining = invoice.total - totalPaid;
            
            if (amount > remaining) {
                showNotification('âš ï¸ ØªØ­Ø°ÙŠØ±', `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø®Ù„ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (${remaining.toFixed(2)} Ø±.Ø³)`, 'warning');
                return;
            }
            
            const payment = {
                id: Date.now(),
                invoiceId,
                invoiceNumber: invoice.number,
                invoiceType: type,
                amount,
                method,
                date,
                reference,
                notes,
                createdAt: new Date().toISOString()
            };
            
            if (type === 'sale') {
                salePayments.push(payment);
                saveToLocalStorage('salePayments', salePayments);
            } else {
                purchasePayments.push(payment);
                saveToLocalStorage('purchasePayments', purchasePayments);
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù„Ù„Ø¯ÙØ¹Ø©
            createPaymentJournalEntry(payment, invoice, type);
            
            closePaymentModal();
            
            const invoiceNumber = type === 'sale' ? 
                `SAL${invoice.number.toString().padStart(3, '0')}` :
                `PUR${invoice.number.toString().padStart(3, '0')}`;
            
            showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„ÙØ§ØªÙˆØ±Ø© ${invoiceNumber}`, 'success');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            if (type === 'sale') {
                renderSalesList();
            } else {
                renderPurchasesList();
            }
            updateDashboard();
        }
        window.savePayment = savePayment;
        
        // Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª
        function showPaymentsHistory(invoiceId, type = 'sale') {
            const invoice = type === 'sale' ? sales.find(s => s.id === invoiceId) : purchases.find(p => p.id === invoiceId);
            if (!invoice) return;
            
            const payments = type === 'sale' ? 
                salePayments.filter(p => p.invoiceId === invoiceId) : 
                purchasePayments.filter(p => p.invoiceId === invoiceId);
            
            const entityName = type === 'sale' ? 
                customers.find(c => c.id === invoice.customerId)?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' :
                suppliers.find(s => s.id === invoice.supplierId)?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            
            const invoiceNumber = type === 'sale' ? 
                `SAL${invoice.number.toString().padStart(3, '0')}` :
                `PUR${invoice.number.toString().padStart(3, '0')}`;
            
            const paymentsTotal = payments.reduce((sum, p) => sum + p.amount, 0);
            const originalPaid = invoice.paidAmount || 0;
            const totalPaid = paymentsTotal + originalPaid;
            const remaining = invoice.total - totalPaid;
            
            const getPaymentMethodDisplay = (method) => {
                switch(method) {
                    case 'cash': return 'ğŸ’° ÙƒØ§Ø´';
                    case 'bank': return 'ğŸ¦ Ø¨Ù†Ùƒ';
                    case 'check': return 'ğŸ“ Ø´ÙŠÙƒ';
                    default: return method;
                }
            };
            
            let paymentsRows = '';
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¥Ù† ÙˆØ¬Ø¯Øª
            if (originalPaid > 0) {
                paymentsRows += `
                    <tr style="background-color: #e3f2fd;">
                        <td>0</td>
                        <td>${invoice.date}</td>
                        <td>${originalPaid.toFixed(2)}</td>
                        <td>${getPaymentMethodDisplay(invoice.paymentMethod || 'cash')}</td>
                        <td>Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</td>
                        <td style="text-align: center;">-</td>
                    </tr>
                `;
            }
            
            if (payments.length === 0 && originalPaid === 0) {
                paymentsRows = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
            } else {
                payments.sort((a, b) => new Date(a.date) - new Date(b.date));
                payments.forEach((payment, index) => {
                    paymentsRows += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${payment.date}</td>
                            <td>${payment.amount.toFixed(2)}</td>
                            <td>${getPaymentMethodDisplay(payment.method)}</td>
                            <td>${payment.reference || '-'}</td>
                            <td>
                                <button class="btn-danger" style="padding: 5px 10px; font-size: 0.85em;" onclick="deletePayment(${payment.id}, '${type}')">Ø­Ø°Ù</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            const modalHtml = `
                <div id="payments-history-modal" class="modal-overlay" onclick="closePaymentsHistoryModal(event)">
                    <div class="modal-content payments-history-modal" onclick="event.stopPropagation()" style="max-width: 900px;">
                        <div class="modal-header">
                            <h3>ğŸ“œ Ø³Ø¬Ù„ Ø¯ÙØ¹Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${invoiceNumber}</h3>
                            <button class="modal-close-btn" onclick="closePaymentsHistoryModal()">âœ–</button>
                        </div>
                        <div class="modal-body">
                            <div class="payment-summary-card">
                                <div class="summary-row">
                                    <span><strong>${type === 'sale' ? 'Ø§Ù„Ø¹Ù…ÙŠÙ„' : 'Ø§Ù„Ù…ÙˆØ±Ø¯'}:</strong></span>
                                    <span>${entityName}</span>
                                </div>
                                <div class="summary-row">
                                    <span><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong></span>
                                    <span>${invoice.total.toFixed(2)} Ø±.Ø³</span>
                                </div>
                                <div class="summary-row">
                                    <span><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong></span>
                                    <span style="color: var(--success-color); font-weight: bold;">${totalPaid.toFixed(2)} Ø±.Ø³</span>
                                </div>
                                <div class="summary-row" style="border-top: 2px solid #ddd; padding-top: 10px; margin-top: 10px;">
                                    <span><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong></span>
                                    <span style="color: ${remaining > 0 ? 'var(--accent-color)' : 'var(--success-color)'}; font-weight: bold; font-size: 1.2em;">
                                        ${remaining.toFixed(2)} Ø±.Ø³ ${remaining === 0 ? 'âœ…' : 'âš ï¸'}
                                    </span>
                                </div>
                            </div>
                            <table style="margin-top: 20px;">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                        <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                                        <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${paymentsRows}
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-footer">
                            ${remaining > 0 ? `<button class="btn-primary" onclick="closePaymentsHistoryModal(); showAddPaymentModal(${invoiceId}, '${type}')">ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>` : ''}
                            <button class="btn-secondary" onclick="closePaymentsHistoryModal()">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª
        function closePaymentsHistoryModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('payments-history-modal');
            if (modal) modal.remove();
        }
        window.showPaymentsHistory = showPaymentsHistory;
        window.closePaymentsHistoryModal = closePaymentsHistoryModal;
        
        // Ø­Ø°Ù Ø¯ÙØ¹Ø©
        async function deletePayment(paymentId, type) {
            const confirmed = await showConfirmDialog(
                'Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©',
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.',
                'warning'
            );
            
            if (!confirmed) return;
            
            if (type === 'sale') {
                const index = salePayments.findIndex(p => p.id === paymentId);
                if (index > -1) {
                    salePayments.splice(index, 1);
                    saveToLocalStorage('salePayments', salePayments);
                }
            } else {
                const index = purchasePayments.findIndex(p => p.id === paymentId);
                if (index > -1) {
                    purchasePayments.splice(index, 1);
                    saveToLocalStorage('purchasePayments', purchasePayments);
                }
            }
            
            closePaymentsHistoryModal();
            showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            
            if (type === 'sale') {
                renderSalesList();
            } else {
                renderPurchasesList();
            }
            updateDashboard();
        }
        window.deletePayment = deletePayment;
        
        // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„ÙØ§ØªÙˆØ±Ø© (Ù…Ù† Ø§Ù„Ø¯ÙØ¹Ø§Øª + Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø§Ù„Ø£ØµÙ„ÙŠ)
        function getTotalPaid(invoiceId, type = 'sale') {
            const invoice = type === 'sale' ? 
                sales.find(s => s.id === invoiceId) : 
                purchases.find(p => p.id === invoiceId);
            
            const payments = type === 'sale' ? 
                salePayments.filter(p => p.invoiceId === invoiceId) : 
                purchasePayments.filter(p => p.invoiceId === invoiceId);
            
            const paymentsTotal = payments.reduce((sum, p) => sum + p.amount, 0);
            const originalPaid = invoice ? (invoice.paidAmount || 0) : 0;
            
            return paymentsTotal + originalPaid;
        }

        // ===== Ø¯ÙˆØ§Ù„ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ =====
        
        // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (Ø§Ù„Ø£ÙˆÙ„ÙŠØ© + Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©)
        function getAllPayments() {
            const allPayments = [];
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù…Ù† Ø§Ù„ÙÙˆØ§ØªÙŠØ±
            sales.forEach(sale => {
                if (sale.paidAmount && sale.paidAmount > 0) {
                    allPayments.push({
                        id: `INI-${sale.id}`,
                        invoiceId: sale.id,
                        invoiceNumber: sale.number,
                        amount: sale.paidAmount,
                        method: sale.paymentMethod || 'cash',
                        date: sale.date,
                        type: 'initial',
                        reference: 'Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©',
                        notes: 'Ø¯ÙØ¹Ø© Ø£ÙˆÙ„ÙŠØ© Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
                        createdAt: sale.createdAt || sale.date
                    });
                }
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
            salePayments.forEach(payment => {
                allPayments.push({
                    ...payment,
                    type: 'additional'
                });
            });
            
            return allPayments;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
        function updatePaymentsStatistics() {
            const allPayments = getAllPayments();
            
            // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
            const totalAmount = allPayments.reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('totalPaymentsAmount').textContent = totalAmount.toFixed(2) + ' Ø±.Ø³';
            
            // Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª
            document.getElementById('totalPaymentsCount').textContent = allPayments.length;
            
            // Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹
            const partialInvoices = sales.filter(sale => {
                const totalPaid = getTotalPaid(sale.id, 'sale');
                const remaining = sale.total - totalPaid;
                return remaining > 0.01 && totalPaid > 0;
            });
            document.getElementById('partialPaymentsCount').textContent = partialInvoices.length;
            
            // Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
            const initialPayments = allPayments.filter(p => p.type === 'initial');
            document.getElementById('initialPaymentsCount').textContent = initialPayments.length;
        }
        
        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
        function renderCustomerPayments(paymentsToRender = null) {
            const tbody = document.getElementById('paymentsList');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙÙ…Ø±Ø±Ø© Ø£Ùˆ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
            const displayPayments = paymentsToRender || getAllPayments();
            
            if (displayPayments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                updatePaymentsStatistics();
                return;
            }
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
            const sortedPayments = [...displayPayments].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedPayments.forEach(payment => {
                const sale = sales.find(s => s.id === payment.invoiceId);
                const customer = sale ? customers.find(c => c.id === sale.customerId) : null;
                
                const customerName = customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                const invoiceNumber = sale ? `SAL${sale.number.toString().padStart(3, '0')}` : '-';
                
                const getPaymentMethodDisplay = (method) => {
                    switch(method) {
                        case 'cash': return 'ğŸ’° ÙƒØ§Ø´';
                        case 'bank': return 'ğŸ¦ Ø¨Ù†Ùƒ';
                        case 'check': return 'ğŸ“ Ø´ÙŠÙƒ';
                        default: return method;
                    }
                };
                
                const paymentTypeDisplay = payment.type === 'initial' ? 
                    '<span style="background: #e3f2fd; color: #1976d2; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">ğŸ”µ Ø£ÙˆÙ„ÙŠØ©</span>' :
                    '<span style="background: #fff3e0; color: #f57c00; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">ğŸŸ  Ø¥Ø¶Ø§ÙÙŠØ©</span>';
                
                // Format Transaction ID: show only last 6 characters with full ID in tooltip
                const fullId = payment.id.toString();
                const shortId = fullId.length > 6 ? '...' + fullId.slice(-6) : fullId;
                const transactionIdDisplay = fullId.length > 6 ? 
                    `<span class="transaction-id-wrapper">
                        <span class="transaction-id-short">${shortId}</span>
                        <span class="transaction-id-tooltip">${fullId}</span>
                    </span>` : fullId;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${transactionIdDisplay}</td>
                    <td>${paymentTypeDisplay}</td>
                    <td>${payment.date}</td>
                    <td>${customerName}</td>
                    <td>${invoiceNumber}</td>
                    <td style="font-weight: bold; color: var(--success-color);">${payment.amount.toFixed(2)} Ø±.Ø³</td>
                    <td>${getPaymentMethodDisplay(payment.method)}</td>
                    <td>
                        <div class="action-menu-container">
                            <button class="action-menu-btn" onclick="toggleActionMenu(this, 'payment-menu-${payment.id}', event)">â‹®</button>
                            <div id="payment-menu-${payment.id}" class="action-menu-content">
                                <a href="#" onclick="event.preventDefault(); event.stopPropagation(); viewPaymentDetails('${payment.id}', '${payment.type}');">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
                                <a href="#" onclick="printPaymentReceipt('${payment.id}'); return false;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</a>
                                ${payment.type === 'additional' ? `<a href="#" class="delete-action" onclick="event.preventDefault(); event.stopPropagation(); deletePaymentFromList(${payment.id});">ğŸ—‘ï¸ Ø­Ø°Ù</a>` : ''}
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            updatePaymentsStatistics();
        }
        
        // Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø© ÙÙŠ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        function searchCustomerPayments() {
            const searchCustomer = document.getElementById('paymentSearchCustomer').value.toLowerCase().trim();
            const searchTransactionId = document.getElementById('paymentSearchTransactionId').value.trim();
            const searchInvoiceId = document.getElementById('paymentSearchInvoiceId').value.trim();
            const paymentType = document.getElementById('paymentTypeFilter').value;
            const dateFrom = document.getElementById('paymentDateFrom').value;
            const dateTo = document.getElementById('paymentDateTo').value;
            const methodFilter = document.getElementById('paymentMethodFilter').value;
            
            let filteredPayments = getAllPayments();
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
            if (searchCustomer) {
                filteredPayments = filteredPayments.filter(payment => {
                    const sale = sales.find(s => s.id === payment.invoiceId);
                    if (!sale) return false;
                    const customer = customers.find(c => c.id === sale.customerId);
                    return customer && customer.name.toLowerCase().includes(searchCustomer);
                });
            }
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹
            if (searchTransactionId) {
                filteredPayments = filteredPayments.filter(payment => 
                    payment.id.toString().includes(searchTransactionId)
                );
            }
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            if (searchInvoiceId) {
                filteredPayments = filteredPayments.filter(payment => {
                    const sale = sales.find(s => s.id === payment.invoiceId);
                    if (!sale) return false;
                    const invoiceNumber = `SAL${sale.number.toString().padStart(3, '0')}`;
                    return invoiceNumber.includes(searchInvoiceId.toUpperCase()) || 
                           sale.number.toString().includes(searchInvoiceId);
                });
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©
            if (paymentType !== 'all') {
                filteredPayments = filteredPayments.filter(payment => payment.type === paymentType);
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            if (dateFrom) {
                filteredPayments = filteredPayments.filter(payment => 
                    new Date(payment.date) >= new Date(dateFrom)
                );
            }
            if (dateTo) {
                filteredPayments = filteredPayments.filter(payment => 
                    new Date(payment.date) <= new Date(dateTo)
                );
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
            if (methodFilter !== 'all') {
                filteredPayments = filteredPayments.filter(payment => payment.method === methodFilter);
            }
            
            renderCustomerPayments(filteredPayments);
            
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            const hasFilters = searchCustomer || searchTransactionId || searchInvoiceId || 
                             paymentType !== 'all' || dateFrom || dateTo || methodFilter !== 'all';
            
            if (hasFilters) {
                showNotification('ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«', `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${filteredPayments.length} Ø¯ÙØ¹Ø©`, 'info');
            }
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±
        function resetPaymentsFilters() {
            document.getElementById('paymentSearchCustomer').value = '';
            document.getElementById('paymentSearchTransactionId').value = '';
            document.getElementById('paymentSearchInvoiceId').value = '';
            document.getElementById('paymentTypeFilter').value = 'all';
            document.getElementById('paymentDateFrom').value = '';
            document.getElementById('paymentDateTo').value = '';
            document.getElementById('paymentMethodFilter').value = 'all';
            
            renderCustomerPayments();
            showNotification('ğŸ”„ ØªÙ… Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©', 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±', 'success');
        }
        
        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©
        function viewPaymentDetails(paymentId, paymentType) {
            const allPayments = getAllPayments();
            // Ù…Ù‚Ø§Ø±Ù†Ø© Ø°ÙƒÙŠØ© ØªØ¯Ø¹Ù… Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù…
            const payment = allPayments.find(p => p.id == paymentId || p.id.toString() === paymentId.toString());
            
            if (!payment) {
                console.error('Payment not found:', paymentId, 'Type:', paymentType);
                console.log('Available payments:', allPayments.map(p => ({id: p.id, type: p.type})));
                showNotification('âŒ Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹Ø©', 'error');
                return;
            }
            
            const sale = sales.find(s => s.id === payment.invoiceId);
            const customer = sale ? customers.find(c => c.id === sale.customerId) : null;
            
            const customerName = customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            const invoiceNumber = sale ? `SAL${sale.number.toString().padStart(3, '0')}` : '-';
            
            const getPaymentMethodDisplay = (method) => {
                switch(method) {
                    case 'cash': return 'ğŸ’° ÙƒØ§Ø´';
                    case 'bank': return 'ğŸ¦ Ø¨Ù†Ùƒ';
                    case 'check': return 'ğŸ“ Ø´ÙŠÙƒ';
                    default: return method;
                }
            };
            
            const detailsHtml = `
                <div id="payment-details-modal" class="modal-overlay" onclick="closePaymentDetailsModal(event)">
                    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©</h3>
                            <button class="modal-close-btn" onclick="closePaymentDetailsModal()">âœ–</button>
                        </div>
                        <div class="modal-body">
                            <div class="payment-details-card">
                                <div class="detail-row">
                                    <span><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</strong></span>
                                    <span>${payment.id}</span>
                                </div>
                                <div class="detail-row">
                                    <span><strong>Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©:</strong></span>
                                    <span>${payment.type === 'initial' ? 'ğŸ”µ Ø¯ÙØ¹Ø© Ø£ÙˆÙ„ÙŠØ©' : 'ğŸŸ  Ø¯ÙØ¹Ø© Ø¥Ø¶Ø§ÙÙŠØ©'}</span>
                                </div>
                                <div class="detail-row">
                                    <span><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong></span>
                                    <span>${payment.date}</span>
                                </div>
                                <div class="detail-row">
                                    <span><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong></span>
                                    <span>${customerName}</span>
                                </div>
                                <div class="detail-row">
                                    <span><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong></span>
                                    <span>${invoiceNumber}</span>
                                </div>
                                <div class="detail-row">
                                    <span><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong></span>
                                    <span style="color: var(--success-color); font-weight: bold; font-size: 1.2em;">${payment.amount.toFixed(2)} Ø±.Ø³</span>
                                </div>
                                <div class="detail-row">
                                    <span><strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong></span>
                                    <span>${getPaymentMethodDisplay(payment.method)}</span>
                                </div>
                                ${payment.reference ? `
                                <div class="detail-row">
                                    <span><strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹:</strong></span>
                                    <span>${payment.reference}</span>
                                </div>
                                ` : ''}
                                ${payment.notes ? `
                                <div class="detail-row">
                                    <span><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong></span>
                                    <span>${payment.notes}</span>
                                </div>
                                ` : ''}
                                <div class="detail-row" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #ddd;">
                                    <span><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong></span>
                                    <span style="font-size: 0.9em; color: #666;">${new Date(payment.createdAt).toLocaleString('ar-SA')}</span>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            ${sale ? `<button class="btn-info" onclick="closePaymentDetailsModal(); showPaymentsHistory(${payment.invoiceId}, 'sale')">ğŸ“œ Ø³Ø¬Ù„ Ø¯ÙØ¹Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>` : ''}
                            <button class="btn-secondary" onclick="closePaymentDetailsModal()">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', detailsHtml);
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©
        function closePaymentDetailsModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('payment-details-modal');
            if (modal) modal.remove();
        }
        
        // Ø·Ø¨Ø§Ø¹Ø© Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ Ù„Ù„Ø¯ÙØ¹Ø©
        function printPaymentReceipt(paymentId) {
            const allPayments = getAllPayments();
            const payment = allPayments.find(p => p.id == paymentId || p.id.toString() === paymentId.toString());
            
            if (!payment) {
                showNotification('âŒ Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹Ø©', 'error');
                return;
            }
            
            const sale = sales.find(s => s.id === payment.invoiceId);
            const customer = sale ? customers.find(c => c.id === sale.customerId) : null;
            
            const customerName = customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            const invoiceNumber = sale ? `SAL${sale.number.toString().padStart(3, '0')}` : '-';
            
            const getPaymentMethodDisplay = (method) => {
                switch(method) {
                    case 'cash': return 'ÙƒØ§Ø´';
                    case 'bank': return 'Ø¨Ù†Ùƒ';
                    case 'check': return 'Ø´ÙŠÙƒ';
                    default: return method;
                }
            };
            
            // Get company name from settings
            const activityName = activities.find(a => a.id === currentActivityId)?.name || 'Ø§Ù„Ù…Ù†Ø´Ø£Ø©';
            
            const receiptHTML = `
<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ - ${payment.id}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 40px;
            background: white;
        }
        .receipt-container {
            max-width: 800px;
            margin: 0 auto;
            border: 3px solid #2c5aa0;
            padding: 40px;
            background: white;
        }
        .receipt-header {
            text-align: center;
            border-bottom: 3px solid #2c5aa0;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .company-name {
            font-size: 28px;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 10px;
        }
        .receipt-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-top: 10px;
        }
        .receipt-body {
            margin: 30px 0;
        }
        .receipt-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            font-size: 16px;
        }
        .receipt-row:nth-child(even) {
            background-color: #f9f9f9;
        }
        .receipt-label {
            font-weight: bold;
            color: #555;
            min-width: 150px;
        }
        .receipt-value {
            color: #333;
            text-align: left;
            flex: 1;
        }
        .amount-row {
            background-color: #e3f2fd !important;
            border: 2px solid #2c5aa0;
            margin: 20px 0;
        }
        .amount-row .receipt-value {
            font-size: 22px;
            font-weight: bold;
            color: #2c5aa0;
        }
        .receipt-footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 2px solid #ddd;
        }
        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }
        .signature-box {
            text-align: center;
            width: 200px;
        }
        .signature-line {
            border-top: 2px solid #333;
            margin-top: 50px;
            padding-top: 10px;
            font-weight: bold;
            color: #555;
        }
        @media print {
            body {
                padding: 0;
            }
            .receipt-container {
                border: none;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="receipt-container">
        <div class="receipt-header">
            <div class="company-name">${activityName}</div>
            <div class="receipt-title">Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</div>
            <div style="margin-top: 10px; color: #666;">PAYMENT RECEIPT</div>
        </div>
        
        <div class="receipt-body">
            <div class="receipt-row">
                <span class="receipt-label">Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯:</span>
                <span class="receipt-value">${payment.id}</span>
            </div>
            <div class="receipt-row">
                <span class="receipt-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                <span class="receipt-value">${payment.date}</span>
            </div>
            <div class="receipt-row">
                <span class="receipt-label">Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù† Ø§Ù„Ø³ÙŠØ¯/Ø©:</span>
                <span class="receipt-value">${customerName}</span>
            </div>
            <div class="receipt-row amount-row">
                <span class="receipt-label">Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡:</span>
                <span class="receipt-value">${payment.amount.toFixed(2)} Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</span>
            </div>
            <div class="receipt-row">
                <span class="receipt-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</span>
                <span class="receipt-value">${getPaymentMethodDisplay(payment.method)}</span>
            </div>
            <div class="receipt-row">
                <span class="receipt-label">Ø¹Ù† ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…:</span>
                <span class="receipt-value">${invoiceNumber}</span>
            </div>
            ${payment.reference ? `
            <div class="receipt-row">
                <span class="receipt-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹:</span>
                <span class="receipt-value">${payment.reference}</span>
            </div>
            ` : ''}
            ${payment.notes ? `
            <div class="receipt-row">
                <span class="receipt-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span>
                <span class="receipt-value">${payment.notes}</span>
            </div>
            ` : ''}
        </div>
        
        <div class="receipt-footer">
            <div class="signature-section">
                <div class="signature-box">
                    <div class="signature-line">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
                </div>
                <div class="signature-box">
                    <div class="signature-line">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        window.onload = function() {
            window.print();
        };
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£Ùˆ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
        window.onafterprint = function() {
            window.close();
        };
        
        // Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© - Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ù‚ØµÙŠØ±Ø©
        setTimeout(function() {
            if (window.matchMedia) {
                const mediaQueryList = window.matchMedia('print');
                mediaQueryList.addListener(function(mql) {
                    if (!mql.matches) {
                        window.close();
                    }
                });
            }
        }, 100);
    <\/script>
</body>
</html>`;
            
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(receiptHTML);
            printWindow.document.close();
        }
        
        // Ø­Ø°Ù Ø¯ÙØ¹Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        async function deletePaymentFromList(paymentId) {
            const payment = salePayments.find(p => p.id === paymentId);
            if (!payment) return;
            
            const sale = sales.find(s => s.id === payment.invoiceId);
            const invoiceNumber = sale ? `SAL${sale.number.toString().padStart(3, '0')}` : 'Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            
            const confirmed = await showConfirmDialog({
                title: 'ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©',
                message: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ\n\nØ§Ù„Ù…Ø¨Ù„Øº: ${payment.amount.toFixed(2)} Ø±.Ø³\nØ§Ù„ÙØ§ØªÙˆØ±Ø©: ${invoiceNumber}\n\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`,
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            
            if (!confirmed) return;
            
            const index = salePayments.findIndex(p => p.id === paymentId);
            if (index > -1) {
                salePayments.splice(index, 1);
                saveToLocalStorage('salePayments', salePayments);
                
                renderCustomerPayments();
                renderSalesList();
                updateDashboard();
                
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        }

        // ===== Ø¯ÙˆØ§Ù„ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† =====
        
        // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Ø§Ù„Ø£ÙˆÙ„ÙŠØ© + Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©)
        function getAllSupplierPayments() {
            const allPayments = [];
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù…Ù† ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            purchases.forEach(purchase => {
                if (purchase.paidAmount && purchase.paidAmount > 0) {
                    allPayments.push({
                        id: `INI-${purchase.id}`,
                        invoiceId: purchase.id,
                        invoiceNumber: purchase.number,
                        amount: purchase.paidAmount,
                        method: purchase.paymentMethod || 'cash',
                        date: purchase.date,
                        type: 'initial',
                        reference: 'Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©',
                        notes: 'Ø¯ÙØ¹Ø© Ø£ÙˆÙ„ÙŠØ© Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
                        createdAt: purchase.createdAt || purchase.date
                    });
                }
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
            purchasePayments.forEach(payment => {
                allPayments.push({
                    ...payment,
                    type: 'additional'
                });
            });
            
            return allPayments;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        function updateSupplierPaymentsStatistics() {
            const allPayments = getAllSupplierPayments();
            
            // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
            const totalAmount = allPayments.reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('totalSupplierPaymentsAmount').textContent = totalAmount.toFixed(2) + ' Ø±.Ø³';
            
            // Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª
            document.getElementById('totalSupplierPaymentsCount').textContent = allPayments.length;
            
            // Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹
            const partialInvoices = purchases.filter(purchase => {
                const totalPaid = getTotalPaid(purchase.id, 'purchase');
                const remaining = purchase.total - totalPaid;
                return remaining > 0.01 && totalPaid > 0;
            });
            document.getElementById('partialSupplierPaymentsCount').textContent = partialInvoices.length;
            
            // Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
            const initialPayments = allPayments.filter(p => p.type === 'initial');
            document.getElementById('initialSupplierPaymentsCount').textContent = initialPayments.length;
        }
        
        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        function renderSupplierPayments(paymentsToRender = null) {
            const tbody = document.getElementById('supplierPaymentsList');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙÙ…Ø±Ø±Ø© Ø£Ùˆ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
            const displayPayments = paymentsToRender || getAllSupplierPayments();
            
            if (displayPayments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                updateSupplierPaymentsStatistics();
                return;
            }
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
            const sortedPayments = [...displayPayments].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedPayments.forEach(payment => {
                const purchase = purchases.find(p => p.id === payment.invoiceId);
                const supplier = purchase ? suppliers.find(s => s.id === purchase.supplierId) : null;
                
                const supplierName = supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                const invoiceNumber = purchase ? `PUR${purchase.number.toString().padStart(3, '0')}` : '-';
                
                const getPaymentMethodDisplay = (method) => {
                    switch(method) {
                        case 'cash': return 'ğŸ’° ÙƒØ§Ø´';
                        case 'bank': return 'ğŸ¦ Ø¨Ù†Ùƒ';
                        case 'check': return 'ğŸ“ Ø´ÙŠÙƒ';
                        default: return method;
                    }
                };
                
                const paymentTypeDisplay = payment.type === 'initial' ? 
                    '<span style="background: #e3f2fd; color: #1976d2; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">ğŸ”µ Ø£ÙˆÙ„ÙŠØ©</span>' :
                    '<span style="background: #fff3e0; color: #f57c00; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">ğŸŸ  Ø¥Ø¶Ø§ÙÙŠØ©</span>';
                
                // Format Transaction ID: show only last 6 characters with full ID in tooltip
                const fullId = payment.id.toString();
                const shortId = fullId.length > 6 ? '...' + fullId.slice(-6) : fullId;
                const transactionIdDisplay = fullId.length > 6 ? 
                    `<span class="transaction-id-wrapper">
                        <span class="transaction-id-short">${shortId}</span>
                        <span class="transaction-id-tooltip">${fullId}</span>
                    </span>` : fullId;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${transactionIdDisplay}</td>
                    <td>${paymentTypeDisplay}</td>
                    <td>${payment.date}</td>
                    <td>${supplierName}</td>
                    <td>${invoiceNumber}</td>
                    <td style="font-weight: bold; color: var(--danger-color);">${payment.amount.toFixed(2)} Ø±.Ø³</td>
                    <td>${getPaymentMethodDisplay(payment.method)}</td>
                    <td>
                        <div class="action-menu-container">
                            <button class="action-menu-btn" onclick="toggleActionMenu(this, 'supplier-payment-menu-${payment.id}', event)">â‹®</button>
                            <div id="supplier-payment-menu-${payment.id}" class="action-menu-content">
                                <a href="#" onclick="event.preventDefault(); event.stopPropagation(); viewSupplierPaymentDetails('${payment.id}', '${payment.type}');">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
                                <a href="#" onclick="printPurchasePaymentVoucher('${payment.id}'); return false;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø³Ù†Ø¯ ØµØ±Ù</a>
                                ${payment.type === 'additional' ? `<a href="#" class="delete-action" onclick="event.preventDefault(); event.stopPropagation(); deleteSupplierPaymentFromList(${payment.id});">ğŸ—‘ï¸ Ø­Ø°Ù</a>` : ''}
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            updateSupplierPaymentsStatistics();
        }
        
        // Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø© ÙÙŠ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        function searchSupplierPayments() {
            const searchSupplier = document.getElementById('supplierPaymentSearchSupplier').value.toLowerCase().trim();
            const searchTransactionId = document.getElementById('supplierPaymentSearchTransactionId').value.trim();
            const searchInvoiceId = document.getElementById('supplierPaymentSearchInvoiceId').value.trim();
            const paymentType = document.getElementById('supplierPaymentTypeFilter').value;
            const dateFrom = document.getElementById('supplierPaymentDateFrom').value;
            const dateTo = document.getElementById('supplierPaymentDateTo').value;
            const methodFilter = document.getElementById('supplierPaymentMethodFilter').value;
            
            let filteredPayments = getAllSupplierPayments();
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯
            if (searchSupplier) {
                filteredPayments = filteredPayments.filter(payment => {
                    const purchase = purchases.find(p => p.id === payment.invoiceId);
                    if (!purchase) return false;
                    const supplier = suppliers.find(s => s.id === purchase.supplierId);
                    return supplier && supplier.name.toLowerCase().includes(searchSupplier);
                });
            }
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹
            if (searchTransactionId) {
                filteredPayments = filteredPayments.filter(payment => 
                    payment.id.toString().includes(searchTransactionId)
                );
            }
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            if (searchInvoiceId) {
                filteredPayments = filteredPayments.filter(payment => {
                    const purchase = purchases.find(p => p.id === payment.invoiceId);
                    if (!purchase) return false;
                    const invoiceNumber = `PUR${purchase.number.toString().padStart(3, '0')}`;
                    return invoiceNumber.includes(searchInvoiceId.toUpperCase()) || 
                           purchase.number.toString().includes(searchInvoiceId);
                });
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©
            if (paymentType !== 'all') {
                filteredPayments = filteredPayments.filter(payment => payment.type === paymentType);
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            if (dateFrom) {
                filteredPayments = filteredPayments.filter(payment => 
                    new Date(payment.date) >= new Date(dateFrom)
                );
            }
            if (dateTo) {
                filteredPayments = filteredPayments.filter(payment => 
                    new Date(payment.date) <= new Date(dateTo)
                );
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
            if (methodFilter !== 'all') {
                filteredPayments = filteredPayments.filter(payment => payment.method === methodFilter);
            }
            
            renderSupplierPayments(filteredPayments);
            
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            const hasFilters = searchSupplier || searchTransactionId || searchInvoiceId || 
                             paymentType !== 'all' || dateFrom || dateTo || methodFilter !== 'all';
            
            if (hasFilters) {
                showNotification('ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«', `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${filteredPayments.length} Ø¯ÙØ¹Ø©`, 'info');
            }
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙÙ„Ø§ØªØ± Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        function resetSupplierPaymentsFilters() {
            document.getElementById('supplierPaymentSearchSupplier').value = '';
            document.getElementById('supplierPaymentSearchTransactionId').value = '';
            document.getElementById('supplierPaymentSearchInvoiceId').value = '';
            document.getElementById('supplierPaymentTypeFilter').value = 'all';
            document.getElementById('supplierPaymentDateFrom').value = '';
            document.getElementById('supplierPaymentDateTo').value = '';
            document.getElementById('supplierPaymentMethodFilter').value = 'all';
            
            renderSupplierPayments();
            showNotification('ğŸ”„ ØªÙ… Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©', 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±', 'success');
        }
        
        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø¯ÙØ¹Ø© Ø§Ù„Ù…ÙˆØ±Ø¯
        function viewSupplierPaymentDetails(paymentId, paymentType) {
            const allPayments = getAllSupplierPayments();
            const payment = allPayments.find(p => p.id == paymentId || p.id.toString() === paymentId.toString());
            
            if (!payment) {
                console.error('Payment not found:', paymentId, 'Type:', paymentType);
                showNotification('âŒ Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹Ø©', 'error');
                return;
            }
            
            const purchase = purchases.find(p => p.id === payment.invoiceId);
            const supplier = purchase ? suppliers.find(s => s.id === purchase.supplierId) : null;
            
            const supplierName = supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            const invoiceNumber = purchase ? `PUR${purchase.number.toString().padStart(3, '0')}` : '-';
            
            const getPaymentMethodDisplay = (method) => {
                switch(method) {
                    case 'cash': return 'ğŸ’° ÙƒØ§Ø´';
                    case 'bank': return 'ğŸ¦ Ø¨Ù†Ùƒ';
                    case 'check': return 'ğŸ“ Ø´ÙŠÙƒ';
                    default: return method;
                }
            };
            
            const detailsHtml = `
                <div id="supplier-payment-details-modal" class="modal-overlay" onclick="closeSupplierPaymentDetailsModal(event)">
                    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©</h3>
                            <button class="modal-close-btn" onclick="closeSupplierPaymentDetailsModal()">âœ–</button>
                        </div>
                        <div class="modal-body">
                            <div class="payment-details-card">
                                <div class="detail-row">
                                    <span><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</strong></span>
                                    <span>${payment.id}</span>
                                </div>
                                <div class="detail-row">
                                    <span><strong>Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©:</strong></span>
                                    <span>${payment.type === 'initial' ? 'ğŸ”µ Ø¯ÙØ¹Ø© Ø£ÙˆÙ„ÙŠØ©' : 'ğŸŸ  Ø¯ÙØ¹Ø© Ø¥Ø¶Ø§ÙÙŠØ©'}</span>
                                </div>
                                <div class="detail-row">
                                    <span><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong></span>
                                    <span>${payment.date}</span>
                                </div>
                                <div class="detail-row">
                                    <span><strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong></span>
                                    <span>${supplierName}</span>
                                </div>
                                <div class="detail-row">
                                    <span><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong></span>
                                    <span>${invoiceNumber}</span>
                                </div>
                                <div class="detail-row">
                                    <span><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong></span>
                                    <span style="color: var(--danger-color); font-weight: bold; font-size: 1.2em;">${payment.amount.toFixed(2)} Ø±.Ø³</span>
                                </div>
                                <div class="detail-row">
                                    <span><strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong></span>
                                    <span>${getPaymentMethodDisplay(payment.method)}</span>
                                </div>
                                ${payment.reference ? `
                                <div class="detail-row">
                                    <span><strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹:</strong></span>
                                    <span>${payment.reference}</span>
                                </div>
                                ` : ''}
                                ${payment.notes ? `
                                <div class="detail-row">
                                    <span><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong></span>
                                    <span>${payment.notes}</span>
                                </div>
                                ` : ''}
                                <div class="detail-row" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #ddd;">
                                    <span><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong></span>
                                    <span style="font-size: 0.9em; color: #666;">${new Date(payment.createdAt).toLocaleString('ar-SA')}</span>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            ${purchase ? `<button class="btn-info" onclick="closeSupplierPaymentDetailsModal(); showPaymentsHistory(${payment.invoiceId}, 'purchase')">ğŸ“œ Ø³Ø¬Ù„ Ø¯ÙØ¹Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>` : ''}
                            <button class="btn-secondary" onclick="closeSupplierPaymentDetailsModal()">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', detailsHtml);
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø¯ÙØ¹Ø© Ø§Ù„Ù…ÙˆØ±Ø¯
        function closeSupplierPaymentDetailsModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('supplier-payment-details-modal');
            if (modal) modal.remove();
        }
        
        // Ø·Ø¨Ø§Ø¹Ø© Ø³Ù†Ø¯ ØµØ±Ù Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…ÙˆØ±Ø¯
        function printPurchasePaymentVoucher(paymentId) {
            const allPayments = getAllSupplierPayments();
            const payment = allPayments.find(p => p.id == paymentId || p.id.toString() === paymentId.toString());
            
            if (!payment) {
                showNotification('âŒ Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹Ø©', 'error');
                return;
            }
            
            const purchase = purchases.find(p => p.id === payment.invoiceId);
            const supplier = purchase ? suppliers.find(s => s.id === purchase.supplierId) : null;
            
            const supplierName = supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            const invoiceNumber = purchase ? `PUR${purchase.number.toString().padStart(3, '0')}` : '-';
            
            const getPaymentMethodDisplay = (method) => {
                switch(method) {
                    case 'cash': return 'Ù†Ù‚Ø¯Ø§Ù‹';
                    case 'bank': return 'Ø¨Ù†Ùƒ';
                    case 'check': return 'Ø´ÙŠÙƒ';
                    default: return method;
                }
            };
            
            // Get company name from settings
            const activityName = activities.find(a => a.id === currentActivityId)?.name || 'Ø§Ù„Ù…Ù†Ø´Ø£Ø©';
            
            const voucherHTML = `
<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø³Ù†Ø¯ ØµØ±Ù - ${payment.id}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 40px;
            background: white;
        }
        .voucher-container {
            max-width: 800px;
            margin: 0 auto;
            border: 3px solid #2c5aa0;
            padding: 40px;
            background: white;
        }
        .voucher-header {
            text-align: center;
            border-bottom: 3px solid #2c5aa0;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .company-name {
            font-size: 28px;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 10px;
        }
        .voucher-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-top: 10px;
        }
        .voucher-body {
            margin: 30px 0;
        }
        .voucher-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            font-size: 16px;
        }
        .voucher-row:nth-child(even) {
            background-color: #f9f9f9;
        }
        .voucher-label {
            font-weight: bold;
            color: #555;
            min-width: 150px;
        }
        .voucher-value {
            color: #333;
            text-align: left;
            flex: 1;
        }
        .amount-row {
            background-color: #e3f2fd !important;
            border: 2px solid #2c5aa0;
            margin: 20px 0;
        }
        .amount-row .voucher-value {
            font-size: 22px;
            font-weight: bold;
            color: #2c5aa0;
        }
        .voucher-footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 2px solid #ddd;
        }
        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }
        .signature-box {
            text-align: center;
            width: 200px;
        }
        .signature-line {
            border-top: 2px solid #333;
            margin-top: 50px;
            padding-top: 10px;
            font-weight: bold;
            color: #555;
        }
        @media print {
            body {
                padding: 0;
            }
            .voucher-container {
                border: none;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="voucher-container">
        <div class="voucher-header">
            <div class="company-name">${activityName}</div>
            <div class="voucher-title">Ø³Ù†Ø¯ ØµØ±Ù</div>
            <div style="margin-top: 10px; color: #666;">PAYMENT VOUCHER</div>
        </div>
        
        <div class="voucher-body">
            <div class="voucher-row">
                <span class="voucher-label">Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯:</span>
                <span class="voucher-value">${payment.id}</span>
            </div>
            <div class="voucher-row">
                <span class="voucher-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                <span class="voucher-value">${payment.date}</span>
            </div>
            <div class="voucher-row">
                <span class="voucher-label">Ø¯ÙØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ¯/Ø©:</span>
                <span class="voucher-value">${supplierName}</span>
            </div>
            <div class="voucher-row amount-row">
                <span class="voucher-label">Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡:</span>
                <span class="voucher-value">${payment.amount.toFixed(2)} Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</span>
            </div>
            <div class="voucher-row">
                <span class="voucher-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</span>
                <span class="voucher-value">${getPaymentMethodDisplay(payment.method)}</span>
            </div>
            <div class="voucher-row">
                <span class="voucher-label">Ù…Ù‚Ø§Ø¨Ù„ ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…:</span>
                <span class="voucher-value">${invoiceNumber}</span>
            </div>
            ${payment.reference ? `
            <div class="voucher-row">
                <span class="voucher-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹/Ø§Ù„Ø´ÙŠÙƒ:</span>
                <span class="voucher-value">${payment.reference}</span>
            </div>
            ` : ''}
            ${payment.notes ? `
            <div class="voucher-row">
                <span class="voucher-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span>
                <span class="voucher-value">${payment.notes}</span>
            </div>
            ` : ''}
        </div>
        
        <div class="voucher-footer">
            <div class="signature-section">
                <div class="signature-box">
                    <div class="signature-line">Ø§Ù„Ù…Ø¯ÙŠØ± / Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</div>
                </div>
                <div class="signature-box">
                    <div class="signature-line">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        window.onload = function() {
            window.print();
        };
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£Ùˆ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
        window.onafterprint = function() {
            window.close();
        };
        
        // Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© - Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ù‚ØµÙŠØ±Ø©
        setTimeout(function() {
            if (window.matchMedia) {
                const mediaQueryList = window.matchMedia('print');
                mediaQueryList.addListener(function(mql) {
                    if (!mql.matches) {
                        window.close();
                    }
                });
            }
        }, 100);
    <\/script>
</body>
</html>`;
            
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(voucherHTML);
            printWindow.document.close();
        }
        
        // Ø­Ø°Ù Ø¯ÙØ¹Ø© Ù…ÙˆØ±Ø¯ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        async function deleteSupplierPaymentFromList(paymentId) {
            const payment = purchasePayments.find(p => p.id === paymentId);
            if (!payment) return;
            
            const purchase = purchases.find(p => p.id === payment.invoiceId);
            const invoiceNumber = purchase ? `PUR${purchase.number.toString().padStart(3, '0')}` : 'Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            
            const confirmed = await showConfirmDialog({
                title: 'ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©',
                message: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ\n\nØ§Ù„Ù…Ø¨Ù„Øº: ${payment.amount.toFixed(2)} Ø±.Ø³\nØ§Ù„ÙØ§ØªÙˆØ±Ø©: ${invoiceNumber}\n\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`,
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            
            if (!confirmed) return;
            
            const index = purchasePayments.findIndex(p => p.id === paymentId);
            if (index > -1) {
                purchasePayments.splice(index, 1);
                saveToLocalStorage('purchasePayments', purchasePayments);
                
                renderSupplierPayments();
                renderPurchasesList();
                updateDashboard();
                
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        }

        // ===== Returns Functions =====
        function showReturnTab(type) {
            document.getElementById('salesReturnContent').classList.remove('active');
            document.getElementById('purchaseReturnContent').classList.remove('active');
            document.getElementById('salesReturnTabBtn').classList.remove('active');
            document.getElementById('purchasesReturnTabBtn').classList.remove('active');

            if (type === 'sales') {
                document.getElementById('salesReturnContent').classList.add('active');
                document.getElementById('salesReturnTabBtn').classList.add('active');
                newSaleReturn();
            } else {
                document.getElementById('purchaseReturnContent').classList.add('active');
                document.getElementById('purchasesReturnTabBtn').classList.add('active');
                newPurchaseReturn();
            }
        }
        
        function newSaleReturn() {
            activeSaleReturn = null;
            document.getElementById('salesReturnInvoiceSearch').value = '';
            document.getElementById('salesReturnInvoiceDetails').style.display = 'none';
            document.getElementById('salesReturnItemsContainer').style.display = 'none';
            document.getElementById('salesReturnItemsList').innerHTML = '';
            document.getElementById('salesReturnTotal').textContent = '0.00';
        }

        function findSaleForReturn() {
            const invoiceNumber = parseInt(document.getElementById('salesReturnInvoiceSearch').value);
            if (isNaN(invoiceNumber)) {
                showNotification('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ØµØ­ÙŠØ­', 'warning');
                return;
            }
            
            const sale = sales.find(s => s.number === invoiceNumber);
            if (!sale) {
                showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…', 'error');
                newSaleReturn();
                return;
            }

            activeSaleReturn = sale;
            const customer = customers.find(c => c.id === sale.customerId);
            
            const detailsDiv = document.getElementById('salesReturnInvoiceDetails');
            detailsDiv.innerHTML = `
                <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> SAL${sale.number.toString().padStart(3, '0')}</p>
                <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${sale.date}</p>
            `;
            detailsDiv.style.display = 'block';

            const itemsTbody = document.getElementById('salesReturnItemsList');
            itemsTbody.innerHTML = '';
            sale.items.forEach(item => {
                const tr = document.createElement('tr');
                tr.dataset.itemId = item.id;
                tr.dataset.price = item.price;
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td><input type="number" class="return-item-qty-input" min="0" max="${item.quantity}" value="0" oninput="updateSaleReturnTotal()"></td>
                `;
                itemsTbody.appendChild(tr);
            });
            
            document.getElementById('salesReturnItemsContainer').style.display = 'block';
            updateSaleReturnTotal();
        }

        function updateSaleReturnTotal() {
            let total = 0;
            document.querySelectorAll('#salesReturnItemsList tr').forEach(tr => {
                const price = parseFloat(tr.dataset.price);
                const qty = parseInt(tr.querySelector('input').value) || 0;
                total += price * qty;
            });
            document.getElementById('salesReturnTotal').textContent = total.toFixed(2);
        }

        async function saveSaleReturn() {
            if (!activeSaleReturn) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø«', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const returnedItems = [];
            let totalReturnValue = 0;
            document.querySelectorAll('#salesReturnItemsList tr').forEach(tr => {
                const qty = parseInt(tr.querySelector('input').value) || 0;
                if (qty > 0) {
                    const originalItem = activeSaleReturn.items.find(i => i.id == tr.dataset.itemId);
                    returnedItems.push({
                        id: originalItem.id,
                        name: originalItem.name,
                        price: originalItem.price,
                        quantity: qty
                    });
                    totalReturnValue += originalItem.price * qty;
                }
            });

            if (returnedItems.length === 0) {
                showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ ÙƒÙ…ÙŠØ§Øª Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹', 'warning');
                return;
            }

            returnedItems.forEach(returnedItem => {
                const itemInStock = items.find(i => i.id === returnedItem.id);
                if (itemInStock) {
                    itemInStock.stock += returnedItem.quantity;
                }
            });

            const newReturn = {
                id: Date.now(),
                number: currentSaleReturnNumber,
                date: new Date().toISOString().split('T')[0],
                originalInvoiceId: activeSaleReturn.id,
                originalInvoiceNumber: activeSaleReturn.number,
                customerId: activeSaleReturn.customerId,
                branchId: activeSaleReturn.branchId || null,
                items: returnedItems,
                total: totalReturnValue
            };


// --- ğŸ’¡ Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ---
            // 1. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            const originalSaleIndex = sales.findIndex(s => s.id === activeSaleReturn.id);
            
            if (originalSaleIndex > -1) {
                // 2. Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                const originalSale = sales[originalSaleIndex];
                
                // Ø®ØµÙ… Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ
                originalSale.total = roundCurrency((originalSale.total || 0) - totalReturnValue);
                originalSale.remainingAmount = roundCurrency((originalSale.remainingAmount || 0) - totalReturnValue);
                
                // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                originalSale.notes = (originalSale.notes || '') + ` [Ù…Ø±ØªØ¬Ø¹ Ø¨Ù‚ÙŠÙ…Ø©: ${totalReturnValue.toFixed(2)}]`;
                
                debugLog('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©:', sales[originalSaleIndex]);
            }
            // --- ğŸ’¡ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ---

            // Ø§Ù„Ø³Ø·Ø± 7930 ÙŠØ¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§
         salesReturns.push(newReturn);
            currentSaleReturnNumber++;
            
            const success1 = saveToLocalStorage('salesReturns', salesReturns);
            const success2 = saveToLocalStorage('items', items);
            const success3 = saveToLocalStorage('sales', sales); // <-- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: Ù„Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            
            if (success1 && success2 && success3) { // <-- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±Ø·: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ ÙƒÙ„ Ø´ÙŠØ¡
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø±Ù‚Ù… SR${newReturn.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                newSaleReturn();
                renderSalesReturns();
                updateDashboard();
                renderItems();
                renderSalesList(); // <-- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: Ù„ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

       function renderSalesReturns() {
    const tbody = document.getElementById('salesReturnsList');
    // ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
    tbody.parentElement.querySelector('thead tr').innerHTML = `
        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
        <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th> 
    `;

    tbody.innerHTML = '';
    if (salesReturns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Øª</td></tr>';
        return;
    }
    salesReturns.forEach(sr => {
        const customer = customers.find(c => c.id === sr.customerId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>SR${sr.number.toString().padStart(3, '0')}</td>
            <td>${sr.date}</td>
            <td>${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>SAL${sr.originalInvoiceNumber.toString().padStart(3, '0')}</td>
            <td>${sr.total.toFixed(2)}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-danger" onclick="deleteSaleReturn(${sr.id})">Ø­Ø°Ù</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

        // ===== Expenses and Revenues Functions =====
    async function addExpense() {
    const date = document.getElementById('expenseDate').value;
    const category = document.getElementById('expenseCategory').value;
    const amount = parseFloat(document.getElementById('expenseAmount').value);
    if (!date || !category || isNaN(amount)) { 
        showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning'); 
        return; 
    }

    const attachmentFile = document.getElementById('expenseAttachment').files[0];
    let attachmentUrl = null;

    if (attachmentFile) {
        attachmentUrl = await uploadFile(attachmentFile, 'expenses');
        if (!attachmentUrl) {
            showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹', 'ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚ØŒ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ', 'error');
            return;
        }
    }

    const expense = { 
        id: Date.now(), 
        date, 
        category, 
        amount, 
        description: document.getElementById('expenseDescription').value, 
        paymentMethod: document.getElementById('expensePaymentMethod').value, 
        reference: document.getElementById('expenseReference').value,
        branchId: document.getElementById('expenseBranchId').value || null,
        attachmentUrl: attachmentUrl 
    };
    
    expenses.push(expense);
    const success = saveToLocalStorage('expenses', expenses);
    if (success) {
        clearExpenseForm(); 
        renderExpenses();
        updateExpenseStats();
        updateDashboard();
        
        // ğŸ“’ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        await createExpenseJournalEntry(expense);
    } else {
        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}
       function renderExpenses() {
    const tbody = document.getElementById('expensesList');
    tbody.innerHTML = '';
    if (expenses.length === 0) { 
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª</td></tr>'; // ğŸ’¡ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø¥Ù„Ù‰ 8
        return; 
    }
    
    [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(exp => {
        const tr = document.createElement('tr');
        
        const attachmentLink = exp.attachmentUrl 
            ? `<a href="${exp.attachmentUrl}" target="_blank" class="btn-info" style="padding: 4px 8px; text-decoration: none;">Ø¹Ø±Ø¶</a>`
            : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        
        tr.innerHTML = `
            <td>${exp.date}</td>
            <td>${exp.category}</td>
            <td>${exp.amount.toFixed(2)}</td>
            <td>${getPaymentMethodName(exp.paymentMethod)}</td>
            <td>${exp.description || '-'}</td>
            <td>${exp.reference || '-'}</td>
            <td>${attachmentLink}</td>
            <td>
                <div class="action-menu-container">
                    <button class="action-menu-btn" onclick="toggleActionMenu(event, ${exp.id})">â‹®</button>
                    <div class="action-menu-content" id="menu-${exp.id}">
                        <a href="#" onclick="event.preventDefault(); editExpense(${exp.id});">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>
                        <a href="#" onclick="event.preventDefault(); deleteExpense(${exp.id});" style="color: #dc3545;">ğŸ—‘ï¸ Ø­Ø°Ù</a>
                    </div>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}
        function getPaymentMethodName(method) { return { 'cash': 'Ù†Ù‚Ø¯ÙŠ', 'bank': 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ', 'check': 'Ø´ÙŠÙƒ', 'card': 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†' }[method] || method; }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseCategory').value = expense.category;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseDescription').value = expense.description || '';
            document.getElementById('expensePaymentMethod').value = expense.paymentMethod;
            document.getElementById('expenseReference').value = expense.reference || '';
            const btn = document.querySelector('#expenses .btn-primary');
            btn.textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ';
            btn.onclick = () => updateExpense(id);
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            applyEditMode('#expenses', 'expenseDate', '#expenses h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ`);
        }

        async function updateExpense(id) {
            const date = document.getElementById('expenseDate').value, category = document.getElementById('expenseCategory').value, amount = parseFloat(document.getElementById('expenseAmount').value);
            if (!date || !category || isNaN(amount)) { showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning'); return; }
            const index = expenses.findIndex(e => e.id === id);
            if (index > -1) {
                expenses[index] = { ...expenses[index], date, category, amount, description: document.getElementById('expenseDescription').value, paymentMethod: document.getElementById('expensePaymentMethod').value, reference: document.getElementById('expenseReference').value };
                const success = saveToLocalStorage('expenses', expenses);
                if (success) {
                    clearExpenseForm();
                    renderExpenses();
                    updateExpenseStats();
                    showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            }
        }
        
        async function deleteExpense(id) {
            const confirmed = await showConfirmDialog(
                'Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ',
                'warning',
                'Ù†Ù‚Ù„',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                const expense = expenses.find(e => e.id === id);
                if (expense) {
                    moveToTrash('expenses', expense);
                    expenses = expenses.filter(e => e.id !== id);
                    const success = saveToLocalStorage('expenses', expenses);
                    if (success) {
                        renderExpenses();
                        updateExpenseStats();
                        updateDashboard();
                        showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            }
        }
        
      async function clearExpenseForm() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
    const confirmed = await confirmCancelEdit('#expenses');
    if (!confirmed) return;
    
    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    ['expenseCategory', 'expenseAmount', 'expenseDescription', 'expenseReference'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('expensePaymentMethod').value = 'cash';
    
    document.getElementById('expenseAttachment').value = null; 
    
    const btn = document.querySelector('#expenses .btn-primary');
    btn.textContent = ' Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ';
    btn.onclick = addExpense;
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
    removeEditMode('#expenses', '#expenses h2', 'ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatExpenses" class="stat-mini-number">0</span></span>');
}
        function updateExpenseStats() {
            const today = new Date().toISOString().split('T')[0];
            const month = today.substring(0, 7);
            const total = expenses.reduce((s, e) => s + e.amount, 0);
            const todayTotal = expenses.filter(e => e.date === today).reduce((s, e) => s + e.amount, 0);
            const monthTotal = expenses.filter(e => e.date.substring(0, 7) === month).reduce((s, e) => s + e.amount, 0);
            document.getElementById('totalExpenses').textContent = total.toFixed(2);
            document.getElementById('todayExpenses').textContent = todayTotal.toFixed(2);
            document.getElementById('monthExpenses').textContent = monthTotal.toFixed(2);
        }
        
        async function addRevenue() {
            const date = document.getElementById('revenueDate').value, category = document.getElementById('revenueCategory').value, amount = parseFloat(document.getElementById('revenueAmount').value);
            if (!date || !category || isNaN(amount)) { showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning'); return; }
            const revenue = { 
                id: Date.now(), 
                date, 
                category, 
                amount, 
                source: document.getElementById('revenueSource').value, 
                description: document.getElementById('revenueDescription').value, 
                reference: document.getElementById('revenueReference').value,
                branchId: document.getElementById('revenueBranchId').value || null
            };
            revenues.push(revenue);
            const success = saveToLocalStorage('revenues', revenues);
            if (success) {
                clearRevenueForm();
                renderRevenues();
                updateRevenueStats();
                updateDashboard();
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }
        function renderRevenues() {
            const tbody = document.getElementById('revenuesList');
            tbody.innerHTML = '';
            if (revenues.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</td></tr>'; return; }
             [...revenues].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(rev => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${rev.date}</td>
                    <td>${rev.category}</td>
                    <td>${getRevenueSourceName(rev.source)}</td>
                    <td>${rev.amount.toFixed(2)}</td>
                    <td>${rev.description || '-'}</td>
                    <td>${rev.reference || '-'}</td>
                    <td>
                        <div class="action-menu-container">
                            <button class="action-menu-btn" onclick="toggleActionMenu(event, ${rev.id})">â‹®</button>
                            <div class="action-menu-content" id="menu-${rev.id}">
                                <a href="#" onclick="event.preventDefault(); editRevenue(${rev.id});">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>
                                <a href="#" onclick="event.preventDefault(); deleteRevenue(${rev.id});" style="color: #dc3545;">ğŸ—‘ï¸ Ø­Ø°Ù</a>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        function getRevenueSourceName(source) { return { 'sales': 'Ù…Ø¨ÙŠØ¹Ø§Øª', 'services': 'Ø®Ø¯Ù…Ø§Øª', 'investment': 'Ø§Ø³ØªØ«Ù…Ø§Ø±', 'other': 'Ø£Ø®Ø±Ù‰' }[source] || source; }
        function editRevenue(id) {
            const rev = revenues.find(r => r.id === id);
            if (!rev) return;
            document.getElementById('revenueDate').value = rev.date;
            document.getElementById('revenueCategory').value = rev.category;
            document.getElementById('revenueAmount').value = rev.amount;
            document.getElementById('revenueDescription').value = rev.description || '';
            document.getElementById('revenueSource').value = rev.source;
            document.getElementById('revenueReference').value = rev.reference || '';
            const btn = document.querySelector('#revenues .btn-primary');
            btn.textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯';
            btn.onclick = () => updateRevenue(id);
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            applyEditMode('#revenues', 'revenueDate', '#revenues h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯`);
        }
        async function updateRevenue(id) {
            const date = document.getElementById('revenueDate').value, category = document.getElementById('revenueCategory').value, amount = parseFloat(document.getElementById('revenueAmount').value);
            if (!date || !category || isNaN(amount)) { showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning'); return; }
            const index = revenues.findIndex(r => r.id === id);
            if (index > -1) {
                revenues[index] = { ...revenues[index], date, category, amount, source: document.getElementById('revenueSource').value, description: document.getElementById('revenueDescription').value, reference: document.getElementById('revenueReference').value };
                const success = saveToLocalStorage('revenues', revenues);
                if (success) {
                    clearRevenueForm();
                    renderRevenues();
                    updateRevenueStats();
                    showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            }
        }
        async function deleteRevenue(id) {
            const confirmed = await showConfirmDialog(
                'Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ',
                'warning',
                'Ù†Ù‚Ù„',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                const revenue = revenues.find(r => r.id === id);
                if (revenue) {
                    moveToTrash('revenues', revenue);
                    revenues = revenues.filter(r => r.id !== id);
                    const success = saveToLocalStorage('revenues', revenues);
                    if (success) {
                        renderRevenues();
                        updateRevenueStats();
                        updateDashboard();
                        showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            }
        }
        async function clearRevenueForm() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            const confirmed = await confirmCancelEdit('#revenues');
            if (!confirmed) return;
            
            document.getElementById('revenueDate').value = new Date().toISOString().split('T')[0];
            ['revenueCategory', 'revenueAmount', 'revenueDescription', 'revenueReference'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('revenueSource').value = 'sales';
            const btn = document.querySelector('#revenues .btn-primary');
            btn.textContent = ' Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ±Ø§Ø¯';
            btn.onclick = addRevenue;
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            removeEditMode('#revenues', '#revenues h2', 'ğŸ’° Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰ <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatRevenues" class="stat-mini-number">0</span></span>');
        }
        function updateRevenueStats() {
            const today = new Date().toISOString().split('T')[0];
            const month = today.substring(0, 7);
            const total = revenues.reduce((s, r) => s + r.amount, 0);
            const todayTotal = revenues.filter(r => r.date === today).reduce((s, r) => s + r.amount, 0);
            const monthTotal = revenues.filter(r => r.date.substring(0, 7) === month).reduce((s, r) => s + r.amount, 0);
            document.getElementById('totalRevenues').textContent = total.toFixed(2);
            document.getElementById('todayRevenues').textContent = todayTotal.toFixed(2);
            document.getElementById('monthRevenues').textContent = monthTotal.toFixed(2);
        }

        // ===== Bonds Functions =====
        let bonds = loadFromLocalStorage('bonds') || [];

        function renderBonds() {
            const tbody = document.getElementById('bondsList');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            const searchTerm = document.getElementById('searchBonds') ? document.getElementById('searchBonds').value.toLowerCase() : '';
            
            let filteredBonds = bonds;
            if (searchTerm) {
                filteredBonds = bonds.filter(b => 
                    b.number.toString().includes(searchTerm) || 
                    b.description.toLowerCase().includes(searchTerm) ||
                    (b.partyName && b.partyName.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredBonds.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù†Ø¯Ø§Øª</td></tr>';
                return;
            }
            
            [...filteredBonds].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(bond => {
                const tr = document.createElement('tr');
                const typeLabel = bond.type === 'receipt' ? '<span style="color:#28a745;font-weight:bold;">ğŸ“¥ Ù‚Ø¨Ø¶</span>' : '<span style="color:#dc3545;font-weight:bold;">ğŸ“¤ ØµØ±Ù</span>';
                
                tr.innerHTML = `
                    <td>${bond.number}</td>
                    <td>${typeLabel}</td>
                    <td>${bond.date}</td>
                    <td>${bond.partyName || '-'}</td>
                    <td>${bond.amount.toFixed(2)}</td>
                    <td>${bond.description || '-'}</td>
                    <td>
                        <div class="action-menu-container">
                            <button class="action-menu-btn" onclick="toggleActionMenu(event, 'bond-${bond.id}')">â‹®</button>
                            <div class="action-menu-content" id="menu-bond-${bond.id}">
                                <a href="#" onclick="event.preventDefault(); printBond(${bond.id});">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</a>
                                <a href="#" onclick="event.preventDefault(); deleteBond(${bond.id});" style="color: #dc3545;">ğŸ—‘ï¸ Ø­Ø°Ù</a>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Update mini stat
            const miniStat = document.getElementById('miniStatBonds');
            if (miniStat) miniStat.textContent = bonds.length;
        }

        async function addBond() {
            const date = document.getElementById('bondDate').value;
            const type = document.getElementById('bondType').value;
            const amount = parseFloat(document.getElementById('bondAmount').value);
            const partyType = document.getElementById('bondPartyType').value;
            const partyId = document.getElementById('bondPartyId').value;
            const description = document.getElementById('bondDescription').value;
            const branchId = document.getElementById('bondBranchId').value;
            
            if (!date || isNaN(amount) || amount <= 0) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'warning');
                return;
            }
            
            // Get party name
            let partyName = '';
            if (partyId) {
                const select = document.getElementById('bondPartyId');
                if (select.selectedIndex > -1) {
                    partyName = select.options[select.selectedIndex].text;
                }
            }
            
            const newBond = {
                id: Date.now(),
                number: bonds.length + 1,
                date,
                type,
                amount,
                partyType,
                partyId,
                partyName,
                description,
                branchId
            };
            
            bonds.push(newBond);
            const success = saveToLocalStorage('bonds', bonds);
            
            if (success) {
                // Create Journal Entry
                await createBondJournalEntry(newBond);
                
                document.getElementById('bondAmount').value = '';
                document.getElementById('bondDescription').value = '';
                renderBonds();
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

        async function deleteBond(id) {
            const confirmed = await showConfirmDialog(
                'Ø­Ø°Ù Ø§Ù„Ø³Ù†Ø¯',
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ù†Ø¯ØŸ',
                'danger',
                'Ø­Ø°Ù',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            
            if (confirmed) {
                bonds = bonds.filter(b => b.id !== id);
                saveToLocalStorage('bonds', bonds);
                renderBonds();
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        }

        function updateBondPartySelect() {
            const type = document.getElementById('bondPartyType').value;
            const select = document.getElementById('bondPartyId');
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø±Ù</option>';
            
            if (type === 'customer') {
                customers.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                });
            } else if (type === 'supplier') {
                suppliers.forEach(s => {
                    select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                });
            } else if (type === 'employee') {
                employees.forEach(e => {
                    select.innerHTML += `<option value="${e.id}">${e.name}</option>`;
                });
            }
        }

        function toggleBondPartyType() {
            // Optional: Adjust UI based on bond type if needed
        }

        function printBond(id) {
            const bond = bonds.find(b => b.id === id);
            if (!bond) return;
            
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            const title = bond.type === 'receipt' ? 'Ø³Ù†Ø¯ Ù‚Ø¨Ø¶' : 'Ø³Ù†Ø¯ ØµØ±Ù';
            
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>${title} #${bond.number}</title>
                    <style>
                        body { font-family: Tahoma, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .content { margin: 20px 0; }
                        .row { margin: 15px 0; font-size: 18px; }
                        .label { font-weight: bold; width: 120px; display: inline-block; }
                        .footer { margin-top: 50px; display: flex; justify-content: space-between; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${title}</h1>
                        <h3>Ø±Ù‚Ù…: ${bond.number}</h3>
                    </div>
                    <div class="content">
                        <div class="row"><span class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> ${bond.date}</div>
                        <div class="row"><span class="label">Ø§Ù„Ù…Ø¨Ù„Øº:</span> ${bond.amount.toFixed(2)} Ø±ÙŠØ§Ù„</div>
                        <div class="row"><span class="label">Ø§Ù„Ø·Ø±Ù:</span> ${bond.partyName || '-'}</div>
                        <div class="row"><span class="label">Ø§Ù„Ø¨ÙŠØ§Ù†:</span> ${bond.description || '-'}</div>
                    </div>
                    <div class="footer">
                        <div>Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
                        <div>Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</div>
                        <div>Ø§Ù„Ù…Ø¯ÙŠØ±</div>
                    </div>
                    <script>window.print(); window.onafterprint = function(){ window.close(); };<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        async function createBondJournalEntry(bond) {
            // Placeholder for journal entry creation
            console.log('Creating journal entry for bond:', bond);
        }

        // ===== Employees Functions =====
        let editingEmployeeId = null;

        function generateEmployeeCode() {
            const count = employees.length + 1;
            return `EMP-${String(count).padStart(3, '0')}`;
        }

        function openAddEmployee() {
            editingEmployeeId = null;
            document.getElementById('employeeModalTitle').textContent = 'ğŸ‘¨â€ğŸ’¼ Ø¨Ø·Ø§Ù‚Ø© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯';
            document.getElementById('employeeCode').value = generateEmployeeCode();
            clearEmployeeForm();
            document.getElementById('addEmployeeModal').style.display = 'block';
            // Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            document.body.style.overflow = 'hidden';
        }

        function closeAddEmployee() {
            const modal = document.getElementById('addEmployeeModal');
            modal.style.display = 'none';
            clearEmployeeForm();
            document.body.style.overflow = 'auto';
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„
            modal.querySelectorAll('input, select, textarea').forEach(field => {
                field.removeAttribute('readonly');
                field.style.backgroundColor = '';
                field.style.cursor = '';
            });
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø­ÙØ¸
            const saveBtn = modal.querySelector('.btn-primary');
            if (saveBtn) saveBtn.style.display = '';
        }

        function clearEmployeeForm() {
            document.getElementById('employeeNameAr').value = '';
            document.getElementById('employeeNameEn').value = '';
            document.getElementById('employeeStatus').value = 'active';
            document.getElementById('employeePhone').value = '';
            document.getElementById('employeeEmail').value = '';
            document.getElementById('employeeJobTitle').value = '';
            document.getElementById('employeeDepartment').value = '';
            document.getElementById('employeeHireDate').value = '';
            document.getElementById('employeeContractEnd').value = '';
            document.getElementById('employeeContractFile').value = ''; // ØªØµÙÙŠØ± Ø­Ù‚Ù„ Ø§Ù„Ù…Ù„Ù
            currentContractFile = null; // ØªØµÙÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
            const viewContractBtn = document.getElementById('viewContractBtn');
            if (viewContractBtn) viewContractBtn.style.display = 'none';
            
            document.getElementById('employeeBasicSalary').value = '';
            document.getElementById('employeeHousingAllowance').value = '';
            document.getElementById('employeeTransportAllowance').value = '';
            document.getElementById('employeeOtherAllowances').value = '';
            document.getElementById('employeeNationalId').value = '';
            document.getElementById('employeeNationality').value = '';
            document.getElementById('employeeBirthDate').value = '';
            document.getElementById('employeeMaritalStatus').value = '';
            document.getElementById('employeeAddress').value = '';
            document.getElementById('employeeImagePreview').innerHTML = '<span style="color: #adb5bd; font-size: 48px;">ğŸ‘¤</span>';
            document.getElementById('employeeTotalSalary').textContent = '0.00';
        }

        function previewEmployeeImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('employeeImagePreview').innerHTML = 
                        `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function calculateEmployeeTotalSalary() {
            const basic = parseFloat(document.getElementById('employeeBasicSalary').value) || 0;
            const housing = parseFloat(document.getElementById('employeeHousingAllowance').value) || 0;
            const transport = parseFloat(document.getElementById('employeeTransportAllowance').value) || 0;
            const other = parseFloat(document.getElementById('employeeOtherAllowances').value) || 0;
            const total = basic + housing + transport + other;
            document.getElementById('employeeTotalSalary').textContent = total.toFixed(2);
        }

        async function saveEmployee() {
            const nameAr = document.getElementById('employeeNameAr').value.trim();
            const nationalId = document.getElementById('employeeNationalId').value.trim();
            const nationality = document.getElementById('employeeNationality').value;

            if (!nameAr || !nationalId || !nationality) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØ§Ù„Ø¬Ù†Ø³ÙŠØ©', 'warning');
                return;
            }

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ø¹Ù‚Ø¯
            let contractFileBase64 = currentContractFile; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
            const fileInput = document.getElementById('employeeContractFile');
            
            if (fileInput.files && fileInput.files[0]) {
                try {
                    const file = fileInput.files[0];
                    contractFileBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(e);
                        reader.readAsDataURL(file);
                    });
                } catch (error) {
                    console.error('Error reading contract file:', error);
                    showNotification('âš ï¸ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¹Ù‚Ø¯', 'error');
                    return;
                }
            }

            const employee = {
                id: editingEmployeeId || Date.now(),
                code: document.getElementById('employeeCode').value,
                nameAr: nameAr,
                nameEn: document.getElementById('employeeNameEn').value.trim(),
                status: document.getElementById('employeeStatus').value,
                phone: document.getElementById('employeePhone').value.trim(),
                email: document.getElementById('employeeEmail').value.trim(),
                jobTitle: document.getElementById('employeeJobTitle').value.trim(),
                department: document.getElementById('employeeDepartment').value,
                hireDate: document.getElementById('employeeHireDate').value,
                contractEnd: document.getElementById('employeeContractEnd').value,
                contractFile: contractFileBase64, // Ø­ÙØ¸ Ù…Ù„Ù Ø§Ù„Ø¹Ù‚Ø¯
                basicSalary: parseFloat(document.getElementById('employeeBasicSalary').value) || 0,
                housingAllowance: parseFloat(document.getElementById('employeeHousingAllowance').value) || 0,
                transportAllowance: parseFloat(document.getElementById('employeeTransportAllowance').value) || 0,
                otherAllowances: parseFloat(document.getElementById('employeeOtherAllowances').value) || 0,
                nationalId: nationalId,
                nationality: nationality,
                birthDate: document.getElementById('employeeBirthDate').value,
                maritalStatus: document.getElementById('employeeMaritalStatus').value,
                address: document.getElementById('employeeAddress').value.trim(),
                image: document.getElementById('employeeImagePreview').innerHTML.includes('img') ? 
                    document.getElementById('employeeImagePreview').querySelector('img').src : null,
                createdAt: editingEmployeeId ? employees.find(e => e.id === editingEmployeeId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (editingEmployeeId) {
                const index = employees.findIndex(e => e.id === editingEmployeeId);
                employees[index] = employee;
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } else {
                employees.push(employee);
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }

            console.log('ğŸ‘¨â€ğŸ’¼ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù:', employee.nameAr, '| Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:', employees.length);
            saveToLocalStorage('employees', employees);
            renderEmployees();
            closeAddEmployee();
        }

        function renderEmployees() {
            const list = document.getElementById('employeesList');
            list.innerHTML = '';

            if (employees.length === 0) {
                list.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ‘¥</div>
                        <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ù…Ø³Ø¬Ù„ÙˆÙ†</p>
                    </div>
                `;
                document.getElementById('miniStatEmployees').textContent = '0';
                return;
            }

            employees.forEach(emp => {
                const totalSalary = emp.basicSalary + emp.housingAllowance + emp.transportAllowance + emp.otherAllowances;
                const statusIcon = emp.status === 'active' ? 'ğŸŸ¢' : emp.status === 'inactive' ? 'âšª' : 'ğŸ”´';
                const statusText = emp.status === 'active' ? 'Ù†Ø´Ø·' : emp.status === 'inactive' ? 'ØºÙŠØ± Ù†Ø´Ø·' : 'Ù…ÙˆÙ‚ÙˆÙ';
                
                const card = document.createElement('div');
                card.style.cssText = 'background: white; border: 1px solid #dee2e6; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s;';
                card.onmouseenter = () => card.style.transform = 'translateY(-4px)';
                card.onmouseleave = () => card.style.transform = 'translateY(0)';
                
                card.innerHTML = `
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; flex-shrink: 0; background: #f8f9fa; display: flex; align-items: center; justify-content: center; border: 2px solid #dee2e6;">
                            ${emp.image ? `<img src="${emp.image}" style="width: 100%; height: 100%; object-fit: cover;">` : '<span style="font-size: 36px;">ğŸ‘¤</span>'}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 16px; color: #2c3e50; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${emp.nameAr}</div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">${emp.code}</div>
                            <div style="font-size: 13px; color: #495057;">${emp.jobTitle || '-'}</div>
                            <div style="margin-top: 6px;">
                                <span style="background: ${emp.status === 'active' ? '#d4edda' : '#f8d7da'}; color: ${emp.status === 'active' ? '#155724' : '#721c24'}; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                    ${statusIcon} ${statusText}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="border-top: 1px solid #e9ecef; padding-top: 12px; margin-top: 12px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; margin-bottom: 10px;">
                            <div><span style="color: #6c757d;">ğŸ“±</span> ${emp.phone || '-'}</div>
                            <div><span style="color: #6c757d;">ğŸ†”</span> ${emp.nationalId || '-'}</div>
                            <div><span style="color: #6c757d;">ğŸ’¼</span> ${emp.department ? getDepartmentName(emp.department) : '-'}</div>
                            <div><span style="color: #6c757d;">ğŸ’°</span> ${totalSalary.toFixed(2)}</div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button onclick="viewEmployee(${emp.id})" class="btn-info" style="flex: 1; padding: 8px; font-size: 13px;">
                                ğŸ‘ï¸ Ø¹Ø±Ø¶
                            </button>
                            <button onclick="editEmployee(${emp.id})" class="btn-warning" style="flex: 1; padding: 8px; font-size: 13px;">
                                âœï¸ ØªØ¹Ø¯ÙŠÙ„
                            </button>
                            <button onclick="deleteEmployee(${emp.id})" class="btn-danger" style="flex: 1; padding: 8px; font-size: 13px;">
                                ğŸ—‘ï¸ Ø­Ø°Ù
                            </button>
                        </div>
                    </div>
                `;
                
                list.appendChild(card);
            });

            document.getElementById('miniStatEmployees').textContent = employees.length;
        }

        function getDepartmentName(dept) {
            const depts = {
                'accounting': 'Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
                'sales': 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                'purchases': 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
                'hr': 'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©',
                'it': 'ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª',
                'operations': 'Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª',
                'management': 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©'
            };
            return depts[dept] || dept;
        }

        function viewEmployee(id) {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;

            const totalSalary = emp.basicSalary + emp.housingAllowance + emp.transportAllowance + emp.otherAllowances;
            const statusIcon = emp.status === 'active' ? 'ğŸŸ¢' : emp.status === 'inactive' ? 'âšª' : 'ğŸ”´';
            const statusText = emp.status === 'active' ? 'Ù†Ø´Ø·' : emp.status === 'inactive' ? 'ØºÙŠØ± Ù†Ø´Ø·' : 'Ù…ÙˆÙ‚ÙˆÙ';

            // Ù†ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆÙ†Ø¹Ø±Ø¶ ÙÙŠÙ‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
            editingEmployeeId = null;
            document.getElementById('employeeModalTitle').textContent = 'ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù';
            
            // Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            document.getElementById('employeeCode').value = emp.code;
            document.getElementById('employeeNameAr').value = emp.nameAr;
            document.getElementById('employeeNameEn').value = emp.nameEn || '';
            document.getElementById('employeeStatus').value = emp.status;
            document.getElementById('employeePhone').value = emp.phone || '';
            document.getElementById('employeeEmail').value = emp.email || '';
            document.getElementById('employeeJobTitle').value = emp.jobTitle || '';
            document.getElementById('employeeDepartment').value = emp.department || '';
            document.getElementById('employeeHireDate').value = emp.hireDate || '';
            document.getElementById('employeeContractEnd').value = emp.contractEnd || '';
            document.getElementById('employeeBasicSalary').value = emp.basicSalary || '';
            document.getElementById('employeeHousingAllowance').value = emp.housingAllowance || '';
            document.getElementById('employeeTransportAllowance').value = emp.transportAllowance || '';
            document.getElementById('employeeOtherAllowances').value = emp.otherAllowances || '';
            document.getElementById('employeeNationalId').value = emp.nationalId;
            document.getElementById('employeeNationality').value = emp.nationality;
            document.getElementById('employeeBirthDate').value = emp.birthDate || '';
            document.getElementById('employeeMaritalStatus').value = emp.maritalStatus || '';
            document.getElementById('employeeAddress').value = emp.address || '';
            
            if (emp.image) {
                document.getElementById('employeeImagePreview').innerHTML = 
                    `<img src="${emp.image}" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                document.getElementById('employeeImagePreview').innerHTML = '<span style="color: #adb5bd; font-size: 48px;">ğŸ‘¤</span>';
            }
            
            calculateEmployeeTotalSalary();
            
            // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø­ÙØ¸ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ÙÙ‚Ø·
            const modal = document.getElementById('addEmployeeModal');
            const saveBtn = modal.querySelector('.btn-primary');
            saveBtn.style.display = 'none';
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Ø¬Ø¹Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
            modal.querySelectorAll('input, select, textarea').forEach(field => {
                field.setAttribute('readonly', true);
                field.style.backgroundColor = '#f8f9fa';
                field.style.cursor = 'not-allowed';
            });
        }

        function editEmployee(id) {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;

            editingEmployeeId = id;
            document.getElementById('employeeModalTitle').textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù';
            
            document.getElementById('employeeCode').value = emp.code;
            document.getElementById('employeeNameAr').value = emp.nameAr;
            document.getElementById('employeeNameEn').value = emp.nameEn || '';
            document.getElementById('employeeStatus').value = emp.status;
            document.getElementById('employeePhone').value = emp.phone || '';
            document.getElementById('employeeEmail').value = emp.email || '';
            document.getElementById('employeeJobTitle').value = emp.jobTitle || '';
            document.getElementById('employeeDepartment').value = emp.department || '';
            document.getElementById('employeeHireDate').value = emp.hireDate || '';
            document.getElementById('employeeContractEnd').value = emp.contractEnd || '';

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù„Ù Ø§Ù„Ø¹Ù‚Ø¯
            document.getElementById('employeeContractFile').value = ''; // ØªØµÙÙŠØ± Ø­Ù‚Ù„ Ø§Ù„Ù…Ù„Ù
            currentContractFile = emp.contractFile || null;
            const viewContractBtn = document.getElementById('viewContractBtn');
            if (currentContractFile) {
                viewContractBtn.style.display = 'block';
            } else {
                viewContractBtn.style.display = 'none';
            }

            document.getElementById('employeeBasicSalary').value = emp.basicSalary || '';
            document.getElementById('employeeHousingAllowance').value = emp.housingAllowance || '';
            document.getElementById('employeeTransportAllowance').value = emp.transportAllowance || '';
            document.getElementById('employeeOtherAllowances').value = emp.otherAllowances || '';
            document.getElementById('employeeNationalId').value = emp.nationalId;
            document.getElementById('employeeNationality').value = emp.nationality;
            document.getElementById('employeeBirthDate').value = emp.birthDate || '';
            document.getElementById('employeeMaritalStatus').value = emp.maritalStatus || '';
            document.getElementById('employeeAddress').value = emp.address || '';
            
            if (emp.image) {
                document.getElementById('employeeImagePreview').innerHTML = 
                    `<img src="${emp.image}" style="width: 100%; height: 100%; object-fit: cover;">`;
            }
            
            calculateEmployeeTotalSalary();
            document.getElementById('addEmployeeModal').style.display = 'block';
        }

        async function deleteEmployee(id) {
            const confirmed = await showConfirmDialog(
                'Ø­Ø°Ù Ù…ÙˆØ¸Ù',
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸ÙØŸ',
                'danger',
                'Ø­Ø°Ù',
                'Ø¥Ù„ØºØ§Ø¡'
            );

            if (!confirmed) return;

            employees = employees.filter(e => e.id !== id);
            saveToLocalStorage('employees', employees);
            renderEmployees();
            showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        function searchEmployees() {
            const searchTerm = document.getElementById('employeeSearchInput').value.toLowerCase();
            const list = document.getElementById('employeesList');
            
            const filtered = employees.filter(emp => 
                emp.nameAr.toLowerCase().includes(searchTerm) ||
                emp.nameEn?.toLowerCase().includes(searchTerm) ||
                emp.code.toLowerCase().includes(searchTerm) ||
                emp.nationalId.includes(searchTerm) ||
                emp.phone?.includes(searchTerm) ||
                emp.jobTitle?.toLowerCase().includes(searchTerm)
            );

            list.innerHTML = '';
            
            if (filtered.length === 0) {
                list.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ”</div>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«</p>
                    </div>
                `;
                return;
            }

            filtered.forEach(emp => {
                const totalSalary = emp.basicSalary + emp.housingAllowance + emp.transportAllowance + emp.otherAllowances;
                const statusIcon = emp.status === 'active' ? 'ğŸŸ¢' : emp.status === 'inactive' ? 'âšª' : 'ğŸ”´';
                const statusText = emp.status === 'active' ? 'Ù†Ø´Ø·' : emp.status === 'inactive' ? 'ØºÙŠØ± Ù†Ø´Ø·' : 'Ù…ÙˆÙ‚ÙˆÙ';
                
                const card = document.createElement('div');
                card.style.cssText = 'background: white; border: 1px solid #dee2e6; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
                
                card.innerHTML = `
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; flex-shrink: 0; background: #f8f9fa; display: flex; align-items: center; justify-content: center; border: 2px solid #dee2e6;">
                            ${emp.image ? `<img src="${emp.image}" style="width: 100%; height: 100%; object-fit: cover;">` : '<span style="font-size: 36px;">ğŸ‘¤</span>'}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 16px; color: #2c3e50; margin-bottom: 4px;">${emp.nameAr}</div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">${emp.code}</div>
                            <div style="font-size: 13px; color: #495057;">${emp.jobTitle || '-'}</div>
                            <div style="margin-top: 6px;">
                                <span style="background: ${emp.status === 'active' ? '#d4edda' : '#f8d7da'}; color: ${emp.status === 'active' ? '#155724' : '#721c24'}; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                    ${statusIcon} ${statusText}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="border-top: 1px solid #e9ecef; padding-top: 12px; margin-top: 12px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; margin-bottom: 10px;">
                            <div><span style="color: #6c757d;">ğŸ“±</span> ${emp.phone || '-'}</div>
                            <div><span style="color: #6c757d;">ğŸ†”</span> ${emp.nationalId || '-'}</div>
                            <div><span style="color: #6c757d;">ğŸ’¼</span> ${emp.department ? getDepartmentName(emp.department) : '-'}</div>
                            <div><span style="color: #6c757d;">ğŸ’°</span> ${totalSalary.toFixed(2)}</div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button onclick="viewEmployee(${emp.id})" class="btn-info" style="flex: 1; padding: 8px; font-size: 13px;">
                                ğŸ‘ï¸ Ø¹Ø±Ø¶
                            </button>
                            <button onclick="editEmployee(${emp.id})" class="btn-warning" style="flex: 1; padding: 8px; font-size: 13px;">
                                âœï¸ ØªØ¹Ø¯ÙŠÙ„
                            </button>
                            <button onclick="deleteEmployee(${emp.id})" class="btn-danger" style="flex: 1; padding: 8px; font-size: 13px;">
                                ğŸ—‘ï¸ Ø­Ø°Ù
                            </button>
                        </div>
                    </div>
                `;
                
                list.appendChild(card);
            });
        }

        // ===== Salaries Functions =====

        // ===== Attendance Functions =====
        
        // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ù†ÙˆØ§Øª
        function initializeAttendanceYears() {
            const yearSelect = document.getElementById('attendanceYear');
            if (!yearSelect) return;
            
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù†ÙˆØ§Øª Ù…Ù† 2020 Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© + 2
            for (let year = 2020; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        function initializeAttendanceMonth() {
            const monthSelect = document.getElementById('attendanceMonth');
            if (!monthSelect) return;
            
            const currentMonth = new Date().getMonth() + 1; // 1-12
            monthSelect.value = currentMonth;
        }

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ù…ØµØ­Ø­Ø© Ù„Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
function loadAttendanceData() {
    const year = document.getElementById('attendanceYear').value;
    const month = document.getElementById('attendanceMonth').value;
    
    if (!year || !month) {
        showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø±', 'warning');
        return;
    }
    
    console.log(`ğŸ“… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±: ${year}-${month}`);
    
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­Ø© Ø§Ù„ØªÙŠ Ø£Ø¶ÙÙ†Ø§Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù
    renderAttendanceTable(parseInt(year), parseInt(month));
}



// Ø±Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªÙˆØ§ÙÙ‚Ø©)
function renderAttendanceTable(year, month) {
    document.getElementById('attendanceEmptyState').style.display = 'none';
    document.getElementById('attendanceTableContainer').style.display = 'block';
    
    const tbody = document.getElementById('attendanceTableBody');
    
    if (!employees || employees.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6c757d;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ù…Ø³Ø¬Ù„ÙˆÙ†</td></tr>`;
        document.getElementById('attendanceSaveBtn').style.display = 'none';
        return;
    }
    
    tbody.innerHTML = '';
    
    employees.forEach((emp, index) => {
        if (emp.status !== 'active') return; // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø´Ø·ÙŠÙ† ÙÙ‚Ø·

        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #dee2e6';
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        const attendanceKey = `attendance_${year}_${month}_${emp.id}`;
        const savedData = loadFromLocalStorage(attendanceKey) || {};
        
        const getVal = (val) => (val !== undefined && val !== null && val !== '') ? val : 0;
        const inputStyle = "width: 80px; padding: 8px; text-align: center; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; font-weight: bold; font-family: 'Segoe UI', Arial, sans-serif;";

        tr.innerHTML = `
            <td style="padding: 15px; text-align: center;">${index + 1}</td>
            <td style="padding: 15px;">
                <div style="font-weight: 600; color: #2c3e50;">${emp.nameAr}</div>
                <div style="font-size: 12px; color: #6c757d;">${emp.jobTitle || 'Ù…ÙˆØ¸Ù'}</div>
            </td>
            
            <td style="padding: 15px; text-align: center;">
                <input type="number" dir="ltr" id="absence_${emp.id}" value="${getVal(savedData.absenceDays)}" min="0" step="1" onfocus="if(this.value==0)this.value=''" onblur="if(this.value=='')this.value=0" style="${inputStyle}">
            </td>
            
            <td style="padding: 15px; text-align: center;">
                <input type="number" dir="ltr" id="late_${emp.id}" value="${getVal(savedData.lateHours)}" min="0" step="0.5" onfocus="if(this.value==0)this.value=''" onblur="if(this.value=='')this.value=0" style="${inputStyle}">
            </td>
            
            <td style="padding: 15px; text-align: center;">
                <input type="number" dir="ltr" id="overtime_${emp.id}" value="${getVal(savedData.overtimeHours)}" min="0" step="0.5" onfocus="if(this.value==0)this.value=''" onblur="if(this.value=='')this.value=0" style="${inputStyle} border-color: #28a745;">
            </td>
            
            <td style="padding: 15px;">
                <input type="text" id="notes_${emp.id}" value="${savedData.notes || ''}" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." style="width: 100%; min-width: 150px; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 13px;">
            </td>
        `;
        
        tbody.appendChild(tr);
    });
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø­ÙØ¸ (ØªØ£ÙƒØ¯Ù†Ø§ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡ ÙÙŠ HTML)
    const saveBtn = document.getElementById('attendanceSaveBtn');
    if(saveBtn) saveBtn.style.display = 'block';
}
        // Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ± (Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
        function toggleAttendance(empId, day, month, year) {
            console.log(`ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ±: Ù…ÙˆØ¸Ù ${empId}, ÙŠÙˆÙ… ${day}/${month}/${year}`);
            // TODO: Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«
        }

        // ===== End Attendance Functions =====

        // ===== Payroll Calculation Functions =====
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø³Ù†ÙˆØ§Øª ÙÙŠ ÙÙ„ØªØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨
        function initializePayrollYears() {
            const yearSelect = document.getElementById('payrollYear');
            console.log('ğŸ” initializePayrollYears called, yearSelect:', yearSelect);
            if (!yearSelect) {
                console.warn('âš ï¸ payrollYear element not found!');
                return;
            }
            
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            
            for (let year = 2020; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
            console.log('âœ… Payroll years initialized:', yearSelect.options.length, 'years');
        }
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        function initializePayrollMonth() {
            const monthSelect = document.getElementById('payrollMonth');
            console.log('ğŸ” initializePayrollMonth called, monthSelect:', monthSelect);
            if (!monthSelect) {
                console.warn('âš ï¸ payrollMonth element not found!');
                return;
            }
            
            const currentMonth = new Date().getMonth() + 1;
            monthSelect.value = currentMonth;
            console.log('âœ… Payroll month initialized to:', currentMonth);
        }
        // ==========================================
// ğŸ’° Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ (Ø§Ù„Ù…Ø­Ø¯Ø«)
// ==========================================

// 1. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø±ÙˆØ§ØªØ¨
function calculatePayroll() {
    const year = document.getElementById('payrollYear').value;
    const month = document.getElementById('payrollMonth').value;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙÙ„ (Ù‡Ù„ Ø§Ù„Ø´Ù‡Ø± Ù…Ø¹ØªÙ…Ø¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŸ)
    const lockKey = `payroll_locked_${year}_${month}`;
    const isLocked = loadFromLocalStorage(lockKey);
    
    if (isLocked) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ÙŠØ± Ù…Ù‚ÙÙ„Ø§Ù‹ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙˆØ¹Ø±Ø¶Ù‡Ø§ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
        const payrollKey = `payroll_${year}_${month}`;
        const savedPayroll = loadFromLocalStorage(payrollKey);
        
        if (savedPayroll && savedPayroll.length > 0) {
            renderPayrollTable(savedPayroll);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ù„Ù„Ø¹Ø±Ø¶
            const totalGross = savedPayroll.reduce((sum, p) => sum + (p.gross || 0), 0);
            const totalDeductions = savedPayroll.reduce((sum, p) => sum + (p.totalDeductions || 0), 0);
            const totalNet = savedPayroll.reduce((sum, p) => sum + (p.netSalary || 0), 0); // Ø§Ø³ØªØ®Ø¯Ø§Ù… netSalary Ø£Ùˆ net
            
            updatePayrollSummary(totalGross, totalDeductions, totalNet);
            
            // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ù„Ø£Ù†Ù‡ Ù…Ø¹ØªÙ…Ø¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹
            const approveBtn = document.getElementById('approvePayrollBtn');
            if(approveBtn) approveBtn.style.display = 'none';
            
            showNotification('ğŸ”’ Ù…Ø³ÙŠØ± Ù…Ø¹ØªÙ…Ø¯', `ÙŠØªÙ… Ø¹Ø±Ø¶ Ù…Ø³ÙŠØ± ${getMonthName(month)} ${year} (Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·).`, 'info');
            return;
        } else {
            showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ÙŠØ± Ù…Ù‚ÙÙ„ ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡!', 'error');
            return;
        }
    }
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ¸ÙÙŠÙ†
    if (employees.length === 0) {
        showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ù„Ø­Ø³Ø§Ø¨ Ø±ÙˆØ§ØªØ¨Ù‡Ù…', 'warning');
        return;
    }

    showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø±ÙˆØ§ØªØ¨...');

    const payrollData = [];
    let totalGross = 0;
    let totalDeductions = 0;
    let totalNet = 0;

    // Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙ„ Ù…ÙˆØ¸Ù ÙˆØ­Ø³Ø§Ø¨ Ø±Ø§ØªØ¨Ù‡
    employees.forEach(emp => {
        // Ø£. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
        const attendanceKey = `attendance_${year}_${month}_${emp.id}`;
        const att = loadFromLocalStorage(attendanceKey) || {
            absenceDays: 0,
            lateHours: 0,
            overtimeHours: 0
        };

        // Ø¨. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©
        const basic = parseFloat(emp.basicSalary) || 0;
        const housing = parseFloat(emp.housingAllowance) || 0;
        const transport = parseFloat(emp.transportAllowance) || 0;
        const other = parseFloat(emp.otherAllowances) || 0;
        
        // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø«Ø§Ø¨Øª
        const fixedGross = basic + housing + transport + other;

        // Ø¬. Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ø³Ø§Ø¹Ø©
        const dailyRate = fixedGross / 30;
        const hourlyRate = fixedGross / 30 / 8; 

        // Ø¯. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        const absenceDeduction = att.absenceDays * dailyRate;
        const lateDeduction = att.lateHours * hourlyRate;
        const overtimeAmount = att.overtimeHours * hourlyRate * 1.5;

        // Ù‡Ù€. Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª (GOSI)
        let gosi = 0;
        if (emp.nationality === 'saudi' || emp.nationality === 'Ø³Ø¹ÙˆØ¯ÙŠ' || emp.nationality === 'Saudi') {
            gosi = (basic + housing) * 0.0975; 
        }

        // Ùˆ. Ø§Ù„Ø®Ù„Ø§ØµØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        const totalAdditions = fixedGross + overtimeAmount;
        const currentDeductions = absenceDeduction + lateDeduction + gosi;
        const netSalary = totalAdditions - currentDeductions;

        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
        totalGross += totalAdditions;
        totalDeductions += currentDeductions;
        totalNet += netSalary;

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
        payrollData.push({
            id: emp.id,
            name: emp.nameAr,
            job: emp.jobTitle,
            basic: basic,
            allowances: housing + transport + other,
            overtime: overtimeAmount,
            overtimeHours: att.overtimeHours,
            absence: absenceDeduction + lateDeduction,
            absenceDays: att.absenceDays,
            gosi: gosi,
            net: netSalary,
            status: 'draft',
            // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ
            gross: totalAdditions, // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø«Ø§Ø¨Øª + Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ)
            netSalary: netSalary, // Ø§Ù„ØµØ§ÙÙŠ
            totalDeductions: currentDeductions // Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª (ØºÙŠØ§Ø¨ + ØªØ£Ø®ÙŠØ± + ØªØ£Ù…ÙŠÙ†Ø§Øª)
        });
    });

    // Ø². Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙŠØ± (Ù…Ø¤Ù‚Øª)
    const payrollKey = `payroll_${year}_${month}`;
    saveToLocalStorage(payrollKey, payrollData);

    // Ø­. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    renderPayrollTable(payrollData);
    updatePayrollSummary(totalGross, totalDeductions, totalNet);
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯
    const approveBtn = document.getElementById('approvePayrollBtn');
    if(approveBtn) approveBtn.style.display = 'inline-block';
    
    hideLoading();
    showNotification('âœ… ØªÙ… Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨', 'success');
}

// 2. Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
function renderPayrollTable(data) {
    const tbody = document.getElementById('payrollTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
        return;
    }

    data.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="padding:12px; text-align:center;">${index + 1}</td>
            <td style="padding:12px; font-weight:bold; color:#2c3e50;">
                ${row.name}
                <div style="font-size:11px; color:#999; font-weight:normal;">${row.job || '-'}</div>
            </td>
            <td style="padding:12px; text-align:center;">${row.basic.toFixed(2)}</td>
            <td style="padding:12px; text-align:center;">${row.allowances.toFixed(2)}</td>
            <td style="padding:12px; text-align:center; color:#27ae60;">${row.overtime.toFixed(2)}</td>
            <td style="padding:12px; text-align:center; color:#c0392b;">${row.absence.toFixed(2)}</td>
            <td style="padding:12px; text-align:center; color:#e67e22;">${row.gosi.toFixed(2)}</td>
            <td style="padding:12px; text-align:center; font-weight:bold; font-size:15px; background:#f0fff4; color:#27ae60;">${row.net.toFixed(2)}</td>
            <td style="padding:12px; text-align:center;">
                <button class="btn-secondary btn-sm" onclick="alert('ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹')" style="padding:5px 10px; font-size:12px;">ğŸ“</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// 3. Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
function updatePayrollSummary(gross, deductions, net) {
    const grossEl = document.getElementById('payrollTotalGross');
    const deducEl = document.getElementById('payrollTotalDeductions');
    const netEl = document.getElementById('payrollTotalNet');

    if (grossEl) grossEl.textContent = gross.toFixed(2);
    if (deducEl) deducEl.textContent = deductions.toFixed(2);
    if (netEl) netEl.textContent = net.toFixed(2);
}

// 4. Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ§Ù„ØªØ±Ø­ÙŠÙ„ (Ø§Ù„ØªÙŠ Ø³Ø£Ù„Ù†Ø§ Ø¹Ù†Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹)
// 4. Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ§Ù„ØªØ±Ø­ÙŠÙ„ (Ù…Ø¹ Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø¢Ù„ÙŠ)
async function approvePayroll() {
    const year = document.getElementById('payrollYear').value;
    const month = document.getElementById('payrollMonth').value;
    
    const payrollKey = `payroll_${year}_${month}`;
    const payrollData = loadFromLocalStorage(payrollKey);
    console.log('ğŸ” [approvePayroll] payrollKey:', payrollKey, 'payrollData:', payrollData);
    
    if (!payrollData || payrollData.length === 0) {
        showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'ÙŠØ±Ø¬Ù‰ Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        return;
    }
    
    // 1. ØªØ¬Ù‡ÙŠØ² Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‚ÙŠØ¯
    // Ù†Ø¬Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
    const totalGross = payrollData.reduce((sum, p) => sum + (p.gross || 0), 0);
    const totalNet = payrollData.reduce((sum, p) => sum + (p.netSalary || 0), 0);
    const totalDeductions = payrollData.reduce((sum, p) => sum + (p.totalDeductions || 0), 0);

    showConfirmDialog(
        'ğŸ”’ Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù…Ø³ÙŠØ±',
        `Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ© Ø¨Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ØªØ§Ù„ÙŠØ©:\n\nğŸ’° Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${totalGross.toFixed(2)}\nğŸ“‰ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª: ${totalDeductions.toFixed(2)}\nğŸ’µ Ø§Ù„ØµØ§ÙÙŠ Ù„Ù„Ø¯ÙØ¹: ${totalNet.toFixed(2)}\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`,
        'warning',
        'Ù†Ø¹Ù…ØŒ Ø§Ø¹ØªÙ…Ø¯ ÙˆØ±Ø­Ù‘Ù„',
        'Ø¥Ù„ØºØ§Ø¡'
    ).then(async (confirmed) => {
        if (confirmed) {
            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯...');

            // 2. Ø¨Ù†Ø§Ø¡ Ø£Ø·Ø±Ø§Ù Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ
            const journalEntriesList = [];

            // Ø£. Ø§Ù„Ø·Ø±Ù Ø§Ù„Ù…Ø¯ÙŠÙ† (Ù…Ù† Ø­Ù€/ Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ø£Ø¬ÙˆØ±) - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº
            journalEntriesList.push({
                accountCode: '5111', 
                accountName: 'Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ø£Ø¬ÙˆØ±',
                debit: totalGross,
                credit: 0
            });

            // Ø¨. Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¯Ø§Ø¦Ù† Ø§Ù„Ø£ÙˆÙ„ (Ø¥Ù„Ù‰ Ø­Ù€/ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚) - ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ø³ÙŠØµØ±Ù
            journalEntriesList.push({
                accountCode: '1111', // ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø£Ùˆ Ø§Ù„Ø¨Ù†Ùƒ 1121 Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒ)
                accountName: 'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',
                debit: 0,
                credit: totalNet
            });

            // Ø¬. Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¯Ø§Ø¦Ù† Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø¥Ù„Ù‰ Ø­Ù€/ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø©) - Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª
            if (totalDeductions > 0) {
                journalEntriesList.push({
                    accountCode: '4212', // Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø©
                    accountName: 'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø© (Ø®ØµÙˆÙ…Ø§Øª ÙˆØ¬Ø²Ø§Ø¡Ø§Øª)',
                    debit: 0,
                    credit: totalDeductions
                });
            }

            // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚ÙŠØ¯ Ù„Ù„Ù†Ø¸Ø§Ù… (Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±ØµØ¯Ø© ÙˆØ­ÙØ¸Ù‡ ÙÙŠ Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©)
            const entryResult = await createJournalEntry({
                date: new Date().toISOString().split('T')[0], // ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
                description: `Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø±ÙˆØ§ØªØ¨ Ø´Ù‡Ø± ${month}/${year} Ù„Ø¹Ø¯Ø¯ ${payrollData.length} Ù…ÙˆØ¸Ù`,
                reference: `PAYROLL-${year}-${month}`,
                referenceType: 'payroll',
                entries: journalEntriesList,
                total: totalGross,
                notes: 'ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¢Ù„ÙŠØ§Ù‹ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙˆØ§ØªØ¨'
            });

            if (entryResult) {
                // 4. Ù‚ÙÙ„ Ø§Ù„Ø´Ù‡Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                const lockKey = `payroll_locked_${year}_${month}`;
                saveToLocalStorage(lockKey, true);
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø±
                document.getElementById('approvePayrollBtn').style.display = 'none';
                
                hideLoading();
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØ±Ø­ÙŠÙ„', `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø±Ù‚Ù… #${entryResult.id} ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                
                // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ø±Ø¤ÙŠØ© ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                updateDashboard();
            }
        }
    });
}
        
        // ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„ Ù…ÙˆØ¸Ù
        function editPayrollRecord(empId, year, month) {
            showNotification('ğŸš§ Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info');
        }
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø±
        function getMonthName(monthNum) {
            const months = ['', 'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
            return months[monthNum] || '';
        }
        
        // ===== End Payroll Functions =====

        function normalizeAmount(value) {
            const amount = parseFloat(value);
            return Number.isFinite(amount) ? amount : 0;
        }

        function roundCurrency(value) {
            return Math.round((Number(value) || 0) * 100) / 100;
        }

        function formatCurrency(value) {
            const amount = Number(value);
            return Number.isFinite(amount) ? amount.toFixed(2) : '0.00';
        }

        function getSalaryFormValues() {
            const monthInput = document.getElementById('salaryMonth');
            if (!monthInput) return null;
            const getValue = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };
            return {
                month: monthInput.value || '',
                employeeName: getValue('salaryEmployeeName').trim(),
                nationalId: getValue('salaryNationalId').trim(),
                nationality: getValue('salaryNationality'),
                employeeId: getValue('salaryEmployeeId').trim(),
                jobTitle: getValue('salaryJobTitle').trim(),
                branchId: getValue('salaryBranchId') || null,
                basic: getValue('salaryBasic') || '0',
                housing: getValue('salaryHousing') || '0',
                transport: getValue('salaryTransport') || '0',
                otherAllowances: getValue('salaryOtherAllowances') || '0',
                overtime: getValue('salaryOvertime') || '0',
                otherDeductions: getValue('salaryOtherDeductions') || '0',
                notes: getValue('salaryNotes').trim()
            };
        }

        function computeSalaryBreakdown(formData) {
            const basic = roundCurrency(normalizeAmount(formData.basic));
            const housing = roundCurrency(normalizeAmount(formData.housing));
            const transport = roundCurrency(normalizeAmount(formData.transport));
            const otherAllowances = roundCurrency(normalizeAmount(formData.otherAllowances));
            const overtime = roundCurrency(normalizeAmount(formData.overtime));
            const allowancesTotal = roundCurrency(housing + transport + otherAllowances + overtime);
            const gross = roundCurrency(basic + allowancesTotal);
            const gosiBase = Math.min(basic + housing, GOSI_SALARY_CAP);
            const gosiEmployee = roundCurrency(gosiBase * GOSI_RATE);
            const gosiEmployer = roundCurrency(gosiBase * GOSI_RATE);
            const otherDeductions = roundCurrency(normalizeAmount(formData.otherDeductions));
            const net = roundCurrency(gross - gosiEmployee - otherDeductions);

            return {
                basic,
                housing,
                transport,
                otherAllowances,
                overtime,
                allowancesTotal,
                gross,
                gosiEmployee,
                gosiEmployer,
                otherDeductions,
                net
            };
        }

        async function addSalary() {
            const formData = getSalaryFormValues();
            if (!formData) return;
            if (!formData.month || !formData.employeeName || !formData.nationalId || !formData.nationality) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© ÙˆØ§Ù„Ø¬Ù†Ø³ÙŠØ©', 'warning');
                return;
            }
            if (normalizeAmount(formData.basic) <= 0) {
                showNotification('âš ï¸ Ø±Ø§ØªØ¨ ØºÙŠØ± ØµØ­ÙŠØ­', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'warning');
                return;
            }
            const breakdown = computeSalaryBreakdown(formData);
            const salaryRecord = {
                id: Date.now(),
                month: formData.month,
                employeeName: formData.employeeName,
                nationalId: formData.nationalId,
                nationality: formData.nationality,
                employeeId: formData.employeeId,
                jobTitle: formData.jobTitle,
                branchId: formData.branchId,
                notes: formData.notes,
                basic: breakdown.basic,
                housing: breakdown.housing,
                transport: breakdown.transport,
                otherAllowances: breakdown.otherAllowances,
                overtime: breakdown.overtime,
                allowancesTotal: breakdown.allowancesTotal,
                gross: breakdown.gross,
                gosiEmployee: breakdown.gosiEmployee,
                gosiEmployer: breakdown.gosiEmployer,
                otherDeductions: breakdown.otherDeductions,
                net: breakdown.net,
                createdAt: new Date().toISOString()
            };

            salaries.push(salaryRecord);
            const success = saveToLocalStorage('salaries', salaries);
            if (success) {
                clearSalaryForm(true, true); // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
                renderSalaries();
                updateSalarySummary();
                updateDataStats();
                
                // ğŸ“’ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                await createSalaryJournalEntry(salaryRecord);
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨', 'error');
            }
        }

        async function updateSalary(id) {
            const formData = getSalaryFormValues();
            if (!formData) return;
            if (!formData.month || !formData.employeeName || !formData.nationalId || !formData.nationality) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© ÙˆØ§Ù„Ø¬Ù†Ø³ÙŠØ©', 'warning');
                return;
            }
            const index = salaries.findIndex(s => s.id === id);
            if (index === -1) return;
            const breakdown = computeSalaryBreakdown(formData);
            const existing = salaries[index];
            salaries[index] = {
                ...existing,
                month: formData.month,
                employeeName: formData.employeeName,
                nationalId: formData.nationalId,
                nationality: formData.nationality,
                employeeId: formData.employeeId,
                jobTitle: formData.jobTitle,
                branchId: formData.branchId,
                notes: formData.notes,
                basic: breakdown.basic,
                housing: breakdown.housing,
                transport: breakdown.transport,
                otherAllowances: breakdown.otherAllowances,
                overtime: breakdown.overtime,
                allowancesTotal: breakdown.allowancesTotal,
                gross: breakdown.gross,
                gosiEmployee: breakdown.gosiEmployee,
                gosiEmployer: breakdown.gosiEmployer,
                otherDeductions: breakdown.otherDeductions,
                net: breakdown.net,
                updatedAt: new Date().toISOString()
            };

            const success = saveToLocalStorage('salaries', salaries);
            if (success) {
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                clearSalaryForm(true, true); // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                renderSalaries();
                updateSalarySummary();
                updateDataStats();
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨', 'error');
            }
        }

        function editSalary(id) {
            const salary = salaries.find(s => s.id === id);
            if (!salary) return;
            editingSalaryId = id;
            if (document.getElementById('salaryMonth')) document.getElementById('salaryMonth').value = salary.month || '';
            if (document.getElementById('salaryEmployeeName')) document.getElementById('salaryEmployeeName').value = salary.employeeName || '';
            if (document.getElementById('salaryNationalId')) document.getElementById('salaryNationalId').value = salary.nationalId || '';
            if (document.getElementById('salaryNationality')) document.getElementById('salaryNationality').value = salary.nationality || '';
            if (document.getElementById('salaryEmployeeId')) document.getElementById('salaryEmployeeId').value = salary.employeeId || '';
            if (document.getElementById('salaryJobTitle')) document.getElementById('salaryJobTitle').value = salary.jobTitle || '';
            if (document.getElementById('salaryBasic')) document.getElementById('salaryBasic').value = formatCurrency(salary.basic);
            if (document.getElementById('salaryHousing')) document.getElementById('salaryHousing').value = formatCurrency(salary.housing);
            if (document.getElementById('salaryTransport')) document.getElementById('salaryTransport').value = formatCurrency(salary.transport);
            if (document.getElementById('salaryOtherAllowances')) document.getElementById('salaryOtherAllowances').value = formatCurrency(salary.otherAllowances);
            if (document.getElementById('salaryOvertime')) document.getElementById('salaryOvertime').value = formatCurrency(salary.overtime);
            if (document.getElementById('salaryOtherDeductions')) document.getElementById('salaryOtherDeductions').value = formatCurrency(salary.otherDeductions);
            if (document.getElementById('salaryNotes')) document.getElementById('salaryNotes').value = salary.notes || '';

            const addBtn = document.querySelector('#salaries .btn-primary');
            if (addBtn) {
                addBtn.textContent = 'ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ÙŠØ±';
                addBtn.onclick = () => updateSalary(id);
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            applyEditMode('#salaries', 'salaryEmployeeName', '#salaries h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ÙŠØ±: ${salary.employeeName}`);
        }

        async function deleteSalary(id) {
            const confirmed = await showConfirmDialog(
                'Ø­Ø°Ù Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨',
                'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ÙŠØ±ØŸ',
                'danger',
                'Ø­Ø°Ù',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (!confirmed) return;
            salaries = salaries.filter(s => s.id !== id);
            const success = saveToLocalStorage('salaries', salaries);
            if (success) {
                if (editingSalaryId === id) {
                    clearSalaryForm();
                }
                renderSalaries();
                updateSalarySummary();
                updateDataStats();
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨', 'error');
            }
        }
// Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±ÙˆØ§ØªØ¨ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ø¢Ù…Ù†Ø©)
function clearSalaryForm() {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ± Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
    const yearSelect = document.getElementById('payrollYear');
    const monthSelect = document.getElementById('payrollMonth');
    
    if (yearSelect) yearSelect.value = new Date().getFullYear();
    if (monthSelect) monthSelect.value = new Date().getMonth() + 1;

    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù†Ø¯ Ø§Ù„ØªØµÙÙŠØ±
    const approveBtn = document.getElementById('approvePayrollBtn');
    if (approveBtn) approveBtn.style.display = 'none';

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    const tbody = document.getElementById('payrollTableBody');
    if (tbody) {
        tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 40px; color: #95a5a6;">
            <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">ğŸ‘†</div>
            <p style="font-size: 16px; margin: 0;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø±ÙˆØ§ØªØ¨" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
        </td></tr>`;
    }
    
    updatePayrollSummary(0, 0, 0);
}
        function renderSalaries(data = null, isFiltered = false) {
            const tbody = document.getElementById('salariesList');
            if (!tbody) return;
            const source = Array.isArray(data) ? data : salaries;
            tbody.innerHTML = '';
            if (source.length === 0) {
                const message = isFiltered ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙŠØ±Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙŠØ±Ø§Øª Ø±ÙˆØ§ØªØ¨ Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯';
                tbody.innerHTML = `<tr><td colspan="12" style="text-align: center;">${message}</td></tr>`;
                return;
            }

            const sorted = [...source].sort((a, b) => {
                if ((b.month || '') > (a.month || '')) return 1;
                if ((b.month || '') < (a.month || '')) return -1;
                return (a.employeeName || '').localeCompare(b.employeeName || '');
            });

            sorted.forEach(salary => {
                const allowances = typeof salary.allowancesTotal === 'number'
                    ? salary.allowancesTotal
                    : normalizeAmount(salary.housing) + normalizeAmount(salary.transport) + normalizeAmount(salary.otherAllowances) + normalizeAmount(salary.overtime);
                const gross = typeof salary.gross === 'number' ? salary.gross : normalizeAmount(salary.basic) + allowances;
                const gosiEmployee = normalizeAmount(salary.gosiEmployee);
                const otherDeductions = normalizeAmount(salary.otherDeductions);
                const net = typeof salary.net === 'number' ? salary.net : gross - gosiEmployee - otherDeductions;
                const tr = document.createElement('tr');
                if (salary.notes) {
                    tr.title = salary.notes;
                }
                tr.innerHTML = `
                    <td>${salary.employeeName || '-'}</td>
                    <td>${salary.nationalId || '-'}</td>
                    <td>${salary.nationality === 'saudi' ? 'ğŸ‡¸ğŸ‡¦ Ø³Ø¹ÙˆØ¯ÙŠ' : salary.nationality === 'non-saudi' ? 'ğŸŒ ØºÙŠØ± Ø³Ø¹ÙˆØ¯ÙŠ' : '-'}</td>
                    <td>${salary.month || '-'}</td>
                    <td>${salary.jobTitle || '-'}</td>
                    <td>${formatCurrency(salary.basic)}</td>
                    <td>${formatCurrency(allowances)}</td>
                    <td>${formatCurrency(gross)}</td>
                    <td>${formatCurrency(gosiEmployee)}</td>
                    <td>${formatCurrency(otherDeductions)}</td>
                    <td>${formatCurrency(net)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-warning edit-btn" onclick="editSalary(${salary.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn-danger edit-btn" onclick="deleteSalary(${salary.id})">Ø­Ø°Ù</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ===== Advances Functions =====
        
        async function addAdvance() {
            const date = document.getElementById('advanceDate').value;
            const type = document.getElementById('advanceType').value;
            const employee = document.getElementById('advanceEmployee').value;
            const amount = parseFloat(document.getElementById('advanceAmount').value);
            const description = document.getElementById('advanceDescription').value;
            const status = document.getElementById('advanceStatus').value;

            if (!date || !employee || !amount) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©', 'error');
                return;
            }

            const newAdvance = {
                id: Date.now(),
                date,
                type,
                employee,
                amount,
                description,
                status,
                createdAt: new Date().toISOString()
            };

            advances.push(newAdvance);
            saveToLocalStorage('advances', advances);
            
            renderAdvances();
            updateAdvanceStats();
            clearAdvanceForm();
            
            showNotification('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù„ÙØ©/Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        function renderAdvances() {
            const advancesList = document.getElementById('advancesList');
            if (!advancesList) return;

            advancesList.innerHTML = advances.map(advance => `
                <tr>
                    <td>${advance.date}</td>
                    <td>${advance.type}</td>
                    <td>${advance.employee}</td>
                    <td>${advance.amount.toFixed(2)}</td>
                    <td>${getStatusBadge(advance.status)}</td>
                    <td>${advance.description || '-'}</td>
                    <td>
                        <div class="action-menu-container">
                            <button class="action-menu-btn" onclick="toggleActionMenu(event, ${advance.id})">â‹®</button>
                            <div class="action-menu-content" id="menu-${advance.id}">
                                <a href="#" onclick="event.preventDefault(); editAdvance(${advance.id});">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>
                                <a href="#" onclick="event.preventDefault(); deleteAdvance(${advance.id});" style="color: #dc3545;">ğŸ—‘ï¸ Ø­Ø°Ù</a>
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');

            const miniStat = document.getElementById('miniStatAdvances');
            if (miniStat) {
                miniStat.textContent = advances.length;
            }
        }

        async function clearAdvanceForm() {
            const confirmed = await confirmCancelEdit('#advances');
            if (!confirmed) return;
            
            document.getElementById('advanceDate').value = '';
            document.getElementById('advanceEmployee').value = '';
            document.getElementById('advanceAmount').value = '';
            document.getElementById('advanceDescription').value = '';
            
            const addButton = document.querySelector('#advances .btn-add');
            if (addButton) {
                addButton.textContent = ' Ø¥Ø¶Ø§ÙØ© Ø³Ù„ÙØ©/ Ø¹Ù‡Ø¯Ø©';
                addButton.onclick = addAdvance;
            }
            
            removeEditMode('#advances', '#advances h2', 'ğŸ’µ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatAdvances" class="stat-mini-number">0</span></span>');
        }

        function updateAdvanceStats() {
            const totalAdvancesEl = document.getElementById('totalAdvances');
            const dueAdvancesEl = document.getElementById('dueAdvances');
            const paidAdvancesEl = document.getElementById('paidAdvances');

            if (totalAdvancesEl) {
                const total = advances.reduce((sum, advance) => sum + advance.amount, 0);
                totalAdvancesEl.textContent = total.toFixed(2);
            }

            if (dueAdvancesEl) {
                const due = advances
                    .filter(advance => advance.status === 'Ù…Ø³ØªØ­Ù‚')
                    .reduce((sum, advance) => sum + advance.amount, 0);
                dueAdvancesEl.textContent = due.toFixed(2);
            }

            if (paidAdvancesEl) {
                const paid = advances
                    .filter(advance => advance.status === 'Ù…Ø³Ø¯Ø¯')
                    .reduce((sum, advance) => sum + advance.amount, 0);
                paidAdvancesEl.textContent = paid.toFixed(2);
            }
        }

        function getStatusBadge(status) {
            const badges = {
                'Ù…Ø³ØªØ­Ù‚': '<span style="color: #e74c3c; font-weight: bold;">Ù…Ø³ØªØ­Ù‚</span>',
                'Ù…Ø³Ø¯Ø¯': '<span style="color: #27ae60; font-weight: bold;">Ù…Ø³Ø¯Ø¯</span>',
                'Ø¬Ø²Ø¦ÙŠ': '<span style="color: #f39c12; font-weight: bold;">Ù…Ø³Ø¯Ø¯ Ø¬Ø²Ø¦ÙŠØ§Ù‹</span>'
            };
            return badges[status] || status;
        }

        function editAdvance(id) {
            const advance = advances.find(a => a.id === id);
            if (!advance) return;

            document.getElementById('advanceDate').value = advance.date;
            document.getElementById('advanceType').value = advance.type;
            document.getElementById('advanceEmployee').value = advance.employee;
            document.getElementById('advanceAmount').value = advance.amount;
            document.getElementById('advanceDescription').value = advance.description || '';
            document.getElementById('advanceStatus').value = advance.status;

            const addButton = document.querySelector('#advances .btn-add');
            addButton.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
            addButton.onclick = function() { updateAdvance(id); };

            applyEditMode('#advances', 'advanceEmployee', '#advances h2', `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©: ${advance.employee}`);
        }

        async function updateAdvance(id) {
            const advanceIndex = advances.findIndex(a => a.id === id);
            if (advanceIndex === -1) return;

            const date = document.getElementById('advanceDate').value;
            const type = document.getElementById('advanceType').value;
            const employee = document.getElementById('advanceEmployee').value;
            const amount = parseFloat(document.getElementById('advanceAmount').value);
            const description = document.getElementById('advanceDescription').value;
            const status = document.getElementById('advanceStatus').value;

            advances[advanceIndex] = {
                ...advances[advanceIndex],
                date,
                type,
                employee,
                amount,
                description,
                status
            };

            saveToLocalStorage('advances', advances);
            renderAdvances();
            updateAdvanceStats();
            clearAdvanceForm();

            const addButton = document.querySelector('#advances .btn-add');
            addButton.textContent = ' Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø©/Ø³Ù„ÙØ©';
            addButton.onclick = addAdvance;

            showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„ÙØ©/Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
        
        async function deleteAdvance(id) {
            const confirmed = await showConfirmDialog({
                title: 'âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„ÙØ©/Ø§Ù„Ø¹Ù‡Ø¯Ø©ØŸ',
                type: 'danger',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });

            if (!confirmed) return;

            const advanceIndex = advances.findIndex(a => a.id === id);
            if (advanceIndex === -1) return;

            moveToTrash('advances', advances[advanceIndex]);
            
            advances.splice(advanceIndex, 1);
            saveToLocalStorage('advances', advances);
            
            renderAdvances();
            updateAdvanceStats();
            
            showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ù„ÙØ©/Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // ===== End Advances Functions =====

        function updateSalarySummary() {
            const monthInput = document.getElementById('salaryMonth');
            const targetMonth = monthInput ? monthInput.value : '';
            const dataset = targetMonth ? salaries.filter(s => s.month === targetMonth) : [...salaries];
            const totals = dataset.reduce((acc, salary) => {
                acc.count += 1;
                const basic = normalizeAmount(salary.basic);
                const housing = normalizeAmount(salary.housing);
                const transport = normalizeAmount(salary.transport);
                const otherAllowances = normalizeAmount(salary.otherAllowances);
                const overtime = normalizeAmount(salary.overtime);
                const allowances = typeof salary.allowancesTotal === 'number' ? salary.allowancesTotal : housing + transport + otherAllowances + overtime;
                const gross = typeof salary.gross === 'number' ? salary.gross : basic + allowances;
                const gosiEmployee = normalizeAmount(salary.gosiEmployee);
                const gosiEmployer = normalizeAmount(salary.gosiEmployer);
                const otherDeductions = normalizeAmount(salary.otherDeductions);
                const net = typeof salary.net === 'number' ? salary.net : gross - gosiEmployee - otherDeductions;

                acc.basic += basic;
                acc.allowances += allowances;
                acc.gross += gross;
                acc.gosi += gosiEmployee;
                acc.gosiEmployer += gosiEmployer;
                acc.otherDeductions += otherDeductions;
                acc.net += net;
                return acc;
            }, { count: 0, basic: 0, allowances: 0, gross: 0, gosi: 0, gosiEmployer: 0, otherDeductions: 0, net: 0 });

            const summaryCount = document.getElementById('salarySummaryCount');
            if (summaryCount) summaryCount.textContent = totals.count;
            const summaryBasic = document.getElementById('salarySummaryBasic');
            if (summaryBasic) summaryBasic.textContent = formatCurrency(totals.basic);
            const summaryAllowances = document.getElementById('salarySummaryAllowances');
            if (summaryAllowances) summaryAllowances.textContent = formatCurrency(totals.allowances);
            const summaryGross = document.getElementById('salarySummaryGross');
            if (summaryGross) summaryGross.textContent = formatCurrency(totals.gross);
            const summaryGosi = document.getElementById('salarySummaryGosi');
            if (summaryGosi) summaryGosi.textContent = formatCurrency(totals.gosi);
            const summaryGosiEmployer = document.getElementById('salarySummaryGosiEmployer');
            if (summaryGosiEmployer) summaryGosiEmployer.textContent = formatCurrency(totals.gosiEmployer);
            const summaryOther = document.getElementById('salarySummaryOtherDeductions');
            if (summaryOther) summaryOther.textContent = formatCurrency(totals.otherDeductions);
            const summaryNet = document.getElementById('salarySummaryNet');
            if (summaryNet) summaryNet.textContent = formatCurrency(totals.net);

            const miniStat = document.getElementById('miniStatSalaries');
            if (miniStat) miniStat.textContent = formatCurrency(totals.net);
        }

        // ===== Accounting & Reports Functions =====
        
        // Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        function switchAccountingTab(tabName) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
            document.getElementById('reportsTab').classList.remove('active');
            document.getElementById('accountStatementsTab').classList.remove('active');
            document.getElementById('reportsTabBtn').classList.remove('active');
            document.getElementById('accountStatementsTabBtn').classList.remove('active');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.getElementById(tabName + 'TabBtn').classList.add('active');
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const today = new Date().toISOString().split('T')[0];
            if (tabName === 'accountStatements') {
                document.getElementById('statementFrom').value = today;
                document.getElementById('statementTo').value = today;
            }
        }
        
        // Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨
        function changeStatementType() {
            const statementType = document.getElementById('statementType').value;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            document.getElementById('specificSupplierFilter').style.display = 'none';
            document.getElementById('specificCustomerFilter').style.display = 'none';
            document.getElementById('specificEmployeeFilter').style.display = 'none';
            document.getElementById('taxFilterType').style.display = 'none';
            
            // ğŸª ØªØ­Ø¯ÙŠØ« ÙÙ„ØªØ± Ø§Ù„ÙØ±ÙˆØ¹
            populateBranchFilter();
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
            switch(statementType) {
                case 'suppliers':
                    document.getElementById('specificSupplierFilter').style.display = 'inline-block';
                    populateSpecificSupplierFilter();
                    break;
                case 'customers':
                    document.getElementById('specificCustomerFilter').style.display = 'inline-block';
                    populateSpecificCustomerFilter();
                    break;
                case 'employees':
                    document.getElementById('specificEmployeeFilter').style.display = 'inline-block';
                    populateSpecificEmployeeFilter();
                    break;
                case 'tax':
                    document.getElementById('taxFilterType').style.display = 'inline-block';
                    break;
            }
        }
        
        // Ø¯ÙˆØ§Ù„ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        function populateSpecificSupplierFilter() {
            const select = document.getElementById('specificSupplierFilter');
            select.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>';
            suppliers.forEach(supplier => {
                select.innerHTML += `<option value="${supplier.id}">${supplier.name}</option>`;
            });
        }
        
        function populateSpecificCustomerFilter() {
            const select = document.getElementById('specificCustomerFilter');
            select.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>';
            customers.forEach(customer => {
                select.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
            });
        }
        
        function populateSpecificEmployeeFilter() {
            const select = document.getElementById('specificEmployeeFilter');
            select.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>';
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨
            const employees = [...new Set(salaries.map(s => s.employeeName))];
            employees.forEach(employee => {
                select.innerHTML += `<option value="${employee}">${employee}</option>`;
            });
        }
        
        // ğŸª Ø¯Ø§Ù„Ø© ØªØ¹Ø¨Ø¦Ø© ÙÙ„ØªØ± Ø§Ù„ÙØ±ÙˆØ¹
        function populateBranchFilter() {
            const select = document.getElementById('statementBranchFilter');
            if (!select) return;
            
            const activityBranches = branches.filter(b => b.activityId === currentActivityId);
            
            select.innerHTML = '<option value="all">ğŸª ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>';
            select.innerHTML += '<option value="general_admin">ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>';
            select.innerHTML += '<option value="">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·</option>';
            
            activityBranches.forEach(branch => {
                select.innerHTML += `<option value="${branch.id}">${branch.name}</option>`;
            });
        }
        
        // ğŸª Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
        function filterByBranch(transactions) {
            const branchFilter = document.getElementById('statementBranchFilter').value;
            
            if (branchFilter === 'all') {
                return transactions; // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else if (branchFilter === 'general_admin') {
                return transactions.filter(t => t.branchId === 'general_admin'); // Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø·
            } else if (branchFilter === '') {
                return transactions.filter(t => !t.branchId || t.branchId === ''); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                return transactions.filter(t => t.branchId == branchFilter); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ´Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ±
        function autoRefreshStatement() {
            const statementResults = document.getElementById('statementResults').innerHTML;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙƒØ´Ù Ù…Ø¹Ø±ÙˆØ¶ØŒ Ù†Ø¹ÙŠØ¯ ØªÙˆÙ„ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            if (statementResults && statementResults.trim() !== '') {
                generateAccountStatement();
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨
        function generateAccountStatement() {
            const statementType = document.getElementById('statementType').value;
            const fromDate = document.getElementById('statementFrom').value;
            const toDate = document.getElementById('statementTo').value;
            
            if (!fromDate || !toDate) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØªØ±Ø© Ø²Ù…Ù†ÙŠØ© ØµØ­ÙŠØ­Ø©', 'warning');
                return;
            }
            
            switch(statementType) {
                case 'suppliers':
                    generateSuppliersStatement(fromDate, toDate);
                    break;
                case 'customers':
                    generateCustomersStatement(fromDate, toDate);
                    break;
                case 'employees':
                    generateEmployeesStatement(fromDate, toDate);
                    break;
                case 'bank':
                    generateBankStatement(fromDate, toDate);
                    break;
                case 'cash':
                    generateCashStatement(fromDate, toDate);
                    break;
                case 'tax':
                    generateTaxStatement(fromDate, toDate);
                    break;
            }
        }
        
        // Ø¯Ø§Ù„Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        function generateSuppliersStatement(fromDate, toDate) {
            const specificSupplierId = document.getElementById('specificSupplierFilter').value;
            
            let filteredPurchases = purchases.filter(p => 
                p.date >= fromDate && p.date <= toDate
            );
            
            if (specificSupplierId !== 'all') {
                filteredPurchases = filteredPurchases.filter(p => p.supplierId == specificSupplierId);
            }
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            filteredPurchases = filterByBranch(filteredPurchases);
            
            let totalPurchases = 0;
            let totalPaid = 0;
            let totalRemaining = 0;
            
            let tableHTML = `
                <h3>ğŸ“¦ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h3>
                <table class="account-statement-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                            <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredPurchases.forEach(purchase => {
                const supplier = suppliers.find(s => s.id === purchase.supplierId);
                const totalPaidAmount = getTotalPaid(purchase.id, 'purchase');
                const remaining = purchase.total - totalPaidAmount;
                
                totalPurchases += purchase.total;
                totalPaid += totalPaidAmount;
                totalRemaining += remaining;
                
                tableHTML += `
                    <tr>
                        <td>${purchase.date}</td>
                        <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td>PUR${purchase.number.toString().padStart(3, '0')}</td>
                        <td>${purchase.total.toFixed(2)}</td>
                        <td>${totalPaidAmount.toFixed(2)}</td>
                        <td class="${remaining > 0.01 ? 'remaining-unpaid' : 'remaining-paid'}">${remaining.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            const summaryHTML = `
                <div class="dashboard-cards">
                    <div class="dashboard-card customers">
                        <div class="card-value">${totalPurchases.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                        <div class="card-growth">
                            <span>+8%</span>
                            <span class="growth-icon">ğŸ“¦</span>
                        </div>
                    </div>
                    <div class="dashboard-card profit">
                        <div class="card-value">${totalPaid.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
                        <div class="card-growth">
                            <span>+12%</span>
                            <span class="growth-icon">âœ…</span>
                        </div>
                    </div>
                    <div class="dashboard-card revenue">
                        <div class="card-value">${totalRemaining.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                        <div class="card-growth">
                            <span>${totalRemaining > 0 ? '-5%' : '+15%'}</span>
                            <span class="growth-icon">${totalRemaining > 0 ? 'â³' : 'ğŸ‰'}</span>
                        </div>
                    </div>
                    <div class="dashboard-card sales-today">
                        <div class="card-value">${filteredPurchases.length}</div>
                        <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                        <div class="card-growth">
                            <span>+5%</span>
                            <span class="growth-icon">ğŸ“‹</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statementSummary').innerHTML = summaryHTML;
            document.getElementById('statementResults').innerHTML = tableHTML;
        }
        
        // Ø¯Ø§Ù„Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - Ù…Ø­Ø¯Ù‘Ø«Ø© Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª
        function generateCustomersStatement(fromDate, toDate) {
            const specificCustomerId = document.getElementById('specificCustomerFilter').value;
            
            let filteredSales = sales.filter(s => 
                s.date >= fromDate && s.date <= toDate
            );
            
            if (specificCustomerId !== 'all') {
                filteredSales = filteredSales.filter(s => s.customerId == specificCustomerId);
            }
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            filteredSales = filterByBranch(filteredSales);
            
            let totalSales = 0;
            let totalPaid = 0;
            let totalRemaining = 0;
            
            let tableHTML = `
                <h3>ğŸ‘¥ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù‘Ù†)</h3>
                <table class="account-statement-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                            <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</th>
                            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredSales.forEach(sale => {
                const customer = customers.find(c => c.id === sale.customerId);
                const totalPaidFromPayments = getTotalPaid(sale.id, 'sale');
                const paymentsCount = salePayments.filter(p => p.invoiceId === sale.id).length;
                const remaining = sale.total - totalPaidFromPayments;
                
                totalSales += sale.total;
                totalPaid += totalPaidFromPayments;
                totalRemaining += remaining;
                
                tableHTML += `
                    <tr>
                        <td>${sale.date}</td>
                        <td>${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td>SAL${sale.number.toString().padStart(3, '0')}</td>
                        <td>${sale.total.toFixed(2)}</td>
                        <td>${totalPaidFromPayments.toFixed(2)}</td>
                        <td>${paymentsCount > 0 ? `${paymentsCount} Ø¯ÙØ¹Ø©` : '-'}</td>
                        <td class="${remaining > 0.01 ? 'remaining-unpaid' : 'remaining-paid'}">${remaining.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            const summaryHTML = `
                <div class="dashboard-cards">
                    <div class="dashboard-card customers">
                        <div class="card-value">${totalSales.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                        <div class="card-growth">
                            <span>ğŸ’°</span>
                            <span class="growth-icon">ğŸ“ˆ</span>
                        </div>
                    </div>
                    <div class="dashboard-card profit">
                        <div class="card-value">${totalPaid.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
                        <div class="card-growth">
                            <span>âœ…</span>
                            <span class="growth-icon">ğŸ’µ</span>
                        </div>
                    </div>
                    <div class="dashboard-card revenue">
                        <div class="card-value">${totalRemaining.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                        <div class="card-growth">
                            <span>${totalRemaining > 0 ? 'â³' : 'ğŸ‰'}</span>
                            <span class="growth-icon">${totalRemaining > 0 ? 'âš ï¸' : 'âœ…'}</span>
                        </div>
                    </div>
                    <div class="dashboard-card sales-today">
                        <div class="card-value">${filteredSales.length}</div>
                        <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                        <div class="card-growth">
                            <span>ğŸ“‹</span>
                            <span class="growth-icon">ğŸ”¢</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statementSummary').innerHTML = summaryHTML;
            document.getElementById('statementResults').innerHTML = tableHTML;
        }
        
        // Ø¯Ø§Ù„Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        function generateEmployeesStatement(fromDate, toDate) {
            const specificEmployee = document.getElementById('specificEmployeeFilter').value;
            
            let filteredSalaries = salaries.filter(s => 
                s.month >= fromDate && s.month <= toDate
            );
            
            if (specificEmployee !== 'all') {
                filteredSalaries = filteredSalaries.filter(s => s.employeeName === specificEmployee);
            }
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            filteredSalaries = filterByBranch(filteredSalaries);
            
            let totalBasic = 0;
            let totalAllowances = 0;
            let totalDeductions = 0;
            let totalNet = 0;
            
            let tableHTML = `
                <h3>ğŸ‘· ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
                <table class="account-statement-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø´Ù‡Ø±</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                            <th>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
                            <th>Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</th>
                            <th>Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª</th>
                            <th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredSalaries.forEach(salary => {
                const totalGross = salary.basicSalary + salary.allowances;
                const totalDeduction = salary.gosiEmployee + salary.otherDeductions;
                const netSalary = totalGross - totalDeduction;
                
                totalBasic += salary.basicSalary;
                totalAllowances += salary.allowances;
                totalDeductions += totalDeduction;
                totalNet += netSalary;
                
                tableHTML += `
                    <tr>
                        <td>${salary.month}</td>
                        <td>${salary.employeeName}</td>
                        <td>${salary.basicSalary.toFixed(2)}</td>
                        <td>${salary.allowances.toFixed(2)}</td>
                        <td>${totalDeduction.toFixed(2)}</td>
                        <td>${netSalary.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            const summaryHTML = `
                <div class="dashboard-cards">
                    <div class="dashboard-card customers">
                        <div class="card-value">${totalBasic.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
                        <div class="card-growth">
                            <span>+5%</span>
                            <span class="growth-icon">ğŸ’¼</span>
                        </div>
                    </div>
                    <div class="dashboard-card profit">
                        <div class="card-value">${totalAllowances.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</div>
                        <div class="card-growth">
                            <span>+10%</span>
                            <span class="growth-icon">ğŸ</span>
                        </div>
                    </div>
                    <div class="dashboard-card revenue">
                        <div class="card-value">${totalDeductions.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª</div>
                        <div class="card-growth">
                            <span>-3%</span>
                            <span class="growth-icon">ğŸ“‰</span>
                        </div>
                    </div>
                    <div class="dashboard-card sales-today">
                        <div class="card-value">${totalNet.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµØ§ÙÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨</div>
                        <div class="card-growth">
                            <span>+8%</span>
                            <span class="growth-icon">ğŸ’°</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statementSummary').innerHTML = summaryHTML;
            document.getElementById('statementResults').innerHTML = tableHTML;
        }
        
        // Ø¯Ø§Ù„Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ
        function generateBankStatement(fromDate, toDate) {
            let bankTransactions = [];
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©
            sales.filter(s => s.date >= fromDate && s.date <= toDate && s.paymentMethod === 'bank')
                .forEach(sale => {
                    const customer = customers.find(c => c.id === sale.customerId);
                    bankTransactions.push({
                        date: sale.date,
                        description: `Ù…Ø¨ÙŠØ¹Ø§Øª - ${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
                        reference: `SAL${sale.number.toString().padStart(3, '0')}`,
                        debit: 0,
                        credit: sale.paidAmount || 0,
                        type: 'sale'
                    });
                });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©
            purchases.filter(p => p.date >= fromDate && p.date <= toDate && p.paymentMethod === 'bank')
                .forEach(purchase => {
                    const supplier = suppliers.find(s => s.id === purchase.supplierId);
                    bankTransactions.push({
                        date: purchase.date,
                        description: `Ù…Ø´ØªØ±ÙŠØ§Øª - ${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
                        reference: `PUR${purchase.number.toString().padStart(3, '0')}`,
                        debit: purchase.paidAmount || 0,
                        credit: 0,
                        type: 'purchase'
                    });
                });
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            bankTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let balance = 0;
            let totalDebits = 0;
            let totalCredits = 0;
            
            let tableHTML = `
                <h3>ğŸ¦ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ</h3>
                <table class="account-statement-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                            <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                            <th>Ù…Ø¯ÙŠÙ†</th>
                            <th>Ø¯Ø§Ø¦Ù†</th>
                            <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            bankTransactions.forEach(transaction => {
                balance += transaction.credit - transaction.debit;
                totalDebits += transaction.debit;
                totalCredits += transaction.credit;
                
                tableHTML += `
                    <tr>
                        <td>${transaction.date}</td>
                        <td>${transaction.description}</td>
                        <td>${transaction.reference}</td>
                        <td>${transaction.debit > 0 ? transaction.debit.toFixed(2) : '-'}</td>
                        <td>${transaction.credit > 0 ? transaction.credit.toFixed(2) : '-'}</td>
                        <td class="${balance >= 0 ? 'remaining-paid' : 'remaining-unpaid'}">${balance.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            const summaryHTML = `
                <div class="dashboard-cards">
                    <div class="dashboard-card revenue">
                        <div class="card-value">${totalDebits.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†</div>
                        <div class="card-growth">
                            <span>+7%</span>
                            <span class="growth-icon">ğŸ“¤</span>
                        </div>
                    </div>
                    <div class="dashboard-card customers">
                        <div class="card-value">${totalCredits.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù†</div>
                        <div class="card-growth">
                            <span>+15%</span>
                            <span class="growth-icon">ğŸ“¥</span>
                        </div>
                    </div>
                    <div class="dashboard-card ${balance >= 0 ? 'profit' : 'sales-today'}">
                        <div class="card-value">${balance.toFixed(2)}</div>
                        <div class="card-title">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div>
                        <div class="card-growth">
                            <span>${balance >= 0 ? '+12%' : '-8%'}</span>
                            <span class="growth-icon">${balance >= 0 ? 'ğŸ’°' : 'âš ï¸'}</span>
                        </div>
                    </div>
                    <div class="dashboard-card sales-today">
                        <div class="card-value">${bankTransactions.length}</div>
                        <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</div>
                        <div class="card-growth">
                            <span>+5%</span>
                            <span class="growth-icon">ï¿½</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statementSummary').innerHTML = summaryHTML;
            document.getElementById('statementResults').innerHTML = tableHTML;
        }
        
        // Ø¯Ø§Ù„Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
        function generateCashStatement(fromDate, toDate) {
            let cashTransactions = [];
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
            sales.filter(s => s.date >= fromDate && s.date <= toDate && (s.paymentMethod === 'cash' || !s.paymentMethod))
                .forEach(sale => {
                    const customer = customers.find(c => c.id === sale.customerId);
                    cashTransactions.push({
                        date: sale.date,
                        description: `Ù…Ø¨ÙŠØ¹Ø§Øª Ù†Ù‚Ø¯ÙŠØ© - ${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
                        reference: `SAL${sale.number.toString().padStart(3, '0')}`,
                        debit: 0,
                        credit: sale.paidAmount || 0,
                        type: 'sale'
                    });
                });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
            purchases.filter(p => p.date >= fromDate && p.date <= toDate && (p.paymentMethod === 'cash' || !p.paymentMethod))
                .forEach(purchase => {
                    const supplier = suppliers.find(s => s.id === purchase.supplierId);
                    cashTransactions.push({
                        date: purchase.date,
                        description: `Ù…Ø´ØªØ±ÙŠØ§Øª Ù†Ù‚Ø¯ÙŠØ© - ${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
                        reference: `PUR${purchase.number.toString().padStart(3, '0')}`,
                        debit: purchase.paidAmount || 0,
                        credit: 0,
                        type: 'purchase'
                    });
                });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
            expenses.filter(e => e.date >= fromDate && e.date <= toDate)
                .forEach(expense => {
                    cashTransactions.push({
                        date: expense.date,
                        description: `Ù…ØµØ±ÙˆÙØ§Øª - ${expense.description}`,
                        reference: `EXP${expense.id}`,
                        debit: expense.amount,
                        credit: 0,
                        type: 'expense'
                    });
                });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
            revenues.filter(r => r.date >= fromDate && r.date <= toDate)
                .forEach(revenue => {
                    cashTransactions.push({
                        date: revenue.date,
                        description: `Ø¥ÙŠØ±Ø§Ø¯Ø§Øª - ${revenue.description}`,
                        reference: `REV${revenue.id}`,
                        debit: 0,
                        credit: revenue.amount,
                        type: 'revenue'
                    });
                });
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            cashTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let balance = 0;
            let totalDebits = 0;
            let totalCredits = 0;
            
            let tableHTML = `
                <h3>ğŸ’° ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</h3>
                <table class="account-statement-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                            <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                            <th>Ù…Ø¯ÙŠÙ†</th>
                            <th>Ø¯Ø§Ø¦Ù†</th>
                            <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            cashTransactions.forEach(transaction => {
                balance += transaction.credit - transaction.debit;
                totalDebits += transaction.debit;
                totalCredits += transaction.credit;
                
                tableHTML += `
                    <tr>
                        <td>${transaction.date}</td>
                        <td>${transaction.description}</td>
                        <td>${transaction.reference}</td>
                        <td>${transaction.debit > 0 ? transaction.debit.toFixed(2) : '-'}</td>
                        <td>${transaction.credit > 0 ? transaction.credit.toFixed(2) : '-'}</td>
                        <td class="${balance >= 0 ? 'remaining-paid' : 'remaining-unpaid'}">${balance.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            const summaryHTML = `
                <div class="dashboard-cards">
                    <div class="dashboard-card revenue">
                        <div class="card-value">${totalDebits.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†</div>
                        <div class="card-growth">
                            <span>+9%</span>
                            <span class="growth-icon">ğŸ’¸</span>
                        </div>
                    </div>
                    <div class="dashboard-card customers">
                        <div class="card-value">${totalCredits.toFixed(2)}</div>
                        <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù†</div>
                        <div class="card-growth">
                            <span>+18%</span>
                            <span class="growth-icon">ğŸ’µ</span>
                        </div>
                    </div>
                    <div class="dashboard-card ${balance >= 0 ? 'profit' : 'sales-today'}">
                        <div class="card-value">${balance.toFixed(2)}</div>
                        <div class="card-title">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div>
                        <div class="card-growth">
                            <span>${balance >= 0 ? '+22%' : '-11%'}</span>
                            <span class="growth-icon">${balance >= 0 ? 'ğŸ’°' : 'âš ï¸'}</span>
                        </div>
                    </div>
                    <div class="dashboard-card sales-today">
                        <div class="card-value">${cashTransactions.length}</div>
                        <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</div>
                        <div class="card-growth">
                            <span>+3%</span>
                            <span class="growth-icon">ï¿½</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statementSummary').innerHTML = summaryHTML;
            document.getElementById('statementResults').innerHTML = tableHTML;
        }
        
        // Ø¯Ø§Ù„Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
        function generateTaxStatement(fromDate, toDate) {
            const taxFilter = document.getElementById('taxFilterType').value;
            const TAX_RATE = 0.15; // Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© 15%
            
            let taxTransactions = [];
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            sales.filter(s => s.date >= fromDate && s.date <= toDate).forEach(sale => {
                const customer = customers.find(c => c.id === sale.customerId);
                const hasTax = sale.includeTax || false;
                const baseAmount = hasTax ? sale.total / 1.15 : sale.total;
                const taxAmount = hasTax ? baseAmount * TAX_RATE : 0;
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
                if (taxFilter === 'withTax' && !hasTax) return;
                if (taxFilter === 'withoutTax' && hasTax) return;
                
                taxTransactions.push({
                    date: sale.date,
                    type: 'Ù…Ø¨ÙŠØ¹Ø§Øª',
                    customer: customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                    reference: `SAL${sale.number.toString().padStart(3, '0')}`,
                    baseAmount: baseAmount,
                    taxAmount: taxAmount,
                    total: sale.total,
                    hasTax: hasTax,
                    category: 'sale'
                });
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            purchases.filter(p => p.date >= fromDate && p.date <= toDate).forEach(purchase => {
                const supplier = suppliers.find(s => s.id === purchase.supplierId);
                const hasTax = purchase.includeTax || false;
                const baseAmount = hasTax ? purchase.total / 1.15 : purchase.total;
                const taxAmount = hasTax ? baseAmount * TAX_RATE : 0;
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
                if (taxFilter === 'withTax' && !hasTax) return;
                if (taxFilter === 'withoutTax' && hasTax) return;
                
                taxTransactions.push({
                    date: purchase.date,
                    type: 'Ù…Ø´ØªØ±ÙŠØ§Øª',
                    customer: supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                    reference: `PUR${purchase.number.toString().padStart(3, '0')}`,
                    baseAmount: baseAmount,
                    taxAmount: taxAmount,
                    total: purchase.total,
                    hasTax: hasTax,
                    category: 'purchase'
                });
            });
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            taxTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
            let totalSalesTax = 0;
            let totalPurchasesTax = 0;
            let cumulativeTaxBalance = 0;
            
            let tableHTML = `
                <h3>ğŸ“Š ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%)</h3>
                <table class="account-statement-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
                            <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            taxTransactions.forEach(transaction => {
                // Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù…Ù† Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…ÙˆØ¬Ø¨Ø©
                // Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© ÙÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø³Ø§Ù„Ø¨Ø©
                const taxImpact = transaction.category === 'sale' ? transaction.taxAmount : -transaction.taxAmount;
                cumulativeTaxBalance += taxImpact;
                
                if (transaction.category === 'sale') {
                    totalSalesTax += transaction.taxAmount;
                } else {
                    totalPurchasesTax += transaction.taxAmount;
                }
                
                tableHTML += `
                    <tr>
                        <td>${transaction.date}</td>
                        <td>${transaction.type}</td>
                        <td>${transaction.customer}</td>
                        <td>${transaction.reference}</td>
                        <td>${transaction.baseAmount.toFixed(2)}</td>
                        <td class="${transaction.taxAmount > 0 ? 'remaining-unpaid' : ''}">${transaction.taxAmount.toFixed(2)}</td>
                        <td>${transaction.total.toFixed(2)}</td>
                        <td class="${cumulativeTaxBalance >= 0 ? 'remaining-unpaid' : 'remaining-paid'}">${cumulativeTaxBalance.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            const netTaxDue = totalSalesTax - totalPurchasesTax;
            
            tableHTML += `
                    </tbody>
                    <tfoot>
                        <tr style="font-weight: bold; background: #f5f7fa;">
                            <td colspan="5" style="text-align: left;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª:</td>
                            <td>Ø¶Ø±ÙŠØ¨Ø© Ù…Ø¨ÙŠØ¹Ø§Øª: ${totalSalesTax.toFixed(2)}</td>
                            <td>Ø¶Ø±ÙŠØ¨Ø© Ù…Ø´ØªØ±ÙŠØ§Øª: ${totalPurchasesTax.toFixed(2)}</td>
                            <td class="${netTaxDue >= 0 ? 'remaining-unpaid' : 'remaining-paid'}">ØµØ§ÙÙŠ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${netTaxDue.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            const summaryHTML = `
                <div class="dashboard-cards">
                    <div class="dashboard-card sales-today">
                        <div class="card-value">${totalSalesTax.toFixed(2)}</div>
                        <div class="card-title">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ù…Ø³ØªØ­Ù‚Ø©)</div>
                        <div class="card-growth">
                            <span>ğŸ“¤ Ù„Ù„Ø­ÙƒÙˆÙ…Ø©</span>
                            <span class="growth-icon">â¬†ï¸</span>
                        </div>
                    </div>
                    <div class="dashboard-card profit">
                        <div class="card-value">${totalPurchasesTax.toFixed(2)}</div>
                        <div class="card-title">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ù…Ø¯ÙÙˆØ¹Ø©)</div>
                        <div class="card-growth">
                            <span>ğŸ“¥ Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</span>
                            <span class="growth-icon">â¬‡ï¸</span>
                        </div>
                    </div>
                    <div class="dashboard-card ${netTaxDue >= 0 ? 'revenue' : 'customers'}">
                        <div class="card-value">${netTaxDue.toFixed(2)}</div>
                        <div class="card-title">ØµØ§ÙÙŠ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ${netTaxDue >= 0 ? '(Ù…Ø³ØªØ­Ù‚Ø© Ù„Ù„Ø­ÙƒÙˆÙ…Ø©)' : '(Ù…Ø³ØªØ±Ø¬Ø¹Ø©)'}</div>
                        <div class="card-growth">
                            <span>${netTaxDue >= 0 ? 'ğŸ’¸ ÙŠØ¬Ø¨ Ø§Ù„Ø³Ø¯Ø§Ø¯' : 'ğŸ’° Ø±ØµÙŠØ¯ Ù„ØµØ§Ù„Ø­Ùƒ'}</span>
                            <span class="growth-icon">${netTaxDue >= 0 ? 'âš ï¸' : 'âœ…'}</span>
                        </div>
                    </div>
                    <div class="dashboard-card customers">
                        <div class="card-value">${taxTransactions.length}</div>
                        <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                        <div class="card-growth">
                            <span>ğŸ“‹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                            <span class="growth-icon">ğŸ“Š</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statementSummary').innerHTML = summaryHTML;
            document.getElementById('statementResults').innerHTML = tableHTML;
        }
        
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„ÙƒØ´ÙˆÙ
        function exportStatementToExcel() {
            const statementType = document.getElementById('statementType').value;
            const fromDate = document.getElementById('statementFrom').value;
            const toDate = document.getElementById('statementTo').value;
            
            // Ù…Ù†Ø·Ù‚ ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒØ´Ù Ø¥Ù„Ù‰ Excel
            const table = document.querySelector('#statementResults table');
            if (!table) {
                showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ´Ù Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ CSV
            let csv = '\uFEFF'; // BOM for UTF-8 Excel compatibility
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = [];
                
                cols.forEach(col => {
                    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙˆØ§ØµÙ„
                    let text = col.textContent.trim();
                    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù‚ØªØ¨Ø§Ø³ Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙÙˆØ§ØµÙ„
                    if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                        text = '"' + text.replace(/"/g, '""') + '"';
                    }
                    rowData.push(text);
                });
                
                csv += rowData.join(',') + '\n';
            });
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
            const statementNames = {
                'suppliers': 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†',
                'customers': 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',
                'employees': 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†',
                'bank': 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_Ø§Ù„Ø¨Ù†Ùƒ',
                'cash': 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©',
                'tax': 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©'
            };
            
            const fileName = `${statementNames[statementType] || 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨'}_${fromDate}_${toDate}.csv`;
            
            // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', `ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒØ´Ù Ø¨Ù†Ø¬Ø§Ø­: ${fileName}`, 'success');
            } else {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ', 'error');
            }
        }
        
        function printAccountStatement() {
            const statementResults = document.getElementById('statementResults').innerHTML;
            const statementSummary = document.getElementById('statementSummary').innerHTML;
            
            if (!statementResults) {
                showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ´Ù Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const printContent = `
                <html>
                    <head>
                        <title>ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨</title>
                        <style>
                            body { font-family: 'Tajawal', Arial, sans-serif; direction: rtl; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                            th { background-color: #f8f9fa; }
                            .remaining-unpaid { color: #dc3545; }
                            .remaining-paid { color: #28a745; }
                        </style>
                    </head>
                    <body>
                        ${statementSummary}
                        ${statementResults}
                    </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

console.log('ğŸ” Reached line ~15100 in main script...');

        // ===== Reports Functions =====
        function updateReportItemFilter() {
            const filterType = document.getElementById('reportItemFilter').value;
            const specificItemSelect = document.getElementById('reportSpecificItem');
            if (filterType === 'specific') {
                specificItemSelect.style.display = 'block';
                specificItemSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>';
                items.forEach(item => {
                    specificItemSelect.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                });
            } else {
                specificItemSelect.style.display = 'none';
                specificItemSelect.value = '';
            }
        }
        
        function changeReportType() {
            const reportType = document.getElementById('reportType').value;
            const isInvoiceReport = (reportType === 'sales' || reportType === 'purchases' || reportType === 'sales_returns' || reportType === 'purchase_returns');
            
            // ğŸ”¥ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            document.getElementById('reportResults').innerHTML = '';
            document.getElementById('reportSummary').innerHTML = '';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø£ÙˆÙ„Ø§Ù‹
            const itemFilterDiv = document.getElementById('reportItemFilter').parentElement;
            const specificItemDiv = document.getElementById('reportSpecificItem').parentElement;
            const paymentFilterDiv = document.getElementById('paymentStatusFilter').parentElement;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
            itemFilterDiv.style.display = 'none';
            specificItemDiv.style.display = 'none'; 
            paymentFilterDiv.style.display = 'none';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ± Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            if (isInvoiceReport) {
                itemFilterDiv.style.display = 'block';
                specificItemDiv.style.display = 'block';
            }
            
            if (reportType === 'sales' || reportType === 'purchases') {
                paymentFilterDiv.style.display = 'block';
            }
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù†ÙØ³Ù‡ - Ø³ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "ØµÙ†Ù Ù…Ø­Ø¯Ø¯"
            document.getElementById('reportSpecificItem').style.display = 'none';
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© ÙÙ„ØªØ± Ø§Ù„Ø£ØµÙ†Ø§Ù
            document.getElementById('reportItemFilter').value = 'all';

            const supplierFilter = document.getElementById('reportSupplierFilter');
            const customerFilter = document.getElementById('reportCustomerFilter');

            supplierFilter.style.display = 'none';
            customerFilter.style.display = 'none';

            if (reportType === 'purchases' || reportType === 'purchase_returns') {
                supplierFilter.style.display = 'inline-block';
                supplierFilter.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>';
                suppliers.forEach(supplier => {
                    supplierFilter.innerHTML += `<option value="${supplier.id}">${supplier.name}</option>`;
                });
            } else if (reportType === 'sales' || reportType === 'sales_returns') {
                customerFilter.style.display = 'inline-block';
                customerFilter.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>';
                customers.forEach(customer => {
                    customerFilter.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
                });
            }
            
            // ğŸª ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙˆØ¹
            updateReportBranchFilter();
        }
        
        // ğŸª Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙˆØ¹ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        function updateReportBranchFilter() {
            const branchFilter = document.getElementById('reportBranchFilter');
            if (!branchFilter) return;
            
            const activityBranches = branches.filter(b => b.activityId === currentActivityId);
            
            branchFilter.innerHTML = '<option value="all">ğŸª ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>';
            branchFilter.innerHTML += '<option value="general_admin">ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>';
            branchFilter.innerHTML += '<option value="">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·</option>';
            
            activityBranches.forEach(branch => {
                branchFilter.innerHTML += `<option value="${branch.id}">${branch.name}</option>`;
            });
        }

        // ğŸ”§ Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© (COGS)
        function calculateCOGS(filteredSales) {
            let totalCost = 0;
            
            if (!Array.isArray(filteredSales)) {
                return 0;
            }
            
            filteredSales.forEach(sale => {
                if (sale && Array.isArray(sale.items)) {
                    sale.items.forEach(soldItem => {
                        if (soldItem && soldItem.id) {
                            const masterItem = items.find(item => item.id === soldItem.id);
                            if (masterItem && soldItem.quantity) {
                                const cost = Number(masterItem.cost) || 0;
                                const quantity = Number(soldItem.quantity) || 0;
                                totalCost += quantity * cost;
                            }
                        }
                    });
                }
            });
            
            return totalCost;
        }


function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const fromDate = document.getElementById('reportFrom').value;
    const toDate = document.getElementById('reportTo').value;
    const paymentStatus = document.getElementById('paymentStatusFilter').value;
    const itemFilterType = document.getElementById('reportItemFilter').value;
    const specificItemId = parseInt(document.getElementById('reportSpecificItem').value);
    
    const selectedSupplierId = document.getElementById('reportSupplierFilter').value;
    const selectedCustomerId = document.getElementById('reportCustomerFilter').value;
    const selectedBranchId = document.getElementById('reportBranchFilter').value; // ğŸª ÙÙ„ØªØ± Ø§Ù„ÙØ±Ø¹

    let data = [];
    let reportTitle = '';
    let tableHeaders = '';
    let tableBody = '';
    let summary = {
        count: 0,
        totalAmount: 0,
        totalPaid: 0,
        totalRemaining: 0,
        totalBasic: 0,
        totalAllowances: 0,
        totalGross: 0,
        totalGosiEmployee: 0,
        totalGosiEmployer: 0,
        totalOtherDeductions: 0,
        totalNet: 0
    };

    switch (reportType) {
        case 'balance_sheet': {
            const resultsDiv = document.getElementById('reportResults');
            
            // ğŸ›¡ï¸ Fetch Isolated Opening Balances
            let opening = { cash: 0, bank: 0, inventory: 0 };
            try {
                if (typeof currentActivityId !== 'undefined' && currentActivityId) {
                    const storageKey = 'activity_' + currentActivityId + '_opening_balances';
                    const stored = localStorage.getItem(storageKey);
                    if (stored) opening = JSON.parse(stored);
                }
            } catch (e) { console.error('Error reading opening balances for report:', e); }

            const openingCash = Number(opening.cash) || 0;
            const openingBank = Number(opening.bank) || 0;
            const openingInventory = Number(opening.inventory) || 0;
            
            // 1. Calculate Assets
            const totalSalesPaid = sales.reduce((sum, s) => sum + (s.paidAmount || 0), 0);
            const totalRevenues = revenues.reduce((sum, r) => sum + (r.amount || 0), 0);
            const totalPurchasesPaid = purchases.reduce((sum, p) => sum + (p.paidAmount || 0), 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const totalSalaries = salaries.reduce((sum, s) => sum + (s.netSalary || 0), 0);
            
            const cashOnHand = (totalSalesPaid + totalRevenues + openingCash + openingBank) - (totalPurchasesPaid + totalExpenses + totalSalaries);
            
            const currentInventoryValue = items.reduce((sum, i) => sum + ((i.stock || 0) * (i.cost || 0)), 0);
            const inventoryValue = currentInventoryValue + openingInventory;
            
            const accountsReceivable = sales.reduce((sum, s) => sum + (s.remainingAmount || 0), 0);
            
            const employeeAdvances = advances.filter(a => a.status !== 'Ù…Ø³Ø¯Ø¯').reduce((sum, a) => sum + (a.amount || 0), 0);
            
            const fixedAssets = assets.reduce((sum, a) => {
                 const dep = typeof calculateDepreciation === 'function' ? calculateDepreciation(a) : { bookValue: a.cost };
                 return sum + (dep.bookValue || 0);
            }, 0);
            
            const totalAssets = cashOnHand + inventoryValue + accountsReceivable + employeeAdvances + fixedAssets;
            
            // 2. Calculate Liabilities
            const accountsPayable = purchases.reduce((sum, p) => sum + (p.remainingAmount || 0), 0);
            const totalLiabilities = accountsPayable;
            
            // 3. Calculate Equity
            const totalSales = sales.reduce((sum, s) => sum + (s.total || 0), 0);
            
            let cogs = 0;
            sales.forEach(sale => {
                if (sale.items) {
                    sale.items.forEach(si => {
                        const item = items.find(i => i.id === si.id);
                        if (item) {
                            const baseQty = (si.quantity || 0) * (si.unitFactor || 1);
                            cogs += baseQty * (item.cost || 0);
                        }
                    });
                }
            });
            
            const netProfit = (totalSales + totalRevenues) - (cogs + totalExpenses + totalSalaries);
            const totalEquity = totalAssets - totalLiabilities;
            const capitalOrOpening = totalEquity - netProfit;
            
            resultsDiv.innerHTML = `
                <h3 style="margin-top:20px; text-align:center; color:#2c3e50;">ğŸ“Š Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ© (Balance Sheet)</h3>
                <p style="text-align:center; color:#7f8c8d;">ÙƒÙ…Ø§ ÙÙŠ ${new Date().toLocaleDateString('ar-SA')}</p>
                
                <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px;">
                    <!-- Ø§Ù„Ø£ØµÙˆÙ„ -->
                    <div style="flex: 1; min-width: 300px;">
                        <table class="report-table" style="width:100%; border-collapse:collapse; box-shadow:0 2px 15px rgba(0,0,0,0.05);">
                            <thead>
                                <tr><th colspan="2" style="background:#2c5aa0; color:white; padding:12px; text-align:right;">Ø§Ù„Ø£ØµÙˆÙ„ (Assets)</th></tr>
                            </thead>
                            <tbody>
                                <tr style="background:#f8f9fa;"><td colspan="2" style="padding:8px; font-weight:bold; color:#2c5aa0;">Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©</td></tr>
                                <tr><td style="padding:10px; border-bottom:1px solid #eee;">Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© ÙˆÙ…Ø§ ÙÙŠ Ø­ÙƒÙ…Ù‡Ø§</td><td style="padding:10px; border-bottom:1px solid #eee; font-family:monospace; font-size:1.1em;">${cashOnHand.toFixed(2)}</td></tr>
                                <tr><td style="padding:10px; border-bottom:1px solid #eee;">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</td><td style="padding:10px; border-bottom:1px solid #eee; font-family:monospace; font-size:1.1em;">${inventoryValue.toFixed(2)}</td></tr>
                                <tr><td style="padding:10px; border-bottom:1px solid #eee;">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)</td><td style="padding:10px; border-bottom:1px solid #eee; font-family:monospace; font-size:1.1em;">${accountsReceivable.toFixed(2)}</td></tr>
                                <tr><td style="padding:10px; border-bottom:1px solid #eee;">Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù</td><td style="padding:10px; border-bottom:1px solid #eee; font-family:monospace; font-size:1.1em;">${employeeAdvances.toFixed(2)}</td></tr>
                                
                                <tr style="background:#f8f9fa;"><td colspan="2" style="padding:8px; font-weight:bold; color:#2c5aa0;">Ø§Ù„Ø£ØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©</td></tr>
                                <tr><td style="padding:10px; border-bottom:1px solid #eee;">Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ø§Ù„ØµØ§ÙÙŠ)</td><td style="padding:10px; border-bottom:1px solid #eee; font-family:monospace; font-size:1.1em;">${fixedAssets.toFixed(2)}</td></tr>
                                
                                <tr style="background:#e8f4f8; font-weight:bold;"><td style="padding:12px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„</td><td style="padding:12px; font-family:monospace; font-size:1.2em; color:#2c5aa0;">${totalAssets.toFixed(2)}</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Ø§Ù„Ø®ØµÙˆÙ… ÙˆØ­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© -->
                    <div style="flex: 1; min-width: 300px;">
                        <table class="report-table" style="width:100%; border-collapse:collapse; box-shadow:0 2px 15px rgba(0,0,0,0.05);">
                            <thead>
                                <tr><th colspan="2" style="background:#c0392b; color:white; padding:12px; text-align:right;">Ø§Ù„Ø®ØµÙˆÙ… ÙˆØ­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (Liabilities & Equity)</th></tr>
                            </thead>
                            <tbody>
                                <tr style="background:#fff5f5;"><td colspan="2" style="padding:8px; font-weight:bold; color:#c0392b;">Ø§Ù„Ø®ØµÙˆÙ… (Liabilities)</td></tr>
                                <tr><td style="padding:10px; border-bottom:1px solid #eee;">Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ø¯Ø§Ø¦Ù†Ø©)</td><td style="padding:10px; border-bottom:1px solid #eee; font-family:monospace; font-size:1.1em;">${accountsPayable.toFixed(2)}</td></tr>
                                <tr style="background:#fff0f0; font-weight:bold;"><td style="padding:10px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…</td><td style="padding:10px; font-family:monospace; font-size:1.1em;">${totalLiabilities.toFixed(2)}</td></tr>
                                
                                <tr style="background:#fff5f5;"><td colspan="2" style="padding:8px; font-weight:bold; color:#c0392b;">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (Equity)</td></tr>
                                <tr><td style="padding:10px; border-bottom:1px solid #eee;">Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ / Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ</td><td style="padding:10px; border-bottom:1px solid #eee; font-family:monospace; font-size:1.1em;">${capitalOrOpening.toFixed(2)}</td></tr>
                                <tr><td style="padding:10px; border-bottom:1px solid #eee;">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø§Ù„Ø®Ø³Ø§Ø±Ø©)</td><td style="padding:10px; border-bottom:1px solid #eee; font-family:monospace; font-size:1.1em;">${netProfit.toFixed(2)}</td></tr>
                                <tr style="background:#fff0f0; font-weight:bold;"><td style="padding:10px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</td><td style="padding:10px; font-family:monospace; font-size:1.1em;">${totalEquity.toFixed(2)}</td></tr>
                                
                                <tr style="background:#e8f4f8; font-weight:bold; border-top: 2px solid #333;"><td style="padding:12px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ… ÙˆØ­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</td><td style="padding:12px; font-family:monospace; font-size:1.2em; color:#c0392b;">${(totalLiabilities + totalEquity).toFixed(2)}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            return;
        }

        case 'sales': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª';
            tableHeaders = `<th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ø®ØµÙ…</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>`;
            let src = Array.isArray(sales) ? sales : [];
            data = src.filter(s => (!fromDate || s.date >= fromDate) && (!toDate || s.date <= toDate));
            
            if (selectedCustomerId !== 'all') {
                data = data.filter(s => s.customerId == selectedCustomerId);
            }
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            if (selectedBranchId === 'all') {
                // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹ - Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¡
            } else if (selectedBranchId === '') {
                data = data.filter(s => !s.branchId); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                data = data.filter(s => s.branchId == selectedBranchId); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
            break;
        }
        case 'purchases': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª';
            tableHeaders = `<th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>`;
            let src = Array.isArray(purchases) ? purchases : [];
            data = src.filter(p => (!fromDate || p.date >= fromDate) && (!toDate || p.date <= toDate));

            if (selectedSupplierId !== 'all') {
                data = data.filter(p => p.supplierId == selectedSupplierId);
            }
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            if (selectedBranchId === 'all') {
                // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else if (selectedBranchId === 'general_admin') {
                data = data.filter(p => p.branchId === 'general_admin'); // Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø·
            } else if (selectedBranchId === '') {
                data = data.filter(p => !p.branchId || p.branchId === ''); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                data = data.filter(p => p.branchId == selectedBranchId); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
            break;
        }
        case 'sales_returns': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª';
            tableHeaders = `<th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>`;
            let src = Array.isArray(salesReturns) ? salesReturns : [];
            data = src.filter(r => (!fromDate || r.date >= fromDate) && (!toDate || r.date <= toDate));
            
            if (selectedCustomerId !== 'all') {
                data = data.filter(r => r.customerId == selectedCustomerId);
            }
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            if (selectedBranchId === 'all') {
                // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else if (selectedBranchId === '') {
                data = data.filter(r => !r.branchId); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                data = data.filter(r => r.branchId == selectedBranchId); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
            break;
        }
        case 'purchase_returns': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª';
            tableHeaders = `<th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>`;
            let src = Array.isArray(purchaseReturns) ? purchaseReturns : [];
            data = src.filter(r => (!fromDate || r.date >= fromDate) && (!toDate || r.date <= toDate));

            if (selectedSupplierId !== 'all') {
                data = data.filter(r => r.supplierId == selectedSupplierId);
            }
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            if (selectedBranchId === 'all') {
                // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else if (selectedBranchId === '') {
                data = data.filter(r => !r.branchId); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                data = data.filter(r => r.branchId == selectedBranchId); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
            break;
        }
        case 'expenses': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª';
            tableHeaders = `<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th>`;
            const src = Array.isArray(expenses) ? expenses : [];
            data = src.filter(e => (!fromDate || e.date >= fromDate) && (!toDate || e.date <= toDate));
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            if (selectedBranchId === 'all') {
                // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else if (selectedBranchId === 'general_admin') {
                data = data.filter(e => e.branchId === 'general_admin'); // Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø·
            } else if (selectedBranchId === '') {
                data = data.filter(e => !e.branchId || e.branchId === ''); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                data = data.filter(e => e.branchId == selectedBranchId); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
            break;
        }
        case 'revenues': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª';
            tableHeaders = `<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„Ù…ØµØ¯Ø±</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th>`;
            const src = Array.isArray(revenues) ? revenues : [];
            data = src.filter(r => (!fromDate || r.date >= fromDate) && (!toDate || r.date <= toDate));
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            if (selectedBranchId === 'all') {
                // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else if (selectedBranchId === '') {
                data = data.filter(r => !r.branchId); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                data = data.filter(r => r.branchId == selectedBranchId); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
            break;
        }
        case 'salaries': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨';
            tableHeaders = `<th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th><th>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th><th>Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ GOSI</th><th>Ù…Ø³Ø§Ù‡Ù…Ø© Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„</th><th>Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰</th><th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</th>`;
            const src = Array.isArray(salaries) ? salaries : [];
            data = src.filter(salary => {
                if (!salary) return false;
                const monthValue = salary.month ? `${salary.month}-01` : '';
                const afterFrom = !fromDate || (monthValue && monthValue >= fromDate);
                const beforeTo = !toDate || (monthValue && monthValue <= toDate);
                return afterFrom && beforeTo;
            });
            
            // ğŸª ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
            if (selectedBranchId === 'all') {
                // ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
            } else if (selectedBranchId === 'general_admin') {
                data = data.filter(s => s.branchId === 'general_admin'); // Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø·
            } else if (selectedBranchId === '') {
                data = data.filter(s => !s.branchId || s.branchId === ''); // Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            } else {
                data = data.filter(s => s.branchId == selectedBranchId); // ÙØ±Ø¹ Ù…Ø­Ø¯Ø¯
            }
            break;
        }
        case 'profit_loss': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø©';

            const filteredSales = (Array.isArray(sales) ? sales : [])
                .filter(s => (!fromDate || s.date >= fromDate) && (!toDate || s.date <= toDate));
            const filteredExpenses = (Array.isArray(expenses) ? expenses : [])
                .filter(e => (!fromDate || e.date >= fromDate) && (!toDate || e.date <= toDate));
            const filteredRevenues = (Array.isArray(revenues) ? revenues : [])
                .filter(r => (!fromDate || r.date >= fromDate) && (!toDate || r.date <= toDate));

            const totalSalesRevenue = filteredSales.reduce((sum, sale) => sum + (Number(sale.total) || 0), 0);
            const totalOtherRevenues = filteredRevenues.reduce((sum, revenue) => sum + (Number(revenue.amount) || 0), 0);
            const totalCOGS = calculateCOGS(filteredSales);
            const grossProfit = totalSalesRevenue - totalCOGS;
            const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + (Number(expense.amount) || 0), 0);
            
            // ğŸ”¥ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ: ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„)
            const netProfitFromOperations = grossProfit + totalOtherRevenues - totalExpenses;

            let summaryHtml = `<h3>Ù…Ù„Ø®Øµ ${reportTitle}</h3>
                <p><strong>Ø§Ù„ÙØªØ±Ø© Ù…Ù†:</strong> ${fromDate || 'Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'} <strong>Ø¥Ù„Ù‰:</strong> ${toDate || 'Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'}</p>
                <p><strong>Ø¹Ø¯Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</strong> ${filteredSales.length}</p>
                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</strong> ${filteredExpenses.length}</p>
                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰:</strong> ${filteredRevenues.length}</p>`;
            document.getElementById('reportSummary').innerHTML = summaryHtml;

            let resultsHtml = `
                <h3 style="margin-top:20px;">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø© (Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©)</h3>
                <table style="text-align: right; margin-bottom: 30px;">
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;"><strong>ï¿½ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</strong></td>
                        <td style="padding: 10px; color: var(--success-color); font-weight: bold;">${totalSalesRevenue.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">(-) ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</td>
                        <td style="padding: 10px; color: var(--accent-color);">${totalCOGS.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 2px solid #333; font-size: 1.05em;">
                        <td style="padding: 10px;"><strong>(=) Ù…Ø¬Ù…Ù„ Ø±Ø¨Ø­ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</strong></td>
                        <td style="padding: 10px; font-weight: bold;">${grossProfit.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">ğŸ’¡ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰</td>
                        <td style="padding: 10px; color: var(--success-color);">${totalOtherRevenues.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">(-) Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</td>
                        <td style="padding: 10px; color: var(--accent-color);">${totalExpenses.toFixed(2)}</td>
                    </tr>
                    <tr style="background: ${netProfitFromOperations >= 0 ? 'var(--success-color)' : 'var(--accent-color)'}; color: white; font-size: 1.2em; border-radius: 8px;">
                        <td style="padding: 15px;"><strong>(=) ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</strong></td>
                        <td style="padding: 15px; font-weight: bold;">${netProfitFromOperations.toFixed(2)}</td>
                    </tr>
                </table>`;
            document.getElementById('reportResults').innerHTML = resultsHtml;
            
            // ğŸ”¥ Ø§Ù„Ø¢Ù† Ù†ÙƒÙ…Ù„ Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙƒØ´Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
            let detailedData = [];
            
            // Ø¥Ø¶Ø§ÙØ© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            filteredSales.forEach(sale => {
                detailedData.push({
                    type: 'Ù…Ø¨ÙŠØ¹Ø©',
                    number: `SAL${sale.number.toString().padStart(3, '0')}`,
                    date: sale.date,
                    description: (Array.isArray(customers) ? customers : []).find(c => c.id === sale.customerId)?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                    debit: 0,
                    credit: Number(sale.total) || 0
                });
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
            filteredExpenses.forEach(expense => {
                detailedData.push({
                    type: 'Ù…ØµØ±ÙˆÙ',
                    number: `EXP${expense.number?.toString().padStart(3, '0') || '---'}`,
                    date: expense.date,
                    description: expense.description || 'Ù…ØµØ±ÙˆÙ',
                    debit: Number(expense.amount) || 0,
                    credit: 0
                });
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
            filteredRevenues.forEach(revenue => {
                detailedData.push({
                    type: 'Ø¥ÙŠØ±Ø§Ø¯',
                    number: `REV${revenue.number?.toString().padStart(3, '0') || '---'}`,
                    date: revenue.date,
                    description: revenue.description || 'Ø¥ÙŠØ±Ø§Ø¯ Ø¢Ø®Ø±',
                    debit: 0,
                    credit: Number(revenue.amount) || 0
                });
            });
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            detailedData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒØ´Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
            if (detailedData.length > 0) {
                let detailedTableBody = '';
                detailedData.forEach(item => {
                    detailedTableBody += `<tr>
                        <td>${item.number}</td>
                        <td>${item.date}</td>
                        <td>${item.type}</td>
                        <td>${item.description}</td>
                        <td style="color: var(--accent-color); font-weight: bold;">${item.debit.toFixed(2)}</td>
                        <td style="color: var(--success-color); font-weight: bold;">${item.credit.toFixed(2)}</td>
                    </tr>`;
                });

                document.getElementById('reportTable').innerHTML = `
                    <div style="margin-top: 30px;">
                        <h3>ğŸ“‹ Ø§Ù„ÙƒØ´Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th>Ø§Ù„ÙˆØµÙ</th>
                                    <th style="color: var(--accent-color);">Ù…Ø¯ÙŠÙ†</th>
                                    <th style="color: var(--success-color);">Ø¯Ø§Ø¦Ù†</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${detailedTableBody}
                            </tbody>
                        </table>
                    </div>`;
            } else {
                document.getElementById('reportTable').innerHTML = '<p style="text-align: center; margin-top: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>';
            }
            return;
        }
    }

    if (reportType === 'sales' || reportType === 'purchases') {
        if (paymentStatus === 'paid' || paymentStatus === 'unpaid') {
            data = data.filter(inv => {
                const total = Number(inv.total) || 0;
                const paid = Number(inv.paidAmount) || 0;
                const remaining = total - paid;
                
                if (paymentStatus === 'paid') {
                    return remaining <= 0.01;
                } else {
                    return remaining > 0.01;
                }
            });
        }
    }

    if ((reportType === 'sales' || reportType === 'purchases' || reportType === 'sales_returns' || reportType === 'purchase_returns')
        && itemFilterType === 'specific' && specificItemId) {
        data = data.filter(invoice =>
            Array.isArray(invoice.items) && invoice.items.some(it => it.id === specificItemId)
        );
    }

if (data.length > 0) {
    data.forEach(item => {
        if (reportType === 'sales') {
            const customer = (Array.isArray(customers) ? customers : []).find(c => c.id === item.customerId);
            const subtotal = Number(item.subtotal) || 0;
            const discount = Number(item.discount) || 0;
            const total = Number(item.total) || 0;
            const paid  = Number(item.paidAmount) || 0;
            const remaining = total - paid;
            
            // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            const getPaymentMethodForReport = (method) => {
                switch(method) {
                    case 'cash': return 'ÙƒØ§Ø´';
                    case 'bank': return 'Ø¨Ù†Ùƒ';
                    case 'mixed': return 'Ù…Ø®ØªÙ„Ø·';
                    default: return 'ÙƒØ§Ø´';
                }
            };

            tableBody += `<tr>
                <td>SAL${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                <td>${subtotal > 0 ? subtotal.toFixed(2) : total.toFixed(2)}</td>
                <td>${discount.toFixed(2)}</td>
                <td>${total.toFixed(2)}</td>
                <td>${paid.toFixed(2)}</td>
                <td>${getPaymentMethodForReport(item.paymentMethod)}</td>
                <td class="${Math.abs(remaining) <= 0.01 ? 'remaining-paid' : 'remaining-unpaid'}">${remaining.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;
            summary.totalPaid   += paid;
            summary.totalRemaining += remaining;

        } else if (reportType === 'purchases') {
            const supplier = (Array.isArray(suppliers) ? suppliers : []).find(s => s.id === item.supplierId);
            const total = Number(item.total) || 0;
            const paid  = Number(item.paidAmount) || 0;
            const remaining = total - paid;

            tableBody += `<tr>
                <td>PUR${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                <td>${total.toFixed(2)}</td>
                <td>${paid.toFixed(2)}</td>
                <td class="${Math.abs(remaining) <= 0.01 ? 'remaining-paid' : 'remaining-unpaid'}">${remaining.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;
            summary.totalPaid   += paid;
            summary.totalRemaining += remaining;

        } else if (reportType === 'sales_returns') {
            const customer = (Array.isArray(customers) ? customers : []).find(c => c.id === item.customerId);
            const total = Number(item.total) || 0;
            const originalSale = (Array.isArray(sales) ? sales : []).find(s => s.id === item.saleId);
            const originalInvoiceNumber = originalSale ? `SAL${originalSale.number.toString().padStart(3, '0')}` : '-';

            tableBody += `<tr>
                <td>SR${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                <td>${originalInvoiceNumber}</td>
                <td>${total.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;

        } else if (reportType === 'purchase_returns') {
            const supplier = (Array.isArray(suppliers) ? suppliers : []).find(s => s.id === item.supplierId);
            const total = Number(item.total) || 0;
            const originalPurchase = (Array.isArray(purchases) ? purchases : []).find(p => p.id === item.purchaseId);
            const originalInvoiceNumber = originalPurchase ? `PUR${originalPurchase.number.toString().padStart(3, '0')}` : '-';

            tableBody += `<tr>
                <td>PR${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                <td>${originalInvoiceNumber}</td>
                <td>${total.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;

        } else if (reportType === 'expenses') {
                const amount = Number(item.amount) || 0;
                tableBody += `<tr>
                    <td>${item.date}</td>
                    <td>${item.category}</td>
                    <td>${item.description || '-'}</td>
                    <td>${amount.toFixed(2)}</td>
                </tr>`;
                summary.totalAmount += amount;

            } else if (reportType === 'revenues') {
                const amount = Number(item.amount) || 0;
                tableBody += `<tr>
                    <td>${item.date}</td>
                    <td>${item.category}</td>
                    <td>${getRevenueSourceName(item.source)}</td>
                    <td>${amount.toFixed(2)}</td>
                </tr>`;
                summary.totalAmount += amount;
                } else if (reportType === 'salaries') {
                    const basic = normalizeAmount(item.basic);
                    const housing = normalizeAmount(item.housing);
                    const transport = normalizeAmount(item.transport);
                    const otherAllowances = normalizeAmount(item.otherAllowances);
                    const overtime = normalizeAmount(item.overtime);
                    const allowances = typeof item.allowancesTotal === 'number' ? item.allowancesTotal : housing + transport + otherAllowances + overtime;
                    const gross = typeof item.gross === 'number' ? item.gross : basic + allowances;
                    const gosiEmployee = normalizeAmount(item.gosiEmployee);
                    const gosiEmployer = normalizeAmount(item.gosiEmployer);
                    const otherDeductions = normalizeAmount(item.otherDeductions);
                    const net = typeof item.net === 'number' ? item.net : gross - gosiEmployee - otherDeductions;

                    tableBody += `<tr>
                        <td>${item.employeeName || '-'}</td>
                        <td>${item.month || '-'}</td>
                        <td>${item.jobTitle || '-'}</td>
                        <td>${formatCurrency(basic)}</td>
                        <td>${formatCurrency(allowances)}</td>
                        <td>${formatCurrency(gross)}</td>
                        <td>${formatCurrency(gosiEmployee)}</td>
                        <td>${formatCurrency(gosiEmployer)}</td>
                        <td>${formatCurrency(otherDeductions)}</td>
                        <td>${formatCurrency(net)}</td>
                    </tr>`;

                    summary.totalBasic += basic;
                    summary.totalAllowances += allowances;
                    summary.totalGross += gross;
                    summary.totalGosiEmployee += gosiEmployee;
                    summary.totalGosiEmployer += gosiEmployer;
                    summary.totalOtherDeductions += otherDeductions;
                    summary.totalNet += net;
                    summary.totalAmount += net;
            }
        });
        summary.count = data.length;
    }

    const summaryDiv = document.getElementById('reportSummary');
    let summaryHtml = `<h3>Ù…Ù„Ø®Øµ ${reportTitle}</h3>`;
    if (reportType === 'sales' || reportType === 'purchases') {
        summaryHtml += `
            <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</strong> ${summary.count}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº:</strong> ${summary.totalAmount.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${summary.totalPaid.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${summary.totalRemaining.toFixed(2)}</p>`;
    } else if (reportType === 'sales_returns' || reportType === 'purchase_returns') {
        summaryHtml += `
            <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª:</strong> ${summary.count}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª:</strong> ${summary.totalAmount.toFixed(2)}</p>`;
    } else if (reportType === 'salaries') {
        summaryHtml += `
            <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ÙŠØ±Ø§Øª:</strong> ${summary.count}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</strong> ${summary.totalBasic.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª:</strong> ${summary.totalAllowances.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨:</strong> ${summary.totalGross.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª GOSI Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†:</strong> ${summary.totalGosiEmployee.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³Ø§Ù‡Ù…Ø§Øª Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ GOSI:</strong> ${summary.totalGosiEmployer.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰:</strong> ${summary.totalOtherDeductions.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµØ§ÙÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨:</strong> ${summary.totalNet.toFixed(2)}</p>`;
    } else {
        summaryHtml += `
            <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:</strong> ${summary.count}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº:</strong> ${summary.totalAmount.toFixed(2)}</p>`;
    }
    summaryDiv.innerHTML = summaryHtml;

    const resultsDiv = document.getElementById('reportResults');
    if (tableBody) {
        if (reportType === 'sales' || reportType === 'purchases') {
            if (reportType === 'sales') {
                tableBody += `<tr class="report-total-row">
                    <td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                    <td>-</td>
                    <td>-</td>
                    <td>${summary.totalAmount.toFixed(2)}</td>
                    <td>${summary.totalPaid.toFixed(2)}</td>
                    <td>-</td>
                    <td>${summary.totalRemaining.toFixed(2)}</td>
                </tr>`;
            } else {
                tableBody += `<tr class="report-total-row">
                    <td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                    <td>${summary.totalAmount.toFixed(2)}</td>
                    <td>${summary.totalPaid.toFixed(2)}</td>
                    <td>${summary.totalRemaining.toFixed(2)}</td>
                </tr>`;
            }
        } else if (reportType === 'sales_returns' || reportType === 'purchase_returns') {
            tableBody += `<tr class="report-total-row">
                <td colspan="4">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                <td>${summary.totalAmount.toFixed(2)}</td>
            </tr>`;
        } else if (reportType === 'salaries') {
            tableBody += `<tr class="report-total-row">
                <td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                <td>${summary.totalBasic.toFixed(2)}</td>
                <td>${summary.totalAllowances.toFixed(2)}</td>
                <td>${summary.totalGross.toFixed(2)}</td>
                <td>${summary.totalGosiEmployee.toFixed(2)}</td>
                <td>${summary.totalGosiEmployer.toFixed(2)}</td>
                <td>${summary.totalOtherDeductions.toFixed(2)}</td>
                <td>${summary.totalNet.toFixed(2)}</td>
            </tr>`;
        } else {
            tableBody += `<tr class="report-total-row">
                <td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                <td>${summary.totalAmount.toFixed(2)}</td>
            </tr>`;
        }

        resultsDiv.innerHTML = `
            <h3 style="margin-top:20px;">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
            <table>
                <thead><tr>${tableHeaders}</tr></thead>
                <tbody>${tableBody}</tbody>
            </table>`;
    } else {
        resultsDiv.innerHTML = `<p style="text-align: center; margin-top: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</p>`;
    }
}


        function exportToExcel() {
            const reportTable = document.querySelector("#reportResults table");
            if (!reportTable) {
                showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ±', 'ÙŠØ±Ø¬Ù‰ Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±', 'warning');
                return;
            }

            let csv = [];
            const headers = [];
            reportTable.querySelectorAll("thead th").forEach(header => headers.push(`"${header.innerText}"`));
            csv.push(headers.join(','));

            reportTable.querySelectorAll("tbody tr").forEach(row => {
                const rowData = [];
                row.querySelectorAll("td").forEach(cell => rowData.push(`"${cell.innerText}"`));
                csv.push(rowData.join(','));
            });

            const csvContent = "data:text/csv;charset=utf-8," + '\uFEFF' + csv.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const reportType = document.getElementById('reportType').value;
            link.setAttribute("download", `report_${reportType}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToWeb() {
            const reportResultsHTML = document.getElementById('reportResults').innerHTML;
            const reportSummaryHTML = document.getElementById('reportSummary').innerHTML;

            if (!reportResultsHTML.trim() || reportResultsHTML.includes("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª")) {
                showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ±', 'ÙŠØ±Ø¬Ù‰ Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±', 'warning');
                return;
            }
            
            const reportType = document.getElementById('reportType').value;
            const reportTitle = `ØªÙ‚Ø±ÙŠØ± ${document.querySelector(`#reportType option[value='${reportType}']`).textContent}`;

            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                    <head>
                        <title>${reportTitle}</title>
                        <meta charset="UTF-8">
                        <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">



                        <style>
                            body { font-family: 'Tajawal', sans-serif; direction: rtl; padding: 20px; color: #2c3e50; }
                            h1, h3 { color: #2c5aa0; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 14px; }
                            th, td { border: 1px solid #ddd; padding: 10px; text-align: right; }
                            th { background-color: #2c5aa0; color: white; }
                            tr:nth-child(even) { background-color: #f8f9fa; }
                            .report-summary { border: 1px solid #ddd; border-right: 5px solid #2c5aa0; padding: 15px; margin-bottom: 20px; background: #f8f9fa; border-radius: 8px; }
                            .report-total-row { font-weight: bold; background-color: #34495e; color: white; }
                            .remaining-paid { color: #27ae60; font-weight: bold; }
                            .remaining-unpaid { color: #e74c3c; font-weight: bold; }
                            @media print {
                                body { padding: 10px; }
                                button { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>${reportTitle}</h1>
                        <div class="report-summary">${reportSummaryHTML}</div>
                        ${reportResultsHTML}
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="window.print()" style="padding: 10px 20px; background: #2c5aa0; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-right: 10px;">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </body>
                </html>
            `);
            newWindow.document.close();
        }

        // ===== Data Management Functions =====
        function ensureActivitySelected() {
            if (!currentActivityId) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø´Ø§Ø· Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'warning');
                return false;
            }
            return true;
        }

        async function refreshActivityData() {
            if (!currentActivityId) return;
            initializeApp();
        }

        function updateDataStats() {
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            setText('dataItemsCount', items.length);
            setText('dataCustomersCount', customers.length);
            setText('dataSuppliersCount', suppliers.length);
            setText('dataPurchasesCount', purchases.length);
            setText('dataSalesCount', sales.length);
            setText('dataExpensesCount', expenses.length);
            setText('dataRevenuesCount', revenues.length);
            setText('dataSalariesCount', salaries.length);
            setText('dataStockQuantity', calculateTotalStock());
            const hasActivity = Boolean(currentActivityId);
            let lastBackupText = 'ØºÙŠØ± Ù…ØªØ§Ø­';
            if (hasActivity) {
                const backupKey = getActivityDataKey('lastBackup');
                const lastBackup = backupKey ? localStorage.getItem(backupKey) : null;
                lastBackupText = lastBackup ? new Date(lastBackup).toLocaleDateString('ar-SA') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            }
            setText('dataLastBackup', lastBackupText);
        }

        function exportActivityData() {
            if (!ensureActivitySelected()) return;
            const activity = activities.find(a => a.id == currentActivityId);
            const activityData = { items, customers, suppliers, purchases, sales, expenses, revenues, salaries, salesReturns, purchaseReturns, exportDate: new Date().toISOString(), system: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ', activityName: activity ? activity.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' };
            const dataStr = JSON.stringify(activityData, null, 2);
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([dataStr], {type: 'application/json'}));
            link.download = `Ø§Ù„Ø¯ÙŠÙˆØ§Ù†_${activity ? activity.name.replace(/\s/g, '_') : 'Ø¨ÙŠØ§Ù†Ø§Øª'}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showNotification('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        function exportActivityDataExcel() {
            if (!ensureActivitySelected()) return;
            if (!window.XLSX || !XLSX.utils || typeof XLSX.utils.book_new !== 'function') {
                showNotification('âŒ Ø®Ø·Ø£', 'Ù…ÙƒØªØ¨Ø© Excel ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
                return;
            }

            const activity = activities.find(a => a.id == currentActivityId);
            const workbook = XLSX.utils.book_new();
            const todayISO = new Date().toISOString();
            const todayDate = todayISO.split('T')[0];

            const safeSheetName = (name) => {
                if (!name) return 'Sheet';
                const invalidChars = /[:\\\/?*\[\]]/g;
                const cleaned = name.replace(invalidChars, ' ');
                return cleaned.length > 30 ? cleaned.substring(0, 27) + '...' : cleaned;
            };

            const formatDocNumber = (prefix, number) => {
                if (typeof number === 'number') {
                    return `${prefix}${number.toString().padStart(3, '0')}`;
                }
                return `${prefix}${number || ''}`;
            };

            const formatItemsList = (list) => {
                if (!Array.isArray(list) || list.length === 0) return '';
                return list.map(item => {
                    const name = item && item.name ? item.name : '';
                    const qty = item && typeof item.quantity === 'number' ? item.quantity : 0;
                    const price = item && typeof item.price === 'number' ? item.price : 0;
                    return `${name} x${qty} @${price}`;
                }).join('\n');
            };

            const appendSheet = (rows, title) => {
                const preparedRows = (Array.isArray(rows) && rows.length) ? rows : [{ 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª': '' }];
                const worksheet = XLSX.utils.json_to_sheet(preparedRows);
                XLSX.utils.book_append_sheet(workbook, worksheet, safeSheetName(title));
            };

            const summaryRows = [
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': activity ? activity.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': new Date().toLocaleString('ar-SA') },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': items.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': customers.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': suppliers.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': purchases.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': sales.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': expenses.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': revenues.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': salaries.length }
            ];
            appendSheet(summaryRows, 'Ù…Ù„Ø®Øµ');

            appendSheet(items.map(item => ({
                'Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù': item.code || '',
                'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù': item.name || '',
                'ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡': typeof item.cost === 'number' ? item.cost : Number(item.cost) || 0,
                'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹': typeof item.price === 'number' ? item.price : Number(item.price) || 0,
                'Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ': typeof item.stock === 'number' ? item.stock : Number(item.stock) || 0
            })), 'Ø§Ù„Ø£ØµÙ†Ø§Ù');

            appendSheet(customers.map(customer => ({
                'Ø±Ù…Ø² Ø§Ù„Ø¹Ù…ÙŠÙ„': customer.code || '',
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„': customer.name || '',
                'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„': customer.phone || '',
                'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ': customer.email || '',
                'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†': customer.address || ''
            })), 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡');

            appendSheet(suppliers.map(supplier => ({
                'Ø±Ù…Ø² Ø§Ù„Ù…ÙˆØ±Ø¯': supplier.code || '',
                'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯': supplier.name || '',
                'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„': supplier.phone || '',
                'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ': supplier.email || '',
                'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†': supplier.address || ''
            })), 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†');

            appendSheet(purchases.map(purchase => {
                const supplier = suppliers.find(s => s.id === purchase.supplierId);
                const remaining = (purchase && typeof purchase.remainingAmount === 'number')
                    ? purchase.remainingAmount
                    : (purchase.total || 0) - (purchase.paidAmount || 0);
                return {
                    'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©': formatDocNumber('PUR', purchase.number),
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': purchase.date || '',
                    'Ø§Ù„Ù…ÙˆØ±Ø¯': supplier ? supplier.name : '',
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù': Array.isArray(purchase.items) ? purchase.items.length : 0,
                    'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª': typeof purchase.total === 'number' ? purchase.total : Number(purchase.total) || 0,
                    'Ø§Ù„Ù…Ø¯ÙÙˆØ¹': typeof purchase.paidAmount === 'number' ? purchase.paidAmount : Number(purchase.paidAmount) || 0,
                    'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': remaining,
                    'Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©': formatItemsList(purchase.items),
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': purchase.notes || ''
                };
            }), 'ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');

            appendSheet(sales.map(sale => {
                const customer = customers.find(c => c.id === sale.customerId);
                const remaining = (sale && typeof sale.remainingAmount === 'number')
                    ? sale.remainingAmount
                    : (sale.total || 0) - (sale.paidAmount || 0);
                return {
                    'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©': formatDocNumber('SAL', sale.number),
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': sale.date || '',
                    'Ø§Ù„Ø¹Ù…ÙŠÙ„': customer ? customer.name : '',
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù': Array.isArray(sale.items) ? sale.items.length : 0,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©': typeof sale.total === 'number' ? sale.total : Number(sale.total) || 0,
                    'Ø§Ù„Ù…Ø¯ÙÙˆØ¹': typeof sale.paidAmount === 'number' ? sale.paidAmount : Number(sale.paidAmount) || 0,
                    'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': remaining,
                    'ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©': sale.taxApplied === false ? 'Ù„Ø§' : 'Ù†Ø¹Ù…',
                    'Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©': formatItemsList(sale.items),
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': sale.notes || ''
                };
            }), 'ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');

            appendSheet(expenses.map(expense => ({
                'Ø§Ù„ØªØ§Ø±ÙŠØ®': expense.date || '',
                'Ø§Ù„ØªØµÙ†ÙŠÙ': expense.category || '',
                'Ø§Ù„Ù…Ø¨Ù„Øº': typeof expense.amount === 'number' ? expense.amount : Number(expense.amount) || 0,
                'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹': getPaymentMethodName ? getPaymentMethodName(expense.paymentMethod) : (expense.paymentMethod || ''),
                'Ø§Ù„Ù…Ø±Ø¬Ø¹': expense.reference || '',
                'Ø§Ù„ÙˆØµÙ': expense.description || ''
            })), 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª');

            appendSheet(revenues.map(revenue => ({
                'Ø§Ù„ØªØ§Ø±ÙŠØ®': revenue.date || '',
                'Ø§Ù„ØªØµÙ†ÙŠÙ': revenue.category || '',
                'Ø§Ù„Ù…ØµØ¯Ø±': getRevenueSourceName ? getRevenueSourceName(revenue.source) : (revenue.source || ''),
                'Ø§Ù„Ù…Ø¨Ù„Øº': typeof revenue.amount === 'number' ? revenue.amount : Number(revenue.amount) || 0,
                'Ø§Ù„Ù…Ø±Ø¬Ø¹': revenue.reference || '',
                'Ø§Ù„ÙˆØµÙ': revenue.description || ''
            })), 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª');

            appendSheet(salaries.map(salary => ({
                'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù': salary.employeeName || '',
                'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©': salary.employeeId || '',
                'Ø´Ù‡Ø± Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚': salary.month || '',
                'Ø³Ø¹ÙˆØ¯ÙŠØŸ': salary.isSaudi ? 'Ù†Ø¹Ù…' : 'Ù„Ø§',
                'Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ': typeof salary.basic === 'number' ? salary.basic : Number(salary.basic) || 0,
                'Ø¨Ø¯Ù„ Ø§Ù„Ø³ÙƒÙ†': typeof salary.housing === 'number' ? salary.housing : Number(salary.housing) || 0,
                'Ø¨Ø¯Ù„ Ø§Ù„Ù†Ù‚Ù„': typeof salary.transport === 'number' ? salary.transport : Number(salary.transport) || 0,
                'Ø¨Ø¯Ù„Ø§Øª Ø£Ø®Ø±Ù‰': typeof salary.otherAllowances === 'number' ? salary.otherAllowances : Number(salary.otherAllowances) || 0,
                'Ø³Ø§Ø¹Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©': typeof salary.overtime === 'number' ? salary.overtime : Number(salary.overtime) || 0,
                'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø§ØªØ¨': typeof salary.gross === 'number' ? salary.gross : Number(salary.gross) || 0,
                'Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª (GOSI)': typeof salary.gosiEmployee === 'number' ? salary.gosiEmployee : Number(salary.gosiEmployee) || 0,
                'Ù…Ø³Ø§Ù‡Ù…Ø© Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„ (GOSI)': typeof salary.gosiEmployer === 'number' ? salary.gosiEmployer : Number(salary.gosiEmployer) || 0,
                'Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰': typeof salary.otherDeductions === 'number' ? salary.otherDeductions : Number(salary.otherDeductions) || 0,
                'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨': typeof salary.net === 'number' ? salary.net : Number(salary.net) || 0,
                'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': salary.notes || ''
            })), 'Ø§Ù„Ø±ÙˆØ§ØªØ¨');

            appendSheet(purchaseReturns.map(returnDoc => {
                const supplier = suppliers.find(s => s.id === returnDoc.supplierId);
                return {
                    'Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹': formatDocNumber('PR', returnDoc.number),
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': returnDoc.date || '',
                    'Ø§Ù„Ù…ÙˆØ±Ø¯': supplier ? supplier.name : '',
                    'ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©': formatDocNumber('PUR', returnDoc.originalInvoiceNumber),
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©': typeof returnDoc.total === 'number' ? returnDoc.total : Number(returnDoc.total) || 0,
                    'Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©': formatItemsList(returnDoc.items)
                };
            }), 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');

            appendSheet(salesReturns.map(returnDoc => {
                const customer = customers.find(c => c.id === returnDoc.customerId);
                return {
                    'Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹': formatDocNumber('SR', returnDoc.number),
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': returnDoc.date || '',
                    'Ø§Ù„Ø¹Ù…ÙŠÙ„': customer ? customer.name : '',
                    'ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©': formatDocNumber('SAL', returnDoc.originalInvoiceNumber),
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©': typeof returnDoc.total === 'number' ? returnDoc.total : Number(returnDoc.total) || 0,
                    'Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©': formatItemsList(returnDoc.items)
                };
            }), 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');

            const fileName = `Ø§Ù„Ø¯ÙŠÙˆØ§Ù†_${activity ? activity.name.replace(/\s/g, '_') : 'Ø¨ÙŠØ§Ù†Ø§Øª'}_${todayDate}_Excel.xlsx`;
            XLSX.writeFile(workbook, fileName);
            showNotification('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
        }

        async function importData() {
            if (!ensureActivitySelected()) return;
            
            // Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
            const choice = await new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                
                const dialog = document.createElement('div');
                dialog.style.cssText = 'background: white; padding: 30px; border-radius: 15px; max-width: 400px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';
                dialog.innerHTML = `
                    <h3 style="margin: 0 0 20px 0; color: #333;">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                    <p style="margin: 0 0 25px 0; color: #666; line-height: 1.6;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡:</p>
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <button id="choiceJSON" style="flex: 1; padding: 15px; background: #059669; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                            ğŸ“„ JSON
                        </button>
                        <button id="choiceExcel" style="flex: 1; padding: 15px; background: #0284c7; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                            ğŸ“Š Excel
                        </button>
                    </div>
                    <button id="choiceCancel" style="width: 100%; padding: 12px; background: #e5e7eb; color: #333; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                document.getElementById('choiceJSON').onclick = () => {
                    document.body.removeChild(overlay);
                    resolve('json');
                };
                document.getElementById('choiceExcel').onclick = () => {
                    document.body.removeChild(overlay);
                    resolve('excel');
                };
                document.getElementById('choiceCancel').onclick = () => {
                    document.body.removeChild(overlay);
                    resolve(null);
                };
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                        resolve(null);
                    }
                };
            });
            
            if (choice === 'json') {
                document.getElementById('importFile').click();
            } else if (choice === 'excel') {
                document.getElementById('importExcelFile').click();
            }
        }

         async function handleExcelImport(files) {
            if (!files.length) return;
            if (!ensureActivitySelected()) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ù…ÙƒØªØ¨Ø© XLSX
                    if (typeof XLSX === 'undefined') {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ù…ÙƒØªØ¨Ø© Excel ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
                        return;
                    }
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // ØªØ­ÙˆÙŠÙ„ ÙƒÙ„ ÙˆØ±Ù‚Ø© Ø¥Ù„Ù‰ JSON
                    const importedData = {};
                    const sheetMapping = {
                        'Ø§Ù„Ø£ØµÙ†Ø§Ù': 'items',
                        'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡': 'customers',
                        'Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†': 'suppliers',
                        'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª': 'purchases',
                        'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª': 'sales',
                        'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª': 'expenses',
                        'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª': 'revenues',
                        'Ø§Ù„Ø±ÙˆØ§ØªØ¨': 'salaries',
                        'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª': 'salesReturns',
                        'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª': 'purchaseReturns'
                    };
                    
                    let foundData = false;
                    workbook.SheetNames.forEach(sheetName => {
                        const key = sheetMapping[sheetName] || sheetName;
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        if (jsonData.length > 0) {
                            importedData[key] = jsonData;
                            foundData = true;
                        }
                    });
                    
                    if (!foundData) {
                        showNotification('âŒ Ù…Ù„Ù ÙØ§Ø±Øº', 'Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©', 'error');
                        return;
                    }
                    
                    const confirmed = await showConfirmDialog(
                        'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel',
                        `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${Object.keys(importedData).length} Ø¬Ø¯ÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª.\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØŸ`,
                        'info',
                        'Ù†Ø¹Ù…',
                        'Ø¥Ù„ØºØ§Ø¡'
                    );
                    
                    if (confirmed) {
                        const savePromises = [];
                        const keysToImport = ['items', 'customers', 'suppliers', 'purchases', 'sales', 'expenses', 'revenues', 'salaries', 'salesReturns', 'purchaseReturns'];
                        
                        keysToImport.forEach(key => {
                            if (importedData[key] && Array.isArray(importedData[key])) {
                                savePromises.push(saveToLocalStorage(key, importedData[key]));
                            }
                        });
                        
                        const saveResults = await Promise.all(savePromises);
                        if (savePromises.length && saveResults.some(result => !result)) {
                            showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
                            return;
                        }
                        
                        await refreshActivityData();
                        const importInput = document.getElementById('importExcelFile');
                        if (importInput) {
                            importInput.value = '';
                        }
                        showNotification('âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    }
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel:', error);
                    const importInput = document.getElementById('importExcelFile');
                    if (importInput) {
                        importInput.value = '';
                    }
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ù„Ù', 'error');
                }
            };
            reader.readAsArrayBuffer(files[0]);
        }

         async function handleFileImport(files) { // Ø£Ø¶ÙÙ†Ø§ ÙƒÙ„Ù…Ø© async
     if (!files.length) return;
     if (!ensureActivitySelected()) return;
    const reader = new FileReader();
    reader.onload = async function(e) { // Ø£Ø¶ÙÙ†Ø§ ÙƒÙ„Ù…Ø© async Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹
        try {
            const importedData = JSON.parse(e.target.result);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ù„Ù (ÙŠØ¯Ø¹Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„ÙŠØ¯ÙˆÙŠØ©)
            const isValid = (importedData.system && importedData.system.includes('Ø§Ù„Ø¯ÙŠÙˆØ§Ù†')) || 
                           (importedData.backupType === 'manual') || 
                           (importedData.version && importedData.items);

            if (!isValid) {
                showNotification('âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­', 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù', 'error');
                return;
            }
            
            const confirmed = await showConfirmDialog(
                'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯',
                'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØŸ',
                'info',
                'Ù†Ø¹Ù…',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {

                // Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙØ¸
                const savePromises = [];
                const keysToImport = ['items', 'customers', 'suppliers', 'purchases', 'sales', 'expenses', 'revenues', 'salaries', 'salesReturns', 'purchaseReturns'];

                keysToImport.forEach(key => {
                    if (importedData[key] && Array.isArray(importedData[key])) {
                        // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase
                        savePromises.push(saveToLocalStorage(key, importedData[key]));
                    }
                });

                // Ù†Ù†ØªØ¸Ø± Ø­ØªÙ‰ ØªÙƒØªÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙØ¸
                const saveResults = await Promise.all(savePromises);
                if (savePromises.length && saveResults.some(result => !result)) {
                    showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
                    return;
                }

                await refreshActivityData();
                const importInput = document.getElementById('importFile');
                if (importInput) {
                    importInput.value = '';
                }
                showNotification('âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Firebase Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©', 'success');
            }
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:", error);
            const importInput = document.getElementById('importFile');
            if (importInput) {
                importInput.value = '';
            }
            showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        }
    };
    reader.readAsText(files[0]);
}

        function createBackup() {
            if (!ensureActivitySelected()) return;
            exportActivityData();
            const timestamp = new Date().toISOString();
            const lastBackupKey = getActivityDataKey('lastBackup');
            const reminderKey = getActivityDataKey('lastBackupTimestamp');
            if (lastBackupKey) {
                localStorage.setItem(lastBackupKey, timestamp);
            }
            if (reminderKey) {
                localStorage.setItem(reminderKey, Date.now());
            }
            updateDataStats();
        }

        async function importSampleData() {
            if (!ensureActivitySelected()) return;
            const confirmed = await showConfirmDialog(
                'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©',
                'Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ',
                'info',
                'Ù…ØªØ§Ø¨Ø¹Ø©',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                const sampleItems = [{ id: Date.now() + 1, code: 'IT001', name: 'Ø¬Ù‡Ø§Ø² ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ù…Ø­Ù…ÙˆÙ„', cost: 2000, price: 2500, stock: 10 }];
                const sampleCustomers = [{ id: Date.now() + 2, code: 'CU001', name: 'Ø´Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ©', phone: '0123456789', email: 'info@tech.com', address: 'Ø§Ù„Ø±ÙŠØ§Ø¶' }];
                const sampleSuppliers = [{ id: Date.now() + 3, code: 'SU001', name: 'Ø´Ø±ÙƒØ© Ø§Ù„Ø¥Ù…Ø¯Ø§Ø¯Ø§Øª', phone: '0123456791', email: 'supply@tech.com', address: 'Ø§Ù„Ø¯Ù…Ø§Ù…' }];

                const updatedItems = [...items, ...sampleItems];
                const updatedCustomers = [...customers, ...sampleCustomers];
                const updatedSuppliers = [...suppliers, ...sampleSuppliers];

                const saveResults = await Promise.all([
                    saveToLocalStorage('items', updatedItems),
                    saveToLocalStorage('customers', updatedCustomers),
                    saveToLocalStorage('suppliers', updatedSuppliers)
                ]);

                if (saveResults.some(result => !result)) {
                    showNotification('âŒ Ø®Ø·Ø£', 'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹', 'error');
                    return;
                }

                await refreshActivityData();
                showNotification('âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ', 'success');
            }
        }
async function clearActivityData() {
    if (!ensureActivitySelected()) return;
    const activity = activities.find(a => a.id == currentActivityId);
    const activityName = activity ? activity.name : 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ';
    
    const confirmed1 = await showConfirmDialog(
        'Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
        `ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª "${activityName}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.\n\nâš ï¸ Ø³ÙŠØªÙ… Ø­Ø°Ù:\nâ€¢ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†\nâ€¢ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª\nâ€¢ ğŸ‘¨â€ğŸ’¼ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ø­Ø¶ÙˆØ±\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`,
        'danger',
        'Ù†Ø¹Ù…',
        'Ø¥Ù„ØºØ§Ø¡'
    );
    if (confirmed1) {
        const confirmed2 = await showConfirmDialog(
            'ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ',
            'â›” Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø¬Ø¯Ø§Ù‹ØŸ\n\nÙ‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§!\nØ³ØªÙØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ùˆ LocalStorage.',
            'danger',
            'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
            'Ø¥Ù„ØºØ§Ø¡'
        );
        if (confirmed2) {
            try {
                showLoading('Ø¬Ø§Ø±ÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

                // 1. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© (ØªÙ… Ø¥Ø¶Ø§ÙØ© employees Ù‡Ù†Ø§)
                const dataKeys = [
                    'items', 'customers', 'suppliers', 'purchases', 'sales', 
                    'salesReturns', 'purchaseReturns', 'expenses', 'revenues', 
                    'salaries', 'advances', 'assets', 'branches', 
                    'salePayments', 'purchasePayments', 'journalEntries', 'chartOfAccounts',
                    'employees' // <--- ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                ];
                
                // 2. Ø­Ø°Ù Ù…Ù† Firebase
                if (USE_FIREBASE && window.firebaseAuth?.currentUser && currentActivityId) {
                    const { ref, remove } = window.firebaseModules;
                    const db = window.firebaseDatabase;
                    
                    // Ø­Ø°Ù Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    const deletePromises = dataKeys.map(async (key) => {
                        const path = `activities/${currentActivityId}/${key}`;
                        try {
                            const dataRef = ref(db, path);
                            await remove(dataRef);
                        } catch (error) {
                            console.error(`âŒ ÙØ´Ù„ Ø­Ø°Ù ${key} Ù…Ù† Firebase:`, error);
                        }
                    });

                    // ğŸ”¥ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ù…Ø³ÙŠØ±Ø§Øª Ù…Ù† Firebase (Ù„Ø£Ù†Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©)
                    // Ù†ÙØªØ±Ø¶ Ø£Ù†Ù‡Ø§ Ù…Ø®Ø²Ù†Ø© ØªØ­Øª Ù…Ø³Ø§Ø±Ø§Øª Ø®Ø§ØµØ© Ø£Ùˆ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ Ø¹Ù†Ø¯ Ø­Ø°Ù Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙŠØ³Ù…Ø­
                    // Ù‡Ù†Ø§ Ø³Ù†Ø­Ø§ÙˆÙ„ Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
                    const dynamicPaths = [`activities/${currentActivityId}/attendance`, `activities/${currentActivityId}/payroll`];
                    dynamicPaths.forEach(path => {
                        deletePromises.push(
                            remove(ref(db, path)).catch(e => console.log('Ù…Ø³Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:', path))
                        );
                    });

                    await Promise.all(deletePromises);
                    console.log('ğŸ”¥ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase');
                }
                
                // 3. Ø­Ø°Ù Ù…Ù† LocalStorage (ØªÙ†Ø¸ÙŠÙ Ø¹Ù…ÙŠÙ‚)
                // Ø£. Ø­Ø°Ù Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ©
                dataKeys.forEach(key => {
                    const storageKey = getActivityDataKey(key);
                    if (storageKey) localStorage.removeItem(storageKey);
                });
                
                // Ø¨. ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„ Ù„Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© (attendance_..., payroll_..., locked_...)
                // Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙ„ Ù…ÙØ§ØªÙŠØ­ LocalStorage ÙˆØ­Ø°Ù Ù…Ø§ ÙŠØ®Øµ Ø§Ù„Ù†Ø´Ø§Ø·
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    // Ù†ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙØªØ§Ø­ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù†Ø´Ø§Ø· Ø£Ùˆ ÙŠØ¨Ø¯Ø£ Ø¨Ø¨Ø§Ø¯Ø¦Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±/Ø§Ù„Ø±ÙˆØ§ØªØ¨ (Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ)
                    if (key.includes(currentActivityId) || 
                        key.startsWith(`attendance_`) || 
                        key.startsWith(`payroll_`)) {
                        keysToRemove.push(key);
                    }
                }
                // ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù
                keysToRemove.forEach(k => localStorage.removeItem(k));
                console.log(`ğŸ§¹ ØªÙ… ØªÙ†Ø¸ÙŠÙ ${keysToRemove.length} Ù…ÙØªØ§Ø­ Ø¥Ø¶Ø§ÙÙŠ Ù…Ù† LocalStorage`);

                // Ø­Ø°Ù ØªØ°ÙƒÙŠØ± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                const reminderKey = getActivityDataKey('lastBackupTimestamp');
                if (reminderKey) localStorage.removeItem(reminderKey);
                
                // 4. ØªÙØ±ÙŠØº Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (RAM)
                items = [];
                customers = [];
                suppliers = [];
                purchases = [];
                sales = [];
                expenses = [];
                revenues = [];
                salaries = [];
                employees = []; // <--- ØªÙ… Ø§Ù„ØªÙØ±ÙŠØº
                salesReturns = [];
                purchaseReturns = [];
                advances = [];
                assets = [];
                branches = [];
                salePayments = [];
                purchasePayments = [];
                journalEntries = [];
                chartOfAccounts = []; // Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡ Ù„Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø´ÙŠØ¡ (Ø£Ø¶Ù…Ù† Ø·Ø±ÙŠÙ‚Ø©)
                hideLoading();
                showNotification('âœ… ØªÙ… Ø§Ù„Ù…Ø³Ø­', `ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª "${activityName}" Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…...`, 'success');
                
                setTimeout(() => {
                    location.reload();
                }, 1500);

            } catch (error) {
                hideLoading();
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'error');
            }
        }
    }
}
        // ===== Dashboard Update =====
 function updateDashboard() {
    console.log('ğŸ“Š ğŸ”„ updateDashboard - Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…...');
    
    // ğŸ›¡ï¸ Fetch Isolated Opening Balances
    let opening = { cash: 0, bank: 0, inventory: 0 };
    try {
        if (typeof currentActivityId !== 'undefined' && currentActivityId) {
            const storageKey = 'activity_' + currentActivityId + '_opening_balances';
            const stored = localStorage.getItem(storageKey);
            if (stored) opening = JSON.parse(stored);
        }
    } catch (e) { console.error('Error reading opening balances for dashboard:', e); }

    const openingCash = Number(opening.cash) || 0;
    const openingBank = Number(opening.bank) || 0;
    const openingInventory = Number(opening.inventory) || 0;

    console.log('ğŸ“Š currentActivityId:', currentActivityId);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù:', items?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:', customers?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†:', suppliers?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:', sales?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:', purchases?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:', expenses?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:', revenues?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‡Ø¯:', advances?.length || 0);
    console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆÙ„:', assets?.length || 0);
    
    // ğŸ” ÙØ­Øµ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù†Ø´Ø· Ø­Ø§Ù„ÙŠØ§Ù‹
    const activeSection = document.querySelector('.section.active');
    console.log('ğŸ“ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù†Ø´Ø· Ø­Ø§Ù„ÙŠØ§Ù‹:', activeSection ? activeSection.id : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯');
    
    const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
    const allowEmpty = !currentActivityId && loggedInUser && loggedInUser.role === 'admin';
    
    console.log('ğŸ“Š allowEmpty:', allowEmpty, '| loggedInUser:', loggedInUser?.email);
    
    if (!currentActivityId && !allowEmpty) {
        console.log('âš ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù updateDashboard - Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ù…Ø­Ø¯Ø¯ ÙˆÙ„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙØ§Ø±Øº');
        return;
    }

    const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) {
            const oldValue = el.textContent;
            el.textContent = value;
            console.log(`âœ… ØªØ­Ø¯ÙŠØ« #${id}: "${oldValue}" â†’ "${value}"`);
            
            // ğŸ” ÙØ­Øµ Ø¨Ø¹Ø¯ 100ms Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªØºÙŠÙŠØ± Ø§Ù„Ù‚ÙŠÙ…Ø©
            setTimeout(() => {
                const currentValue = document.getElementById(id)?.textContent;
                if (currentValue !== value.toString()) {
                    console.error(`ğŸš¨ Ø§Ù„Ù‚ÙŠÙ…Ø© ØªØºÙŠØ±Øª! #${id}: "${value}" â†’ "${currentValue}"`);
                }
            }, 100);
        } else {
            console.warn(`âš ï¸ Ø§Ù„Ø¹Ù†ØµØ± #${id} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!`);
        }
    };
   document.getElementById('totalAdvancesHome').textContent = advances.length;
    setText('totalItems', items.length);
    setText('totalCustomers', customers.length);
    setText('totalSuppliers', suppliers.length);
    setText('stockValue', items.reduce((s, i) => s + ((Number(i.stock) || 0) * (Number(i.cost) || 0)), 0).toFixed(2));
    setText('totalSales', sales.reduce((s, i) => s + (Number(i.total) || 0), 0).toFixed(2));
    
    // ğŸ” ØªØ´Ø®ÙŠØµ Ø®Ø§Øµ Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
    console.log('ğŸ›’ ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:');
    console.log('  - Ø¹Ø¯Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:', purchases.length);
    purchases.forEach((p, idx) => {
        console.log(`  - ÙØ§ØªÙˆØ±Ø© ${idx + 1}: Ø±Ù‚Ù…=${p.number}, ØªØ§Ø±ÙŠØ®=${p.date}, Ø¥Ø¬Ù…Ø§Ù„ÙŠ=${p.total}`);
    });
    const totalPurchasesValue = purchases.reduce((s, i) => s + (Number(i.total) || 0), 0);
    console.log(`  - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©: ${totalPurchasesValue.toFixed(2)}`);
    
    setText('totalPurchases', totalPurchasesValue.toFixed(2));
    
    console.log(`  - Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ #totalPurchases: ${document.getElementById('totalPurchases')?.textContent}`);
    
    setText('totalExpensesHome', expenses.reduce((s, e) => s + (Number(e.amount) || 0), 0).toFixed(2));
    setText('totalRevenuesHome', revenues.reduce((s, r) => s + (Number(r.amount) || 0), 0).toFixed(2));
    
    setText('totalStockQuantity', calculateTotalStock());
    
    // ğŸ’° Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ù…ØªØ§Ø­ - Ù…Ø­Ø¯Ù‘Ø« Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª
    // Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ø¯Ø§Ø®Ù„ = Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª) + Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
    const cashFromSalePayments = salePayments.reduce((sum, payment) => sum + (Number(payment.amount) || 0), 0);
    const cashRevenues = revenues.reduce((sum, rev) => sum + (Number(rev.amount) || 0), 0);
    const totalCashIn = cashFromSalePayments + cashRevenues;
    
    // Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ø®Ø§Ø±Ø¬ = Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª) + Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    const cashFromPurchasePayments = purchasePayments.reduce((sum, payment) => sum + (Number(payment.amount) || 0), 0);
    const cashExpenses = expenses.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
    const totalCashOut = cashFromPurchasePayments + cashExpenses;
    
    // Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ = (Ø§Ù„Ø¯Ø§Ø®Ù„ - Ø§Ù„Ø®Ø§Ø±Ø¬) + Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ (Ù†Ù‚Ø¯ÙŠØ© + Ø¨Ù†Ùƒ)
    const availableCash = (totalCashIn - totalCashOut) + openingCash + openingBank;
    
    setText('availableCash', availableCash.toFixed(2));

    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„ (ØµØ§ÙÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ) + Ø§Ù„Ù…Ø®Ø²ÙˆÙ† + Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†
    let fixedAssetsValue = 0;
    if (typeof calculateDepreciation === 'function') {
        fixedAssetsValue = assets.reduce((sum, asset) => {
            const depreciation = calculateDepreciation(asset);
            return sum + depreciation.bookValue;
        }, 0);
    } else {
        // Ø­Ø³Ø§Ø¨ Ù…Ø¨Ø³Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø¯Ø§Ù„Ø© calculateDepreciation Ù…ØªØ§Ø­Ø©
        fixedAssetsValue = assets.reduce((sum, asset) => sum + (Number(asset.cost) || 0), 0);
    }

    // Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠØ© + Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†
    const currentInventoryValue = items.reduce((sum, i) => sum + ((Number(i.stock) || 0) * (Number(i.cost) || 0)), 0);
    const totalInventoryValue = currentInventoryValue + openingInventory;

    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„ = Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© + Ø§Ù„Ù…Ø®Ø²ÙˆÙ† + Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©
    const totalAssetsValue = fixedAssetsValue + totalInventoryValue + availableCash;

    setText('totalAssetsHome', totalAssetsValue.toFixed(2));
    
    console.log('âœ… updateDashboard - Ø§ÙƒØªÙ…Ù„ ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª!');
    console.log('ğŸ“Š Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:');
    console.log('  - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù:', items.length);
    console.log('  - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:', customers.length);
    console.log('  - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†:', suppliers.length);
    console.log('  - Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:', items.reduce((s, i) => s + ((Number(i.stock) || 0) * (Number(i.cost) || 0)), 0).toFixed(2));
    console.log('  - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:', sales.reduce((s, i) => s + (Number(i.total) || 0), 0).toFixed(2));
    console.log('  - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:', purchases.reduce((s, i) => s + (Number(i.total) || 0), 0).toFixed(2));
    
    // ğŸ” ÙØ­Øµ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙŠ DOM ÙØ¹Ù„ÙŠØ§Ù‹
    setTimeout(() => {
        console.log('ğŸ” ÙØ­Øµ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙŠ DOM:');
        console.log('  ğŸ“Š #totalItems.textContent =', document.getElementById('totalItems')?.textContent);
        console.log('  ğŸ“Š #totalCustomers.textContent =', document.getElementById('totalCustomers')?.textContent);
        console.log('  ğŸ“Š #totalSuppliers.textContent =', document.getElementById('totalSuppliers')?.textContent);
        console.log('  ğŸ“Š #totalSales.textContent =', document.getElementById('totalSales')?.textContent);
        console.log('  ğŸ“Š #totalPurchases.textContent =', document.getElementById('totalPurchases')?.textContent);
        
        // ÙØ­Øµ Ø§Ù„Ù€ CSS Ø§Ù„Ù…Ø·Ø¨Ù‚
        const totalItemsEl = document.getElementById('totalItems');
        if (totalItemsEl) {
            const styles = window.getComputedStyle(totalItemsEl);
            console.log('  ğŸ¨ CSS Ù„Ù€ #totalItems:');
            console.log('    - display:', styles.display);
            console.log('    - visibility:', styles.visibility);
            console.log('    - opacity:', styles.opacity);
            console.log('    - color:', styles.color);
            console.log('    - font-size:', styles.fontSize);
        }
    }, 100);
    
    // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
    if (document.getElementById('advanced-dashboard')?.classList.contains('active')) {
        console.log('ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©...');
        if (typeof updateLiveStats === 'function') {
            updateLiveStats();
        } else {
            // ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
            updateAdvancedDashboardCards();
        }
    }
}

// ===== Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© =====
function updateAdvancedDashboardCards() {
    console.log('ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹...');
    
    const today = new Date().toISOString().split('T')[0];
    const currentMonth = new Date().toISOString().slice(0, 7);
    
    console.log('ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…:', today);
    console.log('ğŸ“… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:', currentMonth);
    
    // Ø·Ø¨Ø§Ø¹Ø© ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„ØªØ´Ø®ÙŠØµ
    console.log('ğŸ“Š ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:');
    sales.forEach((s, i) => {
        console.log(`  Ø§Ù„Ø¨ÙŠØ¹ ${i + 1}: ØªØ§Ø±ÙŠØ®="${s.date}", Ø¥Ø¬Ù…Ø§Ù„ÙŠ=${s.total}`);
    });
    
    // Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…
    const todaySales = sales.filter(s => {
        const saleDate = s.date ? s.date.split('T')[0] : ''; // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© ISO
        const isToday = saleDate === today;
        console.log(`  ğŸ” ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ¹: ØªØ§Ø±ÙŠØ®="${s.date}" -> ØªØ§Ø±ÙŠØ® Ù…Ù†Ø³Ù‚="${saleDate}", Ù‡Ù„ Ø§Ù„ÙŠÙˆÙ…ØŸ ${isToday}`);
        return isToday;
    });
    const todaySalesTotal = todaySales.reduce((sum, s) => sum + (Number(s.total) || 0), 0);
    document.getElementById('todaySales').textContent = todaySalesTotal.toFixed(2);
    
    console.log(`âœ… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…: ${todaySales.length} ÙØ§ØªÙˆØ±Ø©ØŒ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${todaySalesTotal.toFixed(2)}`);
    
    // Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…
    const todayPurchases = purchases.filter(p => {
        const purchaseDate = p.date ? p.date.split('T')[0] : '';
        return purchaseDate === today;
    });
    const todayPurchasesTotal = todayPurchases.reduce((sum, p) => sum + (Number(p.total) || 0), 0);
    document.getElementById('todayPurchases').textContent = todayPurchasesTotal.toFixed(2);
    
    // Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…
    const todayExpenses = expenses.filter(e => {
        const expenseDate = e.date ? e.date.split('T')[0] : '';
        return expenseDate === today;
    });
    const todayExpensesTotal = todayExpenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
    document.getElementById('todayExpenses').textContent = todayExpensesTotal.toFixed(2);
    
    // Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…
    const todayRevenues = revenues.filter(r => {
        const revenueDate = r.date ? r.date.split('T')[0] : '';
        return revenueDate === today;
    });
    const todayRevenuesTotal = todayRevenues.reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
    document.getElementById('todayRevenues').textContent = todayRevenuesTotal.toFixed(2);
    
    // Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
    const monthlySales = sales.filter(s => {
        const saleDate = s.date ? s.date.split('T')[0] : '';
        return saleDate.startsWith(currentMonth);
    });
    const monthlySalesTotal = monthlySales.reduce((sum, s) => sum + (Number(s.total) || 0), 0);
    document.getElementById('monthlySales').textContent = monthlySalesTotal.toFixed(2);
    
    // Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
    const monthlyPurchases = purchases.filter(p => {
        const purchaseDate = p.date ? p.date.split('T')[0] : '';
        return purchaseDate.startsWith(currentMonth);
    });
    const monthlyPurchasesTotal = monthlyPurchases.reduce((sum, p) => sum + (Number(p.total) || 0), 0);
    document.getElementById('monthlyPurchases').textContent = monthlyPurchasesTotal.toFixed(2);
    
    // Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
    const monthlyExpenses = expenses.filter(e => {
        const expenseDate = e.date ? e.date.split('T')[0] : '';
        return expenseDate.startsWith(currentMonth);
    });
    const monthlyExpensesTotal = monthlyExpenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
    const monthlyExpensesCard = document.getElementById('monthlyExpensesCard');
    if (monthlyExpensesCard) monthlyExpensesCard.textContent = monthlyExpensesTotal.toFixed(2);
    
    // Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
    const monthlyRevenues = revenues.filter(r => {
        const revenueDate = r.date ? r.date.split('T')[0] : '';
        return revenueDate.startsWith(currentMonth);
    });
    const monthlyRevenuesTotal = monthlyRevenues.reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
    document.getElementById('monthlyRevenues').textContent = monthlyRevenuesTotal.toFixed(2);
    
    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©:');
    console.log('  - Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…:', todaySalesTotal.toFixed(2), `(${todaySales.length} ÙØ§ØªÙˆØ±Ø©)`);
    console.log('  - Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…:', todayPurchasesTotal.toFixed(2), `(${todayPurchases.length} ÙØ§ØªÙˆØ±Ø©)`);
    console.log('  - Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©:', monthlySalesTotal.toFixed(2), `(${monthlySales.length} ÙØ§ØªÙˆØ±Ø©)`);
    console.log('  - Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©:', monthlyPurchasesTotal.toFixed(2), `(${monthlyPurchases.length} ÙØ§ØªÙˆØ±Ø©)`);
}

// ===== Ø¯Ø§Ù„Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Placeholder) =====
function initAdvancedDashboard() {
    // Ø¯Ø§Ù„Ø© ÙØ§Ø±ØºØ© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ - Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ØªÙØ­Ø¯Ø« Ø¨ÙˆØ§Ø³Ø·Ø© updateAdvancedDashboardCards()
    console.log('ğŸ“Š initAdvancedDashboard: ØªÙ… Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ (Ø¯Ø§Ù„Ø© ÙØ§Ø±ØºØ©)');
}

// ğŸ†• ===== Ø¯ÙˆØ§Ù„ ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© =====

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
let salesVsPurchasesChart = null;
let expensesDistributionChart = null;
let topItemsChart = null;
let cashFlowChart = null;

// ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ (KPIs)
function updateKPIs() {
    const currentMonth = new Date().toISOString().slice(0, 7);
    
    // Ø­Ø³Ø§Ø¨ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠ
    const monthlySalesData = sales.filter(s => s.date && s.date.startsWith(currentMonth));
    const monthlyPurchasesData = purchases.filter(p => p.date && p.date.startsWith(currentMonth));
    const monthlyExpensesData = expenses.filter(e => e.date && e.date.startsWith(currentMonth));
    const monthlyRevenuesData = revenues.filter(r => r.date && r.date.startsWith(currentMonth));
    
    const totalSales = monthlySalesData.reduce((sum, s) => sum + (Number(s.total) || 0), 0);
    const totalPurchases = monthlyPurchasesData.reduce((sum, p) => sum + (Number(p.total) || 0), 0);
    const totalExpenses = monthlyExpensesData.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
    const totalRevenues = monthlyRevenuesData.reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
    
    const netProfit = (totalSales + totalRevenues) - (totalPurchases + totalExpenses);
    document.getElementById('kpiNetProfit').textContent = netProfit.toFixed(2);
    
    // Ø­Ø³Ø§Ø¨ Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    const customersDebt = sales.reduce((sum, s) => sum + (Number(s.remainingAmount) || 0), 0);
    const customersWithDebt = sales.filter(s => (Number(s.remainingAmount) || 0) > 0).length;
    document.getElementById('kpiCustomersDebt').textContent = customersDebt.toFixed(2);
    document.getElementById('kpiCustomersCount').textContent = `ğŸ‘¥ ${customersWithDebt} Ø¹Ù…ÙŠÙ„`;
    
    // Ø­Ø³Ø§Ø¨ Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
    const suppliersDebt = purchases.reduce((sum, p) => sum + (Number(p.remainingAmount) || 0), 0);
    const suppliersWithDebt = purchases.filter(p => (Number(p.remainingAmount) || 0) > 0).length;
    document.getElementById('kpiSuppliersDebt').textContent = suppliersDebt.toFixed(2);
    document.getElementById('kpiSuppliersCount').textContent = `ğŸ¢ ${suppliersWithDebt} Ù…ÙˆØ±Ø¯`;
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ù…ØªØ§Ø­ (ØªÙ‚Ø¯ÙŠØ± Ø¨Ø³ÙŠØ·)
    const cashFlow = customersDebt - suppliersDebt;
    document.getElementById('kpiCashFlow').textContent = cashFlow.toFixed(2);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª
    const profitTrend = netProfit >= 0 ? 'ğŸ“ˆ Ø±Ø¨Ø­' : 'ğŸ“‰ Ø®Ø³Ø§Ø±Ø©';
    document.getElementById('kpiNetProfitTrend').textContent = profitTrend;
}

// ØªØ­Ø¯ÙŠØ« Ø±Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª vs Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
function updateSalesVsPurchasesChart() {
    const ctx = document.getElementById('salesVsPurchasesChart');
    if (!ctx) return;
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±
    const months = [];
    const salesData = [];
    const purchasesData = [];
    
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const monthStr = date.toISOString().slice(0, 7);
        
        // Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
        const monthNames = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 
                           'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
        months.push(monthNames[date.getMonth()]);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
        const monthSales = sales
            .filter(s => s.date && s.date.startsWith(monthStr))
            .reduce((sum, s) => sum + (Number(s.total) || 0), 0);
        salesData.push(monthSales);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
        const monthPurchases = purchases
            .filter(p => p.date && p.date.startsWith(monthStr))
            .reduce((sum, p) => sum + (Number(p.total) || 0), 0);
        purchasesData.push(monthPurchases);
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù…
    if (salesVsPurchasesChart) {
        salesVsPurchasesChart.destroy();
    }
    
    salesVsPurchasesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                data: salesData,
                borderColor: '#27ae60',
                backgroundColor: 'rgba(39, 174, 96, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
                data: purchasesData,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: document.body.classList.contains('dark-mode') ? '#e4e6ea' : '#666',
                        font: {
                            family: "'Tajawal', sans-serif"
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: document.body.classList.contains('dark-mode') ? '#b0b3b8' : '#666'
                    },
                    grid: {
                        color: document.body.classList.contains('dark-mode') ? '#3a3b3c' : 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: document.body.classList.contains('dark-mode') ? '#b0b3b8' : '#666'
                    },
                    grid: {
                        color: document.body.classList.contains('dark-mode') ? '#3a3b3c' : 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
}

// ØªØ­Ø¯ÙŠØ« Ø±Ø³Ù… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
function updateExpensesDistributionChart() {
    const ctx = document.getElementById('expensesDistributionChart');
    if (!ctx) return;
    
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
    const categories = {};
    expenses.forEach(e => {
        const category = e.category || 'Ø£Ø®Ø±Ù‰';
        categories[category] = (categories[category] || 0) + (Number(e.amount) || 0);
    });
    
    const labels = Object.keys(categories);
    const data = Object.values(categories);
    
    // Ø£Ù„ÙˆØ§Ù† Ù…ØªÙ†ÙˆØ¹Ø©
    const colors = [
        '#667eea', '#764ba2', '#f093fb', '#f5576c', 
        '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
        '#fa709a', '#fee140'
    ];
    
    // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù…
    if (expensesDistributionChart) {
        expensesDistributionChart.destroy();
    }
    
    expensesDistributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'right'
                }
            }
        }
    });
}

// ØªØ­Ø¯ÙŠØ« Ø±Ø³Ù… Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ø¨ÙŠØ¹Ø§Ù‹
function updateTopItemsChart() {
    const ctx = document.getElementById('topItemsChart');
    if (!ctx) return;
    
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØµÙ†Ù
    const itemSales = {};
    sales.forEach(sale => {
        if (sale.items && Array.isArray(sale.items)) {
            sale.items.forEach(item => {
                const itemName = item.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const itemTotal = (Number(item.price) || 0) * (Number(item.quantity) || 0);
                itemSales[itemName] = (itemSales[itemName] || 0) + itemTotal;
            });
        }
    });
    
    // ØªØ±ØªÙŠØ¨ ÙˆØ£Ø®Ø° Ø£Ø¹Ù„Ù‰ 5
    const sorted = Object.entries(itemSales)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    
    const labels = sorted.map(([name]) => name);
    const data = sorted.map(([, value]) => value);
    
    // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù…
    if (topItemsChart) {
        topItemsChart.destroy();
    }
    
    topItemsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                data: data,
                backgroundColor: [
                    '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'
                ],
                borderRadius: 5
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true
                }
            }
        }
    });
}

// ØªØ­Ø¯ÙŠØ« Ø±Ø³Ù… Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ
function updateCashFlowChart() {
    const ctx = document.getElementById('cashFlowChart');
    if (!ctx) return;
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
    const days = [];
    const cashInData = [];
    const cashOutData = [];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        // Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ…
        const dayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
        days.push(dayNames[date.getDay()]);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„Ø© (Ù…Ø¨ÙŠØ¹Ø§Øª + Ø¥ÙŠØ±Ø§Ø¯Ø§Øª)
        const daySales = sales
            .filter(s => s.date && s.date.split('T')[0] === dateStr)
            .reduce((sum, s) => sum + (Number(s.paidAmount) || 0), 0);
        const dayRevenues = revenues
            .filter(r => r.date && r.date.split('T')[0] === dateStr)
            .reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
        cashInData.push(daySales + dayRevenues);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬Ø© (Ù…Ø´ØªØ±ÙŠØ§Øª + Ù…ØµØ±ÙˆÙØ§Øª)
        const dayPurchases = purchases
            .filter(p => p.date && p.date.split('T')[0] === dateStr)
            .reduce((sum, p) => sum + (Number(p.paidAmount) || 0), 0);
        const dayExpenses = expenses
            .filter(e => e.date && e.date.split('T')[0] === dateStr)
            .reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
        cashOutData.push(dayPurchases + dayExpenses);
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù…
    if (cashFlowChart) {
        cashFlowChart.destroy();
    }
    
    cashFlowChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: days,
            datasets: [{
                label: 'ØªØ¯ÙÙ‚Ø§Øª Ø¯Ø§Ø®Ù„Ø©',
                data: cashInData,
                backgroundColor: '#43e97b',
                borderRadius: 5
            }, {
                label: 'ØªØ¯ÙÙ‚Ø§Øª Ø®Ø§Ø±Ø¬Ø©',
                data: cashOutData,
                backgroundColor: '#f5576c',
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: document.body.classList.contains('dark-mode') ? '#e4e6ea' : '#666',
                        font: {
                            family: "'Tajawal', sans-serif"
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: document.body.classList.contains('dark-mode') ? '#b0b3b8' : '#666'
                    },
                    grid: {
                        color: document.body.classList.contains('dark-mode') ? '#3a3b3c' : 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: document.body.classList.contains('dark-mode') ? '#b0b3b8' : '#666'
                    },
                    grid: {
                        color: document.body.classList.contains('dark-mode') ? '#3a3b3c' : 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
}

// Ø¯Ø§Ù„Ø© Ø´Ø§Ù…Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
function updateAllCharts() {
    console.log('ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©...');
    updateKPIs();
    updateSalesVsPurchasesChart();
    updateExpensesDistributionChart();
    updateTopItemsChart();
    updateCashFlowChart();
    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©');
}
        
        // ========================================
        // ğŸ”¥ Firebase Authentication Functions
        // ========================================
        
        /**
         * ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙÙŠ Firebase Authentication
         */
        async function firebaseCreateUser(email, password, userData) {
            if (!USE_FIREBASE) {
                debugLog('âš ï¸ Firebase Ù…Ø¹Ø·Ù„ - Ø§Ø³ØªØ®Ø¯Ø§Ù… LocalStorage ÙÙ‚Ø·');
                return null;
            }

            try {
                const { createUserWithEmailAndPassword } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                debugLog('ğŸ”¥ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙÙŠ Firebase:', email);
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const firebaseUser = userCredential.user;
                
                debugLog('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase:', firebaseUser.uid);
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ Realtime Database
                await firebaseSaveUserData(firebaseUser.uid, userData);
                
                return firebaseUser;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Firebase:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showNotification('âš ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù…', 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
                } else if (error.code === 'auth/weak-password') {
                    showNotification('âš ï¸ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warning');
                }
                return null;
            }
        }

        /**
         * Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Realtime Database
         */
        async function firebaseSaveUserData(uid, userData) {
            if (!USE_FIREBASE) return;

            try {
                const { ref, set } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙƒÙ€ key Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† UID Ù„ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©
                const sanitizedEmail = userData.email.replace(/[.#$[\]]/g, '_');
                const userRef = ref(db, `users/${sanitizedEmail}`);
                
                // Ø¥Ø²Ø§Ù„Ø© Ø­Ù‚Ù„ password Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ (ÙŠÙØ­ÙØ¸ ÙÙ‚Ø· ÙÙŠ Authentication)
                const { password, ...userDataWithoutPassword } = userData;
                
                await set(userRef, {
                    ...userDataWithoutPassword,
                    firebaseUid: uid,
                    createdAt: userData.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                
                debugLog('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Database');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
            }
        }

        /**
         * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase
         */
        async function firebaseSignIn(email, password) {
            if (!USE_FIREBASE) {
                debugLog('âš ï¸ Firebase Ù…Ø¹Ø·Ù„ - Ø§Ø³ØªØ®Ø¯Ø§Ù… LocalStorage ÙÙ‚Ø·');
                return null;
            }

            try {
                const { signInWithEmailAndPassword } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                debugLog('ğŸ”¥ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Firebase:', email);
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const firebaseUser = userCredential.user;
                
                debugLog('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­:', firebaseUser.uid);
                
                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Database
                let userData = await firebaseGetUserData(firebaseUser.uid);
                
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                if (!userData) {
                    console.log('ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...');
                    userData = await createUserDataFromFirebaseAuth(firebaseUser, 'user', null);
                }
                
                return { firebaseUser, userData };
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Firebase:', error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    return { error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©' };
                } else if (error.code === 'auth/too-many-requests') {
                    return { error: 'ØªÙ… Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹' };
                }
                return { error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' };
            }
        }

        /**
         * Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firebase Database
         */
        async function firebaseGetUserData(uid) {
            if (!USE_FIREBASE) return null;

            try {
                const { ref, get } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                // Ø£ÙˆÙ„Ø§Ù‹: Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… UID
                let userRef = ref(db, `users/${uid}`);
                let snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù€ UID ÙÙŠ Database');
                    return snapshot.val();
                }
                
                // Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ØŒ Ø§Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù† Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù€ UID
                const usersRef = ref(db, 'users');
                const usersSnapshot = await get(usersRef);
                
                if (usersSnapshot.exists()) {
                    const allUsers = usersSnapshot.val();
                    
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ù€ UID
                    for (const [key, userData] of Object.entries(allUsers)) {
                        if (userData && (userData.firebaseUid === uid || userData.id === uid)) {
                            console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù€ key: ${key}`);
                            return userData;
                        }
                    }
                }
                
                console.log('ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Database - Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹');
                return null;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                return null;
            }
        }

        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Database ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Auth
         */
        async function createUserDataFromFirebaseAuth(firebaseUser, role = 'user', activityId = null) {
            if (!USE_FIREBASE || !window.firebaseDatabase) return null;

            try {
                const { ref, set } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                console.log('ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...');
                
                const userData = {
                    id: firebaseUser.uid,
                    name: firebaseUser.displayName || firebaseUser.email.split('@')[0], // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯
                    email: firebaseUser.email,
                    phone: firebaseUser.phoneNumber || '',
                    role: role,
                    activityId: activityId,
                    firebaseUid: firebaseUser.uid,
                    createdAt: new Date().toISOString(),
                    createdBy: 'system-auto'
                };
                
                const userRef = ref(db, `users/${firebaseUser.uid}`);
                await set(userRef, userData);
                
                console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:', userData);
                return userData;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©:', error);
                return null;
            }
        }

        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Firebase Authentication + Database
         */
        async function createFirstSystemAdmin(email, password, name, phone = '') {
            if (!USE_FIREBASE) return null;

            try {
                const { createUserWithEmailAndPassword } = window.firebaseModules;
                const { ref, set } = window.firebaseModules;
                const auth = window.firebaseAuth;
                const db = window.firebaseDatabase;
                
                console.log('ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„...');
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const firebaseUser = userCredential.user;
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙŠ Database
                const adminData = {
                    id: firebaseUser.uid,
                    name: name,
                    email: email,
                    password: password, // Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                    phone: phone,
                    role: 'admin',
                    activityId: null, // Ø§Ù„Ù…Ø¯ÙŠØ± Ù„ÙŠØ³ Ù…Ø±ØªØ¨Ø· Ø¨Ù†Ø´Ø§Ø· Ù…Ø­Ø¯Ø¯
                    firebaseUid: firebaseUser.uid,
                    createdAt: new Date().toISOString(),
                    createdBy: 'system'
                };
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase Database
                const userRef = ref(db, `users/${firebaseUser.uid}`);
                await set(userRef, adminData);
                
                console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                
                return { firebaseUser, userData: adminData };
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…:', error);
                if (error.code === 'auth/email-already-in-use') {
                    return { error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„. Ø¥Ø°Ø§ ÙƒÙ†Øª Ù‚Ø¯ Ø­Ø°ÙØª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¨Ù‚Ø§Ù‹ØŒ Ø­Ø§ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¢Ø®Ø±.' };
                } else if (error.code === 'auth/weak-password') {
                    return { error: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹' };
                } else if (error.code === 'auth/invalid-email') {
                    return { error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­' };
                }
                return { error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨' };
            }
        }

        /**
         * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆÙ„
         */
        async function checkForFirstSetup() {
            console.log('ğŸ” checkForFirstSetup: Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ');
            
            if (!USE_FIREBASE) {
                console.log('âš ï¸ Firebase Ù…Ø¹Ø·Ù„');
                return false;
            }

            try {
                const { ref, get } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                console.log('ğŸ“Š ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...');
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                
                if (!snapshot.exists()) {
                    console.log('ğŸš€ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† - Ø¥Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„');
                    return true; // ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„ÙŠ
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¯ÙŠØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
                const usersData = snapshot.val();
                console.log('ğŸ‘¥ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', Object.keys(usersData).length, 'Ù…Ø³ØªØ®Ø¯Ù…');
                
                const admins = Object.values(usersData).filter(user => user && user.role === 'admin');
                console.log('ğŸ‘‘ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†:', admins.length);
                
                if (admins.length === 0) {
                    console.log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù… - Ø¥Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ±');
                    return true;
                }
                
                console.log('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„ - ÙŠÙˆØ¬Ø¯', admins.length, 'Ù…Ø¯ÙŠØ±');
                return false; // Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ:', error);
                return false;
            }
        }

        /**
         * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase
         */
        async function firebaseSignOut() {
            if (!USE_FIREBASE) return;

            try {
                const { signOut } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                await signOut(auth);
                debugLog('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:', error);
            }
        }

        /**
         * Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Firebase
         */
        async function firebaseGetActivityData(activityId, dataType) {
            if (!USE_FIREBASE) return null;

            try {
                console.log(`ğŸ” Firebase: Ø¬Ù„Ø¨ ${dataType} Ù„Ù„Ù†Ø´Ø§Ø· ${activityId}`);
                
                const { ref, get } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                const dataRef = ref(db, `activities/${activityId}/${dataType}`);
                console.log(`ğŸ“ Firebase Path: activities/${activityId}/${dataType}`);
                
                const snapshot = await get(dataRef);
                
                console.log(`ğŸ” snapshot.exists() = ${snapshot.exists()}`);
                if (snapshot.exists()) {
                    const dataObject = snapshot.val();
                    console.log(`ğŸ” Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù… Ù…Ù† Firebase Ù„Ù€ ${dataType}:`, dataObject);
                    console.log(`ğŸ” Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${typeof dataObject}`);
                    console.log(`ğŸ” Ù‡Ù„ Ù‡Ùˆ Ù…ØµÙÙˆÙØ©ØŸ ${Array.isArray(dataObject)}`);
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
                    let dataArray;
                    if (Array.isArray(dataObject)) {
                        dataArray = dataObject;
                    } else if (typeof dataObject === 'object' && dataObject !== null) {
                        dataArray = Object.values(dataObject);
                    } else {
                        dataArray = [];
                    }
                    
                    console.log(`ğŸ” Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù€ ${dataType}:`, dataArray);
                    console.log(`âœ… Firebase: ÙˆÙØ¬Ø¯ ${dataArray.length} Ø¹Ù†ØµØ± Ù…Ù† ${dataType}`);
                    return dataArray;
                } else {
                    debugLog(`âš ï¸ Firebase: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ${dataType} - Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† LocalStorage`);
                    return [];
                }
            } catch (error) {
                console.error(`âŒ Firebase Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ${dataType} Ù„Ù„Ù†Ø´Ø§Ø· ${activityId}:`, error);
                console.error(`âŒ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:`, error.message, error.code);
                console.error(`âŒ Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† LocalStorage Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ`);
                return null;
            }
        }

        /**
         * Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase
         */
        async function firebaseSaveActivityData(activityId, dataType, data) {
            if (!USE_FIREBASE) {
                console.log('âš ï¸ Firebase ØºÙŠØ± Ù…ÙØ¹Ù„');
                return false;
            }

            try {
                const { ref, set } = window.firebaseModules;
                const db = window.firebaseDatabase;
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµÙÙˆÙØ©
                if (!Array.isArray(data)) {
                    console.error(`âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙŠØ³Øª Ù…ØµÙÙˆÙØ©: ${dataType}`, typeof data);
                    return false;
                }
                
                console.log(`ğŸ”¥ Firebase: Ø¨Ø¯Ø¡ Ø­ÙØ¸ ${dataType} (${data.length} Ø¹Ù†ØµØ±) Ù„Ù„Ù†Ø´Ø§Ø· ${activityId}`);
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù†
                const dataObject = {};
                data.forEach((item, index) => {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… id Ø§Ù„ÙØ±ÙŠØ¯ Ù„ÙƒÙ„ Ø¹Ù†ØµØ±ØŒ Ù…Ø¹ fallback Ø¢Ù…Ù†
                    const itemId = item.id || item.number || `${Date.now()}_${index}`;
                    dataObject[itemId] = item;
                });
                
                console.log(`ğŸ”¥ Firebase: ØªÙ… ØªØ­ÙˆÙŠÙ„ ${Object.keys(dataObject).length} Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù†`);
                
                const dataRef = ref(db, `activities/${activityId}/${dataType}`);
                await set(dataRef, dataObject);
                
                console.log(`âœ… Firebase: ØªÙ… Ø­ÙØ¸ ${dataType} Ø¨Ù†Ø¬Ø§Ø­`);
                debugLog(`âœ… ØªÙ… Ø­ÙØ¸ ${dataType} ÙÙŠ Firebase`);
                return true;
            } catch (error) {
                console.error(`âŒ Firebase: Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ${dataType}:`, error);
                console.error(`âŒ Firebase: ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:`, error.message, error.code);
                return false;
            }
        }

        // ===== Login System Functions =====
        let loginInProgress = false;
        
        // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø¹Ø§Ù…Ø© (global) ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ù† onclick
        window.handleLogin = async function() {
            if (loginInProgress) {
                return;
            }
            loginInProgress = true;
            const errorMsg = document.getElementById('login-error');
            const email = document.getElementById('loginEmail').value.trim();
            const pass = document.getElementById('loginPassword').value;

            if (!email || !pass) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'warning');
                loginInProgress = false;
                return;
            }

    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
    errorMsg.style.display = 'none';

    try {
        let user = null;
        
        // ========================================
        // ğŸ”¥ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 1: Firebase Authentication
        // ========================================
        if (USE_FIREBASE) {
            debugLog('ğŸ”¥ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Firebase...');
            const firebaseResult = await firebaseSignIn(email, pass);
            
            if (firebaseResult && !firebaseResult.error && firebaseResult.userData) {
                debugLog('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ø¨Ø± Firebase');
                user = firebaseResult.userData;
            user.firebaseUid = firebaseResult.firebaseUser.uid;
            window.currentUser = user; // <--- ğŸ”¥ Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ù†Ø§

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Firebase ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Firebase ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                try {
                    const { ref, get } = window.firebaseModules;
                    const db = window.firebaseDatabase;
                    
                    const usersRef = ref(db, 'users');
                    const usersSnapshot = await get(usersRef);
                    
                    if (usersSnapshot.exists()) {
                        const usersData = usersSnapshot.val();
                        const rawUsers = Object.values(usersData)
                            .filter(u => u && u.id && u.email);
                        
                        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                        const uniqueUsersMap = new Map();
                        rawUsers.forEach(u => {
                            const existing = uniqueUsersMap.get(u.email);
                            if (!existing || (u.createdAt && u.createdAt > existing.createdAt)) {
                                uniqueUsersMap.set(u.email, {
                                    id: u.id,
                                    name: u.name,
                                    email: u.email,
                                    phone: u.phone || '', // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ø¬ÙˆØ§Ù„
                                    password: u.password,
                                    role: u.role,
                                    activityId: u.activityId,
                                    firebaseUid: u.firebaseUid,
                                    createdAt: u.createdAt
                                });
                            }
                        });
                        
                        // Ø¯Ù…Ø¬ Ø°ÙƒÙŠ: Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…ÙØ­Ø¯Ø«Ø©
                        const localUsers = loadFromLocalStorage('diwan_users') || [];
                        console.log('ğŸ”„ Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...');
                        console.log('ğŸ“Š Firebase users:', Array.from(uniqueUsersMap.values()).length);
                        console.log('ğŸ“Š Local users:', localUsers.length);
                        
                        // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Firebase ÙƒØ£Ø³Ø§Ø³ + Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…ÙØ­Ø¯Ø«Ø©
                        const mergedUsersMap = new Map();
                        
                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ø£ÙˆÙ„Ø§Ù‹
                        Array.from(uniqueUsersMap.values()).forEach(user => {
                            mergedUsersMap.set(user.email, user);
                        });
                        
                        // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªÙƒÙˆÙ† Ø£Ø­Ø¯Ø«)
                        localUsers.forEach(localUser => {
                            const firebaseUser = mergedUsersMap.get(localUser.email);
                            if (firebaseUser) {
                                // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø£Ø­Ø¯Ø«
                                const mergedUser = {
                                    ...firebaseUser,
                                    // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©
                                    name: localUser.name || firebaseUser.name,
                                    phone: localUser.phone || firebaseUser.phone,
                                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ù„ÙŠ Ø£Ø­Ø¯Ø«ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                                    ...(localUser.updatedAt && localUser.updatedAt > firebaseUser.updatedAt ? {
                                        name: localUser.name,
                                        phone: localUser.phone,
                                        updatedAt: localUser.updatedAt
                                    } : {})
                                };
                                mergedUsersMap.set(localUser.email, mergedUser);
                                
                                if (localUser.phone && !firebaseUser.phone) {
                                    console.log(`ğŸ”„ Ø¯Ù…Ø¬: Ø§Ø­ØªÙØ¸ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù€ ${localUser.email}: ${localUser.phone}`);
                                }
                            } else {
                                // Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·
                                mergedUsersMap.set(localUser.email, localUser);
                            }
                        });
                        
                        users = Array.from(mergedUsersMap.values());
                        localStorage.setItem('diwan_users', JSON.stringify(users));
                        debugLog(`âœ… ØªÙ… Ø¯Ù…Ø¬ ${users.length} Ù…Ø³ØªØ®Ø¯Ù… (Firebase + Local)`);
                        
                        // ØªØ´Ø®ÙŠØµ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…ÙˆØ¬Ø©
                        const usersWithPhone = users.filter(u => u.phone);
                        console.log(`ğŸ“± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø£Ø±Ù‚Ø§Ù… Ø¬ÙˆØ§Ù„: ${usersWithPhone.length}`);
                        usersWithPhone.forEach(u => {
                            console.log(`  ğŸ“± ${u.email}: ${u.phone}`);
                        });
                    }
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', error);
                }
            } else if (firebaseResult && firebaseResult.error) {
                hideLoading();
                errorMsg.textContent = firebaseResult.error;
                errorMsg.style.display = 'block';
                return;
            }
        }
        
        // ========================================
        // ğŸ“¦ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 2: LocalStorage (Fallback)
        // ========================================
        if (!user) {
            debugLog('ğŸ“¦ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± LocalStorage...');
            const savedUsers = loadFromLocalStorage('diwan_users') || [];
            users = savedUsers;
          user = users.find(u => u.email === email && u.password === pass);
        window.currentUser = user; // <--- ğŸ”¥ ÙˆØ£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ù†Ø§

        if (!user) {
                hideLoading();
                errorMsg.textContent = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                errorMsg.style.display = 'block';
                return;
            }
            
            debugLog('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ø¨Ø± LocalStorage');
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ù† Firebase Ø£Ùˆ LocalStorage
        if (USE_FIREBASE) {
            try {
                const firebaseActivities = await firebaseLoadActivitiesDirectly();
                if (firebaseActivities && firebaseActivities.length > 0) {
                    activities = firebaseActivities;
                    // Ø­ÙØ¸ ÙÙŠ LocalStorage
                    localStorage.setItem('diwan_activities', JSON.stringify(activities));
                    debugLog(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${activities.length} Ù†Ø´Ø§Ø· Ù…Ù† Firebase`);
                } else {
                    activities = loadFromLocalStorage('diwan_activities') || [];
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©:', error);
                activities = loadFromLocalStorage('diwan_activities') || [];
            }
        } else {
            activities = loadFromLocalStorage('diwan_activities') || [];
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        if (user.role === 'user' && (!user.activityId || !activities.find(a => a.id == user.activityId))) {
            hideLoading();
            showNotification('âš ï¸ Ù†Ø´Ø§Ø· ØºÙŠØ± ØµØ§Ù„Ø­', 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±.', 'warning');
            errorMsg.textContent = 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± ØµØ§Ù„Ø­.';
            errorMsg.style.display = 'block';
            
            // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹
            if (USE_FIREBASE && user.firebaseUid) {
                await firebaseSignOut();
            }
            return;
        }

        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Session Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
        sessionStorage.setItem('loggedInUser', JSON.stringify(user));
        sessionStorage.setItem('isLoggedIn', 'true');
        
        // Ø­Ø°Ù Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Ù†Ø¸Ø§Ù… "ØªØ°ÙƒØ±Ù†ÙŠ" Ø§Ù„Ø³Ø§Ø¨Ù‚
        localStorage.removeItem('rememberedUser');
        localStorage.removeItem('loggedInUser');
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('justLoggedOut');

        updateLoggedInUserDisplay(user);
        document.getElementById('login-overlay').style.display = 'none';
        document.querySelector('.app-container').style.display = 'flex';
        
        // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ®ØµÙŠØµ Ø¹Ù† Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·
        hideCustomizationForManagers(user.role);
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        const footer = document.getElementById('appFooter');
        if (footer) {
            footer.style.display = 'block';
            setTimeout(() => { footer.style.opacity = '1'; }, 100);
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©)
        if (typeof checkBackupReminder === 'function') {
            checkBackupReminder();
        }

        if (user.role === 'admin') {
            currentActivityId = sessionStorage.getItem('currentActivityId');
            if (currentActivityId && activities.find(a => a.id == currentActivityId)) {
                selectActivity(currentActivityId);
            } else {
                enterAdminWithoutActivity();
            }
        } else {
            selectActivity(user.activityId);
        }

        hideLoading();
        
        // Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        showNotification('âœ… Ù…Ø±Ø­Ø¨Ø§Ù‹', `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ${user.name || user.email}`, 'success');

    } catch (error) {
        hideLoading();
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
        errorMsg.textContent = 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        errorMsg.style.display = 'block';
    } finally {
        loginInProgress = false;
    }
}

        // ===== First Setup System Functions =====
        
        /**
         * Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹
         */
        function showFirstSetup() {
            console.log('ğŸš€ Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹');
            
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            document.getElementById('login-overlay').style.display = 'none';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ
            document.getElementById('first-setup-overlay').style.display = 'flex';
            
            // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ù‡Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
            document.getElementById('adminName').value = '';
            document.getElementById('adminEmail').value = '';
            document.getElementById('adminPhone').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPasswordConfirm').value = '';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            const errorMsg = document.getElementById('setup-error');
            errorMsg.style.display = 'none';
        }
        
        /**
         * Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
         */
        function cancelFirstSetup() {
            console.log('â†©ï¸ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
            
            // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ
            document.getElementById('first-setup-overlay').style.display = 'none';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            document.getElementById('login-overlay').style.display = 'flex';
        }
        
        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„
         */
        async function createFirstAdmin() {
            const errorMsg = document.getElementById('setup-error');
            const name = document.getElementById('adminName').value.trim();
            const email = document.getElementById('adminEmail').value.trim();
            const phone = document.getElementById('adminPhone').value.trim();
            const password = document.getElementById('adminPassword').value;
            const confirmPassword = document.getElementById('adminPasswordConfirm').value;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (!name || !email || !password) {
                errorMsg.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©';
                errorMsg.style.display = 'block';
                return;
            }

            if (password.length < 6) {
                errorMsg.textContent = 'âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
                errorMsg.style.display = 'block';
                return;
            }

            if (password !== confirmPassword) {
                errorMsg.textContent = 'âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†';
                errorMsg.style.display = 'block';
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorMsg.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­';
                errorMsg.style.display = 'block';
                return;
            }

            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…...');
            errorMsg.style.display = 'none';

            try {
                const result = await createFirstSystemAdmin(email, password, name, phone);
                
                if (result && !result.error) {
                    hideLoading();
                    document.getElementById('first-setup-overlay').style.display = 'none';
                    
                    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Session Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                    sessionStorage.setItem('loggedInUser', JSON.stringify(result.userData));
                    sessionStorage.setItem('isLoggedIn', 'true');
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                    document.getElementById('login-overlay').style.display = 'none';
                    document.querySelector('.app-container').style.display = 'flex';
                    
                    updateLoggedInUserDisplay(result.userData);
                    enterAdminWithoutActivity();
                    
                    showNotification('ğŸ‰ ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!', `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name}, ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ ÙƒÙ…Ø¯ÙŠØ± Ù„Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                    
                } else {
                    hideLoading();
                    errorMsg.textContent = result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨';
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                hideLoading();
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…:', error);
                errorMsg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                errorMsg.style.display = 'block';
            }
        }

        /**
         * ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
         */
      async function checkFirstSetup() {
            console.log('ğŸ” checkFirstSetup: Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ');
            
            if (!USE_FIREBASE) {
                console.log('âš ï¸ Firebase Ù…Ø¹Ø·Ù„ - ØªÙ… ØªØ¬Ø§Ù‡Ù„ ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ');
                return;
            }

            console.log('ğŸ”¥ Firebase Ù…ÙØ¹Ù„ - ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

            try {
                const needsSetup = await checkForFirstSetup();
                console.log('ğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ - ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„ÙŠ:', needsSetup);
                
                if (needsSetup) {
                    console.log('ğŸš€ Ø¥Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„');
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('first-setup-overlay').style.display = 'flex';
                    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù† Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    const firstSetupBtn = document.getElementById('firstSetupBtn');
                    if (firstSetupBtn) firstSetupBtn.style.display = 'none';
                } else {
                    console.log('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„ - Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ±');
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ø£Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„
                    const firstSetupBtn = document.getElementById('firstSetupBtn');
                    if (firstSetupBtn) firstSetupBtn.style.display = 'none';
                    
                    console.log('ğŸ“ Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©');
                    document.getElementById('login-overlay').style.display = 'flex';
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ:', error);
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø£Ø¸Ù‡Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙˆØ£Ø®ÙÙ Ø²Ø± Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
                document.getElementById('login-overlay').style.display = 'flex';
                const firstSetupBtn = document.getElementById('firstSetupBtn');
                if (firstSetupBtn) firstSetupBtn.style.display = 'none';
            }
        }

        function enterAdminWithoutActivity() {
            currentActivityId = null;
            sessionStorage.removeItem('currentActivityId');

            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) loginOverlay.style.display = 'none';
            const activityOverlay = document.getElementById('activity-overlay');
            if (activityOverlay) activityOverlay.style.display = 'none';
            const appContainer = document.querySelector('.app-container');
            if (appContainer) appContainer.style.display = 'flex';

            items = [];
            customers = [];
            suppliers = [];
            purchases = [];
            sales = [];
            expenses = [];
            revenues = [];
            salaries = [];
            salesReturns = [];
            purchaseReturns = [];
            currentPurchaseItems = [];
            currentSaleItems = [];
            currentPurchaseNumber = 1;
            currentSaleNumber = 1;
            currentSaleReturnNumber = 1;
            currentPurchaseReturnNumber = 1;
            editingPurchaseId = null;
            editingSaleId = null;

            const todayISO = new Date().toISOString().split('T')[0];
            const setValueIfExists = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.value = value;
            };
            ['purchaseDate', 'saleDate', 'expenseDate', 'revenueDate', 'reportFrom', 'reportTo'].forEach(id => setValueIfExists(id, todayISO));

            setValueIfExists('purchaseCode', `PUR${currentPurchaseNumber.toString().padStart(3, '0')}`);
            setValueIfExists('saleCode', `SAL${currentSaleNumber.toString().padStart(3, '0')}`);

            updateHeaderForActivity(null);
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            updateLoggedInUserDisplay(loggedInUser);
            updateSidebar(loggedInUser ? loggedInUser.role : null);

            newPurchase();
            newSale();
            newSaleReturn();
            newPurchaseReturn();

            renderItems();
            renderCustomers();
            renderSuppliers();
            renderPurchasesList();
            renderSalesList();
            renderSalesReturns();
            renderPurchaseReturns();
            renderExpenses();
            renderRevenues();
            updatePurchaseDropdowns();
            updateSaleDropdowns();
            updateExpenseStats();
            updateRevenueStats();
            updateDataStats();
            updateDashboard();
            updateReportItemFilter();
            // Ù„Ø§ Ù†Ø³ØªØ¯Ø¹ÙŠ changeReportType() Ù„ØªØ±Ùƒ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙØ§Ø±Øº
            const reportResults = document.getElementById('reportResults');
            if (reportResults) reportResults.innerHTML = '';
            const reportSummary = document.getElementById('reportSummary');
            if (reportSummary) reportSummary.innerHTML = '';
            renderActivitiesInSettings();
            renderUsersInSettings();
        }
        
      async function logout() {
            const confirmed = await showConfirmDialog({
                title: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
                message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ',
                icon: 'ğŸšª',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡',
                confirmButtonClass: 'danger'
            });
            
            if (confirmed) {
                // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
                sessionStorage.clear();
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('rememberedUser');
                
                location.reload();
            }
        }

        function renderUsersInSettings() {
            // ØªÙ… Ø¥Ø²Ø§Ù„Ø© loadUsers() Ù„Ø£Ù†Ù‡ ÙŠØ³Ø¨Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø­Ù…Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù…ØªØºÙŠØ± users Ø§Ù„Ø¹Ø§Ù…
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const isAdmin = loggedInUser && loggedInUser.role === 'admin';
            const isManager = loggedInUser && loggedInUser.role === 'manager';
            const activitySelect = document.getElementById('newUserActivity');
            const userSelect = document.getElementById('usersDropdown');
            const roleSelect = document.getElementById('newUserRole');

            // ØªØ´Ø®ÙŠØµ Ù„Ù„Ù…Ø¯ÙŠØ±
            if (isManager) {
                console.log('ğŸ” ØªØµÙÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·:');
                console.log('Ù…Ø¹Ø±Ù Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø¯ÙŠØ±:', loggedInUser.activityId, 'Ù†ÙˆØ¹Ù‡:', typeof loggedInUser.activityId);
                console.log('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', users.length);
                users.forEach(u => {
                    console.log(`  - ${u.email}: Ù†Ø´Ø§Ø·=${u.activityId} (${typeof u.activityId}), Ø¯ÙˆØ±=${u.role}`);
                });
            }

            if (roleSelect) {
                if (isManager) {
                    roleSelect.value = 'user';
                    roleSelect.disabled = true;
                } else {
                    roleSelect.disabled = false;
                }
            }

            if (activitySelect) {
                activitySelect.innerHTML = '<option value="">-- ØªØ¹ÙŠÙŠÙ† Ù„Ù†Ø´Ø§Ø· --</option>';
                const availableActivities = isManager
                    ? activities.filter(act => String(act.id) === String(loggedInUser.activityId))
                    : activities;
                availableActivities.forEach(act => {
                    activitySelect.innerHTML += `<option value="${act.id}">${act.name}</option>`;
                });
                if (isManager) {
                    activitySelect.value = loggedInUser.activityId || '';
                    activitySelect.disabled = true;
                } else {
                    activitySelect.disabled = false;
                }
            }

            if (userSelect) {
                const previousSelection = userSelect.value;
                userSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§</option>';
                
                // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                const filteredUsers = users.filter(user => {
                    if (isAdmin) return true;
                    if (isManager) {
                        // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡
                        if (user.role === 'admin') return false;
                        // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± Ø¨Ø±Ø¤ÙŠØ© Ù†ÙØ³Ù‡
                        if (user.role === 'manager' && String(user.id) !== String(loggedInUser.id)) return false;
                        
                        // Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù†Øµ
                        const userActivityId = String(user.activityId || '');
                        const managerActivityId = String(loggedInUser.activityId || '');
                        const matches = userActivityId === managerActivityId;
                        
                        console.log(`  ØªØ­Ù‚Ù‚ Ù…Ù† ${user.email}: activityId="${userActivityId}" Ù…Ù‚Ø§Ø¨Ù„ "${managerActivityId}" => ${matches}`);
                        return matches;
                    }
                    return false;
                });

                console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙÙŠØ©:', filteredUsers.length);

                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·ØŒ Ø«Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                const sortedUsers = filteredUsers.sort((a, b) => {
                    const roleOrder = { admin: 1, manager: 2, user: 3 };
                    const orderA = roleOrder[a.role] || 4;
                    const orderB = roleOrder[b.role] || 4;
                    
                    if (orderA !== orderB) {
                        return orderA - orderB;
                    }
                    
                    // Ù†ÙØ³ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…
                    const nameA = (a.name && a.name.trim()) ? a.name : a.email;
                    const nameB = (b.name && b.name.trim()) ? b.name : b.email;
                    return nameA.localeCompare(nameB, 'ar');
                });

                sortedUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    const roleLabelMap = { admin: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', manager: 'Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·', user: 'Ù…Ø³ØªØ®Ø¯Ù…' };
                    const baseName = (user.name && user.name.trim()) ? user.name : user.email;
                    option.textContent = `${baseName} - ${roleLabelMap[user.role] || 'Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`;
                    userSelect.appendChild(option);
                });

                if (previousSelection && users.some(u => String(u.id) === previousSelection)) {
                    userSelect.value = previousSelection;
                } else {
                    userSelect.value = '';
                }
            }

            handleUserSelection();
        }

        function handleUserSelection() {
            const userSelect = document.getElementById('usersDropdown');
            const infoBox = document.getElementById('selectedUserInfo');
            const nameInput = document.getElementById('selectedUserName');
            const emailInput = document.getElementById('selectedUserEmail');
            const phoneInput = document.getElementById('selectedUserPhone');
            const roleInput = document.getElementById('selectedUserRole');
            const activityInput = document.getElementById('selectedUserActivity');
            const editBtn = document.getElementById('editSelectedUserBtn');
            const deleteBtn = document.getElementById('deleteSelectedUserBtn');

            if (!userSelect) return;

            const userId = userSelect.value;
            const user = users.find(u => String(u.id) === userId);

            if (!user) {
                if (infoBox) infoBox.style.display = 'none';
                if (nameInput) nameInput.value = '';
                if (emailInput) emailInput.value = '';
                if (phoneInput) phoneInput.value = '';
                if (roleInput) roleInput.value = '';
                if (activityInput) activityInput.value = '';
                if (editBtn) editBtn.disabled = true;
                if (deleteBtn) deleteBtn.disabled = true;
                return;
            }

            if (infoBox) infoBox.style.display = 'flex';
            if (nameInput) nameInput.value = (user.name && user.name.trim()) ? user.name : user.email;
            if (emailInput) emailInput.value = user.email || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            if (phoneInput) phoneInput.value = (user.phone && user.phone.trim()) ? user.phone : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            if (roleInput) {
                const roleNames = { admin: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', manager: 'Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·', user: 'Ù…Ø³ØªØ®Ø¯Ù…' };
                roleInput.value = roleNames[user.role] || 'Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            }

            let assignedActivity = 'ØºÙŠØ± Ù…Ø®ØµØµ';
            if (user.role === 'admin') {
                assignedActivity = 'Ù…ØªØ¹Ø¯Ø¯ (Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…)';
            } else if (user.role === 'manager' || user.role === 'user') {
                const activity = activities.find(a => a.id == user.activityId);
                assignedActivity = activity ? activity.name : 'Ù†Ø´Ø§Ø· ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            }
            if (activityInput) activityInput.value = assignedActivity;

            if (editBtn) editBtn.disabled = false;
            if (deleteBtn) deleteBtn.disabled = false;
        }

        function handleEditSelectedUser() {
            const userSelect = document.getElementById('usersDropdown');
            if (!userSelect || !userSelect.value) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'warning');
                return;
            }
            const userId = userSelect.value;
            openEditUserModal(userId);
        }

        function handleDeleteSelectedUser() {
            const userSelect = document.getElementById('usersDropdown');
            if (!userSelect || !userSelect.value) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'warning');
                return;
            }
            const userId = userSelect.value;
            deleteUser(userId);
        }

        let editingUserId = null;
        let editingUserSelf = false;
        function openEditUserModal(userId, options = {}) {
            editingUserSelf = Boolean(options && options.selfEdit);
            const user = users.find(u => String(u.id) === String(userId));
            if (!user) return;

            editingUserId = user.id;

            // ØªØ´Ø®ÙŠØµ: Ø·Ø¨Ø§Ø¹Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
            console.log('ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ¹Ø¯ÙŠÙ„:', user);
            console.log('ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:', user.phone);

            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const isManager = loggedInUser && loggedInUser.role === 'manager';
            const isSelf = loggedInUser && String(user.id) === String(loggedInUser.id);

            if (isManager) {
                // Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ÙŠØ³ØªØ·ÙŠØ¹ ØªØ¹Ø¯ÙŠÙ„:
                // 1. Ù†ÙØ³Ù‡ (Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙ‡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·)
                // 2. Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ† ÙÙŠ Ù†Ø´Ø§Ø·Ù‡ ÙÙ‚Ø·
                // Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ ØªØ¹Ø¯ÙŠÙ„:
                // - Ù…Ø¯ÙŠØ±ÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… (admin)
                // - Ù…Ø¯ÙŠØ±ÙŠ Ø£Ù†Ø´Ø·Ø© Ø£Ø®Ø±Ù‰ (manager Ù…Ù† Ø£Ù†Ø´Ø·Ø© Ù…Ø®ØªÙ„ÙØ©)
                // - Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ø£Ù†Ø´Ø·Ø© Ø£Ø®Ø±Ù‰

                const sameActivity = String(user.activityId) === String(loggedInUser.activityId);
                
                if (user.role === 'admin') {
                    showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', 'warning');
                    return;
                }
                
                if (user.role === 'manager' && !isSelf) {
                    showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø· Ø¢Ø®Ø±', 'warning');
                    return;
                }
                
                if (user.role === 'user' && !sameActivity) {
                    showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ù†Ø´Ø§Ø·Ùƒ ÙÙ‚Ø·', 'warning');
                    return;
                }
            }

            const nameInput = document.getElementById('editUserName');
            const emailInput = document.getElementById('editUserEmail');
            const phoneInput = document.getElementById('editUserPhone');
            const passwordInput = document.getElementById('editUserPassword');
            const securityQuestionSelect = document.getElementById('editUserSecurityQuestion');
            const securityAnswerInput = document.getElementById('editUserSecurityAnswer');
            const roleSelect = document.getElementById('editUserRole');
            const actSel = document.getElementById('editUserActivity');

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            nameInput.value = user.name || '';
            emailInput.value = user.email || '';
            
            // ØªØ´Ø®ÙŠØµ Ø®Ø§Øµ Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¬ÙˆØ§Ù„
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ“‹ ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ID:', userId);
            console.log('ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', Object.keys(user));
            console.log('ğŸ“± Ù‚ÙŠÙ…Ø© user.phone:', user.phone);
            console.log('ğŸ“± Ù†ÙˆØ¹ user.phone:', typeof user.phone);
            console.log('ğŸ“± Ù‡Ù„ user.phone ÙØ§Ø±ØºØŸ', user.phone === '' || user.phone === null || user.phone === undefined);
            console.log('ğŸ“± Ø·ÙˆÙ„ user.phone:', user.phone ? user.phone.length : 0);
            console.log('ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…Ù„Ø©:', JSON.stringify(user, null, 2));
            
            // ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚Ù„ Ø§Ù„Ø¬ÙˆØ§Ù„
            phoneInput.value = user.phone || '';
            
            console.log('âœ… Ù‚ÙŠÙ…Ø© Ø­Ù‚Ù„ Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©:', phoneInput.value);
            console.log('âœ… Ø·ÙˆÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø©:', phoneInput.value.length);
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            
            passwordInput.value = '';  // Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙØ§Ø±Øº Ù„Ù„Ø£Ù…Ø§Ù†ØŒ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ ÙÙ‚Ø·
            passwordInput.placeholder = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„ÙŠ)';
            
            // ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚ÙˆÙ„ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹)
            securityQuestionSelect.value = user.securityQuestion || '';
            securityAnswerInput.value = user.securityAnswer || '';
            
            // Ø¥Ø¸Ù‡Ø§Ø± ØªØ­Ø°ÙŠØ± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ‡ Ø³Ø¤Ø§Ù„ Ø£Ù…Ø§Ù†
            const securityWarning = document.getElementById('securityQuestionWarning');
            if (!user.securityQuestion) {
                securityWarning.style.display = 'block';
                console.log('âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ø³Ø¤Ø§Ù„ Ø£Ù…Ø§Ù† Ù…Ø­Ø¯Ø¯');
            } else {
                securityWarning.style.display = 'none';
            }
            
            roleSelect.value = user.role;

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø©
            actSel.innerHTML = '<option value="">-- ØªØ¹ÙŠÙŠÙ† Ù„Ù†Ø´Ø§Ø· --</option>';
            const availableActivities = isManager
                ? activities.filter(a => String(a.id) === String(loggedInUser.activityId))
                : activities;
            availableActivities.forEach(a => actSel.innerHTML += `<option value="${a.id}">${a.name}</option>`);

            const shouldShowActivity = (user.role === 'user' || user.role === 'manager');
            actSel.style.display = shouldShowActivity ? 'block' : 'none';
            actSel.value = shouldShowActivity ? (user.activityId || '') : '';

            // ØªÙ…ÙƒÙŠÙ† Ø£Ùˆ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø¨ Ø³ÙŠØ§Ù‚ Ø§Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ
            const disableRoleSelect = editingUserSelf || isManager || isSelf;
            roleSelect.disabled = disableRoleSelect;
            actSel.disabled = editingUserSelf || isSelf;

            if (!disableRoleSelect) {
                roleSelect.onchange = function() {
                    if (this.value === 'user' || this.value === 'manager') {
                        actSel.style.display = 'block';
                        actSel.disabled = false;
                    } else {
                        actSel.style.display = 'none';
                        actSel.value = '';
                        actSel.disabled = false;
                    }
                };
            } else {
                roleSelect.onchange = null;
            }

            document.getElementById('user-edit-overlay').style.display = 'flex';
        }

        function closeEditUserModal() {
            document.getElementById('user-edit-overlay').style.display = 'none';
            editingUserId = null;
            editingUserSelf = false;
        }

        // ===== Ø¯ÙˆØ§Ù„ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© =====
        let editingActivityId = null;

        function openEditActivityModal(activityId) {
            const activity = activities.find(a => a.id === activityId);
            if (!activity) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }

            editingActivityId = activityId;
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©
            document.getElementById('editActivityName').value = activity.name;
            document.getElementById('activityCreatedAt').textContent = activity.createdAt || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            document.getElementById('activityCreatedBy').textContent = activity.createdBy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            
            // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø¹ ØªØ£Ø«ÙŠØ±
            const overlay = document.getElementById('edit-activity-overlay');
            overlay.style.display = 'flex';
            overlay.classList.add('show');
            
            // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù…
            setTimeout(() => {
                document.getElementById('editActivityName').focus();
                document.getElementById('editActivityName').select();
            }, 300);
        }

        function closeEditActivityModal() {
            const overlay = document.getElementById('edit-activity-overlay');
            overlay.classList.remove('show');
            overlay.classList.add('hide');
            
            setTimeout(() => {
                overlay.style.display = 'none';
                overlay.classList.remove('hide');
                editingActivityId = null;
                document.getElementById('editActivityForm').reset();
            }, 300);
        }

        async function saveEditedActivity() {
            const nameInput = document.getElementById('editActivityName');
            const newName = nameInput.value.trim();
            
            if (!newName) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·', 'warning');
                nameInput.focus();
                return;
            }
            
            if (!editingActivityId) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„ØªØ¹Ø¯ÙŠÙ„', 'error');
                return;
            }
            
            const activityIndex = activities.findIndex(a => a.id === editingActivityId);
            if (activityIndex === -1) {
                showNotification('âš ï¸ Ø®Ø·Ø£', 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }
            
            const currentName = activities[activityIndex].name;
            
            if (newName === currentName) {
                showNotification('â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±', 'Ù„Ù… ØªÙ‚Ù… Ø¨ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·', 'info');
                closeEditActivityModal();
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†Ø´Ø§Ø· Ø¢Ø®Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…
            const existingActivity = activities.find(a => a.name === newName && a.id !== editingActivityId);
            if (existingActivity) {
                showNotification('âš ï¸ Ø§Ø³Ù… Ù…ÙƒØ±Ø±', 'ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø¢Ø®Ø± Ø¨Ù†ÙØ³ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…', 'warning');
                nameInput.focus();
                nameInput.select();
                return;
            }
            
            try {
                // Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                activities[activityIndex].name = newName;
                activities[activityIndex].updatedAt = new Date().toLocaleString('ar-SA');
                
                // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆFirebase
                await saveActivities();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                renderActivitiesInSettings();
                
                // ØªØ­Ø¯ÙŠØ« Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
                if (currentActivityId === editingActivityId) {
                    updateHeaderForActivity(activities[activityIndex]);
                }
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ ÙÙŠ Firebase Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
                try {
                    if (typeof firebaseSaveActivityData === 'function' && currentActivityId === editingActivityId) {
                        await firebaseSaveActivityData();
                    }
                } catch (firebaseError) {
                    console.log('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase:', firebaseError.message);
                }
                
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø¥Ù„Ù‰ "${newName}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                closeEditActivityModal();
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†Ø´Ø§Ø·:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª', 'error');
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Enter ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ù†Øµ
        document.addEventListener('DOMContentLoaded', function() {
            const editActivityName = document.getElementById('editActivityName');
            if (editActivityName) {
                editActivityName.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveEditedActivity();
                    }
                });
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
            const editActivityOverlay = document.getElementById('edit-activity-overlay');
            if (editActivityOverlay) {
                editActivityOverlay.addEventListener('click', function(e) {
                    if (e.target === editActivityOverlay) {
                        closeEditActivityModal();
                    }
                });
            }
        });


        // ===== Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· =====

        function openSelfEditUserModal() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser) {
                showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ø¬Ù„', 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }

            console.log('ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† sessionStorage:', loggedInUser);
            console.log('ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ù† sessionStorage:', loggedInUser.phone);

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ù…ØµÙÙˆÙØ© users Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© (Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„)
            const currentUser = users.find(u => String(u.id) === String(loggedInUser.id));
            
            if (!currentUser) {
                showNotification('âŒ Ø®Ø·Ø£', 'ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ¹Ø¯ÙŠÙ„', 'error');
                return;
            }

            console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù…ØµÙÙˆÙØ© users:', currentUser);
            console.log('ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ù† users:', currentUser.phone);
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ sessionStorage ÙˆÙ„ÙŠØ³ ÙÙŠ usersØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« users
            if (loggedInUser.phone && !currentUser.phone) {
                console.log('âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ sessionStorage Ù„ÙƒÙ† Ù…ÙÙ‚ÙˆØ¯ ÙÙŠ users!');
                console.log('ğŸ”§ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« users Ù…Ù† sessionStorage...');
                currentUser.phone = loggedInUser.phone;
                saveUsers();
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« users Ø¨Ù†Ø¬Ø§Ø­');
            }

            openEditUserModal(currentUser.id, { selfEdit: true });
        }

        async function saveEditedUser() {
            console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø¯Ø§Ù„Ø© saveEditedUser...');
            
            const name = document.getElementById('editUserName').value.trim();
            const email = document.getElementById('editUserEmail').value.trim();
            const phone = document.getElementById('editUserPhone').value.trim();
            const password = document.getElementById('editUserPassword').value.trim();
            const securityQuestion = document.getElementById('editUserSecurityQuestion').value.trim();
            const securityAnswer = document.getElementById('editUserSecurityAnswer').value.trim();
            let role = document.getElementById('editUserRole').value;
            let activityId = document.getElementById('editUserActivity').value;
            const phonePattern = /^[+\d]{6,20}$/;
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const isManager = loggedInUser && loggedInUser.role === 'manager';

            // ØªØ´Ø®ÙŠØµ Ù…ÙØµÙ„ Ù„Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
            console.log('ğŸ“‹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¯Ø®Ù„Ø©:');
            console.log('  ğŸ“§ Email:', email);
            console.log('  ğŸ‘¤ Name:', name);
            console.log('  ğŸ“± Phone (raw):', `"${document.getElementById('editUserPhone').value}"`);
            console.log('  ğŸ“± Phone (trimmed):', `"${phone}"`);
            console.log('  ğŸ“± Phone length:', phone.length);
            console.log('  ğŸ“± Phone type:', typeof phone);
            console.log('  ğŸ” Password:', password ? '***' : 'ÙØ§Ø±Øº');
            console.log('  ğŸ­ Role:', role);
            console.log('  ğŸ¢ ActivityId:', activityId);
            console.log('  ğŸ”¢ editingUserId:', editingUserId);

            if (!name) { showNotification('âš ï¸ Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·Ù„ÙˆØ¨', 'warning'); return; }
            if (!email) { showNotification('âš ï¸ Ø¨Ø±ÙŠØ¯ Ù…Ø·Ù„ÙˆØ¨', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø·Ù„ÙˆØ¨', 'warning'); return; }
            if (!phone) { 
                console.error('âŒ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙØ§Ø±Øº!'); 
                showNotification('âš ï¸ Ø¬ÙˆØ§Ù„ Ù…Ø·Ù„ÙˆØ¨', 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ø·Ù„ÙˆØ¨', 'warning'); 
                return; 
            }
            if (!phonePattern.test(phone)) { 
                console.error('âŒ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:', phone); 
                showNotification('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· ÙˆÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ù„Ø§Ù…Ø© +', 'warning'); 
                return; 
            }
            if (!role) { showNotification('âš ï¸ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø©', 'Ø§Ø®ØªØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©', 'warning'); return; }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† (Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø³Ø¤Ø§Ù„ØŒ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©)
            if (securityQuestion && !securityAnswer) {
                showNotification('âš ï¸ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø·Ù„ÙˆØ¨Ø©', 'Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª Ø³Ø¤Ø§Ù„ Ø£Ù…Ø§Ù†ØŒ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©', 'warning');
                return;
            }
            if (!securityQuestion && securityAnswer) {
                showNotification('âš ï¸ Ø³Ø¤Ø§Ù„ Ù…Ø·Ù„ÙˆØ¨', 'Ø¥Ø°Ø§ Ø£Ø¯Ø®Ù„Øª Ø¥Ø¬Ø§Ø¨Ø©ØŒ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†', 'warning');
                return;
            }

            const idx = users.findIndex(u => String(u.id) === String(editingUserId));
            console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:');
            console.log('  ğŸ”¢ editingUserId:', editingUserId, '(type:', typeof editingUserId, ')');
            console.log('  ğŸ“Š users.length:', users.length);
            console.log('  ğŸ“ users IDs:', users.map(u => `${u.id} (${typeof u.id})`));
            console.log('  ğŸ¯ found index:', idx);
            
            if (idx === -1) { 
                console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…ØµÙÙˆÙØ© users!');
                showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error'); 
                return; 
            }

            const targetUser = users[idx];
            console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', {
                id: targetUser.id,
                email: targetUser.email,
                name: targetUser.name,
                phone: targetUser.phone,
                phoneType: typeof targetUser.phone
            });
            
            const isSelf = loggedInUser && String(targetUser.id) === String(loggedInUser.id);

            // ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙŠÙˆØ¯ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·
            if (isManager && !isSelf) {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ†ØªÙ…ÙŠ Ù„Ù†ÙØ³ Ø§Ù„Ù†Ø´Ø§Ø·
                if (String(targetUser.activityId) !== String(loggedInUser.activityId)) {
                    showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ù†Ø´Ø§Ø·Ùƒ ÙÙ‚Ø·', 'warning');
                    return;
                }
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØ³ØªÙ‡Ø¯Ù Ù„ÙŠØ³ Ù…Ø¯ÙŠØ± Ø£Ùˆ Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…
                if (targetUser.role === 'admin' || targetUser.role === 'manager') {
                    showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', 'warning');
                    return;
                }
                
                // ÙØ±Ø¶ Ø¯ÙˆØ± Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ ÙˆÙ†ÙØ³ Ø§Ù„Ù†Ø´Ø§Ø·
                role = 'user';
                activityId = loggedInUser.activityId;
            } else if (isSelf) {
                // Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ù†ÙØ³Ù‡ØŒ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
                role = targetUser.role;
                activityId = targetUser.activityId || '';
            } else if (editingUserSelf) {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø°Ø§ØªÙŠ
                role = targetUser.role;
                activityId = targetUser.activityId || '';
            }

            if ((role === 'user' || role === 'manager') && !activityId) { showNotification('âš ï¸ Ù†Ø´Ø§Ø· Ù…Ø·Ù„ÙˆØ¨', 'ÙŠØ¬Ø¨ ØªØ¹ÙŠÙŠÙ† Ù†Ø´Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'warning'); return; }


            // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±
            if (users.some(u => u.email === email && String(u.id) !== String(editingUserId))) {
                showNotification('âŒ Ø¨Ø±ÙŠØ¯ Ù…ÙƒØ±Ø±', 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
                return;
            }

            console.log('ğŸ’¾ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ø¯ÙŠØ«...');
            console.log('  ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', `"${phone}"`);
            console.log('  ğŸ“± Ø·ÙˆÙ„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:', phone.length);
            console.log('  ğŸ“± Ù†ÙˆØ¹ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:', typeof phone);
            console.log('  ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù„Ù„ØªØ­Ø¯ÙŠØ«:', {
                id: targetUser.id,
                name: targetUser.name,
                email: targetUser.email,
                phoneBeforeUpdate: targetUser.phone,
                phoneBeforeType: typeof targetUser.phone
            });

            // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
            const oldPhone = targetUser.phone;
            
            targetUser.name = name;
            targetUser.email = email;
            targetUser.phone = phone;
            if (password) targetUser.password = password; // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø©
            targetUser.role = role;
            targetUser.activityId = (role === 'user' || role === 'manager') ? activityId : null;
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† (ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ… Ø¬Ø¯ÙŠØ¯Ø©)
            if (securityQuestion && securityAnswer) {
                targetUser.securityQuestion = securityQuestion;
                targetUser.securityAnswer = securityAnswer;
                console.log('ğŸ” ØªÙ… ØªØ­Ø¯ÙŠØ« Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†');
            }

            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« targetUser:');
            console.log('  ğŸ“± oldPhone:', `"${oldPhone}"`);
            console.log('  ğŸ“± newPhone:', `"${targetUser.phone}"`);
            console.log('  ğŸ“± phoneChanged:', oldPhone !== targetUser.phone);
            console.log('  ğŸ‘¤ targetUser Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', {
                id: targetUser.id,
                name: targetUser.name,
                email: targetUser.email,
                phone: targetUser.phone,
                phoneType: typeof targetUser.phone
            });
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ… ÙÙŠ Ù…ØµÙÙˆÙØ© users
            const checkUser = users[idx];
            console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† users[idx] Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', {
                id: checkUser.id,
                phone: checkUser.phone,
                phoneType: typeof checkUser.phone
            });
            console.log('ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', {
                id: targetUser.id,
                name: targetUser.name,
                email: targetUser.email,
                phone: targetUser.phone,
                role: targetUser.role
            });

            const updatedUser = targetUser;
            
            // Ø­ÙØ¸ ØªÙØµÙŠÙ„ÙŠ Ù…Ø¹ ØªØ´Ø®ÙŠØµ
            console.log('ğŸ’¾ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...');
            const saveResult = await saveUsers();
            console.log('ğŸ’¾ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­ÙØ¸:', saveResult);
            
            // Ø­ÙØ¸ ÙÙŠ Firebase Ø£ÙŠØ¶Ø§Ù‹
            try {
                if (USE_FIREBASE && typeof firebase !== 'undefined' && firebase.auth().currentUser) {
                    console.log('ğŸ”¥ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØ­Ø¯Ø« ÙÙŠ Firebase...');
                    console.log('ğŸ”¥ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', updatedUser.id);
                    console.log('ğŸ”¥ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸:', {
                        name: updatedUser.name,
                        email: updatedUser.email,
                        phone: updatedUser.phone,
                        role: updatedUser.role,
                        activityId: updatedUser.activityId
                    });
                    
                    const userRef = firebase.database().ref(`users/${updatedUser.id}`);
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Ø£ÙˆÙ„Ø§Ù‹
                    const existingUser = await userRef.once('value');
                    if (existingUser.exists()) {
                        console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ FirebaseØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...');
                        const updateData = {
                            name: updatedUser.name,
                            email: updatedUser.email,
                            phone: updatedUser.phone,
                            role: updatedUser.role,
                            activityId: updatedUser.activityId,
                            updatedAt: new Date().toISOString()
                        };
                        // Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡
                        if (updatedUser.securityQuestion) {
                            updateData.securityQuestion = updatedUser.securityQuestion;
                            updateData.securityAnswer = updatedUser.securityAnswer;
                        }
                        await userRef.update(updateData);
                        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­');
                    } else {
                        console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ FirebaseØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¤Ù‡...');
                        const newData = {
                            id: updatedUser.id,
                            name: updatedUser.name,
                            email: updatedUser.email,
                            phone: updatedUser.phone,
                            role: updatedUser.role,
                            activityId: updatedUser.activityId,
                            createdAt: updatedUser.createdAt || new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        // Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                        if (updatedUser.securityQuestion) {
                            newData.securityQuestion = updatedUser.securityQuestion;
                            newData.securityAnswer = updatedUser.securityAnswer;
                        }
                        await userRef.set(newData);
                        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­');
                    }
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase
                    const verification = await userRef.once('value');
                    const savedData = verification.val();
                    console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Firebase:', savedData.phone);
                    
                } else {
                    console.log('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„');
                }
            } catch (firebaseError) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase:', firebaseError);
            }
            
            console.log('ğŸ’¾ Ø¨Ø¹Ø¯ saveUsers() - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:');
            const savedUser = users.find(u => String(u.id) === String(editingUserId));
            console.log('ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø­ÙÙˆØ¸:', savedUser ? savedUser.phone : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            
            // ØªØ­Ù‚Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ù…Ù† localStorage Ù…Ø¨Ø§Ø´Ø±Ø©
            const directCheck = loadFromLocalStorage('diwan_users');
            if (directCheck) {
                const directUser = directCheck.find(u => String(u.id) === String(editingUserId));
                console.log('ğŸ“± ØªØ­Ù‚Ù‚ Ù…Ø¨Ø§Ø´Ø± Ù…Ù† localStorage - Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:', directUser ? directUser.phone : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            }
            
            if (loggedInUser && String(loggedInUser.id) === String(updatedUser.id)) {
                sessionStorage.setItem('loggedInUser', JSON.stringify(updatedUser));
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« sessionStorage Ø£ÙŠØ¶Ø§Ù‹');
                updateLoggedInUserDisplay(updatedUser);
            }
            renderUsersInSettings();
            closeEditUserModal();
            showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'success');
        }

        async function deleteUser(id) {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const targetId = String(id);
            if (loggedInUser && String(loggedInUser.id) === targetId) {
                showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ù†ÙØ³Ùƒ', 'warning');
                return;
            }

            if (loggedInUser && loggedInUser.role === 'manager') {
                const target = users.find(u => String(u.id) === targetId);
                if (!target || target.role !== 'user' || String(target.activityId) !== String(loggedInUser.activityId)) {
                    showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'warning');
                    return;
                }
            }

            const admins = users.filter(u => u.role === 'admin');
            const userToDelete = users.find(u => String(u.id) === targetId);
            if (!userToDelete) {
                showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯', 'error');
                return;
            }

            if (userToDelete.role === 'admin' && admins.length <= 1) {
                showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙŠØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…', 'warning');
                return;
            }

            const confirmed = await showConfirmDialog(
                'Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
                `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${userToDelete.email}ØŸ`,
                'danger',
                'Ø­Ø°Ù',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                showLoading('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...');
                
                try {
                    // Ø­Ø°Ù Ù…Ù† Firebase Database Ø£ÙˆÙ„Ø§Ù‹
                    if (USE_FIREBASE && userToDelete.email) {
                        const { ref, remove } = window.firebaseModules;
                        const db = window.firebaseDatabase;
                        
                        // Ø­Ø°Ù Ù…Ù† users/
                        const sanitizedEmail = userToDelete.email.replace(/[.#$[\]]/g, '_');
                        const userRef = ref(db, `users/${sanitizedEmail}`);
                        await remove(userRef);
                        console.log('ğŸ”¥ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firebase Database');
                        
                        // Ø­Ø°Ù Ù…Ù† Firebase Authentication Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ‡ firebaseUid
                        if (userToDelete.firebaseUid) {
                            try {
                                // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Authentication ÙŠØªØ·Ù„Ø¨ Admin SDK Ù…Ù† Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø®Ø§Ø¯Ù…
                                // Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ† Ø­Ø°ÙÙ‡ Ù…Ù† Database ÙÙ‚Ø·
                                console.log('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø­Ø³Ø§Ø¨ Firebase Authentication Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠØ²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹. ÙŠØ¬Ø¨ Ø­Ø°ÙÙ‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Firebase Console');
                            } catch (authError) {
                                console.warn('âš ï¸ ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firebase Authentication:', authError);
                            }
                        }
                    }
                    
                    // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    users = users.filter(u => String(u.id) !== targetId);
                    
                    // Ø­ÙØ¸ ÙÙŠ LocalStorage
                    await saveUsers();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                    renderUsersInSettings();
                    
                    hideLoading();
                    showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    
                } catch (error) {
                    hideLoading();
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
                }
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
        async function addUser() {
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const phone = document.getElementById('newUserPhone').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            const role = document.getElementById('newUserRole').value;
            const activityId = document.getElementById('newUserActivity').value;
            const securityQuestion = document.getElementById('newUserSecurityQuestion').value;
            const securityAnswer = document.getElementById('newUserSecurityAnswer').value.trim();
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const isAdmin = loggedInUser && loggedInUser.role === 'admin';
            const isManager = loggedInUser && loggedInUser.role === 'manager';

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            if (!name || !email || !phone || !password) {
                showNotification('âš ï¸ Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† (Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø³Ø¤Ø§Ù„ØŒ ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©)
            if (securityQuestion && !securityAnswer) {
                showNotification('âš ï¸ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø·Ù„ÙˆØ¨Ø©', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø© Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†', 'warning');
                return;
            }

            if (!loggedInUser || (!isAdmin && !isManager)) {
                showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', 'warning');
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showNotification('âš ï¸ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­', 'warning');
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
            if (users.some(u => u.email === email)) {
                showNotification('âš ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
                return;
            }

            let normalizedRole = role;
            let normalizedActivityId = activityId;

            if (isManager) {
                if (!loggedInUser.activityId) {
                    showNotification('âš ï¸ Ù†Ø´Ø§Ø· ØºÙŠØ± Ù…Ø­Ø¯Ø¯', 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Ù†Ø´Ø§Ø· Ù…Ø­Ø¯Ø¯ Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', 'warning');
                    return;
                }

                // Ù‚ÙŠÙˆØ¯ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·
                if (role !== 'user') {
                    showNotification('âš ï¸ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø­Ø¯ÙˆØ¯Ø©', 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ø§Ø¯ÙŠÙŠÙ† ÙÙ‚Ø·', 'warning');
                    return;
                }

                if (activityId && String(activityId) !== String(loggedInUser.activityId)) {
                    showNotification('âš ï¸ Ù†Ø´Ø§Ø· ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ù„Ù‰ Ù†Ø´Ø§Ø·Ùƒ ÙÙ‚Ø·', 'warning');
                    return;
                }

                // ØªØ­ÙˆÙŠÙ„ Ù…Ø¹Ø±Ù Ø§Ù„Ù†Ø´Ø§Ø· Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚
                const managerActivityId = loggedInUser.activityId;
                normalizedRole = 'user'; // ÙÙ‚Ø· Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ø§Ø¯ÙŠÙŠÙ†
                normalizedActivityId = managerActivityId; // ÙÙ‚Ø· Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø¯ÙŠØ±

                console.log('ğŸ§­ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· ÙŠØ¶ÙŠÙ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ:', {
                    managerEmail: loggedInUser.email,
                    managerActivityId: managerActivityId,
                    newUserRole: normalizedRole,
                    newUserActivityId: normalizedActivityId
                });
            }

            if ((normalizedRole === 'user' || normalizedRole === 'manager') && !normalizedActivityId) {
                showNotification('âš ï¸ Ù†Ø´Ø§Ø· Ù…Ø·Ù„ÙˆØ¨', 'ÙŠØ¬Ø¨ ØªØ¹ÙŠÙŠÙ† Ù†Ø´Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'warning');
                return;
            }

            if (normalizedRole === 'admin') {
                normalizedActivityId = null;
            }

            try {
                showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...');

                // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const newUser = {
                    id: 'user_' + Date.now(),
                    name: name,
                    email: email,
                    password: password,
                    phone: phone,
                    role: normalizedRole,
                    activityId: (normalizedRole === 'user' || normalizedRole === 'manager') ? normalizedActivityId : null,
                    securityQuestion: securityQuestion || null,
                    securityAnswer: securityAnswer || null,
                    createdAt: new Date().toISOString()
                };

                console.log(' Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯:', {
                    email: newUser.email,
                    role: newUser.role,
                    activityId: newUser.activityId,
                    activityIdType: typeof newUser.activityId,
                    addedBy: loggedInUser.email,
                    addedByRole: loggedInUser.role,
                    addedByActivityId: loggedInUser.activityId
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ©
                users.push(newUser);

                // ğŸ”¥ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙÙŠ Firebase Authentication
                if (USE_FIREBASE) {
                    try {
                        console.log('ğŸ”¥ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Firebase Authentication Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', email);
                        const firebaseUser = await firebaseCreateUser(email, password, normalizedRole, normalizedActivityId);
                        
                        if (firebaseUser && firebaseUser.uid) {
                            newUser.firebaseUid = firebaseUser.uid;
                            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Firebase Ø¨Ù†Ø¬Ø§Ø­. UID:', firebaseUser.uid);
                            
                            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Database
                            await firebaseSaveUserData(firebaseUser.uid, newUser);
                        }
                    } catch (firebaseError) {
                        console.error('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Firebase:', firebaseError);
                        // Ù†ÙƒÙ…Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Firebase
                    }
                }

                // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                saveUsers();
                
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¢Ù†:', users.length);

                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserEmail').value = '';
                document.getElementById('newUserPhone').value = '';
                document.getElementById('newUserPassword').value = '';
                document.getElementById('newUserRole').value = 'user';
                document.getElementById('newUserActivity').value = '';
                document.getElementById('newUserSecurityQuestion').value = '';
                document.getElementById('newUserSecurityAnswer').value = '';

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
                renderUsersInSettings();

                hideLoading();
                showNotification('âœ… ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');

            } catch (error) {
                hideLoading();
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
            }
        }

        /**
         * Ø¥ØµÙ„Ø§Ø­ Ø­Ø³Ø§Ø¨ Firebase Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯
         * Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ Console Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ù… Ù‚Ø¨Ù„ ØªÙØ¹ÙŠÙ„ Firebase Authentication
         */
        async function fixUserFirebaseAuth(email, password) {
            try {
                console.log('ğŸ”§ Ø¨Ø¯Ø¡ Ø¥ØµÙ„Ø§Ø­ Ø­Ø³Ø§Ø¨ Firebase Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', email);
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const users = loadFromLocalStorage('diwan_users') || [];
                const user = users.find(u => u.email === email);
                
                if (!user) {
                    console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    return { success: false, message: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' };
                }
                
                if (user.firebaseUid) {
                    console.log('âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¯ÙŠÙ‡ firebaseUid Ø¨Ø§Ù„ÙØ¹Ù„:', user.firebaseUid);
                    console.log('Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Firebase');
                }
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Firebase
                let firebaseUser;
                try {
                    firebaseUser = await firebaseCreateUser(email, password, user.role, user.activityId);
                    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Firebase:', firebaseUser.uid);
                } catch (error) {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø­Ø§ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ UID
                    if (error.code === 'auth/email-already-in-use') {
                        console.log('â„¹ï¸ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ FirebaseØŒ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
                        const result = await firebaseSignIn(email, password);
                        if (result && result.firebaseUser) {
                            firebaseUser = result.firebaseUser;
                            console.log('âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ UID Ù…Ù† Firebase:', firebaseUser.uid);
                        } else {
                            throw new Error('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                        }
                    } else {
                        throw error;
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                user.firebaseUid = firebaseUser.uid;
                
                // Ø­ÙØ¸ ÙÙŠ LocalStorage
                const userIndex = users.findIndex(u => u.email === email);
                users[userIndex] = user;
                saveToLocalStorage('diwan_users', users);
                
                // Ø­ÙØ¸ ÙÙŠ Firebase Database
                await firebaseSaveUserData(firebaseUser.uid, user);
                
                console.log('âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
                return { 
                    success: true, 
                    message: 'ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­',
                    firebaseUid: firebaseUser.uid 
                };
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ø­Ø³Ø§Ø¨ Firebase:', error);
                return { 
                    success: false, 
                    message: error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹' 
                };
            }
        }

        // ===== Logo Management Functions =====
        function handleLogoUpload(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];
            if (!validTypes.includes(file.type)) {
                showNotification('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø¨ØµÙŠØºØ© PNG Ø£Ùˆ JPG Ø£Ùˆ SVG ÙÙ‚Ø·.', 'error');
                fileInput.value = '';
                return;
            }

            // Validate file size (max 2MB)
            const maxSize = 2 * 1024 * 1024; // 2MB in bytes
            if (file.size > maxSize) {
                showNotification('âŒ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª.', 'error');
                fileInput.value = '';
                return;
            }

            // Read and convert to Base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64String = e.target.result;
                
                // Save to localStorage
                localStorage.setItem('systemLogo', base64String);
                
                // Update preview in Settings
                const previewImg = document.getElementById('logoPreview');
                if (previewImg) {
                    previewImg.src = base64String;
                    previewImg.style.display = 'block';
                }
                
                // Hide "no logo" text
                const noLogoText = document.getElementById('noLogoText');
                if (noLogoText) noLogoText.style.display = 'none';
                
                // Update login screen logo
                const loginLogo = document.getElementById('loginLogo');
                if (loginLogo) {
                    loginLogo.src = base64String;
                    loginLogo.style.display = 'block';
                }
                
                // Update sidebar logo
                const sidebarLogo = document.getElementById('sidebarLogo');
                if (sidebarLogo) {
                    sidebarLogo.src = base64String;
                    sidebarLogo.style.display = 'block';
                }
                
                // Show remove button
                const removeBtn = document.getElementById('removeLogoBtn');
                if (removeBtn) removeBtn.style.display = 'inline-block';
                
                showNotification('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            };
            
            reader.onerror = function() {
                showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.', 'error');
                fileInput.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            showConfirmDialog(
                'Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø±',
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ',
                'warning',
                'Ø­Ø°Ù',
                'Ø¥Ù„ØºØ§Ø¡'
            ).then(confirmed => {
                if (confirmed) {
                    // Remove from localStorage
                    localStorage.removeItem('systemLogo');
                    
                    // Clear preview in Settings
                    const previewImg = document.getElementById('logoPreview');
                    if (previewImg) {
                        previewImg.src = '';
                        previewImg.style.display = 'none';
                    }
                    
                    // Show "no logo" text
                    const noLogoText = document.getElementById('noLogoText');
                    if (noLogoText) noLogoText.style.display = 'block';
                    
                    // Clear login screen logo
                    const loginLogo = document.getElementById('loginLogo');
                    if (loginLogo) {
                        loginLogo.src = '';
                        loginLogo.style.display = 'none';
                    }
                    
                    // Clear sidebar logo
                    const sidebarLogo = document.getElementById('sidebarLogo');
                    if (sidebarLogo) {
                        sidebarLogo.src = '';
                        sidebarLogo.style.display = 'none';
                    }
                    
                    // Hide remove button
                    const removeBtn = document.getElementById('removeLogoBtn');
                    if (removeBtn) removeBtn.style.display = 'none';
                    
                    // Clear file input
                    const fileInput = document.getElementById('logoFileInput');
                    if (fileInput) fileInput.value = '';
                    
                    showNotification('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                }
            });
        }

        function loadSavedLogo() {
            const savedLogo = localStorage.getItem('systemLogo');
            const noLogoText = document.getElementById('noLogoText');
            
            if (savedLogo) {
                // Update preview in Settings
                const previewImg = document.getElementById('logoPreview');
                if (previewImg) {
                    previewImg.src = savedLogo;
                    previewImg.style.display = 'block';
                }
                
                // Hide "no logo" text
                if (noLogoText) noLogoText.style.display = 'none';
                
                // Update login screen logo
                const loginLogo = document.getElementById('loginLogo');
                if (loginLogo) {
                    loginLogo.src = savedLogo;
                    loginLogo.style.display = 'block';
                }
                
                // Update sidebar logo
                const sidebarLogo = document.getElementById('sidebarLogo');
                if (sidebarLogo) {
                    sidebarLogo.src = savedLogo;
                    sidebarLogo.style.display = 'block';
                }
                
                // Show remove button
                const removeBtn = document.getElementById('removeLogoBtn');
                if (removeBtn) removeBtn.style.display = 'inline-block';
            } else {
                // Show "no logo" text if no logo exists
                if (noLogoText) noLogoText.style.display = 'block';
            }
        }

        // ===== Activity Logo Functions =====
        function handleActivityLogoUpload(fileInput) {
            debugLog('ğŸ” Ø¨Ø¯Ø¡ Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·...');
            
            const file = fileInput.files[0];
            if (!file) {
                debugLog('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù');
                return;
            }
            
            debugLog('ğŸ“„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±:', file.name, 'Ø§Ù„Ø­Ø¬Ù…:', file.size);
            
            // Check file size (max 500KB for localStorage compatibility)
            if (file.size > 500 * 1024) {
                showNotification('âŒ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹', 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 500 ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª. ÙŠØ±Ø¬Ù‰ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.', 'error');
                fileInput.value = '';
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                debugLog('âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­');
                const base64String = e.target.result;
                
                // Get current activity
                let currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
                debugLog('Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ:', currentActivity);
                
                if (!currentActivity) {
                    showNotification('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ù…Ø­Ø¯Ø¯', 'error');
                    return;
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·
                currentActivity.logo = base64String;
                
                // Ø­ÙØ¸ ÙÙŠ sessionStorage
                sessionStorage.setItem('currentActivity', JSON.stringify(currentActivity));
                
                // Ø­ÙØ¸ ÙÙŠ localStorage activities
                try {
                    const storageKey = `activity_${currentActivity.id}_data`;
                    const activityData = JSON.parse(localStorage.getItem(storageKey)) || {};
                    activityData.logo = base64String;
                    localStorage.setItem(storageKey, JSON.stringify(activityData));
                    debugLog('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ localStorage');
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        showNotification('âŒ Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦Ø©', 'Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø£ØµØºØ± (Ø£Ù‚Ù„ Ù…Ù† 200 ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª).', 'error');
                        fileInput.value = '';
                        return;
                    }
                    throw error;
                }
                
                // Update preview
                const previewImg = document.getElementById('activityLogoPreview');
                const noLogoText = document.getElementById('noActivityLogoText');
                if (previewImg) {
                    previewImg.src = base64String;
                    previewImg.style.display = 'block';
                    debugLog('ğŸ–¼ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¹Ø§Ø±');
                }
                if (noLogoText) noLogoText.style.display = 'none';
                
                // Update header logo
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) {
                    headerLogo.src = base64String;
                    headerLogo.style.display = 'block';
                    debugLog('ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©');
                }
                
                // Show remove button
                const removeBtn = document.getElementById('removeActivityLogoBtn');
                if (removeBtn) removeBtn.style.display = 'inline-block';
                
                showNotification('âœ… ØªÙ… Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            };
            
            reader.onerror = function() {
                debugLog('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù');
                showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.', 'error');
                fileInput.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        function removeActivityLogo() {
            showConfirm(
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·ØŸ',
                'Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±',
                'warning',
                () => {
                    const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
                    if (!currentActivity) return;
                    
                    // Remove logo from localStorage
                    const storageKey = `activity_${currentActivity.id}_data`;
                    const activityData = JSON.parse(localStorage.getItem(storageKey)) || {};
                    delete activityData.logo;
                    localStorage.setItem(storageKey, JSON.stringify(activityData));
                    
                    // Update preview
                    const previewImg = document.getElementById('activityLogoPreview');
                    const noLogoText = document.getElementById('noActivityLogoText');
                    if (previewImg) previewImg.style.display = 'none';
                    if (noLogoText) noLogoText.style.display = 'block';
                    
                    // Clear header logo
                    const headerLogo = document.getElementById('activityHeaderLogo');
                    if (headerLogo) headerLogo.style.display = 'none';
                    
                    // Hide remove button
                    const removeBtn = document.getElementById('removeActivityLogoBtn');
                    if (removeBtn) removeBtn.style.display = 'none';
                    
                    // Clear file input
                    const fileInput = document.getElementById('activityLogoFileInput');
                    if (fileInput) fileInput.value = '';
                    
                    showNotification('âœ… ØªÙ… Ø­Ø°Ù Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                }
            );
        }

        function loadActivityLogo() {
            const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
            if (!currentActivity) {
                // Hide logo if no activity
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) headerLogo.style.display = 'none';
                return;
            }
            
            // Load logo from localStorage
            const storageKey = `activity_${currentActivity.id}_data`;
            const activityData = JSON.parse(localStorage.getItem(storageKey));
            const savedLogo = activityData?.logo;
            
            if (!savedLogo) {
                // Hide logo if no logo saved
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) headerLogo.style.display = 'none';
                return;
            }
            
            // Update preview in settings
            const previewImg = document.getElementById('activityLogoPreview');
            const noLogoText = document.getElementById('noActivityLogoText');
            if (previewImg) {
                previewImg.src = savedLogo;
                previewImg.style.display = 'block';
            }
            if (noLogoText) noLogoText.style.display = 'none';
            
            // Update header logo
            const headerLogo = document.getElementById('activityHeaderLogo');
            if (headerLogo) {
                headerLogo.src = savedLogo;
                headerLogo.style.display = 'block';
            }
            
            // Show remove button
            const removeBtn = document.getElementById('removeActivityLogoBtn');
            if (removeBtn) removeBtn.style.display = 'inline-block';
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        function loadUsersDropdown() {
            // Ø¯Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ©
            console.log('ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...');
        }

        function loadActivitiesDropdown() {
            // Ø¯Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ©  
            console.log('ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø©...');
        }

        // ===== Ù†Ø¸Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ =====
        
        /**
         * Ù†Ø¸Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø°ÙƒÙŠ Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©
         * ÙŠÙÙ†Ø¨Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
         */
        function initBackupReminderSystem() {
            if (!currentActivityId) return;
            
            const reminderKey = `diwan_lastBackupReminder_${currentActivityId}`;
            const lastReminderTime = Number(localStorage.getItem(reminderKey) || 0);
            const now = Date.now();
            const twentyFourHours = 24 * 60 * 60 * 1000;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ù…Ø± 24 Ø³Ø§Ø¹Ø© Ù…Ù†Ø° Ø¢Ø®Ø± ØªÙ†Ø¨ÙŠÙ‡
            if ((now - lastReminderTime) >= twentyFourHours) {
                showBackupReminder();
            }
            
            // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©
            setInterval(() => {
                const currentTime = Date.now();
                const lastCheck = Number(localStorage.getItem(reminderKey) || 0);
                if ((currentTime - lastCheck) >= twentyFourHours) {
                    showBackupReminder();
                }
            }, twentyFourHours);
        }
        
        /**
         * Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
         */
        async function showBackupReminder() {
            if (!currentActivityId) return;
            
            try {
                const activity = activities.find(a => a.id == currentActivityId);
                if (!activity) return;
                
                // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªÙ†Ø¨ÙŠÙ‡
                const reminderKey = `diwan_lastBackupReminder_${currentActivityId}`;
                localStorage.setItem(reminderKey, String(Date.now()));
                
                // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const totalRecords = (items?.length || 0) + (customers?.length || 0) + (suppliers?.length || 0) + 
                                   (purchases?.length || 0) + (sales?.length || 0) + (expenses?.length || 0) + 
                                   (revenues?.length || 0) + (salaries?.length || 0);
                
                // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ø­ØªØ±Ø§ÙÙŠ
                const userChoice = await showConfirmDialog({
                    title: 'ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                    message: `
                        <div style="text-align: center; padding: 10px;">
                            <div style="font-size: 48px; margin-bottom: 15px; animation: pulse 2s infinite;">ğŸ›¡ï¸</div>
                            <h3 style="color: #2c3e50; margin: 0 0 10px 0; font-family: 'Tajawal', sans-serif;">Ø­Ù…Ø§ÙŠØ© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø£ÙˆÙ„ÙˆÙŠØªÙ†Ø§</h3>
                            <div style="margin-bottom: 20px; font-size: 15px; color: #555;">
                                <p style="margin: 5px 0;">Ù†Ø´Ø§Ø·: <strong>${activity.name}</strong></p>
                                <p style="margin: 5px 0;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: <strong>${totalRecords}</strong></p>
                            </div>
                            <p style="color: #e74c3c; font-weight: bold; font-size: 15px; margin-bottom: 20px;">
                                Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù†Ø° Ø£ÙƒØ«Ø± Ù…Ù† 24 Ø³Ø§Ø¹Ø©.
                            </p>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #e9ecef; text-align: right;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span>ğŸ’¡</span>
                                    <strong style="color: #2c3e50; font-size: 14px;">Ù†ØµÙŠØ­Ø©:</strong>
                                </div>
                                <p style="margin: 0; color: #666; font-size: 13px; padding-right: 25px;">
                                    Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙŠØ­Ù…ÙŠÙƒ Ù…Ù† ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙŠØ³ØªØºØ±Ù‚ Ø«ÙˆØ§Ù†Ù ÙÙ‚Ø·.
                                </p>
                            </div>
                        </div>
                    `,
                    type: 'info',
                    confirmText: 'Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ø¢Ù†',
                    cancelText: 'ØªØ°ÙƒÙŠØ±ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹',
                    confirmButtonClass: 'btn-success' // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„ÙˆÙ† Ø£Ø®Ø¶Ø± Ù„Ù„Ø²Ø±
                });
                
                if (userChoice) {
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªØ§Ø± Ø¥Ø¬Ø±Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙˆØ±Ø§Ù‹
                    const success = await performManualBackup();
                    if (success) {
                        showNotification('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'ØªÙ… Ø­ÙØ¸ ÙˆØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙÙŠ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª', 'success');
                    } else {
                        showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
                    }
                } else {
                    showNotification('â„¹ï¸ ØªÙ… ØªØ£Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'Ø³ÙŠØªÙ… ØªØ°ÙƒÙŠØ±Ùƒ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 24 Ø³Ø§Ø¹Ø©', 'info');
                }
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ:', error);
            }
        }
        
        /**
         * Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
         */
        async function showBackupReminderDialog(activityName, totalRecords, dataStats) {
            const confirmed = await showConfirmDialog({
                title: 'ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                message: `
                    <div style="text-align: center; padding: 10px;">
                        <div style="font-size: 48px; margin-bottom: 15px; animation: pulse 2s infinite;">ğŸ›¡ï¸</div>
                        <h3 style="color: #2c3e50; margin: 0 0 10px 0; font-family: 'Tajawal', sans-serif;">Ø­Ù…Ø§ÙŠØ© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø£ÙˆÙ„ÙˆÙŠØªÙ†Ø§</h3>
                        <div style="margin-bottom: 20px; font-size: 15px; color: #555;">
                            <p style="margin: 5px 0;">Ù†Ø´Ø§Ø·: <strong>${activityName}</strong></p>
                            <p style="margin: 5px 0;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: <strong>${totalRecords}</strong></p>
                        </div>
                        <p style="color: #e74c3c; font-weight: bold; font-size: 15px; margin-bottom: 20px;">
                            Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù†Ø° Ø£ÙƒØ«Ø± Ù…Ù† 24 Ø³Ø§Ø¹Ø©.
                        </p>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #e9ecef; text-align: right;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span>ğŸ’¡</span>
                                <strong style="color: #2c3e50; font-size: 14px;">Ù†ØµÙŠØ­Ø©:</strong>
                            </div>
                            <p style="margin: 0; color: #666; font-size: 13px; padding-right: 25px;">
                                Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙŠØ­Ù…ÙŠÙƒ Ù…Ù† ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙŠØ³ØªØºØ±Ù‚ Ø«ÙˆØ§Ù†Ù ÙÙ‚Ø·.
                            </p>
                        </div>
                    </div>
                `,
                type: 'info',
                confirmText: 'Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ø¢Ù†',
                cancelText: 'ØªØ°ÙƒÙŠØ±ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹',
                confirmButtonClass: 'btn-success'
            });
            
            return confirmed ? 'backup_now' : 'dismiss';
        }
        
        /**
         * ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ø¹Ù†Ø¯ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
         */
        async function performManualBackup() {
            if (!currentActivityId) return;
            
            try {
                const activity = activities.find(a => a.id == currentActivityId);
                if (!activity) return;
                
                // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const backupData = {
                    activity: activity,
                    system: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ', // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø§Ù„Ù†Ø¸Ø§Ù…
                    items: items || [],
                    customers: customers || [],
                    suppliers: suppliers || [],
                    purchases: purchases || [],
                    sales: sales || [],
                    expenses: expenses || [],
                    revenues: revenues || [],
                    salaries: salaries || [],
                    backupDate: new Date().toISOString(),
                    backupTimestamp: Date.now(),
                    version: '23.0',
                    backupType: 'manual' // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
                };
                
                // Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ localStorage
                const backupKey = `diwan_manualBackup_${currentActivityId}`;
                const oldBackupsKey = `diwan_manualBackup_old_${currentActivityId}`;
                
                // Ù†Ù‚Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                const oldBackup = localStorage.getItem(backupKey);
                if (oldBackup) {
                    localStorage.setItem(oldBackupsKey, oldBackup);
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                localStorage.setItem(`diwan_lastBackupReminder_${currentActivityId}`, String(Date.now()));
                
                // ğŸ†• ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().split('T')[0] + '_' + new Date().toTimeString().split(' ')[0].replace(/:/g, '-');
                link.href = url;
                link.download = `Ù†Ø³Ø®Ø©_Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©_${activity.name.replace(/\s/g, '_')}_${timestamp}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                debugLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ù†Ø´Ø§Ø·: ${activity.name}`);
                
                return true;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ÙŠØ¯ÙˆÙŠ:', error);
                return false;
            }
        }
        
        /**
         * Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ©
         */
        async function restoreManualBackup() {
            if (!currentActivityId) {
                showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø· Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const backupKey = `diwan_manualBackup_${currentActivityId}`;
            const backupData = localStorage.getItem(backupKey);
            
            if (!backupData) {
                showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø´Ø§Ø·', 'warning');
                return;
            }
            
            const confirmed = await showConfirmDialog(
                'Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©',
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                'warning',
                'Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            
            if (!confirmed) return;
            
            try {
                const backup = JSON.parse(backupData);
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                items = backup.items || [];
                customers = backup.customers || [];
                suppliers = backup.suppliers || [];
                purchases = backup.purchases || [];
                sales = backup.sales || [];
                expenses = backup.expenses || [];
                revenues = backup.revenues || [];
                salaries = backup.salaries || [];
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø© ÙÙŠ Firebase
                saveToLocalStorage('items', items);
                saveToLocalStorage('customers', customers);
                saveToLocalStorage('suppliers', suppliers);
                saveToLocalStorage('purchases', purchases);
                saveToLocalStorage('sales', sales);
                saveToLocalStorage('expenses', expenses);
                saveToLocalStorage('revenues', revenues);
                saveToLocalStorage('salaries', salaries);
                saveToLocalStorage('assets', assets);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                renderItems();
                renderCustomers();
                renderSuppliers();
                renderPurchasesList();
                renderSalesList();
                renderExpenses();
                renderRevenues();
                renderSalaries();
                updateDataStats();
                
                const backupDate = new Date(backup.backupDate);
                showNotification(
                    'âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­',
                    `ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨ØªØ§Ø±ÙŠØ® ${backupDate.toLocaleString('ar-SA')}`,
                    'success'
                );
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
                showNotification('âŒ ÙØ´Ù„Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
            }
        }
        
        /**
         * Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ©
         */
        function showManualBackupInfo() {
            if (!currentActivityId) return;
            
            const backupKey = `diwan_manualBackup_${currentActivityId}`;
            const lastReminderKey = `diwan_lastBackupReminder_${currentActivityId}`;
            
            const backupData = localStorage.getItem(backupKey);
            const lastReminderTime = Number(localStorage.getItem(lastReminderKey) || 0);
            
            if (!backupData) {
                showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯', 'info');
                return;
            }
            
            try {
                const backup = JSON.parse(backupData);
                const backupDate = new Date(backup.backupDate);
                const timeDiff = Date.now() - lastBackupTime;
                const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
                
                let message = `ğŸ“… ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${backupDate.toLocaleString('ar-SA')}\n`;
                message += `â±ï¸ Ù…Ù†Ø°: ${hoursDiff} Ø³Ø§Ø¹Ø©\n`;
                message += `ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù: ${backup.items?.length || 0}\n`;
                message += `ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${backup.customers?.length || 0}\n`;
                message += `ğŸ¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†: ${backup.suppliers?.length || 0}\n`;
                message += `ğŸ’° Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${backup.sales?.length || 0}\n`;
                message += `ğŸ›’ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${backup.purchases?.length || 0}`;
                
                showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', message, 'info');
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
            }
        }
        
        /**
         * ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© ÙƒÙ…Ù„Ù JSON
         */
        function downloadManualBackup() {
            if (!currentActivityId) {
                showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø· Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const backupKey = `diwan_manualBackup_${currentActivityId}`;
            const backupData = localStorage.getItem(backupKey);
            
            if (!backupData) {
                showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø´Ø§Ø·', 'warning');
                return;
            }
            
            try {
                const backup = JSON.parse(backupData);
                const activity = activities.find(a => a.id == currentActivityId);
                const activityName = activity ? activity.name : 'Ø§Ù„Ù†Ø´Ø§Ø·';
                
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ù…Ù„Ù
                const date = new Date();
                const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
                const timeStr = date.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
                const fileName = `Ù†Ø³Ø®Ø©_Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©_ÙŠØ¯ÙˆÙŠØ©_${activityName}_${dateStr}_${timeStr}.json`;
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ JSON Ù…Ù†Ø³Ù‚
                const jsonString = JSON.stringify(backup, null, 2);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Blob ÙˆØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification(
                    'âœ… ØªÙ… Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­',
                    `ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${fileName}`,
                    'success'
                );
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
                showNotification('âŒ ÙØ´Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ±Ù‚ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®ØµÙ… ÙˆØ·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
        async function upgradeSalesData() {
            let dataUpdated = false;
            
            sales.forEach(sale => {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ‡Ø§ Ø­Ù‚Ù„ Ø§Ù„Ø®ØµÙ…ØŒ Ø£Ø¶ÙÙ‡ ÙƒØµÙØ±
                if (sale.discount === undefined) {
                    sale.discount = 0;
                    dataUpdated = true;
                }
                
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ‡Ø§ Ø­Ù‚Ù„ "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…"ØŒ Ø§Ø­Ø³Ø¨Ù‡
                if (sale.afterDiscount === undefined) {
                    sale.afterDiscount = (sale.subtotal || 0) - (sale.discount || 0);
                    dataUpdated = true;
                }
                
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ‡Ø§ Ø­Ù‚Ù„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ØŒ Ø£Ø¶ÙÙ‡ ÙƒÙ€ "ÙƒØ§Ø´"
                if (sale.paymentMethod === undefined) {
                    sale.paymentMethod = 'cash';
                    dataUpdated = true;
                }
            });
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±
            if (dataUpdated) {
                saveToLocalStorage('sales', sales);
                console.log('âœ… ØªÙ… ØªØ±Ù‚ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„ØªØ´Ù…Ù„ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®ØµÙ… ÙˆØ·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹');
            }
        }

        // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… Ù†Ù‚Ù„ ØªØ¹Ø±ÙŠÙ initializeApp Ø¥Ù„Ù‰ Ù…ÙƒØ§Ù† Ù…Ø¨ÙƒØ± ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØª

        // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… Ù†Ù‚Ù„ ØªØ¹Ø±ÙŠÙ initializeApp Ø¥Ù„Ù‰ Ù…ÙƒØ§Ù† Ù…Ø¨ÙƒØ± ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØª

        // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
        function validateSession() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† sessionStorage Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… localStorage
            let loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser') || 'null');
            let isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            let storageType = 'session';
            
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ÙÙŠ sessionStorageØŒ ØªØ­Ù‚Ù‚ Ù…Ù† localStorage
            if (!loggedInUser || !isLoggedIn) {
                loggedInUser = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
                isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                storageType = 'local';
                
                // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª ÙÙŠ localStorageØŒ Ø§Ù†Ø³Ø®Ù‡Ø§ Ø¥Ù„Ù‰ sessionStorage Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø±ÙŠØ¹
                if (loggedInUser && isLoggedIn) {
                    sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                    sessionStorage.setItem('isLoggedIn', 'true');
                }
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø© isLoggedInØŒ Ù‚Ù… Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡Ø§
            if (loggedInUser && !isLoggedIn) {
                if (storageType === 'session') {
                    sessionStorage.setItem('isLoggedIn', 'true');
                } else {
                    localStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('isLoggedIn', 'true');
                }
                return true;
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø¥Ø´Ø§Ø±Ø© isLoggedIn ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù‚Ù… Ø¨Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
            if (isLoggedIn && !loggedInUser) {
                sessionStorage.removeItem('isLoggedIn');
                localStorage.removeItem('isLoggedIn');
                return false;
            }
            
            return isLoggedIn && loggedInUser;
        }
document.addEventListener('DOMContentLoaded', function() {
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            if (window.AUTO_LOGIN_IN_PROGRESS) {
                console.log('ğŸ”’ ØªÙ… ØªØ¬Ø§Ù‡Ù„ DOMContentLoaded Ù„Ø£Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ÙŠØ¯ÙˆÙŠ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©
            const manualLogout = sessionStorage.getItem('manualLogout');
            if (manualLogout) {
                console.log('ğŸš« ØªÙ… Ù…Ù†Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø³Ø¨Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ÙŠØ¯ÙˆÙŠ Ø³Ø§Ø¨Ù‚');
                sessionStorage.removeItem('manualLogout');
                // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                document.getElementById('login-overlay').style.display = 'flex';
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ" Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            const rememberedUser = localStorage.getItem('rememberedUser');
            let autoLoginAttempted = false;
            
            if (rememberedUser) {
                try {
                    const userData = JSON.parse(rememberedUser);
                    const now = new Date().getTime();
                    const dayInMs = 30 * 24 * 60 * 60 * 1000; // 30 ÙŠÙˆÙ…
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (30 ÙŠÙˆÙ…)
                    if (userData.timestamp && (now - userData.timestamp) < dayInMs) {
                        autoLoginAttempted = true;
                        
                        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙˆØ±Ø§Ù‹
                        document.getElementById('login-overlay').style.display = 'none';
                        
                        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ø¹Ø±Ø¶Ù‡Ø§
                        document.getElementById('loginEmail').value = userData.email;
                        document.getElementById('loginPassword').value = userData.password;
                        document.getElementById('rememberMe').checked = true;
                        
                        console.log('ğŸ”„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ"...');
                        
                        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                        setTimeout(() => {
                            handleLogin();
                        }, 100);
                        
                    } else {
                        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
                        console.log('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ" Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©ØŒ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§');
                        localStorage.removeItem('rememberedUser');
                    }
                } catch (e) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª "ØªØ°ÙƒØ±Ù†ÙŠ":', e);
                    localStorage.removeItem('rememberedUser');
                }
            }
            
            // ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
            if (!autoLoginAttempted) {
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('justLoggedOut');
                console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©');
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø­ÙÙˆØ¸
            loadSavedLogo();
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø´Ø¹Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø¥Ø®ÙØ§Ø¡Ù‡ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©
            const loginLogo = document.getElementById('loginLogo');
            if (loginLogo) {
                loginLogo.onerror = function() {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø´Ø¹Ø§Ø± ÙÙŠ localStorage Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø®ÙØ§Ø¡
                    const savedLogo = localStorage.getItem('systemLogo');
                    if (!savedLogo) {
                        this.style.display = 'none';
                    }
                };
            }
            
            const hydrateResponsiveTables = () => {
                const tables = document.querySelectorAll('.section table');
                tables.forEach(table => {
                    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
                    if (!headers.length) return;
                    table.querySelectorAll('tbody tr').forEach(row => {
                        Array.from(row.children).forEach((cell, index) => {
                            if (headers[index]) {
                                cell.setAttribute('data-label', headers[index]);
                            } else {
                                cell.removeAttribute('data-label');
                            }
                        });
                    });
                });
            };

            let responsiveTablesTimer;
            const scheduleResponsiveTablesHydration = () => {
                clearTimeout(responsiveTablesTimer);
                responsiveTablesTimer = setTimeout(hydrateResponsiveTables, 100);
            };

            // Ù…Ø¹ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† Ù…ØµØ§Ø¯Ù‚Ø©
            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ØªÙØ­Ù…Ù„ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            console.log("ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");
            
            // Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
            setTimeout(() => {
                const emailField = document.getElementById('loginEmail');
                const passwordField = document.getElementById('loginPassword');
                if (emailField) emailField.value = '';
                if (passwordField) passwordField.value = '';
            }, 100);
            
            if (EMAILJS_FIXED) {
                emailJsConfig = { ...EMAILJS_DEFAULTS };
            } else {
                const storedEmailJsConfig = JSON.parse(localStorage.getItem('diwan_email_config') || 'null') || {};
                emailJsConfig = {
                    serviceID: storedEmailJsConfig.serviceID || EMAILJS_DEFAULTS.serviceID || '',
                    templateID: storedEmailJsConfig.templateID || EMAILJS_DEFAULTS.templateID || '',
                    resetTemplateID: storedEmailJsConfig.resetTemplateID || EMAILJS_DEFAULTS.resetTemplateID || '',
                    publicKey: storedEmailJsConfig.publicKey || EMAILJS_DEFAULTS.publicKey || ''
                };
            }
            if (!('resetTemplateID' in emailJsConfig) || emailJsConfig.resetTemplateID === undefined) {
                emailJsConfig.resetTemplateID = '';
            }
            if (!EMAILJS_FIXED) {
                loadEmailJsSettings();
            }

            loadActivities();
            // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø«Ø§Ø¨ØªØ©
            if (EMAILJS_FIXED) {
                const toggleBtn = document.getElementById('toggleEmailSettingsBtn');
                if (toggleBtn) toggleBtn.style.display = 'none';
            }
            handleResetFlowFromURL();
            
            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            restoreLoginState();
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„
            FilterSortHelper.makeSortable('itemsTable', 'items', renderItems);
            FilterSortHelper.makeSortable('customersTable', 'customers', renderCustomers);
            FilterSortHelper.makeSortable('suppliersTable', 'suppliers', renderSuppliers);
            FilterSortHelper.makeSortable('salesTable', 'sales', renderSalesList);
            FilterSortHelper.makeSortable('purchasesTable', 'purchases', renderPurchasesList);
            
            // Ø±Ø¨Ø· Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±Ø©
            document.getElementById('searchItems')?.addEventListener('input', renderItems);
            document.getElementById('searchCustomers')?.addEventListener('input', renderCustomers);
            document.getElementById('searchSuppliers')?.addEventListener('input', renderSuppliers);
            document.getElementById('searchSales')?.addEventListener('input', searchSales);
            document.getElementById('searchPurchases')?.addEventListener('input', searchPurchases);
            
            document.addEventListener('click', function(event) {
                const cp = document.getElementById('controlPanel'), dt = document.querySelector('.design-toggle');
                if (cp && cp.classList.contains('show') && !cp.contains(event.target) && !dt.contains(event.target)) {
                    cp.classList.remove('show');
                }
            });

            const tableObserverRoot = document.querySelector('.app-container') || document.body;
            const responsiveTableObserver = new MutationObserver(scheduleResponsiveTablesHydration);
            responsiveTableObserver.observe(tableObserverRoot, { childList: true, subtree: true });
            scheduleResponsiveTablesHydration();

            const loginEmailField = document.getElementById('loginEmail');
            const loginPasswordField = document.getElementById('loginPassword');
            const submitOnEnter = (event) => {
                if (event.key === 'Enter') {
                    handleLogin();
                }
            };
            if (loginEmailField) {
                loginEmailField.addEventListener('keyup', submitOnEnter);
            }
            if (loginPasswordField) {
                loginPasswordField.addEventListener('keyup', submitOnEnter);
            }

            const searchInputs = { 'searchItems': searchItems, 'searchCustomers': searchCustomers, 'searchSuppliers': searchSuppliers, 'searchPurchases': searchPurchases, 'searchSales': searchSales, 'searchExpenses': () => {}, 'searchRevenues': () => {}, 'searchSalaries': searchSalaries };
            let searchTimeout;
            Object.keys(searchInputs).forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.onkeyup = () => {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(searchInputs[id], 300);
                    };
                }
            });
            
            // ØªÙ‡ÙŠØ¦Ø© ÙƒØ´ÙˆÙ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
            initializeAccountStatements();
        });
        
        // Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function restoreLoginState() {

            
    if (window.AUTO_LOGIN_IN_PROGRESS) {
        console.log('ğŸ”„ ØªÙ… ØªØ®Ø·ÙŠ restoreLoginState Ù„Ø£Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„');
        return;
    }
    console.log('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
            console.log('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            createDefaultUser();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø© ÙÙŠ sessionStorage
            const sessionUser = sessionStorage.getItem('loggedInUser');
            const sessionLogin = sessionStorage.getItem('isLoggedIn');
            
            console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©:');
            console.log('sessionLogin:', sessionLogin);
            console.log('sessionUser exists:', !!sessionUser);
            
            let user = null;
            let isLoggedIn = false;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ sessionStorage
            if (sessionLogin === 'true' && sessionUser) {
                try {
                    user = JSON.parse(sessionUser);
                    isLoggedIn = true;
                    console.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ sessionStorage:', user);
                } catch (e) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† sessionStorage:', e);
                }
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡
            if (isLoggedIn && user) {
                console.log('ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©...');
                await loadUsers();
                await loadActivities();
                
                console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', users.length);
                console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù†Ø´Ø·Ø©:', activities.length);
            }
            
            if (isLoggedIn && user) {
                console.log('ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØµØ­ÙŠØ­ØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©...');
                // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                document.getElementById('login-overlay').style.display = 'none';
                document.querySelector('.app-container').style.display = 'flex';
                
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                updateLoggedInUserDisplay(user);
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„Ù…Ø¯ÙŠØ±
                if (user.role === 'admin') {
                    const savedActivityId = sessionStorage.getItem('currentActivityId');
                    console.log('Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø­ÙÙˆØ¸:', savedActivityId);
                    console.log('Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©:', activities.map(a => `${a.id}: ${a.name}`));
                    
                    if (savedActivityId && activities.find(a => a.id == savedActivityId)) {
                        console.log('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø§Ø·:', savedActivityId);
                        await selectActivity(savedActivityId);
                    } else {
                        console.log('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ù…Ø­ÙÙˆØ¸ ØµØ­ÙŠØ­ØŒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ù†Ø´Ø§Ø·');
                        enterAdminWithoutActivity();
                    }
                } else if (user.activityId) {
                    console.log('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', user.activityId);
                    selectActivity(user.activityId);
                }
            } else {
                console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© ØµØ­ÙŠØ­Ø© - Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©:');
                console.log('sessionLogin:', sessionLogin);
                console.log('sessionUser exists:', !!sessionUser);
                console.log('isLoggedIn:', isLoggedIn);
                console.log('user exists:', !!user);
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                document.getElementById('login-overlay').style.display = 'flex';
                document.querySelector('.app-container').style.display = 'none';
            }
        }
        
        // ===== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© =====
        
        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ„ Ø¬Ø¯ÙŠØ¯
        async function addAsset() {
            const name = document.getElementById('assetName').value.trim();
            const type = document.getElementById('assetType').value;
            const purchaseDate = document.getElementById('assetPurchaseDate').value;
            const supplier = document.getElementById('assetSupplier').value.trim();
            const invoiceNumber = document.getElementById('assetInvoiceNumber').value.trim();
            const cost = parseFloat(document.getElementById('assetCost').value);
            const lifespan = parseInt(document.getElementById('assetLifespan').value);
            const salvageValue = parseFloat(document.getElementById('assetSalvageValue').value) || 0;
            const status = document.getElementById('assetStatus').value;
            const notes = document.getElementById('assetNotes').value.trim();

            if (!name || !type || !purchaseDate || !cost || !lifespan) {
                let missingFields = [];
                if (!name) missingFields.push('Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„');
                if (!type) missingFields.push('Ù†ÙˆØ¹ Ø§Ù„Ø£ØµÙ„');
                if (!purchaseDate) missingFields.push('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡');
                if (!cost) missingFields.push('ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡');
                if (!lifespan) missingFields.push('Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ');
                
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', `ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ù„ÙŠØ©: ${missingFields.join('ØŒ ')}`, 'warning');
                return;
            }

            if (cost <= 0 || lifespan <= 0) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±', 'warning');
                return;
            }

            if (salvageValue >= cost) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø±Ø¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡', 'warning');
                return;
            }

            // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            const editingId = document.getElementById('assetForm').getAttribute('data-editing-id');
            
            if (editingId) {
                // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                const assetIndex = assets.findIndex(a => a.id == editingId);
                if (assetIndex !== -1) {
                    const oldCode = assets[assetIndex].code;
                    assets[assetIndex] = {
                        ...assets[assetIndex],
                        name,
                        type,
                        purchaseDate,
                        supplier,
                        invoiceNumber,
                        cost,
                        lifespan,
                        salvageValue,
                        status,
                        notes
                    };
                    
                    try {
                        saveToLocalStorage('assets', assets);
                        showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØµÙ„ "${name}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                        resetAssetForm();
                        displayAssets();
                        updateAssetsStats();
                    } catch (error) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØµÙ„:', error);
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØµÙ„', 'error');
                    }
                }
            } else {
                // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                const asset = {
                    id: Date.now(),
                    code: `ASSET${(assets.length + 1).toString().padStart(3, '0')}`,
                    name,
                    type,
                    purchaseDate,
                    supplier,
                    invoiceNumber,
                    cost,
                    lifespan,
                    salvageValue,
                    status,
                    notes,
                    createdAt: new Date().toISOString()
                };

                assets.push(asset);
                
                try {
                    saveToLocalStorage('assets', assets);
                    showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ„ "${name}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                    resetAssetForm();
                    displayAssets();
                    updateAssetsStats();
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„:', error);
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„', 'error');
                    assets.pop(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸
                }
            }
        }

        // Ø¯Ø§Ù„Ø© ØªÙØ±ÙŠØº Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£ØµÙˆÙ„
        async function clearAssetForm() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            const confirmed = await confirmCancelEdit('#assetForm');
            if (!confirmed) return;
            
            resetAssetForm();
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£ØµÙˆÙ„ (Ø¨Ø¯ÙˆÙ† ØªØ£ÙƒÙŠØ¯)
        function resetAssetForm() {
            document.getElementById('assetName').value = '';
            document.getElementById('assetType').value = '';
            document.getElementById('assetPurchaseDate').value = '';
            document.getElementById('assetSupplier').value = '';
            document.getElementById('assetInvoiceNumber').value = '';
            document.getElementById('assetCost').value = '';
            document.getElementById('assetLifespan').value = '';
            document.getElementById('assetSalvageValue').value = '';
            document.getElementById('assetStatus').value = 'active';
            document.getElementById('assetNotes').value = '';
            
            // Ø­Ø°Ù Ù…Ø¹Ø±Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¥Ù† ÙˆØ¬Ø¯
            document.getElementById('assetForm').removeAttribute('data-editing-id');
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            const formTitle = document.querySelector('#assetForm h3');
            if (formTitle) {
                formTitle.innerHTML = 'Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ„ Ø«Ø§Ø¨Øª Ø¬Ø¯ÙŠØ¯';
                formTitle.style.color = '';
            }
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            const formInputs = document.querySelectorAll('#assetForm input, #assetForm select, #assetForm textarea');
            formInputs.forEach(input => {
                input.classList.remove('editing-mode');
            });
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            const submitBtn = document.querySelector('#assetForm .btn-primary');
            if (submitBtn) {
                submitBtn.innerHTML = 'â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ„';
                submitBtn.classList.remove('update-mode');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ
        function calculateDepreciation(asset) {
            const depreciableValue = asset.cost - asset.salvageValue;
            const annualDepreciation = depreciableValue / asset.lifespan;
            
            const purchaseDate = new Date(asset.purchaseDate);
            const currentDate = new Date();
            const monthsElapsed = (currentDate.getFullYear() - purchaseDate.getFullYear()) * 12 + 
                                (currentDate.getMonth() - purchaseDate.getMonth()) + 
                                (currentDate.getDate() >= purchaseDate.getDate() ? 0 : -1);
            
            const yearsElapsed = Math.max(0, monthsElapsed / 12);
            const accumulatedDepreciation = Math.min(annualDepreciation * yearsElapsed, depreciableValue);
            const bookValue = asset.cost - accumulatedDepreciation;
            
            return {
                annualDepreciation: annualDepreciation,
                accumulatedDepreciation: accumulatedDepreciation,
                bookValue: Math.max(bookValue, asset.salvageValue),
                yearsElapsed: yearsElapsed
            };
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙˆÙ„
        function displayAssets() {
            const assetsList = document.getElementById('assetsList');
            const searchTerm = document.getElementById('searchAssets').value.toLowerCase();
            const typeFilter = document.getElementById('filterAssetType').value;
            const statusFilter = document.getElementById('filterAssetStatus').value;

            let filteredAssets = assets.filter(asset => {
                const matchesSearch = asset.name.toLowerCase().includes(searchTerm) ||
                                    asset.code.toLowerCase().includes(searchTerm) ||
                                    asset.supplier.toLowerCase().includes(searchTerm);
                const matchesType = !typeFilter || asset.type === typeFilter;
                const matchesStatus = !statusFilter || asset.status === statusFilter;
                
                return matchesSearch && matchesType && matchesStatus;
            });

            assetsList.innerHTML = filteredAssets.map(asset => {
                const depreciation = calculateDepreciation(asset);
                const typeIcons = {
                    'computers': 'ğŸ’»',
                    'furniture': 'ğŸª‘',
                    'vehicles': 'ğŸš—',
                    'equipment': 'âš™ï¸',
                    'electronics': 'ğŸ“±',
                    'buildings': 'ğŸ¢',
                    'other': 'ğŸ“¦'
                };
                
                const statusIcons = {
                    'active': 'ğŸŸ¢',
                    'maintenance': 'ğŸŸ¡',
                    'inactive': 'ğŸ”´'
                };

                return `
                    <tr>
                        <td>${asset.code}</td>
                        <td>${asset.name}</td>
                        <td>${typeIcons[asset.type]} ${getAssetTypeLabel(asset.type)}</td>
                        <td>${asset.purchaseDate}</td>
                        <td>${asset.cost.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                        <td>${asset.lifespan} Ø³Ù†ÙˆØ§Øª</td>
                        <td>${depreciation.annualDepreciation.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                        <td>${depreciation.accumulatedDepreciation.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                        <td>${depreciation.bookValue.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                        <td>${statusIcons[asset.status]} ${getAssetStatusLabel(asset.status)}</td>
                        <td style="white-space: nowrap;">
                            <button class="btn-warning" onclick="editAsset(${asset.id})" title="ØªØ¹Ø¯ÙŠÙ„" style="background: #2c5aa0; border-color: #2c5aa0;">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn-danger" onclick="deleteAsset(${asset.id})" title="Ø­Ø°Ù">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ³Ù…ÙŠØ© Ù†ÙˆØ¹ Ø§Ù„Ø£ØµÙ„
        function getAssetTypeLabel(type) {
            const labels = {
                'computers': 'Ø£Ø¬Ù‡Ø²Ø© ÙƒÙ…Ø¨ÙŠÙˆØªØ±',
                'furniture': 'Ø£Ø«Ø§Ø« Ù…ÙƒØªØ¨ÙŠ',
                'vehicles': 'Ø³ÙŠØ§Ø±Ø§Øª ÙˆÙ…Ø±ÙƒØ¨Ø§Øª',
                'equipment': 'Ù…Ø¹Ø¯Ø§Øª ÙˆØ¢Ù„Ø§Øª',
                'electronics': 'Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©',
                'buildings': 'Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ¹Ù‚Ø§Ø±Ø§Øª',
                'other': 'Ø£Ø®Ø±Ù‰'
            };
            return labels[type] || type;
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ³Ù…ÙŠØ© Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„
        function getAssetStatusLabel(status) {
            const labels = {
                'active': 'Ù†Ø´Ø·',
                'maintenance': 'ØªØ­Øª Ø§Ù„ØµÙŠØ§Ù†Ø©',
                'inactive': 'ØºÙŠØ± Ù†Ø´Ø·'
            };
            return labels[status] || status;
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£ØµÙˆÙ„
        function updateAssetsStats() {
            const totalValue = assets.reduce((sum, asset) => sum + asset.cost, 0);
            const totalDepreciation = assets.reduce((sum, asset) => {
                const depreciation = calculateDepreciation(asset);
                return sum + depreciation.accumulatedDepreciation;
            }, 0);
            const netValue = totalValue - totalDepreciation;
            const totalCount = assets.length;

            document.getElementById('totalAssetsValue').textContent = totalValue.toFixed(2);
            document.getElementById('totalDepreciation').textContent = totalDepreciation.toFixed(2);
            document.getElementById('netAssetsValue').textContent = netValue.toFixed(2);
            document.getElementById('totalAssetsCount').textContent = totalCount;
            document.getElementById('miniStatAssets').textContent = netValue.toFixed(2);
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø£ØµÙ„
        async function deleteAsset(assetId) {
            const asset = assets.find(a => a.id === assetId);
            if (!asset) return;

            const confirmed = await showConfirmDialog({
                title: 'ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø£ØµÙ„',
                message: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø£ØµÙ„ "${asset.name}"ØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.`,
                type: 'danger',
                icon: 'âš ï¸',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡',
                confirmButtonClass: 'danger'
            });

            if (confirmed) {
                const index = assets.findIndex(a => a.id === assetId);
                assets.splice(index, 1);
                
                try {
                    saveToLocalStorage('assets', assets);
                    showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£ØµÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    displayAssets();
                    updateAssetsStats();
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø£ØµÙ„:', error);
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø£ØµÙ„', 'error');
                }
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø£ØµÙ„ (Ù…Ø¨Ø³Ø·Ø©)
        function editAsset(assetId) {
            const asset = assets.find(a => a.id === assetId);
            if (!asset) return;

            // Ù…Ù„Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
            document.getElementById('assetName').value = asset.name;
            document.getElementById('assetType').value = asset.type;
            document.getElementById('assetPurchaseDate').value = asset.purchaseDate;
            document.getElementById('assetSupplier').value = asset.supplier;
            document.getElementById('assetInvoiceNumber').value = asset.invoiceNumber;
            document.getElementById('assetCost').value = asset.cost;
            document.getElementById('assetLifespan').value = asset.lifespan;
            document.getElementById('assetSalvageValue').value = asset.salvageValue;
            document.getElementById('assetStatus').value = asset.status;
            document.getElementById('assetNotes').value = asset.notes;

            // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ø£ØµÙ„ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡
            document.getElementById('assetForm').setAttribute('data-editing-id', assetId);
            
            // ØªØºÙŠÙŠØ± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            const formTitle = document.querySelector('#assetForm h3');
            if (formTitle) {
                formTitle.innerHTML = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ØµÙ„: ' + asset.name;
                formTitle.style.color = '#28a745';
            }
            
            // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ù„Ù„Ù…Ø¤Ø«Ø± Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø£Ø®Ø¶Ø±
            const formInputs = document.querySelectorAll('#assetForm input, #assetForm select, #assetForm textarea');
            formInputs.forEach(input => {
                input.classList.add('editing-mode');
            });
            
            // ØªØºÙŠÙŠØ± Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
            const submitBtn = document.querySelector('#assetForm .btn-primary');
            if (submitBtn) {
                submitBtn.innerHTML = 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØµÙ„';
                submitBtn.classList.add('update-mode');
            }
            
            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
            document.getElementById('assetForm').scrollIntoView({ behavior: 'smooth' });
            
            // Ù†Ù‚Ù„ Ø§Ù„Ù…Ø¤Ø´Ø± Ù„Ù„Ø­Ù‚Ù„ Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
            setTimeout(() => {
                document.getElementById('assetName').focus();
                document.getElementById('assetName').select();
            }, 500);
        }

        // ===== Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© =====
        
        // ===== Ø¯ÙˆØ§Ù„ Ø·Ø¨Ø§Ø¹Ø© ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„ =====
        
        // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„ Ø¥Ù„Ù‰ Excel
        function exportAssetsToExcel() {
console.log('ğŸ” Reached exportAssetsToExcel function...');
            try {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
                const filteredAssets = getFilteredAssets();
                
                if (filteredAssets.length === 0) {
                    showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆÙ„ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§', 'warning');
                    return;
                }

                // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Excel
                const worksheetData = [];
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                worksheetData.push(['ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ©']);
                worksheetData.push(['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + new Date().toLocaleDateString('ar-SA')]);
                worksheetData.push(['']); // Ø³Ø·Ø± ÙØ§Ø±Øº
                
                // Ø¥Ø¶Ø§ÙØ© Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                worksheetData.push([
                    'ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„',
                    'Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„', 
                    'Ø§Ù„Ù†ÙˆØ¹',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡',
                    'Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ø±ÙŠØ§Ù„)',
                    'Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ (Ø³Ù†ÙˆØ§Øª)',
                    'Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ Ø§Ù„Ø³Ù†ÙˆÙŠ (Ø±ÙŠØ§Ù„)',
                    'Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ (Ø±ÙŠØ§Ù„)',
                    'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØªØ±ÙŠØ© (Ø±ÙŠØ§Ù„)',
                    'Ø§Ù„Ø­Ø§Ù„Ø©',
                    'Ø§Ù„Ù…ÙˆØ±Ø¯',
                    'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª'
                ]);
                
                // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙˆÙ„
                filteredAssets.forEach(asset => {
                    const depreciation = calculateDepreciation(asset);
                    worksheetData.push([
                        asset.code,
                        asset.name,
                        getAssetTypeLabel(asset.type),
                        asset.purchaseDate,
                        asset.cost.toFixed(2),
                        asset.lifespan,
                        depreciation.annualDepreciation.toFixed(2),
                        depreciation.accumulatedDepreciation.toFixed(2),
                        depreciation.bookValue.toFixed(2),
                        getAssetStatusLabel(asset.status),
                        asset.supplier || '',
                        asset.invoiceNumber || '',
                        asset.notes || ''
                    ]);
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± ÙØ§Ø±Øº
                worksheetData.push(['']);
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const totalValue = filteredAssets.reduce((sum, asset) => sum + asset.cost, 0);
                const totalDepreciation = filteredAssets.reduce((sum, asset) => {
                    const depreciation = calculateDepreciation(asset);
                    return sum + depreciation.accumulatedDepreciation;
                }, 0);
                const netValue = totalValue - totalDepreciation;
                
                worksheetData.push(['Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:']);
                worksheetData.push(['Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆÙ„:', filteredAssets.length]);
                worksheetData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙˆÙ„:', totalValue.toFixed(2) + ' Ø±ÙŠØ§Ù„']);
                worksheetData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ:', totalDepreciation.toFixed(2) + ' Ø±ÙŠØ§Ù„']);
                worksheetData.push(['ØµØ§ÙÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙˆÙ„:', netValue.toFixed(2) + ' Ø±ÙŠØ§Ù„']);

                // Ø¥Ù†Ø´Ø§Ø¡ workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(worksheetData);
                
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶
                ws['!cols'] = [
                    { width: 12 }, // ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„
                    { width: 25 }, // Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„
                    { width: 18 }, // Ø§Ù„Ù†ÙˆØ¹
                    { width: 15 }, // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡
                    { width: 18 }, // Ø§Ù„ØªÙƒÙ„ÙØ©
                    { width: 18 }, // Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ
                    { width: 18 }, // Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ Ø§Ù„Ø³Ù†ÙˆÙŠ
                    { width: 18 }, // Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ
                    { width: 18 }, // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØªØ±ÙŠØ©
                    { width: 15 }, // Ø§Ù„Ø­Ø§Ù„Ø©
                    { width: 20 }, // Ø§Ù„Ù…ÙˆØ±Ø¯
                    { width: 15 }, // Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                    { width: 30 }  // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                ];

                XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ©");
                
                // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù
                const fileName = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø£ØµÙˆÙ„_Ø§Ù„Ø«Ø§Ø¨ØªØ©_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', `ØªÙ… ØªØµØ¯ÙŠØ± ${filteredAssets.length} Ø£ØµÙ„ Ø¥Ù„Ù‰ Excel Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Excel:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Excel', 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„
        function printAssetsReport() {
            try {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
                const filteredAssets = getFilteredAssets();
                
                if (filteredAssets.length === 0) {
                    showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'warning');
                    return;
                }

                // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
                let printHTML = `
                    <html dir="rtl">
                    <head>
                        <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ©</title>
                        <style>
                            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .header h1 { color: #2c5aa0; margin-bottom: 10px; }
                            .header p { color: #666; margin: 5px 0; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                            th { background-color: #2c5aa0; color: white; font-weight: bold; }
                            tr:nth-child(even) { background-color: #f9f9f9; }
                            .summary { background-color: #f0f7ff; padding: 15px; border-radius: 5px; margin-top: 20px; }
                            .summary h3 { color: #2c5aa0; margin-bottom: 10px; }
                            .summary-item { margin: 5px 0; }
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>ğŸ¢ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ©</h1>
                            <p>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleDateString('ar-SA')}</p>
                            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆÙ„: ${filteredAssets.length}</p>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„</th>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„</th>
                                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                                    <th>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
                                    <th>Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ</th>
                                    <th>Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ Ø§Ù„Ø³Ù†ÙˆÙŠ</th>
                                    <th>Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ</th>
                                    <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØªØ±ÙŠØ©</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙˆÙ„
                filteredAssets.forEach(asset => {
                    const depreciation = calculateDepreciation(asset);
                    const statusIcons = {
                        'active': 'ğŸŸ¢',
                        'maintenance': 'ğŸŸ¡',
                        'inactive': 'ğŸ”´'
                    };
                    
                    printHTML += `
                        <tr>
                            <td>${asset.code}</td>
                            <td>${asset.name}</td>
                            <td>${getAssetTypeLabel(asset.type)}</td>
                            <td>${asset.purchaseDate}</td>
                            <td>${asset.cost.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${asset.lifespan} Ø³Ù†ÙˆØ§Øª</td>
                            <td>${depreciation.annualDepreciation.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${depreciation.accumulatedDepreciation.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${depreciation.bookValue.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${statusIcons[asset.status]} ${getAssetStatusLabel(asset.status)}</td>
                        </tr>
                    `;
                });

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const totalValue = filteredAssets.reduce((sum, asset) => sum + asset.cost, 0);
                const totalDepreciation = filteredAssets.reduce((sum, asset) => {
                    const depreciation = calculateDepreciation(asset);
                    return sum + depreciation.accumulatedDepreciation;
                }, 0);
                const netValue = totalValue - totalDepreciation;

                printHTML += `
                            </tbody>
                        </table>
                        
                        <div class="summary">
                            <h3>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
                            <div class="summary-item"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆÙ„:</strong> ${filteredAssets.length} Ø£ØµÙ„</div>
                            <div class="summary-item"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙˆÙ„:</strong> ${totalValue.toFixed(2)} Ø±ÙŠØ§Ù„</div>
                            <div class="summary-item"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ:</strong> ${totalDepreciation.toFixed(2)} Ø±ÙŠØ§Ù„</div>
                            <div class="summary-item"><strong>ØµØ§ÙÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙˆÙ„:</strong> ${netValue.toFixed(2)} Ø±ÙŠØ§Ù„</div>
                        </div>
                    </body>
                    </html>
                `;

                // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printHTML);
                printWindow.document.close();
                
                // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø«Ù… Ø·Ø¨Ø§Ø¹Ø©
                printWindow.onload = function() {
                    printWindow.print();
                };
                
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²', 'ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
        function getFilteredAssets() {
            const searchTerm = document.getElementById('searchAssets').value.toLowerCase();
            const typeFilter = document.getElementById('filterAssetType').value;
            const statusFilter = document.getElementById('filterAssetStatus').value;

            return assets.filter(asset => {
                const matchesSearch = asset.name.toLowerCase().includes(searchTerm) ||
                                    asset.code.toLowerCase().includes(searchTerm) ||
                                    asset.supplier.toLowerCase().includes(searchTerm);
                const matchesType = !typeFilter || asset.type === typeFilter;
                const matchesStatus = !statusFilter || asset.status === statusFilter;
                
                return matchesSearch && matchesType && matchesStatus;
            });
        }
        
        // ===== Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø·Ø¨Ø§Ø¹Ø© ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„ =====
        
        // ===== Ø¯ÙˆØ§Ù„ Ø·Ø¨Ø§Ø¹Ø© ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨ =====
        
        // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø¥Ù„Ù‰ Excel
        function exportSalariesToExcel() {
            try {
                // Ø¥Ø¶Ø§ÙØ© ØªØ´Ø®ÙŠØµ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                console.log('ğŸ” ØªØ´Ø®ÙŠØµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:');
                console.log('Ù…ØªØºÙŠØ± salaries:', salaries);
                console.log('Ø·ÙˆÙ„ Ù…ØµÙÙˆÙØ© salaries:', salaries ? salaries.length : 'ØºÙŠØ± Ù…Ø¹Ø±Ù');
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
                const filteredSalaries = getSalariesForExport();
                console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©:', filteredSalaries);
                console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©:', filteredSalaries.length);
                
                if (filteredSalaries.length === 0) {
                    showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙŠØ±Ø§Øª Ø±ÙˆØ§ØªØ¨ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§. Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${salaries ? salaries.length : 0}`, 'warning');
                    return;
                }

                // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Excel
                const worksheetData = [];
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                worksheetData.push(['ØªÙ‚Ø±ÙŠØ± Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨']);
                worksheetData.push(['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + new Date().toLocaleDateString('ar-SA')]);
                worksheetData.push(['']); // Ø³Ø·Ø± ÙØ§Ø±Øº
                
                // Ø¥Ø¶Ø§ÙØ© Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                worksheetData.push([
                    'Ø§Ù„Ù…ÙˆØ¸Ù',
                    'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©',
                    'Ø§Ù„Ø¬Ù†Ø³ÙŠØ©',
                    'Ø§Ù„Ø´Ù‡Ø±',
                    'Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ',
                    'Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ø±ÙŠØ§Ù„)',
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª (Ø±ÙŠØ§Ù„)',
                    'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø±ÙŠØ§Ù„)',
                    'Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ GOSI (Ø±ÙŠØ§Ù„)',
                    'Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰ (Ø±ÙŠØ§Ù„)',
                    'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨ (Ø±ÙŠØ§Ù„)',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©'
                ]);
                
                // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨
                filteredSalaries.forEach(salary => {
                    worksheetData.push([
                        salary.employeeName || '',
                        salary.nationalId || '',
                        salary.nationality || '',
                        salary.month || '',
                        salary.jobTitle || '',
                        (salary.basicSalary || 0).toFixed(2),
                        (salary.totalAllowances || 0).toFixed(2),
                        (salary.grossSalary || 0).toFixed(2),
                        (salary.gosiDeduction || 0).toFixed(2),
                        (salary.otherDeductions || 0).toFixed(2),
                        (salary.netSalary || 0).toFixed(2),
                        new Date(salary.createdAt || Date.now()).toLocaleDateString('ar-SA')
                    ]);
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± ÙØ§Ø±Øº
                worksheetData.push(['']);
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const totalBasicSalary = filteredSalaries.reduce((sum, salary) => sum + (salary.basicSalary || 0), 0);
                const totalAllowances = filteredSalaries.reduce((sum, salary) => sum + (salary.totalAllowances || 0), 0);
                const totalGrossSalary = filteredSalaries.reduce((sum, salary) => sum + (salary.grossSalary || 0), 0);
                const totalGosiDeduction = filteredSalaries.reduce((sum, salary) => sum + (salary.gosiDeduction || 0), 0);
                const totalOtherDeductions = filteredSalaries.reduce((sum, salary) => sum + (salary.otherDeductions || 0), 0);
                const totalNetSalary = filteredSalaries.reduce((sum, salary) => sum + (salary.netSalary || 0), 0);
                
                worksheetData.push(['Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:']);
                worksheetData.push(['Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:', filteredSalaries.length]);
                worksheetData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:', totalBasicSalary.toFixed(2) + ' Ø±ÙŠØ§Ù„']);
                worksheetData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª:', totalAllowances.toFixed(2) + ' Ø±ÙŠØ§Ù„']);
                worksheetData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨:', totalGrossSalary.toFixed(2) + ' Ø±ÙŠØ§Ù„']);
                worksheetData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª GOSI:', totalGosiDeduction.toFixed(2) + ' Ø±ÙŠØ§Ù„']);
                worksheetData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰:', totalOtherDeductions.toFixed(2) + ' Ø±ÙŠØ§Ù„']);
                worksheetData.push(['ØµØ§ÙÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨:', totalNetSalary.toFixed(2) + ' Ø±ÙŠØ§Ù„']);

                // Ø¥Ù†Ø´Ø§Ø¡ workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(worksheetData);
                
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶
                ws['!cols'] = [
                    { width: 20 }, // Ø§Ù„Ù…ÙˆØ¸Ù
                    { width: 18 }, // Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
                    { width: 15 }, // Ø§Ù„Ø¬Ù†Ø³ÙŠØ©
                    { width: 12 }, // Ø§Ù„Ø´Ù‡Ø±
                    { width: 20 }, // Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
                    { width: 18 }, // Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                    { width: 18 }, // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª
                    { width: 15 }, // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                    { width: 18 }, // Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ GOSI
                    { width: 18 }, // Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰
                    { width: 18 }, // ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨
                    { width: 15 }  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                ];

                XLSX.utils.book_append_sheet(wb, ws, "Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨");
                
                // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù
                const fileName = `ØªÙ‚Ø±ÙŠØ±_Ù…Ø³ÙŠØ±Ø§Øª_Ø§Ù„Ø±ÙˆØ§ØªØ¨_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', `ØªÙ… ØªØµØ¯ÙŠØ± ${filteredSalaries.length} Ù…Ø³ÙŠØ±Ø© Ø±Ø§ØªØ¨ Ø¥Ù„Ù‰ Excel Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Excel:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Excel', 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨
        function printSalariesReport() {
            try {
                // Ø¥Ø¶Ø§ÙØ© ØªØ´Ø®ÙŠØµ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                console.log('ğŸ–¨ï¸ ØªØ´Ø®ÙŠØµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:');
                console.log('Ù…ØªØºÙŠØ± salaries:', salaries);
                console.log('Ø·ÙˆÙ„ Ù…ØµÙÙˆÙØ© salaries:', salaries ? salaries.length : 'ØºÙŠØ± Ù…Ø¹Ø±Ù');
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
                const filteredSalaries = getSalariesForExport();
                console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©:', filteredSalaries);
                console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©:', filteredSalaries.length);
                
                if (filteredSalaries.length === 0) {
                    showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙŠØ±Ø§Øª Ø±ÙˆØ§ØªØ¨ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©. Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${salaries ? salaries.length : 0}`, 'warning');
                    return;
                }

                // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
                let printHTML = `
                    <html dir="rtl">
                    <head>
                        <title>ØªÙ‚Ø±ÙŠØ± Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨</title>
                        <style>
                            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .header h1 { color: #2c5aa0; margin-bottom: 10px; }
                            .header p { color: #666; margin: 5px 0; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px; }
                            th, td { border: 1px solid #ddd; padding: 6px; text-align: right; }
                            th { background-color: #2c5aa0; color: white; font-weight: bold; }
                            tr:nth-child(even) { background-color: #f9f9f9; }
                            .summary { background-color: #f0f7ff; padding: 15px; border-radius: 5px; margin-top: 20px; }
                            .summary h3 { color: #2c5aa0; margin-bottom: 10px; }
                            .summary-item { margin: 5px 0; }
                            .net-salary { font-weight: bold; color: #28a745; }
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>ğŸ’¼ ØªÙ‚Ø±ÙŠØ± Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨</h1>
                            <p>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleDateString('ar-SA')}</p>
                            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ${filteredSalaries.length}</p>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                                    <th>Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</th>
                                    <th>Ø§Ù„Ø´Ù‡Ø±</th>
                                    <th>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                                    <th>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
                                    <th>Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                    <th>GOSI</th>
                                    <th>Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰</th>
                                    <th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨
                filteredSalaries.forEach(salary => {
                    printHTML += `
                        <tr>
                            <td>${salary.employeeName || ''}</td>
                            <td>${salary.nationalId || ''}</td>
                            <td>${salary.nationality || ''}</td>
                            <td>${salary.month || ''}</td>
                            <td>${salary.jobTitle || ''}</td>
                            <td>${(salary.basicSalary || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${(salary.totalAllowances || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${(salary.grossSalary || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${(salary.gosiDeduction || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td>${(salary.otherDeductions || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                            <td class="net-salary">${(salary.netSalary || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                        </tr>
                    `;
                });

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const totalBasicSalary = filteredSalaries.reduce((sum, salary) => sum + (salary.basicSalary || 0), 0);
                const totalAllowances = filteredSalaries.reduce((sum, salary) => sum + (salary.totalAllowances || 0), 0);
                const totalGrossSalary = filteredSalaries.reduce((sum, salary) => sum + (salary.grossSalary || 0), 0);
                const totalGosiDeduction = filteredSalaries.reduce((sum, salary) => sum + (salary.gosiDeduction || 0), 0);
                const totalOtherDeductions = filteredSalaries.reduce((sum, salary) => sum + (salary.otherDeductions || 0), 0);
                const totalNetSalary = filteredSalaries.reduce((sum, salary) => sum + (salary.netSalary || 0), 0);

                printHTML += `
                            </tbody>
                        </table>
                        
                        <div class="summary">
                            <h3 style="text-align: center; color: #2c5aa0; margin-bottom: 20px; border-bottom: 2px solid #2c5aa0; padding-bottom: 10px;">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
                            
                            <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ù†Ø¸Ù… -->
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px; background: #f8f9fa;">
                                <tbody>
                                    <tr style="background: #e3f2fd;">
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; font-weight: bold; background: #2c5aa0; color: white; width: 30%;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; text-align: center; font-weight: bold; color: #2c5aa0;">${filteredSalaries.length} Ù…ÙˆØ¸Ù</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; font-weight: bold; background: #2c5aa0; color: white; width: 30%;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; text-align: center; font-weight: bold; color: #27ae60;">${totalBasicSalary.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; font-weight: bold; background: #2c5aa0; color: white;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; text-align: center; font-weight: bold; color: #f39c12;">${totalAllowances.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; font-weight: bold; background: #2c5aa0; color: white;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; text-align: center; font-weight: bold; color: #9b59b6;">${totalGrossSalary.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                                    </tr>
                                    <tr style="background: #ffebee;">
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; font-weight: bold; background: #2c5aa0; color: white;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª GOSI</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; text-align: center; font-weight: bold; color: #e74c3c;">${totalGosiDeduction.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; font-weight: bold; background: #2c5aa0; color: white;">Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰</td>
                                        <td style="border: 1px solid #2c5aa0; padding: 12px; text-align: center; font-weight: bold; color: #8e44ad;">${totalOtherDeductions.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- ØµØ§ÙÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙÙŠ Ù…Ø±Ø¨Ø¹ Ù…Ù…ÙŠØ² -->
                            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #e8f5e8, #f0fff0); border: 3px solid #2ecc71; border-radius: 10px; text-align: center; box-shadow: 0 4px 8px rgba(46, 204, 113, 0.2);">
                                <h2 style="margin: 0; color: #2ecc71; font-size: 1.8em;">ğŸ’¼ ØµØ§ÙÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h2>
                                <div style="font-size: 2.2em; font-weight: bold; color: #27ae60; margin-top: 10px;">${totalNetSalary.toFixed(2)} Ø±ÙŠØ§Ù„</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
                            </div>
                        </div>
                    </body>
                    </html>
                `;

                // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printHTML);
                printWindow.document.close();
                
                // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø«Ù… Ø·Ø¨Ø§Ø¹Ø©
                printWindow.onload = function() {
                    printWindow.print();
                };
                
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²', 'ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:', error);
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
        function getFilteredSalaries() {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ØªØºÙŠØ± ÙˆØ£Ù†Ù‡ Ù…ØµÙÙˆÙØ©
            if (!salaries || !Array.isArray(salaries)) {
                console.warn('Ù…ØµÙÙˆÙØ© Ø§Ù„Ø±ÙˆØ§ØªØ¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ ÙØ§Ø±ØºØ©:', salaries);
                return [];
            }
            
            const searchElement = document.getElementById('searchSalaries');
            const searchTerm = searchElement ? searchElement.value.toLowerCase() : '';

            return salaries.filter(salary => {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¨Ø­Ø«ØŒ Ø£Ø±Ø¬Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (!searchTerm) return true;
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ù‚Ø¨Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§
                const matchesSearch = (salary.employeeName || '').toLowerCase().includes(searchTerm) ||
                                    (salary.nationalId || '').toLowerCase().includes(searchTerm) ||
                                    (salary.nationality || '').toLowerCase().includes(searchTerm) ||
                                    (salary.month || '').toLowerCase().includes(searchTerm) ||
                                    (salary.jobTitle || '').toLowerCase().includes(searchTerm);
                
                return matchesSearch;
            });
        }

        // Ø¯Ø§Ù„Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§ØªØ¨ (ØªØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ renderSalaries)
        function getSalariesForExport() {
            if (!salaries || !Array.isArray(salaries)) {
                console.warn('Ù…ØµÙÙˆÙØ© Ø§Ù„Ø±ÙˆØ§ØªØ¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                return [];
            }

            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶
            return salaries.map(salary => {
                const allowances = typeof salary.allowancesTotal === 'number'
                    ? salary.allowancesTotal
                    : (salary.housing || 0) + (salary.transport || 0) + (salary.otherAllowances || 0) + (salary.overtime || 0);
                
                const gross = typeof salary.gross === 'number' ? salary.gross : (salary.basic || 0) + allowances;
                const gosiEmployee = salary.gosiEmployee || 0;
                const otherDeductions = salary.otherDeductions || 0;
                const net = typeof salary.net === 'number' ? salary.net : gross - gosiEmployee - otherDeductions;

                return {
                    employeeName: salary.employeeName || '',
                    nationalId: salary.nationalId || '',
                    nationality: salary.nationality || '',
                    month: salary.month || '',
                    jobTitle: salary.jobTitle || '',
                    basicSalary: salary.basic || 0,
                    totalAllowances: allowances,
                    grossSalary: gross,
                    gosiDeduction: gosiEmployee,
                    otherDeductions: otherDeductions,
                    netSalary: net,
                    createdAt: salary.createdAt || Date.now()
                };
            });
        }
        
        // ===== Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø·Ø¨Ø§Ø¹Ø© ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨ =====
        
        // Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© ÙƒØ´ÙˆÙ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        function initializeAccountStatements() {
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const today = new Date().toISOString().split('T')[0];
            const statementFromInput = document.getElementById('statementFrom');
            const statementToInput = document.getElementById('statementTo');
            
            if (statementFromInput) statementFromInput.value = today;
            if (statementToInput) statementToInput.value = today;
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            const statementTypeSelect = document.getElementById('statementType');
            if (statementTypeSelect) {
                statementTypeSelect.value = '';
                // Ù„Ø§ Ù†Ø³ØªØ¯Ø¹ÙŠ changeStatementType() Ù„ØªØ±ÙƒÙ‡ ÙØ§Ø±Øº
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙÙ„Ø§ØªØ±
            populateSpecificSupplierFilter();
            populateSpecificCustomerFilter();
            populateSpecificEmployeeFilter();
        }

        // ===== Password Management =====
        function openChangePasswordModal() {
            const isLogged = sessionStorage.getItem('isLoggedIn') === 'true';
            if (!isLogged) { alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.'); return; }
            const oldEl = document.getElementById('cp-old');
            const newEl = document.getElementById('cp-new');
            const confEl = document.getElementById('cp-confirm');
            if (!oldEl || !newEl || !confEl) return;
            oldEl.value = '';
            newEl.value = '';
            confEl.value = '';
            document.getElementById('change-password-overlay').style.display = 'flex';
        }
        function closeChangePasswordModal() {
            const overlay = document.getElementById('change-password-overlay');
            if (overlay) overlay.style.display = 'none';
        }
        async function submitPasswordChange() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser) { alert('ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„.'); return; }
            const oldP = document.getElementById('cp-old').value;
            const newP = document.getElementById('cp-new').value;
            const confP = document.getElementById('cp-confirm').value;
            if (!oldP || !newP || !confP) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.'); return; }
            if (newP.length < 6) { alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù/Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.'); return; }
            if (newP !== confP) { alert('ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚.'); return; }
            const idx = users.findIndex(u => String(u.id) === String(loggedInUser.id));
            if (idx === -1) { alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.'); return; }
            if (users[idx].password !== oldP) { alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.'); return; }
            users[idx].password = newP;
            await saveUsers();
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©
            loggedInUser.password = newP;
            sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
            updateLoggedInUserDisplay(loggedInUser);
            closeChangePasswordModal();
            alert('âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.');
        }

        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¯ÙˆØ§Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ù„ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù…Ø¨ÙƒØ±Ø§Ù‹
        
        // Ø¯Ø§Ù„Ø© Ù…Ø¨Ø³Ø·Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© (Ù„Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§ÙÙ‚)
        function handleResetFlowFromURL() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('resetToken');
            if (token) {
                alert('Ù…ÙŠØ²Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ.\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù….');
            }
        }

// Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
function getStoredData(key) {
    try {
        // Ø¬Ø±Ø¨ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        const activityKey = currentActivityId ? `activity_${currentActivityId}_${key}` : key;
        
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:`, {
            key,
            currentActivityId,
            activityKey,
            keysInStorage: Object.keys(localStorage).filter(k => k.includes(key))
        });
        
        const data = localStorage.getItem(activityKey);
        if (data) {
            const parsed = JSON.parse(data);
            console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${key}:`, parsed.length, 'Ø¹Ù†ØµØ±');
            return parsed;
        }
        
        // Ø¬Ø±Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨Ø³ÙŠØ·
        const simpleData = localStorage.getItem(key);
        if (simpleData) {
            const parsed = JSON.parse(simpleData);
            console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${key} (Ù…ÙØªØ§Ø­ Ø¨Ø³ÙŠØ·):`, parsed.length, 'Ø¹Ù†ØµØ±');
            return parsed;
        }
        
        console.log(`âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${key}`);
        return null;
    } catch (error) {
        console.error(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ${key}:`, error);
        return null;
    }
}
function updateLiveStats() {
    const today = new Date().toISOString().split('T')[0];
    const currentMonth = new Date().toISOString().substring(0, 7);
    
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:');
    console.log(`ğŸ“… Ø§Ù„ÙŠÙˆÙ…: ${today}, Ø§Ù„Ø´Ù‡Ø±: ${currentMonth}`);
    console.log(`ğŸ¯ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentActivityId}`);
    console.log(`ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„:`, {
        salesType: typeof sales,
        salesLength: sales ? sales.length : 'null',
        purchasesType: typeof purchases,
        purchasesLength: purchases ? purchases.length : 'null'
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ø£Ùˆ localStorage Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ø­Ù…Ù„Ø©
    async function reloadDataIfNeeded() {
        if (USE_FIREBASE && currentActivityId) {
            if (!sales || sales.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø­Ù…Ù„Ø© - Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase');
                const firebaseSales = await firebaseGetActivityData(currentActivityId, 'sales') || [];
                window.sales = sales = firebaseSales;
                console.log(`âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ${firebaseSales.length} Ù…Ø¨ÙŠØ¹Ø© Ù…Ù† Firebase`);
            }
            
            if (!purchases || purchases.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ø­Ù…Ù„Ø© - Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase');
                const firebasePurchases = await firebaseGetActivityData(currentActivityId, 'purchases') || [];
                window.purchases = purchases = firebasePurchases;
                console.log(`âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ${firebasePurchases.length} Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ù† Firebase`);
            }
            
            if (!expenses || expenses.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø­Ù…Ù„Ø© - Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase');
                const firebaseExpenses = await firebaseGetActivityData(currentActivityId, 'expenses') || [];
                window.expenses = expenses = firebaseExpenses;
                console.log(`âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ${firebaseExpenses.length} Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù† Firebase`);
            }
            
            if (!revenues || revenues.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…Ø­Ù…Ù„Ø© - Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase');
                const firebaseRevenues = await firebaseGetActivityData(currentActivityId, 'revenues') || [];
                window.revenues = revenues = firebaseRevenues;
                console.log(`âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ${firebaseRevenues.length} Ø¥ÙŠØ±Ø§Ø¯Ø© Ù…Ù† Firebase`);
            }
        } else {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage ÙƒØ­Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            if (!sales || sales.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø­Ù…Ù„Ø© - Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage');
                const storedSales = getStoredData('sales');
                if (storedSales && storedSales.length > 0) {
                    window.sales = sales = storedSales;
                    console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${storedSales.length} Ù…Ø¨ÙŠØ¹Ø© Ù…Ù† localStorage`);
                }
            }
            
            if (!purchases || purchases.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ø­Ù…Ù„Ø© - Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage');
                const storedPurchases = getStoredData('purchases');
                if (storedPurchases && storedPurchases.length > 0) {
                    window.purchases = purchases = storedPurchases;
                    console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${storedPurchases.length} Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ù† localStorage`);
                }
            }
            
            if (!expenses || expenses.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø­Ù…Ù„Ø© - Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage');
                const storedExpenses = getStoredData('expenses');
                if (storedExpenses && storedExpenses.length > 0) {
                    window.expenses = expenses = storedExpenses;
                    console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${storedExpenses.length} Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù† localStorage`);
                }
            }
            
            if (!revenues || revenues.length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…Ø­Ù…Ù„Ø© - Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage');
                const storedRevenues = getStoredData('revenues');
                if (storedRevenues && storedRevenues.length > 0) {
                    window.revenues = revenues = storedRevenues;
                    console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${storedRevenues.length} Ø¥ÙŠØ±Ø§Ø¯Ø© Ù…Ù† localStorage`);
                }
            }
        }
    }
    
    // ØªÙ†ÙÙŠØ° Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± Ø«Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    reloadDataIfNeeded().then(() => {
        console.log(`ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„:`, { 
            sales: sales ? sales.length : 'null', 
            purchases: purchases ? purchases.length : 'null',
            expenses: expenses ? expenses.length : 'null',
            revenues: revenues ? revenues.length : 'null'
        });
        
        // ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!sales) {
            console.error('âŒ sales ØºÙŠØ± Ù…Ø¹Ø±Ù!');
            window.sales = sales = [];
        }
        if (!purchases) {
            console.error('âŒ purchases ØºÙŠØ± Ù…Ø¹Ø±Ù!');
            window.purchases = purchases = [];
        }
        if (!expenses) {
            console.error('âŒ expenses ØºÙŠØ± Ù…Ø¹Ø±Ù!');
            window.expenses = expenses = [];
        }
        if (!revenues) {
            console.error('âŒ revenues ØºÙŠØ± Ù…Ø¹Ø±Ù!');
            window.revenues = revenues = [];
        }
    
    // ğŸ’° Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…
    const todaySalesAmount = (sales && sales.length > 0) ? sales.filter(s => s.date === today)
                                  .reduce((sum, sale) => sum + (Number(sale.total) || 0), 0) : 0;
    const todaySalesEl = document.getElementById('todaySales');
    
    // ØªØ´Ø®ÙŠØµ: Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
    if (sales && sales.length > 0) {
        const salesDates = [...new Set(sales.map(s => s.date))];
        console.log(`ğŸ“… ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:`, salesDates);
        console.log(`ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø­Ø« (Ø§Ù„ÙŠÙˆÙ…):`, today);
        console.log(`âœï¸ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨ØªØ§Ø±ÙŠØ® ${today}:`, sales.filter(s => s.date === today).length);
    }
    
    console.log(`âœï¸ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…: ${todaySalesAmount}, Ø¹Ù†ØµØ± HTML: ${todaySalesEl ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}`);
    if (todaySalesEl) todaySalesEl.textContent = todaySalesAmount.toFixed(2);
    
    // ğŸ›’ Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…
    const todayPurchasesAmount = (purchases && purchases.length > 0) ? purchases.filter(p => p.date === today)
                                         .reduce((sum, purchase) => sum + (Number(purchase.total) || 0), 0) : 0;
    const todayPurchasesEl = document.getElementById('todayPurchases');
    console.log(`âœï¸ Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…: ${todayPurchasesAmount}, Ø¹Ù†ØµØ± HTML: ${todayPurchasesEl ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}`);
    if (todayPurchasesEl) todayPurchasesEl.textContent = todayPurchasesAmount.toFixed(2);
    
    // ï¿½ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…
    const todayExpensesAmount = expenses.filter(e => e.date === today)
                                       .reduce((sum, expense) => sum + (Number(expense.amount) || 0), 0);
    const todayExpensesEl = document.getElementById('todayExpenses');
    if (todayExpensesEl) todayExpensesEl.textContent = todayExpensesAmount.toFixed(2);
    
    // ğŸ’µ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ… (Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰)
    const todayRevenuesAmount = revenues.filter(r => r.date === today)
                                       .reduce((sum, revenue) => sum + (Number(revenue.amount) || 0), 0);
    const todayRevenuesEl = document.getElementById('todayRevenues');
    if (todayRevenuesEl) todayRevenuesEl.textContent = todayRevenuesAmount.toFixed(2);
    
    const monthlySalesAmount = (sales && sales.length > 0) ? sales.filter(s => s.date && s.date.substring(0, 7) === currentMonth)
                                   .reduce((sum, sale) => sum + (Number(sale.total) || 0), 0) : 0;
    const monthlySalesEl = document.getElementById('monthlySales');
    if (monthlySalesEl) monthlySalesEl.textContent = monthlySalesAmount.toFixed(2);
    
    const monthlyPurchasesAmount = (purchases && purchases.length > 0) ? purchases.filter(p => p.date && p.date.substring(0, 7) === currentMonth)
                                           .reduce((sum, purchase) => sum + (Number(purchase.total) || 0), 0) : 0;
    const monthlyPurchasesEl = document.getElementById('monthlyPurchases');
    if (monthlyPurchasesEl) monthlyPurchasesEl.textContent = monthlyPurchasesAmount.toFixed(2);
    
    // ğŸ’¸ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±
    const monthlyExpensesAmount = expenses.filter(e => e.date.substring(0, 7) === currentMonth)
                                         .reduce((sum, expense) => sum + (Number(expense.amount) || 0), 0);
    const monthlyExpensesCardEl = document.getElementById('monthlyExpensesCard');
    if (monthlyExpensesCardEl) monthlyExpensesCardEl.textContent = monthlyExpensesAmount.toFixed(2);
    
    // ğŸ’µ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø± (Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰)
    const monthlyRevenuesAmount = revenues.filter(r => r.date.substring(0, 7) === currentMonth)
                                         .reduce((sum, revenue) => sum + (Number(revenue.amount) || 0), 0);
    const monthlyRevenuesEl = document.getElementById('monthlyRevenues');
    if (monthlyRevenuesEl) monthlyRevenuesEl.textContent = monthlyRevenuesAmount.toFixed(2);

    // ğŸ”¥ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø© (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙÙ‚Ø·)
    const activity = activities.find(a => a.id == currentActivityId);
    
    const yearStart = new Date().getFullYear() + '-01-01';
    const cumulativeSales = sales.filter(s => s.date >= yearStart);
    const cumulativeSalesRevenue = cumulativeSales.reduce((sum, sale) => sum + sale.total, 0);
    const cumulativeRevenuesExtra = revenues.filter(r => r.date >= yearStart).reduce((sum, revenue) => sum + revenue.amount, 0);
    const cumulativeExpenses = expenses.filter(e => e.date >= yearStart).reduce((sum, expense) => sum + expense.amount, 0);
    const cumulativeCOGS = calculateCOGS(cumulativeSales);
    
    // ØµØ§ÙÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø© Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙÙ‚Ø·)
    const cumulativeGrossProfit = cumulativeSalesRevenue - cumulativeCOGS;
    const cumulativeNetProfitFromOperations = cumulativeGrossProfit + cumulativeRevenuesExtra - cumulativeExpenses;
    
    }).catch(error => {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
    });
}
// ğŸ“Š Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© - Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹

function renderSalesChart() {
    const ctx = document.getElementById('salesChart');
    if (!ctx) return;
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
    const last7Days = getLast7Days();
    const salesData = last7Days.map(day => 
        sales.filter(s => s.date === day)
             .reduce((sum, sale) => sum + sale.total, 0)
    );

    // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    if (window.salesChartInstance) {
        window.salesChartInstance.destroy();
    }

    window.salesChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: last7Days.map(day => formatDate(day)),
            datasets: [{
                label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                data: salesData,
                borderColor: '#2c5aa0',
                backgroundColor: 'rgba(44, 90, 160, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    rtl: true,
                    labels: {
                        font: {
                            family: 'Tajawal',
                            size: 14
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…',
                    font: {
                        family: 'Tajawal',
                        size: 16
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        }
                    }
                },
                y: {
                    ticks: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        },
                        callback: function(value) {
                            return value + ' Ø±.Ø³';
                        }
                    }
                }
            }
        }
    });
}

function renderRevenueChart() {
    const ctx = document.getElementById('revenueChart');
    if (!ctx) return;
    
    const revenueBySource = {
        'Ù…Ø¨ÙŠØ¹Ø§Øª': revenues.filter(r => r.source === 'sales').reduce((sum, r) => sum + r.amount, 0),
        'Ø®Ø¯Ù…Ø§Øª': revenues.filter(r => r.source === 'services').reduce((sum, r) => sum + r.amount, 0),
        'Ø§Ø³ØªØ«Ù…Ø§Ø±': revenues.filter(r => r.source === 'investment').reduce((sum, r) => sum + r.amount, 0),
        'Ø£Ø®Ø±Ù‰': revenues.filter(r => r.source === 'other').reduce((sum, r) => sum + r.amount, 0)
    };

    // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    if (window.revenueChartInstance) {
        window.revenueChartInstance.destroy();
    }

    window.revenueChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(revenueBySource),
            datasets: [{
                data: Object.values(revenueBySource),
                backgroundColor: [
                    '#2c5aa0',
                    '#27ae60',
                    '#e74c3c',
                    '#f39c12'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    rtl: true,
                    labels: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        },
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value.toFixed(2)} Ø±.Ø³ (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderExpensesChart() {
    const ctx = document.getElementById('expensesChart');
    if (!ctx) return;
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±
    const months = [];
    const expensesData = [];
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const monthStr = date.toISOString().substring(0, 7);
        months.push(monthStr);
        const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === monthStr)
                                     .reduce((sum, expense) => sum + expense.amount, 0);
        expensesData.push(monthExpenses);
    }
    
    if (window.expensesChartInstance) {
        window.expensesChartInstance.destroy();
    }
    
    window.expensesChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                data: expensesData,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function renderPurchasesSalesChart() {
    const ctx = document.getElementById('purchasesSalesChart');
    if (!ctx) return;
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±
    const months = [];
    const purchasesData = [];
    const salesData = [];
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const monthStr = date.toISOString().substring(0, 7);
        months.push(monthStr);
        const monthPurchases = purchases.filter(p => p.date.substring(0, 7) === monthStr)
                                       .reduce((sum, purchase) => sum + purchase.total, 0);
        const monthSales = sales.filter(s => s.date.substring(0, 7) === monthStr)
                               .reduce((sum, sale) => sum + sale.total, 0);
        purchasesData.push(monthPurchases);
        salesData.push(monthSales);
    }
    
    if (window.purchasesSalesChartInstance) {
        window.purchasesSalesChartInstance.destroy();
    }
    
    window.purchasesSalesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{
                label: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
                data: purchasesData,
                backgroundColor: '#e74c3c',
                borderColor: '#c0392b',
                borderWidth: 1
            }, {
                label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                data: salesData,
                backgroundColor: '#27ae60',
                borderColor: '#219a52',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯Ù‡Ù…
function toggleAllCustomerCheckboxes(mainCheckbox) {
    const checkboxes = document.querySelectorAll('.customer-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = mainCheckbox.checked;
    });
}

// === Ø¯ÙˆØ§Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª ===

// --- Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ---
async function deleteSaleReturn(returnId) {
    const returnIndex = salesReturns.findIndex(sr => sr.id === returnId);
    if (returnIndex === -1) return;

    const returnToDelete = salesReturns[returnIndex];
    const returnNumber = `SR${returnToDelete.number.toString().padStart(3, '0')}`;
    const customer = customers.find(c => c.id === returnToDelete.customerId);
    const customerName = customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

    createCustomConfirmDialog({
        title: 'ğŸ—‘ï¸ Ù†Ù‚Ù„ Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
        icon: 'âš ï¸',
        content: `
            <div style="text-align: right; line-height: 1.8;">
                <p style="font-size: 16px; margin-bottom: 15px;">Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ</p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-right: 4px solid #dc3545;">
                    <p style="margin: 8px 0;"><strong>ğŸ“‹ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</strong> ${returnNumber}</p>
                    <p style="margin: 8px 0;"><strong>ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${customerName}</p>
                    <p style="margin: 8px 0;"><strong>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${returnToDelete.total.toFixed(2)} Ø±ÙŠØ§Ù„</p>
                    <p style="margin: 8px 0;"><strong>ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù:</strong> ${returnToDelete.items.length}</p>
                </div>
                <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-right: 3px solid #ffc107; margin-top: 15px;">
                    <p style="margin: 0; color: #856404;"><strong>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø³ÙŠØªÙ… Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                </div>
            </div>
        `,
        confirmText: 'Ù†Ø¹Ù…ØŒ Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©',
        cancelText: 'Ø¥Ù„ØºØ§Ø¡',
        onConfirm: async () => {
            // Ø£Ù‡Ù… Ø®Ø·ÙˆØ©: Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            // Ø¹Ù†Ø¯ Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§ØªØŒ ÙŠØ¬Ø¨ Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
            returnToDelete.items.forEach(returnedItem => {
                const itemInStock = items.find(i => i.id === returnedItem.id);
                if (itemInStock) {
                    itemInStock.stock -= returnedItem.quantity;
                }
            });

            moveToTrash('salesReturns', returnToDelete);
            salesReturns.splice(returnIndex, 1);

            saveToLocalStorage('salesReturns', salesReturns);
            saveToLocalStorage('items', items);

            renderSalesReturnsNew();
            renderItems();
            updateDashboard();
            showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­', `ØªÙ… Ù†Ù‚Ù„ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ${returnNumber} Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª`, 'success');
        }
    });
}

// --- Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ---
async function deletePurchaseReturn(returnId) {
    const returnIndex = purchaseReturns.findIndex(pr => pr.id === returnId);
    if (returnIndex === -1) return;

    const returnToDelete = purchaseReturns[returnIndex];
    const returnNumber = `PR${returnToDelete.number.toString().padStart(3, '0')}`;
    const supplier = suppliers.find(s => s.id === returnToDelete.supplierId);
    const supplierName = supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

    createCustomConfirmDialog({
        title: 'ğŸ—‘ï¸ Ù†Ù‚Ù„ Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
        icon: 'âš ï¸',
        content: `
            <div style="text-align: right; line-height: 1.8;">
                <p style="font-size: 16px; margin-bottom: 15px;">Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ØªØ§Ù„ÙŠ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ</p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-right: 4px solid #fd7e14;">
                    <p style="margin: 8px 0;"><strong>ğŸ“‹ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</strong> ${returnNumber}</p>
                    <p style="margin: 8px 0;"><strong>ğŸ¢ Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${supplierName}</p>
                    <p style="margin: 8px 0;"><strong>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${returnToDelete.total.toFixed(2)} Ø±ÙŠØ§Ù„</p>
                    <p style="margin: 8px 0;"><strong>ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù:</strong> ${returnToDelete.items.length}</p>
                </div>
                <div style="background: #d1ecf1; padding: 12px; border-radius: 6px; border-right: 3px solid #17a2b8; margin-top: 15px;">
                    <p style="margin: 0; color: #0c5460;"><strong>â„¹ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø²ÙŠØ§Ø¯ØªÙ‡Ø§)</p>
                </div>
            </div>
        `,
        confirmText: 'Ù†Ø¹Ù…ØŒ Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©',
        cancelText: 'Ø¥Ù„ØºØ§Ø¡',
        onConfirm: async () => {
            // Ø£Ù‡Ù… Ø®Ø·ÙˆØ©: Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            // Ø¹Ù†Ø¯ Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§ØªØŒ ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.
            returnToDelete.items.forEach(returnedItem => {
                const itemInStock = items.find(i => i.id === returnedItem.id);
                if (itemInStock) {
                    itemInStock.stock += returnedItem.quantity;
                }
            });

            moveToTrash('purchaseReturns', returnToDelete);
            purchaseReturns.splice(returnIndex, 1);

            saveToLocalStorage('purchaseReturns', purchaseReturns);
            saveToLocalStorage('items', items);

            renderPurchaseReturnsNew();
            renderItems();
            updateDashboard();
            showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­', `ØªÙ… Ù†Ù‚Ù„ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ${returnNumber} Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª`, 'success');
        }
    });
}

// ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª =====
function findSaleForReturnNew() {
    const invoiceNumber = parseInt(document.getElementById('salesReturnInvoiceSearchNew').value);
    if (isNaN(invoiceNumber)) {
        showNotification('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ØµØ­ÙŠØ­', 'warning');
        return;
    }
    
    const sale = sales.find(s => s.number === invoiceNumber);
    if (!sale) {
        showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…', 'error');
        newSaleReturnNew();
        return;
    }

    activeSaleReturn = sale;
    const customer = customers.find(c => c.id === sale.customerId);
    
    const detailsDiv = document.getElementById('salesReturnInvoiceDetailsNew');
    detailsDiv.innerHTML = `
        <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> SAL${sale.number.toString().padStart(3, '0')}</p>
        <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${sale.date}</p>
    `;
    detailsDiv.style.display = 'block';

    const itemsTbody = document.getElementById('salesReturnItemsListNew');
    itemsTbody.innerHTML = '';
    sale.items.forEach(item => {
        const tr = document.createElement('tr');
        tr.dataset.itemId = item.id;
        tr.dataset.price = item.price;
        tr.innerHTML = `
            <td>${item.name}</td>
            <td>${item.price.toFixed(2)}</td>
            <td>${item.quantity}</td>
            <td><input type="number" class="return-item-qty-input" min="0" max="${item.quantity}" value="0" oninput="updateSaleReturnTotalNew()"></td>
        `;
        itemsTbody.appendChild(tr);
    });
    
    document.getElementById('salesReturnItemsContainerNew').style.display = 'block';
    updateSaleReturnTotalNew();
}

function updateSaleReturnTotalNew() {
    let total = 0;
    document.querySelectorAll('#salesReturnItemsListNew tr').forEach(tr => {
        const price = parseFloat(tr.dataset.price);
        const qty = parseInt(tr.querySelector('input').value) || 0;
        total += price * qty;
    });
    document.getElementById('salesReturnTotalNew').textContent = total.toFixed(2);
}

async function saveSaleReturnNew() {
    if (!activeSaleReturn) {
        showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø«', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        return;
    }
    
    const returnedItems = [];
    let totalReturnValue = 0;
    document.querySelectorAll('#salesReturnItemsListNew tr').forEach(tr => {
        const qty = parseInt(tr.querySelector('input').value) || 0;
        if (qty > 0) {
            const originalItem = activeSaleReturn.items.find(i => i.id == tr.dataset.itemId);
            returnedItems.push({
                id: originalItem.id,
                name: originalItem.name,
                price: originalItem.price,
                quantity: qty
            });
            totalReturnValue += originalItem.price * qty;
        }
    });

    if (returnedItems.length === 0) {
        showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ ÙƒÙ…ÙŠØ§Øª Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹', 'warning');
        return;
    }

    returnedItems.forEach(returnedItem => {
        const itemInStock = items.find(i => i.id === returnedItem.id);
        if (itemInStock) {
            itemInStock.stock += returnedItem.quantity;
        }
    });

    const newReturn = {
        id: Date.now(),
        number: currentSaleReturnNumber,
        date: new Date().toISOString().split('T')[0],
        originalInvoiceId: activeSaleReturn.id,
        originalInvoiceNumber: activeSaleReturn.number,
        customerId: activeSaleReturn.customerId,
        branchId: activeSaleReturn.branchId || null,
        items: returnedItems,
        total: totalReturnValue
    };

    const originalSaleIndex = sales.findIndex(s => s.id === activeSaleReturn.id);
    if (originalSaleIndex > -1) {
        const originalSale = sales[originalSaleIndex];
        originalSale.total = roundCurrency((originalSale.total || 0) - totalReturnValue);
        originalSale.remainingAmount = roundCurrency((originalSale.remainingAmount || 0) - totalReturnValue);
        originalSale.notes = (originalSale.notes || '') + ` [Ù…Ø±ØªØ¬Ø¹ Ø¨Ù‚ÙŠÙ…Ø©: ${totalReturnValue.toFixed(2)}]`;
    }

    salesReturns.push(newReturn);
    currentSaleReturnNumber++;
    
    const success1 = saveToLocalStorage('salesReturns', salesReturns);
    const success2 = saveToLocalStorage('items', items);
    const success3 = saveToLocalStorage('sales', sales);
    
    if (success1 && success2 && success3) {
        // ğŸ“‹ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø°Ù† Ù…Ø®Ø²Ù†ÙŠ Ù„Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¥Ø¯Ø®Ø§Ù„)
        await createStockPermission('in', newReturn, 'sales_return');
        
        showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø±Ù‚Ù… SR${newReturn.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        newSaleReturnNew();
        renderSalesReturnsNew();
        updateDashboard();
        renderItems();
        renderSalesList();
    } else {
        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}

function renderSalesReturnsNew() {
    const tbody = document.getElementById('salesReturnHistoryNew');
    tbody.innerHTML = '';
    if (salesReturns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Øª</td></tr>';
        return;
    }
    salesReturns.forEach(sr => {
        const customer = customers.find(c => c.id === sr.customerId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>SR${sr.number.toString().padStart(3, '0')}</td>
            <td>${sr.date}</td>
            <td>${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>SAL${sr.originalInvoiceNumber.toString().padStart(3, '0')}</td>
            <td>${sr.total.toFixed(2)}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-danger" onclick="deleteSaleReturn(${sr.id})">Ø­Ø°Ù</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function newSaleReturnNew() {
    activeSaleReturn = null;
    document.getElementById('salesReturnInvoiceSearchNew').value = '';
    document.getElementById('salesReturnInvoiceDetailsNew').style.display = 'none';
    document.getElementById('salesReturnItemsContainerNew').style.display = 'none';
    document.getElementById('salesReturnItemsListNew').innerHTML = '';
    document.getElementById('salesReturnTotalNew').textContent = '0.00';
}

// ===== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ© =====

/**
 * ğŸ“‹ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø°Ù† Ù…Ø®Ø²Ù†ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ
 * @param {string} type - Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø°Ù†: 'in' (Ø¥Ø¯Ø®Ø§Ù„) Ø£Ùˆ 'out' (ØµØ±Ù)
 * @param {object} invoice - Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù…Ø¨ÙŠØ¹Ø§Øª Ø£Ùˆ Ù…Ø´ØªØ±ÙŠØ§Øª)
 * @param {string} customSource - Ù…ØµØ¯Ø± Ù…Ø®ØµØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù…Ø«Ù„ 'sales_return' Ø£Ùˆ 'purchase_return'
 */
async function createStockPermission(type, invoice, customSource = null) {
    try {
        const permissionNumber = permissions.length + 1;
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØµØ¯Ø±
        let source;
        let sourceRef;
        
        if (customSource) {
            source = customSource;
            if (customSource === 'sales_return') {
                sourceRef = `SR-${invoice.number.toString().padStart(3, '0')}`;
            } else if (customSource === 'purchase_return') {
                sourceRef = `PR-${invoice.number.toString().padStart(3, '0')}`;
            } else {
                sourceRef = `${customSource.toUpperCase()}-${invoice.number.toString().padStart(3, '0')}`;
            }
        } else {
            source = type === 'out' ? 'sales' : 'purchases';
            sourceRef = type === 'out' 
                ? `SAL-${invoice.number.toString().padStart(3, '0')}` 
                : `PUR-${invoice.number.toString().padStart(3, '0')}`;
        }
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ø±Ù (Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ù…ÙˆØ±Ø¯)
        let partyId = null;
        let partyName = '';
        
        if (customSource === 'sales_return' || (type === 'in' && !customSource)) {
            // Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Øª Ø£Ùˆ Ù…Ø´ØªØ±ÙŠØ§Øª
            partyId = invoice.customerId || invoice.supplierId;
            if (invoice.customerId) {
                const customer = customers.find(c => c.id === partyId);
                partyName = customer ? customer.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            } else if (invoice.supplierId) {
                const supplier = suppliers.find(s => s.id === partyId);
                partyName = supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            }
        } else if (type === 'out' || customSource === 'purchase_return') {
            partyId = invoice.customerId || invoice.supplierId;
            if (invoice.customerId) {
                const customer = customers.find(c => c.id === partyId);
                partyName = customer ? customer.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            } else if (invoice.supplierId) {
                const supplier = suppliers.find(s => s.id === partyId);
                partyName = supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            }
        } else {
            partyId = invoice.supplierId;
            const supplier = suppliers.find(s => s.id === partyId);
            partyName = supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¥Ø°Ù†
        const permission = {
            id: Date.now(),
            number: permissionNumber,
            date: invoice.date,
            type: type, // 'in' or 'out'
            source: source, // 'sales' or 'purchases'
            sourceRef: sourceRef,
            warehouseId: invoice.branchId || 0,
            partyId: partyId,
            partyName: partyName,
            items: invoice.items.map(item => {
                const itemData = items.find(i => i.id === item.id);
                return {
                    id: item.id,
                    code: itemData ? itemData.code : (item.code || 'N/A'),
                    name: item.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                    quantity: item.quantity || 0,
                    unitPrice: item.price || 0,
                    total: item.total || 0
                };
            }),
            notes: invoice.notes || '',
            createdAt: new Date().toISOString()
        };
        
        permissions.push(permission);
        await saveToLocalStorage('permissions', permissions);
        
        console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø°Ù† Ù…Ø®Ø²Ù†ÙŠ Ø±Ù‚Ù… ${permissionNumber} Ù…Ù† Ù†ÙˆØ¹ ${type === 'out' ? 'ØµØ±Ù' : 'Ø¥Ø¯Ø®Ø§Ù„'}`);
        
        return permission;
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø°Ù† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ:', error);
        return null;
    }
}

/**
 * ğŸ“Š Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©
 */
function renderPermissionsList() {
    const tbody = document.getElementById('permissionsList');
    if (!tbody) {
        console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (permissions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">ğŸ“‹ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø°ÙˆÙ† Ù…Ø®Ø²Ù†ÙŠØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>';
        return;
    }
    
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø°ÙˆÙ† Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ù…
    const sortedPermissions = [...permissions].sort((a, b) => b.number - a.number);
    
    sortedPermissions.forEach(perm => {
        const row = document.createElement('tr');
        
        // Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø°Ù† Ù…Ø¹ Badge Ù…Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø±
        let typeBadge;
        if (perm.source === 'sales_return') {
            typeBadge = '<span style="background: #17a2b8; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">â†©ï¸ Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¥Ø¯Ø®Ø§Ù„)</span>';
        } else if (perm.source === 'purchase_return') {
            typeBadge = '<span style="background: #fd7e14; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">â†ªï¸ Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª (ØµØ±Ù)</span>';
        } else if (perm.type === 'in') {
            typeBadge = '<span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">ğŸ“¥ Ø¥Ø¯Ø®Ø§Ù„</span>';
        } else {
            typeBadge = '<span style="background: #dc3545; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">ğŸ“¤ ØµØ±Ù</span>';
        }
        
        // Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        const warehouseName = perm.warehouseId 
            ? (branches.find(b => b.id === perm.warehouseId)?.name || 'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ')
            : 'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ';
        
        // Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù
        const itemsCount = perm.items.length;
        
        row.innerHTML = `
            <td>${perm.number}</td>
            <td>${perm.date}</td>
            <td>${typeBadge}</td>
            <td>${warehouseName}</td>
            <td>${perm.partyName}</td>
            <td><span style="color: #007bff; font-weight: 600;">${perm.sourceRef}</span></td>
            <td>${itemsCount} ØµÙ†Ù</td>
            <td>
                <div class="action-menu-container" style="position: relative; display: inline-block;">
                    <button onclick="toggleActionMenu(event, 'perm-action-${perm.id}')" class="btn-icon" style="background: none; border: none; cursor: pointer; font-size: 1.2em;">
                        â‹®
                    </button>
                    <div id="perm-action-${perm.id}" class="action-menu" style="display: none; position: absolute; left: 0; top: 100%; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; min-width: 150px; overflow: hidden;">
                        <button onclick="printPermission(${perm.id})" style="display: block; width: 100%; text-align: right; padding: 8px 12px; background: none; border: none; cursor: pointer; transition: background 0.2s;">
                            ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                        <button onclick="editPermission(${perm.id})" style="display: block; width: 100%; text-align: right; padding: 8px 12px; background: none; border: none; cursor: pointer; transition: background 0.2s; border-top: 1px solid #eee;">
                            âœï¸ ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button onclick="deletePermission(${perm.id})" style="display: block; width: 100%; text-align: right; padding: 8px 12px; background: none; border: none; cursor: pointer; transition: background 0.2s; color: #dc3545; border-top: 1px solid #eee;">
                            ğŸ—‘ï¸ Ø­Ø°Ù
                        </button>
                    </div>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    console.log(`âœ… ØªÙ… Ø¹Ø±Ø¶ ${permissions.length} Ø¥Ø°Ù† Ù…Ø®Ø²Ù†ÙŠ`);
}

/**
 * ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø¥Ø°Ù† Ù…Ø®Ø²Ù†ÙŠ
 */
function printPermission(permissionId) {
    const permission = permissions.find(p => p.id === permissionId);
    if (!permission) {
        showNotification('âŒ Ø®Ø·Ø£', 'Ø§Ù„Ø¥Ø°Ù† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
        return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    const printWindow = window.open('', '', 'width=800,height=600');
    
    const typeName = permission.type === 'in' ? 'Ø¥Ø°Ù† Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø®Ø²Ù†ÙŠ' : 'Ø¥Ø°Ù† ØµØ±Ù Ù…Ø®Ø²Ù†ÙŠ';
    const typeColor = permission.type === 'in' ? '#28a745' : '#dc3545';
    
    // Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù
    let itemsTable = '';
    permission.items.forEach((item, index) => {
        itemsTable += `
            <tr>
                <td>${index + 1}</td>
                <td>${item.code}</td>
                <td>${item.name}</td>
                <td>${item.quantity}</td>
                <td>${item.unitPrice.toFixed(2)}</td>
                <td>${item.total.toFixed(2)}</td>
            </tr>
        `;
    });
    
    const totalQty = permission.items.reduce((sum, item) => sum + item.quantity, 0);
    const totalAmount = permission.items.reduce((sum, item) => sum + item.total, 0);
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <title>${typeName} - Ø±Ù‚Ù… ${permission.number}</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { font-family: 'Arial', 'Tahoma', sans-serif; padding: 30px; }
                .header { text-align: center; border-bottom: 3px solid ${typeColor}; padding-bottom: 20px; margin-bottom: 30px; }
                .header h1 { color: ${typeColor}; font-size: 28px; margin-bottom: 10px; }
                .info-section { display: flex; justify-content: space-between; margin-bottom: 30px; }
                .info-box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; width: 48%; }
                .info-box h3 { color: #333; margin-bottom: 10px; font-size: 16px; }
                .info-row { margin: 8px 0; }
                .info-label { font-weight: bold; color: #555; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th { background: ${typeColor}; color: white; padding: 12px; text-align: center; }
                td { border: 1px solid #ddd; padding: 10px; text-align: center; }
                tr:nth-child(even) { background: #f9f9f9; }
                .footer { margin-top: 40px; text-align: center; color: #666; font-size: 14px; }
                .total-row { background: #f0f0f0; font-weight: bold; }
                @media print { body { padding: 10px; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${typeName}</h1>
                <p>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù†: ${permission.number}</p>
            </div>
            
            <div class="info-section">
                <div class="info-box">
                    <h3>ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ø°Ù†</h3>
                    <div class="info-row"><span class="info-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> ${permission.date}</div>
                    <div class="info-row"><span class="info-label">Ø§Ù„Ù…ØµØ¯Ø±:</span> ${permission.sourceRef}</div>
                    <div class="info-row"><span class="info-label">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</span> ${branches.find(b => b.id === permission.warehouseId)?.name || 'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ'}</div>
                </div>
                
                <div class="info-box">
                    <h3>ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ${permission.type === 'out' ? 'Ø§Ù„Ø¹Ù…ÙŠÙ„' : 'Ø§Ù„Ù…ÙˆØ±Ø¯'}</h3>
                    <div class="info-row"><span class="info-label">Ø§Ù„Ø§Ø³Ù…:</span> ${permission.partyName}</div>
                    ${permission.notes ? `<div class="info-row"><span class="info-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span> ${permission.notes}</div>` : ''}
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù</th>
                        <th>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsTable}
                    <tr class="total-row">
                        <td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                        <td>${totalQty}</td>
                        <td>-</td>
                        <td>${totalAmount.toFixed(2)} Ø±.Ø³</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="footer">
                <p>ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¯ÙŠÙˆØ§Ù†ÙŠ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</p>
                <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleDateString('ar-SA')}</p>
            </div>
            
            <script` + `>
                window.onload = function() {
                    window.print();
                    window.onafterprint = function() {
                        window.close();
                    };
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ¯Ø¹Ù… onafterprint Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯
                    setTimeout(function() {
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ø§ ØªØ²Ø§Ù„ Ù…ÙØªÙˆØ­Ø© ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø¯ Ø§Ù†ØªÙ‡Øª (ØªÙ‚Ø±ÙŠØ¨ÙŠØ§Ù‹)
                        // Ù…Ù„Ø§Ø­Ø¸Ø©: window.print() ØªØ­Ø¬Ø¨ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙŠ Ù…Ø¹Ø¸Ù… Ø§Ù„Ù…ØªØµÙØ­Ø§ØªØŒ Ù„Ø°Ø§ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ¹Ù…Ù„ Ø¨Ø¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø­ÙˆØ§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                        window.close();
                    }, 500);
                };
            </script` + `>
        </body>
        </html>
    `);
    
    printWindow.document.close();
}

/**
 * ğŸ—‘ï¸ Ø­Ø°Ù Ø¥Ø°Ù† Ù…Ø®Ø²Ù†ÙŠ
 */
async function deletePermission(id) {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­ÙˆØ§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
    if (typeof showConfirmDialog === 'function') {
        const confirmed = await showConfirmDialog({
            title: 'Ø­Ø°Ù Ø¥Ø°Ù† Ù…Ø®Ø²Ù†ÙŠ',
            message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø°Ù†ØŸ<br>Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø°Ù† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.',
            type: 'danger',
            confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
            cancelText: 'Ø¥Ù„ØºØ§Ø¡',
            icon: 'ğŸ—‘ï¸'
        });
        
        if (!confirmed) return;
    } else {
        // Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… ØªÙˆÙØ± Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø°Ù†ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø°Ù† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.')) {
            return;
        }
    }
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¥Ø°Ù†
    const index = permissions.findIndex(p => p.id === id);
    if (index === -1) {
        showNotification('âŒ Ø®Ø·Ø£', 'Ø§Ù„Ø¥Ø°Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
        return;
    }
    
    // Ø­Ø°Ù Ø§Ù„Ø¥Ø°Ù†
    permissions.splice(index, 1);
    
    // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
    if (typeof saveToLocalStorage === 'function') {
        saveToLocalStorage('permissions', permissions);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    renderPermissionsList();
    
    showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø°Ù† Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

/**
 * âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø°Ù† Ù…Ø®Ø²Ù†ÙŠ
 */
function editPermission(id) {
    showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ø§', 'warning');
}

function searchPermissions() {
    console.log('ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©...');
    console.log(`ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${permissions.length}`);
    applyPermissionsFilters();
}

function resetPermissionFilters() {
    const permNumber = document.getElementById('permNumber');
    const permSource = document.getElementById('permSource');
    const permRef = document.getElementById('permRef');
    const permWarehouse = document.getElementById('permWarehouse');
    const permCustomer = document.getElementById('permCustomer');
    const permSupplier = document.getElementById('permSupplier');
    
    if (permNumber) permNumber.value = '';
    if (permSource) permSource.value = '';
    if (permRef) permRef.value = '';
    if (permWarehouse) permWarehouse.value = '';
    if (permCustomer) permCustomer.value = '';
    if (permSupplier) permSupplier.value = '';
    
    console.log('Resetting permission filters...');
    renderPermissionsList();
}

/**
 * ğŸ” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©
 */
function applyPermissionsFilters() {
    const permNumber = document.getElementById('permNumber')?.value.trim();
    const permSource = document.getElementById('permSource')?.value;
    const permRef = document.getElementById('permRef')?.value.trim().toLowerCase();
    const permWarehouse = document.getElementById('permWarehouse')?.value;
    const permCustomer = document.getElementById('permCustomer')?.value;
    const permSupplier = document.getElementById('permSupplier')?.value;
    
    console.log('ğŸ” Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«:', {
        permNumber,
        permSource,
        permRef,
        permWarehouse,
        permCustomer,
        permSupplier,
        totalPermissions: permissions.length
    });
    
    let filtered = [...permissions];
    
    // ÙÙ„ØªØ±Ø© Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù†
    if (permNumber) {
        filtered = filtered.filter(p => p.number.toString().includes(permNumber));
        console.log(`âœ… Ø¨Ø¹Ø¯ ÙÙ„ØªØ±Ø© Ø§Ù„Ø±Ù‚Ù…: ${filtered.length} Ù†ØªÙŠØ¬Ø©`);
    }
    
    // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ù…ØµØ¯Ø±
    if (permSource) {
        filtered = filtered.filter(p => p.source === permSource);
        console.log(`âœ… Ø¨Ø¹Ø¯ ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØµØ¯Ø±: ${filtered.length} Ù†ØªÙŠØ¬Ø©`);
    }
    
    // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø±Ù
    if (permRef) {
        filtered = filtered.filter(p => p.sourceRef.toLowerCase().includes(permRef));
        console.log(`âœ… Ø¨Ø¹Ø¯ ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹: ${filtered.length} Ù†ØªÙŠØ¬Ø©`);
    }
    
    // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
    if (permWarehouse) {
        filtered = filtered.filter(p => p.warehouseId === parseInt(permWarehouse));
        console.log(`âœ… Ø¨Ø¹Ø¯ ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: ${filtered.length} Ù†ØªÙŠØ¬Ø©`);
    }
    
    // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ±Ø¯
    if (permCustomer) {
        filtered = filtered.filter(p => p.partyId === parseInt(permCustomer) && p.type === 'out');
        console.log(`âœ… Ø¨Ø¹Ø¯ ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„: ${filtered.length} Ù†ØªÙŠØ¬Ø©`);
    }
    
    if (permSupplier) {
        filtered = filtered.filter(p => p.partyId === parseInt(permSupplier) && p.type === 'in');
        console.log(`âœ… Ø¨Ø¹Ø¯ ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯: ${filtered.length} Ù†ØªÙŠØ¬Ø©`);
    }
    
    console.log(`ğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${filtered.length} Ø¥Ø°Ù† Ù…Ù† Ø£ØµÙ„ ${permissions.length}`);
    
    renderFilteredPermissions(filtered);
}

/**
 * ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
 */
function renderFilteredPermissions(filteredPermissions) {
    const tbody = document.getElementById('permissionsList');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (filteredPermissions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">ğŸ“‹ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«</td></tr>';
        return;
    }
    
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø°ÙˆÙ† Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ù…
    const sortedPermissions = [...filteredPermissions].sort((a, b) => b.number - a.number);
    
    sortedPermissions.forEach(perm => {
        const row = document.createElement('tr');
        
        // Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø°Ù† Ù…Ø¹ Badge Ù…Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø±
        let typeBadge;
        if (perm.source === 'sales_return') {
            typeBadge = '<span style="background: #17a2b8; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">â†©ï¸ Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¥Ø¯Ø®Ø§Ù„)</span>';
        } else if (perm.source === 'purchase_return') {
            typeBadge = '<span style="background: #fd7e14; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">â†ªï¸ Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª (ØµØ±Ù)</span>';
        } else if (perm.type === 'in') {
            typeBadge = '<span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">ğŸ“¥ Ø¥Ø¯Ø®Ø§Ù„</span>';
        } else {
            typeBadge = '<span style="background: #dc3545; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">ğŸ“¤ ØµØ±Ù</span>';
        }
        
        // Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        const warehouseName = perm.warehouseId 
            ? (branches.find(b => b.id === perm.warehouseId)?.name || 'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ')
            : 'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ';
        
        // Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù
        const itemsCount = perm.items.length;
        
        row.innerHTML = `
            <td>${perm.number}</td>
            <td>${perm.date}</td>
            <td>${typeBadge}</td>
            <td>${warehouseName}</td>
            <td>${perm.partyName}</td>
            <td><span style="color: #007bff; font-weight: 600;">${perm.sourceRef}</span></td>
            <td>${itemsCount} ØµÙ†Ù</td>
            <td>
                <div class="action-menu-container" style="position: relative; display: inline-block;">
                    <button onclick="toggleActionMenu(event, 'perm-action-${perm.id}')" class="btn-icon" style="background: none; border: none; cursor: pointer; font-size: 1.2em;">
                        â‹®
                    </button>
                    <div id="perm-action-${perm.id}" class="action-menu" style="display: none; position: absolute; left: 0; top: 100%; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; min-width: 150px; overflow: hidden;">
                        <button onclick="printPermission(${perm.id})" style="display: block; width: 100%; text-align: right; padding: 8px 12px; background: none; border: none; cursor: pointer; transition: background 0.2s;">
                            ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                        <button onclick="editPermission(${perm.id})" style="display: block; width: 100%; text-align: right; padding: 8px 12px; background: none; border: none; cursor: pointer; transition: background 0.2s; border-top: 1px solid #eee;">
                            âœï¸ ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button onclick="deletePermission(${perm.id})" style="display: block; width: 100%; text-align: right; padding: 8px 12px; background: none; border: none; cursor: pointer; transition: background 0.2s; color: #dc3545; border-top: 1px solid #eee;">
                            ğŸ—‘ï¸ Ø­Ø°Ù
                        </button>
                    </div>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    console.log(`âœ… ØªÙ… Ø¹Ø±Ø¶ ${filteredPermissions.length} Ø¥Ø°Ù† Ù…Ø®Ø²Ù†ÙŠ Ù…Ù† Ø£ØµÙ„ ${permissions.length}`);
}

/**
 * ğŸ”“ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
 */
function openAdvancedPermissionsSearch() {
    const modal = document.getElementById('advancedPermissionsSearchModal');
    if (modal) {
        modal.style.display = 'flex';
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª
        const warehouseSelect = document.getElementById('permWarehouseAdvanced');
        if (warehouseSelect) {
            warehouseSelect.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
            branches.forEach(branch => {
                warehouseSelect.innerHTML += `<option value="${branch.id}">${branch.name}</option>`;
            });
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        const customerSelect = document.getElementById('permCustomerAdvanced');
        if (customerSelect) {
            customerSelect.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
            customers.forEach(customer => {
                customerSelect.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
            });
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        const supplierSelect = document.getElementById('permSupplierAdvanced');
        if (supplierSelect) {
            supplierSelect.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
            suppliers.forEach(supplier => {
                supplierSelect.innerHTML += `<option value="${supplier.id}">${supplier.name}</option>`;
            });
        }
    }
}

/**
 * ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
 */
function closeAdvancedPermissionsSearch() {
    const modal = document.getElementById('advancedPermissionsSearchModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

/**
 * ğŸ” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
 */
function applyAdvancedPermissionsSearch() {
    const dateFrom = document.getElementById('permDateFrom')?.value;
    const dateTo = document.getElementById('permDateTo')?.value;
    const type = document.getElementById('permTypeAdvanced')?.value;
    const warehouseId = document.getElementById('permWarehouseAdvanced')?.value;
    const customerId = document.getElementById('permCustomerAdvanced')?.value;
    const supplierId = document.getElementById('permSupplierAdvanced')?.value;
    
    let filtered = [...permissions];
    
    // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (dateFrom) {
        filtered = filtered.filter(p => new Date(p.date) >= new Date(dateFrom));
    }
    
    if (dateTo) {
        filtered = filtered.filter(p => new Date(p.date) <= new Date(dateTo));
    }
    
    // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ù†ÙˆØ¹
    if (type) {
        filtered = filtered.filter(p => p.type === type);
    }
    
    // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
    if (warehouseId) {
        filtered = filtered.filter(p => p.warehouseId === parseInt(warehouseId));
    }
    
    // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„
    if (customerId) {
        filtered = filtered.filter(p => p.partyId === parseInt(customerId) && p.type === 'out');
    }
    
    // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ù…ÙˆØ±Ø¯
    if (supplierId) {
        filtered = filtered.filter(p => p.partyId === parseInt(supplierId) && p.type === 'in');
    }
    
    renderFilteredPermissions(filtered);
    closeAdvancedPermissionsSearch();
    
    showNotification('âœ… ØªÙ… Ø§Ù„Ø¨Ø­Ø«', `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${filtered.length} Ø¥Ø°Ù† Ù…Ø®Ø²Ù†ÙŠ`, 'success');
}

/**
 * ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
 */
function resetAdvancedPermissionsSearch() {
    document.getElementById('permDateFrom').value = '';
    document.getElementById('permDateTo').value = '';
    document.getElementById('permTypeAdvanced').value = '';
    document.getElementById('permWarehouseAdvanced').value = '';
    document.getElementById('permCustomerAdvanced').value = '';
    document.getElementById('permSupplierAdvanced').value = '';
    
    renderPermissionsList();
    closeAdvancedPermissionsSearch();
}

/**
 * ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©
 */
function loadPermissionsFilters() {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª ÙÙŠ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    const warehouseSelect = document.getElementById('permWarehouse');
    if (warehouseSelect) {
        warehouseSelect.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
        branches.forEach(branch => {
            warehouseSelect.innerHTML += `<option value="${branch.id}">${branch.name}</option>`;
        });
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    const customerSelect = document.getElementById('permCustomer');
    if (customerSelect) {
        customerSelect.innerHTML = '<option value=""Ø§Ø®ØªØ±/option>';
        customers.forEach(customer => {
            customerSelect.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
        });
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
    const supplierSelect = document.getElementById('permSupplier');
    if (supplierSelect) {
        supplierSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>';
        suppliers.forEach(supplier => {
            supplierSelect.innerHTML += `<option value="${supplier.id}">${supplier.name}</option>`;
        });
    }
}

// ===== Ø¯ÙˆØ§Ù„ Ø¥Ø°Ù† Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„ÙŠØ¯ÙˆÙŠ =====

let manualPermissionRowIndex = 0;

/**
 * ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø¥Ø°Ù† ØªØ³ÙˆÙŠØ© ÙŠØ¯ÙˆÙŠ
 */
function openManualPermissionModal() {
    // ØªØµÙÙŠØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('manualPermDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('manualPermType').value = '';
    document.getElementById('manualPermWarehouse').value = '';
    document.getElementById('manualPermNotes').value = '';
    document.getElementById('manualPermItemsBody').innerHTML = '';
    manualPermissionRowIndex = 0;
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª
    const warehouseSelect = document.getElementById('manualPermWarehouse');
    warehouseSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</option>';
    branches.forEach(branch => {
        warehouseSelect.innerHTML += `<option value="${branch.id}">${branch.name}</option>`;
    });
    
    // Ø¥Ø¶Ø§ÙØ© ØµÙ ÙˆØ§Ø­Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ
    addManualPermissionRow();
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.getElementById('manualPermissionModal').style.display = 'flex';
}

/**
 * Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø°Ù† Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„ÙŠØ¯ÙˆÙŠ
 */
function closeManualPermissionModal() {
    document.getElementById('manualPermissionModal').style.display = 'none';
}

/**
 * Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ Ù„Ø¥Ø¯Ø®Ø§Ù„ ØµÙ†Ù
 */
function addManualPermissionRow() {
    const tbody = document.getElementById('manualPermItemsBody');
    const rowId = `manualPermRow${manualPermissionRowIndex++}`;
    
    const tr = document.createElement('tr');
    tr.id = rowId;
    tr.innerHTML = `
        <td style="padding: 8px; border: 1px solid #dee2e6;">
            <select class="manualPermItem" onchange="updateManualPermUnits(this)" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>
                ${items.map(item => `<option value="${item.id}">${item.name} (Ù…ØªÙˆÙØ±: ${item.stock})</option>`).join('')}
            </select>
        </td>
        <td style="padding: 8px; border: 1px solid #dee2e6;">
            <input type="number" class="manualPermQty" min="0.01" step="0.01" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
        </td>
        <td style="padding: 8px; border: 1px solid #dee2e6;">
            <select class="manualPermUnit" disabled style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; background: #f8f9fa;">
                <option value="">Ø§Ù„ÙˆØ­Ø¯Ø©</option>
            </select>
        </td>
        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
            <button onclick="removeManualPermissionRow('${rowId}')" class="btn-danger" style="padding: 5px 10px; font-size: 0.9em;">ğŸ—‘ï¸</button>
        </td>
    `;
    tbody.appendChild(tr);
}

/**
 * Ø­Ø°Ù ØµÙ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
 */
function removeManualPermissionRow(rowId) {
    const row = document.getElementById(rowId);
    if (row) row.remove();
}

/**
 * ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ†Ù
 */
function updateManualPermUnits(selectElement) {
    const itemId = parseInt(selectElement.value);
    const row = selectElement.closest('tr');
    const unitSelect = row.querySelector('.manualPermUnit');
    
    if (!itemId) {
        unitSelect.innerHTML = '<option value="">Ø§Ù„ÙˆØ­Ø¯Ø©</option>';
        unitSelect.disabled = true;
        return;
    }
    
    const item = items.find(i => i.id === itemId);
    if (!item || !item.units || item.units.length === 0) {
        unitSelect.innerHTML = '<option value="piece">Ù‚Ø·Ø¹Ø©</option>';
        unitSelect.disabled = false;
        return;
    }
    
    unitSelect.innerHTML = item.units.map(unit => 
        `<option value="${unit.name}">${unit.name} (${unit.quantity} Ù‚Ø·Ø¹Ø©)</option>`
    ).join('');
    unitSelect.disabled = false;
}

/**
 * Ø­ÙØ¸ Ø¥Ø°Ù† Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„ÙŠØ¯ÙˆÙŠ
 */
async function saveManualPermission() {
    // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const date = document.getElementById('manualPermDate').value;
    const type = document.getElementById('manualPermType').value;
    const warehouseId = parseInt(document.getElementById('manualPermWarehouse').value);
    const notes = document.getElementById('manualPermNotes').value.trim();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    if (!date || !type || !warehouseId || !notes) {
        showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning');
        return;
    }
    
    // Ø¬Ù…Ø¹ Ø§Ù„Ø£ØµÙ†Ø§Ù
    const rows = document.querySelectorAll('#manualPermItemsBody tr');
    const permissionItems = [];
    
    for (let row of rows) {
        const itemId = parseInt(row.querySelector('.manualPermItem').value);
        const qty = parseFloat(row.querySelector('.manualPermQty').value);
        const unit = row.querySelector('.manualPermUnit').value;
        
        if (itemId && qty > 0 && unit) {
            const item = items.find(i => i.id === itemId);
            if (!item) continue;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø§Ù„Ù‚Ø·Ø¹
            let qtyInPieces = qty;
            if (item.units && item.units.length > 0) {
                const selectedUnit = item.units.find(u => u.name === unit);
                if (selectedUnit) {
                    qtyInPieces = qty * selectedUnit.quantity;
                }
            }
            
            permissionItems.push({
                id: itemId,
                name: item.name,
                code: item.code || 'N/A',
                quantity: qtyInPieces,
                unit: unit,
                originalQty: qty
            });
        }
    }
    
    if (permissionItems.length === 0) {
        showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warning');
        return;
    }
    
    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸
    const typeText = type === 'in' ? 'Ø²ÙŠØ§Ø¯Ø© (ÙØ§Ø¦Ø¶)' : 'Ù†Ù‚Øµ (Ø¹Ø¬Ø²/ØªØ§Ù„Ù)';
    const confirmed = await showConfirmDialog({
        title: 'ğŸ’¾ ØªØ£ÙƒÙŠØ¯ Ø­ÙØ¸ Ø§Ù„Ø¥Ø°Ù†',
        message: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø¥Ø°Ù† Ø§Ù„ØªØ³ÙˆÙŠØ©ØŸ\n\nØ§Ù„Ù†ÙˆØ¹: ${typeText}\nØ¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù: ${permissionItems.length}\n\nØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ø¨Ø§Ø´Ø±Ø©.`,
        type: 'info',
        confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­ÙØ¸',
        cancelText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    
    if (!confirmed) return;
    
    try {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙÙŠ Ù…ØµÙÙˆÙØ© items
        for (let permItem of permissionItems) {
            const item = items.find(i => i.id === permItem.id);
            if (item) {
                if (type === 'in') {
                    // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                    item.stock += permItem.quantity;
                } else {
                    // Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                    item.stock -= permItem.quantity;
                    if (item.stock < 0) item.stock = 0; // Ù…Ù†Ø¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ø§Ù„Ø¨
                }
            }
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        await saveToLocalStorage('items', items);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø°Ù† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ
        const warehouse = branches.find(b => b.id === warehouseId);
        const manualInvoice = {
            id: Date.now(),
            date: date,
            type: type,
            number: permissions.length + 1,
            items: permissionItems,
            notes: notes,
            warehouseName: warehouse ? warehouse.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            source: 'manual',
            reference: `ØªØ³ÙˆÙŠØ© ÙŠØ¯ÙˆÙŠØ© - ${typeText}`
        };
        
        await createStockPermission(type, manualInvoice, 'manual');
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        closeManualPermissionModal();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        renderPermissionsList();
        renderItems();
        updateDashboard();
        
        showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ø¥Ø°Ù† Ø§Ù„ØªØ³ÙˆÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (${permissionItems.length} ØµÙ†Ù)`, 'success');
        
    } catch (error) {
        console.error('Error saving manual permission:', error);
        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø°Ù†', 'error');
    }
}

// ===== Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø¥Ø°Ù† Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„ÙŠØ¯ÙˆÙŠ =====

// ===== ğŸ“‹ Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø±Ø¯ =====

let currentInventoryData = [];
// inventoryAdjustments declared globally at top of script

/**
 * ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ
 */
function openInventoryModal() {
    // ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    currentInventoryData = [];
    document.getElementById('inventoryDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('inventoryWarehouse').value = '';
    document.getElementById('inventoryReference').value = '';
    document.getElementById('inventoryNotes').value = '';
    document.getElementById('inventorySearchInput').value = '';
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª - Ø§Ø³ØªØ®Ø¯Ø§Ù… warehouses Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† branches
    const warehouseSelect = document.getElementById('inventoryWarehouse');
    warehouseSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</option>';
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª
    const warehouseList = warehouses || branches || [];
    
    console.log('ğŸ­ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:', warehouseList.length);
    console.log('ğŸ“¦ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª:', warehouseList);
    
    if (warehouseList.length === 0) {
        console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
        ensurePrimaryWarehouse(); // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙˆØ¯Ø¹ Ø±Ø¦ÙŠØ³ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
        const updatedList = warehouses || branches || [];
        updatedList.forEach(warehouse => {
            const isPrimary = warehouse.isPrimary || warehouse.type === 'primary';
            warehouseSelect.innerHTML += `<option value="${warehouse.id}">${warehouse.name}${isPrimary ? ' ğŸ†' : ''}</option>`;
        });
    } else {
        warehouseList.forEach(warehouse => {
            const isPrimary = warehouse.isPrimary || warehouse.type === 'primary';
            warehouseSelect.innerHTML += `<option value="${warehouse.id}">${warehouse.name}${isPrimary ? ' ğŸ†' : ''}</option>`;
        });
    }
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    const primaryWarehouse = warehouseList.find(w => w.isPrimary || w.type === 'primary');
    if (primaryWarehouse) {
        warehouseSelect.value = primaryWarehouse.id;
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:', primaryWarehouse.name);
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø±Ø¯
    loadInventoryCountingTable();
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.getElementById('inventoryModal').style.display = 'flex';
}

/**
 * Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ø±Ø¯
 */
function closeInventoryModal() {
    document.getElementById('inventoryModal').style.display = 'none';
    currentInventoryData = [];
}

/**
 * ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù„Ù„Ø¬Ø±Ø¯
 */
function loadInventoryCountingTable() {
    const tbody = document.getElementById('inventoryCountingBody');
    tbody.innerHTML = '';
    
    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</td></tr>';
        return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ù„ÙƒÙ„ ØµÙ†Ù
    items.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.id = `inventoryRow${item.id}`;
        tr.dataset.itemId = item.id;
        tr.dataset.itemName = item.name.toLowerCase();
        tr.dataset.itemCode = (item.code || '').toLowerCase();
        
        const systemStock = item.stock || 0;
        const unitName = item.unit || 'Ù‚Ø·Ø¹Ø©';
        
        tr.innerHTML = `
            <td style="padding: 10px; border: 1px solid #dee2e6;">${item.code || 'N/A'}</td>
            <td style="padding: 10px; border: 1px solid #dee2e6;">${item.name}</td>
            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; background: #f8f9fa; font-weight: bold;">
                ${systemStock.toFixed(2)}
            </td>
            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">
                <input type="number" 
                       class="actualStockInput" 
                       data-item-id="${item.id}" 
                       data-system-stock="${systemStock}"
                       step="0.01" 
                       min="0" 
                       value="${systemStock.toFixed(2)}"
                       style="width: 100%; padding: 8px; border: 2px solid #ffc107; border-radius: 4px; text-align: center; font-weight: bold;"
                       oninput="calculateVariance(this)">
            </td>
            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">
                <span class="varianceDisplay" style="font-weight: bold; font-size: 1.1em;">0.00</span>
            </td>
            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${unitName}</td>
        `;
        
        tbody.appendChild(tr);
        
        // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
        currentInventoryData.push({
            itemId: item.id,
            itemName: item.name,
            itemCode: item.code || 'N/A',
            systemStock: systemStock,
            actualStock: systemStock,
            variance: 0,
            unit: unitName
        });
    });
    
    updateInventorySummary();
}

/**
 * Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ
 */
function calculateVariance(inputElement) {
    const itemId = parseInt(inputElement.dataset.itemId);
    const systemStock = parseFloat(inputElement.dataset.systemStock);
    const actualStock = parseFloat(inputElement.value) || 0;
    const variance = actualStock - systemStock;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    const row = inputElement.closest('tr');
    const varianceDisplay = row.querySelector('.varianceDisplay');
    varianceDisplay.textContent = variance.toFixed(2);
    
    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ÙØ±Ù‚
    if (variance > 0) {
        // ÙØ§Ø¦Ø¶ (Ø²ÙŠØ§Ø¯Ø©)
        row.style.background = 'rgba(76, 175, 80, 0.1)';
        varianceDisplay.style.color = '#4caf50';
        varianceDisplay.textContent = '+' + variance.toFixed(2);
    } else if (variance < 0) {
        // Ø¹Ø¬Ø² (Ù†Ù‚Øµ)
        row.style.background = 'rgba(244, 67, 54, 0.1)';
        varianceDisplay.style.color = '#f44336';
    } else {
        // Ù…ØªØ·Ø§Ø¨Ù‚
        row.style.background = '';
        varianceDisplay.style.color = '#666';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
    const dataIndex = currentInventoryData.findIndex(d => d.itemId === itemId);
    if (dataIndex > -1) {
        currentInventoryData[dataIndex].actualStock = actualStock;
        currentInventoryData[dataIndex].variance = variance;
    }
    
    updateInventorySummary();
}

/**
 * ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø§Ù„Ø¬Ø±Ø¯
 */
function updateInventorySummary() {
    const totalItems = currentInventoryData.length;
    const surplusItems = currentInventoryData.filter(d => d.variance > 0).length;
    const shortageItems = currentInventoryData.filter(d => d.variance < 0).length;
    
    document.getElementById('inventoryItemsCount').textContent = totalItems;
    document.getElementById('inventorySurplusDisplay').textContent = surplusItems;
    document.getElementById('inventoryShortageDisplay').textContent = shortageItems;
}

/**
 * ÙÙ„ØªØ±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø±Ø¯ (Ø¨Ø­Ø«)
 */
function filterInventoryItems() {
    const searchTerm = document.getElementById('inventorySearchInput').value.toLowerCase().trim();
    const rows = document.querySelectorAll('#inventoryCountingBody tr');
    
    rows.forEach(row => {
        const itemName = row.dataset.itemName || '';
        const itemCode = row.dataset.itemCode || '';
        
        if (itemName.includes(searchTerm) || itemCode.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

/**
 * Ø­ÙØ¸ ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ø¬Ø±Ø¯ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
 */
async function saveInventoryAdjustment() {
    // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const date = document.getElementById('inventoryDate').value;
    const warehouseId = parseInt(document.getElementById('inventoryWarehouse').value);
    const reference = document.getElementById('inventoryReference').value.trim();
    const notes = document.getElementById('inventoryNotes').value.trim();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    if (!date || !warehouseId) {
        showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', 'warning');
        return;
    }
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªÙŠ Ø¨Ù‡Ø§ ÙØ±ÙˆÙ‚Ø§Øª ÙÙ‚Ø·
    const adjustmentItems = currentInventoryData.filter(d => d.variance !== 0);
    
    if (adjustmentItems.length === 0) {
        showNotification('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆÙ‚Ø§Øª', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…ØªØ·Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù…. Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ³ÙˆÙŠØ©.', 'info');
        return;
    }
    
    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸
    const surplusCount = adjustmentItems.filter(d => d.variance > 0).length;
    const shortageCount = adjustmentItems.filter(d => d.variance < 0).length;
    
    const confirmed = await showConfirmDialog({
        title: 'ğŸ’¾ ØªØ£ÙƒÙŠØ¯ Ø­ÙØ¸ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª',
        message: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¬Ø±Ø¯ØŸ\n\nğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª: ${adjustmentItems.length} ØµÙ†Ù\nğŸ“ˆ ÙØ§Ø¦Ø¶ (Ø²ÙŠØ§Ø¯Ø©): ${surplusCount} ØµÙ†Ù\nğŸ“‰ Ø¹Ø¬Ø² (Ù†Ù‚Øµ): ${shortageCount} ØµÙ†Ù\n\nâš ï¸ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø£Ø°ÙˆÙ† Ù…Ø®Ø²Ù†ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.`,
        type: 'warning',
        confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­ÙØ¸ ÙˆØ§Ø·Ø¨Ù‚',
        cancelText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    
    if (!confirmed) return;
    
    try {
        const warehouse = branches.find(b => b.id === warehouseId);
        const warehouseName = warehouse ? warehouse.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ØªØ³ÙˆÙŠØ©
        const adjustmentRecord = {
            id: Date.now(),
            date: date,
            warehouseId: warehouseId,
            warehouseName: warehouseName,
            reference: reference || `Ø¬Ø±Ø¯ ${date}`,
            notes: notes,
            itemsCount: adjustmentItems.length,
            surplusCount: surplusCount,
            shortageCount: shortageCount,
            items: adjustmentItems,
            createdAt: new Date().toISOString()
        };
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        for (let adjItem of adjustmentItems) {
            const item = items.find(i => i.id === adjItem.itemId);
            if (!item) continue;
            
            // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            const oldStock = item.stock;
            item.stock = adjItem.actualStock;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø°Ù† Ù…Ø®Ø²Ù†ÙŠ Ù„Ù„ØªØ³ÙˆÙŠØ©
            const permissionType = adjItem.variance > 0 ? 'in' : 'out';
            const permissionSource = adjItem.variance > 0 ? 'inventory_surplus' : 'inventory_shortage';
            
            const mockInvoice = {
                id: adjustmentRecord.id,
                date: date,
                number: adjustmentRecord.id,
                items: [{
                    id: adjItem.itemId,
                    name: adjItem.itemName,
                    code: adjItem.itemCode,
                    quantity: Math.abs(adjItem.variance),
                    unit: adjItem.unit
                }],
                notes: `${reference || 'Ø¬Ø±Ø¯ Ù…Ø®Ø²Ù†ÙŠ'} - ${adjItem.itemName} (Ø§Ù„Ù†Ø¸Ø§Ù…: ${adjItem.systemStock.toFixed(2)}, Ø§Ù„ÙØ¹Ù„ÙŠ: ${adjItem.actualStock.toFixed(2)})`,
                warehouseName: warehouseName,
                source: permissionSource,
                reference: reference || `Ø¬Ø±Ø¯ ${date}`
            };
            
            await createStockPermission(permissionType, mockInvoice, permissionSource);
        }
        
        // Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØ³ÙˆÙŠØ©
        if (!inventoryAdjustments) inventoryAdjustments = [];
        inventoryAdjustments.push(adjustmentRecord);
        await saveToLocalStorage('inventoryAdjustments', inventoryAdjustments);
        
        // Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        await saveToLocalStorage('items', items);
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        closeInventoryModal();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        renderInventoryHistory();
        renderItems();
        renderPermissionsList();
        updateInventoryStatistics();
        updateDashboard();
        
        showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¬Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªØ­Ø¯ÙŠØ« ${adjustmentItems.length} ØµÙ†Ù`, 'success');
        
    } catch (error) {
        console.error('Error saving inventory adjustment:', error);
        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª', 'error');
    }
}

/**
 * Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¬Ø±Ø¯
 */
function renderInventoryHistory() {
    console.log('ğŸ” renderInventoryHistory called');
    console.log('ğŸ“Š inventoryAdjustments:', inventoryAdjustments);
    console.log('ğŸ“Š inventoryAdjustments length:', inventoryAdjustments?.length);
    
    const tbody = document.getElementById('inventoryHistoryList');
    console.log('ğŸ“‹ tbody element:', tbody);
    if (!tbody) {
        console.error('âŒ inventoryHistoryList element not found!');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (!inventoryAdjustments || inventoryAdjustments.length === 0) {
        console.log('âš ï¸ No inventory adjustments found - showing empty message');
        tbody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align: center; padding: 30px; color: #999;">
                    <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“‹</div>
                    <div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¬Ø±Ø¯ Ù…Ø³Ø¬Ù„Ø©. Ø§Ø¨Ø¯Ø£ Ø¹Ù…Ù„ÙŠØ© Ø¬Ø±Ø¯ Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ø¢Ù†!</div>
                </td>
            </tr>
        `;
        return;
    }
    
    console.log('âœ… Rendering', inventoryAdjustments.length, 'inventory adjustments');
    
    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    const sortedAdjustments = [...inventoryAdjustments].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    sortedAdjustments.forEach(adj => {
        const totalVariance = adj.items.reduce((sum, item) => sum + Math.abs(item.variance), 0);
        const statusColor = (adj.surplusCount > 0 && adj.shortageCount > 0) ? '#ff9800' : 
                          (adj.surplusCount > 0) ? '#4caf50' : '#f44336';
        const statusText = (adj.surplusCount > 0 && adj.shortageCount > 0) ? 'âš ï¸ Ù…Ø®ØªÙ„Ø·' : 
                         (adj.surplusCount > 0) ? 'âœ… ÙØ§Ø¦Ø¶' : 'âŒ Ø¹Ø¬Ø²';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${adj.date}</td>
            <td>${adj.warehouseName}</td>
            <td>${adj.reference}</td>
            <td style="text-align: center; font-weight: bold;">${adj.itemsCount}</td>
            <td style="text-align: center; color: #4caf50; font-weight: bold;">${adj.surplusCount}</td>
            <td style="text-align: center; color: #f44336; font-weight: bold;">${adj.shortageCount}</td>
            <td style="text-align: center; font-weight: bold;">${totalVariance.toFixed(2)}</td>
            <td style="text-align: center;">
                <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9em; font-weight: bold;">
                    ${statusText}
                </span>
            </td>
            <td>
                <div class="action-menu-container">
                    <button class="action-menu-btn" onclick="toggleActionMenu(this, 'inventory-menu-${adj.id}', event)">â‹®</button>
                    <div id="inventory-menu-${adj.id}" class="action-menu-content">
                        <a href="#" onclick="event.preventDefault(); viewInventoryDetails(${adj.id});">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
                        <a href="#" onclick="event.preventDefault(); printInventoryReport(${adj.id});">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</a>
                        <a href="#" class="delete-action" onclick="event.preventDefault(); deleteInventoryAdjustment(${adj.id});">ğŸ—‘ï¸ Ø­Ø°Ù</a>
                    </div>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

/**
 * ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø±Ø¯
 */
function updateInventoryStatistics() {
    if (!inventoryAdjustments) inventoryAdjustments = [];
    
    const totalAdjustments = inventoryAdjustments.length;
    const fullCount = inventoryAdjustments.filter(adj => adj.itemsCount === items.length).length;
    const totalSurplus = inventoryAdjustments.reduce((sum, adj) => sum + adj.surplusCount, 0);
    const totalShortage = inventoryAdjustments.reduce((sum, adj) => sum + adj.shortageCount, 0);
    
    document.getElementById('miniStatInventory').textContent = totalAdjustments;
    document.getElementById('inventoryTotalItems').textContent = items.length;
    document.getElementById('inventoryFullCount').textContent = fullCount;
    document.getElementById('inventorySurplusCount').textContent = totalSurplus;
    document.getElementById('inventoryShortageCount').textContent = totalShortage;
}

/**
 * Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¬Ø±Ø¯
 */
function viewInventoryDetails(adjustmentId) {
    const adjustment = inventoryAdjustments.find(adj => adj.id === adjustmentId);
    if (!adjustment) {
        showNotification('âŒ Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø±Ø¯', 'error');
        return;
    }
    
    let itemsHtml = '';
    adjustment.items.forEach(item => {
        const varianceColor = item.variance > 0 ? '#4caf50' : '#f44336';
        const varianceSign = item.variance > 0 ? '+' : '';
        itemsHtml += `
            <tr>
                <td style="padding: 8px; border: 1px solid #dee2e6;">${item.itemCode}</td>
                <td style="padding: 8px; border: 1px solid #dee2e6;">${item.itemName}</td>
                <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${item.systemStock.toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${item.actualStock.toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; color: ${varianceColor}; font-weight: bold;">
                    ${varianceSign}${item.variance.toFixed(2)}
                </td>
                <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${item.unit}</td>
            </tr>
        `;
    });
    
    const detailsHtml = `
        <div id="inventory-details-modal" class="modal-overlay" onclick="closeInventoryDetailsModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h3>ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¬Ø±Ø¯</h3>
                    <button class="modal-close-btn" onclick="closeInventoryDetailsModal()">âœ–</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div class="detail-row">
                            <span><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong></span>
                            <span>${adjustment.date}</span>
                        </div>
                        <div class="detail-row">
                            <span><strong>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</strong></span>
                            <span>${adjustment.warehouseName}</span>
                        </div>
                        <div class="detail-row">
                            <span><strong>Ø§Ù„Ù…Ø±Ø¬Ø¹:</strong></span>
                            <span>${adjustment.reference}</span>
                        </div>
                        <div class="detail-row">
                            <span><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù:</strong></span>
                            <span style="font-weight: bold;">${adjustment.itemsCount}</span>
                        </div>
                        <div class="detail-row">
                            <span><strong>Ø§Ù„ÙØ§Ø¦Ø¶:</strong></span>
                            <span style="color: #4caf50; font-weight: bold;">${adjustment.surplusCount} ØµÙ†Ù</span>
                        </div>
                        <div class="detail-row">
                            <span><strong>Ø§Ù„Ø¹Ø¬Ø²:</strong></span>
                            <span style="color: #f44336; font-weight: bold;">${adjustment.shortageCount} ØµÙ†Ù</span>
                        </div>
                    </div>
                    ${adjustment.notes ? `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong><br>
                        ${adjustment.notes}
                    </div>
                    ` : ''}
                    <h4 style="margin-bottom: 15px; color: #667eea;">ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; border: 1px solid #dee2e6;">Ø§Ù„ÙƒÙˆØ¯</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6;">Ø§Ù„ØµÙ†Ù</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6;">Ø§Ù„Ù†Ø¸Ø§Ù…</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6;">Ø§Ù„ÙØ¹Ù„ÙŠ</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6;">Ø§Ù„ÙØ±Ù‚</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeInventoryDetailsModal()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', detailsHtml);
}

/**
 * Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¯
 */
function closeInventoryDetailsModal(event) {
    if (event && event.target !== event.currentTarget) return;
    const modal = document.getElementById('inventory-details-modal');
    if (modal) modal.remove();
}

/**
 * Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ø±Ø¯
 */
function printInventoryReport(adjustmentId) {
    const adjustment = inventoryAdjustments.find(adj => adj.id === adjustmentId);
    if (!adjustment) {
        showNotification('âŒ Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø±Ø¯', 'error');
        return;
    }
    
    let itemsHtml = '';
    adjustment.items.forEach((item, index) => {
        const varianceColor = item.variance > 0 ? '#4caf50' : '#f44336';
        const varianceSign = item.variance > 0 ? '+' : '';
        itemsHtml += `
            <tr>
                <td style="padding: 8px; border: 1px solid #333; text-align: center;">${index + 1}</td>
                <td style="padding: 8px; border: 1px solid #333;">${item.itemCode}</td>
                <td style="padding: 8px; border: 1px solid #333;">${item.itemName}</td>
                <td style="padding: 8px; border: 1px solid #333; text-align: center;">${item.systemStock.toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid #333; text-align: center; font-weight: bold;">${item.actualStock.toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid #333; text-align: center; color: ${varianceColor}; font-weight: bold;">
                    ${varianceSign}${item.variance.toFixed(2)}
                </td>
                <td style="padding: 8px; border: 1px solid #333; text-align: center;">${item.unit}</td>
            </tr>
        `;
    });
    
    const activityName = activities.find(a => a.id === currentActivityId)?.name || 'Ø§Ù„Ù…Ù†Ø´Ø£Ø©';
    
    const reportHTML = `
<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªÙ‚Ø±ÙŠØ± Ø¬Ø±Ø¯ - ${adjustment.reference}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
        .report-container { max-width: 1000px; margin: 0 auto; }
        .report-header { text-align: center; padding: 20px; border-bottom: 3px solid #667eea; margin-bottom: 20px; }
        .company-name { font-size: 1.8em; font-weight: bold; color: #667eea; margin-bottom: 10px; }
        .report-title { font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 5px; }
        .report-info { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .info-box { background: #f8f9fa; padding: 12px; border-radius: 6px; border-right: 4px solid #667eea; }
        .info-label { font-size: 0.9em; color: #666; margin-bottom: 5px; }
        .info-value { font-weight: bold; color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #667eea; color: white; padding: 12px; border: 1px solid #333; text-align: center; }
        td { padding: 8px; border: 1px solid #333; }
        .summary-box { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .signature-section { margin-top: 40px; display: flex; justify-content: space-between; }
        .signature-box { text-align: center; }
        .signature-line { width: 200px; border-top: 2px solid #333; margin-top: 60px; padding-top: 10px; }
        @media print { body { padding: 0; } .report-container { max-width: 100%; } }
    </style>
</head>
<body>
    <div class="report-container">
        <div class="report-header">
            <div class="company-name">${activityName}</div>
            <div class="report-title">ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø¬Ø±Ø¯ Ù…Ø®Ø²Ù†ÙŠ</div>
            <div style="color: #666; margin-top: 10px;">${adjustment.reference}</div>
        </div>
        
        <div class="report-info">
            <div class="info-box">
                <div class="info-label">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
                <div class="info-value">${adjustment.date}</div>
            </div>
            <div class="info-box">
                <div class="info-label">ğŸª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</div>
                <div class="info-value">${adjustment.warehouseName}</div>
            </div>
            <div class="info-box">
                <div class="info-label">ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
                <div class="info-value">${adjustment.itemsCount} ØµÙ†Ù</div>
            </div>
        </div>
        
        ${adjustment.notes ? `
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-right: 4px solid #ffc107; margin-bottom: 20px;">
            <strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong><br>
            ${adjustment.notes}
        </div>
        ` : ''}
        
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                    <th>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø§Ù„Ø±ØµÙŠØ¯ (Ù†Ø¸Ø§Ù…)</th>
                    <th>Ø§Ù„Ø±ØµÙŠØ¯ (ÙØ¹Ù„ÙŠ)</th>
                    <th>Ø§Ù„ÙØ±Ù‚</th>
                    <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                </tr>
            </thead>
            <tbody>
                ${itemsHtml}
            </tbody>
        </table>
        
        <div class="summary-box">
            <h3 style="margin-bottom: 15px; color: #667eea;">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
            <div class="summary-row">
                <span><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…ÙØ­ÙˆØµØ©:</strong></span>
                <span>${adjustment.itemsCount} ØµÙ†Ù</span>
            </div>
            <div class="summary-row">
                <span><strong>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¨ÙØ§Ø¦Ø¶ (Ø²ÙŠØ§Ø¯Ø©):</strong></span>
                <span style="color: #4caf50; font-weight: bold;">${adjustment.surplusCount} ØµÙ†Ù</span>
            </div>
            <div class="summary-row">
                <span><strong>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¨Ø¹Ø¬Ø² (Ù†Ù‚Øµ):</strong></span>
                <span style="color: #f44336; font-weight: bold;">${adjustment.shortageCount} ØµÙ†Ù</span>
            </div>
        </div>
        
        <div class="signature-section">
            <div class="signature-box">
                <div class="signature-line">Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¬Ø±Ø¯</div>
            </div>
            <div class="signature-box">
                <div class="signature-line">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</div>
            </div>
            <div class="signature-box">
                <div class="signature-line">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</div>
            </div>
        </div>
    </div>
    
    <script>
        window.onload = function() { window.print(); };
        window.onafterprint = function() { window.close(); };
        setTimeout(function() { window.close(); }, 100);
    <\/script>
</body>
</html>`;
    
    const printWindow = window.open('', '_blank', 'width=1000,height=800');
    printWindow.document.write(reportHTML);
    printWindow.document.close();
}

/**
 * Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø¬Ø±Ø¯
 */
async function deleteInventoryAdjustment(adjustmentId) {
    const adjustment = inventoryAdjustments.find(adj => adj.id === adjustmentId);
    if (!adjustment) return;
    
    const confirmed = await showConfirmDialog({
        title: 'ğŸ—‘ï¸ Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¬Ø±Ø¯',
        message: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¬Ø±Ø¯ØŸ\n\nØ§Ù„Ù…Ø±Ø¬Ø¹: ${adjustment.reference}\nØ¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù: ${adjustment.itemsCount}\n\nâš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù† ÙŠØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ù…Ø·Ø¨Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†. Ù‡Ø°Ø§ Ø³ÙŠØ­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ ÙÙ‚Ø·.`,
        type: 'warning',
        confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
        cancelText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    
    if (!confirmed) return;
    
    const index = inventoryAdjustments.findIndex(adj => adj.id === adjustmentId);
    if (index > -1) {
        inventoryAdjustments.splice(index, 1);
        await saveToLocalStorage('inventoryAdjustments', inventoryAdjustments);
        
        renderInventoryHistory();
        updateInventoryStatistics();
        
        showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }
}

// ===== Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø±Ø¯ =====

function loadCustomersToSalesFilterManagement() {
    const select = document.getElementById('salesCustomerFilterManagement');
    if (!select) return;
    
    select.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
    customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.name;
        select.appendChild(option);
    });
}

function applySalesFiltersManagement() {
    const fromDate = document.getElementById('salesFromDateManagement').value;
    const toDate = document.getElementById('salesToDateManagement').value;
    const customerId = document.getElementById('salesCustomerFilterManagement').value;
    const paymentMethod = document.getElementById('salesPaymentMethodFilterManagement').value;
    
    const tbody = document.getElementById('salesListManagement');
    tbody.innerHTML = '';
    
    let filteredSales = sales;
    
    if (fromDate) filteredSales = filteredSales.filter(s => s.date >= fromDate);
    if (toDate) filteredSales = filteredSales.filter(s => s.date <= toDate);
    if (customerId) filteredSales = filteredSales.filter(s => s.customerId == customerId);
    if (paymentMethod) filteredSales = filteredSales.filter(s => s.paymentMethod === paymentMethod);
    
    if (filteredSales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
        return;
    }
    
    filteredSales.forEach(sale => {
        const customer = customers.find(c => c.id === sale.customerId);
        const paymentMethodText = sale.paymentMethod === 'cash' ? 'ğŸ’µ Ù†Ù‚Ø¯ÙŠ' : 
                                   sale.paymentMethod === 'bank' ? 'ğŸ¦ Ø¨Ù†Ùƒ' : 
                                   sale.paymentMethod === 'mixed' ? 'ğŸ”€ Ù…Ø®ØªÙ„Ø·' : 'ğŸ’µ Ù†Ù‚Ø¯ÙŠ';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>SAL${sale.number.toString().padStart(3, '0')}</td>
            <td>${sale.date}</td>
            <td>${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>${sale.total.toFixed(2)}</td>
            <td>${(sale.paidAmount || 0).toFixed(2)}</td>
            <td class="${sale.remainingAmount > 0 ? 'remaining-unpaid' : 'remaining-paid'}">${(sale.remainingAmount || 0).toFixed(2)}</td>
            <td>${paymentMethodText}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-warning edit-btn" onclick="editSale(${sale.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn-info" onclick="printSale(${sale.id})">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button class="btn-danger" onclick="deleteSale(${sale.id})">Ø­Ø°Ù</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function resetSalesFiltersManagement() {
    document.getElementById('salesFromDateManagement').value = '';
    document.getElementById('salesToDateManagement').value = '';
    document.getElementById('salesCustomerFilterManagement').value = '';
    document.getElementById('salesPaymentMethodFilterManagement').value = '';
    renderSalesManagement();
}

// ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª =====
function findPurchaseForReturnNew() {
    const invoiceNumber = parseInt(document.getElementById('purchaseReturnInvoiceSearchNew').value);
    if (isNaN(invoiceNumber)) {
        showNotification('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ØµØ­ÙŠØ­', 'warning');
        return;
    }
    
    const purchase = purchases.find(p => p.number === invoiceNumber);
    if (!purchase) {
        showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…', 'error');
        newPurchaseReturnNew();
        return;
    }

    activePurchaseReturn = purchase;
    const supplier = suppliers.find(s => s.id === purchase.supplierId);
    
    const detailsDiv = document.getElementById('purchaseReturnInvoiceDetailsNew');
    detailsDiv.innerHTML = `
        <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> PUR${purchase.number.toString().padStart(3, '0')}</p>
        <p><strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${purchase.date}</p>
    `;
    detailsDiv.style.display = 'block';

    const itemsTbody = document.getElementById('purchaseReturnItemsListNew');
    itemsTbody.innerHTML = '';
    purchase.items.forEach(item => {
        const tr = document.createElement('tr');
        tr.dataset.itemId = item.id;
        tr.dataset.price = item.price;
        tr.innerHTML = `
            <td>${item.name}</td>
            <td>${item.price.toFixed(2)}</td>
            <td>${item.quantity}</td>
            <td><input type="number" class="return-item-qty-input" min="0" max="${item.quantity}" value="0" oninput="updatePurchaseReturnTotalNew()"></td>
        `;
        itemsTbody.appendChild(tr);
    });
    
    document.getElementById('purchaseReturnItemsContainerNew').style.display = 'block';
    updatePurchaseReturnTotalNew();
}

function updatePurchaseReturnTotalNew() {
    let total = 0;
    document.querySelectorAll('#purchaseReturnItemsListNew tr').forEach(tr => {
        const price = parseFloat(tr.dataset.price);
        const qty = parseInt(tr.querySelector('input').value) || 0;
        total += price * qty;
    });
    document.getElementById('purchaseReturnTotalNew').textContent = total.toFixed(2);
}

async function savePurchaseReturnNew() {
    if (!activePurchaseReturn) {
        showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø«', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        return;
    }
    
    const returnedItems = [];
    let totalReturnValue = 0;
    document.querySelectorAll('#purchaseReturnItemsListNew tr').forEach(tr => {
        const qty = parseInt(tr.querySelector('input').value) || 0;
        if (qty > 0) {
            const originalItem = activePurchaseReturn.items.find(i => i.id == tr.dataset.itemId);
            returnedItems.push({
                id: originalItem.id,
                name: originalItem.name,
                price: originalItem.price,
                quantity: qty
            });
            totalReturnValue += originalItem.price * qty;
        }
    });

    if (returnedItems.length === 0) {
        showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ ÙƒÙ…ÙŠØ§Øª Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹', 'warning');
        return;
    }

    returnedItems.forEach(returnedItem => {
        const itemInStock = items.find(i => i.id === returnedItem.id);
        if (itemInStock) {
            itemInStock.stock -= returnedItem.quantity;
        }
    });

    const newReturn = {
        id: Date.now(),
        number: currentPurchaseReturnNumber,
        date: new Date().toISOString().split('T')[0],
        originalInvoiceId: activePurchaseReturn.id,
        originalInvoiceNumber: activePurchaseReturn.number,
        supplierId: activePurchaseReturn.supplierId,
        branchId: activePurchaseReturn.branchId || null,
        items: returnedItems,
        total: totalReturnValue
    };

    const originalPurchaseIndex = purchases.findIndex(p => p.id === activePurchaseReturn.id);
    if (originalPurchaseIndex > -1) {
        const originalPurchase = purchases[originalPurchaseIndex];
        originalPurchase.total = roundCurrency((originalPurchase.total || 0) - totalReturnValue);
        originalPurchase.remainingAmount = roundCurrency((originalPurchase.remainingAmount || 0) - totalReturnValue);
        originalPurchase.notes = (originalPurchase.notes || '') + ` [Ù…Ø±ØªØ¬Ø¹ Ø¨Ù‚ÙŠÙ…Ø©: ${totalReturnValue.toFixed(2)}]`;
    }

    purchaseReturns.push(newReturn);
    currentPurchaseReturnNumber++;
    
    const success1 = saveToLocalStorage('purchaseReturns', purchaseReturns);
    const success2 = saveToLocalStorage('items', items);
    const success3 = saveToLocalStorage('purchases', purchases);
    
    if (success1 && success2 && success3) {
        // ğŸ“‹ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø°Ù† Ù…Ø®Ø²Ù†ÙŠ Ù„Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (ØµØ±Ù)
        await createStockPermission('out', newReturn, 'purchase_return');
        
        showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø±Ù‚Ù… PR${newReturn.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        newPurchaseReturnNew();
        renderPurchaseReturnsNew();
        updateDashboard();
        renderItems();
        renderPurchasesList();
    } else {
        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}

function renderPurchaseReturnsNew() {
    const tbody = document.getElementById('purchaseReturnHistoryNew');
    tbody.innerHTML = '';
    if (purchaseReturns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø´ØªØ±ÙŠØ§Øª</td></tr>';
        return;
    }
    purchaseReturns.forEach(pr => {
        const supplier = suppliers.find(s => s.id === pr.supplierId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>PR${pr.number.toString().padStart(3, '0')}</td>
            <td>${pr.date}</td>
            <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>PUR${pr.originalInvoiceNumber.toString().padStart(3, '0')}</td>
            <td>${pr.total.toFixed(2)}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-danger" onclick="deletePurchaseReturn(${pr.id})">Ø­Ø°Ù</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function newPurchaseReturnNew() {
    activePurchaseReturn = null;
    document.getElementById('purchaseReturnInvoiceSearchNew').value = '';
    document.getElementById('purchaseReturnInvoiceDetailsNew').style.display = 'none';
    document.getElementById('purchaseReturnItemsContainerNew').style.display = 'none';
    document.getElementById('purchaseReturnItemsListNew').innerHTML = '';
    document.getElementById('purchaseReturnTotalNew').textContent = '0.00';
}

function loadSupplierAccount() {
    const supplierId = document.getElementById('accountSupplierSelect').value;
    const fromDate = document.getElementById('accountSupplierFromDate').value;
    const toDate = document.getElementById('accountSupplierToDate').value;
    
    if (!supplierId) {
        showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ±Ø¯', 'warning');
        return;
    }
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯...');
    setTimeout(() => {
        // Ø³Ù†Ù†ÙØ° generateSupplierAccountStatement Ù„Ø§Ø­Ù‚Ø§Ù‹
        showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø©', 'Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ° ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯ Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'info');
        hideLoading();
    }, 500);
}

function loadBankAccount() {
    const bankId = document.getElementById('accountBankSelect').value;
    const fromDate = document.getElementById('accountBankFromDate').value;
    const toDate = document.getElementById('accountBankToDate').value;
    
    if (!bankId) {
        showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ù†Ùƒ', 'warning');
        return;
    }
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ...');
    setTimeout(() => {
        // Ø³Ù†Ù†ÙØ° generateBankAccountStatement Ù„Ø§Ø­Ù‚Ø§Ù‹
        showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø©', 'Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ° ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'info');
        hideLoading();
    }, 500);
}

console.log('ğŸ¯ About to define loadRecentActivities...');

function loadRecentActivities() {
    // Ø¯Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ© Ù„Ø­Ù„ Ø§Ù„Ø®Ø·Ø£
    console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©...');
    return [];
}

/**
 * Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©)
 */
function checkBackupReminder() {
    try {
        const lastBackupReminder = localStorage.getItem('lastBackupReminder');
        const now = new Date().getTime();
        const dayInMs = 24 * 60 * 60 * 1000; // 24 Ø³Ø§Ø¹Ø©
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªØ°ÙƒÙŠØ± Ø³Ø§Ø¨Ù‚ Ø£Ùˆ Ù…Ø± Ø£ÙƒØ«Ø± Ù…Ù† 24 Ø³Ø§Ø¹Ø©
        if (!lastBackupReminder || (now - parseInt(lastBackupReminder)) > dayInMs) {
            // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 5 Ø«ÙˆØ§Ù†Ù Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
            setTimeout(() => {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
                const isLoggedIn = sessionStorage.getItem('isLoggedIn');
                if (isLoggedIn === 'true') {
                    showConfirmDialog(
                        'ğŸ’¾ ØªØ°ÙƒÙŠØ±: Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ',
                        'Ù…Ø±Øª 24 Ø³Ø§Ø¹Ø© Ø¹Ù„Ù‰ Ø¢Ø®Ø± ØªØ°ÙƒÙŠØ±. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ø¢Ù†ØŸ\n\nâ€¢ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ù†Ø¹Ù…" Ù„Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ\nâ€¢ Ø£Ùˆ "Ù„Ø§Ø­Ù‚Ø§Ù‹" Ù„Ù„ØªØ°ÙƒÙŠØ± ØºØ¯Ø§Ù‹',
                        'info',
                        'Ù†Ø¹Ù…ØŒ Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ',
                        'Ù„Ø§Ø­Ù‚Ø§Ù‹'
                    ).then(confirmed => {
                        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ°ÙƒÙŠØ±
                        localStorage.setItem('lastBackupReminder', now.toString());
                        
                        if (confirmed) {
                            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙØªØ­ ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                            showSection('settings');
                            setTimeout(() => {
                                switchSettingsTab('backup');
                            }, 500);
                        }
                    });
                }
            }, 5000); // 5 Ø«ÙˆØ§Ù†Ù Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        } else {
            const hoursLeft = Math.round((dayInMs - (now - parseInt(lastBackupReminder))) / (60 * 60 * 1000));
            console.log(`â° Ø§Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ù‚Ø§Ø¯Ù… Ø¨Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ø¹Ø¯ ${hoursLeft} Ø³Ø§Ø¹Ø©`);
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ:', error);
    }
}

// ØªØ­Ù…ÙŠÙ„ ØªØ®ØµÙŠØµØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
console.log('ğŸ¯ About to add DOMContentLoaded listener...');
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ğŸš€ DOMContentLoaded FIRED! - Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
    console.log('ğŸ“„ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© - ØªØ­Ù…ÙŠÙ„ ØªØ®ØµÙŠØµØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ…...');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    setTimeout(() => {
        document.body.classList.add('loaded');
    }, 100);
    
    if (typeof loadDesignPreferences === 'function') {
        loadDesignPreferences();
        console.log('ğŸ¨ ØªÙ… ØªØ­Ù…ÙŠÙ„ ØªØ®ØµÙŠØµØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©');
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ DOM Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    console.log('ğŸ“„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„...');
    setTimeout(() => {
        console.log('â° setTimeout fired - checking loadFooterSettings...');
        if (typeof loadFooterSettings === 'function') {
            console.log('âœ… loadFooterSettings function found, calling it...');
            loadFooterSettings();
            console.log('ğŸ“„ ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ loadFooterSettings() Ù…Ù† DOMContentLoaded');
        } else {
            console.error('âŒ Ø¯Ø§Ù„Ø© loadFooterSettings ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!');
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            const footer = document.getElementById('appFooter');
            if (footer) {
                footer.style.opacity = '1';
                console.log('âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
            }
        }
    }, 200); // ØªØ£Ø®ÙŠØ± 200ms Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    
    // ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù…
    if (typeof checkFirstSetup === 'function') {
        console.log('ğŸš€ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ¸ÙŠÙØ© checkFirstSetup - Ø³ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø©');
        setTimeout(() => {
            console.log('ğŸ” Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù…...');
            checkFirstSetup();
            
            // ğŸ“’ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ ÙÙˆØ±Ø§Ù‹
            if (typeof initializeChartOfAccounts === 'function') {
                console.log('ğŸ’¼ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù…Ù† DOMContentLoaded...');
                initializeChartOfAccounts();
                console.log('âœ… ØªÙ…: chartOfAccounts.length =', chartOfAccounts.length);
            }
        }, 1000); // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Firebase
    } else {
        console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ¸ÙŠÙØ© checkFirstSetup');
    }
    console.log('ğŸ DOMContentLoaded COMPLETED!');
});

</script>

    <!-- Ø¯ÙˆØ§Ù„ ØªØµØ¯ÙŠØ± ÙˆØ·Ø¨Ø§Ø¹Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±ÙˆØ§ØªØ¨ -->
    <script>
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ù‚ (Ø§Ù„Ø³Ù†Ø©ØŒ Ø§Ù„Ø´Ù‡Ø±ØŒ Ø§Ù„Ù†Ø´Ø§Ø·)
    function getPayrollContext() {
        const year = document.getElementById('payrollYear').value;
        const month = document.getElementById('payrollMonth').value;
        const monthsNames = ['', 'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
        const monthName = monthsNames[parseInt(month)] || month;
        
        let activityName = '';
        
        // 1. Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ù…Ù† Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø§Ù„Ø£ÙƒØ«Ø± Ø¯Ù‚Ø© Ù„Ø£Ù†Ù‡ Ù…Ø§ ÙŠØ±Ø§Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
        const headerTitle = document.getElementById('activityHeaderTitle');
        if (headerTitle && headerTitle.textContent && headerTitle.textContent.trim() !== 'Ø¯ÙŠÙˆØ§Ù†ÙŠ') {
            activityName = headerTitle.textContent.trim();
        } 
        // 2. Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ù…Ù† Ø­Ù‚Ù„ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        else {
            const selectedActivityInput = document.getElementById('selectedActivityName');
            if (selectedActivityInput && selectedActivityInput.value) {
                activityName = selectedActivityInput.value;
            }
            // 3. Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
            else if (window.currentActivityId) {
                try {
                    const activities = JSON.parse(localStorage.getItem('diwan_activities') || '[]');
                    const activity = activities.find(a => a.id == window.currentActivityId);
                    if (activity) activityName = activity.name;
                } catch (e) {
                    console.error('Error getting activity name:', e);
                }
            }
        }
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ù†Ø´Ø§Ø·ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙØ§Ø±ØºØ© Ø£Ùˆ Ø¹Ø§Ù…Ø©
        if (!activityName) activityName = 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ';
        
        return { year, month, monthName, activityName };
    }

    // ØªØµØ¯ÙŠØ± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø¥Ù„Ù‰ Excel
    function exportPayrollToExcel() {
        var table = document.getElementById('payrollTableBody');
        if (!table) {
            alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±ÙˆØ§ØªØ¨!');
            return;
        }
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¨
        var parentTable = table.closest('table');
        if (!parentTable) {
            alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ!');
            return;
        }

        const context = getPayrollContext();
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±
        var data = [];
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©
        data.push(["Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·:", context.activityName]);
        data.push(["Ø§Ù„Ø³Ù†Ø©:", context.year, "Ø§Ù„Ø´Ù‡Ø±:", context.monthName]);
        data.push([]); // Ø³Ø·Ø± ÙØ§Ø±Øº
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
        // Ø§Ù„Ø±Ø¤ÙˆØ³
        var headers = [];
        parentTable.querySelectorAll('thead th').forEach(th => {
            headers.push(th.innerText);
        });
        if (headers.length > 0) data.push(headers);
        
        // Ø§Ù„ØµÙÙˆÙ
        parentTable.querySelectorAll('tbody tr').forEach(row => {
            var rowData = [];
            row.querySelectorAll('td').forEach(cell => {
                rowData.push(cell.innerText);
            });
            data.push(rowData);
        });
        
        // Ø§Ù„ØªØ°ÙŠÙŠÙ„ (Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹)
        parentTable.querySelectorAll('tfoot tr').forEach(row => {
            var rowData = [];
            row.querySelectorAll('th, td').forEach(cell => {
                rowData.push(cell.innerText);
            });
            data.push(rowData);
        });

        // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØªØ§Ø¨ Ø§Ù„Ø¹Ù…Ù„
        var wb = XLSX.utils.book_new();
        var ws = XLSX.utils.aoa_to_sheet(data);
        
        // Ø¶Ø¨Ø· Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙˆØ±Ù‚Ø© Ù„Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±
        if(!ws['!views']) ws['!views'] = [];
        ws['!views'].push({ rightToLeft: true });
        
        XLSX.utils.book_append_sheet(wb, ws, "Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨");
        
        // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ø³Ù… Ù…Ø¹Ø¨Ø±
        const fileName = `Ù…Ø³ÙŠØ±_Ø§Ù„Ø±ÙˆØ§ØªØ¨_${context.year}_${context.month}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }

    // Ø·Ø¨Ø§Ø¹Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙÙ‚Ø·
    function printPayrollTable() {
        var table = document.getElementById('payrollTableBody');
        if (!table) {
            alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±ÙˆØ§ØªØ¨!');
            return;
        }
        var parentTable = table.closest('table');
        if (!parentTable) {
            alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ!');
            return;
        }
        
        const context = getPayrollContext();

        // Ù†Ø³Ø® Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        var printWindow = window.open('', '', 'width=1000,height=700');
        printWindow.document.write('<html><head><title>Ø·Ø¨Ø§Ø¹Ø© Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨</title>');
        printWindow.document.write('<style>body{font-family:Tahoma,Arial;direction:rtl;} table{border-collapse:collapse;width:100%;font-size:14px;} th,td{border:1px solid #888;padding:8px;text-align:center;} th{background:#f8f9fa;} .header-info{text-align:center; margin-bottom:20px; border-bottom: 2px solid #eee; padding-bottom: 10px;} .header-info h2{margin:5px 0;} .header-info p{margin:5px 0; font-size: 16px;}</style>');
        printWindow.document.write('</head><body>');
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        printWindow.document.write('<div class="header-info">');
        printWindow.document.write('<h2>' + context.activityName + '</h2>');
        printWindow.document.write('<h3>Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨</h3>');
        printWindow.document.write('<p><strong>Ø§Ù„Ø³Ù†Ø©:</strong> ' + context.year + ' | <strong>Ø§Ù„Ø´Ù‡Ø±:</strong> ' + context.monthName + '</p>');
        printWindow.document.write('</div>');
        
        printWindow.document.write(parentTable.outerHTML);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    }
    </script>

    <!-- ğŸ†• Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
    <div id="footerSettingsModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative;">
            <span class="close" onclick="closeFooterSettingsModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">âš™ï¸ ØªØ®ØµÙŠØµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ°ÙŠÙŠÙ„</h2>
            
            <div class="form-grid grid-1">
                <div>
                    <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©:</label>
                    <input type="text" id="footerCompanyNameInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">
                </div>
                
                <div>
                    <label>ÙˆØµÙ Ø§Ù„Ø´Ø±ÙƒØ©:</label>
                    <textarea id="footerCompanyDescInput" rows="3" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ"></textarea>
                </div>
                
                <div class="form-grid grid-2">
                    <div>
                        <label>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
                        <input type="text" id="footerPhoneInput" placeholder="+966 xx xxx xxxx">
                    </div>
                    
                    <div>
                        <label>âœ‰ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                        <input type="email" id="footerEmailInput" placeholder="info@company.com">
                    </div>
                </div>
                
                <div>
                    <label>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
                    <input type="text" id="footerAddressInput" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø±ÙƒØ©">
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                
                <h4 style="margin-bottom: 10px; color: #667eea;">ğŸŒ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</h4>
                
                <div class="form-grid grid-2">
                    <div>
                        <label>ğ• ØªÙˆÙŠØªØ±/X:</label>
                        <input type="url" id="footerTwitterInput" placeholder="https://twitter.com/yourcompany">
                    </div>
                    
                    <div>
                        <label>ğŸ“˜ ÙÙŠØ³Ø¨ÙˆÙƒ:</label>
                        <input type="url" id="footerFacebookInput" placeholder="https://facebook.com/yourcompany">
                    </div>
                    
                    <div>
                        <label>ğŸ“· Ø§Ù†Ø³ØªÙ‚Ø±Ø§Ù…:</label>
                        <input type="url" id="footerInstagramInput" placeholder="https://instagram.com/yourcompany">
                    </div>
                    
                    <div>
                        <label>ğŸ’¼ Ù„ÙŠÙ†ÙƒØ¯Ø¥Ù†:</label>
                        <input type="url" id="footerLinkedinInput" placeholder="https://linkedin.com/company/yourcompany">
                    </div>
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                
                <div class="form-grid grid-2">
                    <div>
                        <label>Â© Ù†Øµ Ø§Ù„Ø­Ù‚ÙˆÙ‚:</label>
                        <input type="text" id="footerCopyrightInput" placeholder="Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©">
                    </div>
                    
                    <div>
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</label>
                        <input type="text" id="footerVersionInput" placeholder="Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.0">
                    </div>
                </div>
                
                <div class="form-grid grid-2" style="margin-top: 20px; gap: 10px;">
                    <button class="btn-success" onclick="saveFooterSettingsFromModal()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    <button class="btn-secondary" onclick="closeFooterSettingsModal()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>



            <script>
                // Safety net: show footer only when the app UI is ready (avoid early flash)
                (function() {
                    try {
                                    const getStyle = (el) => el ? window.getComputedStyle(el) : null;
                                    const isAppReady = () => {
                                        // Ø§Ø¹ØªØ¨Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø²Ø§Ù‹ ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                                        const app = document.querySelector('.app-container');
                                        const appVisible = app && getStyle(app).display !== 'none';
                                        return Boolean(appVisible);
                                    };

                        const showFooter = () => {
                            const footer = document.getElementById('appFooter');
                            if (footer) footer.style.opacity = '1';
                        };

                        const run = () => {
                            if (typeof loadFooterSettings === 'function') {
                                try { loadFooterSettings(); } catch (e) { console.error('footer fallback load error:', e); }
                            }
                            showFooter();
                        };

                        const start = () => {
                            if (isAppReady()) {
                                run();
                                return;
                            }
                            const startTime = Date.now();
                            const maxWaitMs = 8000; // fallback after 8s even if not ready
                            const interval = setInterval(() => {
                                if (isAppReady() || (Date.now() - startTime) > maxWaitMs) {
                                    clearInterval(interval);
                                    run();
                                }
                            }, 150);
                        };

                        if (document.readyState === 'complete' || document.readyState === 'interactive') {
                            start();
                        } else {
                            document.addEventListener('DOMContentLoaded', start, { once: true });
                        }
                    } catch (err) {
                        console.error('Footer safety script error:', err);
                    }
                })();
            </script>

    <!-- Ø³ÙƒØ±ÙŠØ¨Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† -->
    <script>
        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†
        let isDarkMode = false;

        // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† Ù…Ù† localStorage
        function loadDarkModePreference() {
            const darkModePreference = localStorage.getItem('darkMode');
            if (darkModePreference === 'enabled') {
                isDarkMode = true;
                applyDarkMode();
                updateDarkModeToggleButton();
                console.log('ğŸŒ™ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† Ø§Ù„Ù…Ø­ÙÙˆØ¸');
            }
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ù…Ø· Ø¹Ù„Ù‰ Ø­Ù‚Ù„ ÙˆØ§Ø­Ø¯
        function applyInputStyle(input) {
            if (isDarkMode) {
                input.style.backgroundColor = '#2c2d2e';
                input.style.color = '#e4e6ea';
                input.style.borderColor = '#3a3b3c';
            } else {
                input.style.backgroundColor = '';
                input.style.color = '';
                input.style.borderColor = '';
            }
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†
        function applyDarkMode() {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            // ÙØ±Ø¶ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…ÙˆØ­Ø¯ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„Ø­Ø§Ù„ØªÙŠÙ†
            forceUniformInputColors();
        }
        
        // ÙØ±Ø¶ Ù„ÙˆÙ† Ù…ÙˆØ­Ø¯ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
        function forceUniformInputColors() {
            const allInputs = document.querySelectorAll('input, select, textarea');
            allInputs.forEach(applyInputStyle);
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            applyDarkMode();
            updateDarkModeToggleButton();
            
            // Ø­ÙØ¸ Ø§Ù„ØªÙØ¶ÙŠÙ„
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            
            // ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
            updateChartsForDarkMode();
            
            if (typeof showNotification === 'function') {
                showNotification(
                    isDarkMode ? 'ğŸŒ™ ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„' : 'â˜€ï¸ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡',
                    isDarkMode ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†' : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†',
                    'success'
                );
            }
            
            console.log(isDarkMode ? 'ğŸŒ™ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†' : 'â˜€ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†');
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
        function updateChartsForDarkMode() {
            if (typeof Chart !== 'undefined' && Chart.defaults) {
                if (isDarkMode) {
                    Chart.defaults.color = '#e4e6ea';
                    Chart.defaults.borderColor = '#3a3b3c';
                    Chart.defaults.backgroundColor = 'rgba(228, 230, 234, 0.1)';
                } else {
                    Chart.defaults.color = '#666';
                    Chart.defaults.borderColor = '#ddd';
                    Chart.defaults.backgroundColor = 'rgba(0, 0, 0, 0.1)';
                }
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
                if (typeof updateDashboardCharts === 'function') {
                    updateDashboardCharts();
                }
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
        function updateDarkModeToggleButton() {
            const toggleBtn = document.getElementById('darkModeToggle');
            if (toggleBtn) {
                toggleBtn.innerHTML = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
                toggleBtn.title = isDarkMode ? 'ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­' : 'ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†';
            }
        }

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
        function observeNewInputs() {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) { // Ø¹Ù†ØµØ± HTML
                            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ù†ÙØ³Ù‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„
                            if (node.matches && node.matches('input, select, textarea')) {
                                applyInputStyle(node);
                            }
                            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙØ±Ø¹ÙŠØ©
                            const inputs = node.querySelectorAll('input, select, textarea');
                            inputs.forEach(applyInputStyle);
                        }
                    });
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ¶ÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            loadDarkModePreference();
            observeNewInputs(); // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ù† localStorage - Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø´Ø§Ø·
            // ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø¯Ø§Ù„Ø© loadFromLocalStorage

            // Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø©
            checkActiveSession();
        });
        
        // Ø¯Ø§Ù„Ø© ÙØ­Øµ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù†Ø´Ø·Ø©
        function checkActiveSession() {
            try {
                const sessionUser = sessionStorage.getItem('loggedInUser');
                const sessionActive = sessionStorage.getItem('isLoggedIn');
                
                if (sessionActive === 'true' && sessionUser) {
                    console.log('ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù†Ø´Ø·Ø©...');
                    const user = JSON.parse(sessionUser);
                    window.currentUser = user;
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                    const loginOverlay = document.getElementById('login-overlay');
                    if (loginOverlay) loginOverlay.style.display = 'none';
                    
                    const appContainer = document.querySelector('.app-container');
                    if (appContainer) appContainer.style.display = 'flex';
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    if (typeof updateLoggedInUserDisplay === 'function') {
                        updateLoggedInUserDisplay(user);
                    }
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ®ØµÙŠØµ Ø¹Ù† Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·
                    if (typeof hideCustomizationForManagers === 'function') {
                        hideCustomizationForManagers(user.role);
                    }
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ°ÙŠÙŠÙ„
                    const footer = document.getElementById('appFooter');
                    if (footer) {
                        footer.style.display = 'block';
                        setTimeout(() => { footer.style.opacity = '1'; }, 100);
                    }
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
                    if (user.role === 'admin') {
                        const activityId = sessionStorage.getItem('currentActivityId');
                        if (activityId && typeof selectActivity === 'function') {
                            selectActivity(activityId);
                        } else if (typeof enterAdminWithoutActivity === 'function') {
                            enterAdminWithoutActivity();
                        }
                    } else if (user.activityId && typeof selectActivity === 'function') {
                        selectActivity(user.activityId);
                    }
                } else {
                    // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© - Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    const loginOverlay = document.getElementById('login-overlay');
                    if (loginOverlay) {
                        loginOverlay.style.display = 'flex';
                    }
                }
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø©:', e);
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø£Ø¸Ù‡Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                const loginOverlay = document.getElementById('login-overlay');
                if (loginOverlay) loginOverlay.style.display = 'flex';
            }
        }

// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± (Ø§Ù„Ù…ØµØ­Ø­Ø©)
function saveAttendanceData() {
    const year = document.getElementById('attendanceYear').value;
    const month = document.getElementById('attendanceMonth').value;
    
    if (!year || !month) {
        showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø±', 'warning');
        return;
    }

    let savedCount = 0;
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ ÙÙ‚Ø· Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
    const activeEmployees = employees.filter(e => e.status === 'active');

    activeEmployees.forEach(emp => {
        // Ù‡Ù†Ø§ Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†ÙØ³ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØªÙŠ Ø±Ø³Ù…Ù†Ø§Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (absence_, late_, overtime_)
        const absenceEl = document.getElementById(`absence_${emp.id}`);
        const lateEl = document.getElementById(`late_${emp.id}`);
        const overtimeEl = document.getElementById(`overtime_${emp.id}`);
        const notesEl = document.getElementById(`notes_${emp.id}`);

        // Ù†ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
        if (absenceEl && lateEl && overtimeEl) {
            const attendanceData = {
                employeeId: emp.id,
                employeeName: emp.nameAr,
                year: parseInt(year),
                month: parseInt(month),
                absenceDays: parseFloat(absenceEl.value) || 0, // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù„Ø±Ù‚Ù…ØŒ Ø£Ùˆ 0
                lateHours: parseFloat(lateEl.value) || 0,
                overtimeHours: parseFloat(overtimeEl.value) || 0,
                notes: notesEl ? notesEl.value.trim() : '',
                updatedAt: new Date().toISOString()
            };
            
            // Ù…ÙØªØ§Ø­ Ø§Ù„Ø­ÙØ¸
            const key = `attendance_${year}_${month}_${emp.id}`;
            
            // Ø§Ù„Ø­ÙØ¸ ÙÙŠ LocalStorage
            saveToLocalStorage(key, attendanceData);
            
            // Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù„ØªØ£ÙƒØ¯
            if (attendanceData.absenceDays > 0) {
                console.log(`âœ… ØªÙ… Ø­ÙØ¸ ØºÙŠØ§Ø¨ Ù„Ù„Ù…ÙˆØ¸Ù ${emp.nameAr}: ${attendanceData.absenceDays} Ø£ÙŠØ§Ù…`);
            }
            
            savedCount++;
        }
    });

    if (savedCount > 0) {
        showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù€ ${savedCount} Ù…ÙˆØ¸Ù Ù„Ø´Ù‡Ø± ${month}/${year}`, 'success');
    } else {
        showNotification('âš ï¸ Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.', 'error');
    }
}

    </script>

<!-- ğŸ†• Ø§Ù„ØªØ°ÙŠÙŠÙ„ (Footer) -->
<footer id="appFooter" style="background: linear-gradient(135deg, #1e3a5f 0%, #2c4a6f 100%); color: white; padding: 30px 20px; margin-top: 50px; border-top: 4px solid #1e3a5f; opacity: 0; transition: opacity 0.3s ease-in-out; position: relative; z-index: 10; display: block; box-sizing: border-box;">
    <div style="max-width: 1200px; margin: 0 auto;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-bottom: 20px;">
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© -->
            <div>
                <h4 style="margin: 0 0 15px 0; font-size: 18px; color: white;" id="footerCompanyName">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</h4>
                <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;" id="footerCompanyDesc">ÙˆØµÙ Ù…Ø®ØªØµØ± Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</p>
            </div>
            
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ -->
            <div>
                <h4 style="margin: 0 0 15px 0; font-size: 18px; color: white;">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</h4>
                <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;"><span id="footerPhone">ğŸ“ +966 xx xxx xxxx</span></p>
                <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;"><span id="footerEmail">âœ‰ï¸ info@company.com</span></p>
                <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;"><span id="footerAddress">ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span></p>
            </div>
            
            <!-- Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ -->
            <div>
                <h4 style="margin: 0 0 15px 0; font-size: 18px; color: white;">ØªØ§Ø¨Ø¹Ù†Ø§</h4>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <a href="#" id="footerTwitterLink" style="color: white; font-size: 24px; opacity: 0.8; transition: opacity 0.3s;" title="ØªÙˆÙŠØªØ±" target="_blank">ğ•</a>
                    <a href="#" id="footerFacebookLink" style="color: white; font-size: 24px; opacity: 0.8; transition: opacity 0.3s;" title="ÙÙŠØ³Ø¨ÙˆÙƒ" target="_blank">ğŸ“˜</a>
                    <a href="#" id="footerInstagramLink" style="color: white; font-size: 24px; opacity: 0.8; transition: opacity 0.3s;" title="Ø§Ù†Ø³ØªÙ‚Ø±Ø§Ù…" target="_blank">ğŸ“·</a>
                    <a href="#" id="footerLinkedinLink" style="color: white; font-size: 24px; opacity: 0.8; transition: opacity 0.3s;" title="Ù„ÙŠÙ†ÙƒØ¯Ø¥Ù†" target="_blank">ğŸ’¼</a>
                </div>
            </div>
        </div>
        
        <!-- Ø§Ù„Ø­Ù‚ÙˆÙ‚ ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚ -->
        <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; text-align: center;">
            <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;" id="footerCopyright">Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
            <p style="margin: 5px 0; font-size: 12px; opacity: 0.7;" id="footerVersion">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.0</p>
        </div>
    </div>
</footer>

    <!-- ğŸ’° Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ© (Isolated Storage) -->
    <div id="openingBalanceModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <div class="modal-content" style="background-color: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);">
            <h3 style="margin-top: 0; color: #2c3e50; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">ğŸ’° Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ©</h3>
            <p style="color: #e74c3c; font-size: 0.9em; margin-bottom: 20px; background: #fff5f5; padding: 10px; border-radius: 6px; border: 1px solid #ffcccc;">
                âš ï¸ <strong>ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…:</strong> ÙŠØªÙ… Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø±ØµØ¯Ø© ÙÙŠ Ù…Ø³Ø§Ø­Ø© ØªØ®Ø²ÙŠÙ† Ù…Ù†ÙØµÙ„Ø© ÙˆØ¢Ù…Ù†Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
            </p>
            
            <div class="form-grid" style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ’µ Ø±ØµÙŠØ¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ:</label>
                    <input type="number" id="openingCash" placeholder="0.00" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ¦ Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ:</label>
                    <input type="number" id="openingBank" placeholder="0.00" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ“¦ Ù‚ÙŠÙ…Ø© Ø¨Ø¶Ø§Ø¹Ø© Ø£ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø©:</label>
                    <input type="number" id="openingInventory" placeholder="0.00" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                </div>
                
                <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px dashed #ccc;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50;">Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ (Ù…Ø­Ø³ÙˆØ¨):</label>
                    <span id="calculatedOpeningCapital" style="font-size: 1.2em; font-weight: bold; color: #27ae60;">0.00</span>
                </div>
            </div>
            
            <div class="form-grid grid-2" style="margin-top: 25px; gap: 10px;">
                <button class="btn-success" onclick="saveOpeningBalance()" style="padding: 12px;">ğŸ’¾ Ø­ÙØ¸ Ø¢Ù…Ù†</button>
                <button class="btn-secondary" onclick="document.getElementById('openingBalanceModal').style.display='none'" style="padding: 12px;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        // ğŸ›¡ï¸ Strict Isolation Strategy for Opening Balances
        
        function openOpeningBalanceModal() {
            const dropdown = document.getElementById('activitiesDropdown');
            const selectedId = dropdown.value;
            if (!selectedId) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø´Ø§Ø· Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            // 1. Construct Isolated Key
            const storageKey = 'activity_' + selectedId + '_opening_balances';
            
            // 2. Read ONLY from isolated key
            let data = { cash: 0, bank: 0, inventory: 0 };
            try {
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    data = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Error reading opening balances:', e);
            }
            
            // 3. Populate Inputs
            document.getElementById('openingCash').value = data.cash || '';
            document.getElementById('openingBank').value = data.bank || '';
            document.getElementById('openingInventory').value = data.inventory || '';
            
            updateCalculatedCapital();
            
            // 4. Show Modal
            document.getElementById('openingBalanceModal').style.display = 'flex';
            
            // Attach listeners
            ['openingCash', 'openingBank', 'openingInventory'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.oninput = updateCalculatedCapital;
            });
        }

        function updateCalculatedCapital() {
            const cash = parseFloat(document.getElementById('openingCash').value) || 0;
            const bank = parseFloat(document.getElementById('openingBank').value) || 0;
            const inventory = parseFloat(document.getElementById('openingInventory').value) || 0;
            const total = cash + bank + inventory;
            document.getElementById('calculatedOpeningCapital').textContent = total.toFixed(2);
        }

        function saveOpeningBalance() {
            const dropdown = document.getElementById('activitiesDropdown');
            const selectedId = dropdown.value;
            if (!selectedId) return;

            const cash = parseFloat(document.getElementById('openingCash').value) || 0;
            const bank = parseFloat(document.getElementById('openingBank').value) || 0;
            const inventory = parseFloat(document.getElementById('openingInventory').value) || 0;
            const capital = cash + bank + inventory;

            // 1. Construct Isolated Key
            const storageKey = 'activity_' + selectedId + '_opening_balances';
            
            // 2. Prepare Data Object
            const data = {
                cash: cash,
                bank: bank,
                inventory: inventory,
                capital: capital,
                updatedAt: new Date().toISOString()
            };

            // 3. Safety Check Log
            console.log('ğŸ›¡ï¸ SAFETY CHECK: Saving to ISOLATED key:', storageKey);
            console.log('ğŸ›¡ï¸ SAFETY CHECK: NOT touching main activities array.');

            // 4. Write ONLY to isolated key
            try {
                localStorage.setItem(storageKey, JSON.stringify(data));
                alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¢Ù…Ù†.');
                document.getElementById('openingBalanceModal').style.display = 'none';
            } catch (e) {
                console.error('Error saving opening balances:', e);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸');
            }
        }
    </script>

</body>
</html>

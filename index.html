<!DOCTYPE html>
<html dir="rtl" lang="ar">
<!--
    ========================================
    ðŸŽ¯ Ø§Ù„Ø¯ÙŠÙˆØ§Ù† - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ v20.0
    ========================================
    
    ðŸ“‹ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±:
    
    ðŸ”´ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø£Ø¯Ø§Ø¡:
    âœ… 1. Ù†Ø¸Ø§Ù… ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± (SHA-256)
       - ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
       - Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
       
    âœ… 2. Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Loading Indicators)
       - Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
       - Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ«/Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
       - Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
       
    âœ… 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Error Handling)
       - Ù†Ø¸Ø§Ù… logError Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
       - Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ localStorage
       - Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ ÙˆØ§Ø¶Ø­Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
       - Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
    
    âœ… 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Input Validation)
       - ValidationHelper: Ù…Ø¬Ù…ÙˆØ¹Ø© Ø´Ø§Ù…Ù„Ø© Ù…Ù† Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚
       - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© ÙˆØ§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰/Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·ÙˆÙ„
       - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙˆØ¬Ø¨Ø© ÙˆØ§Ù„Ù†Ø·Ø§Ù‚Ø§Øª
       - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ
       - Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø£ÙƒÙˆØ§Ø¯
       - ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø£Ø­Ù…Ø± Ù„Ù„Ø®Ø·Ø£ØŒ Ø£Ø®Ø¶Ø± Ù„Ù„ØµØ­ÙŠØ­)
       - Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ ÙˆØ§Ø¶Ø­Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù…Ø¹ ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ©
    
    ðŸ”µ ØªØ­Ø³ÙŠÙ†Ø§Øª ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
    âœ… 5. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ
       - Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
       - ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¯ÙŠÙˆÙ† ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©
       - Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªÙŠ Ù†ÙØ°Øª
       - 4 Ø£Ù†ÙˆØ§Ø¹ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ù†Ø¬Ø§Ø­ØŒ ØªØ­Ø°ÙŠØ±ØŒ Ø®Ø·Ø£ØŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª)
       
    âœ… 6. Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
       - Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ø¥Ù„Ù‰ Ø³Ù„Ø© Ù…Ø­Ø°ÙˆÙØ§Øª
       - Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…
       - Ø­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
       - Ø¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø£ØµÙ†Ø§ÙØŒ Ø¹Ù…Ù„Ø§Ø¡ØŒ Ù…ÙˆØ±Ø¯ÙŠÙ†ØŒ Ø¥Ù„Ø®)
    
    âœ… 7. Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Professional Confirm Dialog)
       - Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ confirm() Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© Ø¨Ø­ÙˆØ§Ø±Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠØ©
       - ØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠ Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ù„ÙˆÙ†Ø©
       - 4 Ø£Ù†ÙˆØ§Ø¹ Ù…Ù† Ø§Ù„Ø­ÙˆØ§Ø±Ø§Øª (ØªØ­Ø°ÙŠØ±ØŒ Ø®Ø·Ø±ØŒ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŒ Ù†Ø¬Ø§Ø­)
       - Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­ÙˆØ§Ø± Ø£Ùˆ Ø¨Ø²Ø± Escape
       - Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ø¶Ø­Ø© Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Ù…Ø®ØµØµØ© Ù„ÙƒÙ„ Ø­Ø§Ù„Ø©
       - ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© Ø³Ù„Ø³Ø© (Animations)
    
    ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«: 23 Ø£ÙƒØªÙˆØ¨Ø± 2025
    ========================================
-->
<head>
    <title>Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ - Ø¯ÙŠÙˆØ§Ù†ÙŠ</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Preconnect Ù„Ù„Ø®Ø·ÙˆØ· Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Ø§Ù„ÙØ§ÙÙŠÙƒÙˆÙ† -->
    <link rel="icon" type="image/x-icon" href="logo/logosmall.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Reem+Kufi&display=swap" rel="stylesheet">
    
    <!-- Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© - Firebase Ø¨Ø¯ÙˆÙ† defer Ù„Ø£Ù†Ù‡ Ù…Ø·Ù„ÙˆØ¨ ÙÙˆØ±Ø§Ù‹ -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Ø¥Ø¶Ø§ÙØ© Firebase - Ø¨Ø¯ÙˆÙ† defer Ù„Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡ -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    


    <style>
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */
        .login-form.active {
            display: block !important;
        }
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border-top: 4px solid var(--primary-color);
            margin-bottom: 20px;
        }

        .stat-trend {
            font-size: 0.8em;
            margin-top: 5px;
            font-weight: bold;
        }

        .trend-up { 
            color: var(--success-color); 
        }

        .trend-down { 
            color: var(--accent-color); 
        }

        .analytics-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            .analytics-grid {
                grid-template-columns: 1fr;
            }
      
 
      
        }

        /* Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ */
        * {
            box-sizing: border-box;
        }
        
        html {
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
        }
        
        body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
            position: relative;
        }
        
        /* Ù…Ù†Ø¹ Ø£ÙŠ overflow Ø£ÙÙ‚ÙŠ */
        .section, .container, .form-grid, table, .invoice-items, .report-controls {
            max-width: 100%;
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table {
            table-layout: auto;
            width: 100%;
        }
        
        /* ØªØ­Ø³ÙŠÙ† touch scrolling */
        .invoice-items, .section table {
            -webkit-overflow-scrolling: touch;
        }

        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --bg-color: #ecf0f1;
            --text-color: #2c3e50;
            --font-size: 16px;
            --font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --sidebar-width: 280px;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --header-bg: linear-gradient(135deg, #2c5aa0 0%, #34495e 100%);
        }
    

/* ===== ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ===== */
.chart-card {
    background: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border-top: 4px solid var(--primary-color);
    margin-bottom: 25px;
    height: 320px;
    position: relative;
    transition: all 0.3s ease;
}

@media (max-width: 480px) {
    .advanced-stats {
        gap: 15px !important;
    }

    .advanced-stats .stat-card {
        padding: 16px 12px;
    }

    .advanced-stats .stat-number {
        font-size: 1.7em;
    }
    th {
        padding: 10px 12px;
    }
}

.chart-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.chart-card canvas {
    width: 100% !important;
    height: 240px !important;
    margin-top: 10px;
}

.chart-card h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
    font-size: 1em;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 10px;
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.analytics-card {
    background: white;
    padding: 10px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-bottom: 20px;
    min-height: 120px;
    border-right: 4px solid var(--success-color);
    transition: all 0.3s ease;
}

.analytics-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.analytics-card h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
    font-size: 1.1em;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 8px;
    font-weight: 700;
}

.analytics-card p {
    margin: 8px 0;
    font-size: 14px;
    line-height: 1.5;
    color: var(--text-color);
}

.analytics-card strong {
    color: var(--secondary-color);
    font-weight: 700;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø¨ÙƒØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ© */
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 25px;
    margin: 30px 0;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ© */
.stat-card {
    background: white;
    padding: 10px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border-top: 5px solid var(--primary-color);
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color), var(--success-color));
}

.stat-number {
    font-size: 1.8em;
    font-weight: bold;
    color: var(--primary-color);
    margin: 8px 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-label {
    color: var(--secondary-color);
    font-size: 0.9em;
    font-weight: 600;
    margin-bottom: 8px;
}

.stat-trend {
    font-size: 0.9em;
    margin-top: 8px;
    font-weight: bold;
    padding: 4px 12px;
    border-radius: 20px;
    display: inline-block;
}

.trend-up {
    background: rgba(39, 174, 96, 0.1);
    color: var(--success-color);
}

.trend-down {
    background: rgba(231, 76, 60, 0.1);
    color: var(--accent-color);
}

/* ØªØ®ØµÙŠØµ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */
.advanced-stats {
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)) !important;
    gap: 20px !important;
    margin-bottom: 30px;
}

.advanced-stats .stat-card {
    padding: 20px 15px;
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.advanced-stats .stat-number {
    font-size: 2.4em;
    margin: 10px 0;
}

.advanced-stats .stat-label {
    font-size: 1.1em;
    margin-bottom: 8px;
}

.advanced-stats .stat-trend {
    font-size: 0.95em;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© */
@media (max-width: 1024px) {
    .analytics-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .charts-container {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .chart-card {
        height: 350px;
        padding: 20px;
    }
    
    .chart-card canvas {
        height: 250px !important;
    }
    
    .stat-number {
        font-size: 1.8em;
    }
    
    .analytics-card {
        padding: 15px;
        min-height: 140px;
    }

    .advanced-stats .stat-card {
        aspect-ratio: auto;
        padding: 18px 15px;
    }

    .advanced-stats .stat-number {
        font-size: 2em;
    }

    .section {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 15px 10px;
    }

    .section table {
        min-width: 540px;
    }

    table {
        font-size: calc(var(--font-size) * 0.85);
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }

    th,
    td {
        padding: 8px 6px;
        font-size: 13px;
    }
    
    /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª */
    .container {
        width: 100%;
        max-width: 100vw;
        padding: 10px 5px;
        overflow-x: hidden;
    }
    
    /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        justify-content: center;
    }
    
    .action-buttons button {
        font-size: 12px;
        padding: 6px 10px;
        min-width: auto;
    }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„ØªØ¯Ø±Ø¬Ø§Øª */
.charts-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin: 30px 0;
}

/* ØªØ£Ø«ÙŠØ±Ø§Øª ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
.chart-loading {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
.chart-card h3, 
.analytics-card h3,
.stat-label {
    font-family: 'Tajawal', sans-serif;
    font-weight: 700;
}

/* ØªØ®ØµÙŠØµ Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
:root {
    --chart-color-1: #2c5aa0;
    --chart-color-2: #27ae60;
    --chart-color-3: #e74c3c;
    --chart-color-4: #f39c12;
    --chart-color-5: #9b59b6;
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ===== */
#global-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    display: none;
}

.loader-overlay {
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

.loader-content {
    background: white;
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    text-align: center;
    animation: fadeIn 0.3s ease;
}

.spinner {
    width: 60px;
    height: 60px;
    margin: 0 auto 20px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loader-message {
    color: var(--text-color);
    font-size: 1.1em;
    font-weight: 600;
    margin: 0;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}
/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ===== */

/* ===== Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ===== */
#notifications-container {
    position: fixed;
    top: 80px;
    left: 20px;
    z-index: 9999;
    max-width: 400px;
    pointer-events: none;
}

.notification {
    background: white;
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 12px;
    box-shadow: 0 6px 25px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.4s ease;
    pointer-events: all;
    cursor: pointer;
    transition: all 0.3s ease;
    border-right: 4px solid var(--primary-color);
}

.notification:hover {
    transform: translateX(-5px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
}

.notification.success {
    border-right-color: var(--success-color);
}

.notification.warning {
    border-right-color: #f39c12;
}

.notification.error {
    border-right-color: var(--accent-color);
}

.notification.info {
    border-right-color: var(--primary-color);
}

.notification-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: 700;
    font-size: 0.95em;
    margin-bottom: 4px;
    color: var(--text-color);
}

.notification-message {
    font-size: 0.85em;
    color: #666;
    line-height: 1.4;
}

.notification-close {
    font-size: 20px;
    color: #999;
    cursor: pointer;
    padding: 4px;
    flex-shrink: 0;
}

.notification-close:hover {
    color: var(--accent-color);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideOut {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(100px);
    }
}

.notification.removing {
    animation: slideOut 0.3s ease forwards;
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± */
.notification-bell {
    position: relative;
    cursor: pointer;
    padding: 8px 12px;
    font-size: 1.3em;
    transition: all 0.3s ease;
}

.notification-bell:hover {
    color: var(--primary-color);
    transform: scale(1.1);
}

.notification-badge {
    position: absolute;
    top: 4px;
    right: 4px;
    background: var(--accent-color);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ===== */

/* ===== Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Confirm Dialog) ===== */
.confirm-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 10000;
    backdrop-filter: blur(3px);
    animation: fadeIn 0.3s ease;
}

.confirm-overlay.active {
    display: flex;
    justify-content: center;
    align-items: center;
}

.confirm-dialog {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    max-width: 480px;
    width: 90%;
    overflow: hidden;
    animation: scaleIn 0.3s ease;
    font-family: var(--font-family);
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.confirm-header {
    padding: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    border-bottom: 2px solid #f0f0f0;
}

.confirm-icon {
    font-size: 48px;
    line-height: 1;
}

.confirm-header.warning .confirm-icon {
    color: #f39c12;
}

.confirm-header.danger .confirm-icon {
    color: #e74c3c;
}

.confirm-header.info .confirm-icon {
    color: var(--primary-color);
}

.confirm-header.success .confirm-icon {
    color: var(--success-color);
}

.confirm-title {
    font-size: 1.4em;
    font-weight: 700;
    color: var(--text-color);
}

.confirm-body {
    padding: 24px;
    font-size: 1.05em;
    line-height: 1.6;
    color: #555;
}

.confirm-footer {
    padding: 20px 24px;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: #f8f9fa;
    border-top: 1px solid #e0e0e0;
}

.confirm-footer button {
    padding: 12px 28px;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: var(--font-family);
}

.confirm-btn-cancel {
    background: #e0e0e0;
    color: #666;
}

.confirm-btn-cancel:hover {
    background: #d0d0d0;
    transform: translateY(-2px);
}

.confirm-btn-confirm {
    background: var(--primary-color);
    color: white;
}

.confirm-btn-confirm:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

.confirm-btn-confirm.danger {
    background: #e74c3c;
}

.confirm-btn-confirm.danger:hover {
    background: #c0392b;
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
}

.confirm-btn-confirm.success {
    background: var(--success-color);
}

.confirm-btn-confirm.success:hover {
    background: #229954;
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}

/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ===== */

/* ===== Ø£Ù†Ù…Ø§Ø· Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ===== */
#trash-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

#trash-modal.active {
    display: flex;
}

.trash-content {
    background: white;
    border-radius: 15px;
    padding: 30px;
    max-width: 900px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    animation: fadeIn 0.3s ease;
}

.trash-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #eee;
}

.trash-header h2 {
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 10px;
}

.trash-tabs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 8px;
    margin-bottom: 20px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 8px;
}

.trash-tab {
    padding: 10px 8px;
    background: white;
    border: none;
    cursor: pointer;
    font-size: 0.8em;
    color: #666;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    text-align: center;
    white-space: normal;
    word-wrap: break-word;
}

.trash-tab:hover {
    color: var(--primary-color);
    background: #f0f8ff;
    transform: translateY(-2px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.trash-tab.active {
    color: white;
    background: var(--primary-color);
    font-weight: bold;
    box-shadow: 0 3px 8px rgba(44, 120, 208, 0.3);
}

.trash-items {
    margin-top: 20px;
}

.trash-item {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.trash-item:hover {
    background: #f0f0f0;
    border-color: var(--primary-color);
}

.trash-item-info {
    flex: 1;
}

.trash-item-name {
    font-weight: bold;
    color: var(--text-color);
    margin-bottom: 5px;
}

.trash-item-meta {
    font-size: 0.85em;
    color: #666;
}

.trash-item-actions {
    display: flex;
    gap: 8px;
}

.trash-empty-state {
    text-align: center;
    padding: 40px;
    color: #999;
}

.trash-empty-state i {
    font-size: 4em;
    margin-bottom: 15px;
    opacity: 0.3;
}

.trash-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    gap: 8px;
    margin-bottom: 15px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 8px;
}

.trash-stat {
    text-align: center;
    padding: 8px 6px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.trash-stat:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.trash-stat-value {
    font-size: 1.6em;
    font-weight: bold;
    color: var(--primary-color);
}

.trash-stat-label {
    font-size: 0.75em;
    color: #666;
    margin-top: 2px;
    white-space: normal;
    word-wrap: break-word;
    line-height: 1.2;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width: 768px) {
    .trash-stats {
        grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
        gap: 6px;
        padding: 8px;
    }
    
    .trash-tabs {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    }
    
    .trash-stat {
        padding: 6px 4px;
    }
    
    .trash-stat-value {
        font-size: 1.2em;
    }
    
    .trash-stat-label {
        font-size: 0.65em;
    }
    
    .trash-tab {
        font-size: 0.7em;
        padding: 8px 6px;
    }
}
/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ===== */


    * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); font-size: var(--font-size); background: var(--bg-color); color: var(--text-color); direction: rtl; line-height: 1.6; min-height: 100vh; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(5px); }
        #login-box { background: white; padding: 40px; border-radius: var(--border-radius); box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 420px; text-align: center; animation: fadeIn 0.5s ease; }
        
        /* Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        .login-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            display: block;
            object-fit: contain;
            animation: scaleIn 0.6s ease;
        }
        
        #login-box h2 { color: var(--primary-color); margin-bottom: 25px; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: var(--border-radius); font-size: calc(var(--font-size) * 0.95); }
        #login-error { color: var(--accent-color); margin-bottom: 15px; display: none; font-weight: bold; }
        .login-role-selector button { width: 100%; margin-bottom: 10px; padding: 15px; font-size: 1.1em; }
        .login-form { display: none; }
        .back-to-roles { color: var(--primary-color); cursor: pointer; display: block; margin-top: 20px; font-weight: bold; }

        #activity-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(8px); }
        #activity-box { background: white; padding: 40px; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.25); width: 100%; max-width: 500px; text-align: center; animation: fadeIn 0.5s ease; }
        #activity-box h2 { color: var(--primary-color); margin-bottom: 25px; }
        #activity-list { max-height: 200px; overflow-y: auto; margin-bottom: 20px; }
        .activity-btn { width: 100%; margin-bottom: 10px; padding: 18px; font-size: 1.1em; }
        .app-container { display: flex; min-height: 100vh; }
        .container { flex: 1; margin-right: var(--sidebar-width); padding: 20px; transition: margin-right 0.3s ease; }
        .sidebar { width: var(--sidebar-width); background: var(--sidebar-bg); height: 100vh; position: fixed; right: 0; top: 0; box-shadow: var(--shadow); padding: 20px; overflow-y: auto; z-index: 100; }
        .sidebar-header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--primary-color); }
        .sidebar-header h1 { color: var(--sidebar-text); font-size: 1.5em; margin-bottom: 5px; }
        .sidebar-header .subtitle { color: #bdc3c7; font-size: 0.9em; }
        .sidebar-nav { display: flex; flex-direction: column; gap: 5px; }
        .sidebar-nav button { padding: 12px 15px; border: none; background: transparent; color: var(--sidebar-text); border-radius: var(--border-radius); cursor: pointer; font-size: calc(var(--font-size) * 0.9); font-weight: 500; transition: all 0.3s ease; text-align: right; border: 1px solid transparent; width: 100%; }
        .sidebar-nav button:hover { background: rgba(255, 255, 255, 0.1); transform: translateX(-3px); color: white; border-color: var(--primary-color); }
    .sidebar-nav button.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .user-section { margin-top: 25px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: var(--border-radius); border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; }
    /* Ø´Ø§Ø±Ø© Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
    .current-user { background: #2c3e50; color: #ecf0f1; padding: 12px; border-radius: var(--border-radius); font-weight: bold; font-size: 0.95em; line-height: 1.4; }
    .current-user .user-name { display: block; font-size: 1em; margin-bottom: 6px; }
    .current-user .user-description { display: block; font-size: 0.85em; opacity: 0.85; }
    /* Ø£Ù„ÙˆØ§Ù† Ù…Ø®ØµØµØ© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± */
    .current-user.role-admin { background: var(--success-color); color: #fff; }
    .current-user.role-manager { background: #2c78d0; color: #fff; }
    .current-user.role-user { background: #2980b9; color: #fff; }
        .header { display: flex; align-items: center; justify-content: center; margin-bottom: 30px; padding: 40px; background: var(--header-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); position: relative; color: white; }
        .header-logo { position: absolute; right: 30px; top: 50%; transform: translateY(-50%); width: 80px; height: 80px; object-fit: contain; border-radius: 8px; background: white; padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .header-content { text-align: center; flex: 1; }
        .header h1 { color: white; font-size: calc(var(--font-size) * 2); margin-bottom: 10px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .header .subtitle { color: rgba(255, 255, 255, 0.9); font-size: calc(var(--font-size) * 1.1); }
        .developer-credit { position: absolute; left: 20px; bottom: 20px; color: rgba(255, 255, 255, 0.8); font-size: calc(var(--font-size) * 0.8); font-style: italic; }
    .design-toggle { position: fixed; top: 20px; left: 20px; background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; font-size: 20px; box-shadow: var(--shadow); transition: all 0.3s ease; z-index: 101; }
    .design-toggle:hover { transform: scale(1.1); background: var(--secondary-color); }
        .control-panel { position: fixed; top: 20px; right: calc(var(--sidebar-width) + 20px); background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); z-index: 1000; max-width: 300px; display: none; }
        .control-panel.show { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .control-panel h3 { color: var(--primary-color); margin-bottom: 15px; text-align: center; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--secondary-color); }
        .color-picker { width: 100%; height: 40px; border: none; border-radius: 5px; cursor: pointer; }
        .font-size-control { width: 100%; }
        .section { display: none; background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 20px; min-height: 500px; }
        .section.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .section h2 { 
            color: var(--primary-color); 
            margin-bottom: 25px; 
            font-size: calc(var(--font-size) * 1.5); 
            border-bottom: 3px solid var(--primary-color); 
            padding-bottom: 10px; 
            display: flex; /* Use flexbox */
            justify-content: space-between; /* Space between title and card */
            align-items: center; /* Align items vertically */
        }

        .settings-grid { display: flex; flex-direction: column; gap: 25px; }
    .settings-card { background: #ffffff; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 25px; display: flex; flex-direction: column; gap: 20px; width: 100%; position: relative; overflow: hidden; }
    .settings-card::before { content: ''; position: absolute; top: 0; right: 0; left: 0; height: 4px; background: linear-gradient(90deg, var(--primary-color), var(--success-color)); }
        .settings-card h3 { margin-top: 0; }
        .settings-card .data-actions { margin: 0; }
        .settings-card .data-actions-grid { gap: 15px; }

        .user-selector-controls select,
        .activity-selector-controls select { width: 100%; max-width: 320px; }

        .title-stat-card {
            background-color: #fff;
            color: #1a3556;
            border: none;
            padding: 8px 18px 10px;
            border-radius: var(--border-radius);
            font-size: 0.9em;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .title-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        }

        .title-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px #FFD70099, 0 2px 8px rgba(0,0,0,0.08);
        }

        .title-stat-card .stat-mini-label {
            font-weight: normal;
            margin-left: 8px;
            color: #1a3556;
        }

        .title-stat-card .stat-mini-number {
            font-weight: 700;
            font-size: 1.2em;
        }

        .search-container { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .search-input { flex: 1; min-width: 200px; padding: 12px 15px; border: 2px solid #ddd; border-radius: var(--border-radius); font-size: calc(var(--font-size) * 0.95); transition: all 0.3s ease; font-family: var(--font-family); }
        .search-input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        
        /* Advanced Filters */
        .filters-container { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: var(--border-radius); 
            margin-bottom: 20px; 
            border: 2px solid #e0e0e0;
            display: none;
        }
        .filters-container.show { display: block; animation: slideIn 0.3s ease; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: calc(var(--font-size) * 0.9); color: #555; font-weight: 600; }
        .filter-input { 
            padding: 10px 12px; 
            border: 2px solid #ddd; 
            border-radius: var(--border-radius); 
            font-size: calc(var(--font-size) * 0.9);
            transition: all 0.3s ease;
            font-family: var(--font-family);
        }
        .filter-input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        .filter-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; }
        .toggle-filters-btn { 
            padding: 12px 24px; 
            background: #2196F3; 
            color: white; 
            border: none; 
            border-radius: var(--border-radius); 
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: var(--font-family);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .toggle-filters-btn:hover { 
            background: #1976D2; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Sortable Table Headers */
        .sortable { 
            cursor: pointer; 
            user-select: none; 
            position: relative;
            transition: all 0.3s ease;
        }
        .sortable.asc::after { content: 'â†‘'; opacity: 1; color: #4CAF50; position: absolute; left: 8px; font-size: 0.8em; }
        .sortable.desc::after { content: 'â†“'; opacity: 1; color: #f44336; position: absolute; left: 8px; font-size: 0.8em; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 25px; }
        .stat-card { 
            background: white; 
            padding: 25px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow); 
            border-top: 5px solid var(--primary-color); 
            text-align: center; 
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
        }
        .stat-card h3 { color: var(--secondary-color); margin-bottom: 15px; font-size: calc(var(--font-size) * 1.1); }
        .stat-number { 
            font-size: calc(var(--font-size) * 2.5); 
            font-weight: bold; 
            color: var(--primary-color); 
            margin: 15px 0; 
        }
        .stat-label { 
            color: var(--secondary-color); 
            font-size: calc(var(--font-size) * 1);
            font-weight: 600;
        }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: calc(var(--font-size) * 0.95); }
        th { background: var(--primary-color); color: white; padding: 15px; text-align: right; font-weight: 600; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: right; }
        tr:hover { background: #f8f9fa; }
    .form-grid { display: grid; gap: 20px; margin-bottom: 30px; }
    .grid-5 { grid-template-columns: repeat(5, 1fr); }
    .grid-users { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .account-info-grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); margin-top: 20px; }
    .account-info-card { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); display: flex; flex-direction: column; }
    .account-info-card h3 { color: var(--primary-color); margin-bottom: 15px; font-size: 1.1em; }
    .account-info-field { margin-bottom: 12px; font-size: 0.95em; }
    .account-info-field strong { color: var(--secondary-color); display: inline-block; min-width: 110px; }
    .account-info-actions { display: flex; gap: 10px; margin-top: auto; padding-top: 15px; flex-wrap: wrap; }
    .account-info-actions button { flex: 1 1 160px; background: #1b4f72; color: #ffffff; border: 1px solid #143b55; box-shadow: 0 2px 6px rgba(20, 59, 85, 0.2); }
    .account-info-actions button:hover { background: #163d59; color: #ffffff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(20, 59, 85, 0.3); }
    .data-actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    @media (min-width: 768px) {
        .data-actions-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        input, select, textarea { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: var(--border-radius); font-size: calc(var(--font-size) * 0.95); transition: all 0.3s ease; font-family: var(--font-family); }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        button { padding: 10px 15px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: calc(var(--font-size) * 0.95); font-weight: 600; transition: all 0.3s ease; font-family: var(--font-family); }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-primary:hover { background: #254a8a; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3); }
    .btn-add { background: #008976; color: white; }
    .btn-add:hover { background: #007460; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 137, 118, 0.25); }
    .btn-success { background: var(--success-color); color: white; }
    .btn-success:hover { background: #219653; transform: translateY(-2px); }
    .btn-success.code-generator-btn { background: #1b4f72; color: #ffffff; border: 1px solid #143b55; box-shadow: 0 2px 6px rgba(20, 59, 85, 0.2); }
    .btn-success.code-generator-btn:hover { background: #163d59; color: #ffffff; box-shadow: 0 4px 12px rgba(20, 59, 85, 0.3); }
        .btn-danger { background: var(--accent-color); color: white; }
        .btn-danger:hover { background: #c0392b; transform: translateY(-2px); }
    .btn-secondary { background: #008976; color: white; }
    .btn-secondary:hover { background: #007460; transform: translateY(-2px); }
        .btn-info { background: #1abc9c; color: white; }
        .btn-info:hover { background: #16a085; transform: translateY(-2px); }
        #settings .data-actions-grid button { background: #005189; color: #ffffff; border: 1px solid #003f68; box-shadow: 0 2px 6px rgba(0, 81, 137, 0.2); }
        #settings .data-actions-grid button:hover { background: #004373; color: #ffffff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 81, 137, 0.3); }
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­Ø°ÙŠØ±/Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (ØªØ¹Ø¯ÙŠÙ„/Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ) Ø¨Ù„ÙˆÙ† ÙƒÙ‡Ø±Ù…Ø§Ù†ÙŠ Ù…ØªÙ†Ø§Ø³Ù‚ */
    .btn-warning { background: #E6B980; color: #2c3e50; border: 1px solid #DDB07A; box-shadow: 0 2px 6px rgba(217, 154, 89, 0.12); }
    .btn-warning:hover { background: #D99A59; color: #1a1a1a; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(217, 154, 89, 0.22); }
    /* ØªØ®ØµÙŠØµ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± ÙˆØ§Ù„Ù†Øµ Ø§Ù„Ø£Ø¨ÙŠØ¶ */
    .btn-warning.edit-btn { background: #005189; color: #ffffff; border: 1px solid #003f68; box-shadow: 0 2px 6px rgba(0, 81, 137, 0.2); }
    .btn-warning.edit-btn:hover { background: #004373; color: #ffffff; box-shadow: 0 4px 12px rgba(0, 81, 137, 0.3); }
    /* ØªØ®ØµÙŠØµ Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± Ø§Ù„Ø¯Ø§ÙƒÙ† */
    .btn-warning.backup-btn { background: #1e8449; color: #ffffff; border: 1px solid #16653a; box-shadow: 0 2px 6px rgba(22, 101, 58, 0.18); }
    .btn-warning.backup-btn:hover { background: #16653a; color: #ffffff; box-shadow: 0 4px 12px rgba(22, 101, 58, 0.28); }
      .remaining-unpaid { 
    color: var(--accent-color); /* Ø£Ø­Ù…Ø± - Ø¹Ù„ÙŠÙ‡ Ù…Ø¨Ù„Øº */
    font-weight: bold; 
}
.remaining-paid { 
    color: var(--text-color); /* Ø£Ø³ÙˆØ¯/Ø¹Ø§Ø¯ÙŠ - Ø§Ù„Ø±ØµÙŠØ¯ ØµÙØ± */
    font-weight: normal; 
}
.remaining-credit { 
    color: var(--success-color); /* Ø£Ø®Ø¶Ø± - Ù„Ù‡ Ø±ØµÙŠØ¯ */
    font-weight: bold; 
}
        .report-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .report-controls select, .report-controls input[type="date"] { max-width: 200px; min-width: 150px; }
        .report-controls button { min-width: 150px; }
        .export-options { display: flex; gap: 10px; margin-top: 20px; }
        .report-summary { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: var(--border-radius); }
        .invoice-print { display: none; background: white; padding: 30px; direction: rtl; max-width: 800px; margin: 20px auto; }
        @media print { body * { visibility: hidden; } .invoice-print, .invoice-print * { visibility: visible; } .invoice-print { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; } .no-print { display: none !important; } }
        .invoice-header-print { display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #2c5aa0; }
        .invoice-details { margin: 20px 0; }
        .invoice-items-print table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 1.1em; }
        .invoice-items-print th { background: #e3f2fd; color: #2c5aa0; padding: 12px; text-align: right; font-size: 1.1em; }
        .invoice-items-print th:nth-child(1) { width: 50%; } /* Ø§Ù„ØµÙ†Ù */
        .invoice-items-print th:nth-child(2) { width:35%; text-align: center; } /* Ø§Ù„ÙƒÙ…ÙŠØ© */
        .invoice-items-print th:nth-child(3) { width: 35%; text-align: center; } /* Ø§Ù„Ø³Ø¹Ø± */
        .invoice-items-print th:nth-child(4) { width: 35%; text-align: left; } /* Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ */
        .invoice-items-print td { padding: 10px 12px; border-bottom: 1px solid #ddd; text-align: right; font-size: 1.05em; }
        .invoice-items-print td:nth-child(2) { text-align: center; } /* Ø§Ù„ÙƒÙ…ÙŠØ© */
        .invoice-items-print td:nth-child(3) { text-align: center; } /* Ø§Ù„Ø³Ø¹Ø± */
        .invoice-items-print td:nth-child(4) { text-align: left; direction: ltr; } /* Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ */
    .invoice-totals { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .invoice-totals > div { display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 8px; }
    .invoice-totals > div.total { font-weight: bold; font-size: 1.1em; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; }
    .invoice-totals > div span:last-child { min-width: 120px; text-align: left; direction: ltr; display: inline-block; }
    .invoice-totals input[type="number"] { width: 120px; flex: 0 0 120px; text-align: left; direction: ltr; }
    .invoice-totals-print { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .invoice-totals-print div { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .invoice-totals-print .total { font-weight: bold; font-size: 1.1em; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; }
        .code-generator-btn { padding: 10px 15px; font-size: calc(var(--font-size) * 0.9); width: auto; min-width: 120px; }
        .user-management { background: #f8f9fa; padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; }
        .user-card { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 15px; border-right: 4px solid var(--primary-color); }
    #settings .user-selector { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 20px; }
    #settings .user-selector-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px; }
    #settings .user-selector-controls select { flex: 1 1 220px; min-width: 200px; padding: 12px; border: 2px solid #ddd; border-radius: var(--border-radius); font-family: var(--font-family); }
    #settings .selected-user-info { display: none; gap: 12px; align-items: center; flex-wrap: nowrap; }
    #settings .selected-user-grid { display: flex; gap: 12px; flex-wrap: nowrap; overflow-x: auto; align-items: center; padding-bottom: 5px; }
    #settings .selected-user-field { flex: 0 0 170px; }
    #settings .selected-user-field.role-field { flex: 0 0 120px; }
    #settings .selected-user-field.phone-field { flex: 0 0 140px; }
    #settings .selected-user-field label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--secondary-color); }
    #settings .selected-user-field input { width: 100%; padding: 8px 10px; border: 2px solid #ddd; border-radius: var(--border-radius); background: #f5f7fb; font-family: var(--font-family); font-size: 0.9em; color: #2c3e50; }
    #settings .selected-user-actions { display: flex; gap: 10px; align-items: center; flex: 0 0 auto; margin-top: 22px; }
    #settings .selected-user-actions button { flex: 0 0 120px; max-width: 130px; padding: 8px 10px; }
    #settings .activity-selector { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 20px; }
    #settings .activity-selector-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px; }
    #settings .activity-selector-controls select { flex: 1 1 220px; min-width: 200px; padding: 12px; border: 2px solid #ddd; border-radius: var(--border-radius); font-family: var(--font-family); }
    #settings .selected-activity-info { display: none; gap: 12px; align-items: center; flex-wrap: nowrap; }
    #settings .selected-activity-field { flex: 0 0 220px; }
    #settings .selected-activity-field label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--secondary-color); }
    #settings .selected-activity-field input { width: 100%; padding: 8px 10px; border: 2px solid #ddd; border-radius: var(--border-radius); background: #f5f7fb; font-family: var(--font-family); font-size: 0.9em; color: #2c3e50; }
    #settings .selected-activity-actions { display: flex; gap: 10px; align-items: center; flex: 0 0 auto; margin-top: 30px; }
    #settings .selected-activity-actions button { flex: 0 0 120px; max-width: 130px; padding: 8px 10px; }
        .user-role { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; margin-right: 10px; }
    .role-admin { background: #e74c3c; color: white; }
    .role-manager { background: #2c78d0; color: white; }
        .role-user { background: #3498db; color: white; }
        .role-viewer { background: #95a5a6; color: white; }
        .user-status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 10px; }
        .status-active { background: #27ae60; }
        .status-inactive { background: #e74c3c; }
        .email-settings { background: #fff3cd; padding: 20px; border-radius: var(--border-radius); border-right: 4px solid #ffc107; margin-bottom: 20px; display: none; }
        @media (max-width: 1024px) { .sidebar { width: 250px; } .container { margin-right: 250px; } .control-panel { right: calc(250px + 20px); } }
        @media (max-width: 768px) { 
            * { max-width: 100vw; }
            body { flex-direction: column; overflow-x: hidden; width: 100%; } 
            .sidebar { position: fixed; width: 100%; height: 100vh; max-height: 100vh; overflow-y: auto; box-shadow: none; transform: translateX(100%); transition: transform 0.3s ease; padding: 15px; } 
            .sidebar.open { transform: translateX(0); } 
            .container { max-width: 100vw; width: 100%; margin-right: 0; padding: 10px 5px; overflow-x: hidden; box-sizing: border-box; } 
            .control-panel { right: 10px; } 
            .nav { flex-direction: column; } 
            .nav button { width: 100%; } 
            .form-grid { grid-template-columns: 1fr !important; gap: 10px; padding: 0; } 
            .form-grid input, .form-grid select, .form-grid textarea { width: 100%; max-width: 100%; box-sizing: border-box; }
            .control-panel { position: fixed; top: 0; right: 0; left: 0; bottom: 0; max-width: 100vw; z-index: 2000; overflow-y: auto; } 
            .design-toggle { position: fixed; top: 20px; left: 20px; z-index: 2001; } 
            .invoice-header { flex-direction: column; gap: 10px; align-items: stretch; } 
            .report-controls { flex-direction: column; align-items: stretch; gap: 8px; } 
            .report-controls select, .report-controls input, .report-controls button { width: 100%; max-width: 100%; box-sizing: border-box; } 
            .invoice-header-print { flex-direction: column; gap: 10px; } 
            .search-container { flex-direction: column; gap: 10px; } 
            .search-container input { width: 100%; }
            .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr !important; } 
            .section { padding: 15px 10px; overflow-x: auto; max-width: 100vw; } 
            .section > * { max-width: 100%; }
            table { font-size: 12px; display: block; overflow-x: auto; width: 100%; } 
            th, td { padding: 6px 4px; white-space: nowrap; font-size: 11px; } 
            .invoice-items { overflow-x: auto; -webkit-overflow-scrolling: touch; max-width: 100%; } 
            .invoice-items table { min-width: 500px; display: table; }
            .invoice-totals { padding: 10px; font-size: 14px; }
            .action-buttons { flex-wrap: wrap; gap: 5px; justify-content: center; }
            .action-buttons button { min-width: 70px; padding: 6px 10px; font-size: 12px; }
            button, .btn { padding: 8px 12px; font-size: 13px; }
            
            /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */
            .advanced-stats { 
                display: flex !important; 
                flex-direction: column !important; 
                gap: 15px !important; 
            }
            .advanced-stats .stat-card { 
                width: 100% !important; 
                aspect-ratio: auto !important;
                padding: 20px !important; 
                min-height: 100px;
            }
            .advanced-stats .stat-number { font-size: 2em !important; }
            .advanced-stats .stat-label { font-size: 1em !important; }
            
            /* Ø¥ØµÙ„Ø§Ø­ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
            .charts-container {
                display: flex !important;
                flex-direction: column !important;
                gap: 20px !important;
            }
            .chart-card {
                width: 100% !important;
                height: auto !important;
                min-height: 300px;
                padding: 15px !important;
            }
            .chart-card canvas {
                height: 250px !important;
                max-height: 250px !important;
            }
        }
    .sidebar-toggle { display: none; position: fixed; top: 20px; right: 20px; background: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 10px 15px; cursor: pointer; z-index: 102; }
        @media (max-width: 768px) { .sidebar-toggle { display: block; } 


    }
@media (max-width: 640px) {
    .section {
        overflow-x: visible;
    }

    .section table {
        min-width: 100%;
        display: block;
        border: none;
        background: transparent;
    }

    .section thead {
        display: none;
    }

    .section tbody {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .section tbody tr {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        background: #ffffff;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 14px;
        border: 1px solid #e5e9f2;
    }

    .section tbody tr:hover {
        background: #f8f9fa;
    }

    .section tbody td {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
        border: none;
        text-align: right;
    }

    .section tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--secondary-color);
        flex-shrink: 0;
        min-width: 50px;
        font-size: 0.85em;
    }
    
    /* Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø§Ø³Ù… */
    .section tbody td:nth-child(1),
    .section tbody td:nth-child(2) {
        grid-column: span 1;
    }
    
    /* Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ */
    .section tbody td:nth-child(3),
    .section tbody td:nth-child(4) {
        grid-column: span 1;
    }
    
    /* Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
    .section tbody td:nth-child(5) {
        grid-column: 1;
    }
    
    .section tbody td:last-child {
        grid-column: 2;
        justify-content: flex-start;
        gap: 6px;
        flex-wrap: nowrap;
        flex-direction: row;
    }

    .section tbody td button,
    .section tbody td .btn {
        flex: 0 0 auto;
        min-width: 65px;
        padding: 6px 12px;
        font-size: 11px;
        white-space: nowrap;
    }
}






        /* === START: CSS for new Returns section === */
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

      .btn-whatsapp {
    background-color: #25D366; /* Ù„ÙˆÙ† ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø£Ø®Ø¶Ø± */
    color: white;
}
.btn-whatsapp:hover {
    background-color: #128C7E; /* Ù„ÙˆÙ† Ø£ØºÙ…Ù‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ£Ø´ÙŠØ± */
    transform: translateY(-2px);
}

        .email-btn {
            background-color: #221658;
            color: #ffffff;
            border: 1px solid #1a1246;
            box-shadow: 0 2px 6px rgba(34, 22, 88, 0.25);
        }

        .email-btn:hover {
            background-color: #1b124e;
            color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 22, 88, 0.35);
        }

      
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--secondary-color);
            position: relative;
            bottom: -2px;
        }
        .tab-button.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .return-invoice-details {
            background-color: #f8f9fa;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        .return-invoice-details p { margin-bottom: 5px; }
        .return-item-qty-input { width: 80px !important; padding: 8px !important; text-align: center;}
        /* === END: CSS for new Returns section === */

        .users-settings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-settings-table th,
        .users-settings-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            text-align: right;
        }

        .users-settings-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .users-settings-table tr:hover {
            background: #f8f9fa;
        }

        .activities-management table td:last-child {
            white-space: nowrap !important;
            min-width: 120px !important;
        }

        .activities-management .btn-danger, .activities-management .btn-warning {
            margin: 2px;
            padding: 8px 12px !important;
            font-size: 0.9em !important;
        }

        @media (max-width: 768px) {
            .activities-management table td:last-child {
                min-width: 100px !important;
            }
            
            .activities-management .btn-danger, .activities-management .btn-warning {
                padding: 6px 10px !important;
                font-size: 0.85em !important;
            }
        }



        @media (max-width: 768px) {
            .users-settings-table {
                font-size: 0.9em;
            }
            
            .users-settings-table th,
            .users-settings-table td {
                padding: 8px 10px;
            }
            
            .users-settings-table td:last-child {
                min-width: 100px;
            }
        }

        .report-total-row { background-color: var(--primary-color) !important; color: white !important; font-weight: bold !important; font-size: 1.1em !important; }
        .report-total-row td { padding: 15px !important; border-bottom: 2px solid var(--secondary-color) !important; }
   
        .users-settings-table td:last-child,
        .activities-management table td:last-child {
            white-space: nowrap !important;
            min-width: 120px !important;
            text-align: left !important;
        }

        .users-settings-table .btn-danger {
            margin: 2px;
            padding: 8px 12px !important;
        }

        /* === START: CSS for new Salaries section === */
        #salaries .form-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }

        .salary-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: var(--border-radius);
            border-left: 5px solid var(--primary-color);
        }

        .salary-card h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .salary-summary {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            font-size: 1.05em;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item span:first-child {
            font-weight: 600;
            color: var(--secondary-color);
        }

        .summary-item span:last-child {
            font-weight: bold;
        }

        .summary-total {
            font-size: 1.3em;
            color: var(--primary-color);
            border-top: 2px solid var(--primary-color);
            margin-top: 10px;
            padding-top: 15px;
        }
        
        .gosi-deduction {
            color: var(--accent-color);
        }

        .net-salary {
            color: var(--success-color);
        }

        .salary-actions {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        /* === END: CSS for new Salaries section === */

        @media (max-width: 768px) {
            .users-settings-table td:last-child,
            .activities-management table td:last-child {
                min-width: 100px !important;
            }
            
            .users-settings-table .btn-danger {
                padding: 6px 10px !important;
                font-size: 0.85em !important;
            }
        }
        #sales td.actions-cell {
            text-align: center !important;
            min-width: 240px !important;
        }

        #sales td.actions-cell .action-buttons {
            justify-content: center;
            flex-wrap: wrap;
        }

        #sales td.actions-cell .action-buttons button {
            flex: 1 1 110px;
            margin: 2px !important;
            padding: 8px 10px !important;
            font-size: 0.85em !important;
        }

/* === ØªÙ†Ø³ÙŠÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ === */
.action-buttons {
    display: flex; /* ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¯Ø§Ø®Ù„Ù‡ Ù…Ø±Ù†Ø© ÙˆÙ…ØªØ¬Ø§ÙˆØ±Ø© */
    gap: 10px;      /* ÙŠØ¶ÙŠÙ Ù…Ø³Ø§ÙØ© 5 Ø¨ÙƒØ³Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    min-width: 80px; /* ÙŠØ¶Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
}

.action-buttons button {
    flex: 1;       /* ÙŠØ¬Ø¹Ù„ ÙƒÙ„ Ø²Ø± ÙŠØ£Ø®Ø° Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ù… Ù„ÙŠÙ…Ù„Ø£ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© */
    padding: 6px 8px; /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„Ø²Ø± Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø­Ø¬Ù… */
    font-size: 0.9em; /* ØªØµØºÙŠØ± Ø·ÙÙŠÙ Ù„Ø­Ø¬Ù… Ø§Ù„Ø®Ø· */
}

/* Ø¥ØµÙ„Ø§Ø­ Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ´Ø§Ù…Ù„ Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width: 768px) {

    /* 1. Ø¥Ø¬Ø¨Ø§Ø± Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¸Ù‡ÙˆØ± */
    .sidebar-toggle {
        display: block !important;
    }

    /* 2. Ø¥ØµÙ„Ø§Ø­ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
    #items td .action-buttons,
    #customers td .action-buttons,
    #suppliers td .action-buttons,
    #purchases td .action-buttons,
    #sales td .action-buttons,
    #returns td .action-buttons,
    #expenses td .action-buttons,
    #revenues td .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    /* Ø£ÙƒÙˆØ§Ø¯ Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¬Ø§ÙˆØ¨ */
    body { flex-direction: column; }
    .sidebar { position: fixed; width: 100%; height: auto; box-shadow: none; transform: translateX(100%); transition: transform 0.3s ease; z-index: 2000; }
    .sidebar.open { transform: translateX(0); }
    .container { max-width: 100%; margin-right: 0; padding: 10px; }
    .form-grid, .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
    .search-container { flex-direction: column; }

    .form-grid button {
        font-size: 0.9em;
        padding: 10px;
    }
    
    .search-input {
        font-size: 0.9em;
        padding: 10px;
    }
    
    /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
    .charts-container {
        overflow-x: auto;
        padding-bottom: 10px;
    }
    
    .chart-card {
        min-width: 300px;
        flex-shrink: 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #items table {
        display: block;
        overflow-x: auto;
    }

    #items thead {
        display: none;
    }

    #items tbody {
        display: block;
    }

    #items tr {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-areas:
            "code name stock"
            "cost price price"
            "actions actions actions";
        row-gap: 8px;
        column-gap: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #items td {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 6px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
    }

    #items td::before {
        content: attr(data-label) " :";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
    }

    #items td[data-label="Ø§Ù„ÙƒÙˆØ¯"] { grid-area: code; }
    #items td[data-label="Ø§Ù„Ø§Ø³Ù…"] { grid-area: name; }
    #items td[data-label="Ø§Ù„Ø±ØµÙŠØ¯"] { grid-area: stock; }

    #items td[data-label="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡"] { grid-area: cost; }
    #items td[data-label="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹"] { grid-area: price; }

    #items td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        margin-top: 6px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #items td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #items td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        gap: 12px;
        width: 100%;
    }

    #items td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] button {
        flex: 1;
        font-size: 0.95em;
        padding: 11px 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #customers table {
        display: block;
        overflow-x: auto;
    }

    #customers thead {
        display: none;
    }

    #customers tbody {
        display: block;
    }

    #customers tr {
        display: grid;
        grid-template-columns: minmax(110px, auto) 1fr;
        grid-template-areas:
            "code name"
            "phone email"
            "address address"
            "actions actions";
        column-gap: 10px;
        row-gap: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #customers td {
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        gap: 6px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
    }

    #customers td::before {
        content: attr(data-label) " :";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
    }

    #customers td[data-label="Ø§Ù„ÙƒÙˆØ¯"] { grid-area: code; }
    #customers td[data-label="Ø§Ù„Ø§Ø³Ù…"] { grid-area: name; }
    #customers td[data-label="Ø§Ù„Ù‡Ø§ØªÙ"] { grid-area: phone; }
    #customers td[data-label="Ø§Ù„Ø¨Ø±ÙŠØ¯"] { grid-area: email; }
    #customers td[data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] {
        grid-area: address;
        word-break: break-word;
        margin-top: 6px;
    }

    #customers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        margin-top: 8px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #customers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #customers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    #customers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] button {
        width: 100%;
        font-size: 0.9em;
        padding: 9px 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #suppliers table {
        display: block;
        overflow-x: auto;
    }

    #suppliers thead {
        display: none;
    }

    #suppliers tbody {
        display: block;
    }

    #suppliers tr {
        display: grid;
        grid-template-columns: minmax(110px, auto) 1fr;
        grid-template-areas:
            "code name"
            "phone email"
            "address address"
            "actions actions";
        column-gap: 10px;
        row-gap: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #suppliers td {
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        gap: 6px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
    }

    #suppliers td::before {
        content: attr(data-label) " :";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
    }

    #suppliers td[data-label="Ø§Ù„ÙƒÙˆØ¯"] { grid-area: code; }
    #suppliers td[data-label="Ø§Ù„Ø§Ø³Ù…"] { grid-area: name; }
    #suppliers td[data-label="Ø§Ù„Ù‡Ø§ØªÙ"] { grid-area: phone; }
    #suppliers td[data-label="Ø§Ù„Ø¨Ø±ÙŠØ¯"] { grid-area: email; }
    #suppliers td[data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] {
        grid-area: address;
        word-break: break-word;
        margin-top: 6px;
    }

    #suppliers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        margin-top: 8px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #suppliers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #suppliers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    #suppliers td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] button {
        width: 100%;
        font-size: 0.9em;
        padding: 9px 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #purchases table {
        display: block;
        overflow-x: auto;
    }

    #purchases thead {
        display: none;
    }

    #purchases tbody {
        display: block;
    }

    #purchases tr {
        display: grid;
        grid-template-columns: max-content max-content minmax(0, 1fr) minmax(0, 1fr);
        grid-template-areas:
            "number date supplier supplier"
            "quantity total paid paid"
            "remaining remaining remaining remaining"
            "actions actions actions actions";
        column-gap: 2px;
        row-gap: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #purchases td {
        display: flex;
        align-items: baseline;
        justify-content: flex-start;
        gap: 4px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
        min-width: 0;
        direction: rtl;
    }

    #purchases td::before {
        content: attr(data-label) ":";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
        background: transparent;
        flex-shrink: 0;
        display: inline-block;
    }
    #purchases td[data-label="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©"] {
        grid-area: number;
        white-space: nowrap;
    }
    #purchases td[data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®"] {
        grid-area: date;
        white-space: nowrap;
        margin-inline-start: 12px;
    }
    #purchases td[data-label="Ø§Ù„Ù…ÙˆØ±Ø¯"] {
        grid-area: supplier;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #purchases td[data-label="Ø§Ù„ÙƒÙ…ÙŠØ©"] {
        grid-area: quantity;
        white-space: nowrap;
    }
    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"] {
        grid-area: total;
        white-space: nowrap;
        margin-inline-end: 12px;
    }
    #purchases td[data-label="Ø§Ù„Ù…Ø¯ÙÙˆØ¹"] {
        grid-area: paid;
        white-space: nowrap;
        margin-inline-end: 12px;
    }
    #purchases td[data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ"] {
        grid-area: remaining;
        font-weight: 600;
        white-space: nowrap;
        justify-content: flex-start;
        padding-top: 6px;
        border-top: 1px solid #eee;
    }

    #purchases td[data-label="Ø§Ù„Ù…ÙˆØ±Ø¯"] {
        justify-content: flex-start;
        direction: rtl;
        text-align: right;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        margin-top: 6px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
    }

    #purchases td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons button {
        width: 100%;
        font-size: 0.85em;
        padding: 8px 0;
    }

    /* ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    #sales table {
        display: block;
        overflow-x: auto;
    }

    #sales thead {
        display: none;
    }

    #sales tbody {
        display: block;
    }

    #sales tr {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-areas:
            "number number date"
            "customer customer quantity"
            "total paid remaining"
            "actions actions actions";
        column-gap: 8px;
        row-gap: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #sales td {
        display: flex;
        align-items: baseline;
        justify-content: flex-start;
        gap: 4px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
        min-width: 0;
        direction: rtl;
    }

    #sales td::before {
        content: attr(data-label) ":";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
        background: transparent;
        flex-shrink: 0;
        display: inline-block;
    }

    #sales td[data-label="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©"] {
        grid-area: number;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®"] {
        grid-area: date;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„"] {
        grid-area: customer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #sales td[data-label="Ø§Ù„ÙƒÙ…ÙŠØ©"] {
        grid-area: quantity;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"] {
        grid-area: total;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„Ù…Ø¯ÙÙˆØ¹"] {
        grid-area: paid;
        white-space: nowrap;
    }

    #sales td[data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ"] {
        grid-area: remaining;
        font-weight: 600;
        white-space: nowrap;
        justify-content: flex-start;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] {
        grid-area: actions;
        display: block;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before {
        display: none;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
    }

    #sales td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"] .action-buttons button {
        width: 100%;
        font-size: 0.85em;
        padding: 8px 0;
    }

}

@media (max-width: 480px) {
    /* Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ */
    * { font-size: 14px; }
    
    .analytics-card {
        min-width: 100%;
        margin: 0;
    }
    
    .chart-card {
        min-width: 100%;
        padding: 10px;
    }
    
    .container { padding: 5px 2px; }
    
    .section { padding: 10px 5px; }
    
    table { font-size: 10px; }
    
    th, td { padding: 4px 2px; font-size: 10px; }
    
    .form-grid input, .form-grid select, .form-grid textarea { 
        font-size: 14px;
        padding: 6px 8px;
    }
    
    .action-buttons button { 
        font-size: 11px;
        padding: 5px 8px;
        min-width: 60px;
    }
    
    .btn { 
        font-size: 12px;
        padding: 6px 10px;
    }
    
    h2 { font-size: 1.3em; }
    h3 { font-size: 1.1em; }
    
    .sidebar { font-size: 14px; }
    
    .nav button { font-size: 13px; padding: 8px; }
    
    .invoice-items table { min-width: 400px; }
    
    .user-section button {
        font-size: 0.95em;
        padding: 12px 15px;
        margin: 5px 0;
        min-height: 44px;
    }
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ===== */

/* Ø­Ù‚Ù„ Ø¨Ù‡ Ø®Ø·Ø£ */
input.input-error,
select.input-error,
textarea.input-error {
    border: 2px solid #e74c3c !important;
    background-color: #ffebee !important;
    animation: shake 0.5s ease;
}

/* Ø­Ù‚Ù„ ØµØ­ÙŠØ­ */
input.input-success,
select.input-success,
textarea.input-success {
    border: 2px solid #27ae60 !important;
    background-color: #f1f8f4 !important;
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ */
input.input-error::after,
input.input-success::after {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
}

input.input-error::after {
    content: 'âŒ';
}

input.input-success::after {
    content: 'âœ…';
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®Ø§Ø·Ø¦Ø© */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø£Ø³ÙÙ„ Ø§Ù„Ø­Ù‚Ù„ */
.field-error-message {
    color: #e74c3c;
    font-size: 0.85em;
    margin-top: 4px;
    display: block;
    animation: fadeIn 0.3s ease;
}

/* Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø£Ø³ÙÙ„ Ø§Ù„Ø­Ù‚Ù„ */
.field-success-message {
    color: #27ae60;
    font-size: 0.85em;
    margin-top: 4px;
    display: block;
    animation: fadeIn 0.3s ease;
}

/* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² */
input.input-error:focus,
select.input-error:focus,
textarea.input-error:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
}

input.input-success:focus,
select.input-success:focus,
textarea.input-success:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
}

/* ===== Ù†Ù‡Ø§ÙŠØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ===== */


 </style>


</head>
<body>
    <div id="login-overlay">
        <div id="login-box">
            <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ -->
            <img src="https://res.cloudinary.com/dgjcr2bgq/image/upload/v1762349658/logo_vlldbc.png" 
     alt="Ø´Ø¹Ø§Ø± Ù†Ø¸Ø§Ù… Ø¯ÙŠÙˆØ§Ù†ÙŠ" class="login-logo" id="loginLogo">
            
            <h2>Ø¯ÙŠÙˆØ§Ù†ÙŠ<br><span style="font-size: 0.8em; font-weight: normal; color: #1e3a5f;">Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù…ØªÙƒØ§Ù…Ù„</span></h2>
           <input type="email" id="loginEmail" class="login-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" 
       onkeypress="if(event.key==='Enter')handleLogin()" autocomplete="off"> 

<input type="password" id="loginPassword" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" 
       onkeypress="if(event.key==='Enter')handleLogin()" autocomplete="new-password">
            <button class="btn-primary" onclick="handleLogin()" style="width: 100%;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            <a class="back-to-roles" onclick="openForgotPasswordModal()">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a>
            <p id="login-error">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„.</p>
        </div>
    </div>
    
    <div id="activity-overlay" style="display: none;">
        <div id="activity-box">
            <h2>Ø§Ø®ØªØ± Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ù†Ø´Ø§Ø·Ø§Ù‹ ØªØ¬Ø§Ø±ÙŠØ§Ù‹</h2>
            <div id="activity-list"></div>
            <hr style="margin: 20px 0;">
            <h3>Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ù†Ø´Ø§Ø·Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹</h3>
            <input type="text" id="newActivityName" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ø§Ù„: Ø¨ÙŠØ¹ Ù„Ø­Ø§ÙØ§Øª Ø§Ù„Ø£Ø·ÙØ§Ù„)">
            <button class="btn-success" onclick="addNewActivity()" style="width: 100%;">+ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù†Ø´Ø§Ø·</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div id="user-edit-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 10001; backdrop-filter: blur(5px);">
        <div id="user-edit-box" style="background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 480px; text-align: center;">
            <h2 style="color: var(--primary-color); margin-bottom: 20px;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
            <input type="text" id="editUserName" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="email" id="editUserEmail" class="login-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="tel" id="editUserPhone" class="login-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
            <input type="password" id="editUserPassword" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <select id="editUserRole" class="login-input">
                <option value="admin">Ù…Ø¯ÙŠØ±</option>
                <option value="manager">Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·</option>
                <option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option>
            </select>
            <select id="editUserActivity" class="login-input" style="display: none;">
                <option value="">-- ØªØ¹ÙŠÙŠÙ† Ù„Ù†Ø´Ø§Ø· --</option>
            </select>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn-success" onclick="saveEditedUser()" style="flex:1;">Ø­ÙØ¸</button>
                <button class="btn-secondary" onclick="closeEditUserModal()" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„) -->
    <div id="change-password-overlay" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10002; backdrop-filter: blur(5px);">
        <div style="background:white; padding: 24px; border-radius: var(--border-radius); width: 100%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <h2 style="margin-top:0; color: var(--primary-color);">ðŸ”’ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
            <input type="password" id="cp-old" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
            <input type="password" id="cp-new" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
            <input type="password" id="cp-confirm" class="login-input" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-success" onclick="submitPasswordChange()" style="flex:1;">Ø­ÙØ¸</button>
                <button class="btn-secondary" onclick="closeChangePasswordModal()" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø·) -->
    <div id="forgot-password-overlay" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10002; backdrop-filter: blur(5px);">
        <div style="background:white; padding: 24px; border-radius: var(--border-radius); width: 100%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align:center;">
            <h2 style="margin-top:0; color: var(--primary-color);">ðŸ“§ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
            <p style="margin: 0 0 10px;">Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ³Ù†Ø±Ø³Ù„ Ù„Ùƒ Ø±Ø§Ø¨Ø·Ø§Ù‹ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</p>
            <input type="email" id="fp-email" class="login-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-success" onclick="requestPasswordReset()" style="flex:1;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                <button class="btn-secondary" onclick="closeForgotPasswordModal()" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· -->
    <div id="reset-password-overlay" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10003; backdrop-filter: blur(5px);">
        <div style="background:white; padding: 24px; border-radius: var(--border-radius); width: 100%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align:center;">
            <h2 style="margin-top:0; color: var(--primary-color);">ðŸ” ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <input type="password" id="rp-new" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
            <input type="password" id="rp-confirm" class="login-input" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-success" onclick="submitTokenPasswordReset()" style="flex:1;">Ø­ÙØ¸</button>
                <button class="btn-secondary" onclick="closeResetPasswordModal()" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div class="app-container" style="display: none;">
        <button class="sidebar-toggle" onclick="toggleSidebar()">â˜° Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
                <img src="https://res.cloudinary.com/dgjcr2bgq/image/upload/v1762349658/logo_vlldbc.png" 
     alt="Ø´Ø¹Ø§Ø± Ø¯ÙŠÙˆØ§Ù†ÙŠ" class="header-logo" id="sidebarLogo" 
     style="width: 100px; height: 100px; margin: 0 auto 15px; position: static; transform: none; border-radius: 8px; background: white; padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
            </div>
            
            <div class="sidebar-nav" id="sidebarNav">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>

            <div class="user-section">
                <div class="current-user" id="currentUserDisplay"></div>
                <button class="btn-secondary" onclick="showSection('account-info')" style="width: 100%; margin-top: 10px;">ðŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                <button class="btn-danger" onclick="logout()" style="width: 100%; margin-top: 10px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <button class="design-toggle" onclick="toggleControlPanel()">ðŸŽ¨</button>

        <div class="control-panel" id="controlPanel">
            <h3>ðŸŽ¨ ØªØ®ØµÙŠØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</h3>
            
            <div class="control-group">
                <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø·:</label>
                <select id="fontFamilySelect" onchange="updateFontFamily(this.value)">
                    <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                    <option value="'Tajawal', sans-serif">Tajawal</option>
                    <option value="'Amiri', serif">Amiri</option>
                    <option value="'El Messiri', sans-serif">El Messiri</option>
                    <option value="'Reem Kufi', sans-serif">Reem Kufi</option>
                    <option value="'Arial', sans-serif">Arial</option>
                    <option value="'Helvetica', sans-serif">Helvetica</option>
                </select>
            </div>

            <div class="control-group">
                <label>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·:</label>
                <input type="range" class="font-size-control" min="12" max="20" value="16" onchange="updateFontSize(this.value)">
                <span id="font-size-value">16px</span>
            </div>

            <div class="control-group">
                <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:</label>
                <input type="color" class="color-picker" value="#2c5aa0" onchange="updateColor('--primary-color', this.value)">
            </div>

            <div class="control-group">
                <label>Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©:</label>
                <input type="color" class="color-picker" value="#ecf0f1" onchange="updateColor('--bg-color', this.value)">
            </div>

            <div class="control-group">
                <label>Ù„ÙˆÙ† Ø§Ù„Ù†Øµ:</label>
                <input type="color" class="color-picker" value="#2c3e50" onchange="updateColor('--text-color', this.value)">
            </div>

            <button onclick="resetDesign()" class="btn-primary" style="width: 100%; margin-top: 10px;">ðŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button onclick="toggleControlPanel()" class="btn-danger" style="width: 100%; margin-top: 10px;">âŒ Ø¥ØºÙ„Ø§Ù‚</button>
        </div>

<div class="container">
    <div class="header">
        <div class="header-content">
            <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· ÙÙŠ Ø§Ù„ÙˆØ³Ø· -->
            <img src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·" class="activity-header-logo" id="activityHeaderLogo" style="display: none; width: 80px; height: 80px; margin: 0 auto 10px; object-fit: contain; border-radius: 8px;">
            
            <h1 id="activityHeaderTitle">Ø¯ÙŠÙˆØ§Ù†ÙŠ</h1>
            <div class="subtitle" id="activityHeaderSubtitle">Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù…ØªÙƒØ§Ù…Ù„</div>
        </div>
        
        <div class="developer-credit">Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ±: ØµØ§Ù„Ø­ Ø§Ù„ØµÙ…Ù„Ø©</div>
    </div>

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
    <div id="notifications-container"></div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª -->
    <div id="trash-modal">
        <div class="trash-content">
            <div class="trash-header">
                <h2>ðŸ—‘ï¸ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</h2>
                <button class="btn-secondary" onclick="closeTrashModal()">âœ– Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            
            <p style="text-align: center; color: #666; font-size: 0.95em; margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 8px;">
                ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ù„Ù…Ø¯Ø© 30 ÙŠÙˆÙ…Ø§Ù‹
            </p>
            
            <div class="trash-stats">
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-items">0</div>
                    <div class="trash-stat-label">Ø£ØµÙ†Ø§Ù</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-customers">0</div>
                    <div class="trash-stat-label">Ø¹Ù…Ù„Ø§Ø¡</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-suppliers">0</div>
                    <div class="trash-stat-label">Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-purchases">0</div>
                    <div class="trash-stat-label">Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-sales">0</div>
                    <div class="trash-stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-expenses">0</div>
                    <div class="trash-stat-label">Ù…ØµØ±ÙˆÙØ§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-revenues">0</div>
                    <div class="trash-stat-label">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-salesReturns">0</div>
                    <div class="trash-stat-label">Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-purchaseReturns">0</div>
                    <div class="trash-stat-label">Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-total">0</div>
                    <div class="trash-stat-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                </div>
            </div>

            <div class="trash-tabs">
                <button class="trash-tab active" onclick="renderTrashItems('items')">ðŸ“¦ Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
                <button class="trash-tab" onclick="renderTrashItems('customers')">ðŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
                <button class="trash-tab" onclick="renderTrashItems('suppliers')">ðŸ­ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</button>
                <button class="trash-tab" onclick="renderTrashItems('purchases')">ðŸ“¥ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('sales')">ðŸ“¤ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('expenses')">ðŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('revenues')">ðŸ’° Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('salesReturns')">â†©ï¸ Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª</button>
                <button class="trash-tab" onclick="renderTrashItems('purchaseReturns')">â†ªï¸ Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª</button>
            </div>

            <div id="trash-items-container" class="trash-items"></div>
        </div>
    </div>

    <div id="home" class="section active">
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</h2>
        <p>Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù…Ù„ÙŠØ§ØªÙƒ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©</p>
       <div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
        <div class="stat-number" id="totalStockQuantity">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
        <div class="stat-number" id="stockValue">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
        <div class="stat-number" id="totalItems">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="stat-number" id="totalCustomers">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
        <div class="stat-number" id="totalSuppliers">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
        <div class="stat-number" id="totalSales">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
        <div class="stat-number" id="totalPurchases">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
        <div class="stat-number" id="totalExpensesHome">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
        <div class="stat-number" id="totalRevenuesHome">0</div>
    </div>
    <div class="stat-card">
    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù</div>
    <div class="stat-number" id="totalAdvancesHome">0</div>
</div>
</div>
</div> 
<div id="advanced-dashboard" class="section">
    <h2>ðŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
    
    <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© -->
    <div class="stats-grid advanced-stats">
        <div class="stat-card">
            <div class="stat-number" id="liveSales">0</div>
            <div class="stat-label">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="stat-trend" id="salesTrend">â†—ï¸ +12%</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="liveRevenue">0</div>
            <div class="stat-label">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
            <div class="stat-trend" id="revenueTrend">â†—ï¸ +8%</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="liveProfit">0</div>
            <div class="stat-label">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div>
            <div class="stat-trend" id="profitTrend">â†—ï¸ +15%</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="liveCustomers">0</div>
            <div class="stat-label">Ø¹Ù…Ù„Ø§Ø¡ Ø¬Ø¯Ø¯</div>
            <div class="stat-trend" id="customersTrend">â†—ï¸ +5%</div>
        </div>
    </div>

    <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="charts-container">
        <div class="chart-card">
            <h3>ðŸ“ˆ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</h3>
            <canvas id="salesChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>ðŸ’° ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h3>
            <canvas id="revenueChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>ðŸ’¸ ØªØ·ÙˆØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
            <canvas id="expensesChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>ðŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
            <canvas id="purchasesSalesChart"></canvas>
        </div>
    </div>

    <!-- Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ© -->
    <div class="analytics-grid">
        <div class="analytics-card">
            <h3>ðŸ“‹ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
            <div id="monthlySummary">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
            </div>
        </div>
        <div class="analytics-card">
            <h3>ðŸŽ¯ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
            <div id="financialPerformance">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
            </div>
        </div>
        <div class="analytics-card">
            <h3>ðŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
            <div id="monthlyExpenses">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
            </div>
        </div>
        <div class="analytics-card">
            <h3>ðŸ’° Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø©</h3>
            <div id="cumulativeProfits">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
            </div>
        </div>
    </div>

    <!-- Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹ -->
    <div class="chart-card">
        <h3>ðŸ† Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹</h3>
        <canvas id="topItemsChart"></canvas>
    </div>
</div>

<div id="items" class="section">
    <h2>ðŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatItems" class="stat-mini-number">0</span></span></h2>
    
    <div class="form-grid grid-4">
        <input type="text" id="itemCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù">
        <input type="text" id="itemName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù *" required>
        <input type="number" id="itemCost" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
        <input type="number" id="itemPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
        <input type="number" id="itemStock" placeholder="Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ">
    <button class="btn-primary btn-add" onclick="addItem()">âž• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchItems" class="search-input" placeholder="ðŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('itemsFilters')">
            <span> </span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="itemsFilters" class="filters-container">
        <div class="filters-grid">
            <div class="filter-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ù…Ù†)</label>
                <input type="number" id="itemCostFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="itemCostTo" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ù…Ù†)</label>
                <input type="number" id="itemPriceFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="itemPriceTo" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ø±ØµÙŠØ¯ (Ù…Ù†)</label>
                <input type="number" id="itemStockFrom" class="filter-input" placeholder="0">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ø±ØµÙŠØ¯ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="itemStockTo" class="filter-input" placeholder="0">
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetItemsFilters()">ðŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button class="btn-primary" onclick="applyItemsFilters()">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        </div>
    </div>

    <table id="itemsTable">
   <thead>
    <tr>
        <th class="sortable" data-column="code">Ø§Ù„ÙƒÙˆØ¯</th>
        <th class="sortable" data-column="name">Ø§Ù„Ø§Ø³Ù…</th>
        <th class="sortable" data-column="cost">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
        <th class="sortable" data-column="price">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
        <th class="sortable" data-column="stock">Ø§Ù„Ø±ØµÙŠØ¯</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    </tr>
</thead>
        <tbody id="itemsList"></tbody>
    </table>
</div>

<div id="customers" class="section">
    <h2>ðŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatCustomers" class="stat-mini-number">0</span></span></h2>
    
    <div class="form-grid grid-3">
        <input type="text" id="customerCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„">
        <input type="text" id="customerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *" required>
        <input type="text" id="customerPhone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
        <input type="email" id="customerEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="text" id="customerAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
    <button class="btn-primary btn-add" onclick="addCustomer()">âž• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchCustomers" class="search-input" placeholder="ðŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('customersFilters')">
            <span> </span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="customersFilters" class="filters-container">
        <p style="color: #666; margin-bottom: 10px;">ðŸ’¡ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø£Ø¹Ù„Ø§Ù‡ Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø§Ù„ÙƒÙˆØ¯ØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)</p>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetCustomersFilters()">ðŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ø­Ø«</button>
        </div>
    </div>

    <table id="customersTable">
        <thead>
    <tr>
        <th class="sortable" data-column="code">Ø§Ù„ÙƒÙˆØ¯</th>
        <th class="sortable" data-column="name">Ø§Ù„Ø§Ø³Ù…</th>
        <th class="sortable" data-column="phone">Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th class="sortable" data-column="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
        <th class="sortable" data-column="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    </tr>
</thead>
        <tbody id="customersList"></tbody>
    </table>
</div>

<div id="suppliers" class="section">
    <h2>ðŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatSuppliers" class="stat-mini-number">0</span></span></h2>
    
    <div class="form-grid grid-3">
        <input type="text" id="supplierCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯">
        <input type="text" id="supplierName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ *" required>
        <input type="text" id="supplierPhone" placeholder=" Ø§Ù„Ù‡Ø§ØªÙ">
        <input type="email" id="supplierEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="text" id="supplierAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
    <button class="btn-primary btn-add" onclick="addSupplier()">âž• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchSuppliers" class="search-input" placeholder="ðŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('suppliersFilters')">
            <span> </span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="suppliersFilters" class="filters-container">
        <p style="color: #666; margin-bottom: 10px;">ðŸ’¡ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø£Ø¹Ù„Ø§Ù‡ Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø§Ù„ÙƒÙˆØ¯ØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)</p>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetSuppliersFilters()">ðŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ø­Ø«</button>
        </div>
    </div>

    <table id="suppliersTable">
        <thead>
            <tr>
                <th class="sortable" data-column="code">Ø§Ù„ÙƒÙˆØ¯</th>
                <th class="sortable" data-column="name">Ø§Ù„Ø§Ø³Ù…</th>
                <th class="sortable" data-column="phone">Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th class="sortable" data-column="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                <th class="sortable" data-column="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="suppliersList"></tbody>
    </table>
</div>

<div id="purchases" class="section">
    <h2>ðŸ›’ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatPurchases" class="stat-mini-number">0</span></span></h2>
    <p>ðŸ“ Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</p>
    
    <div class="form-grid grid-4">
        <input type="text" id="purchaseCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©" readonly>
        <input type="date" id="purchaseDate">
        <select id="purchaseSupplier">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯</option>
        </select>
        <input type="text" id="purchaseNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
    </div>
    
    <div class="form-grid grid-4">
        <select id="purchaseItem">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>
        </select>
        <input type="number" id="purchaseQuantity" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" min="1" value="1">
        <select id="purchaseUnit">
            <option value="Ù‚Ø·Ø¹Ø©">Ù‚Ø·Ø¹Ø©</option>
            <option value="Ø¯Ø±Ø²Ù†">Ø¯Ø±Ø²Ù†</option>
        </select>
        <input type="number" id="purchasePrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
    <button class="btn-primary btn-add" onclick="addPurchaseItem()">âž• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    </div>
    
    <div class="invoice-items">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="purchaseItemsList"></tbody>
        </table>
    </div>
    
    <div class="invoice-totals">
        <div>
            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
            <span id="purchaseSubtotal">0.00</span>
        </div>
        <div>
            <span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
            <span id="purchaseTax">0.00</span>
        </div>
         <div>
            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
            <input type="number" id="purchasePaidAmount" placeholder="0.00" oninput="updatePurchaseTotals()">
        </div>
        <div>
            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
            <span id="purchaseRemainingAmount" class="remaining-unpaid">0.00</span>
        </div>
        <div class="total">
            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
            <span id="purchaseTotal">0.00</span>
        </div>
    </div>
    
   <div style="display: flex; gap: 10px; margin-top: 20px; align-items: center; flex-wrap: wrap;">
    <button class="btn-primary" id="savePurchaseBtn" onclick="savePurchase()">ðŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
    <button class="btn-secondary" onclick="newPurchase()">ðŸ†• ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>

    <input type="file" id="purchaseAttachment" accept="image/*,application/pdf" style="flex: 1; min-width: 250px; padding: 10px; border: 2px dashed var(--primary-color); background: #f8f9fa;">
</div>
    
    <h3 style="margin-top: 30px;">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
    
    <div class="search-container">
        <input type="text" id="searchPurchases" class="search-input" placeholder="ðŸ” Ø¨Ø­Ø« ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('purchasesFilters')">
            <span> </span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="purchasesFilters" class="filters-container">
        <div class="filters-grid">
            <div class="filter-group">
                <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="purchasesDateFrom" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="purchasesDateTo" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ù…Ù†)</label>
                <input type="number" id="purchasesAmountFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="purchasesAmountTo" class="filter-input" placeholder="0.00">
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetPurchasesFilters()">ðŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button class="btn-primary" onclick="applyPurchasesFilters()">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        </div>
    </div>
    
  <table id="purchasesTable">
        <thead>
            <tr>
                <th class="sortable" data-column="code">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th class="sortable" data-column="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th class="sortable" data-column="supplierId">Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                <th class="sortable" data-column="itemsCount">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th class="sortable" data-column="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th class="sortable" data-column="paidAmount">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                <th class="sortable" data-column="remainingAmount">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                <th>Ø§Ù„Ù…Ø±ÙÙ‚</th> <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="purchasesList"></tbody>
    </table>
</div>

<div id="sales" class="section">
    <h2>ðŸ’° ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatSales" class="stat-mini-number">0</span></span></h2>
    <p>ðŸ“ˆ Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
    
    <div class="form-grid grid-4">
        <input type="text" id="saleCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©" readonly>
        <input type="date" id="saleDate">
        <select id="saleCustomer">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
        </select>
        <input type="text" id="saleCustomerCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„" readonly>
    </div>
    
    <div class="form-grid grid-4">
        <input type="text" id="saleCustomerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" readonly>
        <input type="text" id="saleCustomerPhone" placeholder="Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„" readonly>
        <input type="text" id="saleCustomerAddress" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„">
        <input type="text" id="saleNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
    </div>
    
    <div class="form-grid grid-4">
        <select id="saleItem">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>
        </select>
        <input type="number" id="saleQuantity" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" min="1" value="1">
        <select id="saleUnit">
            <option value="Ù‚Ø·Ø¹Ø©">Ù‚Ø·Ø¹Ø©</option>
            <option value="Ø¯Ø±Ø²Ù†">Ø¯Ø±Ø²Ù†</option>
        </select>
        <input type="number" id="salePrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
    <button class="btn-primary btn-add" onclick="addSaleItem()">âž• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    </div>
    
    <div class="invoice-items">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="saleItemsList"></tbody>
        </table>
    </div>
    
    <div class="invoice-totals">
        <div>
            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
            <span id="saleSubtotal">0.00</span>
        </div>
       <div>
            <span>
                <input type="checkbox" id="applySaleTax" onchange="updateSaleTotals()" checked style="margin-right: 5px; vertical-align: middle;">
                <label for="applySaleTax" style="cursor: pointer;">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%)</label>
            </span>
            <span id="saleTax">0.00</span>
        </div>
         <div>
            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
            <input type="number" id="salePaidAmount" placeholder="0.00" oninput="updateSaleTotals()">
        </div>
        <div>
            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
            <span id="saleRemainingAmount" class="remaining-unpaid">0.00</span>
        </div>
        <div class="total">
            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
            <span id="saleTotal">0.00</span>
        </div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn-primary" id="saveSaleBtn" onclick="saveSale()">ðŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
        <button class="btn-secondary" onclick="newSale()">ðŸ†• ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
    
    <h3 style="margin-top: 30px;">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
    
    <div class="search-container">
        <input type="text" id="searchSales" class="search-input" placeholder="ðŸ” Ø¨Ø­Ø« ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('salesFilters')">
            <span> </span>
            <span>ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
            <span>â–¼</span>
        </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="salesFilters" class="filters-container">
        <div class="filters-grid">
            <div class="filter-group">
                <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="salesDateFrom" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="salesDateTo" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ù…Ù†)</label>
                <input type="number" id="salesAmountFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¥Ù„Ù‰)</label>
                <input type="number" id="salesAmountTo" class="filter-input" placeholder="0.00">
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetSalesFilters()">ðŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button class="btn-primary" onclick="applySalesFilters()">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        </div>
    </div>
    
    <table id="salesTable">
        <thead>
            <tr>
                <th class="sortable" data-column="code">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th class="sortable" data-column="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th class="sortable" data-column="customerId">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th class="sortable" data-column="itemsCount">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th class="sortable" data-column="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th class="sortable" data-column="paidAmount">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                <th class="sortable" data-column="remainingAmount">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                <th style="text-align: center;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="salesList"></tbody>
    </table>
</div>

<div id="returns" class="section">
    <h2>â†©ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</h2>
    <div class="tabs">
        <button id="salesReturnTabBtn" class="tab-button active" onclick="showReturnTab('sales')">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
        <button id="purchasesReturnTabBtn" class="tab-button" onclick="showReturnTab('purchases')">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
    </div>

    <div id="salesReturnContent" class="tab-content active">
        <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø§Ø¦Ù†)</h3>
        <div class="search-container">
            <input type="number" id="salesReturnInvoiceSearch" class="search-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©...">
            <button class="btn-primary" onclick="findSaleForReturn()">ðŸ” Ø¨Ø­Ø«</button>
        </div>
        
        <div id="salesReturnInvoiceDetails" class="return-invoice-details" style="display: none;"></div>

        <div id="salesReturnItemsContainer" style="display: none;">
            <h4>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹:</h4>
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„ØµÙ†Ù</th>
                        <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©</th>
                    </tr>
                </thead>
                <tbody id="salesReturnItemsList"></tbody>
            </table>
            <div class="invoice-totals">
                <div class="total">
                    <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</span>
                    <span id="salesReturnTotal">0.00</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-success" onclick="saveSaleReturn()">ðŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</button>
                <button class="btn-secondary" onclick="newSaleReturn()">ðŸ†• Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>
        
        <h3 style="margin-top: 30px;">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
        <table>
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
            </thead>
            <tbody id="salesReturnsList"></tbody>
        </table>
    </div>

    <div id="purchaseReturnContent" class="tab-content">
        <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª (Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¯ÙŠÙ†)</h3>
        <div class="search-container">
            <input type="number" id="purchaseReturnInvoiceSearch" class="search-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©...">
            <button class="btn-primary" onclick="findPurchaseForReturn()">ðŸ” Ø¨Ø­Ø«</button>
        </div>

        <div id="purchaseReturnInvoiceDetails" class="return-invoice-details" style="display: none;"></div>

        <div id="purchaseReturnItemsContainer" style="display: none;">
            <h4>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹:</h4>
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„ØµÙ†Ù</th>
                        <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©</th>
                    </tr>
                </thead>
                <tbody id="purchaseReturnItemsList"></tbody>
            </table>
            <div class="invoice-totals">
                <div class="total">
                    <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</span>
                    <span id="purchaseReturnTotal">0.00</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-success" onclick="savePurchaseReturn()">ðŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</button>
                <button class="btn-secondary" onclick="newPurchaseReturn()">ðŸ†• Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>

        <h3 style="margin-top: 30px;">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
        <table>
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                    <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
            </thead>
            <tbody id="purchaseReturnsList"></tbody>
        </table>
    </div>
</div>

<div id="expenses" class="section">
    <h2>ðŸ’¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatExpenses" class="stat-mini-number">0</span></span></h2>
    <p>ðŸ’° Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØµÙ†ÙŠÙ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p>
    
    <div class="form-grid grid-4">
        <input type="date" id="expenseDate" value="">
        <input type="text" id="expenseCategory" placeholder="ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ØµØ±ÙˆÙ *" required>
        <input type="number" id="expenseAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº *" required min="0">
        <input type="text" id="expenseDescription" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ">
    </div>
    
    <div class="form-grid grid-3">
    <select id="expensePaymentMethod">
        <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
        <option value="bank">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
        <option value="check">Ø´ÙŠÙƒ</option>
        <option value="card">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
    </select>
    <input type="text" id="expenseReference" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ (Ø§Ø®ØªÙŠØ§Ø±)">
    
    <input type="file" id="expenseAttachment" accept="image/*,application/pdf" style="padding: 10px; border: 2px dashed var(--primary-color); background: #f8f9fa;">
    
    <button class="btn-primary btn-add" onclick="addExpense()">âž• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
</div>
    <div class="search-container">
        <input type="text" id="searchExpenses" class="search-input" placeholder="ðŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª...">
    </div>

   <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                <th>Ø§Ù„ÙˆØµÙ</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                <th>Ø§Ù„Ù…Ø±ÙÙ‚</th> <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="expensesList"></tbody>
    </table>
    <div class="stats-grid" style="margin-top: 30px;">
        <div class="stat-card">
            <div class="stat-number" id="totalExpenses">0</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayExpenses">0</div>
            <div class="stat-label">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="monthExpenses">0</div>
            <div class="stat-label">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±</div>
        </div>
    </div>
</div>

<div id="revenues" class="section">
    <h2>ðŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatRevenues" class="stat-mini-number">0</span></span></h2>
    <p>ðŸ’µ Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØµÙ†ÙŠÙ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©</p>
    
    <div class="form-grid grid-4">
        <input type="date" id="revenueDate" value="">
        <input type="text" id="revenueCategory" placeholder="ØªØµÙ†ÙŠÙ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ *" required>
        <input type="number" id="revenueAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº *" required min="0">
        <input type="text" id="revenueDescription" placeholder="ÙˆØµÙ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯">
    </div>
    
    <div class="form-grid grid-3">
        <select id="revenueSource">
            <option value="sales">Ù…Ø¨ÙŠØ¹Ø§Øª</option>
            <option value="services">Ø®Ø¯Ù…Ø§Øª</option>
            <option value="investment">Ø§Ø³ØªØ«Ù…Ø§Ø±</option>
            <option value="other">Ø£Ø®Ø±Ù‰</option>
        </select>
        <input type="text" id="revenueReference" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <button class="btn-primary btn-add" onclick="addRevenue()">âž• Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ±Ø§Ø¯</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchRevenues" class="search-input" placeholder="ðŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª...">
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„ÙˆØµÙ</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="revenuesList"></tbody>
    </table>
    
    <div class="stats-grid" style="margin-top: 30px;">
        <div class="stat-card">
            <div class="stat-number" id="totalRevenues">0</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayRevenues">0</div>
            <div class="stat-label">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="monthRevenues">0</div>
            <div class="stat-label">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div>
        </div>
    </div>
</div>


<!-- Ø¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ Ù‚Ø³Ù… Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆÙ‚Ø¨Ù„ Ù‚Ø³Ù… Ø§Ù„ØµØ¯Ù‚Ø© -->
<div id="advances" class="section">
    <h2>ðŸ’³ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatAdvances" class="stat-mini-number">0.00</span></span></h2>
    <p>ðŸ’° Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø³Ù„Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠØ©</p>
    
    <div class="form-grid grid-4">
        <input type="date" id="advanceDate" value="">
        <select id="advanceType">
            <option value="Ø³Ù„ÙØ©">Ø³Ù„ÙØ© Ù…ÙˆØ¸Ù</option>
            <option value="Ø¹Ù‡Ø¯Ø©">Ø¹Ù‡Ø¯Ø© Ù…Ø§Ù„ÙŠØ©</option>
            <option value="Ø³Ø¯Ø§Ø¯">Ø³Ø¯Ø§Ø¯</option>
        </select>
        <input type="text" id="advanceEmployee" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù / Ø§Ù„Ù…Ø³ØªÙ„Ù… *" required>
        <input type="number" id="advanceAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº *" required min="0">
    </div>
    
    <div class="form-grid grid-3">
        <input type="text" id="advanceDescription" placeholder="Ø§Ù„ÙˆØµÙ / Ø§Ù„ØºØ±Ø¶">
        <select id="advanceStatus">
            <option value="Ù…Ø³ØªØ­Ù‚">Ù…Ø³ØªØ­Ù‚</option>
            <option value="Ù…Ø³Ø¯Ø¯">Ù…Ø³Ø¯Ø¯</option>
            <option value="Ø¬Ø²Ø¦ÙŠ">Ù…Ø³Ø¯Ø¯ Ø¬Ø²Ø¦ÙŠØ§Ù‹</option>
        </select>
        <button class="btn-primary btn-add" onclick="addAdvance()">âž• Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø©/Ø³Ù„ÙØ©</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchAdvances" class="search-input" placeholder="ðŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù...">
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù / Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„ÙˆØµÙ</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="advancesList"></tbody>
    </table>
    
    <div class="stats-grid" style="margin-top: 30px;">
        <div class="stat-card">
            <div class="stat-number" id="totalAdvances">0.00</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ù ÙˆØ§Ù„Ø¹Ù‡Ø¯</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="dueAdvances">0.00</div>
            <div class="stat-label">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="paidAdvances">0.00</div>
            <div class="stat-label">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³Ø¯Ø¯Ø©</div>
        </div>
    </div>
</div>

<div id="salaries" class="section">
    <h2>ðŸ’¼ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨ <span class="title-stat-card"><span class="stat-mini-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="miniStatSalaries" class="stat-mini-number">0.00</span></span></h2>
    <p>ðŸ§¾ Ù‚Ù… Ø¨Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø£Ù†Ø¸Ù…Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>

    <div class="salary-card">
        <h3>Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨</h3>
        <div class="form-grid">
            <input type="month" id="salaryMonth" value="">
            <input type="text" id="salaryEmployeeName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù *" required>
            <input type="text" id="salaryEmployeeId" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ *" required>
            <input type="text" id="salaryJobTitle" placeholder="Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
            <input type="number" id="salaryBasic" placeholder="Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ *" min="0" step="0.01" required>
            <input type="number" id="salaryHousing" placeholder="Ø¨Ø¯Ù„ Ø§Ù„Ø³ÙƒÙ†" min="0" step="0.01">
            <input type="number" id="salaryTransport" placeholder="Ø¨Ø¯Ù„ Ø§Ù„Ù†Ù‚Ù„" min="0" step="0.01">
            <input type="number" id="salaryOtherAllowances" placeholder="Ø¨Ø¯Ù„Ø§Øª Ø£Ø®Ø±Ù‰" min="0" step="0.01">
            <input type="number" id="salaryOvertime" placeholder="Ù…ÙƒØ§ÙØ¢Øª Ø¥Ø¶Ø§ÙÙŠØ©" min="0" step="0.01">
            <input type="number" id="salaryOtherDeductions" placeholder="Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰" min="0" step="0.01">
            <textarea id="salaryNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ù…Ø³ÙŠØ±" rows="2"></textarea>
        </div>
        <div class="salary-actions">
            <button class="btn-primary" onclick="addSalary()">âž• Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙŠØ±</button>
            <button class="btn-secondary" onclick="clearSalaryForm()">â†º ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        </div>
    </div>

    <div class="salary-summary">
        <h3>Ù…Ù„Ø®Øµ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯</h3>
        <div class="summary-item"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span><span id="salarySummaryCount">0</span></div>
        <div class="summary-item"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</span><span id="salarySummaryBasic">0.00</span></div>
        <div class="summary-item"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</span><span id="salarySummaryAllowances">0.00</span></div>
        <div class="summary-item"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨</span><span id="salarySummaryGross">0.00</span></div>
        <div class="summary-item gosi-deduction"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª GOSI</span><span id="salarySummaryGosi">0.00</span></div>
        <div class="summary-item"><span>Ù…Ø³Ø§Ù‡Ù…Ø© Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„ (GOSI)</span><span id="salarySummaryGosiEmployer">0.00</span></div>
        <div class="summary-item"><span>Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰</span><span id="salarySummaryOtherDeductions">0.00</span></div>
        <div class="summary-item summary-total"><span>ØµØ§ÙÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨</span><span id="salarySummaryNet" class="net-salary">0.00</span></div>
    </div>

    <div class="search-container">
        <input type="text" id="searchSalaries" class="search-input" placeholder="ðŸ” Ø¨Ø­Ø« ÙÙŠ Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨...">
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th>Ø§Ù„Ø´Ù‡Ø±</th>
                <th>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                <th>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</th>
                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th>Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ GOSI</th>
                <th>Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰</th>
                <th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="salariesList"></tbody>
    </table>
</div>

<div id="reports" class="section">
    <h2>ðŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
    <p>ðŸ“‹Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"</p>

    <div id="reportsTab" class="tab-content active">
        <div class="report-controls">
            <select id="reportType" onchange="changeReportType()">
                <option value="sales">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                <option value="purchases">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
                <option value="sales_returns">â†©ï¸ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                <option value="purchase_returns">â†©ï¸ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
                <option value="expenses">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</option>
                <option value="revenues">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</option>
                <option value="salaries">ðŸ’¼ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨</option>
                <option value="profit_loss">ðŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø©</option>
            </select>
            
            <input type="date" id="reportFrom">
            <input type="date" id="reportTo">
            
            <select id="reportSupplierFilter" style="display: none;">
                <option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>
            </select>

            <select id="reportCustomerFilter" style="display: none;">
                <option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
            </select>

            <select id="paymentStatusFilter">
                <option value="all">ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</option>
                <option value="paid">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</option>
                <option value="unpaid">ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</option>
            </select>
            
            <select id="reportItemFilter" onchange="updateReportItemFilter()">
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù</option>
                <option value="specific">ØµÙ†Ù Ù…Ø­Ø¯Ø¯</option>
            </select>
            
            <select id="reportSpecificItem" style="display: none;">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>
            </select>
            
            <button class="btn-primary" onclick="generateReport()">ðŸ” Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
        
        <div class="export-options">
            <button class="btn-success" onclick="exportToExcel()">ðŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
            <button class="btn-secondary" onclick="exportToWeb()">ðŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
        
        <div class="report-summary" id="reportSummary">
               
        </div>
        
        <div id="reportResults">
        </div>
    </div>
</div>

<div id="settings" class="section">
    <h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù†Ø¸Ø§Ù…</h2>

    <div class="settings-grid">
        <div id="userManagementSection" class="user-management settings-card" style="display: none;">
            <h3>ðŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            <div class="form-grid grid-users">
                <input type="text" id="newUserName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… *">
                <select id="newUserRole">
                    <option value="admin">Ù…Ø¯ÙŠØ±</option>
                    <option value="manager">Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·</option>
                    <option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option>
                </select>
                <input type="email" id="newUserEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *">
                <input type="tel" id="newUserPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ *">
                <input type="password" id="newUserPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *">
                <select id="newUserActivity">
                    <option value="">-- ØªØ¹ÙŠÙŠÙ† Ù„Ù†Ø´Ø§Ø· --</option>
                </select>
                <button class="btn-primary btn-add" onclick="addUser()">âž• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
            </div>
            <div class="user-selector">
                <label for="usersDropdown" class="user-selector-label">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:</label>
                <div class="user-selector-controls">
                    <select id="usersDropdown" onchange="handleUserSelection()">
                        <option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§</option>
                    </select>
                </div>
                <div id="selectedUserInfo" class="selected-user-info" style="display: none;">
                    <div class="selected-user-grid">
                        <div class="selected-user-field">
                            <label for="selectedUserName">Ø§Ù„Ø§Ø³Ù…</label>
                            <input type="text" id="selectedUserName" readonly>
                        </div>
                        <div class="selected-user-field role-field">
                            <label for="selectedUserRole">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                            <input type="text" id="selectedUserRole" readonly>
                        </div>
                        <div class="selected-user-field">
                            <label for="selectedUserEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="text" id="selectedUserEmail" readonly>
                        </div>
                        <div class="selected-user-field phone-field">
                            <label for="selectedUserPhone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                            <input type="text" id="selectedUserPhone" readonly>
                        </div>
                        <div class="selected-user-field">
                            <label for="selectedUserActivity">Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø®ØµØµ</label>
                            <input type="text" id="selectedUserActivity" readonly>
                        </div>
                    </div>
                    <div class="selected-user-actions">
                        <button class="btn-warning edit-btn" id="editSelectedUserBtn" onclick="handleEditSelectedUser()" disabled>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger" id="deleteSelectedUserBtn" onclick="handleDeleteSelectedUser()" disabled>ðŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="activityManagementSection" class="activities-management settings-card" style="display: none;">
            <h3>ðŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</h3>
            <div class="form-grid grid-3">
                <input type="text" id="settingNewActivityName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                <button class="btn-primary btn-add" onclick="addNewActivity(true)">âž• Ø¥Ø¶Ø§ÙØ© Ù†Ø´Ø§Ø·</button>
                <button class="btn-danger" onclick="showTrashModal()">
                    ðŸ—‘ï¸ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                    <span id="trash-count-badge" style="background: #fff; color: #d32f2f; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-right: 5px; font-weight: bold;"></span>
                </button>
            </div>
            <div class="activity-selector" style="margin-top: 20px;">
                <label for="activitiesDropdown" class="activity-selector-label">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø©:</label>
                <div class="activity-selector-controls">
                    <select id="activitiesDropdown" onchange="handleActivitySelection()">
                        <option value="">Ø§Ø®ØªØ± Ù†Ø´Ø§Ø·Ù‹Ø§</option>
                    </select>
                </div>
                <div id="selectedActivityInfo" class="selected-activity-info" style="display: none;">
                    <div class="selected-activity-field">
                        <label for="selectedActivityName">Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·</label>
                        <input type="text" id="selectedActivityName" readonly>
                    </div>
                    <div class="selected-activity-actions">
                        <button class="btn-warning edit-btn" id="editSelectedActivityBtn" onclick="handleEditSelectedActivity()" disabled>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger" id="deleteSelectedActivityBtn" onclick="handleDeleteSelectedActivity()" disabled>ðŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ - Ù…ØªØ§Ø­ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div id="activityLogoSection" class="activity-logo-settings settings-card" style="display: none;">
                <h3>ðŸ¢ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</h3>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Ø§Ø®ØªØ± Ø´Ø¹Ø§Ø±Ø§Ù‹ Ù„Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±)</p>
            
            <div class="logo-preview-container" style="text-align: center; margin-bottom: 20px;">
                <img id="activityLogoPreview" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·" style="max-width: 150px; max-height: 150px; display: none; border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
                <p id="noActivityLogoText" style="color: #999; font-style: italic;">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ù„Ù„Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯</p>
            </div>
            
            <div class="logo-actions" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <input type="file" id="activityLogoFileInput" accept="image/*" style="display: none;" onchange="handleActivityLogoUpload(this)">
                <button class="btn-primary" onclick="document.getElementById('activityLogoFileInput').click()">ðŸ“¤ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·</button>
                <button class="btn-danger" id="removeActivityLogoBtn" onclick="removeActivityLogo()" style="display: none;">ðŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø±</button>
            </div>
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 0.85em;">
                <p><strong>ðŸ’¡ Ù†ØµØ§Ø¦Ø­:</strong></p>
                <ul style="margin: 5px 0; padding-right: 20px;">
                    <li>Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ ÙˆØ³Ø· Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· ØªØ­ØªÙ‡</li>
                    <li>ÙŠÙÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø¨Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© (PNG)</li>
                    <li>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡: 400Ã—400 Ø¨ÙƒØ³Ù„</li>
                    <li>Ø£Ù‚ØµÙ‰ Ø­Ø¬Ù… Ù„Ù„Ù…Ù„Ù: 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª</li>
                </ul>
            </div>
            </div>

            <div id="programLogoSection" class="logo-settings settings-card">
                <h3>ðŸŽ¨ Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</h3>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Ø§Ø®ØªØ± Ø´Ø¹Ø§Ø±Ø§Ù‹ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</p>
            
            <div class="logo-preview-container" style="text-align: center; margin-bottom: 20px;">
                <img id="logoPreview" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¹Ø§Ø±" style="max-width: 150px; max-height: 150px; display: none; border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
                <p id="noLogoText" style="color: #999; font-style: italic;">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯</p>
            </div>
            
            <div class="logo-actions" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <input type="file" id="logoFileInput" accept="image/*" style="display: none;" onchange="handleLogoUpload(this)">
                <button class="btn-primary" onclick="document.getElementById('logoFileInput').click()">ðŸ“¤ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø¹Ø§Ø±</button>
                <button class="btn-danger" id="removeLogoBtn" onclick="removeLogo()" style="display: none;">ðŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø±</button>
            </div>
            
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 0.85em;">
                <p><strong>ðŸ’¡ Ù†ØµØ§Ø¦Ø­:</strong></p>
                <ul style="margin: 5px 0; padding-right: 20px;">
                    <li>ÙŠÙÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø¨Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© (PNG)</li>
                    <li>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡: 500Ã—500 Ø¨ÙƒØ³Ù„</li>
                    <li>Ø£Ù‚ØµÙ‰ Ø­Ø¬Ù… Ù„Ù„Ù…Ù„Ù: 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª</li>
                </ul>
            </div>
            </div>
        </div>

        <div class="auto-backup-settings settings-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
            <h3 style="color: white;">ðŸ”„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</h3>
            <p style="opacity: 0.95; margin-bottom: 20px;">ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 24 Ø³Ø§Ø¹Ø© ÙˆØ­ÙØ¸Ù‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</p>
            
            <div class="data-actions-grid" style="gap: 15px;">
                <button class="btn-success" onclick="performAutoBackup()" style="background: #10b981;">
                    ðŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ø¢Ù†
                </button>
                <button class="btn-info" onclick="showAutoBackupInfo()" style="background: #3b82f6;">
                    â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¢Ø®Ø± Ù†Ø³Ø®Ø©
                </button>
                <button class="btn-warning" onclick="restoreAutoBackup()" style="background: #f59e0b;">
                    â†©ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¢Ø®Ø± Ù†Ø³Ø®Ø©
                </button>
                <button class="btn-secondary" onclick="downloadAutoBackup()" style="background: #6366f1;">
                    ðŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© ÙƒÙ…Ù„Ù
                </button>
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 8px; margin-top: 20px; backdrop-filter: blur(10px);">
                <h4 style="color: white; margin-bottom: 10px;">âœ¨ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:</h4>
                <ul style="margin: 0; padding-right: 20px; opacity: 0.95;">
                    <li>Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©</li>
                    <li>Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ Ø¢Ù…Ù† Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</li>
                    <li>Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù†Ø³Ø®ØªÙŠÙ† (Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚Ø©)</li>
                    <li>Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø³Ø±ÙŠØ¹Ø© Ø¨Ø¶ØºØ·Ø© ÙˆØ§Ø­Ø¯Ø©</li>
                    <li>Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© ÙƒÙ…Ù„Ù JSON</li>
                </ul>
            </div>
        </div>

        <div class="data-management settings-card">
            <h3>ðŸ”„ Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
            <div class="data-actions">
                <div class="data-actions-grid">
                    <button class="btn-success" onclick="exportActivityData()">ðŸ“¥ ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·</button>
                    <button class="btn-info" onclick="exportActivityDataExcel()">ðŸ“Š ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Excel</button>
                    <button class="btn-primary" onclick="importData()">ðŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ø´Ø§Ø·</button>
                    <button class="btn-warning backup-btn" onclick="createBackup()">ðŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
                    <button class="btn-secondary" onclick="importSampleData()">ðŸ§ª Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù†Ø´Ø§Ø·</button>
                    <button class="btn-danger" onclick="clearActivityData()">ðŸ—‘ï¸ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·</button>
                </div>
            </div>
            <div class="backup-info" style="background: #fff3cd; padding: 20px; border-radius: 8px; border-right: 4px solid #ffc107;">
                <h4>ðŸ’¡ Ù†ØµØ§Ø¦Ø­ Ù…Ù‡Ù…Ø©:</h4>
                <ul style="margin: 10px 0; padding-right: 20px;">
                    <li>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø£Ø¹Ù„Ø§Ù‡ Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·.</li>
                    <li>Ø§Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„ÙƒÙ„ Ù†Ø´Ø§Ø· Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ.</li>
                    <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØµØ­ÙŠØ­ Ù‚Ø¨Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ùˆ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</li>
                </ul>
            </div>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(this.files)">
        </div>
    </div>

    <button id="toggleEmailSettingsBtn" class="btn-success" onclick="toggleEmailSettings()" style="margin-top: 30px; margin-bottom: 10px;">
        âš™ï¸ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
    </button>
    <div class="email-settings">
    <h3>ðŸ“§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (EmailJS)</h3>
    <p>Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¶Ø±ÙˆØ±ÙŠØ© Ù„ØªÙØ¹ÙŠÙ„ Ø®Ø§ØµÙŠØ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ±ÙˆØ§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡Ø§ Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ <a href="https://www.emailjs.com/" target="_blank">EmailJS</a>.</p>
        <div class="form-grid grid-3" style="margin-top: 15px;">
            <div style="display: flex; flex-direction: column;">
                <label for="emailJsServiceId" style="margin-bottom: 5px; font-weight: bold;">Service ID</label>
                <code style="background-color: #eee; padding: 5px; border-radius: 4px; margin-bottom: 5px; cursor: pointer; user-select: all;" onclick="navigator.clipboard.writeText(this.innerText); alert('ØªÙ… Ù†Ø³Ø® Service ID');">service_hu6ucxi</code>
                <input type="text" id="emailJsServiceId" placeholder="Ø£Ø¯Ø®Ù„ Service ID Ù‡Ù†Ø§">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="emailJsTemplateId" style="margin-bottom: 5px; font-weight: bold;">Template ID</label>
                <code style="background-color: #eee; padding: 5px; border-radius: 4px; margin-bottom: 5px; cursor: pointer; user-select: all;" onclick="navigator.clipboard.writeText(this.innerText); alert('ØªÙ… Ù†Ø³Ø® Template ID');">template_cwep9ok</code>
                <input type="text" id="emailJsTemplateId" placeholder="Ø£Ø¯Ø®Ù„ Template ID Ù‡Ù†Ø§">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="emailJsResetTemplateId" style="margin-bottom: 5px; font-weight: bold;">Reset Template ID</label>
                <code style="background-color: #eee; padding: 5px; border-radius: 4px; margin-bottom: 5px; cursor: pointer; user-select: all;" onclick="navigator.clipboard.writeText(this.innerText); alert('ØªÙ… Ù†Ø³Ø® Reset Template ID');">template_password_reset</code>
                <input type="text" id="emailJsResetTemplateId" placeholder="Ø£Ø¯Ø®Ù„ Template ID Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="emailJsPublicKey" style="margin-bottom: 5px; font-weight: bold;">Public Key</label>
                <code style="background-color: #eee; padding: 5px; border-radius: 4px; margin-bottom: 5px; cursor: pointer; user-select: all;" onclick="navigator.clipboard.writeText(this.innerText); alert('ØªÙ… Ù†Ø³Ø® Public Key');">-FKicwCTdzG90IoY6</code>
                <input type="text" id="emailJsPublicKey" placeholder="Ø£Ø¯Ø®Ù„ Public Key Ù‡Ù†Ø§">
            </div>
        </div>
        <button class="btn-success" onclick="saveEmailJsSettings()">ðŸ’¾ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
        <div style="margin-top: 10px; font-size: 0.9em;">
            <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong>
                - Ù‚Ø§Ù„Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: <code>{{to_name}}</code>, <code>{{to_email}}</code>, <code>{{from_name}}</code>, <code>{{invoice_number}}</code>, <code>{{invoice_details}}</code>.
                <br>- Ù‚Ø§Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: <code>{{to_email}}</code>, <code>{{reset_link}}</code>, <code>{{app_name}}</code>.
            </p>
        </div>
    </div>

    
</div>

<div id="account-info" class="section">
    <h2>ðŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
    <p>Ø§Ø³ØªØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ­Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø£Ù…Ø§Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„.</p>
    <div class="account-info-grid">
        <div class="account-info-card">
            <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
            <div class="account-info-field"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="accountInfoName">ØºÙŠØ± Ù…ØªÙˆÙØ±</span></div>
            <div class="account-info-field"><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> <span id="accountInfoEmail">ØºÙŠØ± Ù…ØªÙˆÙØ±</span></div>
            <div class="account-info-field"><strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> <span id="accountInfoPhone">ØºÙŠØ± Ù…ØªÙˆÙØ±</span></div>
            <div class="account-info-field"><strong>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:</strong> <span id="accountInfoRole">ØºÙŠØ± Ù…ØªÙˆÙØ±</span></div>
            <div class="account-info-actions">
                <button class="btn-primary" id="accountInfoEditBtn" onclick="openSelfEditUserModal()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</button>
            </div>
        </div>
        <div class="account-info-card">
            <h3>Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
            <div class="account-info-field"><strong>Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> <span id="accountInfoActivity">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø·</span></div>
            <div class="account-info-actions">
                <button class="btn-warning" id="accountInfoChangeActivityBtn" onclick="showActivityModal()">ðŸ”„ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·</button>
            </div>
        </div>
        <div class="account-info-card">
            <h3>Ø¥Ø¯Ø§Ø±Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
            <p style="margin-bottom: 15px;">Ù†Ù†ØµØ­ Ø¨ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø£Ù…Ø§Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.</p>
            <div class="account-info-actions">
                <button class="btn-warning" onclick="openChangePasswordModal()">ðŸ”’ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
            </div>
        </div>
    </div>
</div>

<div id="purchaseInvoicePrint" class="invoice-print">
    <!-- Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ -->
    <div style="border: 4px double #2c5aa0; padding: 15px; position: relative;">
        
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø±: Ø§Ù„Ø´Ø¹Ø§Ø± (Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø±) + Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· -->
        <div style="border: 2px solid #2c5aa0; border-radius: 15px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center;">
            <div style="width: 60px; display: flex; justify-content: flex-start;">
                <img id="printPurchaseActivityLogo" src="" alt="Ø´Ø¹Ø§Ø±" style="width: 50px; height: 50px; display: none; margin: 0; border-radius: 50%; border: 2px solid #2c5aa0;">
            </div>
            <div style="text-align: center; flex: 1;">
                <h2 id="printPurchaseActivityName" style="margin: 0; color: #2c5aa0; font-size: 1.5em; font-weight: bold;">Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·</h2>
                <div style="font-size: 0.85em; margin-top: 2px;">ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</div>
            </div>
            <div style="width: 60px;"></div>
        </div>
        
        <!-- ØµÙ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 0.95em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px;">
                <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="printPurchaseDate"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px;">
                <strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> <span id="printPurchaseNumber"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px;">
                <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> <span id="printPurchaseTime">--:--</span>
            </div>
        </div>
        
        <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ -->
        <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 10px; font-size: 0.95em;">
            <strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> <span id="printSupplierName">-----</span>
        </div>
        
        <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 10px; font-size: 0.9em;">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> <span id="printPurchaseNotes">-----</span>
        </div>
        
        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù -->
        <table class="invoice-items-table" style="width: 100%; border-collapse: collapse; margin-bottom: 10px; table-layout: fixed; display: table; margin: 0;">
            <colgroup>
                <col style="width: 5%;">    <!-- Ù… -->
                <col style="width: 25%;">   <!-- Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù -->
                <col style="width: 12.5%;"> <!-- Ø§Ù„ÙƒÙ…ÙŠØ© -->
                <col style="width: 12.5%;"> <!-- Ø§Ù„ÙˆØ­Ø¯Ø© -->
                <col style="width: 12.5%;"> <!-- Ø§Ù„Ø³Ø¹Ø± -->
                <col style="width: 12.5%;"> <!-- Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ -->
            </colgroup>
            <thead>
                <tr style="background: #e3f2fd; color: #2c5aa0;">
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">Ù…</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: right;">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">Ø§Ù„Ø³Ø¹Ø±</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                </tr>
            </thead>
            <tbody id="printPurchaseItems" style="font-size: 0.95em;">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </tbody>
        </table>
        
        <!-- Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± Ø§Ù„ØµÙØ­Ø© -->
        <div style="margin-top: 15px; width: 280px; float: left;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #f8f9fa; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</strong>
                <span id="printPurchaseSubtotal">0.00</span>
            </div>
            <div id="printPurchaseTaxRow" style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%):</strong>
                <span id="printPurchaseTax">0.00</span>
            </div>
            <div style="border: 2px solid #2c5aa0; padding: 10px; background: #e3f2fd; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-weight: bold; font-size: 1em; color: #2c5aa0;">
                <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong>
                <span id="printPurchaseTotal">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong>
                <span id="printPurchasePaid">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #fff3cd; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong>
                <span id="printPurchaseRemaining">0.00</span>
            </div>
        </div>
        
        <div style="clear: both;"></div>
    </div>
</div>

<div id="saleInvoicePrint" class="invoice-print">
    <!-- Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ -->
    <div style="border: 4px double #2c5aa0; padding: 15px; position: relative;">
        
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø±: Ø§Ù„Ø´Ø¹Ø§Ø± (Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø±) + Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· -->
        <div style="border: 2px solid #2c5aa0; border-radius: 15px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center;">
            <div style="width: 60px; display: flex; justify-content: flex-start;">
                <img id="printSaleActivityLogo" src="" alt="Ø´Ø¹Ø§Ø±" style="width: 50px; height: 50px; display: none; margin: 0; border-radius: 50%; border: 2px solid #2c5aa0;">
            </div>
            <div style="text-align: center; flex: 1;">
                <h2 id="printSaleActivityName" style="margin: 0; color: #2c5aa0; font-size: 1.5em; font-weight: bold;">Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·</h2>
                <div style="font-size: 0.85em; margin-top: 2px;">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</div>
            </div>
            <div style="width: 60px;"></div>
        </div>
        
        <!-- ØµÙ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div style="display: grid; grid-template-columns: 1fr 1.5fr 0.8fr; gap: 10px; margin-bottom: 10px; font-size: 0.95em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; font-size: 0.85em; border-radius: 8px;">
                <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="printSaleDate"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; background: #e3f2fd; font-size: 0.85em; border-radius: 8px;">
                <strong>ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø© Ù€ Ø±Ù‚Ù…:</strong> <span id="printSaleNumber"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; font-size: 0.85em; border-radius: 8px;">
                <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> <span id="printSaleTime">--:--</span>
            </div>
        </div>
        
        <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
        <div style="display: grid; grid-template-columns: 1.5fr 0.8fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 0.95em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="printCustomerName">-----</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="printCustomerCode">-----</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> <span id="printCustomerPhone">-----</span>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 0.9em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="printCustomerAddress">-----</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> <span id="printSaleNotes">-----</span>
            </div>
        </div>
        
        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù -->
    <table class="invoice-items-table" style="width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 10px;">
            <thead>
                <tr style="background: #e3f2fd; color: #2c5aa0;">
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 5%; border-radius: 6px;">Ù…</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15%; border-radius: 6px;">Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 33%; border-radius: 6px;">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15.5%; border-radius: 6px;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15.5%; border-radius: 6px;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15.5%; border-radius: 6px;">Ø§Ù„Ø³Ø¹Ø±</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 12.5%; border-radius: 6px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                </tr>
            </thead>
            <tbody id="printSaleItems" style="font-size: 0.9em;">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </tbody>
        </table>
        
        <!-- Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± Ø§Ù„ØµÙØ­Ø© -->
            <div style="margin-top: 15px; width: 280px; float: left;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #f8f9fa; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</strong>
                <span id="printSaleSubtotal">0.00</span>
            </div>
            <div id="printSaleTaxRow" style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%):</strong>
                <span id="printSaleTax">0.00</span>
            </div>
            <div style="border: 2px solid #2c5aa0; padding: 10px; background: #e3f2fd; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-weight: bold; font-size: 1em; color: #2c5aa0;">
                <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong>
                <span id="printSaleTotal">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong>
                <span id="printSalePaid">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #fff3cd; font-size: 0.9em;">
                <strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong>
                <span id="printSaleRemaining">0.00</span>
            </div>
        </div>
        
        <div style="clear: both;"></div>
    </div>
</div>
        </div>
    </div>
    <script>
// === Ø¯ÙˆØ§Ù„ Firebase Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ===
// ... (Ø£Ø³ÙÙ„ Ø¯ÙˆØ§Ù„ firebaseGet, firebaseSet, etc.)

/**
 * Ø¯Ø§Ù„Ø© Ù„Ø±ÙØ¹ Ù…Ù„Ù Ø¥Ù„Ù‰ Firebase Storage
 * @param {File} file - Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±ÙØ¹Ù‡
 * @param {string} path - Ø§Ù„Ù…Ø³Ø§Ø± Ø¯Ø§Ø®Ù„ Storage (Ù…Ø«Ù„ 'purchases' Ø£Ùˆ 'expenses')
 * @returns {Promise<string|null>} - Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø£Ùˆ null Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„
 */
/**
 * Ø¯Ø§Ù„Ø© Ù„Ø±ÙØ¹ Ù…Ù„Ù Ø¥Ù„Ù‰ Cloudinary
 * @param {File} file - Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±ÙØ¹Ù‡
 * @param {string} path - (Ù„Ù… Ù†Ø¹Ø¯ Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ù‡Ù†Ø§ ÙˆÙ„ÙƒÙ† Ø³Ù†Ø¨Ù‚ÙŠÙ‡ Ù„Ù„ØªÙˆØ§ÙÙ‚)
 * @returns {Promise<string|null>} - Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø£Ùˆ null Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„
 */
async function uploadFile(file, path) {
    if (!file) return null;

    // --- â¬‡ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Cloudinary Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ â¬‡ï¸ ---
    const CLOUD_NAME = "dgjcr2bgq";
    const UPLOAD_PRESET = "diwani_uploads";
    // --- â¬†ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â¬†ï¸ ---

    const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… FormData Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', UPLOAD_PRESET);

    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù„Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø·
    if (currentActivityId) {
        formData.append('folder', `diwani_attachments/${currentActivityId}/${path}`);
    }

    try {
        showLoading(`Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚... ${file.name}`);

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Cloudinary
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok && data.secure_url) {
            // Ù†Ø¬Ø­ Ø§Ù„Ø±ÙØ¹!
            hideLoading();
            showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            return data.secure_url; // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¢Ù…Ù† Ù„Ù„Ù…Ù„Ù
        } else {
            // ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹
            throw new Error(data.error.message || 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹');
        }

    } catch (error) {
        hideLoading();
        logError('Cloudinary Upload', error);
        showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ' + error.message, 'error');
        return null;
    }
}
// === ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±/Ø§Ù„Ø¥Ù†ØªØ§Ø¬ ===
const DEBUG_MODE = true; // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¢Ù…Ù†Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ± ÙÙ‚Ø·
function debugLog(...args) {
    if (DEBUG_MODE) {
        console.log(...args);
    }
}

// === Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ===
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDtm443qYDGFOH7NIFgaxVWPhhW5Ezrfrw",
  authDomain: "diwani-bc43f.firebaseapp.com",
  databaseURL: "https://diwani-bc43f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "diwani-bc43f",
  storageBucket: "diwani-bc43f.firebasestorage.app",
  messagingSenderId: "796547946795",
  appId: "1:796547946795:web:fe9d572923625463dc0d6e",
  measurementId: "G-VEZFJDN2LB"
};
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth(); //  <-- â¬‡ï¸ Ø£Ø¶Ù Ù‡Ø°Ø§

        // === Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ===
let activities = [];
let currentActivityId = null;
let items = [], customers = [], suppliers = [], purchases = [], sales = [], expenses = [], revenues = [], salaries = [];
let advances = [];
let salesReturns = [], purchaseReturns = [];
let currentPurchaseItems = [], currentSaleItems = [];
let editingPurchaseId = null, editingSaleId = null, editingSalaryId = null;
let currentPurchaseNumber = 1, currentSaleNumber = 1;
let currentSaleReturnNumber = 1, currentPurchaseReturnNumber = 1;
let activeSaleReturn = null, activePurchaseReturn = null;
let users = [];
const FIREBASE_SHARED_ROOT = 'shared_activities';
const GOSI_RATE = 0.09;
const GOSI_SALARY_CAP = 45000;

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª =====
let notifications = [];
let trashBin = {
    items: [],
    customers: [],
    suppliers: [],
    purchases: [],
    sales: [],
    expenses: [],
    revenues: [],
    salaries: [],
    advances: []
};
const LOW_STOCK_THRESHOLD = 5; // Ø­Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†

// ===== ØªÙƒÙˆÙŠÙ† EmailJS Ø§Ù„Ø«Ø§Ø¨Øª (Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø£Ø¯Ù†Ø§Ù‡ Ø«Ù… ÙØ¹Ù‘Ù„ Ø§Ù„Ø¹Ù„Ù… EMAILJS_FIXED) =====
const EMAILJS_FIXED = false; // true = Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø© Ø£Ø¯Ù†Ø§Ù‡ ÙˆØ¹Ø¯Ù… Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯

const EMAILJS_DEFAULTS = {
    serviceID: 'service_hu6ucxi',
    templateID: 'VH3waGBnucCE-S4eeM0I4', // Ù‚Ø§Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
    resetTemplateID: 'template_aqp69jt', // Ù‚Ø§Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    publicKey: '-FKicwCTdzG90IoY6'
};
let emailJsConfig = { ...EMAILJS_DEFAULTS };
    // ===== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ´ÙÙŠØ± Ù„Ù„Ø£Ù…Ø§Ù† =====
    async function hashPassword(password) {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… SHA-256 Ù„ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        const msgBuffer = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    }

    async function verifyPassword(inputPassword, hashedPassword) {
        const inputHash = await hashPassword(inputPassword);
        return inputHash === hashedPassword;
    }

    // ===== Ù†Ø¸Ø§Ù… Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ =====
    function showLoading(message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
        let loader = document.getElementById('global-loader');
        if (!loader) {
            loader = document.createElement('div');
            loader.id = 'global-loader';
            loader.innerHTML = `
                <div class="loader-overlay">
                    <div class="loader-content">
                        <div class="spinner"></div>
                        <p class="loader-message">${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loader);
        } else {
            loader.querySelector('.loader-message').textContent = message;
            loader.style.display = 'block';
        }
    }

    function hideLoading() {
        const loader = document.getElementById('global-loader');
        if (loader) {
            loader.style.display = 'none';
        }
    }

    function updateLoadingMessage(message) {
        const loader = document.getElementById('global-loader');
        if (loader) {
            loader.querySelector('.loader-message').textContent = message;
        }
    }

    // ===== Ù†Ø¸Ø§Ù… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… =====
    function logError(context, error, showToUser = true) {
        const timestamp = new Date().toISOString();
        const errorLog = {
            timestamp,
            context,
            error: error.message || error,
            stack: error.stack || 'No stack trace'
        };
        
        console.error('ðŸ”´ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…:', errorLog);
        
        // Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ localStorage Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
        try {
            let errorLogs = JSON.parse(localStorage.getItem('systemErrors') || '[]');
            errorLogs.push(errorLog);
            // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 50 Ø®Ø·Ø£ ÙÙ‚Ø·
            if (errorLogs.length > 50) errorLogs = errorLogs.slice(-50);
            localStorage.setItem('systemErrors', JSON.stringify(errorLogs));
        } catch (e) {
            console.error('ÙØ´Ù„ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:', e);
        }
        
        if (showToUser) {
            showNotification(
                'âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…',
                `${error.message || error}\n\nÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.`,
                'error',
                8000
            );
        }
    }

    async function safeAsyncOperation(operation, context, loadingMessage = null) {
        try {
            if (loadingMessage) showLoading(loadingMessage);
            const result = await operation();
            return { success: true, data: result };
        } catch (error) {
            logError(context, error);
            return { success: false, error: error.message || error };
        } finally {
            if (loadingMessage) hideLoading();
        }
    }

    // ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =====
    function showNotification(title, message, type = 'info', duration = 5000) {
        const container = document.getElementById('notifications-container') || createNotificationContainer();
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const icons = {
            success: 'âœ…',
            warning: 'âš ï¸',
            error: 'âŒ',
            info: 'â„¹ï¸'
        };
        
        notification.innerHTML = `
            <div class="notification-icon">${icons[type]}</div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <div class="notification-close" onclick="closeNotification(this)">âœ–</div>
        `;
        
        container.appendChild(notification);
        
        // Ø¥Ø²Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        setTimeout(() => {
            if (notification.parentElement) {
                closeNotification(notification.querySelector('.notification-close'));
            }
        }, duration);
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        notifications.push({
            id: Date.now(),
            title,
            message,
            type,
            timestamp: new Date().toISOString()
        });
        
        return notification;
    }

    function createNotificationContainer() {
        const container = document.createElement('div');
        container.id = 'notifications-container';
        document.body.appendChild(container);
        return container;
    }

    function closeNotification(closeButton) {
        const notification = closeButton.closest('.notification');
        notification.classList.add('removing');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }

    function checkLowStock() {
        const lowStockItems = items.filter(item => item.stock <= LOW_STOCK_THRESHOLD && item.stock > 0);
        const outOfStockItems = items.filter(item => item.stock <= 0);
        
        if (outOfStockItems.length > 0) {
            showNotification(
                'ðŸš¨ ØªÙ†Ø¨ÙŠÙ‡: Ø£ØµÙ†Ø§Ù Ù†ÙØ°Øª',
                `${outOfStockItems.length} ØµÙ†Ù Ù†ÙØ° Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ²ÙˆÙŠØ¯ ÙÙˆØ±Ø§Ù‹.`,
                'error',
                8000
            );
        }
        
        if (lowStockItems.length > 0) {
            showNotification(
                'âš ï¸ ØªØ­Ø°ÙŠØ±: Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶',
                `${lowStockItems.length} ØµÙ†Ù Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ù†ÙØ§Ø¯ (Ø£Ù‚Ù„ Ù…Ù† ${LOW_STOCK_THRESHOLD} ÙˆØ­Ø¯Ø§Øª).`,
                'warning',
                7000
            );
        }
    }

    function checkUnpaidDebts() {
        const unpaidSales = sales.filter(s => s.remainingAmount > 0);
        const totalDebt = unpaidSales.reduce((sum, s) => sum + s.remainingAmount, 0);
        
        if (unpaidSales.length > 0) {
            showNotification(
                'ðŸ’° ØªØ°ÙƒÙŠØ±: Ø¯ÙŠÙˆÙ† ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©',
                `Ù„Ø¯ÙŠÙƒ ${unpaidSales.length} ÙØ§ØªÙˆØ±Ø© Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${totalDebt.toFixed(2)} Ø±.Ø³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©.`,
                'warning',
                6000
            );
        }
    }

    // ===== Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª =====
    function moveToTrash(type, item) {
        if (!trashBin[type]) trashBin[type] = [];
        
        const trashItem = {
            ...item,
            deletedAt: new Date().toISOString(),
            deletedBy: JSON.parse(sessionStorage.getItem('loggedInUser'))?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
            type: type
        };
        
        trashBin[type].push(trashItem);
        saveTrashToLocalStorage();
        
        showNotification(
            'ðŸ—‘ï¸ ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
            `ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…Ø§Ù‹.`,
            'info',
            4000
        );
        
        // ØªØ­Ø¯ÙŠØ« Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
        refreshTrashModalIfOpen(type);
        
        return true;
    }

    function restoreFromTrash(type, itemId) {
        const itemIndex = trashBin[type].findIndex(item => item.id === itemId);
        if (itemIndex === -1) return false;
        
        const item = trashBin[type][itemIndex];
        trashBin[type].splice(itemIndex, 1);
        
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        const { deletedAt, deletedBy, type: itemType, ...originalItem } = item;
        
        switch(type) {
            case 'items': items.push(originalItem); break;
            case 'customers': customers.push(originalItem); break;
            case 'suppliers': suppliers.push(originalItem); break;
            case 'purchases': purchases.push(originalItem); break;
            case 'sales': sales.push(originalItem); break;
            case 'expenses': expenses.push(originalItem); break;
            case 'revenues': revenues.push(originalItem); break;
            case 'salaries': salaries.push(originalItem); break;
        }
        
        saveTrashToLocalStorage();
        showNotification(
            'âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
            'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­.',
            'success'
        );
        
        // ØªØ­Ø¯ÙŠØ« Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
        refreshTrashModalIfOpen(type);
        
        return true;
    }

    async function permanentlyDelete(type, itemId) {
        const confirmed = await showConfirmDialog({
            title: 'âš ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ',
            message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ\nâŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!',
            type: 'danger',
            confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
            cancelText: 'Ø¥Ù„ØºØ§Ø¡',
            icon: 'ðŸš«'
        });
        
        if (!confirmed) {
            return false;
        }
        
        const itemIndex = trashBin[type].findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            trashBin[type].splice(itemIndex, 1);
            saveTrashToLocalStorage();
            showNotification(
                'ðŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
                'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ.',
                'info'
            );
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
            refreshTrashModalIfOpen(type);
            
            return true;
        }
        return false;
    }

    function saveTrashToLocalStorage() {
        const key = currentActivityId ? `trash_${currentActivityId}` : 'trash_global';
        localStorage.setItem(key, JSON.stringify(trashBin));
    }

    function loadTrashFromLocalStorage() {
        const key = currentActivityId ? `trash_${currentActivityId}` : 'trash_global';
        const saved = localStorage.getItem(key);
        if (saved) {
            trashBin = JSON.parse(saved);
            cleanOldTrashItems();
        }
    }

    function cleanOldTrashItems() {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        Object.keys(trashBin).forEach(type => {
            trashBin[type] = trashBin[type].filter(item => {
                const deletedDate = new Date(item.deletedAt);
                return deletedDate > thirtyDaysAgo;
            });
        });
        
        saveTrashToLocalStorage();
    }

    function getTrashCount() {
        let count = 0;
        Object.keys(trashBin).forEach(type => {
            count += (trashBin[type] || []).length;
        });
        return count;
    }

    function refreshTrashModalIfOpen(type) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ù…ÙØªÙˆØ­Ø©
        const trashModal = document.getElementById('trash-modal');
        if (trashModal && trashModal.classList.contains('active')) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
            updateTrashBadge();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù„Ù„Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
            // Ù†Ø¬Ø¯ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø·
            const activeTab = document.querySelector('.trash-tab.active');
            if (activeTab) {
                // Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† onclick attribute
                const onclickAttr = activeTab.getAttribute('onclick');
                const match = onclickAttr.match(/renderTrashItems\('([^']+)'\)/);
                if (match) {
                    const currentType = match[1];
                    renderTrashItems(currentType);
                }
            }
        }
    }

    function showTrashModal() {
        loadTrashFromLocalStorage();
        document.getElementById('trash-modal').classList.add('active');
        renderTrashItems('items');
    }

    function closeTrashModal() {
        document.getElementById('trash-modal').classList.remove('active');
    }

    function renderTrashItems(type) {
        const container = document.getElementById('trash-items-container');
        const items = trashBin[type] || [];
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø´Ø·Ø©
        document.querySelectorAll('.trash-tab').forEach(tab => tab.classList.remove('active'));
        event?.target?.classList.add('active');
        
        if (items.length === 0) {
            container.innerHTML = `
                <div class="trash-empty-state">
                    <i>ðŸ—‘ï¸</i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = items.map(item => {
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹Ù‡
            let displayName = item.name || item.code || 'Ø¹Ù†ØµØ±';
            if (type === 'purchases' || type === 'sales' || type === 'salesReturns' || type === 'purchaseReturns') {
                displayName = `ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… ${item.id} - ${item.date || ''}`;
            }
            
            return `
                <div class="trash-item">
                    <div class="trash-item-info">
                        <div class="trash-item-name">${displayName}</div>
                        <div class="trash-item-meta">
                            Ø­Ø°Ù Ø¨ÙˆØ§Ø³Ø·Ø©: ${item.deletedBy} | 
                            ${formatDate(item.deletedAt)}
                        </div>
                    </div>
                    <div class="trash-item-actions">
                        <button class="btn-success btn-sm" onclick="restoreItem('${type}', ${item.id})">
                            â†º Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                        </button>
                        <button class="btn-danger btn-sm" onclick="deleteItemPermanently('${type}', ${item.id})">
                            ðŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function restoreItem(type, itemId) {
        if (restoreFromTrash(type, itemId)) {
            // Ø®Ø±ÙŠØ·Ø© Ø¢Ù…Ù†Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† eval()
            const dataMap = {
                'items': items,
                'customers': customers,
                'suppliers': suppliers,
                'purchases': purchases,
                'sales': sales,
                'expenses': expenses,
                'revenues': revenues,
                'salesReturns': salesReturns,
                'purchaseReturns': purchaseReturns
            };
            
            await saveToFirebase(type, dataMap[type]);
            renderTrashItems(type);
            updateDashboard();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            switch(type) {
                case 'items': renderItems(); break;
                case 'customers': renderCustomers(); break;
                case 'suppliers': renderSuppliers(); break;
                case 'purchases': renderPurchasesList(); break;
                case 'sales': renderSalesList(); break;
                case 'expenses': renderExpenses(); break;
                case 'revenues': renderRevenues(); break;
                case 'salesReturns': renderSalesReturns(); break;
                case 'purchaseReturns': renderPurchaseReturns(); break;
            }
            
            showNotification('âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', `ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© ${getTypeNameAr(type)} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        }
    }

    function deleteItemPermanently(type, itemId) {
        if (permanentlyDelete(type, itemId)) {
            renderTrashItems(type);
        }
    }

    function emptyTrash(type) {
        if (!confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙØ±Ø§Øº Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ù„Ù€ ${getTypeNameAr(type)}ØŸ`)) {
            return;
        }
        
        trashBin[type] = [];
        saveTrashToLocalStorage();
        renderTrashItems(type);
        showNotification(
            'ðŸ—‘ï¸ ØªÙ… Ø¥ÙØ±Ø§Øº Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
            `ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± ${getTypeNameAr(type)} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`,
            'success'
        );
    }

    function getTypeNameAr(type) {
        const names = {
            items: 'Ø§Ù„Ø£ØµÙ†Ø§Ù',
            customers: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',
            suppliers: 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†',
            purchases: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
            sales: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
            expenses: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
            revenues: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',
            salesReturns: 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
            purchaseReturns: 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
            salaries: 'Ø§Ù„Ø±ÙˆØ§ØªØ¨'
        };
        return names[type] || type;
    }

    function updateTrashBadge() {
        const totalCount = getTrashCount();
        const badge = document.getElementById('trash-count-badge');
        
        if (badge) {
            if (totalCount > 0) {
                badge.textContent = totalCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
        ['items', 'customers', 'suppliers', 'purchases', 'sales', 'expenses', 'revenues', 'salesReturns', 'purchaseReturns'].forEach(type => {
            const el = document.getElementById(`trash-count-${type}`);
            if (el) el.textContent = (trashBin[type] || []).length;
        });
        
        const totalEl = document.getElementById('trash-count-total');
        if (totalEl) totalEl.textContent = totalCount;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return 'Ø§Ù„ÙŠÙˆÙ…';
        if (diffDays === 1) return 'Ø£Ù…Ø³';
        if (diffDays < 7) return `Ù…Ù†Ø° ${diffDays} Ø£ÙŠØ§Ù…`;
        if (diffDays < 30) return `Ù…Ù†Ø° ${Math.floor(diffDays / 7)} Ø£Ø³Ø§Ø¨ÙŠØ¹`;
        return date.toLocaleDateString('ar-SA');
    }

    // ===== Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… =====
    
    /**
     * Ù†Ø¸Ø§Ù… Ø´Ø§Ù…Ù„ Ù„ÙÙ„ØªØ±Ø© ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
     */
    const FilterSortHelper = {
        // Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ÙƒÙ„ Ù‚Ø³Ù…
        currentFilters: {},
        
        // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ÙƒÙ„ Ù‚Ø³Ù…
        currentSort: {},
        
        /**
         * ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
         * @param {Array} data - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ÙÙ„ØªØ±ØªÙ‡Ø§
         * @param {Object} filters - Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ±Ø©
         * @returns {Array} - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
         */
        applyFilters(data, filters) {
            if (!data || !Array.isArray(data)) return [];
            
            return data.filter(item => {
                // ÙÙ„ØªØ±Ø© Ø§Ù„Ù†Øµ (Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…)
                if (filters.searchText) {
                    const searchLower = filters.searchText.toLowerCase();
                    const matchFound = Object.values(item).some(value => 
                        value && value.toString().toLowerCase().includes(searchLower)
                    );
                    if (!matchFound) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…Ù†)
                if (filters.dateFrom && item.date) {
                    if (new Date(item.date) < new Date(filters.dateFrom)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø¥Ù„Ù‰)
                if (filters.dateTo && item.date) {
                    if (new Date(item.date) > new Date(filters.dateTo)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø± (Ù…Ù†)
                if (filters.priceFrom !== undefined && filters.priceFrom !== '' && item.price !== undefined) {
                    if (parseFloat(item.price) < parseFloat(filters.priceFrom)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø± (Ø¥Ù„Ù‰)
                if (filters.priceTo !== undefined && filters.priceTo !== '' && item.price !== undefined) {
                    if (parseFloat(item.price) > parseFloat(filters.priceTo)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº (Ù…Ù†)
                if (filters.amountFrom !== undefined && filters.amountFrom !== '' && item.total !== undefined) {
                    if (parseFloat(item.total) < parseFloat(filters.amountFrom)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº (Ø¥Ù„Ù‰)
                if (filters.amountTo !== undefined && filters.amountTo !== '' && item.total !== undefined) {
                    if (parseFloat(item.total) > parseFloat(filters.amountTo)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© (Ù…Ù†)
                if (filters.quantityFrom !== undefined && filters.quantityFrom !== '' && item.quantity !== undefined) {
                    if (parseFloat(item.quantity) < parseFloat(filters.quantityFrom)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© (Ø¥Ù„Ù‰)
                if (filters.quantityTo !== undefined && filters.quantityTo !== '' && item.quantity !== undefined) {
                    if (parseFloat(item.quantity) > parseFloat(filters.quantityTo)) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©/Ø§Ù„Ù†ÙˆØ¹
                if (filters.status && item.status) {
                    if (item.status !== filters.status) return false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
                if (filters.category && item.category) {
                    if (item.category !== filters.category) return false;
                }
                
                return true;
            });
        },
        
        /**
         * ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø¹Ù…ÙˆØ¯ Ù…Ø¹ÙŠÙ†
         * @param {Array} data - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ±ØªÙŠØ¨Ù‡Ø§
         * @param {String} column - Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯
         * @param {String} direction - Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªØ±ØªÙŠØ¨ (asc/desc)
         * @returns {Array} - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø©
         */
        sortData(data, column, direction = 'asc') {
            if (!data || !Array.isArray(data)) return [];
            
            const sortedData = [...data].sort((a, b) => {
                let valueA = a[column];
                let valueB = b[column];
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ§Ø±ØºØ©
                if (valueA === null || valueA === undefined) valueA = '';
                if (valueB === null || valueB === undefined) valueB = '';
                
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
                if (!isNaN(valueA) && !isNaN(valueB)) {
                    valueA = parseFloat(valueA);
                    valueB = parseFloat(valueB);
                }
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
                else if (this.isDate(valueA) && this.isDate(valueB)) {
                    valueA = new Date(valueA);
                    valueB = new Date(valueB);
                }
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†ØµÙˆØµ
                else {
                    valueA = valueA.toString().toLowerCase();
                    valueB = valueB.toString().toLowerCase();
                }
                
                if (valueA < valueB) return direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            return sortedData;
        },
        
        /**
         * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© ØªØ§Ø±ÙŠØ®
         */
        isDate(value) {
            return value && !isNaN(Date.parse(value)) && /\d{4}-\d{2}-\d{2}/.test(value);
        },
        
        /**
         * Ø¥Ø¶Ø§ÙØ© Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ±ØªÙŠØ¨ Ù„Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
         * @param {String} tableId - Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„
         * @param {String} section - Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…
         * @param {Function} renderCallback - Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
         */
        makeSortable(tableId, section, renderCallback) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const headers = table.querySelectorAll('thead th.sortable');
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-column');
                    if (!column) return;
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªØ±ØªÙŠØ¨
                    let direction = 'asc';
                    if (this.currentSort[section]?.column === column) {
                        direction = this.currentSort[section].direction === 'asc' ? 'desc' : 'asc';
                    }
                    
                    // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±ØªÙŠØ¨
                    this.currentSort[section] = { column, direction };
                    
                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                    headers.forEach(h => {
                        h.classList.remove('asc', 'desc');
                    });
                    header.classList.add(direction);
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
                    if (renderCallback) renderCallback();
                });
            });
        },
        
        /**
         * Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø©
         */
        toggleFilters(filterId) {
            const filtersContainer = document.getElementById(filterId);
            if (filtersContainer) {
                filtersContainer.classList.toggle('show');
            }
        },
        
        /**
         * Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±
         */
        resetFilters(section, filterId) {
            this.currentFilters[section] = {};
            const filtersContainer = document.getElementById(filterId);
            if (filtersContainer) {
                const inputs = filtersContainer.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            }
        }
    };
    
    // ===== Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Input Validation) =====
    
    /**
     * Ù…Ø¬Ù…ÙˆØ¹Ø© Ø´Ø§Ù…Ù„Ø© Ù…Ù† Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
     */
    const ValidationHelper = {
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø­Ù‚Ù„ Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹
        required(value, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            if (!value || value.toString().trim() === '') {
                return `âŒ ${fieldName} Ù…Ø·Ù„ÙˆØ¨ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø·ÙˆÙ„
        minLength(value, min, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            if (value && value.toString().trim().length < min) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${min} Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·ÙˆÙ„
        maxLength(value, max, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            if (value && value.toString().length > max) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² ${max} Ø­Ø±ÙØ§Ù‹`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø±Ù‚Ù… ØµØ­ÙŠØ­
        isNumber(value, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            if (value !== '' && isNaN(parseFloat(value))) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨
        isPositive(value, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            const num = parseFloat(value);
            if (!isNaN(num) && num < 0) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹ Ù…ÙˆØ¬Ø¨Ø§Ù‹`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù‚Ù… Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±
        isGreaterThanZero(value, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            const num = parseFloat(value);
            if (!isNaN(num) && num <= 0) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù‚Ù… Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ Ù…Ø¹ÙŠÙ†
        inRange(value, min, max, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„') {
            const num = parseFloat(value);
            if (!isNaN(num) && (num < min || num > max)) {
                return `âŒ ${fieldName} ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† ${min} Ùˆ ${max}`;
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        isEmail(value, fieldName = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') {
            if (value && value.trim() !== '') {
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailPattern.test(value)) {
                    return `âŒ ${fieldName} ØºÙŠØ± ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„: user@example.com)`;
                }
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ
        isSaudiPhone(value, fieldName = 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') {
            if (value && value.trim() !== '') {
                const phonePattern = /^(05|5)[0-9]{8}$/;
                if (!phonePattern.test(value.replace(/\s/g, ''))) {
                    return `âŒ ${fieldName} ØºÙŠØ± ØµØ­ÙŠØ­ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù…)`;
                }
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø©
        isUnique(value, list, field, fieldName = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„', excludeId = null) {
            if (value && value.trim() !== '') {
                const exists = list.some(item => {
                    const isDifferentItem = excludeId ? item.id !== excludeId : true;
                    return isDifferentItem && item[field] && 
                           item[field].toString().toLowerCase() === value.toString().toLowerCase();
                });
                
                if (exists) {
                    return `âŒ ${fieldName} Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ…Ø© Ù…Ø®ØªÙ„ÙØ©`;
                }
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
        isValidDate(value, fieldName = 'Ø§Ù„ØªØ§Ø±ÙŠØ®') {
            if (value && value.trim() !== '') {
                const date = new Date(value);
                if (isNaN(date.getTime())) {
                    return `âŒ ${fieldName} ØºÙŠØ± ØµØ­ÙŠØ­`;
                }
            }
            return null;
        },
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ÙŠØ³ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
        notFutureDate(value, fieldName = 'Ø§Ù„ØªØ§Ø±ÙŠØ®') {
            if (value && value.trim() !== '') {
                const date = new Date(value);
                const today = new Date();
                today.setHours(23, 59, 59, 999);
                
                if (date > today) {
                    return `âŒ ${fieldName} Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„`;
                }
            }
            return null;
        }
    };
    
    /**
     * Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ù†Ù…ÙˆØ°Ø¬
     * @param {Object} validations - ÙƒØ§Ø¦Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚
     * @returns {Object} - { isValid: boolean, errors: Array }
     */
    function validateForm(validations) {
        const errors = [];
        
        for (const [fieldId, rules] of Object.entries(validations)) {
            const element = document.getElementById(fieldId);
            if (!element) continue;
            
            const value = element.value;
            let hasError = false;
            
            // ØªØ·Ø¨ÙŠÙ‚ ÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© ØªØ­Ù‚Ù‚
            for (const rule of rules) {
                const error = rule.validator(value);
                if (error) {
                    errors.push({
                        fieldId,
                        element,
                        message: error
                    });
                    hasError = true;
                    break; // Ø¥ÙŠÙ‚Ø§Ù Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø®Ø·Ø£ Ù„ÙƒÙ„ Ø­Ù‚Ù„
                }
            }
            
            // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
            if (hasError) {
                element.classList.add('input-error');
                element.classList.remove('input-success');
            } else if (value && value.trim() !== '') {
                element.classList.add('input-success');
                element.classList.remove('input-error');
            } else {
                element.classList.remove('input-error', 'input-success');
            }
        }
        
        return {
            isValid: errors.length === 0,
            errors
        };
    }
    
    /**
     * Ø¹Ø±Ø¶ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
     */
    function displayValidationErrors(errors) {
        if (errors.length === 0) return;
        
        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø­Ù‚Ù„ Ø®Ø§Ø·Ø¦
        if (errors[0].element) {
            errors[0].element.focus();
            errors[0].element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø¥Ø´Ø¹Ø§Ø±
        const errorMessages = errors.map(e => e.message).join('\n');
        showNotification(
            'âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ§Ù„ÙŠØ©',
            errorMessages,
            'error',
            6000
        );
    }
    
    /**
     * Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
     */
    function clearValidationStyles() {
        document.querySelectorAll('.input-error, .input-success').forEach(el => {
            el.classList.remove('input-error', 'input-success');
        });
    }

    // ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Professional Confirm Dialog) =====
    
    /**
     * Ø¹Ø±Ø¶ Ø­ÙˆØ§Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ø­ØªØ±Ø§ÙÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† confirm() Ø§Ù„Ø¹Ø§Ø¯ÙŠ
     * @param {Object} options - Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­ÙˆØ§Ø±
     * @param {string} options.title - Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­ÙˆØ§Ø±
     * @param {string} options.message - Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
     * @param {string} options.type - Ù†ÙˆØ¹ Ø§Ù„Ø­ÙˆØ§Ø± (warning, danger, info, success)
     * @param {string} options.confirmText - Ù†Øµ Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
     * @param {string} options.cancelText - Ù†Øµ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
     * @param {string} options.icon - Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­ÙˆØ§Ø±
     * @returns {Promise<boolean>} - true Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ØŒ false Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡
     */
    function showConfirmDialog(options = {}) {
        return new Promise((resolve) => {
            const {
                title = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',
                message = 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ',
                type = 'warning', // warning, danger, info, success
                confirmText = 'ØªØ£ÙƒÙŠØ¯',
                cancelText = 'Ø¥Ù„ØºØ§Ø¡',
                icon = null
            } = options;
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø­ÙˆØ§Ø±
            const overlay = document.getElementById('confirm-overlay');
            const header = document.getElementById('confirm-header');
            const iconEl = document.getElementById('confirm-icon');
            const titleEl = document.getElementById('confirm-title');
            const bodyEl = document.getElementById('confirm-body');
            const confirmBtn = document.getElementById('confirm-btn-confirm');
            const cancelBtn = document.getElementById('confirm-btn-cancel');
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            const icons = {
                warning: 'âš ï¸',
                danger: 'âŒ',
                info: 'â„¹ï¸',
                success: 'âœ…'
            };
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            iconEl.textContent = icon || icons[type] || 'âš ï¸';
            titleEl.textContent = title;
            bodyEl.textContent = message;
            confirmBtn.textContent = confirmText;
            cancelBtn.textContent = cancelText;
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙØ¦Ø§Øª
            header.className = `confirm-header ${type}`;
            confirmBtn.className = `confirm-btn-confirm ${type === 'danger' ? 'danger' : type === 'success' ? 'success' : ''}`;
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø­ÙˆØ§Ø±
            overlay.classList.add('active');
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            const handleConfirm = () => {
                overlay.classList.remove('active');
                cleanup();
                resolve(true);
            };
            
            const handleCancel = () => {
                overlay.classList.remove('active');
                cleanup();
                resolve(false);
            };
            
            const handleOverlayClick = (e) => {
                if (e.target === overlay) {
                    handleCancel();
                }
            };
            
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    handleCancel();
                }
            };
            
            const cleanup = () => {
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
                overlay.removeEventListener('click', handleOverlayClick);
                document.removeEventListener('keydown', handleEscape);
            };
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
            overlay.addEventListener('click', handleOverlayClick);
            document.addEventListener('keydown', handleEscape);
        });
    }
    
    // ===== Ù†Ù‡Ø§ÙŠØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ =====

        // === Ø¯ÙˆØ§Ù„ Firebase Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ===
        async function firebaseSet(key, data) {
            try {
                await database.ref(key).set(data);
                return true;
            } catch (error) {
                logError('Firebase Set', error, false);
                console.error('Firebase set error:', error);
                return false;
            }
        }

        async function firebaseGet(key) {
            try {
                const snapshot = await database.ref(key).once('value');
                return snapshot.val();
            } catch (error) {
                logError('Firebase Get', error, false);
                console.error('Firebase get error:', error);
                return null;
            }
        }

        async function firebaseRemove(key) {
            try {
                await database.ref(key).remove();
                return true;
            } catch (error) {
                logError('Firebase Remove', error, false);
                console.error('Firebase remove error:', error);
                return false;
            }
        }

        async function saveToFirebase(key, data) {
            if (!currentActivityId) return false;

            try {
                const sharedKey = `${FIREBASE_SHARED_ROOT}/${currentActivityId}/${key}`;
                const sharedSaved = await firebaseSet(sharedKey, data);

                const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                if (sharedSaved && currentUser && currentUser.email) {
                    const legacyKey = `users/${currentUser.email.replace('.', '_')}/activities/${currentActivityId}/${key}`;
                    await firebaseSet(legacyKey, data);
                }

                return sharedSaved;
            } catch (error) {
                logError('Save to Firebase', error);
                return false;
            }
        }

        async function loadFromFirebase(key) {
            if (!currentActivityId) return null;

            const sharedKey = `${FIREBASE_SHARED_ROOT}/${currentActivityId}/${key}`;
            let data = await firebaseGet(sharedKey);
            if (data !== null && data !== undefined) {
                return data;
            }

            const legacyEmails = [];
            const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (currentUser && currentUser.email) {
                legacyEmails.push(currentUser.email);
            }
            if (Array.isArray(users)) {
                users.forEach(u => {
                    if (u.email && !legacyEmails.includes(u.email)) {
                        legacyEmails.push(u.email);
                    }
                });
            }

            for (const email of legacyEmails) {
                const legacyKey = `users/${email.replace('.', '_')}/activities/${currentActivityId}/${key}`;
                data = await firebaseGet(legacyKey);
                if (data !== null && data !== undefined) {
                    await firebaseSet(sharedKey, data);
                    return data;
                }
            }

            return null;
        }

        async function removeFromFirebase(key) {
            if (!currentActivityId) return false;

            const sharedKey = `${FIREBASE_SHARED_ROOT}/${currentActivityId}/${key}`;
            const sharedRemoved = await firebaseRemove(sharedKey);

            const legacyResults = [];
            if (Array.isArray(users)) {
                for (const user of users) {
                    if (user.email) {
                        const legacyKey = `users/${user.email.replace('.', '_')}/activities/${currentActivityId}/${key}`;
                        const result = await firebaseRemove(legacyKey);
                        legacyResults.push(result);
                    }
                }
            }

            if (legacyResults.length === 0) {
                return sharedRemoved;
            }

            return sharedRemoved && legacyResults.every(r => r !== false);
        }

        // === Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© ===
        async function saveActivities() {
            const success = await firebaseSet('diwan_activities', activities);
            if (success) {
                loadActivities();
            }
        }

        async function saveUsers() {
            await firebaseSet('diwan_users', users);
        }

       async function loadUsers() {
    users = (await firebaseGet('diwan_users')) || [];
    
    // â¬‡ï¸ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ â¬‡ï¸
    // Ø£ØµØ¨Ø­ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„ÙŠÙ‡ ÙÙ‚Ø· ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¯ÙŠØ±
    // ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
    if (users.length === 0) {
        console.warn("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†. ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ 'Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…' (admin) Ø¬Ø¯ÙŠØ¯.");
        // ÙŠÙ…ÙƒÙ†Ùƒ ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¥Ø¯Ø§Ø±ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        // ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ø³Ù†ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    }
}

        // === Ø¯ÙˆØ§Ù„ ØªØ®ØµÙŠØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===
        function toggleControlPanel() {
            const panel = document.getElementById('controlPanel');
            panel.classList.toggle('show');
        }

        function updateFontSize(size) {
            document.documentElement.style.setProperty('--font-size', size + 'px');
            document.getElementById('font-size-value').textContent = size + 'px';
        }

        function updateColor(variable, color) {
            document.documentElement.style.setProperty(variable, color);
        }

        function updateFontFamily(font) {
            document.documentElement.style.setProperty('--font-family', font);
        }

        function resetDesign() {
            document.documentElement.style.setProperty('--primary-color', '#2c5aa0');
            document.documentElement.style.setProperty('--bg-color', '#ecf0f1');
            document.documentElement.style.setProperty('--text-color', '#2c3e50');
            document.documentElement.style.setProperty('--font-size', '16px');
            document.documentElement.style.setProperty('--font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif");
            
            document.querySelector('input[type="range"]').value = 16;
            document.getElementById('font-size-value').textContent = '16px';
            document.querySelector('input[value="#2c5aa0"]').value = '#2c5aa0';
            document.querySelector('input[value="#ecf0f1"]').value = '#ecf0f1';
            document.querySelector('input[value="#2c3e50"]').value = '#2c3e50';
            document.getElementById('fontFamilySelect').value = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        }

        // === ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ù‡ÙˆØ§ØªÙ ===
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        function updateAccountInfoSection(user) {
            const nameEl = document.getElementById('accountInfoName');
            const emailEl = document.getElementById('accountInfoEmail');
            const phoneEl = document.getElementById('accountInfoPhone');
            const roleEl = document.getElementById('accountInfoRole');
            const activityEl = document.getElementById('accountInfoActivity');
            const changeActivityAccountBtn = document.getElementById('accountInfoChangeActivityBtn');
            const editAccountBtn = document.getElementById('accountInfoEditBtn');

            const fallbackText = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            const fallbackActivity = 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø·';
            if (nameEl) {
                const hasName = user && user.name && user.name.trim();
                nameEl.textContent = hasName ? user.name : (user && user.email ? user.email : fallbackText);
            }
            if (emailEl) {
                emailEl.textContent = user && user.email ? user.email : fallbackText;
            }
            if (phoneEl) {
                const hasPhone = user && user.phone && user.phone.trim();
                phoneEl.textContent = hasPhone ? user.phone : fallbackText;
            }
            if (roleEl) {
                if (user && user.role) {
                    const roleNames = { admin: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', manager: 'Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·', user: 'Ù…Ø³ØªØ®Ø¯Ù…' };
                    roleEl.textContent = roleNames[user.role] || 'Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                } else {
                    roleEl.textContent = fallbackText;
                }
            }
            if (activityEl) {
                let activityName = fallbackActivity;
                if (currentActivityId) {
                    const activity = activities.find(a => a.id == currentActivityId);
                    activityName = activity ? activity.name : 'Ù†Ø´Ø§Ø· ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                }
                activityEl.textContent = activityName;
            }
            if (changeActivityAccountBtn) {
                const showChange = (user && user.role === 'admin');
                changeActivityAccountBtn.style.display = showChange ? 'block' : 'none';
                if (changeActivityAccountBtn.parentElement) {
                    changeActivityAccountBtn.parentElement.style.display = showChange ? 'flex' : 'none';
                }
            }
            if (editAccountBtn) {
                const showEdit = Boolean(user);
                editAccountBtn.style.display = showEdit ? 'block' : 'none';
                if (editAccountBtn.parentElement) {
                    editAccountBtn.parentElement.style.display = showEdit ? 'flex' : 'none';
                }
            }
        }

        function updateSidebar(role) {
            const sidebarNav = document.getElementById('sidebarNav');
            if (!sidebarNav) return;

            // Refreshes the navigation menu according to the signed-in role.
            const baseSections = [
                { id: 'home', label: 'ðŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' },
                { id: 'advanced-dashboard', label: 'ðŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©' },
                { id: 'items', label: 'ðŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù' },
                { id: 'customers', label: 'ðŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' },
                { id: 'suppliers', label: 'ðŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†' },
                { id: 'purchases', label: 'ðŸ›’ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª' },
                { id: 'sales', label: 'ðŸ’° ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª' },
                { id: 'returns', label: 'â†©ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª' },
                { id: 'expenses', label: 'ðŸ’¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª' },
                { id: 'revenues', label: 'ðŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª' },
                { id: 'advances', label: 'ðŸ’³ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù' },
                { id: 'sadaqa', label: 'ðŸ¤² Ø­Ø³Ø§Ø¨ Ø§Ù„ØµØ¯Ù‚Ø©' },
                { id: 'salaries', label: 'ðŸ’¼ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨' },
                { id: 'reports', label: 'ðŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±' },
                { id: 'settings', label: 'âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù†Ø¸Ø§Ù…' }
            ];

            let sectionsToRender;
            if (role === 'admin') {
                sectionsToRender = baseSections;
            } else if (role === 'manager') {
                sectionsToRender = baseSections.filter(section => section.id !== 'advanced-dashboard');
            } else if (role === 'user') {
                sectionsToRender = baseSections.filter(section => !['advanced-dashboard', 'settings', 'salaries'].includes(section.id));
            } else {
                sectionsToRender = baseSections.filter(section => !['advanced-dashboard', 'salaries'].includes(section.id));
            }

            sidebarNav.innerHTML = '';
            sectionsToRender.forEach(section => {
                const button = document.createElement('button');
                button.textContent = section.label;
                button.setAttribute('onclick', `showSection('${section.id}')`);
                sidebarNav.appendChild(button);
            });
            // Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø§Ù„ØµØ¯Ù‚Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (!document.getElementById('sadaqa')) {
                const container = document.querySelector('.container');
                if (container) {
                    const sadaqaSection = document.createElement('div');
                    sadaqaSection.id = 'sadaqa';
                    sadaqaSection.className = 'section';
                    sadaqaSection.innerHTML = `
                        <h2>ðŸ¤² Ø­Ø³Ø§Ø¨ Ø§Ù„ØµØ¯Ù‚Ø©</h2>
                        <div class="form-grid grid-3">
                            <input type="number" id="sadaqaAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„) *" min="1" required>
                            <input type="date" id="sadaqaDate" required>
                            <input type="text" id="sadaqaDesc" placeholder="ÙˆØµÙ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯">
                            <button class="btn-primary btn-add" onclick="addSadaqa()">âž• Ø¥Ø¶Ø§ÙØ© ØµØ¯Ù‚Ø©</button>
                        </div>
                        <div id="sadaqaList" style="margin-top:2em;"></div>
                        <div id="sadaqaTotal" style="margin-top:1em; font-weight:bold;"></div>
                    `;
                    container.appendChild(sadaqaSection);
                    // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø³Ù…
                    setTimeout(() => { window.renderSadaqaList(); }, 0);
                }
            }
            // Ø¯ÙˆØ§Ù„ Ø§Ù„ØµØ¯Ù‚Ø©
            window.addSadaqa = function() {
                const amount = parseFloat(document.getElementById('sadaqaAmount').value);
                const date = document.getElementById('sadaqaDate').value;
                const desc = document.getElementById('sadaqaDesc').value;
                if (!amount || !date) {
                    showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®', 'error');
                    return;
                }
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                sadaqat.push({ amount, date, desc });
                localStorage.setItem('sadaqat', JSON.stringify(sadaqat));
                document.getElementById('sadaqaAmount').value = '';
                document.getElementById('sadaqaDate').value = '';
                document.getElementById('sadaqaDesc').value = '';
                renderSadaqaList();
            };
            window.renderSadaqaList = function() {
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                let html = '<table border="1" style="width:100%;text-align:center"><tr><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th style="text-align:left">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>';
                let total = 0;
                sadaqat.forEach((s, i) => {
                    html += `<tr>
                        <td>${s.amount}</td>
                        <td>${s.date}</td>
                        <td>${s.desc || ''}</td>
                        <td style='text-align:left'>
                            <div class='action-buttons' style='justify-content: flex-start;'>
                                <button class='btn-warning edit-btn' onclick="editSadaqa(${i})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class='btn-danger' onclick="deleteSadaqa(${i})">Ø­Ø°Ù</button>
                            </div>
                        </td>
                    </tr>`;
                    total += s.amount;
                });
                html += '</table>';
                document.getElementById('sadaqaList').innerHTML = html;
                document.getElementById('sadaqaTotal').innerText = 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ¯Ù‚Ø§Øª: ' + total + ' Ø±ÙŠØ§Ù„';
            };
            // Ø­Ø°Ù Ø³Ø¬Ù„ ØµØ¯Ù‚Ø©
            window.deleteSadaqa = function(idx) {
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) {
                    sadaqat.splice(idx, 1);
                    localStorage.setItem('sadaqat', JSON.stringify(sadaqat));
                    renderSadaqaList();
                }
            };
            // ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„ ØµØ¯Ù‚Ø©
            window.editSadaqa = function(idx) {
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                const s = sadaqat[idx];
                document.getElementById('sadaqaAmount').value = s.amount;
                document.getElementById('sadaqaDate').value = s.date;
                document.getElementById('sadaqaDesc').value = s.desc;
                // Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ØŒ Ù†Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…
                window._sadaqaEditIdx = idx;
                const btn = document.querySelector('#sadaqa .btn-add');
                if (btn) {
                    btn.textContent = 'ðŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
                    btn.onclick = function() {
                        const amount = parseFloat(document.getElementById('sadaqaAmount').value);
                        const date = document.getElementById('sadaqaDate').value;
                        const desc = document.getElementById('sadaqaDesc').value;
                        if (!amount || !date) {
                            showNotification('âš ï¸ Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®', 'error');
                            return;
                        }
                        sadaqat[idx] = { amount, date, desc };
                        localStorage.setItem('sadaqat', JSON.stringify(sadaqat));
                        renderSadaqaList();
                        document.getElementById('sadaqaAmount').value = '';
                        document.getElementById('sadaqaDate').value = '';
                        document.getElementById('sadaqaDesc').value = '';
                        btn.textContent = 'âž• Ø¥Ø¶Ø§ÙØ© ØµØ¯Ù‚Ø©';
                        btn.onclick = addSadaqa;
                        window._sadaqaEditIdx = null;
                    };
                }
            };
            // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø³Ù…
            if (!window._sadaqaListLoaded) {
                document.addEventListener('DOMContentLoaded', window.renderSadaqaList);
                window._sadaqaListLoaded = true;
            }

            const activeSection = document.querySelector('.section.active');
            if (activeSection) {
                const activeButton = sidebarNav.querySelector(`button[onclick="showSection('${activeSection.id}')"]`);
                if (activeButton) {
                    activeButton.classList.add('active');
                }
            }
        }

        function updateLoggedInUserDisplay(user) {
            const userEl = document.getElementById('currentUserDisplay');
            if (userEl) {
                if (user) {
                    const displayName = (user.name && user.name.trim()) ? user.name : user.email || 'Ù…Ø³ØªØ®Ø¯Ù…';
                    const roleInfo = {
                        admin: { label: 'ðŸ”‘ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', cls: 'role-admin' },
                        manager: { label: 'ðŸ§­ Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·', cls: 'role-manager' },
                        user: { label: 'ðŸ‘¨â€ðŸ’¼ Ù…Ø³ØªØ®Ø¯Ù…', cls: 'role-user' }
                    };
                    const currentRole = roleInfo[user.role] || { label: 'Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', cls: '' };
                    userEl.innerHTML = `<span class="user-name">ðŸ‘¤ ${displayName}</span><span class="user-description">${currentRole.label}</span>`;
                    userEl.classList.remove('role-admin', 'role-manager', 'role-user');
                    if (currentRole.cls) {
                        userEl.classList.add(currentRole.cls);
                    }
                } else {
                    userEl.innerHTML = '<span class="user-name">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span><span class="user-description">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„</span>';
                    userEl.classList.remove('role-admin', 'role-manager', 'role-user');
                }
            }

            updateAccountInfoSection(user);
        }

        // === Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ===
       function showSection(sectionId) {
    if (editingSaleId || editingPurchaseId) {
        if (!confirm('Ù„Ø¯ÙŠÙƒ ÙØ§ØªÙˆØ±Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ØŸ')) {
            return;
        }
        resetInvoiceForms();
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    document.querySelectorAll('.sidebar-nav button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙ‚Ø·
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø· ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    const activeButton = Array.from(document.querySelectorAll('.sidebar-nav button')).find(
        btn => btn.getAttribute('onclick') === `showSection('${sectionId}')`
    );
    if(activeButton) activeButton.classList.add('active');

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
    if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('open');
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØµØºØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
    if (sectionId === 'items') {
        const miniStatItemsEl = document.getElementById('miniStatItems');
        if (miniStatItemsEl) miniStatItemsEl.textContent = items.length;
        renderItems();
        generateItemCode();
    }
    else if (sectionId === 'customers') {
        const miniStatCustomersEl = document.getElementById('miniStatCustomers');
        if (miniStatCustomersEl) miniStatCustomersEl.textContent = customers.length;
        renderCustomers();
        generateCustomerCode();
    }
    else if (sectionId === 'suppliers') {
        const miniStatSuppliersEl = document.getElementById('miniStatSuppliers');
        if (miniStatSuppliersEl) miniStatSuppliersEl.textContent = suppliers.length;
        renderSuppliers();
        generateSupplierCode();
    }
    else if (sectionId === 'purchases') {
        const miniStatPurchasesEl = document.getElementById('miniStatPurchases');
        if (miniStatPurchasesEl) miniStatPurchasesEl.textContent = purchases.length;
        updatePurchaseDropdowns();
        generatePurchaseCode();
        const purchaseDateEl = document.getElementById('purchaseDate');
        if (purchaseDateEl) purchaseDateEl.value = new Date().toISOString().split('T')[0];
    }
    else if (sectionId === 'sales') {
        const miniStatSalesEl = document.getElementById('miniStatSales');
        if (miniStatSalesEl) miniStatSalesEl.textContent = sales.length;
        updateSaleDropdowns();
        generateSaleCode();
        const saleDateEl = document.getElementById('saleDate');
        if (saleDateEl) saleDateEl.value = new Date().toISOString().split('T')[0];
    }
    else if (sectionId === 'expenses') {
        const miniStatExpensesEl = document.getElementById('miniStatExpenses');
        if (miniStatExpensesEl) miniStatExpensesEl.textContent = expenses.length;
        updateExpenseStats();
        renderExpenses();
        const expenseDateEl = document.getElementById('expenseDate');
        if (expenseDateEl) expenseDateEl.value = new Date().toISOString().split('T')[0];
    } else if (sectionId === 'revenues') {
        const miniStatRevenuesEl = document.getElementById('miniStatRevenues');
        if (miniStatRevenuesEl) miniStatRevenuesEl.textContent = revenues.length;
        updateRevenueStats();
        renderRevenues();
        const revenueDateEl = document.getElementById('revenueDate');
        if (revenueDateEl) revenueDateEl.value = new Date().toISOString().split('T')[0];
    } else if (sectionId === 'salaries') {
        renderSalaries();
        updateSalarySummary();
    } else if (sectionId === 'advances') {
        const miniStatAdvancesEl = document.getElementById('miniStatAdvances');
        if (miniStatAdvancesEl) miniStatAdvancesEl.textContent = advances.length;
        renderAdvances();
        updateAdvanceStats();
        setupAdvanceSearch();
        const advanceDateEl = document.getElementById('advanceDate');
        if (advanceDateEl) advanceDateEl.value = new Date().toISOString().split('T')[0];
 
    } else if (sectionId === 'advanced-dashboard') {
        initAdvancedDashboard();
    } else if (sectionId === 'returns') {
        showReturnTab('sales');
    } else if (sectionId === 'settings') {
        const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        if (loggedInUser && loggedInUser.role === 'admin') {
            document.getElementById('userManagementSection').style.display = 'block';
            document.getElementById('activityManagementSection').style.display = 'block';
            
        } else {
            document.getElementById('userManagementSection').style.display = 'none';
            document.getElementById('activityManagementSection').style.display = 'none';
        }
        if (loggedInUser && (loggedInUser.role === 'admin' || loggedInUser.role === 'manager')) {
            document.getElementById('activityLogoSection').style.display = 'block';
        } else {
            document.getElementById('activityLogoSection').style.display = 'none';
        }
    }
}
        // ===== Activity and Header Functions =====
        function updateHeaderForActivity(activity) {
            if (activity) {
                document.getElementById('activityHeaderTitle').textContent = activity.name;
                document.getElementById('activityHeaderSubtitle').style.display = 'none';
                
                // Load activity logo
                loadActivityLogo();
            } else {
                document.getElementById('activityHeaderTitle').textContent = 'Ø¯ÙŠÙˆØ§Ù†ÙŠ';
                document.getElementById('activityHeaderSubtitle').style.display = 'block';
                
                // Hide activity logo
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) headerLogo.style.display = 'none';
            }

            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            updateAccountInfoSection(loggedInUser);
        }
        
        function getActivityDataKey(baseKey) {
            if (!currentActivityId) return null;
            return `activity_${currentActivityId}_${baseKey}`;
        }
        
        async function loadActivities() {
            activities = (await firebaseGet('diwan_activities')) || [];
            const activitySelect = document.getElementById('userActivitySelect');
            if (activitySelect) {
                activitySelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø£ÙˆÙ„Ø§Ù‹ --</option>';
                activities.forEach(act => {
                    activitySelect.innerHTML += `<option value="${act.id}">${act.name}</option>`;
                });
            }
        }

        async function saveActivities() {
            const success = await firebaseSet('diwan_activities', activities);
            if (success) {
                loadActivities();
            }
        }
        
        function showActivityModal() {
            document.getElementById('activity-overlay').style.display = 'flex';
            document.querySelector('.app-container').style.display = 'none';
            renderActivitiesInModal();
        }
        
        function renderActivitiesInModal() {
            const listDiv = document.getElementById('activity-list');
            listDiv.innerHTML = '';
            if (activities.length === 0) {
                listDiv.innerHTML = '<p>Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯. Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯ Ù„Ù„Ø¨Ø¯Ø¡.</p>';
            } else {
                activities.forEach(activity => {
                    const button = document.createElement('button');
                    button.className = 'btn-primary activity-btn';
                    button.textContent = activity.name;
                    button.onclick = () => selectActivity(activity.id);
                    listDiv.appendChild(button);
                });
            }
        }
        
        async function addNewActivity(fromSettings = false) {
            const inputId = fromSettings ? 'settingNewActivityName' : 'newActivityName';
            const activityName = document.getElementById(inputId).value.trim();
            if (!activityName) {
                showNotification('âš ï¸ Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„Ù†Ø´Ø§Ø·', 'warning');
                return;
            }

            const newActivity = {
                id: Date.now(),
                name: activityName
            };
            activities.push(newActivity);
            await saveActivities();
            document.getElementById(inputId).value = '';

            if (fromSettings) {
                renderActivitiesInSettings();
            } else {
                selectActivity(newActivity.id);
            }
        }
        
        async function selectActivity(id) {
            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·...');
            
            try {
                currentActivityId = id;
                sessionStorage.setItem('currentActivityId', id);
                const activity = activities.find(a => a.id == id);
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ sessionStorage Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø±
                if (activity) {
                    sessionStorage.setItem('currentActivity', JSON.stringify(activity));
                }
                
                updateHeaderForActivity(activity);
                document.getElementById('activity-overlay').style.display = 'none';
                document.querySelector('.app-container').style.display = 'flex';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø´Ø§Ø·
                const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
                if (user) {
                    updateSidebar(user.role);
                }

                await initializeApp();
                hideLoading();
            } catch (error) {
                hideLoading();
                logError('Select Activity', error);
            }
        }
        
        function renderActivitiesInSettings() {
            const dropdown = document.getElementById('activitiesDropdown');
            if (!dropdown) return;

            const previousSelection = dropdown.value;
            dropdown.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù†Ø´Ø§Ø·Ù‹Ø§</option>';

            activities.forEach(activity => {
                const option = document.createElement('option');
                option.value = activity.id;
                option.textContent = activity.name;
                dropdown.appendChild(option);
            });

            if (previousSelection && activities.some(a => String(a.id) === previousSelection)) {
                dropdown.value = previousSelection;
            } else {
                dropdown.value = '';
            }

            handleActivitySelection();
        }

        function handleActivitySelection() {
            const dropdown = document.getElementById('activitiesDropdown');
            const infoBox = document.getElementById('selectedActivityInfo');
            const nameInput = document.getElementById('selectedActivityName');
            const editBtn = document.getElementById('editSelectedActivityBtn');
            const deleteBtn = document.getElementById('deleteSelectedActivityBtn');

            if (!dropdown) return;

            const selectedId = dropdown.value;
            const activity = activities.find(a => String(a.id) === selectedId);

            if (!activity) {
                if (infoBox) infoBox.style.display = 'none';
                if (nameInput) nameInput.value = '';
                if (editBtn) editBtn.disabled = true;
                if (deleteBtn) deleteBtn.disabled = true;
                return;
            }

            if (infoBox) infoBox.style.display = 'flex';
            if (nameInput) nameInput.value = activity.name;
            if (editBtn) editBtn.disabled = false;
            if (deleteBtn) deleteBtn.disabled = false;
        }

        function handleEditSelectedActivity() {
            const dropdown = document.getElementById('activitiesDropdown');
            if (!dropdown || !dropdown.value) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø´Ø§Ø· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'warning');
                return;
            }
            const activityId = Number(dropdown.value);
            if (!Number.isNaN(activityId)) {
                editActivity(activityId);
            }
        }

        function handleDeleteSelectedActivity() {
            const dropdown = document.getElementById('activitiesDropdown');
            if (!dropdown || !dropdown.value) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø´Ø§Ø· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'warning');
                return;
            }
            const activityId = Number(dropdown.value);
            if (!Number.isNaN(activityId)) {
                deleteActivity(activityId);
            }
        }

        async function editActivity(id) {
            const activityIndex = activities.findIndex(a => a.id === id);
            if (activityIndex === -1) return;

            const currentName = activities[activityIndex].name;
            const newName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù†Ø´Ø§Ø·:", currentName);

            if (newName && newName.trim() !== "" && newName.trim() !== currentName) {
                activities[activityIndex].name = newName.trim();
                await saveActivities();
                renderActivitiesInSettings();
                
                if (currentActivityId == id) {
                    updateHeaderForActivity(activities[activityIndex]);
                }
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        }
        
        async function deleteActivity(id) {
            if (id == currentActivityId) {
                showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…ÙØªÙˆØ­ Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø· Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            const activity = activities.find(a => a.id === id);
            const confirmed = await showConfirmDialog(
                'Ø­Ø°Ù Ø§Ù„Ù†Ø´Ø§Ø· Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
                `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù†Ø´Ø§Ø· "${activity.name}"ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`,
                'danger',
                'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                const dataKeys = ['items', 'customers', 'suppliers', 'purchases', 'sales', 'salesReturns', 'purchaseReturns', 'expenses', 'revenues', 'lastBackup'];
                for (const key of dataKeys) {
                    await removeFromFirebase(key);
                }
                activities = activities.filter(a => a.id !== id);
                await saveActivities();
                renderActivitiesInSettings();
            }
        }

        // ===== Search Functions =====
        function searchItems() {
            const searchTerm = document.getElementById('searchItems').value.toLowerCase();
            const filteredItems = items.filter(item => 
                item.name.toLowerCase().includes(searchTerm) || 
                item.code.toLowerCase().includes(searchTerm)
            );
            renderFilteredItems(filteredItems);
        }

        function renderFilteredItems(filteredItems) {
            const tbody = document.getElementById('itemsList');
            tbody.innerHTML = '';
            if (filteredItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</td></tr>';
                return;
            }
            filteredItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Ø§Ù„ÙƒÙˆØ¯">${item.code}</td>
                    <td data-label="Ø§Ù„Ø§Ø³Ù…">${item.name}</td>
                    <td data-label="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">${item.cost}</td>
                    <td data-label="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">${item.price}</td>
                    <td data-label="Ø§Ù„Ø±ØµÙŠØ¯">${item.stock}</td>
                    <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                     <div class="action-buttons">
                        <button class="btn-warning edit-btn" onclick="editItem(${item.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger" onclick="deleteItem(${item.id})">Ø­Ø°Ù</button>
                    </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
function newPurchaseReturn() {
    activePurchaseReturn = null;
    document.getElementById('purchaseReturnInvoiceSearch').value = '';
    document.getElementById('purchaseReturnInvoiceDetails').style.display = 'none';
    document.getElementById('purchaseReturnItemsContainer').style.display = 'none';
    document.getElementById('purchaseReturnItemsList').innerHTML = '';
    document.getElementById('purchaseReturnTotal').textContent = '0.00';
}

function findPurchaseForReturn() {
    const invoiceNumber = parseInt(document.getElementById('purchaseReturnInvoiceSearch').value);
    if (isNaN(invoiceNumber)) {
        showNotification('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ØµØ­ÙŠØ­', 'warning');
        return;
    }
    
    const purchase = purchases.find(p => p.number === invoiceNumber);
    if (!purchase) {
        showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…', 'error');
        newPurchaseReturn();
        return;
    }

    activePurchaseReturn = purchase;
    const supplier = suppliers.find(s => s.id === purchase.supplierId);
    
    const detailsDiv = document.getElementById('purchaseReturnInvoiceDetails');
    detailsDiv.innerHTML = `
        <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> PUR${purchase.number.toString().padStart(3, '0')}</p>
        <p><strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${purchase.date}</p>
    `;
    detailsDiv.style.display = 'block';

    const itemsTbody = document.getElementById('purchaseReturnItemsList');
    itemsTbody.innerHTML = '';
    purchase.items.forEach(item => {
        const tr = document.createElement('tr');
        tr.dataset.itemId = item.id;
        tr.dataset.price = item.price;
        tr.innerHTML = `
            <td>${item.name}</td>
            <td>${item.price.toFixed(2)}</td>
            <td>${item.quantity}</td>
            <td><input type="number" class="return-item-qty-input" min="0" max="${item.quantity}" value="0" oninput="updatePurchaseReturnTotal()"></td>
        `;
        itemsTbody.appendChild(tr);
    });
    
    document.getElementById('purchaseReturnItemsContainer').style.display = 'block';
    updatePurchaseReturnTotal();
}

function updatePurchaseReturnTotal() {
    let total = 0;
    document.querySelectorAll('#purchaseReturnItemsList tr').forEach(tr => {
        const price = parseFloat(tr.dataset.price);
        const qty = parseInt(tr.querySelector('input').value) || 0;
        total += price * qty;
    });
    document.getElementById('purchaseReturnTotal').textContent = total.toFixed(2);
}

async function savePurchaseReturn() {
    if (!activePurchaseReturn) {
        showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø«', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        return;
    }
    
    const returnedItems = [];
    let totalReturnValue = 0;
    document.querySelectorAll('#purchaseReturnItemsList tr').forEach(tr => {
        const qty = parseInt(tr.querySelector('input').value) || 0;
        if (qty > 0) {
            const originalItem = activePurchaseReturn.items.find(i => i.id == tr.dataset.itemId);
            returnedItems.push({
                id: originalItem.id,
                name: originalItem.name,
                price: originalItem.price,
                quantity: qty
            });
            totalReturnValue += originalItem.price * qty;
        }
    });

    if (returnedItems.length === 0) {
        showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙ…ÙŠØ§Øª', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ ÙƒÙ…ÙŠØ§Øª Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹', 'warning');
        return;
    }

    returnedItems.forEach(returnedItem => {
        const itemInStock = items.find(i => i.id === returnedItem.id);
        if (itemInStock) {
            itemInStock.stock -= returnedItem.quantity;
        }
    });

    const newReturn = {
        id: Date.now(),
        number: currentPurchaseReturnNumber,
        date: new Date().toISOString().split('T')[0],
        originalInvoiceId: activePurchaseReturn.id,
        originalInvoiceNumber: activePurchaseReturn.number,
        supplierId: activePurchaseReturn.supplierId,
        items: returnedItems,
        total: totalReturnValue
    };

    const originalPurchaseIndex = purchases.findIndex(p => p.id === activePurchaseReturn.id);

    if (originalPurchaseIndex > -1) {
        const originalPurchase = purchases[originalPurchaseIndex];
        originalPurchase.total = roundCurrency((originalPurchase.total || 0) - totalReturnValue);
        originalPurchase.remainingAmount = roundCurrency((originalPurchase.remainingAmount || 0) - totalReturnValue);
        originalPurchase.notes = (originalPurchase.notes || '') + ` [Ù…Ø±ØªØ¬Ø¹ Ø¨Ù‚ÙŠÙ…Ø©: ${totalReturnValue.toFixed(2)}]`;
        debugLog('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©:', purchases[originalPurchaseIndex]);
    }

    purchaseReturns.push(newReturn);
    currentPurchaseReturnNumber++;
    
    const success1 = await saveToFirebase('purchaseReturns', purchaseReturns);
    const success2 = await saveToFirebase('items', items);
    const success3 = await saveToFirebase('purchases', purchases); 
    
    if (success1 && success2 && success3) { 
        showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø±Ù‚Ù… S-PR${newReturn.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        newPurchaseReturn();
        renderPurchaseReturns();
        updateDashboard();
        renderItems();
        renderPurchasesList(); 
    } else {
        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}

function renderPurchaseReturns() {
    const tbody = document.getElementById('purchaseReturnsList');
    tbody.parentElement.querySelector('thead tr').innerHTML = `
        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
        <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    `;

    tbody.innerHTML = '';
    if (purchaseReturns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø´ØªØ±ÙŠØ§Øª</td></tr>';
        return;
    }
    purchaseReturns.forEach(pr => {
        const supplier = suppliers.find(s => s.id === pr.supplierId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>PR${pr.number.toString().padStart(3, '0')}</td>
            <td>${pr.date}</td>
            <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>PUR${pr.originalInvoiceNumber.toString().padStart(3, '0')}</td>
            <td>${pr.total.toFixed(2)}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-danger" onclick="deletePurchaseReturn(${pr.id})">Ø­Ø°Ù</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function searchCustomers() {
    const searchTerm = document.getElementById('searchCustomers').value.toLowerCase();
    const filteredCustomers = customers.filter(customer => 
        customer.name.toLowerCase().includes(searchTerm) || 
        customer.code.toLowerCase().includes(searchTerm) ||
                (customer.phone && customer.phone.toLowerCase().includes(searchTerm))
            );
            renderFilteredCustomers(filteredCustomers);
        }

        function renderFilteredCustomers(filteredCustomers) {
            const tbody = document.getElementById('customersList');
            tbody.innerHTML = '';
            if (filteredCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</td></tr>';
                return;
            }
            filteredCustomers.forEach(customer => {
                const tr = document.createElement('tr');
                tr.innerHTML = `

                    <td data-label="Ø§Ù„ÙƒÙˆØ¯">${customer.code}</td>
                    <td data-label="Ø§Ù„Ø§Ø³Ù…">${customer.name}</td>
                    <td data-label="Ø§Ù„Ù‡Ø§ØªÙ">${customer.phone || ''}</td>
                    <td data-label="Ø§Ù„Ø¨Ø±ÙŠØ¯">${customer.email || ''}</td>
                    <td data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">${customer.address || ''}</td>
                    <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                        <div class="action-buttons">
                            <button class="btn-warning edit-btn" onclick="editCustomer(${customer.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn-danger" onclick="deleteCustomer(${customer.id})">Ø­Ø°Ù</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function searchSuppliers() {
            const searchTerm = document.getElementById('searchSuppliers').value.toLowerCase();
            const filteredSuppliers = suppliers.filter(supplier => 
                supplier.name.toLowerCase().includes(searchTerm) || 
                supplier.code.toLowerCase().includes(searchTerm) ||
                (supplier.phone && supplier.phone.toLowerCase().includes(searchTerm))
            );
            renderFilteredSuppliers(filteredSuppliers);
        }

        function renderFilteredSuppliers(filteredSuppliers) {
            const tbody = document.getElementById('suppliersList');
            tbody.innerHTML = '';
            if (filteredSuppliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ±Ø¯ÙˆÙ† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</td></tr>';
                return;
            }
            filteredSuppliers.forEach(supplier => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td data-label="Ø§Ù„ÙƒÙˆØ¯">${supplier.code}</td>
                        <td data-label="Ø§Ù„Ø§Ø³Ù…">${supplier.name}</td>
                        <td data-label="Ø§Ù„Ù‡Ø§ØªÙ">${supplier.phone || ''}</td>
                        <td data-label="Ø§Ù„Ø¨Ø±ÙŠØ¯">${supplier.email || ''}</td>
                        <td data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">${supplier.address || ''}</td>
                        <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                            <div class="action-buttons">
                                <button class="btn-warning edit-btn" onclick="editSupplier(${supplier.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="btn-danger" onclick="deleteSupplier(${supplier.id})">Ø­Ø°Ù</button>
                            </div>
                        </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function searchSalaries() {
            const input = document.getElementById('searchSalaries');
            if (!input) return;
            const term = input.value.trim().toLowerCase();
            if (!term) {
                renderSalaries();
                return;
            }
            const filtered = salaries.filter(salary => {
                const nameMatch = (salary.employeeName || '').toLowerCase().includes(term);
                const idMatch = (salary.employeeId || '').toLowerCase().includes(term);
                const jobMatch = (salary.jobTitle || '').toLowerCase().includes(term);
                const monthMatch = (salary.month || '').toLowerCase().includes(term);
                return nameMatch || idMatch || jobMatch || monthMatch;
            });
            renderSalaries(filtered, true);
        }

        // ===== Items Functions =====
        function generateItemCode() {
            document.getElementById('itemCode').value = 'IT' + (items.length + 1).toString().padStart(3, '0');
        }

        async function addItem() {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            const validation = validateForm({
                itemName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') },
                    { validator: (v) => ValidationHelper.isUnique(v, items, 'name', 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') }
                ],
                itemCost: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡') }
                ],
                itemPrice: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹') },
                    { validator: (v) => ValidationHelper.isGreaterThanZero(v, 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹') }
                ],
                itemStock: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø§Ù„ÙƒÙ…ÙŠØ©') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'Ø§Ù„ÙƒÙ…ÙŠØ©') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const code = document.getElementById('itemCode').value;
            const name = document.getElementById('itemName').value.trim();
            const cost = document.getElementById('itemCost').value;
            const price = document.getElementById('itemPrice').value;
            const stock = document.getElementById('itemStock').value;

            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù...');

            try {
                const item = {
                    id: Date.now(),
                    code: code || 'IT' + (items.length + 1).toString().padStart(3, '0'),
                    name: name,
                    cost: parseFloat(cost) || 0,
                    price: parseFloat(price) || 0,
                    stock: parseInt(stock) || 0
                };

                items.push(item);
                const success = await saveToFirebase('items', items);
                
                hideLoading();
                
                if (success) {
                    updateDashboard();
                    clearItemForm();
                    renderItems();
                    showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                } else {
                    items.pop(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙ†Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            } catch (error) {
                hideLoading();
                logError('Add Item', error);
            }
        }

function loadCustomersToSelect() {
    const select = document.getElementById('accountClientSelect');
    if (!select) return;
    
    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>';
    
    customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.name + ' - ' + (customer.code || '');
        select.appendChild(option);
    });
}

        function renderItems() {
            const tbody = document.getElementById('itemsList');
            tbody.innerHTML = '';
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
            let filteredItems = [...items];
            const searchText = document.getElementById('searchItems')?.value || '';
            
            // Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
            const filters = {
                searchText: searchText,
                priceFrom: document.getElementById('itemCostFrom')?.value,
                priceTo: document.getElementById('itemCostTo')?.value,
            };
            
            // Ø¥Ø¶Ø§ÙØ© ÙÙ„Ø§ØªØ± Ø¥Ø¶Ø§ÙÙŠØ©
            if (document.getElementById('itemPriceFrom')?.value) {
                filters.price = { 
                    from: parseFloat(document.getElementById('itemPriceFrom').value),
                    to: parseFloat(document.getElementById('itemPriceTo')?.value || Infinity)
                };
            }
            
            if (document.getElementById('itemStockFrom')?.value) {
                filters.quantity = {
                    from: parseFloat(document.getElementById('itemStockFrom').value),
                    to: parseFloat(document.getElementById('itemStockTo')?.value || Infinity)
                };
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… FilterSortHelper
            if (searchText) {
                filteredItems = filteredItems.filter(item => 
                    item.name.toLowerCase().includes(searchText.toLowerCase()) ||
                    item.code.toLowerCase().includes(searchText.toLowerCase())
                );
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡
            if (filters.priceFrom) {
                filteredItems = filteredItems.filter(item => parseFloat(item.cost) >= parseFloat(filters.priceFrom));
            }
            if (filters.priceTo) {
                filteredItems = filteredItems.filter(item => parseFloat(item.cost) <= parseFloat(filters.priceTo));
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹
            if (filters.price) {
                filteredItems = filteredItems.filter(item => {
                    const price = parseFloat(item.price);
                    return price >= filters.price.from && price <= filters.price.to;
                });
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø±ØµÙŠØ¯
            if (filters.quantity) {
                filteredItems = filteredItems.filter(item => {
                    const stock = parseFloat(item.stock);
                    return stock >= filters.quantity.from && stock <= filters.quantity.to;
                });
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
            const sortState = FilterSortHelper.currentSort['items'];
            if (sortState) {
                filteredItems = FilterSortHelper.sortData(filteredItems, sortState.column, sortState.direction);
            }
            
            if (filteredItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
                return;
            }
            
            filteredItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.code}</td>
                    <td>${item.name}</td>
                    <td>${item.cost}</td>
                    <td>${item.price}</td>
                    <td>${item.stock}</td>
                    <td>
                    <div class="action-buttons">
                        <button class="btn-warning edit-btn" onclick="editItem(${item.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger" onclick="deleteItem(${item.id})">Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ø£ØµÙ†Ø§Ù
        function applyItemsFilters() {
            renderItems();
        }
        
        function resetItemsFilters() {
            document.getElementById('itemCostFrom').value = '';
            document.getElementById('itemCostTo').value = '';
            document.getElementById('itemPriceFrom').value = '';
            document.getElementById('itemPriceTo').value = '';
            document.getElementById('itemStockFrom').value = '';
            document.getElementById('itemStockTo').value = '';
            renderItems();
        }

        function editItem(id) {
            const item = items.find(item => item.id === id);
            if (!item) return;
            
            document.getElementById('itemCode').value = item.code;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCost').value = item.cost;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemStock').value = item.stock;
            const addButton = document.querySelector('#items .btn-primary');
            addButton.textContent = 'ðŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù';
            addButton.onclick = function() { updateItem(id); };
        }

        async function updateItem(id) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ø¹ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±
            const validation = validateForm({
                itemName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù') },
                    { validator: (v) => ValidationHelper.isUnique(v, items, 'name', 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù', id) }
                ],
                itemCost: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡') }
                ],
                itemPrice: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹') },
                    { validator: (v) => ValidationHelper.isGreaterThanZero(v, 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹') }
                ],
                itemStock: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'Ø§Ù„ÙƒÙ…ÙŠØ©') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'Ø§Ù„ÙƒÙ…ÙŠØ©') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('itemName').value.trim();

            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù...');

            try {
                const itemIndex = items.findIndex(item => item.id === id);
                if (itemIndex !== -1) {
                    const oldName = items[itemIndex].name; // Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
                    debugLog('ðŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù:', { oldName, newName: name, itemId: id });
                    
                    items[itemIndex] = {
                        id: id,
                        code: document.getElementById('itemCode').value,
                        name: name,
                        cost: parseFloat(document.getElementById('itemCost').value) || 0,
                        price: parseFloat(document.getElementById('itemPrice').value) || 0,
                        stock: parseInt(document.getElementById('itemStock').value) || 0
                    };
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ÙÙŠ Ø¬Ù…ÙŠØ¹ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                    let salesUpdated = false;
                    let salesCount = 0;
                    sales.forEach(sale => {
                        sale.items.forEach(item => {
                            if (item.id === id || item.name === oldName) {
                                item.name = name;
                                salesUpdated = true;
                                salesCount++;
                            }
                        });
                    });
                    debugLog(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${salesCount} ØµÙ†Ù ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª`);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ÙÙŠ Ø¬Ù…ÙŠØ¹ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
                    let purchasesCount = 0;
                    purchases.forEach(purchase => {
                        purchase.items.forEach(item => {
                            if (item.id === id || item.name === oldName) {
                                item.name = name;
                                purchasesCount++;
                            }
                        });
                    });
                    debugLog(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${purchasesCount} ØµÙ†Ù ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª`);
                    
                    const success = await saveToFirebase('items', items);
                    const salesSuccess = salesUpdated ? await saveToFirebase('sales', sales) : true;
                    const purchasesSuccess = await saveToFirebase('purchases', purchases);
                    
                    debugLog('ðŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', { success, salesSuccess, purchasesSuccess });
                    
                    hideLoading();
                    
                    if (success && salesSuccess && purchasesSuccess) {
                        updateDashboard();
                        clearItemForm();
                        renderItems();
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù…ÙØªÙˆØ­Ø©
                        if (document.getElementById('advanced-dashboard') && 
                            document.getElementById('advanced-dashboard').classList.contains('active')) {
                            debugLog('ðŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©...');
                            renderCharts();
                            updateLiveStats();
                        }
                        
                        const addButton = document.querySelector('#items .btn-primary');
                        addButton.textContent = 'âž• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù';
                        addButton.onclick = addItem;
                        showNotification('âœ… Ù†Ø¬Ø§Ø­', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­!\n- ØªÙ… ØªØ­Ø¯ÙŠØ« ${salesCount} ØµÙ†Ù ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª\n- ØªÙ… ØªØ­Ø¯ÙŠØ« ${purchasesCount} ØµÙ†Ù ÙÙŠ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª`, 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            } catch (error) {
                hideLoading();
                logError('Update Item', error);
            }
        }

        async function deleteItem(id) {
            const confirmed = await showConfirmDialog({
                title: 'ðŸ—‘ï¸ Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…Ø§Ù‹.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„Ù‡',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            
            if (confirmed) {
                showLoading('Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„ØµÙ†Ù...');
                
                try {
                    const item = items.find(i => i.id === id);
                    if (!item) {
                        hideLoading();
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                        return;
                    }
                    
                    // Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                    moveToTrash('items', item);
                    
                    // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©
                    const itemsCopy = [...items];
                    items = items.filter(item => item.id !== id);
                    const success = await saveToFirebase('items', items);
                    
                    hideLoading();
                    
                    if (success) {
                        renderItems();
                        updateDashboard();
                        updateTrashBadge();
                    } else {
                        items = itemsCopy; // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
                        showNotification(
                            'âŒ Ø®Ø·Ø£',
                            'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                            'error'
                        );
                    }
                } catch (error) {
                    hideLoading();
                    logError('Delete Item', error);
                }
            }
        }

        function clearItemForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemCost').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemStock').value = '';
            const addButton = document.querySelector('#items .btn-primary');
            addButton.textContent = 'âž• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù';
            addButton.onclick = addItem;
            generateItemCode(); // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ±ÙŠØº
        }
        
        // ===== Customers Functions =====
        function generateCustomerCode() {
            document.getElementById('customerCode').value = 'CU' + (customers.length + 1).toString().padStart(3, '0');
        }

        async function addCustomer() {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            const validation = validateForm({
                customerName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') },
                    { validator: (v) => ValidationHelper.isUnique(v, customers, 'name', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') }
                ],
                customerPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') }
                ],
                customerEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('customerName').value.trim();

            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„...');

            try {
                const customer = {
                    id: Date.now(),
                    code: document.getElementById('customerCode').value || 'CU' + (customers.length + 1).toString().padStart(3, '0'),
                    name: name,
                    phone: document.getElementById('customerPhone').value,
                    email: document.getElementById('customerEmail').value,
                    address: document.getElementById('customerAddress').value
                };
                customers.push(customer);
                const success = await saveToFirebase('customers', customers);
                
                hideLoading();
                
                if (success) {
                    updateDashboard();
                    clearCustomerForm();
                    renderCustomers();
                    showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    loadCustomersToSelect();

                } else {
                    customers.pop();
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            } catch (error) {
                hideLoading();
                logError('Add Customer', error);
            }
        }

        function renderCustomers() {
            const tbody = document.getElementById('customersList');
            tbody.innerHTML = '';
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
            let filteredCustomers = [...customers];
            const searchText = document.getElementById('searchCustomers')?.value || '';
            
            if (searchText) {
                filteredCustomers = filteredCustomers.filter(customer => 
                    customer.name.toLowerCase().includes(searchText.toLowerCase()) ||
                    customer.code.toLowerCase().includes(searchText.toLowerCase()) ||
                    (customer.phone && customer.phone.includes(searchText)) ||
                    (customer.email && customer.email.toLowerCase().includes(searchText.toLowerCase())) ||
                    (customer.address && customer.address.toLowerCase().includes(searchText.toLowerCase()))
                );
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
            const sortState = FilterSortHelper.currentSort['customers'];
            if (sortState) {
                filteredCustomers = FilterSortHelper.sortData(filteredCustomers, sortState.column, sortState.direction);
            }

            if (filteredCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
                return;
            }

            filteredCustomers.forEach(customer => {
                const tr = document.createElement('tr');
                tr.innerHTML = `

                    <td>${customer.code}</td>
                    <td>${customer.name}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.email}</td>
                    <td>${customer.address}</td>
                    <td>

                               <div class="action-buttons">
                        <button class="btn-warning edit-btn" onclick="editCustomer(${customer.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger" onclick="deleteCustomer(${customer.id})">Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡
        function resetCustomersFilters() {
            document.getElementById('searchCustomers').value = '';
            renderCustomers();
        }

        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer) return;
            
            document.getElementById('customerCode').value = customer.code;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('customerEmail').value = customer.email;
            document.getElementById('customerAddress').value = customer.address;
            const addButton = document.querySelector('#customers .btn-primary');
            addButton.textContent = 'ðŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„';
            addButton.onclick = () => updateCustomer(id);
        }

        async function updateCustomer(id) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ø¹ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±
            const validation = validateForm({
                customerName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„') },
                    { validator: (v) => ValidationHelper.isUnique(v, customers, 'name', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', id) }
                ],
                customerPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') }
                ],
                customerEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('customerName').value.trim();

            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„...');

            try {
                const customerIndex = customers.findIndex(c => c.id === id);
                if (customerIndex !== -1) {
                    customers[customerIndex] = {
                        id: id,
                        code: document.getElementById('customerCode').value,
                        name: name,
                        phone: document.getElementById('customerPhone').value,
                        email: document.getElementById('customerEmail').value,
                        address: document.getElementById('customerAddress').value
                    };
                    const success = await saveToFirebase('customers', customers);
                    
                    hideLoading();
                    
                    if (success) {
                        updateDashboard();
                        clearCustomerForm();
                        renderCustomers();
                        
                        const addButton = document.querySelector('#customers .btn-primary');
                        addButton.textContent = 'âž• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„';
                        addButton.onclick = addCustomer;
                        
                        showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            } catch (error) {
                hideLoading();
                logError('Update Customer', error);
            }
        }

        async function deleteCustomer(id) {
            const confirmed = await showConfirmDialog({
                title: 'ðŸ—‘ï¸ Ù†Ù‚Ù„ Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…Ø§Ù‹.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„Ù‡',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            
            if (confirmed) {
                const customer = customers.find(c => c.id === id);
                if (customer) {
                    moveToTrash('customers', customer);
                    customers = customers.filter(c => c.id !== id);
                    const success = await saveToFirebase('customers', customers);
                    if (success) {
                        renderCustomers();
                        updateDashboard();
                        showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            }
        }

        function clearCustomerForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerAddress').value = '';
            const addButton = document.querySelector('#customers .btn-primary');
            addButton.textContent = 'âž• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„';
            addButton.onclick = addCustomer;
            generateCustomerCode(); // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ±ÙŠØº
        }

        // ===== Suppliers Functions =====
        function generateSupplierCode() {
            document.getElementById('supplierCode').value = 'SU' + (suppliers.length + 1).toString().padStart(3, '0');
        }

        async function addSupplier() {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            const validation = validateForm({
                supplierName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') },
                    { validator: (v) => ValidationHelper.isUnique(v, suppliers, 'name', 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') }
                ],
                supplierPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') }
                ],
                supplierEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('supplierName').value.trim();

            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ±Ø¯...');

            try {
                const supplier = {
                    id: Date.now(),
                    code: document.getElementById('supplierCode').value || 'SU' + (suppliers.length + 1).toString().padStart(3, '0'),
                    name: name,
                    phone: document.getElementById('supplierPhone').value,
                    email: document.getElementById('supplierEmail').value,
                    address: document.getElementById('supplierAddress').value
                };
                suppliers.push(supplier);
                const success = await saveToFirebase('suppliers', suppliers);
                
                hideLoading();
                
                if (success) {
                    updateDashboard();
                    clearSupplierForm();
                    renderSuppliers();
                    showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                } else {
                    suppliers.pop();
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            } catch (error) {
                hideLoading();
                logError('Add Supplier', error);
            }
        }

        function renderSuppliers() {
            const tbody = document.getElementById('suppliersList');
            tbody.innerHTML = '';
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
            let filteredSuppliers = [...suppliers];
            const searchText = document.getElementById('searchSuppliers')?.value || '';
            
            if (searchText) {
                filteredSuppliers = filteredSuppliers.filter(supplier => 
                    supplier.name.toLowerCase().includes(searchText.toLowerCase()) ||
                    supplier.code.toLowerCase().includes(searchText.toLowerCase()) ||
                    (supplier.phone && supplier.phone.includes(searchText)) ||
                    (supplier.email && supplier.email.toLowerCase().includes(searchText.toLowerCase())) ||
                    (supplier.address && supplier.address.toLowerCase().includes(searchText.toLowerCase()))
                );
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
            const sortState = FilterSortHelper.currentSort['suppliers'];
            if (sortState) {
                filteredSuppliers = FilterSortHelper.sortData(filteredSuppliers, sortState.column, sortState.direction);
            }

            if (filteredSuppliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
                return;
            }

            filteredSuppliers.forEach(supplier => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${supplier.code}</td>
                    <td>${supplier.name}</td>
                    <td>${supplier.phone}</td>
                    <td>${supplier.email}</td>
                    <td>${supplier.address}</td>
                    <td>
                    <div class="action-buttons">
                        <button class="btn-warning edit-btn" onclick="editSupplier(${supplier.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-danger" onclick="deleteSupplier(${supplier.id})">Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        function resetSuppliersFilters() {
            document.getElementById('searchSuppliers').value = '';
            renderSuppliers();
        }

        function editSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (!supplier) return;
            
            document.getElementById('supplierCode').value = supplier.code;
            document.getElementById('supplierName').value = supplier.name;
            document.getElementById('supplierPhone').value = supplier.phone;
            document.getElementById('supplierEmail').value = supplier.email;
            document.getElementById('supplierAddress').value = supplier.address;
            const addButton = document.querySelector('#suppliers .btn-primary');
            addButton.textContent = 'ðŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ±Ø¯';
            addButton.onclick = () => updateSupplier(id);
        }

        async function updateSupplier(id) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            clearValidationStyles();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ø¹ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±
            const validation = validateForm({
                supplierName: [
                    { validator: (v) => ValidationHelper.required(v, 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯') },
                    { validator: (v) => ValidationHelper.isUnique(v, suppliers, 'name', 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯', id) }
                ],
                supplierPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„') }
                ],
                supplierEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') }
                ]
            });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('supplierName').value.trim();

            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ±Ø¯...');

            try {
                const supplierIndex = suppliers.findIndex(s => s.id === id);
                if (supplierIndex !== -1) {
                    suppliers[supplierIndex] = {
                        id: id,
                        code: document.getElementById('supplierCode').value,
                        name: name,
                        phone: document.getElementById('supplierPhone').value,
                        email: document.getElementById('supplierEmail').value,
                        address: document.getElementById('supplierAddress').value
                    };
                    const success = await saveToFirebase('suppliers', suppliers);
                    
                    hideLoading();
                    
                    if (success) {
                        updateDashboard();
                        clearSupplierForm();
                        renderSuppliers();
                        
                        const addButton = document.querySelector('#suppliers .btn-primary');
                        addButton.textContent = 'âž• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯';
                        addButton.onclick = addSupplier;
                        
                        showNotification('âœ… Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            } catch (error) {
                hideLoading();
                logError('Update Supplier', error);
            }
        }

        async function deleteSupplier(id) {
            const confirmed = await showConfirmDialog({
                title: 'ðŸ—‘ï¸ Ù†Ù‚Ù„ Ù…ÙˆØ±Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…Ø§Ù‹.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‚Ù„Ù‡',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });
            
            if (confirmed) {
                const supplier = suppliers.find(s => s.id === id);
                if (supplier) {
                    moveToTrash('suppliers', supplier);
                    suppliers = suppliers.filter(s => s.id !== id);
                    const success = await saveToFirebase('suppliers', suppliers);
                    if (success) {
                        renderSuppliers();
                        updateDashboard();
                        showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            }
        }

        function clearSupplierForm() {
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierAddress').value = '';
            const addButton = document.querySelector('#suppliers .btn-primary');
            addButton.textContent = 'âž• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯';
            addButton.onclick = addSupplier;
            generateSupplierCode(); // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ±ÙŠØº
        }
        
        // ===== General Invoice Functions =====
        function resetInvoiceForms() {
            editingSaleId = null;
            editingPurchaseId = null;
            newSale();
            newPurchase();
        }

        // ===== Purchases Functions =====
        function generatePurchaseCode() {
            document.getElementById('purchaseCode').value = 'PUR' + currentPurchaseNumber.toString().padStart(3, '0');
        }
        
        function updatePurchaseDropdowns() {
            const supplierSelect = document.getElementById('purchaseSupplier');
            const itemSelect = document.getElementById('purchaseItem');
            
            supplierSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯</option>';
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name;
                supplierSelect.appendChild(option);
            });

            itemSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (${item.stock} Ù…ØªÙˆÙØ±)`;
                option.dataset.price = item.cost;
                itemSelect.appendChild(option);
            });
            
            renderPurchasesList();
        }
        
        function addPurchaseItem() {
            const itemId = parseInt(document.getElementById('purchaseItem').value);
            const quantity = parseInt(document.getElementById('purchaseQuantity').value);
            const unit = document.getElementById('purchaseUnit').value;
            const price = parseFloat(document.getElementById('purchasePrice').value);
            
            if (!itemId || !quantity || !unit || isNaN(price)) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'warning');
                return;
            }
            
            const item = items.find(i => i.id === itemId);
            if (!item) {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }
            
            const existingItem = currentPurchaseItems.find(i => i.id === itemId && i.unit === unit);
            if (existingItem) {
                existingItem.quantity += quantity;
                existingItem.total = existingItem.quantity * existingItem.price;
            } else {
                currentPurchaseItems.push({
                    id: itemId,
                    name: item.name,
                    quantity: quantity,
                    unit: unit,
                    price: price,
                    total: quantity * price
                });
            }
            
            renderPurchaseItems();
            updatePurchaseTotals();
            
            document.getElementById('purchaseItem').value = '';
            document.getElementById('purchaseQuantity').value = '1';
            document.getElementById('purchasePrice').value = '';
        }
        
        function renderPurchaseItems() {
            const tbody = document.getElementById('purchaseItemsList');
            tbody.innerHTML = '';
            
            if (currentPurchaseItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù</td></tr>';
                return;
            }
            
            currentPurchaseItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit || 'Ù‚Ø·Ø¹Ø©'}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.total.toFixed(2)}</td>
                    <td>
                        <button class="btn-danger" onclick="removePurchaseItem(${index})">Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function removePurchaseItem(index) {
            currentPurchaseItems.splice(index, 1);
            renderPurchaseItems();
            updatePurchaseTotals();
        }
        
        function updatePurchaseTotals() {
            const subtotal = currentPurchaseItems.reduce((sum, item) => sum + item.total, 0);
            const tax = subtotal * 0.15;
            const total = subtotal + tax;
            const paidAmount = parseFloat(document.getElementById('purchasePaidAmount').value) || 0;
            const remainingAmount = total - paidAmount;

            document.getElementById('purchaseSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('purchaseTax').textContent = tax.toFixed(2);
            document.getElementById('purchaseTotal').textContent = total.toFixed(2);
            
            const remainingEl = document.getElementById('purchaseRemainingAmount');
            remainingEl.textContent = remainingAmount.toFixed(2);
            remainingEl.className = remainingAmount <= 0 ? 'remaining-paid' : 'remaining-unpaid';
        }
        
       async function savePurchase() {
    const date = document.getElementById('purchaseDate').value;
    const supplierId = parseInt(document.getElementById('purchaseSupplier').value);
    const notes = document.getElementById('purchaseNotes').value;
    const paidAmount = parseFloat(document.getElementById('purchasePaidAmount').value) || 0;

    if (!date || !supplierId || currentPurchaseItems.length === 0) {
        showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù Ù„Ù„ÙØ§ØªÙˆØ±Ø©', 'warning');
        return;
    }
    
    const attachmentFile = document.getElementById('purchaseAttachment').files[0];
    let attachmentUrl = null;

    if (attachmentFile) {
        attachmentUrl = await uploadFile(attachmentFile, 'purchases');
        if (!attachmentUrl) {
            showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹', 'ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚ØŒ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
            return;
        }
    }
    
    const subtotal = currentPurchaseItems.reduce((sum, item) => sum + item.total, 0);
    const tax = subtotal * 0.15;
    const total = subtotal + tax;
    const remainingAmount = total - paidAmount;

    if (editingPurchaseId) {
        const purchaseIndex = purchases.findIndex(p => p.id === editingPurchaseId);
        if (purchaseIndex > -1) {
            const originalPurchase = purchases[purchaseIndex];
            
            originalPurchase.items.forEach(pi => {
                const item = items.find(i => i.id === pi.id);
                if (item) item.stock -= pi.quantity;
            });

            const updatedPurchase = {
                ...originalPurchase,
                date,
                supplierId,
                notes,
                paidAmount,
                items: [...currentPurchaseItems],
                subtotal,
                tax,
                total,
                remainingAmount,
                attachmentUrl: attachmentUrl || originalPurchase.attachmentUrl
            };

            purchases[purchaseIndex] = updatedPurchase;
            
            showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… PUR${originalPurchase.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
        }
    } else {
         const newPurchaseData = { 
             id: Date.now(), 
             number: currentPurchaseNumber, 
             date, 
             supplierId, 
             notes, 
             paidAmount, 
             items: [...currentPurchaseItems], 
             subtotal, 
             tax, 
             total, 
             remainingAmount,
             attachmentUrl: attachmentUrl 
         };
        purchases.push(newPurchaseData);
        currentPurchaseNumber++;
        showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… PUR${newPurchaseData.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
    }
    
    const success1 = await saveToFirebase('purchases', purchases);
    
    currentPurchaseItems.forEach(pi => {
        const item = items.find(i => i.id === pi.id);
        if (item) item.stock += pi.quantity;
    });
    const success2 = await saveToFirebase('items', items);
    
    if (success1 && success2) {
        newPurchase();
        updateDashboard();
        renderItems();
    } else {
        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}        
        function newPurchase() {
            currentPurchaseItems = [];
            editingPurchaseId = null;
            document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('purchaseSupplier').value = '';
            document.getElementById('purchaseNotes').value = '';
            document.getElementById('purchasePaidAmount').value = '';
            generatePurchaseCode();
            document.getElementById('savePurchaseBtn').textContent = 'ðŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            renderPurchaseItems();
            updatePurchaseTotals();
            renderPurchasesList();
      
  }
  function renderPurchasesList() {
    const tbody = document.getElementById('purchasesList');
    tbody.innerHTML = '';
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
    let filteredPurchases = [...purchases];
    const searchText = document.getElementById('searchPurchases')?.value || '';
    
    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
    if (searchText) {
        filteredPurchases = filteredPurchases.filter(purchase => {
            const supplier = suppliers.find(s => s.id === purchase.supplierId);
            return (`pur${purchase.number}`.toLowerCase().includes(searchText.toLowerCase()) || 
                    (supplier && supplier.name.toLowerCase().includes(searchText.toLowerCase())) || 
                    purchase.date.includes(searchText));
        });
    }
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const dateFrom = document.getElementById('purchasesDateFrom')?.value;
    const dateTo = document.getElementById('purchasesDateTo')?.value;
    if (dateFrom) {
        filteredPurchases = filteredPurchases.filter(purchase => new Date(purchase.date) >= new Date(dateFrom));
    }
    if (dateTo) {
        filteredPurchases = filteredPurchases.filter(purchase => new Date(purchase.date) <= new Date(dateTo));
    }
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº
    const amountFrom = document.getElementById('purchasesAmountFrom')?.value;
    const amountTo = document.getElementById('purchasesAmountTo')?.value;
    if (amountFrom) {
        filteredPurchases = filteredPurchases.filter(purchase => purchase.total >= parseFloat(amountFrom));
    }
    if (amountTo) {
        filteredPurchases = filteredPurchases.filter(purchase => purchase.total <= parseFloat(amountTo));
    }
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
    const sortState = FilterSortHelper.currentSort['purchases'];
    if (sortState) {
        filteredPurchases = FilterSortHelper.sortData(filteredPurchases, sortState.column, sortState.direction);
    }
    
    if (filteredPurchases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>'; // ðŸ’¡ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø¥Ù„Ù‰ 9
        return;
    }
    
    // --- Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØµØ­ÙŠØ­ (Ø­Ù„Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) ---
    filteredPurchases.forEach(purchase => {
        const supplier = suppliers.find(s => s.id === purchase.supplierId);
        const totalQty = purchase.items.reduce((sum, item) => sum + item.quantity, 0);

        const remaining = purchase.remainingAmount ?? (purchase.total - (purchase.paidAmount || 0));
        const remainingClass = remaining > 0.01 ? 'remaining-unpaid' : (remaining < -0.01 ? 'remaining-credit' : 'remaining-paid');
        const remainingText = remaining.toFixed(2);
        
        const attachmentLink = purchase.attachmentUrl 
            ? `<a href="${purchase.attachmentUrl}" target="_blank" class="btn-info" style="padding: 4px 8px; text-decoration: none;">Ø¹Ø±Ø¶</a>`
            : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>PUR${purchase.number.toString().padStart(3, '0')}</td>
            <td>${purchase.date}</td>
            <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>${totalQty}</td>
            <td>${purchase.total.toFixed(2)}</td>
            <td>${(purchase.paidAmount || 0).toFixed(2)}</td>
            <td class="${remainingClass}">${remainingText}</td>
            <td>${attachmentLink}</td>
            <td>
            <div class="action-buttons">
                <button class="btn-secondary" onclick="printPurchaseInvoice(${purchase.id})">ðŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                <button class="btn-warning edit-btn" onclick="editPurchase(${purchase.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn-danger" onclick="deletePurchase(${purchase.id})">Ø­Ø°Ù</button>
            </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
        function applyPurchasesFilters() {
            renderPurchasesList();
        }
        
        function resetPurchasesFilters() {
            document.getElementById('purchasesDateFrom').value = '';
            document.getElementById('purchasesDateTo').value = '';
            document.getElementById('purchasesAmountFrom').value = '';
            document.getElementById('purchasesAmountTo').value = '';
            document.getElementById('searchPurchases').value = '';
            renderPurchasesList();
        }

        function searchPurchases() {
            renderPurchasesList();
        }

        function renderFilteredPurchases(filtered) {
            // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù… ØªØ¹Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø© - ØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ ÙÙŠ renderPurchasesList
            renderPurchasesList();
        }

        function printPurchaseInvoice(purchaseId) {
            const purchase = purchases.find(p => p.id === purchaseId);
            if (!purchase) return;
            
            const supplier = suppliers.find(s => s.id === purchase.supplierId);
            
            // ØªØ­Ù…ÙŠÙ„ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· ÙˆØ§Ø³Ù…Ù‡
            const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
            if (currentActivity) {
                document.getElementById('printPurchaseActivityName').textContent = currentActivity.name;
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† localStorage
                const storageKey = `activity_${currentActivity.id}_data`;
                const activityData = JSON.parse(localStorage.getItem(storageKey));
                const logoImg = document.getElementById('printPurchaseActivityLogo');
                
                if (activityData && activityData.logo) {
                    logoImg.src = activityData.logo;
                    logoImg.style.display = 'block';
                } else {
                    logoImg.style.display = 'none';
                }
            }
            
            // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
            document.getElementById('printPurchaseDate').textContent = purchase.date;
            const now = new Date();
            document.getElementById('printPurchaseTime').textContent = now.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('printPurchaseNumber').textContent = purchase.number.toString().padStart(3, '0');
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯
            document.getElementById('printSupplierName').textContent = supplier ? supplier.name : '-----';
            
            // Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            const notesElement = document.getElementById('printPurchaseNotes');
            if (notesElement) {
                notesElement.textContent = purchase.notes || '-----';
            }
            
            // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù
            const itemsBody = document.getElementById('printPurchaseItems');
            itemsBody.innerHTML = '';
            purchase.items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${index + 1}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: right;">${item.name}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${item.quantity}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${item.unit || 'Ù‚Ø·Ø¹Ø©'}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${item.price.toFixed(2)}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; direction: ltr; font-weight: bold;">${item.total.toFixed(2)}</td>
                `;
                itemsBody.appendChild(tr);
            });
            
            // Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
            document.getElementById('printPurchaseSubtotal').textContent = (purchase.subtotal || 0).toFixed(2);
            
            const taxRow = document.getElementById('printPurchaseTaxRow');
            if (purchase.includeTax) {
                document.getElementById('printPurchaseTax').textContent = (purchase.tax || 0).toFixed(2);
                if (taxRow) taxRow.style.display = 'grid';
            } else {
                if (taxRow) taxRow.style.display = 'none';
            }
            
            document.getElementById('printPurchaseTotal').textContent = (purchase.total || 0).toFixed(2);
            document.getElementById('printPurchasePaid').textContent = (purchase.paidAmount || 0).toFixed(2);
            const remaining = (purchase.remainingAmount !== undefined) ? purchase.remainingAmount : ((purchase.total || 0) - (purchase.paidAmount || 0));
            document.getElementById('printPurchaseRemaining').textContent = remaining.toFixed(2);
            
            const printSection = document.getElementById('purchaseInvoicePrint');
            printSection.style.display = 'block';
            setTimeout(() => {
                window.print();
                printSection.style.display = 'none';
            }, 100);
        }
        
        async function deletePurchase(id) {
            const confirmed = await showConfirmDialog({
                title: 'ðŸ—‘ï¸ Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nâš ï¸ Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡Ø§',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡',
                icon: 'ðŸ“¦'
            });
            
            if (confirmed) {
                const pIndex = purchases.findIndex(p => p.id === id);
                if (pIndex > -1) {
                    const purchase = purchases[pIndex];
                    
                    // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª
                    purchase.items.forEach(pi => {
                        const item = items.find(i => i.id === pi.id);
                        if (item) item.stock -= pi.quantity;
                    });
                    await saveToFirebase('items', items);
                    
                    // Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                    moveToTrash('purchases', purchase);
                    purchases.splice(pIndex, 1);
                    await saveToFirebase('purchases', purchases);
                    
                    renderPurchasesList();
                    updateDashboard();
                    renderItems();
                    showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                }
            }
        }
        
        function editPurchase(id) {
            const purchase = purchases.find(p => p.id === id);
            if (!purchase) return;
            
            editingPurchaseId = id;
            currentPurchaseItems = JSON.parse(JSON.stringify(purchase.items));
            
            document.getElementById('purchaseDate').value = purchase.date;
            document.getElementById('purchaseSupplier').value = purchase.supplierId;
            document.getElementById('purchaseNotes').value = purchase.notes;
            document.getElementById('purchasePaidAmount').value = purchase.paidAmount || 0;
            document.getElementById('purchaseCode').value = `ØªØ¹Ø¯ÙŠÙ„ PUR${purchase.number.toString().padStart(3, '0')}`;
            document.getElementById('savePurchaseBtn').textContent = 'ðŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            
            renderPurchaseItems();
            updatePurchaseTotals();
        }

        // ===== Sales Functions =====
        function generateSaleCode() {
            document.getElementById('saleCode').value = 'SAL' + currentSaleNumber.toString().padStart(3, '0');
        }
        
        function updateSaleDropdowns() {
            const customerSelect = document.getElementById('saleCustomer');
            const itemSelect = document.getElementById('saleItem');
            
            customerSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                customerSelect.appendChild(option);
            });

            itemSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (${item.stock} Ù…ØªÙˆÙØ±)`;
                option.dataset.price = item.price;
                itemSelect.appendChild(option);
            });
            
            renderSalesList();
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        function updateCustomerFields() {
            const customerSelect = document.getElementById('saleCustomer');
            const customerId = parseInt(customerSelect.value);
            const customer = customers.find(c => c.id === customerId);
            
            if (customer) {
                document.getElementById('saleCustomerName').value = customer.name || '';
                document.getElementById('saleCustomerCode').value = customer.code || '';
                document.getElementById('saleCustomerPhone').value = customer.phone || '';
            } else {
                document.getElementById('saleCustomerName').value = '';
                document.getElementById('saleCustomerCode').value = '';
                document.getElementById('saleCustomerPhone').value = '';
            }
        }
        
        function addSaleItem() {
            const itemId = parseInt(document.getElementById('saleItem').value);
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const unit = document.getElementById('saleUnit').value;
            const price = parseFloat(document.getElementById('salePrice').value);
            
            if (!itemId || !quantity || !unit || isNaN(price)) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'warning');
                return;
            }
            
            const item = items.find(i => i.id === itemId);
            if (!item) {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }
            
            const existingInCart = currentSaleItems.find(i => i.id === itemId && i.unit === unit);
            const qtyInCart = existingInCart ? existingInCart.quantity : 0;

            if (item.stock < (quantity + qtyInCart)) {
                showNotification('âš ï¸ Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙ', `Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${quantity + qtyInCart}) ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©. Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${item.stock}`, 'warning', 6000);
                return;
            }
            
            if (existingInCart) {
                existingInCart.quantity += quantity;
                existingInCart.total = existingInCart.quantity * existingInCart.price;
            } else {
                currentSaleItems.push({ id: itemId, name: item.name, quantity, unit: unit, price, total: quantity * price });
            }
            
            renderSaleItems();
            updateSaleTotals();
            
            document.getElementById('saleItem').value = '';
            document.getElementById('saleQuantity').value = '1';
            document.getElementById('salePrice').value = '';
        }
        
        function renderSaleItems() {
            const tbody = document.getElementById('saleItemsList');
            tbody.innerHTML = '';
            if (currentSaleItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù</td></tr>';
                return;
            }
            currentSaleItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit || 'Ù‚Ø·Ø¹Ø©'}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.total.toFixed(2)}</td>
                    <td><button class="btn-danger" onclick="removeSaleItem(${index})">Ø­Ø°Ù</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function removeSaleItem(index) {
            currentSaleItems.splice(index, 1);
            renderSaleItems();
            updateSaleTotals();
        }
        
        function updateSaleTotals() {
            const subtotal = currentSaleItems.reduce((sum, item) => sum + item.total, 0);
            const applyTax = document.getElementById('applySaleTax').checked;
            const tax = applyTax ? subtotal * 0.15 : 0;
            const total = subtotal + tax;
            const paidAmount = parseFloat(document.getElementById('salePaidAmount').value) || 0;
            const remainingAmount = total - paidAmount;

            document.getElementById('saleSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('saleTax').textContent = tax.toFixed(2);
            document.getElementById('saleTotal').textContent = total.toFixed(2);
            
            const remainingEl = document.getElementById('saleRemainingAmount');
            remainingEl.textContent = remainingAmount.toFixed(2);
            remainingEl.className = remainingAmount <= 0 ? 'remaining-paid' : 'remaining-unpaid';
        }
        
        function newSale() {
            currentSaleItems = [];
            editingSaleId = null;
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('saleCustomer').value = '';
            document.getElementById('saleCustomerName').value = '';
            document.getElementById('saleCustomerCode').value = '';
            document.getElementById('saleCustomerPhone').value = '';
            document.getElementById('saleCustomerAddress').value = '';
            document.getElementById('saleNotes').value = '';
            document.getElementById('salePaidAmount').value = '';
            generateSaleCode();
            document.getElementById('saveSaleBtn').textContent = 'ðŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            renderSaleItems();
            updateSaleTotals();
            renderSalesList();
        }

        async function saveSale() {
            const date = document.getElementById('saleDate').value;
            const customerId = parseInt(document.getElementById('saleCustomer').value);
            const notes = document.getElementById('saleNotes').value;
            const customerAddress = document.getElementById('saleCustomerAddress').value;
            const paidAmount = parseFloat(document.getElementById('salePaidAmount').value) || 0;
            const taxApplied = document.getElementById('applySaleTax').checked;

            if (!date || !customerId || currentSaleItems.length === 0) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù Ù„Ù„ÙØ§ØªÙˆØ±Ø©', 'warning');
                return;
            }
            
            const subtotal = currentSaleItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxApplied ? subtotal * 0.15 : 0;
            const total = subtotal + tax;
            const remainingAmount = total - paidAmount;

            if (editingSaleId) {
                const saleIndex = sales.findIndex(s => s.id === editingSaleId);
                if (saleIndex > -1) {
                    const originalSale = sales[saleIndex];
                    
                    originalSale.items.forEach(si => {
                        const item = items.find(i => i.id === si.id);
                        if (item) item.stock += si.quantity;
                    });

                    const updatedSale = {
                        ...originalSale,
                        date,
                        customerId,
                        notes,
                        customerAddress,
                        paidAmount,
                        items: [...currentSaleItems],
                        subtotal,
                        tax,
                        total,
                        remainingAmount,
                        taxApplied
                    };
                    
                    sales[saleIndex] = updatedSale;
                    
                    showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… SAL${originalSale.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                }
            } else {
                const newSaleData = { id: Date.now(), number: currentSaleNumber, date, customerId, notes, customerAddress, paidAmount, items: [...currentSaleItems], subtotal, tax, total, remainingAmount, taxApplied };
                sales.push(newSaleData);
                currentSaleNumber++;
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… SAL${newSaleData.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
            }
            
            const success1 = await saveToFirebase('sales', sales);
            
            currentSaleItems.forEach(si => {
                const item = items.find(i => i.id === si.id);
                if (item) item.stock -= si.quantity;
            });
            const success2 = await saveToFirebase('items', items);
            
            if (success1 && success2) {
                newSale();
                updateDashboard();
                renderItems();
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }
    function renderSalesList() {
    const tbody = document.getElementById('salesList');
    tbody.innerHTML = '';
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
    let filteredSales = [...sales];
    const searchText = document.getElementById('searchSales')?.value || '';
    
    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
    if (searchText) {
        filteredSales = filteredSales.filter(sale => {
            const customer = customers.find(c => c.id === sale.customerId);
            return (`sal${sale.number}`.toLowerCase().includes(searchText.toLowerCase()) || 
                    (customer && customer.name.toLowerCase().includes(searchText.toLowerCase())) || 
                    sale.date.includes(searchText));
        });
    }
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const dateFrom = document.getElementById('salesDateFrom')?.value;
    const dateTo = document.getElementById('salesDateTo')?.value;
    if (dateFrom) {
        filteredSales = filteredSales.filter(sale => new Date(sale.date) >= new Date(dateFrom));
    }
    if (dateTo) {
        filteredSales = filteredSales.filter(sale => new Date(sale.date) <= new Date(dateTo));
    }
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº
    const amountFrom = document.getElementById('salesAmountFrom')?.value;
    const amountTo = document.getElementById('salesAmountTo')?.value;
    if (amountFrom) {
        filteredSales = filteredSales.filter(sale => sale.total >= parseFloat(amountFrom));
    }
    if (amountTo) {
        filteredSales = filteredSales.filter(sale => sale.total <= parseFloat(amountTo));
    }
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨
    const sortState = FilterSortHelper.currentSort['sales'];
    if (sortState) {
        filteredSales = FilterSortHelper.sortData(filteredSales, sortState.column, sortState.direction);
    }
    
    if (filteredSales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
        return;
    }
    
    filteredSales.forEach(sale => {
        const customer = customers.find(c => c.id === sale.customerId);
        const totalQty = sale.items.reduce((sum, item) => sum + item.quantity, 0);
        
        // --- ðŸ’¡ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
        const remaining = sale.remainingAmount ?? (sale.total - (sale.paidAmount || 0));
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
        // remaining-unpaid: Ø£Ø­Ù…Ø± (Ø¹Ù„ÙŠÙ‡ ÙÙ„ÙˆØ³)
        // remaining-credit: Ø£Ø®Ø¶Ø± (Ù„Ù‡ ÙÙ„ÙˆØ³)
        // remaining-paid: Ø£Ø³ÙˆØ¯ (Ø§Ù„Ø±ØµÙŠØ¯ ØµÙØ±)
        const remainingClass = remaining > 0.01 ? 'remaining-unpaid' : (remaining < -0.01 ? 'remaining-credit' : 'remaining-paid');
        const remainingText = remaining.toFixed(2);
        // --- ðŸ’¡ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ---

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td data-label="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©">SAL${sale.number.toString().padStart(3, '0')}</td>
            <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${sale.date}</td>
            <td data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„">${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td data-label="Ø§Ù„ÙƒÙ…ÙŠØ©">${totalQty}</td>
            <td data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ">${sale.total.toFixed(2)}</td>
            <td data-label="Ø§Ù„Ù…Ø¯ÙÙˆØ¹">${(sale.paidAmount || 0).toFixed(2)}</td>
            <td data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ" class="${remainingClass}">${remainingText}</td>
            <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                <div class="action-buttons">
                    <button class="btn-secondary" onclick="printSaleInvoice(${sale.id})">ðŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button class="email-btn" onclick="emailSaleInvoice(${sale.id})">ðŸ“§ Ø¨Ø±ÙŠØ¯</button>
                    <button class="btn-whatsapp" onclick="sendWhatsAppInvoice(${sale.id})">ðŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</button>
                    <button class="btn-warning edit-btn" onclick="editSale(${sale.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn-danger" onclick="deleteSale(${sale.id})">Ø­Ø°Ù</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
        function applySalesFilters() {
            renderSalesList();
        }
        
        function resetSalesFilters() {
            document.getElementById('salesDateFrom').value = '';
            document.getElementById('salesDateTo').value = '';
            document.getElementById('salesAmountFrom').value = '';
            document.getElementById('salesAmountTo').value = '';
            document.getElementById('searchSales').value = '';
            renderSalesList();
        }

        function searchSales() {
            renderSalesList();
        }

     function renderFilteredSales(filtered) {
    // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù… ØªØ¹Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø© - ØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ ÙÙŠ renderSalesList
    renderSalesList();
}

        function printSaleInvoice(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;
            
            const customer = customers.find(c => c.id === sale.customerId);
            
            // ØªØ­Ù…ÙŠÙ„ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· ÙˆØ§Ø³Ù…Ù‡
            const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
            if (currentActivity) {
                document.getElementById('printSaleActivityName').textContent = currentActivity.name;
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† localStorage
                const storageKey = `activity_${currentActivity.id}_data`;
                const activityData = JSON.parse(localStorage.getItem(storageKey));
                const logoImg = document.getElementById('printSaleActivityLogo');
                
                if (activityData && activityData.logo) {
                    logoImg.src = activityData.logo;
                    logoImg.style.display = 'block';
                } else {
                    logoImg.style.display = 'none';
                }
            }
            
            // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
            document.getElementById('printSaleDate').textContent = sale.date;
            const now = new Date();
            document.getElementById('printSaleTime').textContent = now.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('printSaleNumber').textContent = 'SAL' + sale.number.toString().padStart(3, '0');
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
            document.getElementById('printCustomerName').textContent = customer ? customer.name : '-----';
            document.getElementById('printCustomerCode').textContent = customer ? customer.code : '-----';
            document.getElementById('printCustomerPhone').textContent = customer ? customer.phone : '-----';
            document.getElementById('printCustomerAddress').textContent = sale.customerAddress || '-----';
            
            // Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            const notesElement = document.getElementById('printSaleNotes');
            if (notesElement) {
                notesElement.textContent = sale.notes || '-----';
            }
            
            // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù - Ø¯Ù…Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯
            const itemsBody = document.getElementById('printSaleItems');
            itemsBody.innerHTML = '';
            
            // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ ÙˆØ§Ø­Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù
            const tr = document.createElement('tr');
            
            // Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ³Ù„Ø³Ù„
            let numbersHtml = '';
            let codesHtml = '';
            let namesHtml = '';
            let quantitiesHtml = '';
            let unitsHtml = '';
            let pricesHtml = '';
            let totalsHtml = '';
            
            sale.items.forEach((item, index) => {
                const itemData = items.find(i => i.id === item.id);
                const itemCode = itemData ? itemData.code : '---';
                
                const separator = index < sale.items.length - 1 ? '<hr style="margin: 4px 0; border: none; border-top: 1px solid #ccc;">' : '';
                
                numbersHtml += `${index + 1}${separator}`;
                codesHtml += `${itemCode}${separator}`;
                namesHtml += `${item.name}${separator}`;
                quantitiesHtml += `${item.quantity}${separator}`;
                unitsHtml += `${item.unit || 'Ù‚Ø·Ø¹Ø©'}${separator}`;
                pricesHtml += `${item.price.toFixed(2)}${separator}`;
                totalsHtml += `${item.total.toFixed(2)}${separator}`;
            });
            
            tr.innerHTML = `
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${numbersHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${codesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: right; vertical-align: top; border-radius: 6px;">${namesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${quantitiesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${unitsHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${pricesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; vertical-align: top; direction: ltr; font-weight: bold; border-radius: 6px;">${totalsHtml}</td>
            `;
            itemsBody.appendChild(tr);
            
            // Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
            document.getElementById('printSaleSubtotal').textContent = (sale.subtotal || 0).toFixed(2);
            
            const taxRow = document.getElementById('printSaleTaxRow');
            if (sale.includeTax) {
                document.getElementById('printSaleTax').textContent = (sale.tax || 0).toFixed(2);
                if (taxRow) taxRow.style.display = 'grid';
            } else {
                if (taxRow) taxRow.style.display = 'none';
            }
            
            document.getElementById('printSaleTotal').textContent = (sale.total || 0).toFixed(2);
            document.getElementById('printSalePaid').textContent = (sale.paidAmount || 0).toFixed(2);
            const remaining = (sale.remainingAmount !== undefined) ? sale.remainingAmount : ((sale.total || 0) - (sale.paidAmount || 0));
            document.getElementById('printSaleRemaining').textContent = remaining.toFixed(2);
            
            const printSection = document.getElementById('saleInvoicePrint');
            printSection.style.display = 'block';
            setTimeout(() => {
                window.print();
                printSection.style.display = 'none';
            }, 100);
        }
        
        async function deleteSale(id) {
            const confirmed = await showConfirmDialog({
                title: 'ðŸ—‘ï¸ Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª',
                message: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\nâš ï¸ Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.',
                type: 'warning',
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡Ø§',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡',
                icon: 'ðŸ“'
            });
            
            if (confirmed) {
                 const saleIndex = sales.findIndex(s => s.id === id);
                if (saleIndex > -1) {
                    const sale = sales[saleIndex];
                    
                    // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª
                    sale.items.forEach(si => {
                        const item = items.find(i => i.id === si.id);
                        if (item) item.stock += si.quantity;
                    });
                    await saveToFirebase('items', items);
                    
                    // Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                    moveToTrash('sales', sale);
                    sales.splice(saleIndex, 1);
                    await saveToFirebase('sales', sales);
                    
                    renderSalesList();
                    updateDashboard();
                    renderItems();
                    showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                }
            }
        }
        
        function editSale(id) {
            const sale = sales.find(s => s.id === id);
            if (!sale) return;
            
            editingSaleId = id;
            currentSaleItems = JSON.parse(JSON.stringify(sale.items));
            
            document.getElementById('saleDate').value = sale.date;
            document.getElementById('saleCustomer').value = sale.customerId;
            
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
            updateCustomerFields();
            
            document.getElementById('saleCustomerAddress').value = sale.customerAddress || '';
            document.getElementById('saleNotes').value = sale.notes;
            document.getElementById('salePaidAmount').value = sale.paidAmount || 0;
            document.getElementById('saleCode').value = `ØªØ¹Ø¯ÙŠÙ„ SAL${sale.number.toString().padStart(3, '0')}`;
            document.getElementById('saveSaleBtn').textContent = 'ðŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            
            document.getElementById('applySaleTax').checked = sale.taxApplied ?? true;
            
            renderSaleItems();
            updateSaleTotals();
        }

        // ===== Returns Functions =====
        function showReturnTab(type) {
            document.getElementById('salesReturnContent').classList.remove('active');
            document.getElementById('purchaseReturnContent').classList.remove('active');
            document.getElementById('salesReturnTabBtn').classList.remove('active');
            document.getElementById('purchasesReturnTabBtn').classList.remove('active');

            if (type === 'sales') {
                document.getElementById('salesReturnContent').classList.add('active');
                document.getElementById('salesReturnTabBtn').classList.add('active');
                newSaleReturn();
            } else {
                document.getElementById('purchaseReturnContent').classList.add('active');
                document.getElementById('purchasesReturnTabBtn').classList.add('active');
                newPurchaseReturn();
            }
        }
        
        function newSaleReturn() {
            activeSaleReturn = null;
            document.getElementById('salesReturnInvoiceSearch').value = '';
            document.getElementById('salesReturnInvoiceDetails').style.display = 'none';
            document.getElementById('salesReturnItemsContainer').style.display = 'none';
            document.getElementById('salesReturnItemsList').innerHTML = '';
            document.getElementById('salesReturnTotal').textContent = '0.00';
        }

        function findSaleForReturn() {
            const invoiceNumber = parseInt(document.getElementById('salesReturnInvoiceSearch').value);
            if (isNaN(invoiceNumber)) {
                showNotification('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ØµØ­ÙŠØ­', 'warning');
                return;
            }
            
            const sale = sales.find(s => s.number === invoiceNumber);
            if (!sale) {
                showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…', 'error');
                newSaleReturn();
                return;
            }

            activeSaleReturn = sale;
            const customer = customers.find(c => c.id === sale.customerId);
            
            const detailsDiv = document.getElementById('salesReturnInvoiceDetails');
            detailsDiv.innerHTML = `
                <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> SAL${sale.number.toString().padStart(3, '0')}</p>
                <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${sale.date}</p>
            `;
            detailsDiv.style.display = 'block';

            const itemsTbody = document.getElementById('salesReturnItemsList');
            itemsTbody.innerHTML = '';
            sale.items.forEach(item => {
                const tr = document.createElement('tr');
                tr.dataset.itemId = item.id;
                tr.dataset.price = item.price;
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td><input type="number" class="return-item-qty-input" min="0" max="${item.quantity}" value="0" oninput="updateSaleReturnTotal()"></td>
                `;
                itemsTbody.appendChild(tr);
            });
            
            document.getElementById('salesReturnItemsContainer').style.display = 'block';
            updateSaleReturnTotal();
        }

        function updateSaleReturnTotal() {
            let total = 0;
            document.querySelectorAll('#salesReturnItemsList tr').forEach(tr => {
                const price = parseFloat(tr.dataset.price);
                const qty = parseInt(tr.querySelector('input').value) || 0;
                total += price * qty;
            });
            document.getElementById('salesReturnTotal').textContent = total.toFixed(2);
        }

        async function saveSaleReturn() {
            if (!activeSaleReturn) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø«', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const returnedItems = [];
            let totalReturnValue = 0;
            document.querySelectorAll('#salesReturnItemsList tr').forEach(tr => {
                const qty = parseInt(tr.querySelector('input').value) || 0;
                if (qty > 0) {
                    const originalItem = activeSaleReturn.items.find(i => i.id == tr.dataset.itemId);
                    returnedItems.push({
                        id: originalItem.id,
                        name: originalItem.name,
                        price: originalItem.price,
                        quantity: qty
                    });
                    totalReturnValue += originalItem.price * qty;
                }
            });

            if (returnedItems.length === 0) {
                showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ ÙƒÙ…ÙŠØ§Øª Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹', 'warning');
                return;
            }

            returnedItems.forEach(returnedItem => {
                const itemInStock = items.find(i => i.id === returnedItem.id);
                if (itemInStock) {
                    itemInStock.stock += returnedItem.quantity;
                }
            });

            const newReturn = {
                id: Date.now(),
                number: currentSaleReturnNumber,
                date: new Date().toISOString().split('T')[0],
                originalInvoiceId: activeSaleReturn.id,
                originalInvoiceNumber: activeSaleReturn.number,
                customerId: activeSaleReturn.customerId,
                items: returnedItems,
                total: totalReturnValue
            };


// --- ðŸ’¡ Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ---
            // 1. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            const originalSaleIndex = sales.findIndex(s => s.id === activeSaleReturn.id);
            
            if (originalSaleIndex > -1) {
                // 2. Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                const originalSale = sales[originalSaleIndex];
                
                // Ø®ØµÙ… Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ
                originalSale.total = roundCurrency((originalSale.total || 0) - totalReturnValue);
                originalSale.remainingAmount = roundCurrency((originalSale.remainingAmount || 0) - totalReturnValue);
                
                // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                originalSale.notes = (originalSale.notes || '') + ` [Ù…Ø±ØªØ¬Ø¹ Ø¨Ù‚ÙŠÙ…Ø©: ${totalReturnValue.toFixed(2)}]`;
                
                debugLog('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©:', sales[originalSaleIndex]);
            }
            // --- ðŸ’¡ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ---

            // Ø§Ù„Ø³Ø·Ø± 7930 ÙŠØ¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§
         salesReturns.push(newReturn);
            currentSaleReturnNumber++;
            
            const success1 = await saveToFirebase('salesReturns', salesReturns);
            const success2 = await saveToFirebase('items', items);
            const success3 = await saveToFirebase('sales', sales); // <-- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: Ù„Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            
            if (success1 && success2 && success3) { // <-- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±Ø·: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ ÙƒÙ„ Ø´ÙŠØ¡
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø±Ù‚Ù… SR${newReturn.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                newSaleReturn();
                renderSalesReturns();
                updateDashboard();
                renderItems();
                renderSalesList(); // <-- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: Ù„ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

       function renderSalesReturns() {
    const tbody = document.getElementById('salesReturnsList');
    // ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
    tbody.parentElement.querySelector('thead tr').innerHTML = `
        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
        <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th> 
    `;

    tbody.innerHTML = '';
    if (salesReturns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Øª</td></tr>';
        return;
    }
    salesReturns.forEach(sr => {
        const customer = customers.find(c => c.id === sr.customerId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>SR${sr.number.toString().padStart(3, '0')}</td>
            <td>${sr.date}</td>
            <td>${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>SAL${sr.originalInvoiceNumber.toString().padStart(3, '0')}</td>
            <td>${sr.total.toFixed(2)}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-danger" onclick="deleteSaleReturn(${sr.id})">Ø­Ø°Ù</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

     function newPurchase() {
    currentPurchaseItems = [];
    editingPurchaseId = null;
    document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('purchaseSupplier').value = '';
    document.getElementById('purchaseNotes').value = '';
    document.getElementById('purchasePaidAmount').value = '';
    
    document.getElementById('purchaseAttachment').value = null;
    
    generatePurchaseCode();
    document.getElementById('savePurchaseBtn').textContent = 'ðŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
    renderPurchaseItems();
    updatePurchaseTotals();
    renderPurchasesList();
}
        function findPurchaseForReturn() {
            const invoiceNumber = parseInt(document.getElementById('purchaseReturnInvoiceSearch').value);
            if (isNaN(invoiceNumber)) {
                showNotification('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ØµØ­ÙŠØ­', 'warning');
                return;
            }
            
            const purchase = purchases.find(p => p.number === invoiceNumber);
            if (!purchase) {
                showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…', 'error');
                newPurchaseReturn();
                return;
            }

            activePurchaseReturn = purchase;
            const supplier = suppliers.find(s => s.id === purchase.supplierId);
            
            const detailsDiv = document.getElementById('purchaseReturnInvoiceDetails');
            detailsDiv.innerHTML = `
                <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> PUR${purchase.number.toString().padStart(3, '0')}</p>
                <p><strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${purchase.date}</p>
            `;
            detailsDiv.style.display = 'block';

            const itemsTbody = document.getElementById('purchaseReturnItemsList');
            itemsTbody.innerHTML = '';
            purchase.items.forEach(item => {
                const tr = document.createElement('tr');
                tr.dataset.itemId = item.id;
                tr.dataset.price = item.price;
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td><input type="number" class="return-item-qty-input" min="0" max="${item.quantity}" value="0" oninput="updatePurchaseReturnTotal()"></td>
                `;
                itemsTbody.appendChild(tr);
            });
            
            document.getElementById('purchaseReturnItemsContainer').style.display = 'block';
            updatePurchaseReturnTotal();
        }

        function updatePurchaseReturnTotal() {
            let total = 0;
            document.querySelectorAll('#purchaseReturnItemsList tr').forEach(tr => {
                const price = parseFloat(tr.dataset.price);
                const qty = parseInt(tr.querySelector('input').value) || 0;
                total += price * qty;
            });
            document.getElementById('purchaseReturnTotal').textContent = total.toFixed(2);
        }

     async function savePurchaseReturn() {
            if (!activePurchaseReturn) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø«', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const returnedItems = [];
            let totalReturnValue = 0;
            document.querySelectorAll('#purchaseReturnItemsList tr').forEach(tr => {
                const qty = parseInt(tr.querySelector('input').value) || 0;
                if (qty > 0) {
                    const originalItem = activePurchaseReturn.items.find(i => i.id == tr.dataset.itemId);
                    returnedItems.push({
                        id: originalItem.id,
                        name: originalItem.name,
                        price: originalItem.price,
                        quantity: qty
                    });
                    totalReturnValue += originalItem.price * qty;
                }
            });

            if (returnedItems.length === 0) {
                showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙ…ÙŠØ§Øª', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ ÙƒÙ…ÙŠØ§Øª Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹', 'warning');
                return;
            }

            returnedItems.forEach(returnedItem => {
                const itemInStock = items.find(i => i.id === returnedItem.id);
                if (itemInStock) {
                    itemInStock.stock -= returnedItem.quantity;
                }
            });

            const newReturn = {
                id: Date.now(),
                number: currentPurchaseReturnNumber,
                date: new Date().toISOString().split('T')[0],
                originalInvoiceId: activePurchaseReturn.id,
                originalInvoiceNumber: activePurchaseReturn.number,
                supplierId: activePurchaseReturn.supplierId,
                items: returnedItems,
                total: totalReturnValue
            };

            // --- ðŸ’¡ Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ­Ø¯ÙŠØ« ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ© ---
            // 1. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            const originalPurchaseIndex = purchases.findIndex(p => p.id === activePurchaseReturn.id);

            if (originalPurchaseIndex > -1) {
                // 2. Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                const originalPurchase = purchases[originalPurchaseIndex];
                
                // Ø®ØµÙ… Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ
                originalPurchase.total = roundCurrency((originalPurchase.total || 0) - totalReturnValue);
                originalPurchase.remainingAmount = roundCurrency((originalPurchase.remainingAmount || 0) - totalReturnValue);
                
                // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                originalPurchase.notes = (originalPurchase.notes || '') + ` [Ù…Ø±ØªØ¬Ø¹ Ø¨Ù‚ÙŠÙ…Ø©: ${totalReturnValue.toFixed(2)}]`;
                
                debugLog('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©:', purchases[originalPurchaseIndex]);
            }
            // --- ðŸ’¡ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ---

            purchaseReturns.push(newReturn);
            currentPurchaseReturnNumber++;
            
            const success1 = await saveToFirebase('purchaseReturns', purchaseReturns);
            const success2 = await saveToFirebase('items', items);
            const success3 = await saveToFirebase('purchases', purchases); // <-- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            
            if (success1 && success2 && success3) { // <-- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±Ø·
                showNotification('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸', `ØªÙ… Ø­ÙØ¸ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…GitÂ¹S-PR${newReturn.number.toString().padStart(3, '0')} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                newPurchaseReturn();
                renderPurchaseReturns();
                updateDashboard();
                renderItems();
                renderPurchasesList(); // <-- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }
function renderPurchaseReturns() {
    const tbody = document.getElementById('purchaseReturnsList');
    // ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
    tbody.parentElement.querySelector('thead tr').innerHTML = `
        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
        <th>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    `;

    tbody.innerHTML = '';
    if (purchaseReturns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø´ØªØ±ÙŠØ§Øª</td></tr>';
        return;
    }
    purchaseReturns.forEach(pr => {
        const supplier = suppliers.find(s => s.id === pr.supplierId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>PR${pr.number.toString().padStart(3, '0')}</td>
            <td>${pr.date}</td>
            <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>PUR${pr.originalInvoiceNumber.toString().padStart(3, '0')}</td>
            <td>${pr.total.toFixed(2)}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-danger" onclick="deletePurchaseReturn(${pr.id})">Ø­Ø°Ù</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

        function calculateTotalStock() {
            return items.reduce((total, item) => total + (parseInt(item.stock) || 0), 0);
        }

        // ===== Expenses and Revenues Functions =====
    async function addExpense() {
    const date = document.getElementById('expenseDate').value;
    const category = document.getElementById('expenseCategory').value;
    const amount = parseFloat(document.getElementById('expenseAmount').value);
    if (!date || !category || isNaN(amount)) { 
        showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning'); 
        return; 
    }

    const attachmentFile = document.getElementById('expenseAttachment').files[0];
    let attachmentUrl = null;

    if (attachmentFile) {
        attachmentUrl = await uploadFile(attachmentFile, 'expenses');
        if (!attachmentUrl) {
            showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹', 'ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚ØŒ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ', 'error');
            return;
        }
    }

    const expense = { 
        id: Date.now(), 
        date, 
        category, 
        amount, 
        description: document.getElementById('expenseDescription').value, 
        paymentMethod: document.getElementById('expensePaymentMethod').value, 
        reference: document.getElementById('expenseReference').value,
        attachmentUrl: attachmentUrl 
    };
    
    expenses.push(expense);
    const success = await saveToFirebase('expenses', expenses);
    if (success) {
        clearExpenseForm(); 
        renderExpenses();
        updateExpenseStats();
        updateDashboard();
    } else {
        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}
       function renderExpenses() {
    const tbody = document.getElementById('expensesList');
    tbody.innerHTML = '';
    if (expenses.length === 0) { 
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª</td></tr>'; // ðŸ’¡ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø¥Ù„Ù‰ 8
        return; 
    }
    
    [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(exp => {
        const tr = document.createElement('tr');
        
        const attachmentLink = exp.attachmentUrl 
            ? `<a href="${exp.attachmentUrl}" target="_blank" class="btn-info" style="padding: 4px 8px; text-decoration: none;">Ø¹Ø±Ø¶</a>`
            : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        
        tr.innerHTML = `
            <td>${exp.date}</td>
            <td>${exp.category}</td>
            <td>${exp.amount.toFixed(2)}</td>
            <td>${getPaymentMethodName(exp.paymentMethod)}</td>
            <td>${exp.description || '-'}</td>
            <td>${exp.reference || '-'}</td>
            <td>${attachmentLink}</td>
            <td>
                <button class="btn-warning edit-btn" onclick="editExpense(${exp.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn-danger" onclick="deleteExpense(${exp.id})">Ø­Ø°Ù</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}
        function getPaymentMethodName(method) { return { 'cash': 'Ù†Ù‚Ø¯ÙŠ', 'bank': 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ', 'check': 'Ø´ÙŠÙƒ', 'card': 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†' }[method] || method; }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseCategory').value = expense.category;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseDescription').value = expense.description || '';
            document.getElementById('expensePaymentMethod').value = expense.paymentMethod;
            document.getElementById('expenseReference').value = expense.reference || '';
            const btn = document.querySelector('#expenses .btn-primary');
            btn.textContent = 'ðŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ';
            btn.onclick = () => updateExpense(id);
        }

        async function updateExpense(id) {
            const date = document.getElementById('expenseDate').value, category = document.getElementById('expenseCategory').value, amount = parseFloat(document.getElementById('expenseAmount').value);
            if (!date || !category || isNaN(amount)) { showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning'); return; }
            const index = expenses.findIndex(e => e.id === id);
            if (index > -1) {
                expenses[index] = { ...expenses[index], date, category, amount, description: document.getElementById('expenseDescription').value, paymentMethod: document.getElementById('expensePaymentMethod').value, reference: document.getElementById('expenseReference').value };
                const success = await saveToFirebase('expenses', expenses);
                if (success) {
                    clearExpenseForm();
                    renderExpenses();
                    updateExpenseStats();
                    showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            }
        }
        
        async function deleteExpense(id) {
            const confirmed = await showConfirmDialog(
                'Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ',
                'warning',
                'Ù†Ù‚Ù„',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                const expense = expenses.find(e => e.id === id);
                if (expense) {
                    moveToTrash('expenses', expense);
                    expenses = expenses.filter(e => e.id !== id);
                    const success = await saveToFirebase('expenses', expenses);
                    if (success) {
                        renderExpenses();
                        updateExpenseStats();
                        updateDashboard();
                        showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            }
        }
        
      function clearExpenseForm() {
    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    ['expenseCategory', 'expenseAmount', 'expenseDescription', 'expenseReference'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('expensePaymentMethod').value = 'cash';
    
    document.getElementById('expenseAttachment').value = null; 
    
    const btn = document.querySelector('#expenses .btn-primary');
    btn.textContent = 'âž• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ';
    btn.onclick = addExpense;
}
        function updateExpenseStats() {
            const today = new Date().toISOString().split('T')[0];
            const month = today.substring(0, 7);
            const total = expenses.reduce((s, e) => s + e.amount, 0);
            const todayTotal = expenses.filter(e => e.date === today).reduce((s, e) => s + e.amount, 0);
            const monthTotal = expenses.filter(e => e.date.substring(0, 7) === month).reduce((s, e) => s + e.amount, 0);
            document.getElementById('totalExpenses').textContent = total.toFixed(2);
            document.getElementById('todayExpenses').textContent = todayTotal.toFixed(2);
            document.getElementById('monthExpenses').textContent = monthTotal.toFixed(2);
        }
        
        async function addRevenue() {
            const date = document.getElementById('revenueDate').value, category = document.getElementById('revenueCategory').value, amount = parseFloat(document.getElementById('revenueAmount').value);
            if (!date || !category || isNaN(amount)) { showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning'); return; }
            const revenue = { id: Date.now(), date, category, amount, source: document.getElementById('revenueSource').value, description: document.getElementById('revenueDescription').value, reference: document.getElementById('revenueReference').value };
            revenues.push(revenue);
            const success = await saveToFirebase('revenues', revenues);
            if (success) {
                clearRevenueForm();
                renderRevenues();
                updateRevenueStats();
                updateDashboard();
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }
        function renderRevenues() {
            const tbody = document.getElementById('revenuesList');
            tbody.innerHTML = '';
            if (revenues.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</td></tr>'; return; }
             [...revenues].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(rev => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${rev.date}</td><td>${rev.category}</td><td>${getRevenueSourceName(rev.source)}</td><td>${rev.amount.toFixed(2)}</td><td>${rev.description || '-'}</td><td>${rev.reference || '-'}</td><td><button class="btn-warning edit-btn" onclick="editRevenue(${rev.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button><button class="btn-danger" onclick="deleteRevenue(${rev.id})">Ø­Ø°Ù</button></td>`;
                tbody.appendChild(tr);
            });
        }
        function getRevenueSourceName(source) { return { 'sales': 'Ù…Ø¨ÙŠØ¹Ø§Øª', 'services': 'Ø®Ø¯Ù…Ø§Øª', 'investment': 'Ø§Ø³ØªØ«Ù…Ø§Ø±', 'other': 'Ø£Ø®Ø±Ù‰' }[source] || source; }
        function editRevenue(id) {
            const rev = revenues.find(r => r.id === id);
            if (!rev) return;
            document.getElementById('revenueDate').value = rev.date;
            document.getElementById('revenueCategory').value = rev.category;
            document.getElementById('revenueAmount').value = rev.amount;
            document.getElementById('revenueDescription').value = rev.description || '';
            document.getElementById('revenueSource').value = rev.source;
            document.getElementById('revenueReference').value = rev.reference || '';
            const btn = document.querySelector('#revenues .btn-primary');
            btn.textContent = 'ðŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯';
            btn.onclick = () => updateRevenue(id);
        }
        async function updateRevenue(id) {
            const date = document.getElementById('revenueDate').value, category = document.getElementById('revenueCategory').value, amount = parseFloat(document.getElementById('revenueAmount').value);
            if (!date || !category || isNaN(amount)) { showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning'); return; }
            const index = revenues.findIndex(r => r.id === id);
            if (index > -1) {
                revenues[index] = { ...revenues[index], date, category, amount, source: document.getElementById('revenueSource').value, description: document.getElementById('revenueDescription').value, reference: document.getElementById('revenueReference').value };
                const success = await saveToFirebase('revenues', revenues);
                if (success) {
                    clearRevenueForm();
                    renderRevenues();
                    updateRevenueStats();
                    showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            }
        }
        async function deleteRevenue(id) {
            const confirmed = await showConfirmDialog(
                'Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª',
                'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ',
                'warning',
                'Ù†Ù‚Ù„',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                const revenue = revenues.find(r => r.id === id);
                if (revenue) {
                    moveToTrash('revenues', revenue);
                    revenues = revenues.filter(r => r.id !== id);
                    const success = await saveToFirebase('revenues', revenues);
                    if (success) {
                        renderRevenues();
                        updateRevenueStats();
                        updateDashboard();
                        showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
                    } else {
                        showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    }
                }
            }
        }
        function clearRevenueForm() {
            document.getElementById('revenueDate').value = new Date().toISOString().split('T')[0];
            ['revenueCategory', 'revenueAmount', 'revenueDescription', 'revenueReference'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('revenueSource').value = 'sales';
            const btn = document.querySelector('#revenues .btn-primary');
            btn.textContent = 'âž• Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ±Ø§Ø¯';
            btn.onclick = addRevenue;
        }
        function updateRevenueStats() {
            const today = new Date().toISOString().split('T')[0];
            const month = today.substring(0, 7);
            const total = revenues.reduce((s, r) => s + r.amount, 0);
            const todayTotal = revenues.filter(r => r.date === today).reduce((s, r) => s + r.amount, 0);
            const monthTotal = revenues.filter(r => r.date.substring(0, 7) === month).reduce((s, r) => s + r.amount, 0);
            document.getElementById('totalRevenues').textContent = total.toFixed(2);
            document.getElementById('todayRevenues').textContent = todayTotal.toFixed(2);
            document.getElementById('monthRevenues').textContent = monthTotal.toFixed(2);
        }

        // ===== Salaries Functions =====
        function normalizeAmount(value) {
            const amount = parseFloat(value);
            return Number.isFinite(amount) ? amount : 0;
        }

        function roundCurrency(value) {
            return Math.round((Number(value) || 0) * 100) / 100;
        }

        function formatCurrency(value) {
            const amount = Number(value);
            return Number.isFinite(amount) ? amount.toFixed(2) : '0.00';
        }

        function getSalaryFormValues() {
            const monthInput = document.getElementById('salaryMonth');
            if (!monthInput) return null;
            const getValue = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };
            return {
                month: monthInput.value || '',
                employeeName: getValue('salaryEmployeeName').trim(),
                employeeId: getValue('salaryEmployeeId').trim(),
                jobTitle: getValue('salaryJobTitle').trim(),
                basic: getValue('salaryBasic') || '0',
                housing: getValue('salaryHousing') || '0',
                transport: getValue('salaryTransport') || '0',
                otherAllowances: getValue('salaryOtherAllowances') || '0',
                overtime: getValue('salaryOvertime') || '0',
                otherDeductions: getValue('salaryOtherDeductions') || '0',
                notes: getValue('salaryNotes').trim()
            };
        }

        function computeSalaryBreakdown(formData) {
            const basic = roundCurrency(normalizeAmount(formData.basic));
            const housing = roundCurrency(normalizeAmount(formData.housing));
            const transport = roundCurrency(normalizeAmount(formData.transport));
            const otherAllowances = roundCurrency(normalizeAmount(formData.otherAllowances));
            const overtime = roundCurrency(normalizeAmount(formData.overtime));
            const allowancesTotal = roundCurrency(housing + transport + otherAllowances + overtime);
            const gross = roundCurrency(basic + allowancesTotal);
            const gosiBase = Math.min(basic + housing, GOSI_SALARY_CAP);
            const gosiEmployee = roundCurrency(gosiBase * GOSI_RATE);
            const gosiEmployer = roundCurrency(gosiBase * GOSI_RATE);
            const otherDeductions = roundCurrency(normalizeAmount(formData.otherDeductions));
            const net = roundCurrency(gross - gosiEmployee - otherDeductions);

            return {
                basic,
                housing,
                transport,
                otherAllowances,
                overtime,
                allowancesTotal,
                gross,
                gosiEmployee,
                gosiEmployer,
                otherDeductions,
                net
            };
        }

        async function addSalary() {
            const formData = getSalaryFormValues();
            if (!formData) return;
            if (!formData.month || !formData.employeeName || !formData.employeeId) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ', 'warning');
                return;
            }
            if (normalizeAmount(formData.basic) <= 0) {
                showNotification('âš ï¸ Ø±Ø§ØªØ¨ ØºÙŠØ± ØµØ­ÙŠØ­', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'warning');
                return;
            }
            const breakdown = computeSalaryBreakdown(formData);
            const salaryRecord = {
                id: Date.now(),
                month: formData.month,
                employeeName: formData.employeeName,
                employeeId: formData.employeeId,
                jobTitle: formData.jobTitle,
                notes: formData.notes,
                basic: breakdown.basic,
                housing: breakdown.housing,
                transport: breakdown.transport,
                otherAllowances: breakdown.otherAllowances,
                overtime: breakdown.overtime,
                allowancesTotal: breakdown.allowancesTotal,
                gross: breakdown.gross,
                gosiEmployee: breakdown.gosiEmployee,
                gosiEmployer: breakdown.gosiEmployer,
                otherDeductions: breakdown.otherDeductions,
                net: breakdown.net,
                createdAt: new Date().toISOString()
            };

            salaries.push(salaryRecord);
            const success = await saveToFirebase('salaries', salaries);
            if (success) {
                clearSalaryForm();
                renderSalaries();
                updateSalarySummary();
                updateDataStats();
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨', 'error');
            }
        }

        async function updateSalary(id) {
            const formData = getSalaryFormValues();
            if (!formData) return;
            if (!formData.month || !formData.employeeName || !formData.employeeId) {
                showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ', 'warning');
                return;
            }
            const index = salaries.findIndex(s => s.id === id);
            if (index === -1) return;
            const breakdown = computeSalaryBreakdown(formData);
            const existing = salaries[index];
            salaries[index] = {
                ...existing,
                month: formData.month,
                employeeName: formData.employeeName,
                employeeId: formData.employeeId,
                jobTitle: formData.jobTitle,
                notes: formData.notes,
                basic: breakdown.basic,
                housing: breakdown.housing,
                transport: breakdown.transport,
                otherAllowances: breakdown.otherAllowances,
                overtime: breakdown.overtime,
                allowancesTotal: breakdown.allowancesTotal,
                gross: breakdown.gross,
                gosiEmployee: breakdown.gosiEmployee,
                gosiEmployer: breakdown.gosiEmployer,
                otherDeductions: breakdown.otherDeductions,
                net: breakdown.net,
                updatedAt: new Date().toISOString()
            };

            const success = await saveToFirebase('salaries', salaries);
            if (success) {
                showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                clearSalaryForm();
                renderSalaries();
                updateSalarySummary();
                updateDataStats();
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨', 'error');
            }
        }

        function editSalary(id) {
            const salary = salaries.find(s => s.id === id);
            if (!salary) return;
            editingSalaryId = id;
            if (document.getElementById('salaryMonth')) document.getElementById('salaryMonth').value = salary.month || '';
            if (document.getElementById('salaryEmployeeName')) document.getElementById('salaryEmployeeName').value = salary.employeeName || '';
            if (document.getElementById('salaryEmployeeId')) document.getElementById('salaryEmployeeId').value = salary.employeeId || '';
            if (document.getElementById('salaryJobTitle')) document.getElementById('salaryJobTitle').value = salary.jobTitle || '';
            if (document.getElementById('salaryBasic')) document.getElementById('salaryBasic').value = formatCurrency(salary.basic);
            if (document.getElementById('salaryHousing')) document.getElementById('salaryHousing').value = formatCurrency(salary.housing);
            if (document.getElementById('salaryTransport')) document.getElementById('salaryTransport').value = formatCurrency(salary.transport);
            if (document.getElementById('salaryOtherAllowances')) document.getElementById('salaryOtherAllowances').value = formatCurrency(salary.otherAllowances);
            if (document.getElementById('salaryOvertime')) document.getElementById('salaryOvertime').value = formatCurrency(salary.overtime);
            if (document.getElementById('salaryOtherDeductions')) document.getElementById('salaryOtherDeductions').value = formatCurrency(salary.otherDeductions);
            if (document.getElementById('salaryNotes')) document.getElementById('salaryNotes').value = salary.notes || '';

            const addBtn = document.querySelector('#salaries .btn-primary');
            if (addBtn) {
                addBtn.textContent = 'ðŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ÙŠØ±';
                addBtn.onclick = () => updateSalary(id);
            }
        }

        async function deleteSalary(id) {
            const confirmed = await showConfirmDialog(
                'Ø­Ø°Ù Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨',
                'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ÙŠØ±ØŸ',
                'danger',
                'Ø­Ø°Ù',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (!confirmed) return;
            salaries = salaries.filter(s => s.id !== id);
            const success = await saveToFirebase('salaries', salaries);
            if (success) {
                if (editingSalaryId === id) {
                    clearSalaryForm();
                }
                renderSalaries();
                updateSalarySummary();
                updateDataStats();
            } else {
                showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨', 'error');
            }
        }

        function clearSalaryForm(skipSummaryUpdate = true) {
            editingSalaryId = null;
            const monthEl = document.getElementById('salaryMonth');
            let monthWasEmpty = false;
            if (monthEl && !monthEl.value) {
                monthEl.value = new Date().toISOString().slice(0, 7);
                monthWasEmpty = true;
            }
            const inputs = ['salaryEmployeeName', 'salaryEmployeeId', 'salaryJobTitle', 'salaryBasic', 'salaryHousing', 'salaryTransport', 'salaryOtherAllowances', 'salaryOvertime', 'salaryOtherDeductions'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const notesEl = document.getElementById('salaryNotes');
            if (notesEl) notesEl.value = '';

            const addBtn = document.querySelector('#salaries .btn-primary');
            if (addBtn) {
                addBtn.textContent = 'âž• Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙŠØ±';
                addBtn.onclick = addSalary;
            }

            if (monthWasEmpty || !skipSummaryUpdate) {
                updateSalarySummary();
            }
        }

        function renderSalaries(data = null, isFiltered = false) {
            const tbody = document.getElementById('salariesList');
            if (!tbody) return;
            const source = Array.isArray(data) ? data : salaries;
            tbody.innerHTML = '';
            if (source.length === 0) {
                const message = isFiltered ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙŠØ±Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙŠØ±Ø§Øª Ø±ÙˆØ§ØªØ¨ Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯';
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">${message}</td></tr>`;
                return;
            }

            const sorted = [...source].sort((a, b) => {
                if ((b.month || '') > (a.month || '')) return 1;
                if ((b.month || '') < (a.month || '')) return -1;
                return (a.employeeName || '').localeCompare(b.employeeName || '');
            });

            sorted.forEach(salary => {
                const allowances = typeof salary.allowancesTotal === 'number'
                    ? salary.allowancesTotal
                    : normalizeAmount(salary.housing) + normalizeAmount(salary.transport) + normalizeAmount(salary.otherAllowances) + normalizeAmount(salary.overtime);
                const gross = typeof salary.gross === 'number' ? salary.gross : normalizeAmount(salary.basic) + allowances;
                const gosiEmployee = normalizeAmount(salary.gosiEmployee);
                const otherDeductions = normalizeAmount(salary.otherDeductions);
                const net = typeof salary.net === 'number' ? salary.net : gross - gosiEmployee - otherDeductions;
                const tr = document.createElement('tr');
                if (salary.notes) {
                    tr.title = salary.notes;
                }
                tr.innerHTML = `
                    <td>${salary.employeeName || '-'}</td>
                    <td>${salary.month || '-'}</td>
                    <td>${salary.jobTitle || '-'}</td>
                    <td>${formatCurrency(salary.basic)}</td>
                    <td>${formatCurrency(allowances)}</td>
                    <td>${formatCurrency(gross)}</td>
                    <td>${formatCurrency(gosiEmployee)}</td>
                    <td>${formatCurrency(otherDeductions)}</td>
                    <td>${formatCurrency(net)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-warning edit-btn" onclick="editSalary(${salary.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn-danger" onclick="deleteSalary(${salary.id})">Ø­Ø°Ù</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateSalarySummary() {
            const monthInput = document.getElementById('salaryMonth');
            const targetMonth = monthInput ? monthInput.value : '';
            const dataset = targetMonth ? salaries.filter(s => s.month === targetMonth) : [...salaries];
            const totals = dataset.reduce((acc, salary) => {
                acc.count += 1;
                const basic = normalizeAmount(salary.basic);
                const housing = normalizeAmount(salary.housing);
                const transport = normalizeAmount(salary.transport);
                const otherAllowances = normalizeAmount(salary.otherAllowances);
                const overtime = normalizeAmount(salary.overtime);
                const allowances = typeof salary.allowancesTotal === 'number' ? salary.allowancesTotal : housing + transport + otherAllowances + overtime;
                const gross = typeof salary.gross === 'number' ? salary.gross : basic + allowances;
                const gosiEmployee = normalizeAmount(salary.gosiEmployee);
                const gosiEmployer = normalizeAmount(salary.gosiEmployer);
                const otherDeductions = normalizeAmount(salary.otherDeductions);
                const net = typeof salary.net === 'number' ? salary.net : gross - gosiEmployee - otherDeductions;

                acc.basic += basic;
                acc.allowances += allowances;
                acc.gross += gross;
                acc.gosi += gosiEmployee;
                acc.gosiEmployer += gosiEmployer;
                acc.otherDeductions += otherDeductions;
                acc.net += net;
                return acc;
            }, { count: 0, basic: 0, allowances: 0, gross: 0, gosi: 0, gosiEmployer: 0, otherDeductions: 0, net: 0 });

            const summaryCount = document.getElementById('salarySummaryCount');
            if (summaryCount) summaryCount.textContent = totals.count;
            const summaryBasic = document.getElementById('salarySummaryBasic');
            if (summaryBasic) summaryBasic.textContent = formatCurrency(totals.basic);
            const summaryAllowances = document.getElementById('salarySummaryAllowances');
            if (summaryAllowances) summaryAllowances.textContent = formatCurrency(totals.allowances);
            const summaryGross = document.getElementById('salarySummaryGross');
            if (summaryGross) summaryGross.textContent = formatCurrency(totals.gross);
            const summaryGosi = document.getElementById('salarySummaryGosi');
            if (summaryGosi) summaryGosi.textContent = formatCurrency(totals.gosi);
            const summaryGosiEmployer = document.getElementById('salarySummaryGosiEmployer');
            if (summaryGosiEmployer) summaryGosiEmployer.textContent = formatCurrency(totals.gosiEmployer);
            const summaryOther = document.getElementById('salarySummaryOtherDeductions');
            if (summaryOther) summaryOther.textContent = formatCurrency(totals.otherDeductions);
            const summaryNet = document.getElementById('salarySummaryNet');
            if (summaryNet) summaryNet.textContent = formatCurrency(totals.net);

            const miniStat = document.getElementById('miniStatSalaries');
            if (miniStat) miniStat.textContent = formatCurrency(totals.net);
        }

        // ===== Reports Functions =====
        function updateReportItemFilter() {
            const filterType = document.getElementById('reportItemFilter').value;
            const specificItemSelect = document.getElementById('reportSpecificItem');
            if (filterType === 'specific') {
                specificItemSelect.style.display = 'block';
                specificItemSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>';
                items.forEach(item => {
                    specificItemSelect.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                });
            } else {
                specificItemSelect.style.display = 'none';
                specificItemSelect.value = '';
            }
        }
        
        function changeReportType() {
            const reportType = document.getElementById('reportType').value;
            const isInvoiceReport = (reportType === 'sales' || reportType === 'purchases' || reportType === 'sales_returns' || reportType === 'purchase_returns');
            
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙÙ„ØªØ±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù
            document.getElementById('reportItemFilter').style.display = isInvoiceReport ? 'inline-block' : 'none';
            document.getElementById('reportSpecificItem').style.display = 'none';
            
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙÙ„ØªØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ (ÙÙ‚Ø· Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆÙ„ÙŠØ³ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª)
            document.getElementById('paymentStatusFilter').style.display = (reportType === 'sales' || reportType === 'purchases') ? 'inline-block' : 'none';

            const supplierFilter = document.getElementById('reportSupplierFilter');
            const customerFilter = document.getElementById('reportCustomerFilter');

            supplierFilter.style.display = 'none';
            customerFilter.style.display = 'none';

            if (reportType === 'purchases' || reportType === 'purchase_returns') {
                supplierFilter.style.display = 'inline-block';
                supplierFilter.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>';
                suppliers.forEach(supplier => {
                    supplierFilter.innerHTML += `<option value="${supplier.id}">${supplier.name}</option>`;
                });
            } else if (reportType === 'sales' || reportType === 'sales_returns') {
                customerFilter.style.display = 'inline-block';
                customerFilter.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>';
                customers.forEach(customer => {
                    customerFilter.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
                });
            }
        }


function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const fromDate = document.getElementById('reportFrom').value;
    const toDate = document.getElementById('reportTo').value;
    const paymentStatus = document.getElementById('paymentStatusFilter').value;
    const itemFilterType = document.getElementById('reportItemFilter').value;
    const specificItemId = parseInt(document.getElementById('reportSpecificItem').value);
    
    const selectedSupplierId = document.getElementById('reportSupplierFilter').value;
    const selectedCustomerId = document.getElementById('reportCustomerFilter').value;

    let data = [];
    let reportTitle = '';
    let tableHeaders = '';
    let tableBody = '';
    let summary = {
        count: 0,
        totalAmount: 0,
        totalPaid: 0,
        totalRemaining: 0,
        totalBasic: 0,
        totalAllowances: 0,
        totalGross: 0,
        totalGosiEmployee: 0,
        totalGosiEmployer: 0,
        totalOtherDeductions: 0,
        totalNet: 0
    };

    switch (reportType) {
        case 'sales': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª';
            tableHeaders = `<th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>`;
            let src = Array.isArray(sales) ? sales : [];
            data = src.filter(s => (!fromDate || s.date >= fromDate) && (!toDate || s.date <= toDate));
            
            if (selectedCustomerId !== 'all') {
                data = data.filter(s => s.customerId == selectedCustomerId);
            }
            break;
        }
        case 'purchases': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª';
            tableHeaders = `<th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>`;
            let src = Array.isArray(purchases) ? purchases : [];
            data = src.filter(p => (!fromDate || p.date >= fromDate) && (!toDate || p.date <= toDate));

            if (selectedSupplierId !== 'all') {
                data = data.filter(p => p.supplierId == selectedSupplierId);
            }
            break;
        }
        case 'sales_returns': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª';
            tableHeaders = `<th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>`;
            let src = Array.isArray(salesReturns) ? salesReturns : [];
            data = src.filter(r => (!fromDate || r.date >= fromDate) && (!toDate || r.date <= toDate));
            
            if (selectedCustomerId !== 'all') {
                data = data.filter(r => r.customerId == selectedCustomerId);
            }
            break;
        }
        case 'purchase_returns': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª';
            tableHeaders = `<th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>`;
            let src = Array.isArray(purchaseReturns) ? purchaseReturns : [];
            data = src.filter(r => (!fromDate || r.date >= fromDate) && (!toDate || r.date <= toDate));

            if (selectedSupplierId !== 'all') {
                data = data.filter(r => r.supplierId == selectedSupplierId);
            }
            break;
        }
        case 'expenses': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª';
            tableHeaders = `<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th>`;
            const src = Array.isArray(expenses) ? expenses : [];
            data = src.filter(e => (!fromDate || e.date >= fromDate) && (!toDate || e.date <= toDate));
            break;
        }
        case 'revenues': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª';
            tableHeaders = `<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„Ù…ØµØ¯Ø±</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th>`;
            const src = Array.isArray(revenues) ? revenues : [];
            data = src.filter(r => (!fromDate || r.date >= fromDate) && (!toDate || r.date <= toDate));
            break;
        }
        case 'salaries': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨';
            tableHeaders = `<th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th><th>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th><th>Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ GOSI</th><th>Ù…Ø³Ø§Ù‡Ù…Ø© Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„</th><th>Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰</th><th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</th>`;
            const src = Array.isArray(salaries) ? salaries : [];
            data = src.filter(salary => {
                if (!salary) return false;
                const monthValue = salary.month ? `${salary.month}-01` : '';
                const afterFrom = !fromDate || (monthValue && monthValue >= fromDate);
                const beforeTo = !toDate || (monthValue && monthValue <= toDate);
                return afterFrom && beforeTo;
            });
            break;
        }
        case 'profit_loss': {
            reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø©';

            const filteredSales = (Array.isArray(sales) ? sales : [])
                .filter(s => (!fromDate || s.date >= fromDate) && (!toDate || s.date <= toDate));
            const filteredExpenses = (Array.isArray(expenses) ? expenses : [])
                .filter(e => (!fromDate || e.date >= fromDate) && (!toDate || e.date <= toDate));

            const totalSalesRevenue = filteredSales.reduce((sum, sale) => sum + (Number(sale.total) || 0), 0);
            const totalCOGS = calculateCOGS(filteredSales);
            const grossProfit = totalSalesRevenue - totalCOGS;
            const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + (Number(expense.amount) || 0), 0);
            const netProfit = grossProfit - totalExpenses;

            let summaryHtml = `<h3>Ù…Ù„Ø®Øµ ${reportTitle}</h3>
                <p><strong>Ø§Ù„ÙØªØ±Ø© Ù…Ù†:</strong> ${fromDate || '-'} <strong>Ø¥Ù„Ù‰:</strong> ${toDate || '-'}</p>`;
            document.getElementById('reportSummary').innerHTML = summaryHtml;

            let resultsHtml = `
                <h3 style="margin-top:20px;">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
                <table style="text-align: right;">
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</strong></td>
                        <td style="padding: 10px; color: var(--success-color); font-weight: bold;">${totalSalesRevenue.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">(-) ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</td>
                        <td style="padding: 10px; color: var(--accent-color);">${totalCOGS.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 2px solid #333; font-size: 1.1em;">
                        <td style="padding: 10px;"><strong>(=) Ù…Ø¬Ù…Ù„ Ø§Ù„Ø±Ø¨Ø­</strong></td>
                        <td style="padding: 10px; font-weight: bold;">${grossProfit.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px; padding-top: 20px;">(-) Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</td>
                        <td style="padding: 10px; padding-top: 20px; color: var(--accent-color);">${totalExpenses.toFixed(2)}</td>
                    </tr>
                    <tr style="background: ${netProfit >= 0 ? 'var(--success-color)' : 'var(--accent-color)'}; color: white; font-size: 1.2em; border-radius: 8px;">
                        <td style="padding: 15px;"><strong>(=) ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ / Ø§Ù„Ø®Ø³Ø§Ø±Ø©</strong></td>
                        <td style="padding: 15px; font-weight: bold;">${netProfit.toFixed(2)}</td>
                    </tr>
                </table>`;
            document.getElementById('reportResults').innerHTML = resultsHtml;
            return;
        }
    }

    if (reportType === 'sales' || reportType === 'purchases') {
        if (paymentStatus === 'paid' || paymentStatus === 'unpaid') {
            data = data.filter(inv => {
                const total = Number(inv.total) || 0;
                const paid = Number(inv.paidAmount) || 0;
                const remaining = total - paid;
                
                if (paymentStatus === 'paid') {
                    return remaining <= 0.01;
                } else {
                    return remaining > 0.01;
                }
            });
        }
    }

    if ((reportType === 'sales' || reportType === 'purchases' || reportType === 'sales_returns' || reportType === 'purchase_returns')
        && itemFilterType === 'specific' && specificItemId) {
        data = data.filter(invoice =>
            Array.isArray(invoice.items) && invoice.items.some(it => it.id === specificItemId)
        );
    }

if (data.length > 0) {
    data.forEach(item => {
        if (reportType === 'sales') {
            const customer = (Array.isArray(customers) ? customers : []).find(c => c.id === item.customerId);
            const total = Number(item.total) || 0;
            const paid  = Number(item.paidAmount) || 0;
            const remaining = total - paid;

            tableBody += `<tr>
                <td>SAL${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                <td>${total.toFixed(2)}</td>
                <td>${paid.toFixed(2)}</td>
                <td class="${Math.abs(remaining) <= 0.01 ? 'remaining-paid' : 'remaining-unpaid'}">${remaining.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;
            summary.totalPaid   += paid;
            summary.totalRemaining += remaining;

        } else if (reportType === 'purchases') {
            const supplier = (Array.isArray(suppliers) ? suppliers : []).find(s => s.id === item.supplierId);
            const total = Number(item.total) || 0;
            const paid  = Number(item.paidAmount) || 0;
            const remaining = total - paid;

            tableBody += `<tr>
                <td>PUR${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                <td>${total.toFixed(2)}</td>
                <td>${paid.toFixed(2)}</td>
                <td class="${Math.abs(remaining) <= 0.01 ? 'remaining-paid' : 'remaining-unpaid'}">${remaining.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;
            summary.totalPaid   += paid;
            summary.totalRemaining += remaining;

        } else if (reportType === 'sales_returns') {
            const customer = (Array.isArray(customers) ? customers : []).find(c => c.id === item.customerId);
            const total = Number(item.total) || 0;
            const originalSale = (Array.isArray(sales) ? sales : []).find(s => s.id === item.saleId);
            const originalInvoiceNumber = originalSale ? `SAL${originalSale.number.toString().padStart(3, '0')}` : '-';

            tableBody += `<tr>
                <td>SR${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${customer ? customer.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                <td>${originalInvoiceNumber}</td>
                <td>${total.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;

        } else if (reportType === 'purchase_returns') {
            const supplier = (Array.isArray(suppliers) ? suppliers : []).find(s => s.id === item.supplierId);
            const total = Number(item.total) || 0;
            const originalPurchase = (Array.isArray(purchases) ? purchases : []).find(p => p.id === item.purchaseId);
            const originalInvoiceNumber = originalPurchase ? `PUR${originalPurchase.number.toString().padStart(3, '0')}` : '-';

            tableBody += `<tr>
                <td>PR${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${supplier ? supplier.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                <td>${originalInvoiceNumber}</td>
                <td>${total.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;

        } else if (reportType === 'expenses') {
                const amount = Number(item.amount) || 0;
                tableBody += `<tr>
                    <td>${item.date}</td>
                    <td>${item.category}</td>
                    <td>${item.description || '-'}</td>
                    <td>${amount.toFixed(2)}</td>
                </tr>`;
                summary.totalAmount += amount;

            } else if (reportType === 'revenues') {
                const amount = Number(item.amount) || 0;
                tableBody += `<tr>
                    <td>${item.date}</td>
                    <td>${item.category}</td>
                    <td>${getRevenueSourceName(item.source)}</td>
                    <td>${amount.toFixed(2)}</td>
                </tr>`;
                summary.totalAmount += amount;
                } else if (reportType === 'salaries') {
                    const basic = normalizeAmount(item.basic);
                    const housing = normalizeAmount(item.housing);
                    const transport = normalizeAmount(item.transport);
                    const otherAllowances = normalizeAmount(item.otherAllowances);
                    const overtime = normalizeAmount(item.overtime);
                    const allowances = typeof item.allowancesTotal === 'number' ? item.allowancesTotal : housing + transport + otherAllowances + overtime;
                    const gross = typeof item.gross === 'number' ? item.gross : basic + allowances;
                    const gosiEmployee = normalizeAmount(item.gosiEmployee);
                    const gosiEmployer = normalizeAmount(item.gosiEmployer);
                    const otherDeductions = normalizeAmount(item.otherDeductions);
                    const net = typeof item.net === 'number' ? item.net : gross - gosiEmployee - otherDeductions;

                    tableBody += `<tr>
                        <td>${item.employeeName || '-'}</td>
                        <td>${item.month || '-'}</td>
                        <td>${item.jobTitle || '-'}</td>
                        <td>${formatCurrency(basic)}</td>
                        <td>${formatCurrency(allowances)}</td>
                        <td>${formatCurrency(gross)}</td>
                        <td>${formatCurrency(gosiEmployee)}</td>
                        <td>${formatCurrency(gosiEmployer)}</td>
                        <td>${formatCurrency(otherDeductions)}</td>
                        <td>${formatCurrency(net)}</td>
                    </tr>`;

                    summary.totalBasic += basic;
                    summary.totalAllowances += allowances;
                    summary.totalGross += gross;
                    summary.totalGosiEmployee += gosiEmployee;
                    summary.totalGosiEmployer += gosiEmployer;
                    summary.totalOtherDeductions += otherDeductions;
                    summary.totalNet += net;
                    summary.totalAmount += net;
            }
        });
        summary.count = data.length;
    }

    const summaryDiv = document.getElementById('reportSummary');
    let summaryHtml = `<h3>Ù…Ù„Ø®Øµ ${reportTitle}</h3>`;
    if (reportType === 'sales' || reportType === 'purchases') {
        summaryHtml += `
            <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</strong> ${summary.count}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº:</strong> ${summary.totalAmount.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${summary.totalPaid.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${summary.totalRemaining.toFixed(2)}</p>`;
    } else if (reportType === 'sales_returns' || reportType === 'purchase_returns') {
        summaryHtml += `
            <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª:</strong> ${summary.count}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª:</strong> ${summary.totalAmount.toFixed(2)}</p>`;
    } else if (reportType === 'salaries') {
        summaryHtml += `
            <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ÙŠØ±Ø§Øª:</strong> ${summary.count}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</strong> ${summary.totalBasic.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª:</strong> ${summary.totalAllowances.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨:</strong> ${summary.totalGross.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª GOSI Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†:</strong> ${summary.totalGosiEmployee.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³Ø§Ù‡Ù…Ø§Øª Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ GOSI:</strong> ${summary.totalGosiEmployer.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰:</strong> ${summary.totalOtherDeductions.toFixed(2)}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµØ§ÙÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨:</strong> ${summary.totalNet.toFixed(2)}</p>`;
    } else {
        summaryHtml += `
            <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:</strong> ${summary.count}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº:</strong> ${summary.totalAmount.toFixed(2)}</p>`;
    }
    summaryDiv.innerHTML = summaryHtml;

    const resultsDiv = document.getElementById('reportResults');
    if (tableBody) {
        if (reportType === 'sales' || reportType === 'purchases') {
            tableBody += `<tr class="report-total-row">
                <td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                <td>${summary.totalAmount.toFixed(2)}</td>
                <td>${summary.totalPaid.toFixed(2)}</td>
                <td>${summary.totalRemaining.toFixed(2)}</td>
            </tr>`;
        } else if (reportType === 'sales_returns' || reportType === 'purchase_returns') {
            tableBody += `<tr class="report-total-row">
                <td colspan="4">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                <td>${summary.totalAmount.toFixed(2)}</td>
            </tr>`;
        } else if (reportType === 'salaries') {
            tableBody += `<tr class="report-total-row">
                <td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                <td>${summary.totalBasic.toFixed(2)}</td>
                <td>${summary.totalAllowances.toFixed(2)}</td>
                <td>${summary.totalGross.toFixed(2)}</td>
                <td>${summary.totalGosiEmployee.toFixed(2)}</td>
                <td>${summary.totalGosiEmployer.toFixed(2)}</td>
                <td>${summary.totalOtherDeductions.toFixed(2)}</td>
                <td>${summary.totalNet.toFixed(2)}</td>
            </tr>`;
        } else {
            tableBody += `<tr class="report-total-row">
                <td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                <td>${summary.totalAmount.toFixed(2)}</td>
            </tr>`;
        }

        resultsDiv.innerHTML = `
            <h3 style="margin-top:20px;">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
            <table>
                <thead><tr>${tableHeaders}</tr></thead>
                <tbody>${tableBody}</tbody>
            </table>`;
    } else {
        resultsDiv.innerHTML = `<p style="text-align: center; margin-top: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</p>`;
    }
}


        function exportToExcel() {
            const reportTable = document.querySelector("#reportResults table");
            if (!reportTable) {
                showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ±', 'ÙŠØ±Ø¬Ù‰ Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±', 'warning');
                return;
            }

            let csv = [];
            const headers = [];
            reportTable.querySelectorAll("thead th").forEach(header => headers.push(`"${header.innerText}"`));
            csv.push(headers.join(','));

            reportTable.querySelectorAll("tbody tr").forEach(row => {
                const rowData = [];
                row.querySelectorAll("td").forEach(cell => rowData.push(`"${cell.innerText}"`));
                csv.push(rowData.join(','));
            });

            const csvContent = "data:text/csv;charset=utf-8," + '\uFEFF' + csv.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const reportType = document.getElementById('reportType').value;
            link.setAttribute("download", `report_${reportType}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToWeb() {
            const reportResultsHTML = document.getElementById('reportResults').innerHTML;
            const reportSummaryHTML = document.getElementById('reportSummary').innerHTML;

            if (!reportResultsHTML.trim() || reportResultsHTML.includes("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª")) {
                showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ±', 'ÙŠØ±Ø¬Ù‰ Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±', 'warning');
                return;
            }
            
            const reportType = document.getElementById('reportType').value;
            const reportTitle = `ØªÙ‚Ø±ÙŠØ± ${document.querySelector(`#reportType option[value='${reportType}']`).textContent}`;

            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                    <head>
                        <title>${reportTitle}</title>
                        <meta charset="UTF-8">
                        <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">



                        <style>
                            body { font-family: 'Tajawal', sans-serif; direction: rtl; padding: 20px; color: #2c3e50; }
                            h1, h3 { color: #2c5aa0; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 14px; }
                            th, td { border: 1px solid #ddd; padding: 10px; text-align: right; }
                            th { background-color: #2c5aa0; color: white; }
                            tr:nth-child(even) { background-color: #f8f9fa; }
                            .report-summary { border: 1px solid #ddd; border-right: 5px solid #2c5aa0; padding: 15px; margin-bottom: 20px; background: #f8f9fa; border-radius: 8px; }
                            .report-total-row { font-weight: bold; background-color: #34495e; color: white; }
                            .remaining-paid { color: #27ae60; font-weight: bold; }
                            .remaining-unpaid { color: #e74c3c; font-weight: bold; }
                            @media print {
                                body { padding: 10px; }
                                button { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>${reportTitle}</h1>
                        <div class="report-summary">${reportSummaryHTML}</div>
                        ${reportResultsHTML}
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="window.print()" style="padding: 10px 20px; background: #2c5aa0; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">ðŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-right: 10px;">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </body>
                </html>
            `);
            newWindow.document.close();
        }

        // ===== Data Management Functions =====
        function ensureActivitySelected() {
            if (!currentActivityId) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø´Ø§Ø· Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'warning');
                return false;
            }
            return true;
        }

        async function refreshActivityData() {
            if (!currentActivityId) return;
            await initializeApp();
        }

        function updateDataStats() {
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            setText('dataItemsCount', items.length);
            setText('dataCustomersCount', customers.length);
            setText('dataSuppliersCount', suppliers.length);
            setText('dataPurchasesCount', purchases.length);
            setText('dataSalesCount', sales.length);
            setText('dataExpensesCount', expenses.length);
            setText('dataRevenuesCount', revenues.length);
            setText('dataSalariesCount', salaries.length);
            setText('dataStockQuantity', calculateTotalStock());
            const hasActivity = Boolean(currentActivityId);
            let lastBackupText = 'ØºÙŠØ± Ù…ØªØ§Ø­';
            if (hasActivity) {
                const backupKey = getActivityDataKey('lastBackup');
                const lastBackup = backupKey ? localStorage.getItem(backupKey) : null;
                lastBackupText = lastBackup ? new Date(lastBackup).toLocaleDateString('ar-SA') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            }
            setText('dataLastBackup', lastBackupText);
        }

        function exportActivityData() {
            if (!ensureActivitySelected()) return;
            const activity = activities.find(a => a.id == currentActivityId);
            const activityData = { items, customers, suppliers, purchases, sales, expenses, revenues, salaries, salesReturns, purchaseReturns, exportDate: new Date().toISOString(), system: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ', activityName: activity ? activity.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' };
            const dataStr = JSON.stringify(activityData, null, 2);
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([dataStr], {type: 'application/json'}));
            link.download = `Ø§Ù„Ø¯ÙŠÙˆØ§Ù†_${activity ? activity.name.replace(/\s/g, '_') : 'Ø¨ÙŠØ§Ù†Ø§Øª'}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showNotification('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        function exportActivityDataExcel() {
            if (!ensureActivitySelected()) return;
            if (!window.XLSX || !XLSX.utils || typeof XLSX.utils.book_new !== 'function') {
                showNotification('âŒ Ø®Ø·Ø£', 'Ù…ÙƒØªØ¨Ø© Excel ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
                return;
            }

            const activity = activities.find(a => a.id == currentActivityId);
            const workbook = XLSX.utils.book_new();
            const todayISO = new Date().toISOString();
            const todayDate = todayISO.split('T')[0];

            const safeSheetName = (name) => {
                if (!name) return 'Sheet';
                const invalidChars = /[:\\\/?*\[\]]/g;
                const cleaned = name.replace(invalidChars, ' ');
                return cleaned.length > 30 ? cleaned.substring(0, 27) + '...' : cleaned;
            };

            const formatDocNumber = (prefix, number) => {
                if (typeof number === 'number') {
                    return `${prefix}${number.toString().padStart(3, '0')}`;
                }
                return `${prefix}${number || ''}`;
            };

            const formatItemsList = (list) => {
                if (!Array.isArray(list) || list.length === 0) return '';
                return list.map(item => {
                    const name = item && item.name ? item.name : '';
                    const qty = item && typeof item.quantity === 'number' ? item.quantity : 0;
                    const price = item && typeof item.price === 'number' ? item.price : 0;
                    return `${name} x${qty} @${price}`;
                }).join('\n');
            };

            const appendSheet = (rows, title) => {
                const preparedRows = (Array.isArray(rows) && rows.length) ? rows : [{ 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª': '' }];
                const worksheet = XLSX.utils.json_to_sheet(preparedRows);
                XLSX.utils.book_append_sheet(workbook, worksheet, safeSheetName(title));
            };

            const summaryRows = [
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': activity ? activity.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': new Date().toLocaleString('ar-SA') },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': items.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': customers.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': suppliers.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': purchases.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': sales.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': expenses.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': revenues.length },
                { 'Ø§Ù„Ù…Ø¤Ø´Ø±': 'Ø¹Ø¯Ø¯ Ù…Ø³ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨', 'Ø§Ù„Ù‚ÙŠÙ…Ø©': salaries.length }
            ];
            appendSheet(summaryRows, 'Ù…Ù„Ø®Øµ');

            appendSheet(items.map(item => ({
                'Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù': item.code || '',
                'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù': item.name || '',
                'ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡': typeof item.cost === 'number' ? item.cost : Number(item.cost) || 0,
                'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹': typeof item.price === 'number' ? item.price : Number(item.price) || 0,
                'Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ': typeof item.stock === 'number' ? item.stock : Number(item.stock) || 0
            })), 'Ø§Ù„Ø£ØµÙ†Ø§Ù');

            appendSheet(customers.map(customer => ({
                'Ø±Ù…Ø² Ø§Ù„Ø¹Ù…ÙŠÙ„': customer.code || '',
                'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„': customer.name || '',
                'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„': customer.phone || '',
                'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ': customer.email || '',
                'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†': customer.address || ''
            })), 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡');

            appendSheet(suppliers.map(supplier => ({
                'Ø±Ù…Ø² Ø§Ù„Ù…ÙˆØ±Ø¯': supplier.code || '',
                'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯': supplier.name || '',
                'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„': supplier.phone || '',
                'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ': supplier.email || '',
                'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†': supplier.address || ''
            })), 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†');

            appendSheet(purchases.map(purchase => {
                const supplier = suppliers.find(s => s.id === purchase.supplierId);
                const remaining = (purchase && typeof purchase.remainingAmount === 'number')
                    ? purchase.remainingAmount
                    : (purchase.total || 0) - (purchase.paidAmount || 0);
                return {
                    'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©': formatDocNumber('PUR', purchase.number),
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': purchase.date || '',
                    'Ø§Ù„Ù…ÙˆØ±Ø¯': supplier ? supplier.name : '',
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù': Array.isArray(purchase.items) ? purchase.items.length : 0,
                    'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª': typeof purchase.total === 'number' ? purchase.total : Number(purchase.total) || 0,
                    'Ø§Ù„Ù…Ø¯ÙÙˆØ¹': typeof purchase.paidAmount === 'number' ? purchase.paidAmount : Number(purchase.paidAmount) || 0,
                    'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': remaining,
                    'Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©': formatItemsList(purchase.items),
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': purchase.notes || ''
                };
            }), 'ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');

            appendSheet(sales.map(sale => {
                const customer = customers.find(c => c.id === sale.customerId);
                const remaining = (sale && typeof sale.remainingAmount === 'number')
                    ? sale.remainingAmount
                    : (sale.total || 0) - (sale.paidAmount || 0);
                return {
                    'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©': formatDocNumber('SAL', sale.number),
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': sale.date || '',
                    'Ø§Ù„Ø¹Ù…ÙŠÙ„': customer ? customer.name : '',
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù': Array.isArray(sale.items) ? sale.items.length : 0,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©': typeof sale.total === 'number' ? sale.total : Number(sale.total) || 0,
                    'Ø§Ù„Ù…Ø¯ÙÙˆØ¹': typeof sale.paidAmount === 'number' ? sale.paidAmount : Number(sale.paidAmount) || 0,
                    'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': remaining,
                    'ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©': sale.taxApplied === false ? 'Ù„Ø§' : 'Ù†Ø¹Ù…',
                    'Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©': formatItemsList(sale.items),
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': sale.notes || ''
                };
            }), 'ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');

            appendSheet(expenses.map(expense => ({
                'Ø§Ù„ØªØ§Ø±ÙŠØ®': expense.date || '',
                'Ø§Ù„ØªØµÙ†ÙŠÙ': expense.category || '',
                'Ø§Ù„Ù…Ø¨Ù„Øº': typeof expense.amount === 'number' ? expense.amount : Number(expense.amount) || 0,
                'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹': getPaymentMethodName ? getPaymentMethodName(expense.paymentMethod) : (expense.paymentMethod || ''),
                'Ø§Ù„Ù…Ø±Ø¬Ø¹': expense.reference || '',
                'Ø§Ù„ÙˆØµÙ': expense.description || ''
            })), 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª');

            appendSheet(revenues.map(revenue => ({
                'Ø§Ù„ØªØ§Ø±ÙŠØ®': revenue.date || '',
                'Ø§Ù„ØªØµÙ†ÙŠÙ': revenue.category || '',
                'Ø§Ù„Ù…ØµØ¯Ø±': getRevenueSourceName ? getRevenueSourceName(revenue.source) : (revenue.source || ''),
                'Ø§Ù„Ù…Ø¨Ù„Øº': typeof revenue.amount === 'number' ? revenue.amount : Number(revenue.amount) || 0,
                'Ø§Ù„Ù…Ø±Ø¬Ø¹': revenue.reference || '',
                'Ø§Ù„ÙˆØµÙ': revenue.description || ''
            })), 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª');

            appendSheet(salaries.map(salary => ({
                'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù': salary.employeeName || '',
                'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©': salary.employeeId || '',
                'Ø´Ù‡Ø± Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚': salary.month || '',
                'Ø³Ø¹ÙˆØ¯ÙŠØŸ': salary.isSaudi ? 'Ù†Ø¹Ù…' : 'Ù„Ø§',
                'Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ': typeof salary.basic === 'number' ? salary.basic : Number(salary.basic) || 0,
                'Ø¨Ø¯Ù„ Ø§Ù„Ø³ÙƒÙ†': typeof salary.housing === 'number' ? salary.housing : Number(salary.housing) || 0,
                'Ø¨Ø¯Ù„ Ø§Ù„Ù†Ù‚Ù„': typeof salary.transport === 'number' ? salary.transport : Number(salary.transport) || 0,
                'Ø¨Ø¯Ù„Ø§Øª Ø£Ø®Ø±Ù‰': typeof salary.otherAllowances === 'number' ? salary.otherAllowances : Number(salary.otherAllowances) || 0,
                'Ø³Ø§Ø¹Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©': typeof salary.overtime === 'number' ? salary.overtime : Number(salary.overtime) || 0,
                'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø§ØªØ¨': typeof salary.gross === 'number' ? salary.gross : Number(salary.gross) || 0,
                'Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª (GOSI)': typeof salary.gosiEmployee === 'number' ? salary.gosiEmployee : Number(salary.gosiEmployee) || 0,
                'Ù…Ø³Ø§Ù‡Ù…Ø© Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„ (GOSI)': typeof salary.gosiEmployer === 'number' ? salary.gosiEmployer : Number(salary.gosiEmployer) || 0,
                'Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª Ø£Ø®Ø±Ù‰': typeof salary.otherDeductions === 'number' ? salary.otherDeductions : Number(salary.otherDeductions) || 0,
                'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨': typeof salary.net === 'number' ? salary.net : Number(salary.net) || 0,
                'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': salary.notes || ''
            })), 'Ø§Ù„Ø±ÙˆØ§ØªØ¨');

            appendSheet(purchaseReturns.map(returnDoc => {
                const supplier = suppliers.find(s => s.id === returnDoc.supplierId);
                return {
                    'Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹': formatDocNumber('PR', returnDoc.number),
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': returnDoc.date || '',
                    'Ø§Ù„Ù…ÙˆØ±Ø¯': supplier ? supplier.name : '',
                    'ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©': formatDocNumber('PUR', returnDoc.originalInvoiceNumber),
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©': typeof returnDoc.total === 'number' ? returnDoc.total : Number(returnDoc.total) || 0,
                    'Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©': formatItemsList(returnDoc.items)
                };
            }), 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');

            appendSheet(salesReturns.map(returnDoc => {
                const customer = customers.find(c => c.id === returnDoc.customerId);
                return {
                    'Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹': formatDocNumber('SR', returnDoc.number),
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': returnDoc.date || '',
                    'Ø§Ù„Ø¹Ù…ÙŠÙ„': customer ? customer.name : '',
                    'ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©': formatDocNumber('SAL', returnDoc.originalInvoiceNumber),
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©': typeof returnDoc.total === 'number' ? returnDoc.total : Number(returnDoc.total) || 0,
                    'Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©': formatItemsList(returnDoc.items)
                };
            }), 'Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');

            const fileName = `Ø§Ù„Ø¯ÙŠÙˆØ§Ù†_${activity ? activity.name.replace(/\s/g, '_') : 'Ø¨ÙŠØ§Ù†Ø§Øª'}_${todayDate}_Excel.xlsx`;
            XLSX.writeFile(workbook, fileName);
            showNotification('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
        }

        async function importData() {
            if (!ensureActivitySelected()) return;
            const confirmed = await showConfirmDialog(
                'Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                'ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ',
                'warning',
                'Ù…ØªØ§Ø¨Ø¹Ø©',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                document.getElementById('importFile').click();
            }
        }

         async function handleFileImport(files) { // Ø£Ø¶ÙÙ†Ø§ ÙƒÙ„Ù…Ø© async
     if (!files.length) return;
     if (!ensureActivitySelected()) return;
    const reader = new FileReader();
    reader.onload = async function(e) { // Ø£Ø¶ÙÙ†Ø§ ÙƒÙ„Ù…Ø© async Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹
        try {
            const importedData = JSON.parse(e.target.result);
            if (!importedData.system || !importedData.system.includes('Ø§Ù„Ø¯ÙŠÙˆØ§Ù†')) {
                showNotification('âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­', 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù', 'error');
                return;
            }
            const confirmed = await showConfirmDialog(
                'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯',
                'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØŸ',
                'info',
                'Ù†Ø¹Ù…',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {

                // Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙØ¸
                const savePromises = [];
                const keysToImport = ['items', 'customers', 'suppliers', 'purchases', 'sales', 'expenses', 'revenues', 'salaries', 'salesReturns', 'purchaseReturns'];

                keysToImport.forEach(key => {
                    if (importedData[key] && Array.isArray(importedData[key])) {
                        // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase
                        savePromises.push(saveToFirebase(key, importedData[key]));
                    }
                });

                // Ù†Ù†ØªØ¸Ø± Ø­ØªÙ‰ ØªÙƒØªÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙØ¸
                const saveResults = await Promise.all(savePromises);
                if (savePromises.length && saveResults.some(result => !result)) {
                    showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
                    return;
                }

                await refreshActivityData();
                const importInput = document.getElementById('importFile');
                if (importInput) {
                    importInput.value = '';
                }
                showNotification('âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Firebase Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©', 'success');
            }
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:", error);
            const importInput = document.getElementById('importFile');
            if (importInput) {
                importInput.value = '';
            }
            showNotification('âŒ Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        }
    };
    reader.readAsText(files[0]);
}

        function createBackup() {
            if (!ensureActivitySelected()) return;
            exportActivityData();
            const timestamp = new Date().toISOString();
            const lastBackupKey = getActivityDataKey('lastBackup');
            const reminderKey = getActivityDataKey('lastBackupTimestamp');
            if (lastBackupKey) {
                localStorage.setItem(lastBackupKey, timestamp);
            }
            if (reminderKey) {
                localStorage.setItem(reminderKey, Date.now());
            }
            updateDataStats();
        }

        async function importSampleData() {
            if (!ensureActivitySelected()) return;
            const confirmed = await showConfirmDialog(
                'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©',
                'Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ',
                'info',
                'Ù…ØªØ§Ø¨Ø¹Ø©',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                const sampleItems = [{ id: Date.now() + 1, code: 'IT001', name: 'Ø¬Ù‡Ø§Ø² ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ù…Ø­Ù…ÙˆÙ„', cost: 2000, price: 2500, stock: 10 }];
                const sampleCustomers = [{ id: Date.now() + 2, code: 'CU001', name: 'Ø´Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ©', phone: '0123456789', email: 'info@tech.com', address: 'Ø§Ù„Ø±ÙŠØ§Ø¶' }];
                const sampleSuppliers = [{ id: Date.now() + 3, code: 'SU001', name: 'Ø´Ø±ÙƒØ© Ø§Ù„Ø¥Ù…Ø¯Ø§Ø¯Ø§Øª', phone: '0123456791', email: 'supply@tech.com', address: 'Ø§Ù„Ø¯Ù…Ø§Ù…' }];

                const updatedItems = [...items, ...sampleItems];
                const updatedCustomers = [...customers, ...sampleCustomers];
                const updatedSuppliers = [...suppliers, ...sampleSuppliers];

                const saveResults = await Promise.all([
                    saveToFirebase('items', updatedItems),
                    saveToFirebase('customers', updatedCustomers),
                    saveToFirebase('suppliers', updatedSuppliers)
                ]);

                if (saveResults.some(result => !result)) {
                    showNotification('âŒ Ø®Ø·Ø£', 'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹', 'error');
                    return;
                }

                await refreshActivityData();
                showNotification('âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ', 'success');
            }
        }

        async function clearActivityData() {
            if (!ensureActivitySelected()) return;
            const confirmed1 = await showConfirmDialog(
                'Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                'ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù†Ø´Ø§Ø· Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                'danger',
                'Ù†Ø¹Ù…',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed1) {
                const confirmed2 = await showConfirmDialog(
                    'ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ',
                    'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø¬Ø¯Ø§Ù‹ØŸ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§!',
                    'danger',
                    'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
                    'Ø¥Ù„ØºØ§Ø¡'
                );
                if (confirmed2) {
                    const dataKeys = ['items', 'customers', 'suppliers', 'purchases', 'sales', 'salesReturns', 'purchaseReturns', 'expenses', 'revenues', 'salaries', 'lastBackup'];
                    const removalResults = await Promise.all(dataKeys.map(key => removeFromFirebase(key)));
                    if (removalResults.some(result => !result)) {
                        showNotification('âŒ Ø®Ø·Ø£', 'ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©', 'error');
                        return;
                    }
                    dataKeys.forEach(key => {
                        const storageKey = getActivityDataKey(key);
                        if (storageKey) {
                            localStorage.removeItem(storageKey);
                        }
                    });
                    const reminderKey = getActivityDataKey('lastBackupTimestamp');
                    if (reminderKey) {
                        localStorage.removeItem(reminderKey);
                    }
                    items = [];
                    customers = [];
                    suppliers = [];
                    purchases = [];
                    sales = [];
                    expenses = [];
                    revenues = [];
                    salaries = [];
                    salesReturns = [];
                    purchaseReturns = [];
                    await refreshActivityData();
                    showNotification('âœ… ØªÙ… Ø§Ù„Ù…Ø³Ø­', 'ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ', 'success');
                }
            }
        }

        // ===== Dashboard Update =====
 function updateDashboard() {
    const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
    const allowEmpty = !currentActivityId && loggedInUser && loggedInUser.role === 'admin';
    if (!currentActivityId && !allowEmpty) return;

    const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    };
   document.getElementById('totalAdvancesHome').textContent = advances.length;
    setText('totalItems', items.length);
    setText('totalCustomers', customers.length);
    setText('totalSuppliers', suppliers.length);
    setText('stockValue', items.reduce((s, i) => s + ((Number(i.stock) || 0) * (Number(i.cost) || 0)), 0).toFixed(2));
    setText('totalSales', sales.reduce((s, i) => s + (Number(i.total) || 0), 0).toFixed(2));
    setText('totalPurchases', purchases.reduce((s, i) => s + (Number(i.total) || 0), 0).toFixed(2));
    setText('totalExpensesHome', expenses.reduce((s, e) => s + (Number(e.amount) || 0), 0).toFixed(2));
    setText('totalRevenuesHome', revenues.reduce((s, r) => s + (Number(r.amount) || 0), 0).toFixed(2));
    setText('totalStockQuantity', calculateTotalStock());
    // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
    if (document.getElementById('advanced-dashboard').classList.contains('active')) {
        updateLiveStats();
        renderCharts();
    }
}
        
        // ===== Login System Functions =====
     async function handleLogin() {
    const errorMsg = document.getElementById('login-error');
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPassword').value;

    if (!email || !pass) {
        showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'warning');
        return;
    }

    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
    errorMsg.style.display = 'none';

    try {
        // --- â¬‡ï¸ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ ÙŠØ³ØªØ®Ø¯Ù… Firebase Auth ---

        // 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Auth
        const userCredential = await auth.signInWithEmailAndPassword(email, pass);
        const firebaseUser = userCredential.user;

        // 2. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª) Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙ†Ø§
        const user = users.find(u => u.id === firebaseUser.uid || u.email === email);

        if (!user) {
            hideLoading();
            logError('Login', 'Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ„ÙƒÙ† Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙÙ‚ÙˆØ¯', false);
            errorMsg.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø¯ÙŠØ±.';
            errorMsg.style.display = 'block';
            auth.signOut(); 
            return;
        }

        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (ÙƒÙ…Ø§ ÙƒØ§Ù†)
        if ((user.role === 'manager' || user.role === 'user') && (!user.activityId || !activities.find(a => a.id == user.activityId))) {
            hideLoading();
            showNotification('âš ï¸ Ù†Ø´Ø§Ø· ØºÙŠØ± ØµØ§Ù„Ø­', 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±.', 'warning');
            errorMsg.textContent = 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± ØµØ§Ù„Ø­.';
            errorMsg.style.display = 'block';
            auth.signOut(); 
            return;
        }

        // 4. Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Session
        sessionStorage.setItem('loggedInUser', JSON.stringify(user));

        // --- â¬†ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---

        updateLoggedInUserDisplay(user);
        document.getElementById('login-overlay').style.display = 'none';
        document.querySelector('.app-container').style.display = 'flex';

        if (user.role === 'admin') {
            currentActivityId = sessionStorage.getItem('currentActivityId');
            if (currentActivityId && activities.find(a => a.id == currentActivityId)) {
                await selectActivity(currentActivityId);
            } else {
                enterAdminWithoutActivity();
            }
        } else {
            await selectActivity(user.activityId);
        }

        hideLoading();

    } catch (error) {
        hideLoading();
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Firebase Auth
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
            logError('Login', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©', false);
            errorMsg.textContent = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
            errorMsg.style.display = 'block';
        } else {
            logError('Login', error);
            errorMsg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
            errorMsg.style.display = 'block';
        }
    }
}
        function enterAdminWithoutActivity() {
            currentActivityId = null;
            sessionStorage.removeItem('currentActivityId');

            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) loginOverlay.style.display = 'none';
            const activityOverlay = document.getElementById('activity-overlay');
            if (activityOverlay) activityOverlay.style.display = 'none';
            const appContainer = document.querySelector('.app-container');
            if (appContainer) appContainer.style.display = 'flex';

            items = [];
            customers = [];
            suppliers = [];
            purchases = [];
            sales = [];
            expenses = [];
            revenues = [];
            salaries = [];
            salesReturns = [];
            purchaseReturns = [];
            currentPurchaseItems = [];
            currentSaleItems = [];
            currentPurchaseNumber = 1;
            currentSaleNumber = 1;
            currentSaleReturnNumber = 1;
            currentPurchaseReturnNumber = 1;
            editingPurchaseId = null;
            editingSaleId = null;

            const todayISO = new Date().toISOString().split('T')[0];
            const setValueIfExists = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.value = value;
            };
            ['purchaseDate', 'saleDate', 'expenseDate', 'revenueDate', 'reportFrom', 'reportTo'].forEach(id => setValueIfExists(id, todayISO));

            setValueIfExists('purchaseCode', `PUR${currentPurchaseNumber.toString().padStart(3, '0')}`);
            setValueIfExists('saleCode', `SAL${currentSaleNumber.toString().padStart(3, '0')}`);

            updateHeaderForActivity(null);
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            updateLoggedInUserDisplay(loggedInUser);
            updateSidebar(loggedInUser ? loggedInUser.role : null);

            newPurchase();
            newSale();
            newSaleReturn();
            newPurchaseReturn();

            renderItems();
            renderCustomers();
            renderSuppliers();
            renderPurchasesList();
            renderSalesList();
            renderSalesReturns();
            renderPurchaseReturns();
            renderExpenses();
            renderRevenues();
            updatePurchaseDropdowns();
            updateSaleDropdowns();
            updateExpenseStats();
            updateRevenueStats();
            updateDataStats();
            updateDashboard();
            updateReportItemFilter();
            changeReportType();
            const reportResults = document.getElementById('reportResults');
            if (reportResults) reportResults.innerHTML = '';
            const reportSummary = document.getElementById('reportSummary');
            if (reportSummary) reportSummary.innerHTML = '';
            renderActivitiesInSettings();
            renderUsersInSettings();
        }
        
       async function logout() {
            const confirmed = await showConfirmDialog({
                // ... (Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­ÙˆØ§Ø±) ...
            });
            
            if (confirmed) {
                sessionStorage.clear();
                location.reload();
            }
        }
        function renderUsersInSettings() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const isAdmin = loggedInUser && loggedInUser.role === 'admin';
            const isManager = loggedInUser && loggedInUser.role === 'manager';
            const activitySelect = document.getElementById('newUserActivity');
            const userSelect = document.getElementById('usersDropdown');
            const roleSelect = document.getElementById('newUserRole');

            if (roleSelect) {
                if (isManager) {
                    roleSelect.value = 'user';
                    roleSelect.disabled = true;
                } else {
                    roleSelect.disabled = false;
                }
            }

            if (activitySelect) {
                activitySelect.innerHTML = '<option value="">-- ØªØ¹ÙŠÙŠÙ† Ù„Ù†Ø´Ø§Ø· --</option>';
                const availableActivities = isManager
                    ? activities.filter(act => String(act.id) === String(loggedInUser.activityId))
                    : activities;
                availableActivities.forEach(act => {
                    activitySelect.innerHTML += `<option value="${act.id}">${act.name}</option>`;
                });
                if (isManager) {
                    activitySelect.value = loggedInUser.activityId || '';
                    activitySelect.disabled = true;
                } else {
                    activitySelect.disabled = false;
                }
            }

            if (userSelect) {
                const previousSelection = userSelect.value;
                userSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§</option>';
                const filteredUsers = users.filter(user => {
                    if (isAdmin) return true;
                    if (isManager) {
                        if (user.role === 'admin') return false;
                        if (user.role === 'manager' && user.id !== loggedInUser.id) return false;
                        return user.activityId == loggedInUser.activityId;
                    }
                    return false;
                });

                filteredUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    const roleLabelMap = { admin: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', manager: 'Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·', user: 'Ù…Ø³ØªØ®Ø¯Ù…' };
                    const baseName = (user.name && user.name.trim()) ? user.name : user.email;
                    option.textContent = `${baseName} - ${roleLabelMap[user.role] || 'Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`;
                    userSelect.appendChild(option);
                });

                if (previousSelection && users.some(u => String(u.id) === previousSelection)) {
                    userSelect.value = previousSelection;
                } else {
                    userSelect.value = '';
                }
            }

            handleUserSelection();
        }

        function handleUserSelection() {
            const userSelect = document.getElementById('usersDropdown');
            const infoBox = document.getElementById('selectedUserInfo');
            const nameInput = document.getElementById('selectedUserName');
            const emailInput = document.getElementById('selectedUserEmail');
            const phoneInput = document.getElementById('selectedUserPhone');
            const roleInput = document.getElementById('selectedUserRole');
            const activityInput = document.getElementById('selectedUserActivity');
            const editBtn = document.getElementById('editSelectedUserBtn');
            const deleteBtn = document.getElementById('deleteSelectedUserBtn');

            if (!userSelect) return;

            const userId = userSelect.value;
            const user = users.find(u => String(u.id) === userId);

            if (!user) {
                if (infoBox) infoBox.style.display = 'none';
                if (nameInput) nameInput.value = '';
                if (emailInput) emailInput.value = '';
                if (phoneInput) phoneInput.value = '';
                if (roleInput) roleInput.value = '';
                if (activityInput) activityInput.value = '';
                if (editBtn) editBtn.disabled = true;
                if (deleteBtn) deleteBtn.disabled = true;
                return;
            }

            if (infoBox) infoBox.style.display = 'flex';
            if (nameInput) nameInput.value = (user.name && user.name.trim()) ? user.name : user.email;
            if (emailInput) emailInput.value = user.email || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            if (phoneInput) phoneInput.value = (user.phone && user.phone.trim()) ? user.phone : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            if (roleInput) {
                const roleNames = { admin: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', manager: 'Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·', user: 'Ù…Ø³ØªØ®Ø¯Ù…' };
                roleInput.value = roleNames[user.role] || 'Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            }

            let assignedActivity = 'ØºÙŠØ± Ù…Ø®ØµØµ';
            if (user.role === 'admin') {
                assignedActivity = 'Ù…ØªØ¹Ø¯Ø¯ (Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…)';
            } else if (user.role === 'manager' || user.role === 'user') {
                const activity = activities.find(a => a.id == user.activityId);
                assignedActivity = activity ? activity.name : 'Ù†Ø´Ø§Ø· ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            }
            if (activityInput) activityInput.value = assignedActivity;

            if (editBtn) editBtn.disabled = false;
            if (deleteBtn) deleteBtn.disabled = false;
        }

        function handleEditSelectedUser() {
            const userSelect = document.getElementById('usersDropdown');
            if (!userSelect || !userSelect.value) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'warning');
                return;
            }
            const userId = Number(userSelect.value);
            if (!Number.isNaN(userId)) {
                openEditUserModal(userId);
            }
        }

        function handleDeleteSelectedUser() {
            const userSelect = document.getElementById('usersDropdown');
            if (!userSelect || !userSelect.value) {
                showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'warning');
                return;
            }
            const userId = Number(userSelect.value);
            if (!Number.isNaN(userId)) {
                deleteUser(userId);
            }
        }

        let editingUserId = null;
        let editingUserSelf = false;
        function openEditUserModal(userId, options = {}) {
            editingUserId = userId;
            editingUserSelf = Boolean(options && options.selfEdit);
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const isManager = loggedInUser && loggedInUser.role === 'manager';
            const isSelf = loggedInUser && user.id === loggedInUser.id;

            if (isManager) {
                const sameActivity = user.activityId == loggedInUser.activityId;
                if (user.role === 'admin' || (user.role === 'manager' && !isSelf) || (!sameActivity && !isSelf)) {
                    showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'warning');
                    return;
                }
            }

            const nameInput = document.getElementById('editUserName');
            const emailInput = document.getElementById('editUserEmail');
            const phoneInput = document.getElementById('editUserPhone');
            const passwordInput = document.getElementById('editUserPassword');
            const roleSelect = document.getElementById('editUserRole');
            const actSel = document.getElementById('editUserActivity');

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            nameInput.value = user.name || '';
            emailInput.value = user.email;
            phoneInput.value = user.phone || '';
            passwordInput.value = user.password || '';
            roleSelect.value = user.role;

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø©
            actSel.innerHTML = '<option value="">-- ØªØ¹ÙŠÙŠÙ† Ù„Ù†Ø´Ø§Ø· --</option>';
            const availableActivities = isManager
                ? activities.filter(a => String(a.id) === String(loggedInUser.activityId))
                : activities;
            availableActivities.forEach(a => actSel.innerHTML += `<option value="${a.id}">${a.name}</option>`);

            const shouldShowActivity = (user.role === 'user' || user.role === 'manager');
            actSel.style.display = shouldShowActivity ? 'block' : 'none';
            actSel.value = shouldShowActivity ? (user.activityId || '') : '';

            // ØªÙ…ÙƒÙŠÙ† Ø£Ùˆ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø¨ Ø³ÙŠØ§Ù‚ Ø§Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ
            const disableRoleSelect = editingUserSelf || isManager || isSelf;
            roleSelect.disabled = disableRoleSelect;
            actSel.disabled = editingUserSelf || isSelf;

            if (!disableRoleSelect) {
                roleSelect.onchange = function() {
                    if (this.value === 'user' || this.value === 'manager') {
                        actSel.style.display = 'block';
                        actSel.disabled = false;
                    } else {
                        actSel.style.display = 'none';
                        actSel.value = '';
                        actSel.disabled = false;
                    }
                };
            } else {
                roleSelect.onchange = null;
            }

            document.getElementById('user-edit-overlay').style.display = 'flex';
        }

        function closeEditUserModal() {
            document.getElementById('user-edit-overlay').style.display = 'none';
            editingUserId = null;
            editingUserSelf = false;
        }

        function openSelfEditUserModal() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser) {
                showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ø¬Ù„', 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }

            const exists = users.some(u => u.id === loggedInUser.id);
            if (!exists) {
                showNotification('âŒ Ø®Ø·Ø£', 'ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ¹Ø¯ÙŠÙ„', 'error');
                return;
            }

            openEditUserModal(loggedInUser.id, { selfEdit: true });
        }

        async function saveEditedUser() {
            const name = document.getElementById('editUserName').value.trim();
            const email = document.getElementById('editUserEmail').value.trim();
            const phone = document.getElementById('editUserPhone').value.trim();
            const password = document.getElementById('editUserPassword').value.trim();
            let role = document.getElementById('editUserRole').value;
            let activityId = document.getElementById('editUserActivity').value;
            const phonePattern = /^[+\d]{6,20}$/;
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const isManager = loggedInUser && loggedInUser.role === 'manager';

            if (!name) { showNotification('âš ï¸ Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·Ù„ÙˆØ¨', 'warning'); return; }
            if (!email) { showNotification('âš ï¸ Ø¨Ø±ÙŠØ¯ Ù…Ø·Ù„ÙˆØ¨', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø·Ù„ÙˆØ¨', 'warning'); return; }
            if (!phone) { showNotification('âš ï¸ Ø¬ÙˆØ§Ù„ Ù…Ø·Ù„ÙˆØ¨', 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ø·Ù„ÙˆØ¨', 'warning'); return; }
            if (!phonePattern.test(phone)) { showNotification('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· ÙˆÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ù„Ø§Ù…Ø© +', 'warning'); return; }
            if (!role) { showNotification('âš ï¸ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø©', 'Ø§Ø®ØªØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©', 'warning'); return; }

            const idx = users.findIndex(u => u.id === editingUserId);
            if (idx === -1) { showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error'); return; }

            const targetUser = users[idx];
            const isSelf = loggedInUser && targetUser.id === loggedInUser.id;

            if (editingUserSelf || isSelf) {
                role = targetUser.role;
                activityId = targetUser.activityId || '';
            } else if (isManager) {
                role = 'user';
                activityId = loggedInUser.activityId || '';
            }

            if ((role === 'user' || role === 'manager') && !activityId) { showNotification('âš ï¸ Ù†Ø´Ø§Ø· Ù…Ø·Ù„ÙˆØ¨', 'ÙŠØ¬Ø¨ ØªØ¹ÙŠÙŠÙ† Ù†Ø´Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'warning'); return; }


            // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±
            if (users.some(u => u.email === email && u.id !== editingUserId)) {
                showNotification('âŒ Ø¨Ø±ÙŠØ¯ Ù…ÙƒØ±Ø±', 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
                return;
            }

            targetUser.name = name;
            targetUser.email = email;
            targetUser.phone = phone;
            if (password) targetUser.password = password; // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø©
            targetUser.role = role;
            targetUser.activityId = (role === 'user' || role === 'manager') ? activityId : null;

            const updatedUser = targetUser;
            await saveUsers();
            if (loggedInUser && loggedInUser.id === updatedUser.id) {
                sessionStorage.setItem('loggedInUser', JSON.stringify(updatedUser));
                updateLoggedInUserDisplay(updatedUser);
            }
            renderUsersInSettings();
            closeEditUserModal();
            showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'success');
        }

        async function deleteUser(id) {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (loggedInUser.id === id) {
                showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ù†ÙØ³Ùƒ', 'warning');
                return;
            }

            if (loggedInUser.role === 'manager') {
                const target = users.find(u => u.id === id);
                if (!target || target.role !== 'user' || target.activityId != loggedInUser.activityId) {
                    showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'warning');
                    return;
                }
            }

            const admins = users.filter(u => u.role === 'admin');
            const userToDelete = users.find(u => u.id === id);
            if (!userToDelete) {
                showNotification('âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯', 'error');
                return;
            }

            if (userToDelete.role === 'admin' && admins.length <= 1) {
                showNotification('âš ï¸ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙŠØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…', 'warning');
                return;
            }

            const confirmed = await showConfirmDialog(
                'Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
                `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${userToDelete.email}ØŸ`,
                'danger',
                'Ø­Ø°Ù',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            if (confirmed) {
                users = users.filter(u => u.id !== id);
                await saveUsers();
                renderUsersInSettings();
            }
        }

        // ===== Logo Management Functions =====
        function handleLogoUpload(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];
            if (!validTypes.includes(file.type)) {
                showNotification('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø¨ØµÙŠØºØ© PNG Ø£Ùˆ JPG Ø£Ùˆ SVG ÙÙ‚Ø·.', 'error');
                fileInput.value = '';
                return;
            }

            // Validate file size (max 2MB)
            const maxSize = 2 * 1024 * 1024; // 2MB in bytes
            if (file.size > maxSize) {
                showNotification('âŒ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª.', 'error');
                fileInput.value = '';
                return;
            }

            // Read and convert to Base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64String = e.target.result;
                
                // Save to localStorage
                localStorage.setItem('systemLogo', base64String);
                
                // Update preview in Settings
                const previewImg = document.getElementById('logoPreview');
                if (previewImg) {
                    previewImg.src = base64String;
                    previewImg.style.display = 'block';
                }
                
                // Hide "no logo" text
                const noLogoText = document.getElementById('noLogoText');
                if (noLogoText) noLogoText.style.display = 'none';
                
                // Update login screen logo
                const loginLogo = document.getElementById('loginLogo');
                if (loginLogo) {
                    loginLogo.src = base64String;
                    loginLogo.style.display = 'block';
                }
                
                // Update sidebar logo
                const sidebarLogo = document.getElementById('sidebarLogo');
                if (sidebarLogo) {
                    sidebarLogo.src = base64String;
                    sidebarLogo.style.display = 'block';
                }
                
                // Show remove button
                const removeBtn = document.getElementById('removeLogoBtn');
                if (removeBtn) removeBtn.style.display = 'inline-block';
                
                showNotification('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            };
            
            reader.onerror = function() {
                showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.', 'error');
                fileInput.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            showConfirmDialog(
                'Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø±',
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ',
                'warning',
                'Ø­Ø°Ù',
                'Ø¥Ù„ØºØ§Ø¡'
            ).then(confirmed => {
                if (confirmed) {
                    // Remove from localStorage
                    localStorage.removeItem('systemLogo');
                    
                    // Clear preview in Settings
                    const previewImg = document.getElementById('logoPreview');
                    if (previewImg) {
                        previewImg.src = '';
                        previewImg.style.display = 'none';
                    }
                    
                    // Show "no logo" text
                    const noLogoText = document.getElementById('noLogoText');
                    if (noLogoText) noLogoText.style.display = 'block';
                    
                    // Clear login screen logo
                    const loginLogo = document.getElementById('loginLogo');
                    if (loginLogo) {
                        loginLogo.src = '';
                        loginLogo.style.display = 'none';
                    }
                    
                    // Clear sidebar logo
                    const sidebarLogo = document.getElementById('sidebarLogo');
                    if (sidebarLogo) {
                        sidebarLogo.src = '';
                        sidebarLogo.style.display = 'none';
                    }
                    
                    // Hide remove button
                    const removeBtn = document.getElementById('removeLogoBtn');
                    if (removeBtn) removeBtn.style.display = 'none';
                    
                    // Clear file input
                    const fileInput = document.getElementById('logoFileInput');
                    if (fileInput) fileInput.value = '';
                    
                    showNotification('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                }
            });
        }

        function loadSavedLogo() {
            const savedLogo = localStorage.getItem('systemLogo');
            const noLogoText = document.getElementById('noLogoText');
            
            if (savedLogo) {
                // Update preview in Settings
                const previewImg = document.getElementById('logoPreview');
                if (previewImg) {
                    previewImg.src = savedLogo;
                    previewImg.style.display = 'block';
                }
                
                // Hide "no logo" text
                if (noLogoText) noLogoText.style.display = 'none';
                
                // Update login screen logo
                const loginLogo = document.getElementById('loginLogo');
                if (loginLogo) {
                    loginLogo.src = savedLogo;
                    loginLogo.style.display = 'block';
                }
                
                // Update sidebar logo
                const sidebarLogo = document.getElementById('sidebarLogo');
                if (sidebarLogo) {
                    sidebarLogo.src = savedLogo;
                    sidebarLogo.style.display = 'block';
                }
                
                // Show remove button
                const removeBtn = document.getElementById('removeLogoBtn');
                if (removeBtn) removeBtn.style.display = 'inline-block';
            } else {
                // Show "no logo" text if no logo exists
                if (noLogoText) noLogoText.style.display = 'block';
            }
        }

        // ===== Activity Logo Functions =====
        function handleActivityLogoUpload(fileInput) {
            debugLog('ðŸ” Ø¨Ø¯Ø¡ Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·...');
            
            const file = fileInput.files[0];
            if (!file) {
                debugLog('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù');
                return;
            }
            
            debugLog('ðŸ“„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±:', file.name, 'Ø§Ù„Ø­Ø¬Ù…:', file.size);
            
            // Check file size (max 500KB for localStorage compatibility)
            if (file.size > 500 * 1024) {
                showNotification('âŒ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹', 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 500 ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª. ÙŠØ±Ø¬Ù‰ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.', 'error');
                fileInput.value = '';
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                debugLog('âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­');
                const base64String = e.target.result;
                
                // Get current activity
                let currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
                debugLog('ðŸ¢ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ:', currentActivity);
                
                if (!currentActivity) {
                    showNotification('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ù…Ø­Ø¯Ø¯', 'error');
                    return;
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·
                currentActivity.logo = base64String;
                
                // Ø­ÙØ¸ ÙÙŠ sessionStorage
                sessionStorage.setItem('currentActivity', JSON.stringify(currentActivity));
                
                // Ø­ÙØ¸ ÙÙŠ localStorage activities
                try {
                    const storageKey = `activity_${currentActivity.id}_data`;
                    const activityData = JSON.parse(localStorage.getItem(storageKey)) || {};
                    activityData.logo = base64String;
                    localStorage.setItem(storageKey, JSON.stringify(activityData));
                    debugLog('ðŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ localStorage');
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        showNotification('âŒ Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦Ø©', 'Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø£ØµØºØ± (Ø£Ù‚Ù„ Ù…Ù† 200 ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª).', 'error');
                        fileInput.value = '';
                        return;
                    }
                    throw error;
                }
                
                // Update preview
                const previewImg = document.getElementById('activityLogoPreview');
                const noLogoText = document.getElementById('noActivityLogoText');
                if (previewImg) {
                    previewImg.src = base64String;
                    previewImg.style.display = 'block';
                    debugLog('ðŸ–¼ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¹Ø§Ø±');
                }
                if (noLogoText) noLogoText.style.display = 'none';
                
                // Update header logo
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) {
                    headerLogo.src = base64String;
                    headerLogo.style.display = 'block';
                    debugLog('ðŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©');
                }
                
                // Show remove button
                const removeBtn = document.getElementById('removeActivityLogoBtn');
                if (removeBtn) removeBtn.style.display = 'inline-block';
                
                showNotification('âœ… ØªÙ… Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            };
            
            reader.onerror = function() {
                debugLog('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù');
                showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.', 'error');
                fileInput.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        function removeActivityLogo() {
            showConfirm(
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø·ØŸ',
                'Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±',
                'warning',
                () => {
                    const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
                    if (!currentActivity) return;
                    
                    // Remove logo from localStorage
                    const storageKey = `activity_${currentActivity.id}_data`;
                    const activityData = JSON.parse(localStorage.getItem(storageKey)) || {};
                    delete activityData.logo;
                    localStorage.setItem(storageKey, JSON.stringify(activityData));
                    
                    // Update preview
                    const previewImg = document.getElementById('activityLogoPreview');
                    const noLogoText = document.getElementById('noActivityLogoText');
                    if (previewImg) previewImg.style.display = 'none';
                    if (noLogoText) noLogoText.style.display = 'block';
                    
                    // Clear header logo
                    const headerLogo = document.getElementById('activityHeaderLogo');
                    if (headerLogo) headerLogo.style.display = 'none';
                    
                    // Hide remove button
                    const removeBtn = document.getElementById('removeActivityLogoBtn');
                    if (removeBtn) removeBtn.style.display = 'none';
                    
                    // Clear file input
                    const fileInput = document.getElementById('activityLogoFileInput');
                    if (fileInput) fileInput.value = '';
                    
                    showNotification('âœ… ØªÙ… Ø­Ø°Ù Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                }
            );
        }

        function loadActivityLogo() {
            const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
            if (!currentActivity) {
                // Hide logo if no activity
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) headerLogo.style.display = 'none';
                return;
            }
            
            // Load logo from localStorage
            const storageKey = `activity_${currentActivity.id}_data`;
            const activityData = JSON.parse(localStorage.getItem(storageKey));
            const savedLogo = activityData?.logo;
            
            if (!savedLogo) {
                // Hide logo if no logo saved
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) headerLogo.style.display = 'none';
                return;
            }
            
            // Update preview in settings
            const previewImg = document.getElementById('activityLogoPreview');
            const noLogoText = document.getElementById('noActivityLogoText');
            if (previewImg) {
                previewImg.src = savedLogo;
                previewImg.style.display = 'block';
            }
            if (noLogoText) noLogoText.style.display = 'none';
            
            // Update header logo
            const headerLogo = document.getElementById('activityHeaderLogo');
            if (headerLogo) {
                headerLogo.src = savedLogo;
                headerLogo.style.display = 'block';
            }
            
            // Show remove button
            const removeBtn = document.getElementById('removeActivityLogoBtn');
            if (removeBtn) removeBtn.style.display = 'inline-block';
        }

        // ===== Email Functions =====
        function saveEmailJsSettings() {
            emailJsConfig.serviceID = document.getElementById('emailJsServiceId').value.trim();
            emailJsConfig.templateID = document.getElementById('emailJsTemplateId').value.trim();
            emailJsConfig.resetTemplateID = document.getElementById('emailJsResetTemplateId').value.trim();
            emailJsConfig.publicKey = document.getElementById('emailJsPublicKey').value.trim();
            localStorage.setItem('diwan_email_config', JSON.stringify(emailJsConfig));
            showNotification('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
        }

        function loadEmailJsSettings() {
            document.getElementById('emailJsServiceId').value = emailJsConfig.serviceID || '';
            document.getElementById('emailJsTemplateId').value = emailJsConfig.templateID || '';
            const resetTpl = document.getElementById('emailJsResetTemplateId');
            if (resetTpl) resetTpl.value = emailJsConfig.resetTemplateID || '';
            document.getElementById('emailJsPublicKey').value = emailJsConfig.publicKey || '';
        }
function emailSaleInvoice(saleId) {
    if (!emailJsConfig.serviceID || !emailJsConfig.templateID || !emailJsConfig.publicKey) {
        showNotification('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªÙƒÙˆÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.', 'warning');
        return;
    }

    const sale = sales.find(s => s.id === saleId);
    if (!sale) return;

    const customer = customers.find(c => c.id === sale.customerId);
    if (!customer || !customer.email) {
        showNotification('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.', 'error');
        return;
    }
// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
function loadUsersDropdown() {
    // Ø¯Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ©
    console.log('ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...');
}

function loadActivitiesDropdown() {
    // Ø¯Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ©  
    console.log('ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø©...');
}


    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
    const currentActivity = activities.find(a => a.id == currentActivityId);
    const activityName = currentActivity ? currentActivity.name : 'Ø¨Ø³Ù…Ø© Ø¨ÙˆØªÙŠÙƒ';

    // Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
    let emailContent = `
        <div style="font-family: Arial, sans-serif; direction: rtl; text-align: right;">
            <h2 style="color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 10px;">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
            
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
            <div style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> SAL${sale.number.toString().padStart(3, '0')}</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${sale.date}</p>
                <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${customer.name}</p>
                <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${sale.notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}</p>
            </div>

            <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù -->
            <h3 style="color: #34495e;">Ø£ØµÙ†Ø§Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</h3>
            <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                <tr style="background-color: #2c5aa0; color: white;">
                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„ØµÙ†Ù</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                </tr>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù
    sale.items.forEach(item => {
        emailContent += `
            <tr>
                <td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.quantity}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: left;">${item.price.toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: left;">${item.total.toFixed(2)}</td>
            </tr>
        `;
    });

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
    emailContent += `
            </table>
            
            <div style="margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: left; max-width: 350px; margin-left: 0; margin-right: auto;">
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span> <strong>${sale.subtotal.toFixed(2)}</strong></p>
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span> <strong>${sale.tax.toFixed(2)}</strong></p>
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span> <strong>${(sale.paidAmount || 0).toFixed(2)}</strong></p>
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span> <strong>${(sale.remainingAmount ?? sale.total).toFixed(2)}</strong></p>
                <h3 style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #2c5aa0; color: #2c5aa0; display: flex; justify-content: space-between;"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span> <strong>${sale.total.toFixed(2)}</strong></h3>
            </div>

            <!-- Ø§Ù„ØªØ­ÙŠØ© -->
            <div style="margin-top: 30px; text-align: center; font-style: italic; border-top: 1px solid #ddd; padding-top: 15px;">
                <p>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹ ${activityName}</p>
            </div>
        </div>
    `;

    const templateParams = {
        to_name: customer.name,
        to_email: customer.email,
        from_name: activityName,
        invoice_number: `SAL${sale.number.toString().padStart(3, '0')}`,
        invoice_details: emailContent,
        email_subject: `ÙØ§ØªÙˆØ±Ø© ${activityName} - SAL${sale.number.toString().padStart(3, '0')}`
    };

    emailjs.send(emailJsConfig.serviceID, emailJsConfig.templateID, templateParams, emailJsConfig.publicKey)
        .then(function(response) {
           showNotification('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }, function(error) {
           showNotification('âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + error.text, 'error');
        });
}

        // ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ =====
        
        /**
         * Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©
         * ÙŠØ­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙŠØ­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
         */
        function initAutoBackupSystem() {
            if (!currentActivityId) return;
            
            const backupKey = `diwan_lastAutoBackup_${currentActivityId}`;
            const lastBackupTime = Number(localStorage.getItem(backupKey) || 0);
            const now = Date.now();
            const twentyFourHours = 24 * 60 * 60 * 1000;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ù…Ø± 24 Ø³Ø§Ø¹Ø© Ù…Ù†Ø° Ø¢Ø®Ø± Ù†Ø³Ø®Ø©
            if ((now - lastBackupTime) >= twentyFourHours) {
                performAutoBackup();
            }
            
            // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©
            setInterval(() => {
                performAutoBackup();
            }, twentyFourHours);
        }
        
        /**
         * ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
         */
        async function performAutoBackup() {
            if (!currentActivityId) return;
            
            try {
                const activity = activities.find(a => a.id == currentActivityId);
                if (!activity) return;
                
                // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const backupData = {
                    activity: activity,
                    items: items || [],
                    customers: customers || [],
                    suppliers: suppliers || [],
                    purchases: purchases || [],
                    sales: sales || [],
                    expenses: expenses || [],
                    revenues: revenues || [],
                    salaries: salaries || [],
                    backupDate: new Date().toISOString(),
                    backupTimestamp: Date.now(),
                    version: '20.0'
                };
                
                // Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ localStorage
                const backupKey = `diwan_autoBackup_${currentActivityId}`;
                const oldBackupsKey = `diwan_autoBackup_old_${currentActivityId}`;
                
                // Ù†Ù‚Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                const oldBackup = localStorage.getItem(backupKey);
                if (oldBackup) {
                    localStorage.setItem(oldBackupsKey, oldBackup);
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                localStorage.setItem(`diwan_lastAutoBackup_${currentActivityId}`, String(Date.now()));
                
                // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                showNotification(
                    'âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©',
                    `ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù†Ø´Ø§Ø· "${activity.name}" Ø¨Ù†Ø¬Ø§Ø­`,
                    'success'
                );
                
                debugLog(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ù†Ø´Ø§Ø·: ${activity.name}`);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:', error);
            }
        }
        
        /**
         * Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
         */
        async function restoreAutoBackup() {
            if (!currentActivityId) {
                showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø· Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const backupKey = `diwan_autoBackup_${currentActivityId}`;
            const backupData = localStorage.getItem(backupKey);
            
            if (!backupData) {
                showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø´Ø§Ø·', 'warning');
                return;
            }
            
            const confirmed = await showConfirmDialog(
                'Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©',
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.',
                'warning',
                'Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
                'Ø¥Ù„ØºØ§Ø¡'
            );
            
            if (!confirmed) return;
            
            try {
                const backup = JSON.parse(backupData);
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                items = backup.items || [];
                customers = backup.customers || [];
                suppliers = backup.suppliers || [];
                purchases = backup.purchases || [];
                sales = backup.sales || [];
                expenses = backup.expenses || [];
                revenues = backup.revenues || [];
                salaries = backup.salaries || [];
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø© ÙÙŠ Firebase
                await saveToFirebase('items', items);
                await saveToFirebase('customers', customers);
                await saveToFirebase('suppliers', suppliers);
                await saveToFirebase('purchases', purchases);
                await saveToFirebase('sales', sales);
                await saveToFirebase('expenses', expenses);
                await saveToFirebase('revenues', revenues);
                await saveToFirebase('salaries', salaries);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                renderItems();
                renderCustomers();
                renderSuppliers();
                renderPurchasesList();
                renderSalesList();
                renderExpenses();
                renderRevenues();
                renderSalaries();
                updateDataStats();
                
                const backupDate = new Date(backup.backupDate);
                showNotification(
                    'âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­',
                    `ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨ØªØ§Ø±ÙŠØ® ${backupDate.toLocaleString('ar-SA')}`,
                    'success'
                );
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
                showNotification('âŒ ÙØ´Ù„Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
            }
        }
        
        /**
         * Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
         */
        function showAutoBackupInfo() {
            if (!currentActivityId) return;
            
            const backupKey = `diwan_autoBackup_${currentActivityId}`;
            const lastBackupKey = `diwan_lastAutoBackup_${currentActivityId}`;
            
            const backupData = localStorage.getItem(backupKey);
            const lastBackupTime = Number(localStorage.getItem(lastBackupKey) || 0);
            
            if (!backupData) {
                showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯', 'info');
                return;
            }
            
            try {
                const backup = JSON.parse(backupData);
                const backupDate = new Date(backup.backupDate);
                const timeDiff = Date.now() - lastBackupTime;
                const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
                
                let message = `ðŸ“… ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${backupDate.toLocaleString('ar-SA')}\n`;
                message += `â±ï¸ Ù…Ù†Ø°: ${hoursDiff} Ø³Ø§Ø¹Ø©\n`;
                message += `ðŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù: ${backup.items?.length || 0}\n`;
                message += `ðŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${backup.customers?.length || 0}\n`;
                message += `ðŸ¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†: ${backup.suppliers?.length || 0}\n`;
                message += `ðŸ’° Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${backup.sales?.length || 0}\n`;
                message += `ðŸ›’ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${backup.purchases?.length || 0}`;
                
                showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', message, 'info');
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
            }
        }
        
        /**
         * ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙƒÙ…Ù„Ù JSON
         */
        function downloadAutoBackup() {
            if (!currentActivityId) {
                showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø· Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const backupKey = `diwan_autoBackup_${currentActivityId}`;
            const backupData = localStorage.getItem(backupKey);
            
            if (!backupData) {
                showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø´Ø§Ø·', 'warning');
                return;
            }
            
            try {
                const backup = JSON.parse(backupData);
                const activity = activities.find(a => a.id == currentActivityId);
                const activityName = activity ? activity.name : 'Ø§Ù„Ù†Ø´Ø§Ø·';
                
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ù…Ù„Ù
                const date = new Date();
                const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
                const timeStr = date.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
                const fileName = `Ù†Ø³Ø®Ø©_Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©_ØªÙ„Ù‚Ø§Ø¦ÙŠØ©_${activityName}_${dateStr}_${timeStr}.json`;
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ JSON Ù…Ù†Ø³Ù‚
                const jsonString = JSON.stringify(backup, null, 2);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Blob ÙˆØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification(
                    'âœ… ØªÙ… Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­',
                    `ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${fileName}`,
                    'success'
                );
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
                showNotification('âŒ ÙØ´Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
            }
        }

        // ===== Initial App Load =====
        async function initializeApp() {
            if (!currentActivityId) { showActivityModal(); return; }
            
            items = (await loadFromFirebase('items')) || [];
            customers = (await loadFromFirebase('customers')) || [];
            suppliers = (await loadFromFirebase('suppliers')) || [];
            purchases = (await loadFromFirebase('purchases')) || [];
            sales = (await loadFromFirebase('sales')) || [];
            expenses = (await loadFromFirebase('expenses')) || [];
            revenues = (await loadFromFirebase('revenues')) || [];
            salaries = (await loadFromFirebase('salaries')) || [];
            salesReturns = (await loadFromFirebase('salesReturns')) || [];
            advances = (await loadFromFirebase('advances')) || [];
            purchaseReturns = (await loadFromFirebase('purchaseReturns')) || [];

            currentPurchaseNumber = purchases.length > 0 ? Math.max(0, ...purchases.map(p => p.number)) + 1 : 1;
            currentSaleNumber = sales.length > 0 ? Math.max(0, ...sales.map(s => s.number)) + 1 : 1;
            currentSaleReturnNumber = salesReturns.length > 0 ? Math.max(0, ...salesReturns.map(r => r.number)) + 1 : 1;
            currentPurchaseReturnNumber = purchaseReturns.length > 0 ? Math.max(0, ...purchaseReturns.map(r => r.number)) + 1 : 1;
            
            const today = new Date().toISOString().split('T')[0];
            ['purchaseDate', 'saleDate', 'expenseDate', 'revenueDate', 'reportFrom', 'reportTo'].forEach(id => document.getElementById(id).value = today);
            const monthInput = document.getElementById('salaryMonth');
            if (monthInput) {
                if (!monthInput.value) {
                    monthInput.value = new Date().toISOString().slice(0, 7);
                }
                monthInput.onchange = updateSalarySummary;
            }
            
            generatePurchaseCode();
            generateSaleCode();

            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            updateLoggedInUserDisplay(loggedInUser);
            
            updateDashboard(); updateExpenseStats(); updateRevenueStats(); updateDataStats();
            renderItems(); renderCustomers(); renderSuppliers(); renderExpenses(); renderRevenues();
            renderSalaries(); updateSalarySummary();
            clearSalaryForm();
            renderSalesList(); renderPurchasesList();
            renderSalesReturns(); renderPurchaseReturns();
            updatePurchaseDropdowns(); updateSaleDropdowns(); updateReportItemFilter();
            
            // ØªØ­Ù…ÙŠÙ„ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            loadTrashFromLocalStorage();
            updateTrashBadge();
            
            // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†
            setTimeout(() => {
                checkLowStock();
                checkUnpaidDebts();
            }, 2000);
            
            // ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            setTimeout(() => {
                initAutoBackupSystem();
            }, 3000);
            
            const activity = activities.find(a => a.id == currentActivityId);
            console.log(`âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ù†Ø´Ø§Ø·: ${activity ? activity.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø­ÙÙˆØ¸
            loadSavedLogo();
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø´Ø¹Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø¥Ø®ÙØ§Ø¡Ù‡ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©
            const loginLogo = document.getElementById('loginLogo');
            if (loginLogo) {
                loginLogo.onerror = function() {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø´Ø¹Ø§Ø± ÙÙŠ localStorage Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø®ÙØ§Ø¡
                    const savedLogo = localStorage.getItem('systemLogo');
                    if (!savedLogo) {
                        this.style.display = 'none';
                    }
                };
            }
            
            const hydrateResponsiveTables = () => {
                const tables = document.querySelectorAll('.section table');
                tables.forEach(table => {
                    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
                    if (!headers.length) return;
                    table.querySelectorAll('tbody tr').forEach(row => {
                        Array.from(row.children).forEach((cell, index) => {
                            if (headers[index]) {
                                cell.setAttribute('data-label', headers[index]);
                            } else {
                                cell.removeAttribute('data-label');
                            }
                        });
                    });
                });
            };

            let responsiveTablesTimer;
            const scheduleResponsiveTablesHydration = () => {
                clearTimeout(responsiveTablesTimer);
                responsiveTablesTimer = setTimeout(hydrateResponsiveTables, 100);
            };

            await loadUsers();
            if (users.length === 0) {
                users.push({ id: 1, name: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', email: 'msafr3972@gmail.com', phone: '', password: 'A711858322', role: 'admin', activityId: null });
                await saveUsers();
            }
            if (EMAILJS_FIXED) {
                emailJsConfig = { ...EMAILJS_DEFAULTS };
            } else {
                const storedEmailJsConfig = JSON.parse(localStorage.getItem('diwan_email_config') || 'null') || {};
                emailJsConfig = {
                    serviceID: storedEmailJsConfig.serviceID || EMAILJS_DEFAULTS.serviceID || '',
                    templateID: storedEmailJsConfig.templateID || EMAILJS_DEFAULTS.templateID || '',
                    resetTemplateID: storedEmailJsConfig.resetTemplateID || EMAILJS_DEFAULTS.resetTemplateID || '',
                    publicKey: storedEmailJsConfig.publicKey || EMAILJS_DEFAULTS.publicKey || ''
                };
            }
            if (!('resetTemplateID' in emailJsConfig) || emailJsConfig.resetTemplateID === undefined) {
                emailJsConfig.resetTemplateID = '';
            }
            if (!EMAILJS_FIXED) {
                loadEmailJsSettings();
            }

            await loadActivities();
            // Ø¥Ø®ÙØ§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø«Ø§Ø¨ØªØ©
            if (EMAILJS_FIXED) {
                const toggleBtn = document.getElementById('toggleEmailSettingsBtn');
                const emailSettingsDiv = document.querySelector('.email-settings');
                if (toggleBtn) toggleBtn.style.display = 'none';
                if (emailSettingsDiv) emailSettingsDiv.style.display = 'none';
            }
            await handleResetFlowFromURL();
            
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                 const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                 document.getElementById('login-overlay').style.display = 'none';
                 document.querySelector('.app-container').style.display = 'flex';
                 if (loggedInUser.role === 'admin') {
                    currentActivityId = sessionStorage.getItem('currentActivityId');
                    if (currentActivityId && activities.find(a => a.id == currentActivityId)) {
                        selectActivity(currentActivityId);
                    } else {
                        enterAdminWithoutActivity();
                    }
                 } else if (loggedInUser.role === 'manager') {
                    selectActivity(loggedInUser.activityId);
                 } else {
                    selectActivity(loggedInUser.activityId);
                 }
            } else {
                 document.getElementById('login-overlay').style.display = 'flex';
                 document.querySelector('.app-container').style.display = 'none';
            }
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„
            FilterSortHelper.makeSortable('itemsTable', 'items', renderItems);
            FilterSortHelper.makeSortable('customersTable', 'customers', renderCustomers);
            FilterSortHelper.makeSortable('suppliersTable', 'suppliers', renderSuppliers);
            FilterSortHelper.makeSortable('salesTable', 'sales', renderSalesList);
            FilterSortHelper.makeSortable('purchasesTable', 'purchases', renderPurchasesList);
            
            // Ø±Ø¨Ø· Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±Ø©
            document.getElementById('searchItems')?.addEventListener('input', renderItems);
            document.getElementById('searchCustomers')?.addEventListener('input', renderCustomers);
            document.getElementById('searchSuppliers')?.addEventListener('input', renderSuppliers);
            document.getElementById('searchSales')?.addEventListener('input', searchSales);
            document.getElementById('searchPurchases')?.addEventListener('input', searchPurchases);
            
            // Ø±Ø¨Ø· ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡ ÙÙŠ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            document.getElementById('saleCustomer')?.addEventListener('change', updateCustomerFields);
            
            document.addEventListener('click', function(event) {
                const cp = document.getElementById('controlPanel'), dt = document.querySelector('.design-toggle');
                if (cp && cp.classList.contains('show') && !cp.contains(event.target) && !dt.contains(event.target)) {
                    cp.classList.remove('show');
                }
            });

            const tableObserverRoot = document.querySelector('.app-container') || document.body;
            const responsiveTableObserver = new MutationObserver(scheduleResponsiveTablesHydration);
            responsiveTableObserver.observe(tableObserverRoot, { childList: true, subtree: true });
            scheduleResponsiveTablesHydration();

            const loginEmailField = document.getElementById('loginEmail');
            const loginPasswordField = document.getElementById('loginPassword');
            const submitOnEnter = (event) => {
                if (event.key === 'Enter') {
                    handleLogin();
                }
            };
            if (loginEmailField) {
                loginEmailField.addEventListener('keyup', submitOnEnter);
            }
            if (loginPasswordField) {
                loginPasswordField.addEventListener('keyup', submitOnEnter);
            }

            const searchInputs = { 'searchItems': searchItems, 'searchCustomers': searchCustomers, 'searchSuppliers': searchSuppliers, 'searchPurchases': searchPurchases, 'searchSales': searchSales, 'searchExpenses': () => {}, 'searchRevenues': () => {}, 'searchSalaries': searchSalaries };
            let searchTimeout;
            Object.keys(searchInputs).forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.onkeyup = () => {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(searchInputs[id], 300);
                    };
                }
            });
        });
        
        function toggleEmailSettings() {
            const emailSettingsDiv = document.querySelector('.email-settings');
            emailSettingsDiv.style.display = emailSettingsDiv.style.display === 'none' ? 'block' : 'none';
        }

        // ===== Password Management =====
        function openChangePasswordModal() {
            const isLogged = sessionStorage.getItem('isLoggedIn') === 'true';
            if (!isLogged) { alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.'); return; }
            const oldEl = document.getElementById('cp-old');
            const newEl = document.getElementById('cp-new');
            const confEl = document.getElementById('cp-confirm');
            if (!oldEl || !newEl || !confEl) return;
            oldEl.value = '';
            newEl.value = '';
            confEl.value = '';
            document.getElementById('change-password-overlay').style.display = 'flex';
        }
        function closeChangePasswordModal() {
            const overlay = document.getElementById('change-password-overlay');
            if (overlay) overlay.style.display = 'none';
        }
        async function submitPasswordChange() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser) { alert('ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„.'); return; }
            const oldP = document.getElementById('cp-old').value;
            const newP = document.getElementById('cp-new').value;
            const confP = document.getElementById('cp-confirm').value;
            if (!oldP || !newP || !confP) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.'); return; }
            if (newP.length < 6) { alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù/Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.'); return; }
            if (newP !== confP) { alert('ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚.'); return; }
            const idx = users.findIndex(u => u.id === loggedInUser.id);
            if (idx === -1) { alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.'); return; }
            if (users[idx].password !== oldP) { alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.'); return; }
            users[idx].password = newP;
            await saveUsers();
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©
            loggedInUser.password = newP;
            sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
            updateLoggedInUserDisplay(loggedInUser);
            closeChangePasswordModal();
            alert('âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.');
        }

        function openForgotPasswordModal() {
            const emailEl = document.getElementById('fp-email');
            if (emailEl) emailEl.value = '';
            document.getElementById('forgot-password-overlay').style.display = 'flex';
        }
        function closeForgotPasswordModal() {
            const overlay = document.getElementById('forgot-password-overlay');
            if (overlay) overlay.style.display = 'none';
        }
        async function requestPasswordReset() {
            const email = document.getElementById('fp-email').value.trim();
            if (!email) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.'); return; }
            const user = users.find(u => u.email === email);
            if (!user) { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯.'); return; }
            if (!emailJsConfig.serviceID || !emailJsConfig.resetTemplateID || !emailJsConfig.publicKey) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ EmailJS Ùˆ Reset Template ID Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');
                return;
            }
            const token = Math.random().toString(36).slice(2) + Date.now().toString(36);
            const expiresAt = Date.now() + (60 * 60 * 1000); // ØµÙ„Ø§Ø­ÙŠØ© Ø³Ø§Ø¹Ø©
            try {
                await firebaseSet(`diwan_password_resets/${token}`, {
                    email,
                    createdAt: Date.now(),
                    expiresAt,
                    used: false
                });
            } catch (e) {
                alert('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©.');
                return;
            }
            // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…ÙˆÙ‚Ø¹ (Netlify Ø£Ùˆ Ø£ÙŠ Ø§Ø³ØªØ¶Ø§ÙØ©)
            // Ù†Ø­Ø°Ù Ø£ÙŠ Ø¨Ø§Ø±Ø§Ù…ØªØ±Ø§Øª Ø³Ø§Ø¨Ù‚Ø© ÙˆÙ†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒÙ‚Ø§Ø¹Ø¯Ø©
            const baseUrl = window.location.href.split('?')[0];
            const resetLink = `${baseUrl}?resetToken=${encodeURIComponent(token)}`;
            const templateParams = { to_email: email, reset_link: resetLink, app_name: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙŠÙˆØ§Ù†' };
            emailjs.send(emailJsConfig.serviceID, emailJsConfig.resetTemplateID, templateParams, emailJsConfig.publicKey)
                .then(() => { alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ.'); closeForgotPasswordModal(); })
                .catch(err => {
                    let msg = 'âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯';
                    try {
                        const eText = (err && err.text) ? String(err.text) : '';
                        const eStatus = (err && err.status) ? String(err.status) : '';
                        if (eStatus === '400' && /template id not found/i.test(eText)) {
                            msg += '\nØ§Ù„Ø³Ø¨Ø¨: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Template ID.' +
                                   '\nØ§Ù„Ø­Ù„: Ø§ÙØªØ­ Ù„ÙˆØ­Ø© EmailJS > Email Templates ÙˆØ§Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ù‚Ø§Ù„Ø¨ Ø«Ù… Ø§Ù„ØµÙ‚Ù‡ ÙÙŠ Reset Template ID Ø¯Ø§Ø®Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ§Ø­ÙØ¸.';
                        } else if (eStatus === '400' && /service/i.test(eText)) {
                            msg += '\nØ§Ù„Ø³Ø¨Ø¨: Service ID ØºÙŠØ± ØµØ­ÙŠØ­.' +
                                   '\nØ§Ù„Ø­Ù„: Ø§Ù†Ø³Ø® Service ID Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† EmailJS > Email Services.';
                        } else if (eStatus === '401' || /public key/i.test(eText)) {
                            msg += '\nØ§Ù„Ø³Ø¨Ø¨: Public Key ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©.' +
                                   '\nØ§Ù„Ø­Ù„: Ø§Ù†Ø³Ø® Public Key Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† EmailJS > Account > API Keys.';
                        } else {
                            msg += ': ' + JSON.stringify(err);
                        }
                    } catch (_) {
                        msg += ': ' + JSON.stringify(err);
                    }
                    alert(msg);
                });
        }

        let activeResetToken = null;
        function openResetPasswordModal(token) {
            activeResetToken = token;
            const n = document.getElementById('rp-new');
            const c = document.getElementById('rp-confirm');
            if (n) n.value = '';
            if (c) c.value = '';
            document.getElementById('reset-password-overlay').style.display = 'flex';
        }
        function closeResetPasswordModal() {
            const overlay = document.getElementById('reset-password-overlay');
            if (overlay) overlay.style.display = 'none';
            activeResetToken = null;
        }
        async function submitTokenPasswordReset() {
            if (!activeResetToken) { alert('Ø±Ù…Ø² ØºÙŠØ± ØµØ§Ù„Ø­.'); return; }
            const newP = document.getElementById('rp-new').value;
            const confP = document.getElementById('rp-confirm').value;
            if (!newP || !confP) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§.'); return; }
            if (newP.length < 6) { alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù/Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.'); return; }
            if (newP !== confP) { alert('ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚.'); return; }
            const rec = await firebaseGet(`diwan_password_resets/${activeResetToken}`);
            if (!rec) { alert('Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ§Ù„Ø­.'); return; }
            if (rec.used) { alert('ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø³Ø¨Ù‚Ø§Ù‹.'); return; }
            if (Date.now() > rec.expiresAt) { alert('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·.'); return; }
            const idx = users.findIndex(u => u.email === rec.email);
            if (idx === -1) { alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.'); return; }
            users[idx].password = newP;
            await saveUsers();
            await firebaseSet(`diwan_password_resets/${activeResetToken}/used`, true);
            closeResetPasswordModal();
            alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.');
            document.getElementById('login-overlay').style.display = 'flex';
            document.querySelector('.app-container').style.display = 'none';
        }

        async function handleResetFlowFromURL() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('resetToken');
            if (!token) return;
            const rec = await firebaseGet(`diwan_password_resets/${token}`);
            if (!rec) { alert('Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ØºÙŠØ± ØµØ§Ù„Ø­.'); return; }
            if (rec.used) { alert('ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø³Ø¨Ù‚Ø§Ù‹.'); return; }
            if (Date.now() > rec.expiresAt) { alert('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·.'); return; }
            openResetPasswordModal(token);
        }

        function calculateCOGS(filteredSales) {
            let totalCost = 0;
            filteredSales.forEach(sale => {
                sale.items.forEach(soldItem => {
                    const masterItem = items.find(item => item.id === soldItem.id);
                    if (masterItem) {
                        totalCost += soldItem.quantity * masterItem.cost;
                    }
                });
            });
            return totalCost;
        }

// Ø¯ÙˆØ§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
function initAdvancedDashboard() {
    updateLiveStats();
    renderCharts();
    updatePerformanceIndicators();
    
}

function updateLiveStats() {
    const today = new Date().toISOString().split('T')[0];
    const currentMonth = new Date().toISOString().substring(0, 7);
    
    // Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
    const todaySales = sales.filter(s => s.date === today)
                           .reduce((sum, sale) => sum + sale.total, 0);
    const liveSalesEl = document.getElementById('liveSales');
    if (liveSalesEl) liveSalesEl.textContent = todaySales.toFixed(2);
    
    // Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
    const monthRevenue = sales.filter(s => s.date.substring(0, 7) === currentMonth)
                             .reduce((sum, sale) => sum + sale.total, 0);
    const liveRevenueEl = document.getElementById('liveRevenue');
    if (liveRevenueEl) liveRevenueEl.textContent = monthRevenue.toFixed(2);
    
    // ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ù…Ø¨ÙŠØ¹Ø§Øª - Ù…Ø´ØªØ±ÙŠØ§Øª - Ù…ØµØ±ÙˆÙØ§Øª)
    const monthPurchases = purchases.filter(p => p.date.substring(0, 7) === currentMonth)
                                   .reduce((sum, purchase) => sum + purchase.total, 0);
    const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === currentMonth)
                                 .reduce((sum, expense) => sum + expense.amount, 0);
    const netProfit = monthRevenue - monthPurchases - monthExpenses;
    const liveProfitEl = document.getElementById('liveProfit');
    if (liveProfitEl) liveProfitEl.textContent = netProfit.toFixed(2);
    
    // Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯ (Ø³Ù†Ø¶ÙŠÙ createdAt Ù„Ø§Ø­Ù‚Ø§Ù‹)
    const newCustomers = customers.length; // Ù…Ø¤Ù‚ØªØ§Ù‹
    const liveCustomersEl = document.getElementById('liveCustomers');
    if (liveCustomersEl) liveCustomersEl.textContent = newCustomers;
    
    // Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
    const monthlyExpensesEl = document.getElementById('monthlyExpenses');
    if (monthlyExpensesEl) {
        monthlyExpensesEl.innerHTML = `<p>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±: ${monthExpenses.toFixed(2)} Ø±ÙŠØ§Ù„</p>`;
    }

    // Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø© (Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ù†Ø©)
    const yearStart = new Date().getFullYear() + '-01-01';
    const cumulativeRevenue = sales.filter(s => s.date >= yearStart).reduce((sum, sale) => sum + sale.total, 0);
    const cumulativePurchases = purchases.filter(p => p.date >= yearStart).reduce((sum, purchase) => sum + purchase.total, 0);
    const cumulativeExpenses = expenses.filter(e => e.date >= yearStart).reduce((sum, expense) => sum + expense.amount, 0);
    const cumulativeProfits = cumulativeRevenue - cumulativePurchases - cumulativeExpenses;
    const cumulativeProfitsEl = document.getElementById('cumulativeProfits');
    if (cumulativeProfitsEl) {
        cumulativeProfitsEl.innerHTML = `<p>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø©: ${cumulativeProfits.toFixed(2)} Ø±ÙŠØ§Ù„</p>`;
    }
}

function renderCharts() {
    renderSalesChart();
    renderRevenueChart();
    renderTopItemsChart();
    renderExpensesChart();
    renderPurchasesSalesChart();
}

function renderSalesChart() {
    const ctx = document.getElementById('salesChart');
    if (!ctx) return;
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
    const last7Days = getLast7Days();
    const salesData = last7Days.map(day => 
        sales.filter(s => s.date === day)
             .reduce((sum, sale) => sum + sale.total, 0)
    );

    // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    if (window.salesChartInstance) {
        window.salesChartInstance.destroy();
    }

    window.salesChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: last7Days.map(day => formatDate(day)),
            datasets: [{
                label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                data: salesData,
                borderColor: '#2c5aa0',
                backgroundColor: 'rgba(44, 90, 160, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    rtl: true,
                    labels: {
                        font: {
                            family: 'Tajawal',
                            size: 14
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…',
                    font: {
                        family: 'Tajawal',
                        size: 16
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        }
                    }
                },
                y: {
                    ticks: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        },
                        callback: function(value) {
                            return value + ' Ø±.Ø³';
                        }
                    }
                }
            }
        }
    });
}

function renderRevenueChart() {
    const ctx = document.getElementById('revenueChart');
    if (!ctx) return;
    
    const revenueBySource = {
        'Ù…Ø¨ÙŠØ¹Ø§Øª': revenues.filter(r => r.source === 'sales').reduce((sum, r) => sum + r.amount, 0),
        'Ø®Ø¯Ù…Ø§Øª': revenues.filter(r => r.source === 'services').reduce((sum, r) => sum + r.amount, 0),
        'Ø§Ø³ØªØ«Ù…Ø§Ø±': revenues.filter(r => r.source === 'investment').reduce((sum, r) => sum + r.amount, 0),
        'Ø£Ø®Ø±Ù‰': revenues.filter(r => r.source === 'other').reduce((sum, r) => sum + r.amount, 0)
    };

    // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    if (window.revenueChartInstance) {
        window.revenueChartInstance.destroy();
    }

    window.revenueChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(revenueBySource),
            datasets: [{
                data: Object.values(revenueBySource),
                backgroundColor: [
                    '#2c5aa0',
                    '#27ae60',
                    '#e74c3c',
                    '#f39c12'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    rtl: true,
                    labels: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        },
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value.toFixed(2)} Ø±.Ø³ (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderTopItemsChart() {
    const ctx = document.getElementById('topItemsChart');
    if (!ctx) return;
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹
    const itemSales = {};
    sales.forEach(sale => {
        sale.items.forEach(item => {
            if (!itemSales[item.name]) {
                itemSales[item.name] = 0;
            }
            itemSales[item.name] += item.quantity;
        });
    });

    const topItems = Object.entries(itemSales)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    if (window.topItemsChartInstance) {
        window.topItemsChartInstance.destroy();
    }

    window.topItemsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: topItems.map(item => item[0]),
            datasets: [{
                label: 'Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©',
                data: topItems.map(item => item[1]),
                backgroundColor: '#2c5aa0',
                borderColor: '#1a3d7a',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹',
                    font: {
                        family: 'Tajawal',
                        size: 16
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        }
                    }
                },
                y: {
                    ticks: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        }
                    }
                }
            }
        }
    });
}

function renderExpensesChart() {
    const ctx = document.getElementById('expensesChart');
    if (!ctx) return;
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±
    const months = [];
    const expensesData = [];
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const monthStr = date.toISOString().substring(0, 7);
        months.push(monthStr);
        const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === monthStr)
                                     .reduce((sum, expense) => sum + expense.amount, 0);
        expensesData.push(monthExpenses);
    }
    
    if (window.expensesChartInstance) {
        window.expensesChartInstance.destroy();
    }
    
    window.expensesChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                data: expensesData,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function renderPurchasesSalesChart() {
    const ctx = document.getElementById('purchasesSalesChart');
    if (!ctx) return;
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±
    const months = [];
    const purchasesData = [];
    const salesData = [];
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const monthStr = date.toISOString().substring(0, 7);
        months.push(monthStr);
        const monthPurchases = purchases.filter(p => p.date.substring(0, 7) === monthStr)
                                       .reduce((sum, purchase) => sum + purchase.total, 0);
        const monthSales = sales.filter(s => s.date.substring(0, 7) === monthStr)
                               .reduce((sum, sale) => sum + sale.total, 0);
        purchasesData.push(monthPurchases);
        salesData.push(monthSales);
    }
    
    if (window.purchasesSalesChartInstance) {
        window.purchasesSalesChartInstance.destroy();
    }
    
    window.purchasesSalesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{
                label: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
                data: purchasesData,
                backgroundColor: '#e74c3c',
                borderColor: '#c0392b',
                borderWidth: 1
            }, {
                label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                data: salesData,
                backgroundColor: '#27ae60',
                borderColor: '#219a52',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updatePerformanceIndicators() {
    const monthlySummary = document.getElementById('monthlySummary');
    const financialPerformance = document.getElementById('financialPerformance');
    
    if (!monthlySummary || !financialPerformance) return;
    
    const currentMonth = new Date().toISOString().substring(0, 7);
    
    const monthSales = sales.filter(s => s.date.substring(0, 7) === currentMonth)
                          .reduce((sum, sale) => sum + sale.total, 0);
    const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === currentMonth)
                                .reduce((sum, expense) => sum + expense.amount, 0);
    const monthRevenue = revenues.filter(r => r.date.substring(0, 7) === currentMonth)
                               .reduce((sum, revenue) => sum + revenue.amount, 0);
    const monthPurchases = purchases.filter(p => p.date.substring(0, 7) === currentMonth)
                                  .reduce((sum, purchase) => sum + purchase.total, 0);

    const profitMargin = monthSales > 0 ? ((monthSales - monthPurchases - monthExpenses) / monthSales * 100).toFixed(1) : 0;
    const avgInvoice = monthSales / Math.max(sales.filter(s => s.date.substring(0, 7) === currentMonth).length, 1);

    monthlySummary.innerHTML = `
        <div style="margin-bottom: 15px;">
            <p style="margin: 8px 0; font-size: 14px;">ðŸ’° <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</strong> ${monthSales.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ðŸ’¸ <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</strong> ${monthExpenses.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ðŸ“ˆ <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:</strong> ${monthRevenue.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ðŸŽ¯ <strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</strong> ${sales.filter(s => s.date.substring(0, 7) === currentMonth).length}</p>
        </div>
    `;

    financialPerformance.innerHTML = `
        <div style="margin-bottom: 15px;">
            <p style="margin: 8px 0; font-size: 14px;">ðŸ“Š <strong>Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­:</strong> <span style="color: ${profitMargin > 0 ? '#27ae60' : '#e74c3c'}">${profitMargin}%</span></p>
            <p style="margin: 8px 0; font-size: 14px;">ðŸ“ˆ <strong>Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${avgInvoice.toFixed(2)} Ø±.Ø³</p>
            <p style="margin: 8px 0; font-size: 14px;">ðŸ”„ <strong>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ:</strong> <span style="color: #27ae60">+15%</span></p>
            <p style="margin: 8px 0; font-size: 14px;">ðŸŽ¯ <strong>ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù:</strong> <span style="color: #27ae60">85%</span></p>
        </div>
    `;
}

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
function getLast7Days() {
    const days = [];
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toISOString().split('T')[0]);
    }
    return days;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-SA', { 
        month: 'short', 
        day: 'numeric' 
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ¬Ù‡ÙŠØ² Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹)
function formatPhoneNumberForWhatsApp(phone) {
    if (!phone) return null;

    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø³Ø§ÙØ§Øª Ø£Ùˆ Ø´Ø±Ø·Ø§Øª Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø© +
    let cleaned = phone.replace(/[\s\-+]/g, '');

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 (Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ)
    if (cleaned.startsWith('05')) {
        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ØµÙØ± Ø§Ù„Ø£ÙˆÙ„ Ø¨Ù€ 966
        return '966' + cleaned.substring(1);
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 5 Ù…Ø¨Ø§Ø´Ø±Ø©
    if (cleaned.length === 9 && cleaned.startsWith('5')) {
        return '966' + cleaned;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ù…ÙƒØªÙˆØ¨Ø§Ù‹ Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¯ÙˆÙ„ÙŠ Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ø§Ù„ÙØ¹Ù„
    if (cleaned.startsWith('966')) {
        return cleaned;
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙŠØºØ©ØŒ Ø£Ø±Ø¬Ø¹ Ø§Ù„Ø±Ù‚Ù… ÙƒÙ…Ø§ Ù‡Ùˆ (Ù‚Ø¯ ÙŠØ¹Ù…Ù„)
    return cleaned;
}

// Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
function sendWhatsAppInvoice(saleId) {
    const sale = sales.find(s => s.id === saleId);
    if (!sale) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©!');
        return;
    }

    const customer = customers.find(c => c.id === sale.customerId);
    if (!customer || !customer.phone) {
        alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.');
        return;
    }

    const formattedPhone = formatPhoneNumberForWhatsApp(customer.phone);
    if (!formattedPhone) {
        alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­.');
        return;
    }

    // --- ØªØ¬Ù‡ÙŠØ² Ù†Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© ---
    const activityList = (typeof activities !== 'undefined' && Array.isArray(activities)) ? activities : [];
    const activity = activityList.find(a => a.id == currentActivityId);
    const activityName = activity && activity.name ? activity.name : 'Ù†Ø´Ø§Ø·Ùƒ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ';
    let message = `*ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª - ${activityName}*\n\n`;
    message += `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${customer.name},\n`;
    message += `Ø¥Ù„ÙŠÙƒ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…: *SAL${sale.number.toString().padStart(3, '0')}*\n`;
    message += `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${sale.date}\n\n`;

    message += "*Ø§Ù„Ø£ØµÙ†Ø§Ù:*\n";
    sale.items.forEach(item => {
        message += `- ${item.name} (Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.quantity}, Ø§Ù„Ø³Ø¹Ø±: ${item.price.toFixed(2)}) = *${item.total.toFixed(2)}*\n`;
    });

    message += `\n*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${sale.total.toFixed(2)} Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ*\n`;
    message += `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${sale.paidAmount.toFixed(2)}\n`;
    message += `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${sale.remainingAmount.toFixed(2)}\n\n`;
    message += `Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§.`;
    // --- Ù†Ù‡Ø§ÙŠØ© Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ---

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ù„ÙŠÙƒÙˆÙ† Ù…ØªÙˆØ§ÙÙ‚Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø·
    const encodedMessage = encodeURIComponent(message);

    // Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙØªØ­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
    const whatsappUrl = `https://api.whatsapp.com/send?phone=${formattedPhone}&text=${encodedMessage}`;

    // ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
    window.open(whatsappUrl, '_blank');
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯Ù‡Ù…
function toggleAllCustomerCheckboxes(mainCheckbox) {
    const checkboxes = document.querySelectorAll('.customer-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = mainCheckbox.checked;
    });
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø©/Ø³Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
async function addAdvance() {
    const date = document.getElementById('advanceDate').value;
    const type = document.getElementById('advanceType').value;
    const employee = document.getElementById('advanceEmployee').value;
    const amount = parseFloat(document.getElementById('advanceAmount').value);
    const description = document.getElementById('advanceDescription').value;
    const status = document.getElementById('advanceStatus').value;

    if (!date || !employee || !amount) {
        showNotification('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©', 'error');
        return;
    }

    const newAdvance = {
        id: Date.now(),
        date,
        type,
        employee,
        amount,
        description,
        status,
        createdAt: new Date().toISOString()
    };

    advances.push(newAdvance);
    await saveToFirebase('advances', advances);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    renderAdvances();
    updateAdvanceStats();
    clearAdvanceForm();
    
    showNotification('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù„ÙØ©/Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù
function renderAdvances() {
    const advancesList = document.getElementById('advancesList');
    if (!advancesList) return;

    advancesList.innerHTML = advances.map(advance => `
        <tr>
            <td>${advance.date}</td>
            <td>${advance.type}</td>
            <td>${advance.employee}</td>
            <td>${advance.amount.toFixed(2)}</td>
            <td>${getStatusBadge(advance.status)}</td>
            <td>${advance.description || '-'}</td>
            <td class="action-buttons">
                <button class="btn-warning edit-btn" onclick="editAdvance(${advance.id})">âœï¸</button>
                <button class="btn-danger" onclick="deleteAdvance(${advance.id})">ðŸ—‘ï¸</button>
            </td>
        </tr>
    `).join('');

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØµØºØ±Ø©
    const miniStat = document.getElementById('miniStatAdvances');
    if (miniStat) {
        miniStat.textContent = advances.length;
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
function clearAdvanceForm() {
    document.getElementById('advanceDate').value = '';
    document.getElementById('advanceEmployee').value = '';
    document.getElementById('advanceAmount').value = '';
    document.getElementById('advanceDescription').value = '';
    // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ø­Ø§Ù„Ø©
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù
function updateAdvanceStats() {
    const totalAdvancesEl = document.getElementById('totalAdvances');
    const dueAdvancesEl = document.getElementById('dueAdvances');
    const paidAdvancesEl = document.getElementById('paidAdvances');

    if (totalAdvancesEl) {
        const total = advances.reduce((sum, advance) => sum + advance.amount, 0);
        totalAdvancesEl.textContent = total.toFixed(2);
    }

    if (dueAdvancesEl) {
        const due = advances
            .filter(advance => advance.status === 'Ù…Ø³ØªØ­Ù‚')
            .reduce((sum, advance) => sum + advance.amount, 0);
        dueAdvancesEl.textContent = due.toFixed(2);
    }

    if (paidAdvancesEl) {
        const paid = advances
            .filter(advance => advance.status === 'Ù…Ø³Ø¯Ø¯')
            .reduce((sum, advance) => sum + advance.amount, 0);
        paidAdvancesEl.textContent = paid.toFixed(2);
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø´Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø©
function getStatusBadge(status) {
    const badges = {
        'Ù…Ø³ØªØ­Ù‚': '<span style="color: #e74c3c; font-weight: bold;">Ù…Ø³ØªØ­Ù‚</span>',
        'Ù…Ø³Ø¯Ø¯': '<span style="color: #27ae60; font-weight: bold;">Ù…Ø³Ø¯Ø¯</span>',
        'Ø¬Ø²Ø¦ÙŠ': '<span style="color: #f39c12; font-weight: bold;">Ù…Ø³Ø¯Ø¯ Ø¬Ø²Ø¦ÙŠØ§Ù‹</span>'
    };
    return badges[status] || status;
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
function editAdvance(id) {
    const advance = advances.find(a => a.id === id);
    if (!advance) return;

    document.getElementById('advanceDate').value = advance.date;
    document.getElementById('advanceType').value = advance.type;
    document.getElementById('advanceEmployee').value = advance.employee;
    document.getElementById('advanceAmount').value = advance.amount;
    document.getElementById('advanceDescription').value = advance.description || '';
    document.getElementById('advanceStatus').value = advance.status;

    // ØªØºÙŠÙŠØ± Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ ØªØ­Ø¯ÙŠØ«
    const addButton = document.querySelector('#advances .btn-add');
    addButton.textContent = 'ðŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
    addButton.onclick = function() { updateAdvance(id); };

    // ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø¹Ù„Ù‰
    document.getElementById('advances').scrollIntoView({ behavior: 'smooth' });
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«
async function updateAdvance(id) {
    const advanceIndex = advances.findIndex(a => a.id === id);
    if (advanceIndex === -1) return;

    const date = document.getElementById('advanceDate').value;
    const type = document.getElementById('advanceType').value;
    const employee = document.getElementById('advanceEmployee').value;
    const amount = parseFloat(document.getElementById('advanceAmount').value);
    const description = document.getElementById('advanceDescription').value;
    const status = document.getElementById('advanceStatus').value;

    advances[advanceIndex] = {
        ...advances[advanceIndex],
        date,
        type,
        employee,
        amount,
        description,
        status
    };

    await saveToFirebase('advances', advances);
    renderAdvances();
    updateAdvanceStats();
    clearAdvanceForm();

    // Ø¥Ø¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    const addButton = document.querySelector('#advances .btn-add');
    addButton.textContent = 'âž• Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø©/Ø³Ù„ÙØ©';
    addButton.onclick = addAdvance;

    showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„ÙØ©/Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}
// Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø¹Ù‡Ø¯Ø©/Ø³Ù„ÙØ©
async function deleteAdvance(id) {
    const confirmed = await showConfirmDialog({
        title: 'âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
        message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„ÙØ©/Ø§Ù„Ø¹Ù‡Ø¯Ø©ØŸ',
        type: 'danger',
        confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
        cancelText: 'Ø¥Ù„ØºØ§Ø¡'
    });

    if (!confirmed) return;

    const advanceIndex = advances.findIndex(a => a.id === id);
    if (advanceIndex === -1) return;

    // Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
    moveToTrash('advances', advances[advanceIndex]);
    
    advances.splice(advanceIndex, 1);
    await saveToFirebase('advances', advances);
    
    renderAdvances();
    updateAdvanceStats();
    
    showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ù„ÙØ©/Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù‡Ø¯ ÙˆØ§Ù„Ø³Ù„Ù
function setupAdvanceSearch() {
    const searchInput = document.getElementById('searchAdvances');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredAdvances = advances.filter(advance => 
                advance.employee.toLowerCase().includes(searchTerm) ||
                advance.type.toLowerCase().includes(searchTerm) ||
                advance.description.toLowerCase().includes(searchTerm) ||
                advance.status.toLowerCase().includes(searchTerm)
            );
            renderFilteredAdvances(filteredAdvances);
        });
    }
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
function renderFilteredAdvances(filteredAdvances) {
    const advancesList = document.getElementById('advancesList');
    if (!advancesList) return;

    advancesList.innerHTML = filteredAdvances.map(advance => `
        <tr>
            <td>${advance.date}</td>
            <td>${advance.type}</td>
            <td>${advance.employee}</td>
            <td>${advance.amount.toFixed(2)}</td>
            <td>${getStatusBadge(advance.status)}</td>
            <td>${advance.description || '-'}</td>
            <td class="action-buttons">
                <button class="btn-warning edit-btn" onclick="editAdvance(${advance.id})">âœï¸</button>
                <button class="btn-danger" onclick="deleteAdvance(${advance.id})">ðŸ—‘ï¸</button>
            </td>
        </tr>
    `).join('');
}

// === Ø¯ÙˆØ§Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª ===

// --- Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ---
async function deleteSaleReturn(returnId) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ Ø³ÙŠØªÙ… Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.')) {
        return;
    }

    const returnIndex = salesReturns.findIndex(sr => sr.id === returnId);
    if (returnIndex === -1) return;

    const returnToDelete = salesReturns[returnIndex];

    // Ø£Ù‡Ù… Ø®Ø·ÙˆØ©: Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    // Ø¹Ù†Ø¯ Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§ØªØŒ ÙŠØ¬Ø¨ Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
    returnToDelete.items.forEach(returnedItem => {
        const itemInStock = items.find(i => i.id === returnedItem.id);
        if (itemInStock) {
            itemInStock.stock -= returnedItem.quantity;
        }
    });

    moveToTrash('salesReturns', returnToDelete);
    salesReturns.splice(returnIndex, 1);

    await saveToFirebase('salesReturns', salesReturns);
    await saveToFirebase('items', items);

    renderSalesReturns();
    renderItems();
    updateDashboard();
    showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');
}

// --- Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ---
async function deletePurchaseReturn(returnId) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø²ÙŠØ§Ø¯ØªÙ‡Ø§).')) {
        return;
    }

    const returnIndex = purchaseReturns.findIndex(pr => pr.id === returnId);
    if (returnIndex === -1) return;

    const returnToDelete = purchaseReturns[returnIndex];

    // Ø£Ù‡Ù… Ø®Ø·ÙˆØ©: Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    // Ø¹Ù†Ø¯ Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§ØªØŒ ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.
    returnToDelete.items.forEach(returnedItem => {
        const itemInStock = items.find(i => i.id === returnedItem.id);
        if (itemInStock) {
            itemInStock.stock += returnedItem.quantity;
        }
    });

    moveToTrash('purchaseReturns', returnToDelete);
    purchaseReturns.splice(returnIndex, 1);

    await saveToFirebase('purchaseReturns', purchaseReturns);
    await saveToFirebase('items', items);

    renderPurchaseReturns();
    renderItems();
    updateDashboard();
    showNotification('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„', 'ØªÙ… Ù†Ù‚Ù„ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª', 'success');

function loadSupplierAccount() {
    const supplierId = document.getElementById('accountSupplierSelect').value;
    const fromDate = document.getElementById('accountSupplierFromDate').value;
    const toDate = document.getElementById('accountSupplierToDate').value;
    
    if (!supplierId) {
        showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ±Ø¯', 'warning');
        return;
    }
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯...');
    setTimeout(() => {
        // Ø³Ù†Ù†ÙØ° generateSupplierAccountStatement Ù„Ø§Ø­Ù‚Ø§Ù‹
        showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø©', 'Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ° ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯ Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'info');
        hideLoading();
    }, 500);
}

function loadBankAccount() {
    const bankId = document.getElementById('accountBankSelect').value;
    const fromDate = document.getElementById('accountBankFromDate').value;
    const toDate = document.getElementById('accountBankToDate').value;
    
    if (!bankId) {
        showNotification('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ù†Ùƒ', 'warning');
        return;
    }
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ...');
    setTimeout(() => {
        // Ø³Ù†Ù†ÙØ° generateBankAccountStatement Ù„Ø§Ø­Ù‚Ø§Ù‹
        showNotification('â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø©', 'Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ° ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'info');
        hideLoading();
    }, 500);
}
function loadRecentActivities() {
    // Ø¯Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ© Ù„Ø­Ù„ Ø§Ù„Ø®Ø·Ø£
    console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©...');
    return [];
}
}

    </script>

<!-- Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ -->
<div id="confirm-overlay" class="confirm-overlay" role="dialog" aria-modal="true" aria-labelledby="confirm-title" aria-describedby="confirm-body">
    <div class="confirm-dialog">
        <div id="confirm-header" class="confirm-header">
            <span id="confirm-icon" class="confirm-icon" aria-hidden="true">âš ï¸</span>
            <h3 id="confirm-title" class="confirm-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
        </div>
        <div id="confirm-body" class="confirm-body">
            Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ
        </div>
        <div class="confirm-footer">
            <button id="confirm-btn-cancel" class="confirm-btn-cancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
            <button id="confirm-btn-confirm" class="confirm-btn-confirm" type="button">ØªØ£ÙƒÙŠØ¯</button>
        </div>
    </div>
</div>

</body>
</html>